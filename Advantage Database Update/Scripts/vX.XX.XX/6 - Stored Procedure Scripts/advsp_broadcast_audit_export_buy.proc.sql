CREATE PROCEDURE [dbo].[advsp_broadcast_audit_export_buy]  ( 	
	@start_date     smalldatetime,
	@end_date       smalldatetime,
	@cl_code_list   varchar(max)
	)
AS
BEGIN
SET NOCOUNT ON;

SELECT 
	[MEDIA] = 'TV',
	[CLIENT] = orders.CL_CODE,
	--[ClientName] = c.CL_NAME,
	--[DivisionCode] = orders.DIV_CODE,
	--[DivisionName] = d.DIV_NAME,
	[PRODUCT] = orders.PRD_CODE,
	--[ProductName] = p.PRD_DESCRIPTION,
	[EST] = MBWMDD.ORDER_NBR,
	[ESTIMATE] = orders.ORDER_DESC,
	[BUY_DATES] = (SELECT TOP 1 CONVERT(char(10),MBW.[START_DATE],101) + '-' + CONVERT(char(10),MBW.END_DATE,101)
					FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_DATE MBWMDD
						INNER JOIN dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL MBWMD ON MBWMD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID = MBWMDD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID 
						INNER JOIN dbo.MEDIA_BROADCAST_WORKSHEET_MARKET MBWM ON MBWM.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = MBWMD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID 
						INNER JOIN dbo.MEDIA_BROADCAST_WORKSHEET MBW ON MBW.MEDIA_BROADCAST_WORKSHEET_ID = MBWM.MEDIA_BROADCAST_WORKSHEET_ID 
					WHERE orders.ORDER_NBR = MBWMDD.ORDER_NBR
					),
	--[MarketCode] = orders.MARKET_CODE,
	[MARKET] = m.MARKET_DESC,
	[SYSCODE] = v.NCC_TV_SYSCODE_ID,
	--[VendorCode] = orders.VN_CODE,
	[STATION] = v.VN_NAME,
	[LINE] = MBWMDD.ORDER_LINE_NBR,
	[CABLE_NETWORK_CODE] = MBWMD.CABLE_NETWORK_STATION_CODE,
	[PROGRAMMING] = MBWMD.PROGRAM,
	[DAYPART] = dp.DAY_PART_CODE,
	[LEN] = MBWMD.[LENGTH],
	--[ROTATION] = CASE WHEN td.SUNDAY=1 THEN 'Su' ELSE '' END + CASE WHEN td.MONDAY=1 THEN 'M' ELSE '' END + CASE WHEN td.TUESDAY=1 THEN 'T' ELSE '' END +
	--			 CASE WHEN td.WEDNESDAY=1 THEN 'W' ELSE '' END + CASE WHEN td.THURSDAY=1 THEN 'R' ELSE '' END + CASE WHEN td.FRIDAY=1 THEN 'F' ELSE '' END +
	--			 CASE WHEN td.SATURDAY=1 THEN 'Sa' ELSE '' END,
	[ROTATION] = MBWMD.[DAYS],
    [TIMES] = (SELECT TOP 1 MBWMD.[START_TIME] + '-' + MBWMD.END_TIME
				FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_DATE MBWMDD2
					INNER JOIN dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL MBWMD ON MBWMD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID = MBWMDD2.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID 
				WHERE orders.ORDER_NBR = MBWMDD2.ORDER_NBR AND MBWMDD2.ORDER_LINE_NBR = MBWMDD.ORDER_LINE_NBR
				),
	[COST_PER_SPOT] = MBWMDD.RATE,
	[RATING] = MBWMD.PRIMARY_RATING
FROM
	(
	SELECT DISTINCT ORDER_NBR, ORDER_LINE_NBR, RATE, MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID
	FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_DATE
	WHERE ORDER_NBR IS NOT NULL
	AND [DATE] between @start_date and @end_date
	) MBWMDD
	INNER JOIN dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL MBWMD ON MBWMD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID = MBWMDD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID 
	INNER JOIN  (
				SELECT ORDER_NBR, CL_CODE, DIV_CODE, PRD_CODE, MARKET_CODE, VN_CODE, ORDER_DESC
				FROM dbo.TV_HDR
				WHERE
					(
						(@cl_code_list IS NULL)
							OR 
						(@cl_code_list IS NOT NULL AND CL_CODE IN (SELECT * FROM dbo.udf_split_list(@cl_code_list, ',')))
					)
				--AND
				--	(
				--		(@cmp_code_list IS NULL)
				--			OR 
				--		(@cmp_code_list IS NOT NULL AND CMP_CODE IN (SELECT * FROM dbo.udf_split_list(@cmp_code_list, ',')))
				--	)
				) orders on MBWMDD.ORDER_NBR = orders.ORDER_NBR
	LEFT OUTER JOIN dbo.DAY_PART dp ON MBWMD.DAY_PART_ID = dp.DAY_PART_ID 
	INNER JOIN dbo.CLIENT c ON orders.CL_CODE = c.CL_CODE
	INNER JOIN dbo.DIVISION d ON orders.CL_CODE = d.CL_CODE AND orders.DIV_CODE = d.DIV_CODE
	INNER JOIN dbo.PRODUCT p ON orders.CL_CODE = p.CL_CODE AND orders.DIV_CODE = p.DIV_CODE AND orders.PRD_CODE = p.PRD_CODE 
	INNER JOIN dbo.MARKET m ON orders.MARKET_CODE = m.MARKET_CODE 
	INNER JOIN dbo.VENDOR v ON orders.VN_CODE = v.VN_CODE

UNION ALL

SELECT
	[MEDIA] = 'RADIO',
	[CLIENT] = orders.CL_CODE,
	--[ClientName] = c.CL_NAME,
	--[DivisionCode] = orders.DIV_CODE,
	--[DivisionName] = d.DIV_NAME,
	[PRODUCT] = orders.PRD_CODE,
	--[ProductName] = p.PRD_DESCRIPTION,
	[EST] = MBWMDD.ORDER_NBR,
	[ESTIMATE] = orders.ORDER_DESC,
	[BUY_DATES] = (SELECT TOP 1 CONVERT(char(10),MBW.[START_DATE],101) + '-' + CONVERT(char(10),MBW.END_DATE,101)
					FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_DATE MBWMDD
						INNER JOIN dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL MBWMD ON MBWMD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID = MBWMDD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID 
						INNER JOIN dbo.MEDIA_BROADCAST_WORKSHEET_MARKET MBWM ON MBWM.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = MBWMD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID 
						INNER JOIN dbo.MEDIA_BROADCAST_WORKSHEET MBW ON MBW.MEDIA_BROADCAST_WORKSHEET_ID = MBWM.MEDIA_BROADCAST_WORKSHEET_ID 
					WHERE orders.ORDER_NBR = MBWMDD.ORDER_NBR
					),
	--[MarketCode] = orders.MARKET_CODE,
	[MARKET] = m.MARKET_DESC,
	[SYSCODE] = NULL,
	--[VendorCode] = orders.VN_CODE,
	[STATION] = v.VN_NAME,
	[LINE] = MBWMDD.ORDER_LINE_NBR,
	[CABLE_NETWORK_CODE] = NULL,
	[PROGRAM] = MBWMD.PROGRAM,
	[DAYPART] = dp.DAY_PART_CODE,
	[LEN] = MBWMD.[LENGTH],
	--[ROTATION] = CASE WHEN td.SUNDAY=1 THEN 'Su' ELSE '' END + CASE WHEN td.MONDAY=1 THEN 'M' ELSE '' END + CASE WHEN td.TUESDAY=1 THEN 'T' ELSE '' END +
	--			 CASE WHEN td.WEDNESDAY=1 THEN 'W' ELSE '' END + CASE WHEN td.THURSDAY=1 THEN 'R' ELSE '' END + CASE WHEN td.FRIDAY=1 THEN 'F' ELSE '' END +
	--			 CASE WHEN td.SATURDAY=1 THEN 'Sa' ELSE '' END,
	[ROTATION] = MBWMD.[DAYS],
    [TIMES] = (SELECT TOP 1 MBWMD.[START_TIME] + '-' + MBWMD.END_TIME
				FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_DATE MBWMDD2
					INNER JOIN dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL MBWMD ON MBWMD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID = MBWMDD2.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID 
				WHERE orders.ORDER_NBR = MBWMDD2.ORDER_NBR AND MBWMDD2.ORDER_LINE_NBR = MBWMDD.ORDER_LINE_NBR
				),
	[COST_PER_SPOT] = MBWMDD.RATE,
	[RATING] = MBWMD.PRIMARY_AQH_RATING
FROM
	(
	SELECT DISTINCT ORDER_NBR, ORDER_LINE_NBR, RATE, MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID
	FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_DATE
	WHERE ORDER_NBR IS NOT NULL
	AND [DATE] between @start_date and @end_date
	) MBWMDD
	INNER JOIN dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL MBWMD ON MBWMD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID = MBWMDD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID 
	INNER JOIN  (
				SELECT ORDER_NBR, CL_CODE, DIV_CODE, PRD_CODE, MARKET_CODE, VN_CODE, ORDER_DESC
				FROM dbo.RADIO_HDR
				WHERE
					(
						(@cl_code_list IS NULL)
							OR 
						(@cl_code_list IS NOT NULL AND CL_CODE IN (SELECT * FROM dbo.udf_split_list(@cl_code_list, ',')))
					)
				--AND
				--	(
				--		(@cmp_code_list IS NULL)
				--			OR 
				--		(@cmp_code_list IS NOT NULL AND CMP_CODE IN (SELECT * FROM dbo.udf_split_list(@cmp_code_list, ',')))
				--	)
				) orders on MBWMDD.ORDER_NBR = orders.ORDER_NBR
	LEFT OUTER JOIN dbo.DAY_PART dp ON MBWMD.DAY_PART_ID = dp.DAY_PART_ID 
	INNER JOIN dbo.CLIENT c ON orders.CL_CODE = c.CL_CODE
	INNER JOIN dbo.DIVISION d ON orders.CL_CODE = d.CL_CODE AND orders.DIV_CODE = d.DIV_CODE
	INNER JOIN dbo.PRODUCT p ON orders.CL_CODE = p.CL_CODE AND orders.DIV_CODE = p.DIV_CODE AND orders.PRD_CODE = p.PRD_CODE 
	INNER JOIN dbo.MARKET m ON orders.MARKET_CODE = m.MARKET_CODE 
	INNER JOIN dbo.VENDOR v ON orders.VN_CODE = v.VN_CODE

END
GO
