CREATE PROCEDURE [dbo].[advsp_comscore_precache_books]
	@COMSCORE_PRECACHE_MARKET_ID int
AS

SELECT 
	IsSelected = CAST(CASE WHEN b.COMSCORE_TV_BOOK_ID IS NOT NULL THEN 1 ELSE 0 END as bit),
	[Year] = a.[YEAR],
    [Month] = a.[MONTH],
    [Stream] = a.[STREAM],
    [ComscoreTVBookID] = a.COMSCORE_TV_BOOK_ID,
    MarketBookID = b.COMSCORE_PRECACHE_MARKET_BOOK_ID 
FROM dbo.COMSCORE_TV_BOOK a
	LEFT OUTER JOIN dbo.COMSCORE_PRECACHE_MARKET_BOOK b ON b.COMSCORE_PRECACHE_MARKET_ID = @COMSCORE_PRECACHE_MARKET_ID AND a.COMSCORE_TV_BOOK_ID = b.COMSCORE_TV_BOOK_ID 
WHERE a.END_DATETIME < DATEADD(DD,-13,getdate())
ORDER BY a.[YEAR] DESC, [MONTH], [STREAM]
