IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[advsp_media_mananger_writeupdown]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[advsp_media_mananger_writeupdown]
GO

CREATE PROCEDURE [dbo].[advsp_media_mananger_writeupdown] 
	@media_type varchar(1),
	@order_nbr int,
	@line_nbr smallint,
	@addl_charge decimal(14,2),
	@user_code varchar(100)
AS

DECLARE @rev_nbr smallint,
		@seq_nbr smallint,
		@TAXAPPLYAI smallint,
		@TAXAPPLYC smallint,
		@TAXAPPLYLN smallint,
		@TAXAPPLYNC smallint,
		@TAXAPPLYND smallint,
		@TAXAPPLYR smallint,
		@COMMISSION_AMT decimal,
		@NET_AMT decimal,
		@NET_CHARGE decimal,
		@DISCOUNT decimal,
		@REBATE_AMT decimal,
		@STATE_PCT decimal,
		@COUNTY_PCT decimal,
		@CITY_PCT decimal

BEGIN TRY

	BEGIN TRAN
		
		IF @media_type = 'I' BEGIN
	
			SELECT @rev_nbr = REV_NBR, @seq_nbr = SEQ_NBR, @TAXAPPLYAI = TAXAPPLYAI, @TAXAPPLYC = TAXAPPLYC, @TAXAPPLYLN = TAXAPPLYLN, @TAXAPPLYNC = TAXAPPLYNC, @TAXAPPLYND = TAXAPPLYND, @TAXAPPLYR = TAXAPPLYR,
					@COMMISSION_AMT = COMM_AMT, @NET_AMT = EXT_NET_AMT, @NET_CHARGE = NETCHARGE, @DISCOUNT = DISCOUNT_AMT, @REBATE_AMT = REBATE_AMT,
					@STATE_PCT = TAX_STATE_PCT, @COUNTY_PCT = TAX_COUNTY_PCT, @CITY_PCT = TAX_CITY_PCT
			FROM dbo.INTERNET_DETAIL
			WHERE ORDER_NBR = @order_nbr 
			AND LINE_NBR = @line_nbr 
			AND ACTIVE_REV = 1
			AND COALESCE(LINE_CANCELLED, 0) = 0

			--reversal row
			INSERT INTO dbo.INTERNET_DETAIL (ORDER_NBR, LINE_NBR, REV_NBR, SEQ_NBR, ACTIVE_REV, LINK_DETID, [START_DATE],
				END_DATE, CLOSE_DATE, MATL_CLOSE_DATE, EXT_CLOSE_DATE, EXT_MATL_DATE, HEADLINE, INTERNET_TYPE, SIZE,
				PROJ_IMPRESSIONS, GUARANTEED_IMPRESS, URL, TARGET_AUDIENCE, COPY_AREA, JOB_NUMBER, JOB_COMPONENT_NBR, RATE_CARD,
				RATE_TYPE, RATE_DESC, QUANTITY, RATE, NET_RATE, GROSS_RATE, EXT_NET_AMT, EXT_GROSS_AMT,
				COMM_AMT, REBATE_AMT, DISCOUNT_AMT, DISCOUNT_DESC, STATE_AMT, COUNTY_AMT, CITY_AMT, NON_RESALE_AMT,
				NETCHARGE, NCDESC, ADDL_CHARGE, ADDL_CHARGE_DESC, LINE_TOTAL, --LINE_CANCELLED, 
				DATE_TO_BILL, 
				--BILLING_USER,	AR_INV_NBR, AR_TYPE, AR_INV_SEQ, GLEXACT, GLESEQ_SALES, GLESEQ_COS, GLESEQ_WIP, GLESEQ_STATE,
				--GLESEQ_COUNTY, GLESEQ_CITY, GLEXACT_DEF, GLACODE_SALES, GLACODE_COS, GLACODE_WIP, GLACODE_STATE, GLACODE_COUNTY, GLACODE_CITY, 
				NON_BILL_FLAG, MODIFIED_BY, MODIFIED_DATE, MODIFIED_COMMENTS, BILL_TYPE_FLAG, CREATIVE_SIZE, PLACEMENT_1,
				PLACEMENT_2, COMM_PCT, MARKUP_PCT, REBATE_PCT, DISCOUNT_PCT, TAX_CODE, TAX_CITY_PCT, TAX_COUNTY_PCT,
				TAX_STATE_PCT, TAX_RESALE, TAXAPPLYC, TAXAPPLYLN, TAXAPPLYND, TAXAPPLYNC, TAXAPPLYR, TAXAPPLYAI,
				--RECONCILE_FLAG, 
				ACT_IMPRESSIONS, 
				--GLESEQ_SALES_DEF, GLESEQ_COS_DEF, GLACODE_SALES_DEF, GLACODE_COS_DEF, 
				BILLING_AMT, COST_TYPE,	COST_RATE, NET_BASE_RATE, GROSS_BASE_RATE, --BILL_CANCELLED, 
				EST_NBR, EST_LINE_NBR, EST_REV_NBR, AD_NUMBER,
				MAT_COMP, AD_SERVER_PLACEMENT_ID, AD_SERVER_CREATED_BY, AD_SERVER_CREATED_DATETIME, AD_SERVER_LAST_MODIFIED_BY, AD_SERVER_LAST_MODIFIED_DATETIME, AD_SERVER_PLACEMENT_MANUAL, PACKAGE_PARENT,
				AD_SERVER_PLACEMENT_GROUP_ID, AD_SERVER_ID, MARKET_CODE, MEDIA_CHANNEL_ID, MEDIA_TACTIC_ID)
			SELECT ORDER_NBR, LINE_NBR, REV_NBR, SEQ_NBR + 1, NULL AS ACTIVE_REV, LINK_DETID, [START_DATE],
				END_DATE, CLOSE_DATE, MATL_CLOSE_DATE, EXT_CLOSE_DATE, EXT_MATL_DATE, HEADLINE, INTERNET_TYPE, SIZE,
				-1 * PROJ_IMPRESSIONS, -1 * GUARANTEED_IMPRESS, URL, TARGET_AUDIENCE, COPY_AREA, JOB_NUMBER, JOB_COMPONENT_NBR, RATE_CARD,
				RATE_TYPE, RATE_DESC, -1 * QUANTITY, RATE, NET_RATE, GROSS_RATE, -1 * EXT_NET_AMT, -1 * EXT_GROSS_AMT,
				-1 * COMM_AMT, -1 * REBATE_AMT, -1 * DISCOUNT_AMT, DISCOUNT_DESC, -1 * STATE_AMT, -1 * COUNTY_AMT, -1 * CITY_AMT, -1 * NON_RESALE_AMT,
				-1 * NETCHARGE, NULL AS NCDESC, -1 * ADDL_CHARGE, NULL AS ADDL_CHARGE_DESC, -1 * LINE_TOTAL, --LINE_CANCELLED, 
				DATE_TO_BILL, 
				--BILLING_USER, AR_INV_NBR, AR_TYPE, AR_INV_SEQ, GLEXACT, GLESEQ_SALES, GLESEQ_COS, GLESEQ_WIP, GLESEQ_STATE,
				--GLESEQ_COUNTY, GLESEQ_CITY, GLEXACT_DEF, GLACODE_SALES, GLACODE_COS, GLACODE_WIP, GLACODE_STATE, GLACODE_COUNTY, GLACODE_CITY, 
				NON_BILL_FLAG, @user_code AS MODIFIED_BY, getdate() AS MODIFIED_DATE, 'MM writeoff reversal', BILL_TYPE_FLAG, CREATIVE_SIZE, PLACEMENT_1,
				PLACEMENT_2, COMM_PCT, MARKUP_PCT, REBATE_PCT, DISCOUNT_PCT, TAX_CODE, TAX_CITY_PCT, TAX_COUNTY_PCT,
				TAX_STATE_PCT, TAX_RESALE, TAXAPPLYC, TAXAPPLYLN, TAXAPPLYND, TAXAPPLYNC, TAXAPPLYR, TAXAPPLYAI,
				--RECONCILE_FLAG, 
				-1 * ACT_IMPRESSIONS, 
				--GLESEQ_SALES_DEF, GLESEQ_COS_DEF, GLACODE_SALES_DEF, GLACODE_COS_DEF, 
				-1 * BILLING_AMT, COST_TYPE,COST_RATE, NET_BASE_RATE, GROSS_BASE_RATE, --BILL_CANCELLED, 
				EST_NBR, EST_LINE_NBR, EST_REV_NBR, AD_NUMBER,
				MAT_COMP, AD_SERVER_PLACEMENT_ID, AD_SERVER_CREATED_BY, AD_SERVER_CREATED_DATETIME, AD_SERVER_LAST_MODIFIED_BY, AD_SERVER_LAST_MODIFIED_DATETIME, AD_SERVER_PLACEMENT_MANUAL, PACKAGE_PARENT,
				AD_SERVER_PLACEMENT_GROUP_ID, AD_SERVER_ID, MARKET_CODE, MEDIA_CHANNEL_ID, MEDIA_TACTIC_ID 
			FROM dbo.INTERNET_DETAIL
			WHERE ORDER_NBR = @order_nbr 
			AND LINE_NBR = @line_nbr 
			AND ACTIVE_REV = 1
			AND COALESCE(LINE_CANCELLED, 0) = 0

			--new row
			INSERT INTO dbo.INTERNET_DETAIL (ORDER_NBR, LINE_NBR, REV_NBR, SEQ_NBR, ACTIVE_REV, LINK_DETID, [START_DATE],
				END_DATE, CLOSE_DATE, MATL_CLOSE_DATE, EXT_CLOSE_DATE, EXT_MATL_DATE, HEADLINE, INTERNET_TYPE, SIZE,
				PROJ_IMPRESSIONS, GUARANTEED_IMPRESS, URL, TARGET_AUDIENCE, COPY_AREA, JOB_NUMBER, JOB_COMPONENT_NBR, RATE_CARD,
				RATE_TYPE, RATE_DESC, QUANTITY, RATE, NET_RATE, GROSS_RATE, EXT_NET_AMT, EXT_GROSS_AMT,
				COMM_AMT, REBATE_AMT, DISCOUNT_AMT, DISCOUNT_DESC, STATE_AMT, COUNTY_AMT, CITY_AMT, NON_RESALE_AMT,
				NETCHARGE, NCDESC, ADDL_CHARGE, ADDL_CHARGE_DESC, LINE_TOTAL, --LINE_CANCELLED, 
				DATE_TO_BILL, 
				--BILLING_USER,	AR_INV_NBR, AR_TYPE, AR_INV_SEQ, GLEXACT, GLESEQ_SALES, GLESEQ_COS, GLESEQ_WIP, GLESEQ_STATE,
				--GLESEQ_COUNTY, GLESEQ_CITY, GLEXACT_DEF, GLACODE_SALES, GLACODE_COS, GLACODE_WIP, GLACODE_STATE, GLACODE_COUNTY, GLACODE_CITY, 
				NON_BILL_FLAG, MODIFIED_BY, MODIFIED_DATE, MODIFIED_COMMENTS, BILL_TYPE_FLAG, CREATIVE_SIZE, PLACEMENT_1,
				PLACEMENT_2, COMM_PCT, MARKUP_PCT, REBATE_PCT, DISCOUNT_PCT, TAX_CODE, TAX_CITY_PCT, TAX_COUNTY_PCT,
				TAX_STATE_PCT, TAX_RESALE, TAXAPPLYC, TAXAPPLYLN, TAXAPPLYND, TAXAPPLYNC, TAXAPPLYR, TAXAPPLYAI,
				--RECONCILE_FLAG, 
				ACT_IMPRESSIONS, 
				--GLESEQ_SALES_DEF, GLESEQ_COS_DEF, GLACODE_SALES_DEF, GLACODE_COS_DEF, 
				BILLING_AMT, COST_TYPE,	
				COST_RATE, NET_BASE_RATE, GROSS_BASE_RATE, --BILL_CANCELLED, 
				EST_NBR, EST_LINE_NBR, EST_REV_NBR, AD_NUMBER,
				MAT_COMP, AD_SERVER_PLACEMENT_ID, AD_SERVER_CREATED_BY, AD_SERVER_CREATED_DATETIME, AD_SERVER_LAST_MODIFIED_BY, AD_SERVER_LAST_MODIFIED_DATETIME, AD_SERVER_PLACEMENT_MANUAL, PACKAGE_PARENT,
				AD_SERVER_PLACEMENT_GROUP_ID, AD_SERVER_ID, MARKET_CODE, MEDIA_CHANNEL_ID, MEDIA_TACTIC_ID)
			SELECT ORDER_NBR, LINE_NBR, REV_NBR + 1, 0 SEQ_NBR, 1 AS ACTIVE_REV, LINK_DETID, [START_DATE],
				END_DATE, CLOSE_DATE, MATL_CLOSE_DATE, EXT_CLOSE_DATE, EXT_MATL_DATE, HEADLINE, INTERNET_TYPE, SIZE,
				PROJ_IMPRESSIONS, GUARANTEED_IMPRESS, URL, TARGET_AUDIENCE, COPY_AREA, JOB_NUMBER, JOB_COMPONENT_NBR, RATE_CARD,
				RATE_TYPE, RATE_DESC, QUANTITY, RATE, NET_RATE, GROSS_RATE, EXT_NET_AMT, EXT_GROSS_AMT,
				COMM_AMT, REBATE_AMT, DISCOUNT_AMT, DISCOUNT_DESC,
				CASE WHEN TAX_RESALE = 1 THEN b.STATE_TAX ELSE [STATE_AMT] END, 
				CASE WHEN TAX_RESALE = 1 THEN b.COUNTY_TAX ELSE [COUNTY_AMT] END,
				CASE WHEN TAX_RESALE = 1 THEN b.CITY_TAX ELSE [CITY_AMT] END,
				NON_RESALE_AMT,
				NETCHARGE, NULL AS NCDESC, @addl_charge as ADDL_CHARGE, NULL AS ADDL_CHARGE_DESC, LINE_TOTAL, --LINE_CANCELLED, 
				DATE_TO_BILL, 
				--BILLING_USER, AR_INV_NBR, AR_TYPE, AR_INV_SEQ, GLEXACT, GLESEQ_SALES, GLESEQ_COS, GLESEQ_WIP, GLESEQ_STATE,
				--GLESEQ_COUNTY, GLESEQ_CITY, GLEXACT_DEF, GLACODE_SALES, GLACODE_COS, GLACODE_WIP, GLACODE_STATE, GLACODE_COUNTY, GLACODE_CITY, 
				NON_BILL_FLAG, @user_code AS MODIFIED_BY, getdate() AS MODIFIED_DATE, 'MM writeoff new', BILL_TYPE_FLAG, CREATIVE_SIZE, PLACEMENT_1,
				PLACEMENT_2, COMM_PCT, MARKUP_PCT, REBATE_PCT, DISCOUNT_PCT, TAX_CODE, TAX_CITY_PCT, TAX_COUNTY_PCT,
				TAX_STATE_PCT, TAX_RESALE, TAXAPPLYC, TAXAPPLYLN, TAXAPPLYND, TAXAPPLYNC, TAXAPPLYR, TAXAPPLYAI,
				--RECONCILE_FLAG, 
				ACT_IMPRESSIONS, 
				--GLESEQ_SALES_DEF, GLESEQ_COS_DEF, GLACODE_SALES_DEF, GLACODE_COS_DEF, 
				CASE 
					WHEN BILL_TYPE_FLAG = 1 THEN
						(COALESCE(COMM_AMT,0) + COALESCE(REBATE_AMT,0)) + CASE WHEN TAX_RESALE = 1 THEN b.STATE_TAX + b.COUNTY_TAX + b.CITY_TAX ELSE COALESCE([STATE_AMT],0) + COALESCE([COUNTY_TAX],0) + COALESCE([CITY_TAX],0) END
					WHEN BILL_TYPE_FLAG = 2 THEN
						COALESCE(EXT_NET_AMT,0) + COALESCE(NETCHARGE,0) + CASE WHEN TAX_RESALE = 1 THEN b.STATE_TAX + b.COUNTY_TAX + b.CITY_TAX ELSE COALESCE([STATE_AMT],0) + COALESCE([COUNTY_TAX],0) + COALESCE([CITY_TAX],0) END + COALESCE(NON_RESALE_AMT,0) +
						@addl_charge + COALESCE(DISCOUNT_AMT,0)
					WHEN BILL_TYPE_FLAG = 3 THEN
						CASE WHEN TAX_RESALE = 1 THEN b.STATE_TAX + b.COUNTY_TAX + b.CITY_TAX ELSE COALESCE([STATE_AMT],0) + COALESCE([COUNTY_TAX],0) + COALESCE([CITY_TAX],0) END + COALESCE(NON_RESALE_AMT,0) + COALESCE(EXT_NET_AMT,0) + COALESCE(NETCHARGE,0) +
						COALESCE(DISCOUNT_AMT,0) + @addl_charge + COALESCE(COMM_AMT,0) + COALESCE(REBATE_AMT,0)
				END,
				COST_TYPE,COST_RATE, NET_BASE_RATE, GROSS_BASE_RATE, --BILL_CANCELLED, 
				EST_NBR, EST_LINE_NBR, EST_REV_NBR, AD_NUMBER,
				MAT_COMP, AD_SERVER_PLACEMENT_ID, AD_SERVER_CREATED_BY, AD_SERVER_CREATED_DATETIME, AD_SERVER_LAST_MODIFIED_BY, AD_SERVER_LAST_MODIFIED_DATETIME, AD_SERVER_PLACEMENT_MANUAL, PACKAGE_PARENT,
				AD_SERVER_PLACEMENT_GROUP_ID, AD_SERVER_ID, MARKET_CODE, MEDIA_CHANNEL_ID, MEDIA_TACTIC_ID 
			FROM dbo.INTERNET_DETAIL a
				INNER JOIN (
					SELECT * FROM [advtf_calc_tax](@TAXAPPLYAI, @TAXAPPLYC, @TAXAPPLYLN, @TAXAPPLYNC, @TAXAPPLYND, @TAXAPPLYR, @addl_charge, @COMMISSION_AMT, @NET_AMT, @NET_CHARGE, @DISCOUNT, @REBATE_AMT, @STATE_PCT, @COUNTY_PCT, @CITY_PCT)
					) b ON 1=1
			WHERE ORDER_NBR = @order_nbr 
			AND LINE_NBR = @line_nbr 
			AND ACTIVE_REV = 1
			AND COALESCE(LINE_CANCELLED, 0) = 0

			UPDATE dbo.INTERNET_DETAIL SET ACTIVE_REV = NULL
			WHERE ORDER_NBR = @order_nbr 
			AND LINE_NBR = @line_nbr 
			AND REV_NBR = @rev_nbr 
			AND SEQ_NBR = @seq_nbr 

		END
		IF @media_type = 'M' BEGIN
			
			SELECT @rev_nbr = REV_NBR, @seq_nbr = SEQ_NBR, @TAXAPPLYAI = TAXAPPLYAI, @TAXAPPLYC = TAXAPPLYC, @TAXAPPLYLN = TAXAPPLYLN, @TAXAPPLYNC = TAXAPPLYNC, @TAXAPPLYND = TAXAPPLYND, @TAXAPPLYR = TAXAPPLYR,
					@COMMISSION_AMT = COMM_AMT, @NET_AMT = EXT_NET_AMT, @NET_CHARGE = NETCHARGE, @DISCOUNT = DISCOUNT_AMT, @REBATE_AMT = REBATE_AMT,
					@STATE_PCT = TAX_STATE_PCT, @COUNTY_PCT = TAX_COUNTY_PCT, @CITY_PCT = TAX_CITY_PCT
			FROM dbo.MAGAZINE_DETAIL
			WHERE ORDER_NBR = @order_nbr 
			AND LINE_NBR = @line_nbr 
			AND ACTIVE_REV = 1
			AND COALESCE(LINE_CANCELLED, 0) = 0

			--reversal row
			INSERT INTO [dbo].[MAGAZINE_DETAIL]
				([ORDER_NBR], [LINE_NBR], [REV_NBR], [SEQ_NBR], [ACTIVE_REV], [LINK_DETID], [START_DATE], [END_DATE], [CLOSE_DATE],
				[MATL_CLOSE_DATE], [EXT_CLOSE_DATE], [EXT_MATL_DATE], [SIZE], [AD_NUMBER], [HEADLINE], [MATERIAL], [EDITION_ISSUE], [SECTION],
				[JOB_NUMBER], [JOB_COMPONENT_NBR], [RATE_CARD_ID], [RATE_DTL_ID], [CONTRACT_QTY],
				[QUANTITY], [RATE], [NET_RATE], [GROSS_RATE], [FLAT_NET], [FLAT_GROSS], [EXT_NET_AMT], [EXT_GROSS_AMT], [COMM_AMT], [REBATE_AMT],
				[DISCOUNT_AMT], [DISCOUNT_DESC], [STATE_AMT], [COUNTY_AMT], [CITY_AMT], [NON_RESALE_AMT], [NETCHARGE], [NETCHARGE_DESC],
				[ADDL_CHARGE], [ADDL_CHARGE_DESC], [PROD_CHARGE], [PROD_DESC], [COLOR_CHARGE], [COLOR_DESC], [LINE_TOTAL], --[LINE_CANCELLED],
				[BLEED_PCT], [BLEED_AMT], [POSITION_PCT], [POSITION_AMT], [PREMIUM_PCT], [PREMIUM_AMT],
				[DATE_TO_BILL], 
				--[BILLING_USER], [AR_INV_NBR], [AR_TYPE], [AR_INV_SEQ], [GLEXACT], [GLESEQ_SALES], [GLESEQ_COS], [GLESEQ_WIP],
				[MARKUP_PCT], [REBATE_PCT], [DISCOUNT_PCT], [TAX_CODE], [TAX_CITY_PCT], [TAX_COUNTY_PCT], [TAX_STATE_PCT], [TAX_RESALE],
				[TAXAPPLYC], [TAXAPPLYLN], [TAXAPPLYND], [TAXAPPLYNC], [TAXAPPLYR], [TAXAPPLYAI], [RECONCILE_FLAG],
				--[GLESEQ_STATE], [GLESEQ_COUNTY], [GLESEQ_CITY], [GLEXACT_DEF], [GLACODE_SALES], [GLACODE_COS], [GLACODE_WIP], [GLACODE_STATE],
				--[GLACODE_COUNTY], [GLACODE_CITY], 
				[NON_BILL_FLAG], 
				[MODIFIED_BY], [MODIFIED_DATE], [MODIFIED_COMMENTS], [BILL_TYPE_FLAG], [COMM_PCT],							   
				--[GLESEQ_SALES_DEF], [GLESEQ_COS_DEF], [GLACODE_SALES_DEF], [GLACODE_COS_DEF], 
				[BILLING_AMT], [BILL_CANCELLED],
				[EST_NBR], [EST_LINE_NBR], [EST_REV_NBR], [FLAT_NETCHARGE], [FLAT_ADDL_CHARGE], [FLAT_DISCOUNT_AMT], [PRODUCTION_SIZE],
				[MAT_COMP], [SIZE_CODE], [MG_CIRCULATION])
			SELECT
				[ORDER_NBR], [LINE_NBR], [REV_NBR], SEQ_NBR + 1, NULL AS ACTIVE_REV, [LINK_DETID], [START_DATE], [END_DATE], [CLOSE_DATE],
				[MATL_CLOSE_DATE], [EXT_CLOSE_DATE], [EXT_MATL_DATE], [SIZE], [AD_NUMBER], [HEADLINE], [MATERIAL], [EDITION_ISSUE], [SECTION],
				[JOB_NUMBER], [JOB_COMPONENT_NBR], [RATE_CARD_ID], [RATE_DTL_ID], -1 * [CONTRACT_QTY],
				-1 * [QUANTITY], [RATE], [NET_RATE], [GROSS_RATE], [FLAT_NET], [FLAT_GROSS], -1 * [EXT_NET_AMT], -1 * [EXT_GROSS_AMT], -1 * [COMM_AMT], -1 * [REBATE_AMT],
				-1 * [DISCOUNT_AMT], [DISCOUNT_DESC], -1 * [STATE_AMT], -1 * [COUNTY_AMT], -1 * [CITY_AMT], -1 * [NON_RESALE_AMT], -1 * [NETCHARGE], [NETCHARGE_DESC],
				-1 * [ADDL_CHARGE], [ADDL_CHARGE_DESC], -1 * [PROD_CHARGE], [PROD_DESC], -1 * [COLOR_CHARGE], [COLOR_DESC], -1 * [LINE_TOTAL], --[LINE_CANCELLED],
				[BLEED_PCT], -1 * [BLEED_AMT], [POSITION_PCT], -1 * [POSITION_AMT], [PREMIUM_PCT], -1 * [PREMIUM_AMT],
				[DATE_TO_BILL], 
				--[BILLING_USER], [AR_INV_NBR], [AR_TYPE], [AR_INV_SEQ], [GLEXACT], [GLESEQ_SALES], [GLESEQ_COS], [GLESEQ_WIP],
				[MARKUP_PCT], [REBATE_PCT], [DISCOUNT_PCT], [TAX_CODE], [TAX_CITY_PCT], [TAX_COUNTY_PCT], [TAX_STATE_PCT], [TAX_RESALE],
				[TAXAPPLYC], [TAXAPPLYLN], [TAXAPPLYND], [TAXAPPLYNC], [TAXAPPLYR], [TAXAPPLYAI], [RECONCILE_FLAG],
				--[GLESEQ_STATE], [GLESEQ_COUNTY], [GLESEQ_CITY], [GLEXACT_DEF], [GLACODE_SALES], [GLACODE_COS], [GLACODE_WIP], [GLACODE_STATE],
				--[GLACODE_COUNTY], [GLACODE_CITY], 
				[NON_BILL_FLAG], 
				@user_code AS [MODIFIED_BY], getdate() AS [MODIFIED_DATE], 'MM writeoff reversal', [BILL_TYPE_FLAG], [COMM_PCT],							   
				--[GLESEQ_SALES_DEF], [GLESEQ_COS_DEF], [GLACODE_SALES_DEF], [GLACODE_COS_DEF], 
				-1 * [BILLING_AMT], [BILL_CANCELLED],
				[EST_NBR], [EST_LINE_NBR], [EST_REV_NBR], -1 * [FLAT_NETCHARGE], -1 * [FLAT_ADDL_CHARGE], -1 * [FLAT_DISCOUNT_AMT], [PRODUCTION_SIZE],
				[MAT_COMP], [SIZE_CODE], [MG_CIRCULATION]
			FROM dbo.MAGAZINE_DETAIL
			WHERE ORDER_NBR = @order_nbr 
			AND LINE_NBR = @line_nbr 
			AND ACTIVE_REV = 1
			AND COALESCE(LINE_CANCELLED, 0) = 0

			--new row
			INSERT INTO [dbo].[MAGAZINE_DETAIL]
				([ORDER_NBR], [LINE_NBR], [REV_NBR], [SEQ_NBR], [ACTIVE_REV], [LINK_DETID], [START_DATE], [END_DATE], [CLOSE_DATE],
				[MATL_CLOSE_DATE], [EXT_CLOSE_DATE], [EXT_MATL_DATE], [SIZE], [AD_NUMBER], [HEADLINE], [MATERIAL], [EDITION_ISSUE], [SECTION],
				[JOB_NUMBER], [JOB_COMPONENT_NBR], [RATE_CARD_ID], [RATE_DTL_ID], [CONTRACT_QTY],
				[QUANTITY], [RATE], [NET_RATE], [GROSS_RATE], [FLAT_NET], [FLAT_GROSS], [EXT_NET_AMT], [EXT_GROSS_AMT], [COMM_AMT], [REBATE_AMT],
				[DISCOUNT_AMT], [DISCOUNT_DESC], [STATE_AMT], [COUNTY_AMT], [CITY_AMT], [NON_RESALE_AMT], [NETCHARGE], [NETCHARGE_DESC],
				[ADDL_CHARGE], [ADDL_CHARGE_DESC], [PROD_CHARGE], [PROD_DESC], [COLOR_CHARGE], [COLOR_DESC], [LINE_TOTAL], --[LINE_CANCELLED],
				[BLEED_PCT], [BLEED_AMT], [POSITION_PCT], [POSITION_AMT], [PREMIUM_PCT], [PREMIUM_AMT],
				[DATE_TO_BILL], 
				--[BILLING_USER], [AR_INV_NBR], [AR_TYPE], [AR_INV_SEQ], [GLEXACT], [GLESEQ_SALES], [GLESEQ_COS], [GLESEQ_WIP],
				[MARKUP_PCT], [REBATE_PCT], [DISCOUNT_PCT], [TAX_CODE], [TAX_CITY_PCT], [TAX_COUNTY_PCT], [TAX_STATE_PCT], [TAX_RESALE],
				[TAXAPPLYC], [TAXAPPLYLN], [TAXAPPLYND], [TAXAPPLYNC], [TAXAPPLYR], [TAXAPPLYAI], [RECONCILE_FLAG],
				--[GLESEQ_STATE], [GLESEQ_COUNTY], [GLESEQ_CITY], [GLEXACT_DEF], [GLACODE_SALES], [GLACODE_COS], [GLACODE_WIP], [GLACODE_STATE],
				--[GLACODE_COUNTY], [GLACODE_CITY], 
				[NON_BILL_FLAG], 
				[MODIFIED_BY], [MODIFIED_DATE], [MODIFIED_COMMENTS], [BILL_TYPE_FLAG], [COMM_PCT],							   
				--[GLESEQ_SALES_DEF], [GLESEQ_COS_DEF], [GLACODE_SALES_DEF], [GLACODE_COS_DEF], 
				[BILLING_AMT],
				[BILL_CANCELLED],
				[EST_NBR], [EST_LINE_NBR], [EST_REV_NBR], [FLAT_NETCHARGE], [FLAT_ADDL_CHARGE], [FLAT_DISCOUNT_AMT], [PRODUCTION_SIZE],
				[MAT_COMP], [SIZE_CODE], [MG_CIRCULATION])
			SELECT
				[ORDER_NBR], [LINE_NBR], REV_NBR + 1, 0 SEQ_NBR, 1 AS ACTIVE_REV, [LINK_DETID], [START_DATE], [END_DATE], [CLOSE_DATE],
				[MATL_CLOSE_DATE], [EXT_CLOSE_DATE], [EXT_MATL_DATE], [SIZE], [AD_NUMBER], [HEADLINE], [MATERIAL], [EDITION_ISSUE], [SECTION],
				[JOB_NUMBER], [JOB_COMPONENT_NBR], [RATE_CARD_ID], [RATE_DTL_ID], [CONTRACT_QTY],
				[QUANTITY], [RATE], [NET_RATE], [GROSS_RATE], [FLAT_NET], [FLAT_GROSS], [EXT_NET_AMT], [EXT_GROSS_AMT], [COMM_AMT], [REBATE_AMT],
				[DISCOUNT_AMT], [DISCOUNT_DESC],
				CASE WHEN TAX_RESALE = 1 THEN b.STATE_TAX ELSE [STATE_AMT] END, 
				CASE WHEN TAX_RESALE = 1 THEN b.COUNTY_TAX ELSE [COUNTY_AMT] END,
				CASE WHEN TAX_RESALE = 1 THEN b.CITY_TAX ELSE [CITY_AMT] END,
				[NON_RESALE_AMT], [NETCHARGE], [NETCHARGE_DESC],
				@addl_charge as ADDL_CHARGE, [ADDL_CHARGE_DESC], [PROD_CHARGE], [PROD_DESC], [COLOR_CHARGE], [COLOR_DESC], [LINE_TOTAL], --[LINE_CANCELLED],
				[BLEED_PCT], [BLEED_AMT], [POSITION_PCT], [POSITION_AMT], [PREMIUM_PCT], [PREMIUM_AMT],
				[DATE_TO_BILL], 
				--[BILLING_USER], [AR_INV_NBR], [AR_TYPE], [AR_INV_SEQ], [GLEXACT], [GLESEQ_SALES], [GLESEQ_COS], [GLESEQ_WIP],
				[MARKUP_PCT], [REBATE_PCT], [DISCOUNT_PCT], [TAX_CODE], [TAX_CITY_PCT], [TAX_COUNTY_PCT], [TAX_STATE_PCT], [TAX_RESALE],
				[TAXAPPLYC], [TAXAPPLYLN], [TAXAPPLYND], [TAXAPPLYNC], [TAXAPPLYR], [TAXAPPLYAI], [RECONCILE_FLAG],
				--[GLESEQ_STATE], [GLESEQ_COUNTY], [GLESEQ_CITY], [GLEXACT_DEF], [GLACODE_SALES], [GLACODE_COS], [GLACODE_WIP], [GLACODE_STATE],
				--[GLACODE_COUNTY], [GLACODE_CITY], 
				[NON_BILL_FLAG], 
				@user_code AS [MODIFIED_BY], getdate() AS [MODIFIED_DATE], 'MM writeoff new', [BILL_TYPE_FLAG], [COMM_PCT],							   
				--[GLESEQ_SALES_DEF], [GLESEQ_COS_DEF], [GLACODE_SALES_DEF], [GLACODE_COS_DEF], 
				CASE 
					WHEN BILL_TYPE_FLAG = 1 THEN
						(COALESCE(COMM_AMT,0) + COALESCE(REBATE_AMT,0)) + CASE WHEN TAX_RESALE = 1 THEN b.STATE_TAX + b.COUNTY_TAX + b.CITY_TAX ELSE COALESCE([STATE_AMT],0) + COALESCE([COUNTY_TAX],0) + COALESCE([CITY_TAX],0) END
					WHEN BILL_TYPE_FLAG = 2 THEN
						COALESCE(EXT_NET_AMT,0) + COALESCE(NETCHARGE,0) + CASE WHEN TAX_RESALE = 1 THEN b.STATE_TAX + b.COUNTY_TAX + b.CITY_TAX ELSE COALESCE([STATE_AMT],0) + COALESCE([COUNTY_TAX],0) + COALESCE([CITY_TAX],0) END + COALESCE(NON_RESALE_AMT,0) +
						@addl_charge + COALESCE(DISCOUNT_AMT,0)
					WHEN BILL_TYPE_FLAG = 3 THEN
						CASE WHEN TAX_RESALE = 1 THEN b.STATE_TAX + b.COUNTY_TAX + b.CITY_TAX ELSE COALESCE([STATE_AMT],0) + COALESCE([COUNTY_TAX],0) + COALESCE([CITY_TAX],0) END + COALESCE(NON_RESALE_AMT,0) + COALESCE(EXT_NET_AMT,0) + COALESCE(NETCHARGE,0) +
						COALESCE(DISCOUNT_AMT,0) + @addl_charge + COALESCE(COMM_AMT,0) + COALESCE(REBATE_AMT,0)
				END,
				[BILL_CANCELLED],
				[EST_NBR], [EST_LINE_NBR], [EST_REV_NBR], [FLAT_NETCHARGE], [FLAT_ADDL_CHARGE], [FLAT_DISCOUNT_AMT], [PRODUCTION_SIZE],
				[MAT_COMP], [SIZE_CODE], [MG_CIRCULATION]
			FROM dbo.MAGAZINE_DETAIL a
				INNER JOIN (
					SELECT * FROM [advtf_calc_tax](@TAXAPPLYAI, @TAXAPPLYC, @TAXAPPLYLN, @TAXAPPLYNC, @TAXAPPLYND, @TAXAPPLYR, @addl_charge, @COMMISSION_AMT, @NET_AMT, @NET_CHARGE, @DISCOUNT, @REBATE_AMT, @STATE_PCT, @COUNTY_PCT, @CITY_PCT)
					) b ON 1=1
			WHERE ORDER_NBR = @order_nbr 
			AND LINE_NBR = @line_nbr 
			AND ACTIVE_REV = 1
			AND COALESCE(LINE_CANCELLED, 0) = 0
			
			UPDATE dbo.MAGAZINE_DETAIL SET ACTIVE_REV = NULL
			WHERE ORDER_NBR = @order_nbr 
			AND LINE_NBR = @line_nbr 
			AND REV_NBR = @rev_nbr 
			AND SEQ_NBR = @seq_nbr 

		END
		IF @media_type = 'N' BEGIN
		
			SELECT @rev_nbr = REV_NBR, @seq_nbr = SEQ_NBR, @TAXAPPLYAI = TAXAPPLYAI, @TAXAPPLYC = TAXAPPLYC, @TAXAPPLYLN = TAXAPPLYLN, @TAXAPPLYNC = TAXAPPLYNC, @TAXAPPLYND = TAXAPPLYND, @TAXAPPLYR = TAXAPPLYR,
					@COMMISSION_AMT = COMM_AMT, @NET_AMT = EXT_NET_AMT, @NET_CHARGE = NETCHARGE, @DISCOUNT = DISCOUNT_AMT, @REBATE_AMT = REBATE_AMT,
					@STATE_PCT = TAX_STATE_PCT, @COUNTY_PCT = TAX_COUNTY_PCT, @CITY_PCT = TAX_CITY_PCT
			FROM dbo.NEWSPAPER_DETAIL
			WHERE ORDER_NBR = @order_nbr 
			AND LINE_NBR = @line_nbr 
			AND ACTIVE_REV = 1
			AND COALESCE(LINE_CANCELLED, 0) = 0

			--reversal row
			INSERT INTO [dbo].[NEWSPAPER_DETAIL]
				([ORDER_NBR], [LINE_NBR], [REV_NBR], [SEQ_NBR], [ACTIVE_REV], [LINK_DETID], [START_DATE], [END_DATE], [CLOSE_DATE],
				[MATL_CLOSE_DATE], [EXT_CLOSE_DATE], [EXT_MATL_DATE], [SIZE], [AD_NUMBER], [HEADLINE], [MATERIAL], [EDITION_ISSUE], [SECTION],
				[JOB_NUMBER], [JOB_COMPONENT_NBR], [RATE_CARD_ID], [RATE_DTL_ID], [PRINT_COLUMNS], [PRINT_INCHES], [PRINT_LINES], [CONTRACT_QTY],
				[QUANTITY], [RATE], [NET_RATE], [GROSS_RATE], [FLAT_NET], [FLAT_GROSS], [EXT_NET_AMT], [EXT_GROSS_AMT], [COMM_AMT], [REBATE_AMT],
				[DISCOUNT_AMT], [DISCOUNT_DESC], [STATE_AMT], [COUNTY_AMT], [CITY_AMT], [NON_RESALE_AMT], [NETCHARGE], [NETCHARGE_DESC],
				[ADDL_CHARGE], [ADDL_CHARGE_DESC], [PROD_CHARGE], [PROD_DESC], [COLOR_CHARGE], [COLOR_DESC], [LINE_TOTAL], [LINE_CANCELLED],
				[DATE_TO_BILL], --[BILLING_USER], [AR_INV_NBR], [AR_TYPE], [AR_INV_SEQ], [GLEXACT], [GLESEQ_SALES], [GLESEQ_COS], [GLESEQ_WIP],
				[MARKUP_PCT], [REBATE_PCT], [DISCOUNT_PCT], [TAX_CODE], [TAX_CITY_PCT], [TAX_COUNTY_PCT], [TAX_STATE_PCT], [TAX_RESALE],
				[TAXAPPLYC], [TAXAPPLYLN], [TAXAPPLYND], [TAXAPPLYNC], [TAXAPPLYR], [TAXAPPLYAI], [RECONCILE_FLAG],
				--[GLESEQ_STATE], [GLESEQ_COUNTY], [GLESEQ_CITY], [GLEXACT_DEF], [GLACODE_SALES], [GLACODE_COS], [GLACODE_WIP], [GLACODE_STATE],
				--[GLACODE_COUNTY], [GLACODE_CITY], 
				[NON_BILL_FLAG], [MODIFIED_BY], [MODIFIED_DATE], [MODIFIED_COMMENTS], [BILL_TYPE_FLAG], [COMM_PCT],							   
				--[GLESEQ_SALES_DEF], [GLESEQ_COS_DEF], [GLACODE_SALES_DEF], [GLACODE_COS_DEF], 
				[BILLING_AMT], [BILL_CANCELLED],
				[EST_NBR], [EST_LINE_NBR], [EST_REV_NBR], [FLAT_NETCHARGE], [FLAT_ADDL_CHARGE], [FLAT_DISCOUNT_AMT], [PRODUCTION_SIZE],
				[MAT_COMP], [SIZE_CODE], [COST_TYPE], [COST_RATE], [RATE_TYPE], [NP_CIRCULATION], [PRINT_QUANTITY])
			SELECT
				[ORDER_NBR], [LINE_NBR], [REV_NBR], SEQ_NBR + 1, NULL AS ACTIVE_REV, [LINK_DETID], [START_DATE], [END_DATE], [CLOSE_DATE],
				[MATL_CLOSE_DATE], [EXT_CLOSE_DATE], [EXT_MATL_DATE], [SIZE], [AD_NUMBER], [HEADLINE], [MATERIAL], [EDITION_ISSUE], [SECTION],
				[JOB_NUMBER], [JOB_COMPONENT_NBR], [RATE_CARD_ID], [RATE_DTL_ID], [PRINT_COLUMNS], [PRINT_INCHES], -1 * [PRINT_LINES], -1 * [CONTRACT_QTY],
				-1 * [QUANTITY], [RATE], [NET_RATE], [GROSS_RATE], [FLAT_NET], [FLAT_GROSS], -1 * [EXT_NET_AMT], -1 * [EXT_GROSS_AMT], -1 * [COMM_AMT], -1 * [REBATE_AMT],
				-1 * [DISCOUNT_AMT], [DISCOUNT_DESC], -1 * [STATE_AMT], -1 * [COUNTY_AMT], -1 * [CITY_AMT], -1 * [NON_RESALE_AMT], -1 * [NETCHARGE], [NETCHARGE_DESC],
				-1 * [ADDL_CHARGE], [ADDL_CHARGE_DESC], [PROD_CHARGE], [PROD_DESC], [COLOR_CHARGE], [COLOR_DESC], [LINE_TOTAL], [LINE_CANCELLED],
				[DATE_TO_BILL], --[BILLING_USER], [AR_INV_NBR], [AR_TYPE], [AR_INV_SEQ], [GLEXACT], [GLESEQ_SALES], [GLESEQ_COS], [GLESEQ_WIP],
				[MARKUP_PCT], [REBATE_PCT], [DISCOUNT_PCT], [TAX_CODE], [TAX_CITY_PCT], [TAX_COUNTY_PCT], [TAX_STATE_PCT], [TAX_RESALE],
				[TAXAPPLYC], [TAXAPPLYLN], [TAXAPPLYND], [TAXAPPLYNC], [TAXAPPLYR], [TAXAPPLYAI], [RECONCILE_FLAG],
				--[GLESEQ_STATE], [GLESEQ_COUNTY], [GLESEQ_CITY], [GLEXACT_DEF], [GLACODE_SALES], [GLACODE_COS], [GLACODE_WIP], [GLACODE_STATE],
				--[GLACODE_COUNTY], [GLACODE_CITY], 
				[NON_BILL_FLAG], @user_code AS [MODIFIED_BY], getdate() AS [MODIFIED_DATE], 'MM writeoff reversal', [BILL_TYPE_FLAG], [COMM_PCT],							   
				--[GLESEQ_SALES_DEF], [GLESEQ_COS_DEF], [GLACODE_SALES_DEF], [GLACODE_COS_DEF], 
				-1 * [BILLING_AMT], [BILL_CANCELLED],
				[EST_NBR], [EST_LINE_NBR], [EST_REV_NBR], -1 * [FLAT_NETCHARGE], -1 * [FLAT_ADDL_CHARGE], -1 * [FLAT_DISCOUNT_AMT], [PRODUCTION_SIZE],
				[MAT_COMP], [SIZE_CODE], [COST_TYPE], [COST_RATE], [RATE_TYPE], [NP_CIRCULATION], [PRINT_QUANTITY]
			FROM dbo.NEWSPAPER_DETAIL
			WHERE ORDER_NBR = @order_nbr 
			AND LINE_NBR = @line_nbr 
			AND ACTIVE_REV = 1
			AND COALESCE(LINE_CANCELLED, 0) = 0

			--new row
			INSERT INTO [dbo].[NEWSPAPER_DETAIL]
				([ORDER_NBR], [LINE_NBR], [REV_NBR], [SEQ_NBR], [ACTIVE_REV], [LINK_DETID], [START_DATE], [END_DATE], [CLOSE_DATE],
				[MATL_CLOSE_DATE], [EXT_CLOSE_DATE], [EXT_MATL_DATE], [SIZE], [AD_NUMBER], [HEADLINE], [MATERIAL], [EDITION_ISSUE], [SECTION],
				[JOB_NUMBER], [JOB_COMPONENT_NBR], [RATE_CARD_ID], [RATE_DTL_ID], [PRINT_COLUMNS], [PRINT_INCHES], [PRINT_LINES], [CONTRACT_QTY],
				[QUANTITY], [RATE], [NET_RATE], [GROSS_RATE], [FLAT_NET], [FLAT_GROSS], [EXT_NET_AMT], [EXT_GROSS_AMT], [COMM_AMT], [REBATE_AMT],
				[DISCOUNT_AMT], [DISCOUNT_DESC], [STATE_AMT], [COUNTY_AMT], [CITY_AMT], [NON_RESALE_AMT], [NETCHARGE], [NETCHARGE_DESC],
				[ADDL_CHARGE], [ADDL_CHARGE_DESC], [PROD_CHARGE], [PROD_DESC], [COLOR_CHARGE], [COLOR_DESC], [LINE_TOTAL], [LINE_CANCELLED],
				[DATE_TO_BILL], --[BILLING_USER], [AR_INV_NBR], [AR_TYPE], [AR_INV_SEQ], [GLEXACT], [GLESEQ_SALES], [GLESEQ_COS], [GLESEQ_WIP],
				[MARKUP_PCT], [REBATE_PCT], [DISCOUNT_PCT], [TAX_CODE], [TAX_CITY_PCT], [TAX_COUNTY_PCT], [TAX_STATE_PCT], [TAX_RESALE],
				[TAXAPPLYC], [TAXAPPLYLN], [TAXAPPLYND], [TAXAPPLYNC], [TAXAPPLYR], [TAXAPPLYAI], [RECONCILE_FLAG],
				--[GLESEQ_STATE], [GLESEQ_COUNTY], [GLESEQ_CITY], [GLEXACT_DEF], [GLACODE_SALES], [GLACODE_COS], [GLACODE_WIP], [GLACODE_STATE],
				--[GLACODE_COUNTY], [GLACODE_CITY], 
				[NON_BILL_FLAG], [MODIFIED_BY], [MODIFIED_DATE], [MODIFIED_COMMENTS], [BILL_TYPE_FLAG], [COMM_PCT],							   
				--[GLESEQ_SALES_DEF], [GLESEQ_COS_DEF], [GLACODE_SALES_DEF], [GLACODE_COS_DEF], 
				[BILLING_AMT],
				[BILL_CANCELLED],
				[EST_NBR], [EST_LINE_NBR], [EST_REV_NBR], [FLAT_NETCHARGE], [FLAT_ADDL_CHARGE], [FLAT_DISCOUNT_AMT], [PRODUCTION_SIZE],
				[MAT_COMP], [SIZE_CODE], [COST_TYPE], [COST_RATE], [RATE_TYPE], [NP_CIRCULATION], [PRINT_QUANTITY])
			SELECT
				[ORDER_NBR], [LINE_NBR], REV_NBR + 1, 0 SEQ_NBR, 1 AS ACTIVE_REV, [LINK_DETID], [START_DATE], [END_DATE], [CLOSE_DATE],
				[MATL_CLOSE_DATE], [EXT_CLOSE_DATE], [EXT_MATL_DATE], [SIZE], [AD_NUMBER], [HEADLINE], [MATERIAL], [EDITION_ISSUE], [SECTION],
				[JOB_NUMBER], [JOB_COMPONENT_NBR], [RATE_CARD_ID], [RATE_DTL_ID], [PRINT_COLUMNS], [PRINT_INCHES], [PRINT_LINES], [CONTRACT_QTY],
				[QUANTITY], [RATE], [NET_RATE], [GROSS_RATE], [FLAT_NET], [FLAT_GROSS], [EXT_NET_AMT], [EXT_GROSS_AMT], [COMM_AMT], [REBATE_AMT],
				[DISCOUNT_AMT], [DISCOUNT_DESC],
				CASE WHEN TAX_RESALE = 1 THEN b.STATE_TAX ELSE [STATE_AMT] END, 
				CASE WHEN TAX_RESALE = 1 THEN b.COUNTY_TAX ELSE [COUNTY_AMT] END,
				CASE WHEN TAX_RESALE = 1 THEN b.CITY_TAX ELSE [CITY_AMT] END,
				[NON_RESALE_AMT], [NETCHARGE], [NETCHARGE_DESC],
				@addl_charge as ADDL_CHARGE, [ADDL_CHARGE_DESC], [PROD_CHARGE], [PROD_DESC], [COLOR_CHARGE], [COLOR_DESC], [LINE_TOTAL], [LINE_CANCELLED],
				[DATE_TO_BILL], --[BILLING_USER], [AR_INV_NBR], [AR_TYPE], [AR_INV_SEQ], [GLEXACT], [GLESEQ_SALES], [GLESEQ_COS], [GLESEQ_WIP],
				[MARKUP_PCT], [REBATE_PCT], [DISCOUNT_PCT], [TAX_CODE], [TAX_CITY_PCT], [TAX_COUNTY_PCT], [TAX_STATE_PCT], [TAX_RESALE],
				[TAXAPPLYC], [TAXAPPLYLN], [TAXAPPLYND], [TAXAPPLYNC], [TAXAPPLYR], [TAXAPPLYAI], [RECONCILE_FLAG],
				--[GLESEQ_STATE], [GLESEQ_COUNTY], [GLESEQ_CITY], [GLEXACT_DEF], [GLACODE_SALES], [GLACODE_COS], [GLACODE_WIP], [GLACODE_STATE],
				--[GLACODE_COUNTY], [GLACODE_CITY], 
				[NON_BILL_FLAG], @user_code AS [MODIFIED_BY], getdate() AS [MODIFIED_DATE], 'MM writeoff new', [BILL_TYPE_FLAG], [COMM_PCT],							   
				--[GLESEQ_SALES_DEF], [GLESEQ_COS_DEF], [GLACODE_SALES_DEF], [GLACODE_COS_DEF], 
				CASE 
					WHEN BILL_TYPE_FLAG = 1 THEN
						(COALESCE(COMM_AMT,0) + COALESCE(REBATE_AMT,0)) + CASE WHEN TAX_RESALE = 1 THEN b.STATE_TAX + b.COUNTY_TAX + b.CITY_TAX ELSE COALESCE([STATE_AMT],0) + COALESCE([COUNTY_TAX],0) + COALESCE([CITY_TAX],0) END
					WHEN BILL_TYPE_FLAG = 2 THEN
						COALESCE(EXT_NET_AMT,0) + COALESCE(NETCHARGE,0) + CASE WHEN TAX_RESALE = 1 THEN b.STATE_TAX + b.COUNTY_TAX + b.CITY_TAX ELSE COALESCE([STATE_AMT],0) + COALESCE([COUNTY_TAX],0) + COALESCE([CITY_TAX],0) END + COALESCE(NON_RESALE_AMT,0) +
						@addl_charge + COALESCE(DISCOUNT_AMT,0)
					WHEN BILL_TYPE_FLAG = 3 THEN
						CASE WHEN TAX_RESALE = 1 THEN b.STATE_TAX + b.COUNTY_TAX + b.CITY_TAX ELSE COALESCE([STATE_AMT],0) + COALESCE([COUNTY_TAX],0) + COALESCE([CITY_TAX],0) END + COALESCE(NON_RESALE_AMT,0) + COALESCE(EXT_NET_AMT,0) + COALESCE(NETCHARGE,0) +
						COALESCE(DISCOUNT_AMT,0) + @addl_charge + COALESCE(COMM_AMT,0) + COALESCE(REBATE_AMT,0)
				END,
				[BILL_CANCELLED],
				[EST_NBR], [EST_LINE_NBR], [EST_REV_NBR], [FLAT_NETCHARGE], [FLAT_ADDL_CHARGE], [FLAT_DISCOUNT_AMT], [PRODUCTION_SIZE],
				[MAT_COMP], [SIZE_CODE], [COST_TYPE], [COST_RATE], [RATE_TYPE], [NP_CIRCULATION], [PRINT_QUANTITY]
			FROM dbo.NEWSPAPER_DETAIL a
				INNER JOIN (
					SELECT * FROM [advtf_calc_tax](@TAXAPPLYAI, @TAXAPPLYC, @TAXAPPLYLN, @TAXAPPLYNC, @TAXAPPLYND, @TAXAPPLYR, @addl_charge, @COMMISSION_AMT, @NET_AMT, @NET_CHARGE, @DISCOUNT, @REBATE_AMT, @STATE_PCT, @COUNTY_PCT, @CITY_PCT)
					) b ON 1=1
			WHERE ORDER_NBR = @order_nbr 
			AND LINE_NBR = @line_nbr 
			AND ACTIVE_REV = 1
			AND COALESCE(LINE_CANCELLED, 0) = 0

			UPDATE dbo.NEWSPAPER_DETAIL SET ACTIVE_REV = NULL
			WHERE ORDER_NBR = @order_nbr 
			AND LINE_NBR = @line_nbr 
			AND REV_NBR = @rev_nbr 
			AND SEQ_NBR = @seq_nbr 

		END
		IF @media_type = 'O' BEGIN
		
			SELECT @rev_nbr = REV_NBR, @seq_nbr = SEQ_NBR, @TAXAPPLYAI = TAXAPPLYAI, @TAXAPPLYC = TAXAPPLYC, @TAXAPPLYLN = TAXAPPLYLN, @TAXAPPLYNC = TAXAPPLYNC, @TAXAPPLYND = TAXAPPLYND, @TAXAPPLYR = TAXAPPLYR,
					@COMMISSION_AMT = COMM_AMT, @NET_AMT = EXT_NET_AMT, @NET_CHARGE = NETCHARGE, @DISCOUNT = DISCOUNT_AMT, @REBATE_AMT = REBATE_AMT,
					@STATE_PCT = TAX_STATE_PCT, @COUNTY_PCT = TAX_COUNTY_PCT, @CITY_PCT = TAX_CITY_PCT
			FROM dbo.OUTDOOR_DETAIL
			WHERE ORDER_NBR = @order_nbr 
			AND LINE_NBR = @line_nbr 
			AND ACTIVE_REV = 1
			AND COALESCE(LINE_CANCELLED, 0) = 0

			--reversal row
			INSERT INTO [dbo].[OUTDOOR_DETAIL]
				([ORDER_NBR], [LINE_NBR], [REV_NBR], [SEQ_NBR], [ACTIVE_REV], [LINK_DETID], [POST_DATE], [END_DATE], [CLOSE_DATE]
				,[MATL_CLOSE_DATE], [EXT_CLOSE_DATE], [EXT_MATL_DATE], [HEADLINE], [OUTDOOR_TYPE], [SIZE]
				,[LOCATION], [COPY_AREA]
				,[JOB_NUMBER], [JOB_COMPONENT_NBR], [RATE_CARD], [RATE_TYPE], [RATE_DESC]
				,[QUANTITY], [RATE], [NET_RATE], [GROSS_RATE], [EXT_NET_AMT], [EXT_GROSS_AMT], [COMM_AMT], [REBATE_AMT]
				,[DISCOUNT_AMT], [DISCOUNT_DESC], [STATE_AMT], [COUNTY_AMT], [CITY_AMT], [NON_RESALE_AMT], [NETCHARGE], [NCDESC]
				,[ADDL_CHARGE], [ADDL_CHARGE_DESC], [LINE_TOTAL] --,[LINE_CANCELLED]
				,[DATE_TO_BILL]
				--,[BILLING_USER], [AR_INV_NBR], [AR_TYPE], [AR_INV_SEQ], [GLEXACT], [GLESEQ_SALES], [GLESEQ_COS], [GLESEQ_WIP]
				--,[GLESEQ_STATE], [GLESEQ_COUNTY], [GLESEQ_CITY], [GLEXACT_DEF], [GLACODE_SALES], [GLACODE_COS], [GLACODE_WIP]
				--,[GLACODE_STATE], [GLACODE_COUNTY], [GLACODE_CITY]
				,[NON_BILL_FLAG]
				,[MODIFIED_BY], [MODIFIED_DATE], [MODIFIED_COMMENTS], [BILL_TYPE_FLAG]
				,[COMM_PCT], [MARKUP_PCT], [REBATE_PCT], [DISCOUNT_PCT]
				,[TAX_CODE], [TAX_CITY_PCT], [TAX_COUNTY_PCT], [TAX_STATE_PCT], [TAX_RESALE]
				,[TAXAPPLYC], [TAXAPPLYLN], [TAXAPPLYND], [TAXAPPLYNC], [TAXAPPLYR], [TAXAPPLYAI]
				--,[RECONCILE_FLAG], [GLESEQ_SALES_DEF], [GLESEQ_COS_DEF], [GLACODE_SALES_DEF], [GLACODE_COS_DEF]
				,[BILLING_AMT] --, [BILL_CANCELLED]
				,[EST_NBR], [EST_LINE_NBR], [EST_REV_NBR], [AD_NUMBER], [MAT_COMP], [IMPRESSIONS], [ACTUAL_IMPRESSIONS])
			SELECT
				[ORDER_NBR], [LINE_NBR], [REV_NBR], SEQ_NBR + 1, NULL AS ACTIVE_REV, [LINK_DETID], [POST_DATE], [END_DATE], [CLOSE_DATE]
				,[MATL_CLOSE_DATE], [EXT_CLOSE_DATE], [EXT_MATL_DATE], [HEADLINE], [OUTDOOR_TYPE], [SIZE]
				,[LOCATION], [COPY_AREA]
				,[JOB_NUMBER], [JOB_COMPONENT_NBR], [RATE_CARD], [RATE_TYPE], [RATE_DESC]
				,-1 * [QUANTITY], [RATE], [NET_RATE], [GROSS_RATE], -1 * [EXT_NET_AMT], -1 * [EXT_GROSS_AMT], -1 * [COMM_AMT], -1 * [REBATE_AMT]
				,-1 * [DISCOUNT_AMT], [DISCOUNT_DESC], -1 * [STATE_AMT], -1 * [COUNTY_AMT], -1 * [CITY_AMT], -1 * [NON_RESALE_AMT], -1 * [NETCHARGE], [NCDESC]
				,-1 * [ADDL_CHARGE], [ADDL_CHARGE_DESC], -1 * [LINE_TOTAL] --,[LINE_CANCELLED]
				,[DATE_TO_BILL]
				--,[BILLING_USER], [AR_INV_NBR], [AR_TYPE], [AR_INV_SEQ], [GLEXACT], [GLESEQ_SALES], [GLESEQ_COS], [GLESEQ_WIP]
				--,[GLESEQ_STATE], [GLESEQ_COUNTY], [GLESEQ_CITY], [GLEXACT_DEF], [GLACODE_SALES], [GLACODE_COS], [GLACODE_WIP]
				--,[GLACODE_STATE], [GLACODE_COUNTY], [GLACODE_CITY]
				,[NON_BILL_FLAG]
				,@user_code AS MODIFIED_BY, getdate() AS MODIFIED_DATE, 'MM writeoff reversal', [BILL_TYPE_FLAG]
				,[COMM_PCT], [MARKUP_PCT], [REBATE_PCT], [DISCOUNT_PCT]
				,[TAX_CODE], [TAX_CITY_PCT], [TAX_COUNTY_PCT], [TAX_STATE_PCT], [TAX_RESALE]
				,[TAXAPPLYC], [TAXAPPLYLN], [TAXAPPLYND], [TAXAPPLYNC], [TAXAPPLYR], [TAXAPPLYAI]
				--,[RECONCILE_FLAG], [GLESEQ_SALES_DEF], [GLESEQ_COS_DEF], [GLACODE_SALES_DEF], [GLACODE_COS_DEF]
				,-1 * [BILLING_AMT] --, [BILL_CANCELLED]
				,[EST_NBR], [EST_LINE_NBR], [EST_REV_NBR], [AD_NUMBER], [MAT_COMP], -1 * [IMPRESSIONS], -1 * [ACTUAL_IMPRESSIONS]
			FROM dbo.OUTDOOR_DETAIL 
			WHERE ORDER_NBR = @order_nbr 
			AND LINE_NBR = @line_nbr 
			AND ACTIVE_REV = 1
			AND COALESCE(LINE_CANCELLED, 0) = 0

			--new row
			INSERT INTO [dbo].[OUTDOOR_DETAIL]
				([ORDER_NBR], [LINE_NBR], [REV_NBR], [SEQ_NBR], [ACTIVE_REV], [LINK_DETID], [POST_DATE], [END_DATE], [CLOSE_DATE]
				,[MATL_CLOSE_DATE], [EXT_CLOSE_DATE], [EXT_MATL_DATE], [HEADLINE], [OUTDOOR_TYPE], [SIZE]
				,[LOCATION], [COPY_AREA]
				,[JOB_NUMBER], [JOB_COMPONENT_NBR], [RATE_CARD], [RATE_TYPE], [RATE_DESC]
				,[QUANTITY], [RATE], [NET_RATE], [GROSS_RATE], [EXT_NET_AMT], [EXT_GROSS_AMT], [COMM_AMT], [REBATE_AMT]
				,[DISCOUNT_AMT], [DISCOUNT_DESC], [STATE_AMT], [COUNTY_AMT], [CITY_AMT], [NON_RESALE_AMT], [NETCHARGE], [NCDESC]
				,[ADDL_CHARGE], [ADDL_CHARGE_DESC], [LINE_TOTAL] --,[LINE_CANCELLED]
				,[DATE_TO_BILL]
				--,[BILLING_USER], [AR_INV_NBR], [AR_TYPE], [AR_INV_SEQ], [GLEXACT], [GLESEQ_SALES], [GLESEQ_COS], [GLESEQ_WIP]
				--,[GLESEQ_STATE], [GLESEQ_COUNTY], [GLESEQ_CITY], [GLEXACT_DEF], [GLACODE_SALES], [GLACODE_COS], [GLACODE_WIP]
				--,[GLACODE_STATE], [GLACODE_COUNTY], [GLACODE_CITY]
				,[NON_BILL_FLAG]
				,[MODIFIED_BY], [MODIFIED_DATE], [MODIFIED_COMMENTS], [BILL_TYPE_FLAG]
				,[COMM_PCT], [MARKUP_PCT], [REBATE_PCT], [DISCOUNT_PCT]
				,[TAX_CODE], [TAX_CITY_PCT], [TAX_COUNTY_PCT], [TAX_STATE_PCT], [TAX_RESALE]
				,[TAXAPPLYC], [TAXAPPLYLN], [TAXAPPLYND], [TAXAPPLYNC], [TAXAPPLYR], [TAXAPPLYAI]
				--,[RECONCILE_FLAG], [GLESEQ_SALES_DEF], [GLESEQ_COS_DEF], [GLACODE_SALES_DEF], [GLACODE_COS_DEF]
				,[BILLING_AMT] --, [BILL_CANCELLED]
				,[EST_NBR], [EST_LINE_NBR], [EST_REV_NBR], [AD_NUMBER], [MAT_COMP], [IMPRESSIONS], [ACTUAL_IMPRESSIONS])
			SELECT
				[ORDER_NBR], [LINE_NBR], REV_NBR + 1, 0 SEQ_NBR, 1 AS ACTIVE_REV, [LINK_DETID], [POST_DATE], [END_DATE], [CLOSE_DATE]
				,[MATL_CLOSE_DATE], [EXT_CLOSE_DATE], [EXT_MATL_DATE], [HEADLINE], [OUTDOOR_TYPE], [SIZE]
				,[LOCATION], [COPY_AREA]
				,[JOB_NUMBER], [JOB_COMPONENT_NBR], [RATE_CARD], [RATE_TYPE], [RATE_DESC]
				,[QUANTITY], [RATE], [NET_RATE], [GROSS_RATE], [EXT_NET_AMT], [EXT_GROSS_AMT], [COMM_AMT], [REBATE_AMT]
				,[DISCOUNT_AMT], [DISCOUNT_DESC], 
				CASE WHEN TAX_RESALE = 1 THEN b.STATE_TAX ELSE [STATE_AMT] END, 
				CASE WHEN TAX_RESALE = 1 THEN b.COUNTY_TAX ELSE [COUNTY_AMT] END,
				CASE WHEN TAX_RESALE = 1 THEN b.CITY_TAX ELSE [CITY_AMT] END, [NON_RESALE_AMT], [NETCHARGE], NULL AS [NCDESC]
				,@addl_charge as ADDL_CHARGE, NULL AS [ADDL_CHARGE_DESC], [LINE_TOTAL] --,[LINE_CANCELLED]
				,[DATE_TO_BILL]
				--,[BILLING_USER], [AR_INV_NBR], [AR_TYPE], [AR_INV_SEQ], [GLEXACT], [GLESEQ_SALES], [GLESEQ_COS], [GLESEQ_WIP]
				--,[GLESEQ_STATE], [GLESEQ_COUNTY], [GLESEQ_CITY], [GLEXACT_DEF], [GLACODE_SALES], [GLACODE_COS], [GLACODE_WIP]
				--,[GLACODE_STATE], [GLACODE_COUNTY], [GLACODE_CITY]
				,[NON_BILL_FLAG]
				,@user_code AS MODIFIED_BY, getdate() AS MODIFIED_DATE, 'MM writeoff new', [BILL_TYPE_FLAG]
				,[COMM_PCT], [MARKUP_PCT], [REBATE_PCT], [DISCOUNT_PCT]
				,[TAX_CODE], [TAX_CITY_PCT], [TAX_COUNTY_PCT], [TAX_STATE_PCT], [TAX_RESALE]
				,[TAXAPPLYC], [TAXAPPLYLN], [TAXAPPLYND], [TAXAPPLYNC], [TAXAPPLYR], [TAXAPPLYAI]
				--,[RECONCILE_FLAG], [GLESEQ_SALES_DEF], [GLESEQ_COS_DEF], [GLACODE_SALES_DEF], [GLACODE_COS_DEF]
				,CASE 
					WHEN BILL_TYPE_FLAG = 1 THEN
						(COALESCE(COMM_AMT,0) + COALESCE(REBATE_AMT,0)) + CASE WHEN TAX_RESALE = 1 THEN b.STATE_TAX + b.COUNTY_TAX + b.CITY_TAX ELSE COALESCE([STATE_AMT],0) + COALESCE([COUNTY_TAX],0) + COALESCE([CITY_TAX],0) END
					WHEN BILL_TYPE_FLAG = 2 THEN
						COALESCE(EXT_NET_AMT,0) + COALESCE(NETCHARGE,0) + CASE WHEN TAX_RESALE = 1 THEN b.STATE_TAX + b.COUNTY_TAX + b.CITY_TAX ELSE COALESCE([STATE_AMT],0) + COALESCE([COUNTY_TAX],0) + COALESCE([CITY_TAX],0) END + COALESCE(NON_RESALE_AMT,0) +
						@addl_charge + COALESCE(DISCOUNT_AMT,0)
					WHEN BILL_TYPE_FLAG = 3 THEN
						CASE WHEN TAX_RESALE = 1 THEN b.STATE_TAX + b.COUNTY_TAX + b.CITY_TAX ELSE COALESCE([STATE_AMT],0) + COALESCE([COUNTY_TAX],0) + COALESCE([CITY_TAX],0) END + COALESCE(NON_RESALE_AMT,0) + COALESCE(EXT_NET_AMT,0) + COALESCE(NETCHARGE,0) +
						COALESCE(DISCOUNT_AMT,0) + @addl_charge + COALESCE(COMM_AMT,0) + COALESCE(REBATE_AMT,0)
				END --, [BILL_CANCELLED]
				,[EST_NBR], [EST_LINE_NBR], [EST_REV_NBR], [AD_NUMBER], [MAT_COMP], [IMPRESSIONS], [ACTUAL_IMPRESSIONS]
			FROM dbo.OUTDOOR_DETAIL a
				INNER JOIN (
				SELECT * FROM [advtf_calc_tax](@TAXAPPLYAI, @TAXAPPLYC, @TAXAPPLYLN, @TAXAPPLYNC, @TAXAPPLYND, @TAXAPPLYR, @addl_charge, @COMMISSION_AMT, @NET_AMT, @NET_CHARGE, @DISCOUNT, @REBATE_AMT, @STATE_PCT, @COUNTY_PCT, @CITY_PCT)
				) b ON 1=1
			WHERE ORDER_NBR = @order_nbr 
			AND LINE_NBR = @line_nbr 
			AND ACTIVE_REV = 1
			AND COALESCE(LINE_CANCELLED, 0) = 0

			UPDATE dbo.OUTDOOR_DETAIL SET ACTIVE_REV = NULL
			WHERE ORDER_NBR = @order_nbr 
			AND LINE_NBR = @line_nbr 
			AND REV_NBR = @rev_nbr 
			AND SEQ_NBR = @seq_nbr 

		END
		IF @media_type = 'R' BEGIN
		
			SELECT @rev_nbr = REV_NBR, @seq_nbr = SEQ_NBR, @TAXAPPLYAI = TAXAPPLYAI, @TAXAPPLYC = TAXAPPLYC, @TAXAPPLYLN = TAXAPPLYLN, @TAXAPPLYNC = TAXAPPLYNC, @TAXAPPLYND = TAXAPPLYND, @TAXAPPLYR = TAXAPPLYR,
					@COMMISSION_AMT = COMM_AMT, @NET_AMT = EXT_NET_AMT, @NET_CHARGE = NETCHARGE, @DISCOUNT = DISCOUNT_AMT, @REBATE_AMT = REBATE_AMT,
					@STATE_PCT = TAX_STATE_PCT, @COUNTY_PCT = TAX_COUNTY_PCT, @CITY_PCT = TAX_CITY_PCT
			FROM dbo.RADIO_DETAIL
			WHERE ORDER_NBR = @order_nbr 
			AND LINE_NBR = @line_nbr 
			AND ACTIVE_REV = 1
			AND COALESCE(LINE_CANCELLED, 0) = 0

			--reversal row
			INSERT INTO [dbo].[RADIO_DETAIL] (
				[ORDER_NBR], [LINE_NBR], [REV_NBR], [SEQ_NBR], [ACTIVE_REV], [LINK_DETID], [START_DATE], [END_DATE], [CLOSE_DATE], [MATL_CLOSE_DATE], [EXT_CLOSE_DATE], [EXT_MATL_DATE], 
				[BUY_TYPE], [MONTH_NBR], [YEAR_NBR], [DATE1], [DATE2], [DATE3], [DATE4], [DATE5], [DATE6], [DATE7], [MONDAY], [TUESDAY], [WEDNESDAY], [THURSDAY], [FRIDAY], [SATURDAY], [SUNDAY], 
				[SPOTS1], [SPOTS2], [SPOTS3], [SPOTS4], [SPOTS5], [SPOTS6], [SPOTS7], [TOTAL_SPOTS], [JOB_NUMBER], [JOB_COMPONENT_NBR], [QUANTITY], [RATE], [NET_RATE], [GROSS_RATE], 
				[EXT_NET_AMT], [EXT_GROSS_AMT], [COMM_AMT], [REBATE_AMT], [DISCOUNT_AMT], [DISCOUNT_DESC], [STATE_AMT], [COUNTY_AMT], [CITY_AMT], [NON_RESALE_AMT], 
				[NETCHARGE], [NCDESC], [ADDL_CHARGE], [ADDL_CHARGE_DESC], [LINE_TOTAL], 
				--[LINE_CANCELLED], 
				[DATE_TO_BILL], 
				--[BILLING_USER], [AR_INV_NBR], [AR_TYPE], [AR_INV_SEQ], 
				--[GLEXACT], [GLESEQ_SALES], [GLESEQ_COS], [GLESEQ_WIP], [GLESEQ_STATE], [GLESEQ_COUNTY], [GLESEQ_CITY], [GLEXACT_DEF], [GLACODE_SALES], [GLACODE_COS], [GLACODE_WIP], 
				--[GLACODE_STATE], [GLACODE_COUNTY], [GLACODE_CITY], 
				[NON_BILL_FLAG], 
				[MODIFIED_BY], [MODIFIED_DATE], [MODIFIED_COMMENTS], 
				[BILL_TYPE_FLAG], [COMM_PCT], [MARKUP_PCT], [REBATE_PCT], [DISCOUNT_PCT], [TAX_CODE], [TAX_CITY_PCT], [TAX_COUNTY_PCT], [TAX_STATE_PCT], 
				[TAX_RESALE], [TAXAPPLYC], [TAXAPPLYLN], [TAXAPPLYND], [TAXAPPLYNC], [TAXAPPLYR], [TAXAPPLYAI], [RECONCILE_FLAG], 
				--[GLESEQ_SALES_DEF], [GLESEQ_COS_DEF], [GLACODE_SALES_DEF], [GLACODE_COS_DEF], 
				[BILLING_AMT], --[BILL_CANCELLED], 
				[EST_NBR], [EST_LINE_NBR], [EST_REV_NBR], [AD_NUMBER], [MAT_COMP], [COST_TYPE], [COST_RATE], [NET_BASE_RATE], [GROSS_BASE_RATE], 
				[PROGRAMMING], [START_TIME], [END_TIME], [LENGTH], [REMARKS], [TAG], [NETWORK_ID],
				[DAY_PART_ID], [ADDED_VALUE], [LINK_LINE_NUMBER])
			SELECT
				[ORDER_NBR], [LINE_NBR], [REV_NBR], SEQ_NBR + 1, NULL AS ACTIVE_REV, [LINK_DETID], [START_DATE], [END_DATE], [CLOSE_DATE], [MATL_CLOSE_DATE], [EXT_CLOSE_DATE], [EXT_MATL_DATE], 
				[BUY_TYPE], [MONTH_NBR], [YEAR_NBR], [DATE1], [DATE2], [DATE3], [DATE4], [DATE5], [DATE6], [DATE7], [MONDAY], [TUESDAY], [WEDNESDAY], [THURSDAY], [FRIDAY], [SATURDAY], [SUNDAY], 
				-1 * [SPOTS1], -1 * [SPOTS2], -1 * [SPOTS3], -1 * [SPOTS4], -1 * [SPOTS5], -1 * [SPOTS6], -1 * [SPOTS7], -1 * [TOTAL_SPOTS], [JOB_NUMBER], [JOB_COMPONENT_NBR], -1 * [QUANTITY], [RATE], [NET_RATE], [GROSS_RATE], 
				-1 * [EXT_NET_AMT], -1 * [EXT_GROSS_AMT], -1 * [COMM_AMT], -1 * [REBATE_AMT], -1 * [DISCOUNT_AMT], [DISCOUNT_DESC], -1 * [STATE_AMT], -1 * [COUNTY_AMT], -1 * [CITY_AMT], -1 * [NON_RESALE_AMT], 
				-1 * [NETCHARGE], [NCDESC], -1 * [ADDL_CHARGE], [ADDL_CHARGE_DESC], -1 * [LINE_TOTAL], 
				--[LINE_CANCELLED], 
				[DATE_TO_BILL], 
				--[BILLING_USER], [AR_INV_NBR], [AR_TYPE], [AR_INV_SEQ], 
				--[GLEXACT], [GLESEQ_SALES], [GLESEQ_COS], [GLESEQ_WIP], [GLESEQ_STATE], [GLESEQ_COUNTY], [GLESEQ_CITY], [GLEXACT_DEF], [GLACODE_SALES], [GLACODE_COS], [GLACODE_WIP], 
				--[GLACODE_STATE], [GLACODE_COUNTY], [GLACODE_CITY], 
				[NON_BILL_FLAG], 
				@user_code AS [MODIFIED_BY], getdate() AS [MODIFIED_DATE], 'MM writeoff reversal', 
				[BILL_TYPE_FLAG], [COMM_PCT], [MARKUP_PCT], [REBATE_PCT], [DISCOUNT_PCT], [TAX_CODE], [TAX_CITY_PCT], [TAX_COUNTY_PCT], [TAX_STATE_PCT], 
				[TAX_RESALE], [TAXAPPLYC], [TAXAPPLYLN], [TAXAPPLYND], [TAXAPPLYNC], [TAXAPPLYR], [TAXAPPLYAI], [RECONCILE_FLAG], 
				--[GLESEQ_SALES_DEF], [GLESEQ_COS_DEF], [GLACODE_SALES_DEF], [GLACODE_COS_DEF], 
				-1 * [BILLING_AMT], --[BILL_CANCELLED], 
				[EST_NBR], [EST_LINE_NBR], [EST_REV_NBR], [AD_NUMBER], [MAT_COMP], [COST_TYPE], [COST_RATE], [NET_BASE_RATE], [GROSS_BASE_RATE], 
				[PROGRAMMING], [START_TIME], [END_TIME], [LENGTH], [REMARKS], [TAG], [NETWORK_ID],
				[DAY_PART_ID], [ADDED_VALUE], [LINK_LINE_NUMBER]
			FROM dbo.RADIO_DETAIL
			WHERE ORDER_NBR = @order_nbr 
			AND LINE_NBR = @line_nbr 
			AND ACTIVE_REV = 1
			AND COALESCE(LINE_CANCELLED, 0) = 0

			--new row
			INSERT INTO [dbo].[RADIO_DETAIL] (
				[ORDER_NBR], [LINE_NBR], [REV_NBR], [SEQ_NBR], [ACTIVE_REV], [LINK_DETID], [START_DATE], [END_DATE], [CLOSE_DATE], [MATL_CLOSE_DATE], [EXT_CLOSE_DATE], [EXT_MATL_DATE], 
				[BUY_TYPE], [MONTH_NBR], [YEAR_NBR], [DATE1], [DATE2], [DATE3], [DATE4], [DATE5], [DATE6], [DATE7], [MONDAY], [TUESDAY], [WEDNESDAY], [THURSDAY], [FRIDAY], [SATURDAY], [SUNDAY], 
				[SPOTS1], [SPOTS2], [SPOTS3], [SPOTS4], [SPOTS5], [SPOTS6], [SPOTS7], [TOTAL_SPOTS], [JOB_NUMBER], [JOB_COMPONENT_NBR], [QUANTITY], [RATE], [NET_RATE], [GROSS_RATE], 
				[EXT_NET_AMT], [EXT_GROSS_AMT], [COMM_AMT], [REBATE_AMT], [DISCOUNT_AMT], [DISCOUNT_DESC], [STATE_AMT], [COUNTY_AMT], [CITY_AMT], [NON_RESALE_AMT], 
				[NETCHARGE], [NCDESC], [ADDL_CHARGE], [ADDL_CHARGE_DESC], [LINE_TOTAL], 
				--[LINE_CANCELLED], 
				[DATE_TO_BILL], 
				--[BILLING_USER], [AR_INV_NBR], [AR_TYPE], [AR_INV_SEQ], 
				--[GLEXACT], [GLESEQ_SALES], [GLESEQ_COS], [GLESEQ_WIP], [GLESEQ_STATE], [GLESEQ_COUNTY], [GLESEQ_CITY], [GLEXACT_DEF], [GLACODE_SALES], [GLACODE_COS], [GLACODE_WIP], 
				--[GLACODE_STATE], [GLACODE_COUNTY], [GLACODE_CITY], 
				[NON_BILL_FLAG], 
				[MODIFIED_BY], [MODIFIED_DATE], [MODIFIED_COMMENTS], 
				[BILL_TYPE_FLAG], [COMM_PCT], [MARKUP_PCT], [REBATE_PCT], [DISCOUNT_PCT], [TAX_CODE], [TAX_CITY_PCT], [TAX_COUNTY_PCT], [TAX_STATE_PCT], 
				[TAX_RESALE], [TAXAPPLYC], [TAXAPPLYLN], [TAXAPPLYND], [TAXAPPLYNC], [TAXAPPLYR], [TAXAPPLYAI], [RECONCILE_FLAG], 
				--[GLESEQ_SALES_DEF], [GLESEQ_COS_DEF], [GLACODE_SALES_DEF], [GLACODE_COS_DEF], 
				[BILLING_AMT], --[BILL_CANCELLED], 
				[EST_NBR], [EST_LINE_NBR], [EST_REV_NBR], [AD_NUMBER], [MAT_COMP], [COST_TYPE], [COST_RATE], [NET_BASE_RATE], [GROSS_BASE_RATE], 
				[PROGRAMMING], [START_TIME], [END_TIME], [LENGTH], [REMARKS], [TAG], [NETWORK_ID],
				[DAY_PART_ID], [ADDED_VALUE], [LINK_LINE_NUMBER])
			SELECT
				[ORDER_NBR], [LINE_NBR], REV_NBR + 1, 0 SEQ_NBR, 1 AS ACTIVE_REV, [LINK_DETID], [START_DATE], [END_DATE], [CLOSE_DATE], [MATL_CLOSE_DATE], [EXT_CLOSE_DATE], [EXT_MATL_DATE], 
				[BUY_TYPE], [MONTH_NBR], [YEAR_NBR], [DATE1], [DATE2], [DATE3], [DATE4], [DATE5], [DATE6], [DATE7], [MONDAY], [TUESDAY], [WEDNESDAY], [THURSDAY], [FRIDAY], [SATURDAY], [SUNDAY], 
				[SPOTS1], [SPOTS2], [SPOTS3], [SPOTS4], [SPOTS5], [SPOTS6], [SPOTS7], [TOTAL_SPOTS], [JOB_NUMBER], [JOB_COMPONENT_NBR], [QUANTITY], [RATE], [NET_RATE], [GROSS_RATE], 
				[EXT_NET_AMT], [EXT_GROSS_AMT], [COMM_AMT], [REBATE_AMT], [DISCOUNT_AMT], [DISCOUNT_DESC],
				CASE WHEN TAX_RESALE = 1 THEN b.STATE_TAX ELSE [STATE_AMT] END, 
				CASE WHEN TAX_RESALE = 1 THEN b.COUNTY_TAX ELSE [COUNTY_AMT] END,
				CASE WHEN TAX_RESALE = 1 THEN b.CITY_TAX ELSE [CITY_AMT] END,
				[NON_RESALE_AMT], 
				[NETCHARGE], [NCDESC], @addl_charge as ADDL_CHARGE, [ADDL_CHARGE_DESC], [LINE_TOTAL], 
				--[LINE_CANCELLED], 
				[DATE_TO_BILL], 
				--[BILLING_USER], [AR_INV_NBR], [AR_TYPE], [AR_INV_SEQ], 
				--[GLEXACT], [GLESEQ_SALES], [GLESEQ_COS], [GLESEQ_WIP], [GLESEQ_STATE], [GLESEQ_COUNTY], [GLESEQ_CITY], [GLEXACT_DEF], [GLACODE_SALES], [GLACODE_COS], [GLACODE_WIP], 
				--[GLACODE_STATE], [GLACODE_COUNTY], [GLACODE_CITY], 
				[NON_BILL_FLAG], 
				@user_code AS [MODIFIED_BY], getdate() AS [MODIFIED_DATE], 'MM writeoff new', 
				[BILL_TYPE_FLAG], [COMM_PCT], [MARKUP_PCT], [REBATE_PCT], [DISCOUNT_PCT], [TAX_CODE], [TAX_CITY_PCT], [TAX_COUNTY_PCT], [TAX_STATE_PCT], 
				[TAX_RESALE], [TAXAPPLYC], [TAXAPPLYLN], [TAXAPPLYND], [TAXAPPLYNC], [TAXAPPLYR], [TAXAPPLYAI], [RECONCILE_FLAG], 
				--[GLESEQ_SALES_DEF], [GLESEQ_COS_DEF], [GLACODE_SALES_DEF], [GLACODE_COS_DEF], 
				CASE 
					WHEN BILL_TYPE_FLAG = 1 THEN
						(COALESCE(COMM_AMT,0) + COALESCE(REBATE_AMT,0)) + CASE WHEN TAX_RESALE = 1 THEN b.STATE_TAX + b.COUNTY_TAX + b.CITY_TAX ELSE COALESCE([STATE_AMT],0) + COALESCE([COUNTY_TAX],0) + COALESCE([CITY_TAX],0) END
					WHEN BILL_TYPE_FLAG = 2 THEN
						COALESCE(EXT_NET_AMT,0) + COALESCE(NETCHARGE,0) + CASE WHEN TAX_RESALE = 1 THEN b.STATE_TAX + b.COUNTY_TAX + b.CITY_TAX ELSE COALESCE([STATE_AMT],0) + COALESCE([COUNTY_TAX],0) + COALESCE([CITY_TAX],0) END + COALESCE(NON_RESALE_AMT,0) +
						@addl_charge + COALESCE(DISCOUNT_AMT,0)
					WHEN BILL_TYPE_FLAG = 3 THEN
						CASE WHEN TAX_RESALE = 1 THEN b.STATE_TAX + b.COUNTY_TAX + b.CITY_TAX ELSE COALESCE([STATE_AMT],0) + COALESCE([COUNTY_TAX],0) + COALESCE([CITY_TAX],0) END + COALESCE(NON_RESALE_AMT,0) + COALESCE(EXT_NET_AMT,0) + COALESCE(NETCHARGE,0) +
						COALESCE(DISCOUNT_AMT,0) + @addl_charge + COALESCE(COMM_AMT,0) + COALESCE(REBATE_AMT,0)
				END, --[BILL_CANCELLED], 
				[EST_NBR], [EST_LINE_NBR], [EST_REV_NBR], [AD_NUMBER], [MAT_COMP], [COST_TYPE], [COST_RATE], [NET_BASE_RATE], [GROSS_BASE_RATE], 
				[PROGRAMMING], [START_TIME], [END_TIME], [LENGTH], [REMARKS], [TAG], [NETWORK_ID],
				[DAY_PART_ID], [ADDED_VALUE], [LINK_LINE_NUMBER]
			FROM dbo.RADIO_DETAIL a
				INNER JOIN (
					SELECT * FROM [advtf_calc_tax](@TAXAPPLYAI, @TAXAPPLYC, @TAXAPPLYLN, @TAXAPPLYNC, @TAXAPPLYND, @TAXAPPLYR, @addl_charge, @COMMISSION_AMT, @NET_AMT, @NET_CHARGE, @DISCOUNT, @REBATE_AMT, @STATE_PCT, @COUNTY_PCT, @CITY_PCT)
					) b ON 1=1
			WHERE ORDER_NBR = @order_nbr 
			AND LINE_NBR = @line_nbr 
			AND ACTIVE_REV = 1
			AND COALESCE(LINE_CANCELLED, 0) = 0

			UPDATE dbo.RADIO_DETAIL SET ACTIVE_REV = NULL
			WHERE ORDER_NBR = @order_nbr 
			AND LINE_NBR = @line_nbr 
			AND REV_NBR = @rev_nbr 
			AND SEQ_NBR = @seq_nbr 

		END
		IF @media_type = 'T' BEGIN
		
			SELECT @rev_nbr = REV_NBR, @seq_nbr = SEQ_NBR, @TAXAPPLYAI = TAXAPPLYAI, @TAXAPPLYC = TAXAPPLYC, @TAXAPPLYLN = TAXAPPLYLN, @TAXAPPLYNC = TAXAPPLYNC, @TAXAPPLYND = TAXAPPLYND, @TAXAPPLYR = TAXAPPLYR,
					@COMMISSION_AMT = COMM_AMT, @NET_AMT = EXT_NET_AMT, @NET_CHARGE = NETCHARGE, @DISCOUNT = DISCOUNT_AMT, @REBATE_AMT = REBATE_AMT,
					@STATE_PCT = TAX_STATE_PCT, @COUNTY_PCT = TAX_COUNTY_PCT, @CITY_PCT = TAX_CITY_PCT
			FROM dbo.TV_DETAIL
			WHERE ORDER_NBR = @order_nbr 
			AND LINE_NBR = @line_nbr 
			AND ACTIVE_REV = 1
			AND COALESCE(LINE_CANCELLED, 0) = 0

			--reversal row
			INSERT INTO [dbo].[TV_DETAIL] (
				[ORDER_NBR], [LINE_NBR], [REV_NBR], [SEQ_NBR], [ACTIVE_REV], [LINK_DETID], [START_DATE], [END_DATE], [CLOSE_DATE], [MATL_CLOSE_DATE], [EXT_CLOSE_DATE], [EXT_MATL_DATE], 
				[BUY_TYPE], [MONTH_NBR], [YEAR_NBR], [DATE1], [DATE2], [DATE3], [DATE4], [DATE5], [DATE6], [DATE7], [MONDAY], [TUESDAY], [WEDNESDAY], [THURSDAY], [FRIDAY], [SATURDAY], [SUNDAY], 
				[SPOTS1], [SPOTS2], [SPOTS3], [SPOTS4], [SPOTS5], [SPOTS6], [SPOTS7], [TOTAL_SPOTS], [JOB_NUMBER], [JOB_COMPONENT_NBR], [QUANTITY], [RATE], [NET_RATE], [GROSS_RATE], 
				[EXT_NET_AMT], [EXT_GROSS_AMT], [COMM_AMT], [REBATE_AMT], [DISCOUNT_AMT], [DISCOUNT_DESC], [STATE_AMT], [COUNTY_AMT], [CITY_AMT], [NON_RESALE_AMT], 
				[NETCHARGE], [NCDESC], [ADDL_CHARGE], [ADDL_CHARGE_DESC], [LINE_TOTAL], 
				--[LINE_CANCELLED], 
				[DATE_TO_BILL], 
				--[BILLING_USER], [AR_INV_NBR], [AR_TYPE], [AR_INV_SEQ], 
				--[GLEXACT], [GLESEQ_SALES], [GLESEQ_COS], [GLESEQ_WIP], [GLESEQ_STATE], [GLESEQ_COUNTY], [GLESEQ_CITY], [GLEXACT_DEF], [GLACODE_SALES], [GLACODE_COS], [GLACODE_WIP], 
				--[GLACODE_STATE], [GLACODE_COUNTY], [GLACODE_CITY], 
				[NON_BILL_FLAG], 
				[MODIFIED_BY], [MODIFIED_DATE], [MODIFIED_COMMENTS], 
				[BILL_TYPE_FLAG], [COMM_PCT], [MARKUP_PCT], [REBATE_PCT], [DISCOUNT_PCT], [TAX_CODE], [TAX_CITY_PCT], [TAX_COUNTY_PCT], [TAX_STATE_PCT], 
				[TAX_RESALE], [TAXAPPLYC], [TAXAPPLYLN], [TAXAPPLYND], [TAXAPPLYNC], [TAXAPPLYR], [TAXAPPLYAI], [RECONCILE_FLAG], 
				--[GLESEQ_SALES_DEF], [GLESEQ_COS_DEF], [GLACODE_SALES_DEF], [GLACODE_COS_DEF], 
				[BILLING_AMT], --[BILL_CANCELLED], 
				[EST_NBR], [EST_LINE_NBR], [EST_REV_NBR], [AD_NUMBER], [MAT_COMP], [COST_TYPE], [COST_RATE], [NET_BASE_RATE], [GROSS_BASE_RATE], 
				[PROGRAMMING], [START_TIME], [END_TIME], [LENGTH], [REMARKS], [TAG], [NETWORK_ID],
				[CABLE_NETWORK_STATION_CODE], [DAY_PART_ID], [ADDED_VALUE], [BOOKEND], [LINK_LINE_NUMBER])
			SELECT
				[ORDER_NBR], [LINE_NBR], [REV_NBR], SEQ_NBR + 1, NULL AS ACTIVE_REV, [LINK_DETID], [START_DATE], [END_DATE], [CLOSE_DATE], [MATL_CLOSE_DATE], [EXT_CLOSE_DATE], [EXT_MATL_DATE], 
				[BUY_TYPE], [MONTH_NBR], [YEAR_NBR], [DATE1], [DATE2], [DATE3], [DATE4], [DATE5], [DATE6], [DATE7], [MONDAY], [TUESDAY], [WEDNESDAY], [THURSDAY], [FRIDAY], [SATURDAY], [SUNDAY], 
				-1 * [SPOTS1], -1 * [SPOTS2], -1 * [SPOTS3], -1 * [SPOTS4], -1 * [SPOTS5], -1 * [SPOTS6], -1 * [SPOTS7], -1 * [TOTAL_SPOTS], [JOB_NUMBER], [JOB_COMPONENT_NBR], -1 * [QUANTITY], [RATE], [NET_RATE], [GROSS_RATE], 
				-1 * [EXT_NET_AMT], -1 * [EXT_GROSS_AMT], -1 * [COMM_AMT], -1 * [REBATE_AMT], -1 * [DISCOUNT_AMT], NULL AS [DISCOUNT_DESC], -1 * [STATE_AMT], -1 * [COUNTY_AMT], -1 * [CITY_AMT], -1 * [NON_RESALE_AMT], 
				-1 * [NETCHARGE], NULL AS [NCDESC], -1 * [ADDL_CHARGE], NULL AS [ADDL_CHARGE_DESC], -1 * [LINE_TOTAL], 
				--[LINE_CANCELLED], 
				[DATE_TO_BILL], 
				--[BILLING_USER], [AR_INV_NBR], [AR_TYPE], [AR_INV_SEQ], 
				--[GLEXACT], [GLESEQ_SALES], [GLESEQ_COS], [GLESEQ_WIP], [GLESEQ_STATE], [GLESEQ_COUNTY], [GLESEQ_CITY], [GLEXACT_DEF], [GLACODE_SALES], [GLACODE_COS], [GLACODE_WIP], 
				--[GLACODE_STATE], [GLACODE_COUNTY], [GLACODE_CITY], 
				[NON_BILL_FLAG], 
				@user_code AS [MODIFIED_BY], getdate() AS [MODIFIED_DATE], 'MM writeoff reversal', 
				[BILL_TYPE_FLAG], [COMM_PCT], [MARKUP_PCT], [REBATE_PCT], [DISCOUNT_PCT], [TAX_CODE], [TAX_CITY_PCT], [TAX_COUNTY_PCT], [TAX_STATE_PCT], 
				[TAX_RESALE], [TAXAPPLYC], [TAXAPPLYLN], [TAXAPPLYND], [TAXAPPLYNC], [TAXAPPLYR], [TAXAPPLYAI], [RECONCILE_FLAG], 
				--[GLESEQ_SALES_DEF], [GLESEQ_COS_DEF], [GLACODE_SALES_DEF], [GLACODE_COS_DEF], 
				-1 * [BILLING_AMT], --[BILL_CANCELLED], 
				[EST_NBR], [EST_LINE_NBR], [EST_REV_NBR], [AD_NUMBER], [MAT_COMP], [COST_TYPE], [COST_RATE], [NET_BASE_RATE], [GROSS_BASE_RATE], 
				[PROGRAMMING], [START_TIME], [END_TIME], [LENGTH], [REMARKS], [TAG], [NETWORK_ID],
				[CABLE_NETWORK_STATION_CODE], [DAY_PART_ID], [ADDED_VALUE], [BOOKEND], [LINK_LINE_NUMBER]
			FROM dbo.TV_DETAIL
			WHERE ORDER_NBR = @order_nbr 
			AND LINE_NBR = @line_nbr 
			AND ACTIVE_REV = 1
			AND COALESCE(LINE_CANCELLED, 0) = 0

			--new row
			INSERT INTO [dbo].[TV_DETAIL] (
				[ORDER_NBR], [LINE_NBR], [REV_NBR], [SEQ_NBR], [ACTIVE_REV], [LINK_DETID], [START_DATE], [END_DATE], [CLOSE_DATE], [MATL_CLOSE_DATE], [EXT_CLOSE_DATE], [EXT_MATL_DATE], 
				[BUY_TYPE], [MONTH_NBR], [YEAR_NBR], [DATE1], [DATE2], [DATE3], [DATE4], [DATE5], [DATE6], [DATE7], [MONDAY], [TUESDAY], [WEDNESDAY], [THURSDAY], [FRIDAY], [SATURDAY], [SUNDAY], 
				[SPOTS1], [SPOTS2], [SPOTS3], [SPOTS4], [SPOTS5], [SPOTS6], [SPOTS7], [TOTAL_SPOTS], [JOB_NUMBER], [JOB_COMPONENT_NBR], [QUANTITY], [RATE], [NET_RATE], [GROSS_RATE], 
				[EXT_NET_AMT], [EXT_GROSS_AMT], [COMM_AMT], [REBATE_AMT], [DISCOUNT_AMT], [DISCOUNT_DESC], [STATE_AMT], [COUNTY_AMT], [CITY_AMT], [NON_RESALE_AMT], 
				[NETCHARGE], [NCDESC], [ADDL_CHARGE], [ADDL_CHARGE_DESC], [LINE_TOTAL], 
				--[LINE_CANCELLED], 
				[DATE_TO_BILL], 
				--[BILLING_USER], [AR_INV_NBR], [AR_TYPE], [AR_INV_SEQ], 
				--[GLEXACT], [GLESEQ_SALES], [GLESEQ_COS], [GLESEQ_WIP], [GLESEQ_STATE], [GLESEQ_COUNTY], [GLESEQ_CITY], [GLEXACT_DEF], [GLACODE_SALES], [GLACODE_COS], [GLACODE_WIP], 
				--[GLACODE_STATE], [GLACODE_COUNTY], [GLACODE_CITY], 
				[NON_BILL_FLAG], 
				[MODIFIED_BY], [MODIFIED_DATE], [MODIFIED_COMMENTS], 
				[BILL_TYPE_FLAG], [COMM_PCT], [MARKUP_PCT], [REBATE_PCT], [DISCOUNT_PCT], [TAX_CODE], [TAX_CITY_PCT], [TAX_COUNTY_PCT], [TAX_STATE_PCT], 
				[TAX_RESALE], [TAXAPPLYC], [TAXAPPLYLN], [TAXAPPLYND], [TAXAPPLYNC], [TAXAPPLYR], [TAXAPPLYAI], [RECONCILE_FLAG], 
				--[GLESEQ_SALES_DEF], [GLESEQ_COS_DEF], [GLACODE_SALES_DEF], [GLACODE_COS_DEF], 
				[BILLING_AMT], --[BILL_CANCELLED], 
				[EST_NBR], [EST_LINE_NBR], [EST_REV_NBR], [AD_NUMBER], [MAT_COMP], [COST_TYPE], [COST_RATE], [NET_BASE_RATE], [GROSS_BASE_RATE], 
				[PROGRAMMING], [START_TIME], [END_TIME], [LENGTH], [REMARKS], [TAG], [NETWORK_ID],
				[CABLE_NETWORK_STATION_CODE], [DAY_PART_ID], [ADDED_VALUE], [BOOKEND], [LINK_LINE_NUMBER])
			SELECT
				[ORDER_NBR], [LINE_NBR], REV_NBR + 1, 0 SEQ_NBR, 1 AS ACTIVE_REV, [LINK_DETID], [START_DATE], [END_DATE], [CLOSE_DATE], [MATL_CLOSE_DATE], [EXT_CLOSE_DATE], [EXT_MATL_DATE], 
				[BUY_TYPE], [MONTH_NBR], [YEAR_NBR], [DATE1], [DATE2], [DATE3], [DATE4], [DATE5], [DATE6], [DATE7], [MONDAY], [TUESDAY], [WEDNESDAY], [THURSDAY], [FRIDAY], [SATURDAY], [SUNDAY], 
				[SPOTS1], [SPOTS2], [SPOTS3], [SPOTS4], [SPOTS5], [SPOTS6], [SPOTS7], [TOTAL_SPOTS], [JOB_NUMBER], [JOB_COMPONENT_NBR], [QUANTITY], [RATE], [NET_RATE], [GROSS_RATE], 
				[EXT_NET_AMT], [EXT_GROSS_AMT], [COMM_AMT], [REBATE_AMT], [DISCOUNT_AMT], NULL AS [DISCOUNT_DESC],
				CASE WHEN TAX_RESALE = 1 THEN b.STATE_TAX ELSE [STATE_AMT] END, 
				CASE WHEN TAX_RESALE = 1 THEN b.COUNTY_TAX ELSE [COUNTY_AMT] END,
				CASE WHEN TAX_RESALE = 1 THEN b.CITY_TAX ELSE [CITY_AMT] END,
				[NON_RESALE_AMT], 
				[NETCHARGE], NULL AS [NCDESC], @addl_charge as ADDL_CHARGE, NULL AS [ADDL_CHARGE_DESC], [LINE_TOTAL], 
				--[LINE_CANCELLED], 
				[DATE_TO_BILL], 
				--[BILLING_USER], [AR_INV_NBR], [AR_TYPE], [AR_INV_SEQ], 
				--[GLEXACT], [GLESEQ_SALES], [GLESEQ_COS], [GLESEQ_WIP], [GLESEQ_STATE], [GLESEQ_COUNTY], [GLESEQ_CITY], [GLEXACT_DEF], [GLACODE_SALES], [GLACODE_COS], [GLACODE_WIP], 
				--[GLACODE_STATE], [GLACODE_COUNTY], [GLACODE_CITY], 
				[NON_BILL_FLAG], 
				@user_code AS [MODIFIED_BY], getdate() AS [MODIFIED_DATE], 'MM writeoff new', 
				[BILL_TYPE_FLAG], [COMM_PCT], [MARKUP_PCT], [REBATE_PCT], [DISCOUNT_PCT], [TAX_CODE], [TAX_CITY_PCT], [TAX_COUNTY_PCT], [TAX_STATE_PCT], 
				[TAX_RESALE], [TAXAPPLYC], [TAXAPPLYLN], [TAXAPPLYND], [TAXAPPLYNC], [TAXAPPLYR], [TAXAPPLYAI], [RECONCILE_FLAG], 
				--[GLESEQ_SALES_DEF], [GLESEQ_COS_DEF], [GLACODE_SALES_DEF], [GLACODE_COS_DEF], 
				CASE 
					WHEN BILL_TYPE_FLAG = 1 THEN
						(COALESCE(COMM_AMT,0) + COALESCE(REBATE_AMT,0)) + CASE WHEN TAX_RESALE = 1 THEN b.STATE_TAX + b.COUNTY_TAX + b.CITY_TAX ELSE COALESCE([STATE_AMT],0) + COALESCE([COUNTY_TAX],0) + COALESCE([CITY_TAX],0) END
					WHEN BILL_TYPE_FLAG = 2 THEN
						COALESCE(EXT_NET_AMT,0) + COALESCE(NETCHARGE,0) + CASE WHEN TAX_RESALE = 1 THEN b.STATE_TAX + b.COUNTY_TAX + b.CITY_TAX ELSE COALESCE([STATE_AMT],0) + COALESCE([COUNTY_TAX],0) + COALESCE([CITY_TAX],0) END + COALESCE(NON_RESALE_AMT,0) +
						@addl_charge + COALESCE(DISCOUNT_AMT,0)
					WHEN BILL_TYPE_FLAG = 3 THEN
						CASE WHEN TAX_RESALE = 1 THEN b.STATE_TAX + b.COUNTY_TAX + b.CITY_TAX ELSE COALESCE([STATE_AMT],0) + COALESCE([COUNTY_TAX],0) + COALESCE([CITY_TAX],0) END + COALESCE(NON_RESALE_AMT,0) + COALESCE(EXT_NET_AMT,0) + COALESCE(NETCHARGE,0) +
						COALESCE(DISCOUNT_AMT,0) + @addl_charge + COALESCE(COMM_AMT,0) + COALESCE(REBATE_AMT,0)
				END, --[BILL_CANCELLED], 
				[EST_NBR], [EST_LINE_NBR], [EST_REV_NBR], [AD_NUMBER], [MAT_COMP], [COST_TYPE], [COST_RATE], [NET_BASE_RATE], [GROSS_BASE_RATE], 
				[PROGRAMMING], [START_TIME], [END_TIME], [LENGTH], [REMARKS], [TAG], [NETWORK_ID],
				[CABLE_NETWORK_STATION_CODE], [DAY_PART_ID], [ADDED_VALUE], [BOOKEND], [LINK_LINE_NUMBER]
			FROM dbo.TV_DETAIL a
				INNER JOIN (
					SELECT * FROM [advtf_calc_tax](@TAXAPPLYAI, @TAXAPPLYC, @TAXAPPLYLN, @TAXAPPLYNC, @TAXAPPLYND, @TAXAPPLYR, @addl_charge, @COMMISSION_AMT, @NET_AMT, @NET_CHARGE, @DISCOUNT, @REBATE_AMT, @STATE_PCT, @COUNTY_PCT, @CITY_PCT)
					) b ON 1=1
			WHERE ORDER_NBR = @order_nbr 
			AND LINE_NBR = @line_nbr 
			AND ACTIVE_REV = 1
			AND COALESCE(LINE_CANCELLED, 0) = 0

			UPDATE dbo.TV_DETAIL SET ACTIVE_REV = NULL
			WHERE ORDER_NBR = @order_nbr 
			AND LINE_NBR = @line_nbr 
			AND REV_NBR = @rev_nbr 
			AND SEQ_NBR = @seq_nbr 

		END

	COMMIT TRAN

	SELECT '' AS ErrorMessage

END TRY
BEGIN CATCH

	ROLLBACK TRAN
	
	SELECT ERROR_MESSAGE() as ErrorMessage;
        
END CATCH
GO
