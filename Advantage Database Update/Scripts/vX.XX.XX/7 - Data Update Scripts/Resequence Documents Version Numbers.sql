/*
	Update VERSION_NUMBER in DOCUMENTS ONLY FOR PROOFS!
*/
DECLARE
	@VERSIONS TABLE (ID INT IDENTITY, ALERT_ID INT, DOCUMENT_ID INT, VERSION_NUMBER INT);
DECLARE
	@ALERTS TABLE (ID INT IDENTITY, ALERT_ID INT);
DECLARE
	@ROW_COUNT INT,
	@COUNTER INT,
	@ALERT_ID INT
;
SELECT
	@ROW_COUNT = 0,
	@COUNTER = 0,
	@ALERT_ID = NULL
;
INSERT INTO @VERSIONS(ALERT_ID, DOCUMENT_ID, VERSION_NUMBER)
SELECT 
	A.ALERT_ID, D.DOCUMENT_ID, D.VERSION_NUMBER
FROM
	DOCUMENTS D WITH(NOLOCK)
	INNER JOIN ALERT_ATTACHMENT AA WITH(NOLOCK) ON D.DOCUMENT_ID = AA.DOCUMENT_ID
	INNER JOIN ALERT A WITH(NOLOCK) ON A.ALERT_ID = AA.ALERT_ID
WHERE
	A.ALERT_CAT_ID = 79
ORDER BY
	A.ALERT_ID,
	D.DOCUMENT_ID
;
INSERT INTO @ALERTS(ALERT_ID)
SELECT
	DISTINCT ALERT_ID
FROM
	@VERSIONS
;
SELECT
	@ROW_COUNT = COUNT(1)
FROM
	@ALERTS;
IF @ROW_COUNT > 0
BEGIN
	WHILE @ROW_COUNT > @COUNTER
	BEGIN
		SELECT @COUNTER = @COUNTER + 1;
		SELECT @ALERT_ID = NULL;
		SELECT
			@ALERT_ID = A.ALERT_ID
		FROM
			@ALERTS A
		WHERE
			A.ID = @COUNTER
		;
		UPDATE DOCUMENTS SET VERSION_NUMBER = A.ROW_ID
		FROM (
			SELECT 
				TOP 100 PERCENT
				ROW_NUMBER() OVER (ORDER BY D.DOCUMENT_ID) ROW_ID,
				A.ALERT_ID, D.DOCUMENT_ID, D.VERSION_NUMBER
			FROM
				DOCUMENTS D WITH(NOLOCK)
				INNER JOIN ALERT_ATTACHMENT AA WITH(NOLOCK) ON D.DOCUMENT_ID = AA.DOCUMENT_ID
				INNER JOIN ALERT A WITH(NOLOCK) ON A.ALERT_ID = AA.ALERT_ID
			WHERE
				A.ALERT_ID = @ALERT_ID
			ORDER BY
				D.DOCUMENT_ID ASC
		) AS A
			INNER JOIN DOCUMENTS DD ON A.DOCUMENT_ID = DD.DOCUMENT_ID
		;
	END
END