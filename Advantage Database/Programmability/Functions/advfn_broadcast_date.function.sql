CREATE FUNCTION [dbo].[advfn_broadcast_date]
(
	@NormalDate	DATETIME
	,@MonthEnd VARCHAR(5) = 'B'
	,@MediaBroadcastWorksheetmarkID	INT 
)
RETURNS DATETIME
AS
BEGIN
	-- Declare the return variable here
	DECLARE @BroadcastDate DATETIME = NULL
	DECLARE @NormalDateINT	INT

	IF (@NormalDate IS NOT NULL)
		BEGIN
			
			SET @NormalDateINT = (DATEPART(YEAR,@NormalDate)*100)+DATEPART(M,@NormalDate) 
		
			IF (@MonthEnd = 'B')
				BEGIN
					SELECT DISTINCT 
						@BroadcastDate  = X.BRD_WEEK_START
					FROM dbo.fn_BroadcastCal2('01/01/1996') X
					WHERE (1=1)
						AND X.WEEK_NBR = 1
						AND (X.BRD_YEAR*100)+X.BRD_MONTH = @NormalDateINT
				END
			ELSE
				BEGIN 
					SELECT TOP 1
						@BroadcastDate  = X.BRD_WEEK_END
					FROM dbo.fn_BroadcastCal2('01/01/1996') X
					WHERE (1=1)
						AND (X.BRD_YEAR*100)+X.BRD_MONTH = @NormalDateINT
					ORDER BY 
						X.WEEK_NBR DESC
				END
		END
	
	IF (@BroadcastDate IS NULL)
		IF (@MonthEnd = 'B')
			SELECT
				@BroadcastDate = MIN(MBW_MDD.DATE)
			FROM
				MEDIA_BROADCAST_WORKSHEET_MARKET MBW_M
					INNER JOIN MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL MBW_MD
						ON MBW_M.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = MBW_MD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID
					INNER JOIN MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_DATE MBW_MDD
						ON MBW_MD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID = MBW_MDD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID
			WHERE (1=1)
				AND (MBW_M.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = @MediaBroadcastWorksheetmarkID)

					
		ELSE
			SELECT
				@BroadcastDate = MAX(MBW_MDD.DATE)
			FROM
				MEDIA_BROADCAST_WORKSHEET_MARKET MBW_M
					INNER JOIN MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL MBW_MD
						ON MBW_M.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = MBW_MD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID
					INNER JOIN MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_DATE MBW_MDD
						ON MBW_MD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID = MBW_MDD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID
			WHERE (1=1)
				AND (MBW_M.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = @MediaBroadcastWorksheetmarkID)
			



	-- Return the result of the function
	RETURN @BroadcastDate

END
GO


