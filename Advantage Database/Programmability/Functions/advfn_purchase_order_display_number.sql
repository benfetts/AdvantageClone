CREATE FUNCTION [dbo].[advfn_purchase_order_display_number](
	@po_number int
)
RETURNS varchar(12)
AS
BEGIN
	DECLARE @display_po_number varchar(12)

	SELECT @display_po_number = 
		CASE
			WHEN PURCHASE_ORDER.PO_APPROVAL_FLAG IS NOT NULL THEN
				CASE
					WHEN PURCHASE_ORDER.PO_APPROVAL_FLAG = 0 OR PURCHASE_ORDER.PO_APPROVAL_FLAG IS NULL THEN '(Pending)'
					WHEN PURCHASE_ORDER.PO_APPROVAL_FLAG = 1 THEN '(Pending)'
					WHEN PURCHASE_ORDER.PO_APPROVAL_FLAG = 2 THEN CONVERT(VARCHAR(12), PURCHASE_ORDER.PO_NUMBER)
					WHEN PURCHASE_ORDER.PO_APPROVAL_FLAG = 3 THEN '(Denied)'
					ELSE CONVERT(VARCHAR(12), PURCHASE_ORDER.PO_NUMBER)
				END 
			ELSE
				CASE
					WHEN PURCHASE_ORDER.PO_APPR_RULE_CODE IS NULL OR PURCHASE_ORDER.PO_APPR_RULE_CODE = '' OR EMPLOYEE.PO_LIMIT IS NULL THEN CONVERT(VARCHAR(12), PURCHASE_ORDER.PO_NUMBER)
					WHEN PURCHASE_ORDER.EXCEED = 0 AND (PURCHASE_ORDER.PO_PRINTED = 0 OR PURCHASE_ORDER.PO_PRINTED IS NULL) THEN '(Incomplete)'
					WHEN PURCHASE_ORDER.EXCEED = 0 AND PURCHASE_ORDER.PO_PRINTED = 1 THEN CONVERT(VARCHAR(12), PURCHASE_ORDER.PO_NUMBER)
					WHEN PURCHASE_ORDER.EXCEED = 1 THEN '(Incomplete)'
					ELSE CONVERT(VARCHAR(12), PURCHASE_ORDER.PO_NUMBER)
				END
			END
	FROM dbo.PURCHASE_ORDER LEFT OUTER JOIN
		 dbo.EMPLOYEE ON dbo.EMPLOYEE.EMP_CODE = PURCHASE_ORDER.EMP_CODE
	WHERE PURCHASE_ORDER.PO_NUMBER = @po_number

	RETURN @display_po_number
END
GO
