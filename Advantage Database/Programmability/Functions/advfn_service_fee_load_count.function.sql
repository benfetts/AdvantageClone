CREATE FUNCTION [dbo].[advfn_service_fee_load_count](
	@JobServiceFeeID AS int,
	@StartDate AS smalldatetime,
	@EndDate AS smalldatetime)
RETURNS int
WITH SCHEMABINDING
AS
BEGIN

	--SELECT
	--	@JobServiceFeeID = 87,
	--	@StartDate = '1/1/2019',
	--	@EndDate = '12/31/2019'
	
	DECLARE @FeeCount int
	
	SELECT	
		@FeeCount = COUNT(*)
	FROM	
		dbo.INCOME_ONLY JOIN
		(SELECT	
				INCOME_ONLY.IO_ID,
 				INCOME_ONLY.SEQ_NBR
			FROM
				dbo.INCOME_ONLY
			WHERE 
				INCOME_ONLY.JOB_SERVICE_FEE_ID = @JobServiceFeeID AND
				ISNULL(INCOME_ONLY.DELETE_FLAG, 0) = 0 AND
				ISNULL(INCOME_ONLY.MODIFY_FLAG, 0) = 0
		UNION
		SELECT
			INCOME_ONLY.IO_ID,
 			INCOME_ONLY.SEQ_NBR
		FROM
			dbo.INCOME_ONLY JOIN
			(SELECT
					[IO_ID] = INCOME_ONLY.IO_ID,
  					[SEQ_NBR] = MAX(INCOME_ONLY.SEQ_NBR)
				FROM	
					dbo.INCOME_ONLY
				GROUP BY
					INCOME_ONLY.IO_ID) IO_MAX ON INCOME_ONLY.IO_ID = IO_MAX.IO_ID AND	
												 INCOME_ONLY.SEQ_NBR = IO_MAX.SEQ_NBR
		WHERE	
			INCOME_ONLY.JOB_SERVICE_FEE_ID = @JobServiceFeeID AND
			ISNULL(INCOME_ONLY.DELETE_FLAG, 0) = 0 AND
			ISNULL(INCOME_ONLY.MODIFY_FLAG, 0) = 1) IO_CURRENT ON INCOME_ONLY.IO_ID = IO_CURRENT.IO_ID AND		
																  INCOME_ONLY.SEQ_NBR = IO_CURRENT.SEQ_NBR
	WHERE
		INCOME_ONLY.JOB_SERVICE_FEE_ID IS NOT NULL
		AND INCOME_ONLY.JOB_SERVICE_FEE_ID = @JobServiceFeeID 
		AND INCOME_ONLY.[IO_INV_DATE] >= @StartDate 
		AND INCOME_ONLY.[IO_INV_DATE] <= @EndDate
	GROUP BY
		INCOME_ONLY.JOB_SERVICE_FEE_ID

	RETURN @FeeCount

END

GO