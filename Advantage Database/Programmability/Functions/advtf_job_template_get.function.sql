IF EXISTS ( SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID( N'[dbo].[advtf_job_template_get]' ) AND xtype IN ( N'FN', N'IF', N'TF' ))
BEGIN
	DROP FUNCTION [dbo].[advtf_job_template_get]
END
GO

CREATE FUNCTION [dbo].[advtf_job_template_get] (
@JOB_NUMBER INT,
@JOB_COMPONENT_NBR INT
)
RETURNS
@RETURN_TABLE TABLE (
	ITEM_CODE VARCHAR(500),
	ITEM_TYPE VARCHAR(5),
	SHORT_DESC VARCHAR(500),
	LONG_DESC VARCHAR(2000),
	CONTROL_TYPE INT,
	SECTION_ORDER INT,
	ITEM_ORDER INT,
	TMPLT_REQ BIT,
	ADVAN_REQ BIT,
	AGENCY_REQ BIT,
	CLIENT_REQ BIT,
	IS_REQUIRED BIT,
	FIELD_VALUE VARCHAR(MAX),
	FIELD_DESCRIPT VARCHAR(MAX),
	EDITABLE BIT,
	SECTION VARCHAR(1000)
)
AS
BEGIN
	/*=======================*/
	DECLARE @JTCODE AS VARCHAR(6),
		@JTDEFAULT AS VARCHAR(6),
		@CLI_CODE VARCHAR(6),
		@SECTIONCHECK SMALLINT,
		@CLIENT_OVERRIDE_AGENCY_REQS SMALLINT,
		--req's from agency table, keying off of a varchar field in case statement below, 
		--so grabbing the req fields as varchar instead of smallint
		@AGENCY_EDIT_OFFICE SMALLINT,
		@AGENCY_CMP_CODE_R VARCHAR(1),
		@AGENCY_JOB_CLI_REF_R VARCHAR(1),
		@AGENCY_BILL_COOP_CODE_R VARCHAR(1),
		@AGENCY_PROMO_CODE_R VARCHAR(1),
		@AGENCY_COMPLEX_CODE_R VARCHAR(1),
		@AGENCY_FORMAT_SC_CODE_R VARCHAR(1),
		@AGENCY_JOB_AD_SIZE_R VARCHAR(1),
		@AGENCY_ACCT_NBR_R VARCHAR(1),
		@AGENCY_TAX_FLAG_R VARCHAR(1),
		@AGENCY_JOB_FIRST_USE_DT_R VARCHAR(1),
		@AGENCY_JOB_COMP_BUDGET_R VARCHAR(1),
		@AGENCY_JOB_DATE_OPENED_R VARCHAR(1),
		@AGENCY_MARKET_CODE_R VARCHAR(1),
		@AGENCY_AD_NBR_R VARCHAR(1),
		@AGENCY_DP_TM_CODE_R VARCHAR(1),
		@AGENCY_JT_CODE_R VARCHAR(1),
		@AGENCY_PROD_CONT_CODE_R VARCHAR(1),
		@AGENCY_EMAIL_GR_CODE_R VARCHAR(1),
		@AGENCY_BLACKPLATE_VER_R VARCHAR(1),
		@AGENCY_BLACKPLATE_VER2_R VARCHAR(1),
		@AGENCY_FISCAL_PD_R VARCHAR(1),
		@AGENCY_SERVICE_FEE_TYPE_R VARCHAR(1),
		@AGENCY_JOB_LOG_UDV1_R VARCHAR(1),
		@AGENCY_JOB_LOG_UDV2_R VARCHAR(1),
		@AGENCY_JOB_LOG_UDV3_R VARCHAR(1),
		@AGENCY_JOB_LOG_UDV4_R VARCHAR(1),
		@AGENCY_JOB_LOG_UDV5_R VARCHAR(1),
		@AGENCY_JOB_CMP_UDV1_R VARCHAR(1),
		@AGENCY_JOB_CMP_UDV2_R VARCHAR(1),
		@AGENCY_JOB_CMP_UDV3_R VARCHAR(1),
		@AGENCY_JOB_CMP_UDV4_R VARCHAR(1),
		@AGENCY_JOB_CMP_UDV5_R VARCHAR(1),
		--client req's
		@CLIENT_CMP_CODE_R VARCHAR(1),
		@CLIENT_JOB_CLI_REF_R VARCHAR(1),
		@CLIENT_BILL_COOP_CODE_R VARCHAR(1),
		@CLIENT_PROMO_CODE_R VARCHAR(1),
		@CLIENT_COMPLEX_CODE_R VARCHAR(1),
		@CLIENT_FORMAT_SC_CODE_R VARCHAR(1),
		@CLIENT_JOB_AD_SIZE_R VARCHAR(1),
		@CLIENT_ACCT_NBR_R VARCHAR(1),
		@CLIENT_TAX_FLAG_R VARCHAR(1),
		@CLIENT_JOB_FIRST_USE_DT_R VARCHAR(1),
		@CLIENT_JOB_COMP_BUDGET_R VARCHAR(1),
		@CLIENT_JOB_DATE_OPENED_R VARCHAR(1),
		@CLIENT_MARKET_CODE_R VARCHAR(1),
		@CLIENT_AD_NBR_R VARCHAR(1),
		@CLIENT_DP_TM_CODE_R VARCHAR(1),
		@CLIENT_JT_CODE_R VARCHAR(1),
		@CLIENT_PROD_CONT_CODE_R VARCHAR(1),
		@CLIENT_EMAIL_GR_CODE_R VARCHAR(1),
		@CLIENT_BLACKPLATE_VER_R VARCHAR(1),
		@CLIENT_BLACKPLATE_VER2_R VARCHAR(1),
		@CLIENT_FISCAL_PD_R VARCHAR(1),
		@CLIENT_SERVICE_FEE_TYPE_R VARCHAR(1),
		@CLIENT_JOB_LOG_UDV1_R VARCHAR(1),
		@CLIENT_JOB_LOG_UDV2_R VARCHAR(1),
		@CLIENT_JOB_LOG_UDV3_R VARCHAR(1),
		@CLIENT_JOB_LOG_UDV4_R VARCHAR(1),
		@CLIENT_JOB_LOG_UDV5_R VARCHAR(1),
		@CLIENT_JOB_CMP_UDV1_R VARCHAR(1),
		@CLIENT_JOB_CMP_UDV2_R VARCHAR(1),
		@CLIENT_JOB_CMP_UDV3_R VARCHAR(1),
		@CLIENT_JOB_CMP_UDV4_R VARCHAR(1),
		@CLIENT_JOB_CMP_UDV5_R VARCHAR(1),
		-- Vars for field values:
		@JOB_CLIENT_REF_JOB_CLI_REF VARCHAR(20),
		@JOB_COMPONENT_ACCT_NBR VARCHAR(50),
		@JOB_COMPONENT_AD_NBR VARCHAR(30),
		@JOB_COMPONENT_CREATIVE_INSTR VARCHAR(4000),
		@JOB_COMPONENT_DP_TM_CODE VARCHAR(20),
		@JOB_COMPONENT_EMAIL_GR_CODE VARCHAR(150),
		@JOB_COMPONENT_EMP_CODE VARCHAR(20),
		@JOB_COMPONENT_JOB_AD_SIZE VARCHAR(60),
		@JOB_COMPONENT_JOB_CL_PO_NBR VARCHAR(40),
		@JOB_COMPONENT_JOB_COMP_BUDGET_AM VARCHAR(20),
		@JOB_COMPONENT_JOB_COMP_COMMENTS VARCHAR(4000),
		@JOB_COMPONENT_JOB_COMP_DATE VARCHAR(20),
		@JOB_COMPONENT_JOB_COMP_DESC VARCHAR(4000),
		@JOB_COMPONENT_JOB_COMPONENT_NBR VARCHAR(20),
		@JOB_COMPONENT_JOB_DEL_INSTRUCT VARCHAR(4000),
		@JOB_COMPONENT_JOB_FIRST_USE_DATE VARCHAR(20),
		@JOB_COMPONENT_JOB_LAYOUT_COMP VARCHAR(6),
		@JOB_COMPONENT_JOB_LAYOUT_NONE VARCHAR(6),
		@JOB_COMPONENT_JOB_LAYOUT_ROUGH VARCHAR(6),
		@JOB_COMPONENT_JOB_LAYOUT_SPC_EXP VARCHAR(60),
		@JOB_COMPONENT_JOB_LAYOUT_SPECIAL VARCHAR(6),
		@JOB_COMPONENT_JOB_LAYOUT_THUMB VARCHAR(6),
		@JOB_COMPONENT_JOB_MARKUP_PCT VARCHAR(20),
		@JOB_COMPONENT_JOB_PROCESS_CONTRL VARCHAR(6),
		@JOB_COMPONENT_JT_CODE VARCHAR(10),
		@JOB_COMPONENT_MARKET_CODE VARCHAR(6),
		@JOB_COMPONENT_NOBILL_FLAG VARCHAR(6),
		@JOB_COMPONENT_PRD_CONT_CODE VARCHAR(20),
		@JOB_COMPONENT_START_DATE VARCHAR(20),
		@JOB_COMPONENT_TAX_CODE VARCHAR(20),
		@JOB_COMPONENT_TAX_FLAG VARCHAR(6),
		@JOB_COMPONENT_TRF_SCHEDULE_REQ VARCHAR(6),
		@JOB_COMPONENT_UDV1_CODE VARCHAR(20),
		@JOB_COMPONENT_UDV2_CODE VARCHAR(20),
		@JOB_COMPONENT_UDV3_CODE VARCHAR(20),
		@JOB_COMPONENT_UDV4_CODE VARCHAR(20),
		@JOB_COMPONENT_UDV5_CODE VARCHAR(20),
		@JOB_COMPONENT_FISCAL_PERIOD_CODE VARCHAR(20),
		@JOB_COMPONENT_BLACKPLT_VER_CODE VARCHAR(20),
		@JOB_COMPONENT_BLACKPLT_VER_DESC VARCHAR(20),
		@JOB_COMPONENT_BLACKPLT_VER2_CODE VARCHAR(20),
		@JOB_COMPONENT_BLACKPLT_VER2_DESC VARCHAR(20),
		@JOB_COMPONENT_JOB_QTY VARCHAR(20),
		@JOB_COMPONENT_ESTIMATE_NUMBER VARCHAR(20),
		@JOB_COMPONENT_EST_COMPONENT_NBR VARCHAR(20),
		@JOB_COMPONENT_CDP_CONTACT_ID INT,
		@JOB_COMPONENT_ALRT_NOTIFY_HDR_ID VARCHAR(20),
		@JOB_COMPONENT_SERVICE_FEE_FLAG VARCHAR(6),
		@JOB_COMPONENT_SERVICE_FEE_TYPE_ID VARCHAR(6),
		@JOB_COMPONENT_MEDIA_BILL_DATE VARCHAR(20),
		@JOB_LOG_BILL_COOP_CODE VARCHAR(20),
		@JOB_LOG_CL_CODE VARCHAR(20),
		@JOB_LOG_CMP_CODE VARCHAR(20),
		@JOB_LOG_CMP_IDENTIFIER INT,
		@JOB_LOG_COMPLEX_CODE VARCHAR(20),
		@JOB_LOG_DIV_CODE VARCHAR(20),
		@JOB_LOG_FORMAT_SC_CODE VARCHAR(20),
		@JOB_LOG_FORMAT_CODE VARCHAR(20),
		@JOB_LOG_JOB_BILL_COMMENT VARCHAR(4000),
		@JOB_LOG_JOB_COMMENTS VARCHAR(4000),
		@JOB_LOG_JOB_DESC VARCHAR(4000),
		@JOB_LOG_JOB_ESTIMATE_REQ VARCHAR(6),
		@JOB_LOG_JOB_NUMBER VARCHAR(20),
		@JOB_LOG_JOB_RUSH_CHARGES VARCHAR(6),
		@JOB_LOG_OFFICE_CODE VARCHAR(20),
		@JOB_LOG_PRD_CODE VARCHAR(20),
		@JOB_LOG_PROMO_CODE VARCHAR(20),
		@JOB_LOG_SC_CODE VARCHAR(20),
		@JOB_LOG_UDV1_CODE VARCHAR(20),
		@JOB_LOG_UDV2_CODE VARCHAR(20),
		@JOB_LOG_UDV3_CODE VARCHAR(20),
		@JOB_LOG_UDV4_CODE VARCHAR(20),
		@JOB_LOG_UDV5_CODE VARCHAR(20),
		@JOB_LOG_USER_ID VARCHAR(50),
		@JOB_CLI_REF VARCHAR(40),
		@JOB_CLI_DESCRIPT VARCHAR(500),
		@JOB_PRD_DESCRIPT VARCHAR(500),
		@JOB_DIV_DESCRIPT VARCHAR(500)

	--Set default:
	SELECT @JTDEFAULT = 'DFLT';

	SELECT @JTCODE = ISNULL(JOB_TMPLT_CODE, @JTDEFAULT)
	FROM JOB_COMPONENT WITH (NOLOCK)
	WHERE JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR
		AND JOB_NUMBER = @JOB_NUMBER;

	--Section Check
	SELECT @SECTIONCHECK = SECTION_ORDER
	FROM JOB_TMPLT_DTL WITH(NOLOCK)
	WHERE JOB_TMPLT_CODE = @JTCODE
		AND SEQ_NBR = 1
		

	--Get Agency Requirements:
	SELECT @AGENCY_CMP_CODE_R = CMP_CODE_R,
		@AGENCY_JOB_CLI_REF_R = JOB_CLI_REF_R,
		@AGENCY_BILL_COOP_CODE_R = BILL_COOP_CODE_R,
		@AGENCY_PROMO_CODE_R = PROMO_CODE_R,
		@AGENCY_COMPLEX_CODE_R = COMPLEX_CODE_R,
		@AGENCY_FORMAT_SC_CODE_R = FORMAT_SC_CODE_R,
		@AGENCY_JOB_AD_SIZE_R = JOB_AD_SIZE_R,
		@AGENCY_ACCT_NBR_R = ACCT_NBR_R,
		@AGENCY_TAX_FLAG_R = TAX_FLAG_R,
		@AGENCY_JOB_FIRST_USE_DT_R = JOB_FIRST_USE_DT_R,
		@AGENCY_JOB_COMP_BUDGET_R = JOB_COMP_BUDGET_R,
		@AGENCY_JOB_DATE_OPENED_R = JOB_DATE_OPENED_R,
		@AGENCY_MARKET_CODE_R = MARKET_CODE_R,
		@AGENCY_AD_NBR_R = AD_NBR_R,
		@AGENCY_DP_TM_CODE_R = DP_TM_CODE_R,
		@AGENCY_JT_CODE_R = JT_CODE_R,
		@AGENCY_PROD_CONT_CODE_R = PROD_CONT_CODE_R,
		@AGENCY_EMAIL_GR_CODE_R = EMAIL_GR_CODE_R,
		@AGENCY_BLACKPLATE_VER_R = BLACKPLATE_VER_R,
		@AGENCY_BLACKPLATE_VER2_R = BLACKPLATE_VER2_R,
		@AGENCY_FISCAL_PD_R = FISCAL_PD_R,
		@AGENCY_JOB_LOG_UDV1_R = JOB_LOG_UDV1_R,
		@AGENCY_JOB_LOG_UDV2_R = JOB_LOG_UDV2_R,
		@AGENCY_JOB_LOG_UDV3_R = JOB_LOG_UDV3_R,
		@AGENCY_JOB_LOG_UDV4_R = JOB_LOG_UDV4_R,
		@AGENCY_JOB_LOG_UDV5_R = JOB_LOG_UDV5_R,
		@AGENCY_JOB_CMP_UDV1_R = JOB_CMP_UDV1_R,
		@AGENCY_JOB_CMP_UDV2_R = JOB_CMP_UDV2_R,
		@AGENCY_JOB_CMP_UDV3_R = JOB_CMP_UDV3_R,
		@AGENCY_JOB_CMP_UDV4_R = JOB_CMP_UDV4_R,
		@AGENCY_JOB_CMP_UDV5_R = JOB_CMP_UDV5_R,
		@AGENCY_SERVICE_FEE_TYPE_R = SERVICE_FEE_TYPE_R,
		@AGENCY_EDIT_OFFICE = ISNULL(EDIT_OFFICE, 0)
	FROM AGENCY WITH (NOLOCK);

	--Get client code:
	SELECT @CLI_CODE = CL_CODE
	FROM JOB_LOG WITH (NOLOCK)
	WHERE JOB_NUMBER = @JOB_NUMBER;

	--Get client level req's:
	SELECT @CLIENT_CMP_CODE_R = CMP_CODE_R,
		@CLIENT_JOB_CLI_REF_R = JOB_CLI_REF_R,
		@CLIENT_BILL_COOP_CODE_R = BILL_COOP_CODE_R,
		@CLIENT_PROMO_CODE_R = PROMO_CODE_R,
		@CLIENT_COMPLEX_CODE_R = COMPLEX_CODE_R,
		@CLIENT_FORMAT_SC_CODE_R = FORMAT_SC_CODE_R,
		@CLIENT_JOB_AD_SIZE_R = JOB_AD_SIZE_R,
		@CLIENT_ACCT_NBR_R = ACCT_NBR_R,
		@CLIENT_TAX_FLAG_R = TAX_FLAG_R,
		@CLIENT_JOB_FIRST_USE_DT_R = JOB_FIRST_USE_DT_R,
		@CLIENT_JOB_COMP_BUDGET_R = JOB_COMP_BUDGET_R,
		@CLIENT_JOB_DATE_OPENED_R = JOB_DATE_OPENED_R,
		@CLIENT_MARKET_CODE_R = MARKET_CODE_R,
		@CLIENT_AD_NBR_R = AD_NBR_R,
		@CLIENT_DP_TM_CODE_R = DP_TM_CODE_R,
		@CLIENT_JT_CODE_R = JT_CODE_R,
		@CLIENT_PROD_CONT_CODE_R = PROD_CONT_CODE_R,
		@CLIENT_EMAIL_GR_CODE_R = EMAIL_GR_CODE_R,
		@CLIENT_BLACKPLATE_VER_R = BLACKPLATE_VER_R,
		@CLIENT_BLACKPLATE_VER2_R = BLACKPLATE_VER2_R,
		@CLIENT_FISCAL_PD_R = FISCAL_PD_R,
		@CLIENT_JOB_LOG_UDV1_R = JOB_LOG_UDV1_R,
		@CLIENT_JOB_LOG_UDV2_R = JOB_LOG_UDV2_R,
		@CLIENT_JOB_LOG_UDV3_R = JOB_LOG_UDV3_R,
		@CLIENT_JOB_LOG_UDV4_R = JOB_LOG_UDV4_R,
		@CLIENT_JOB_LOG_UDV5_R = JOB_LOG_UDV5_R,
		@CLIENT_JOB_CMP_UDV1_R = JOB_CMP_UDV1_R,
		@CLIENT_JOB_CMP_UDV2_R = JOB_CMP_UDV2_R,
		@CLIENT_JOB_CMP_UDV3_R = JOB_CMP_UDV3_R,
		@CLIENT_JOB_CMP_UDV4_R = JOB_CMP_UDV4_R,
		@CLIENT_JOB_CMP_UDV5_R = JOB_CMP_UDV5_R,
		@CLIENT_SERVICE_FEE_TYPE_R = SERVICE_FEE_TYPE_R,
		@CLIENT_OVERRIDE_AGENCY_REQS = ISNULL(REQ_FLDS, 0)
	FROM CLIENT WITH (NOLOCK)
	WHERE CL_CODE = @CLI_CODE;

	--Get Job data:
	SELECT @JOB_LOG_BILL_COOP_CODE = BILL_COOP_CODE,
		@JOB_LOG_CL_CODE = CL_CODE,
		@JOB_LOG_CMP_CODE = CMP_CODE,
		@JOB_LOG_CMP_IDENTIFIER = CMP_IDENTIFIER,
		@JOB_LOG_COMPLEX_CODE = COMPLEX_CODE,
		@JOB_LOG_DIV_CODE = DIV_CODE,
		@JOB_LOG_FORMAT_SC_CODE = FORMAT_SC_CODE,
		@JOB_LOG_FORMAT_CODE = FORMAT_CODE,
		@JOB_LOG_JOB_BILL_COMMENT = JOB_BILL_COMMENT,
		@JOB_LOG_JOB_COMMENTS = JOB_COMMENTS,
		--CASE 
		--	WHEN CAST(ISNULL(JOB_COMMENTS_HTML, '') AS VARCHAR) = ''
		--		THEN JOB_COMMENTS
		--	ELSE JOB_COMMENTS_HTML
		--	END,
		@JOB_LOG_JOB_DESC = JOB_DESC,
		@JOB_LOG_JOB_ESTIMATE_REQ = JOB_ESTIMATE_REQ,
		@JOB_LOG_JOB_NUMBER = JOB_NUMBER,
		@JOB_LOG_JOB_RUSH_CHARGES = JOB_RUSH_CHARGES,
		@JOB_LOG_OFFICE_CODE = OFFICE_CODE,
		@JOB_LOG_PRD_CODE = PRD_CODE,
		@JOB_LOG_PROMO_CODE = PROMO_CODE,
		@JOB_LOG_SC_CODE = SC_CODE,
		@JOB_LOG_UDV1_CODE = UDV1_CODE,
		@JOB_LOG_UDV2_CODE = UDV2_CODE,
		@JOB_LOG_UDV3_CODE = UDV3_CODE,
		@JOB_LOG_UDV4_CODE = UDV4_CODE,
		@JOB_LOG_UDV5_CODE = UDV5_CODE,
		@JOB_LOG_USER_ID = [USER_ID] + ' - ' + CONVERT(VARCHAR(15), CREATE_DATE, 101)
	FROM JOB_LOG WITH (NOLOCK)
	WHERE JOB_NUMBER = @JOB_NUMBER;

	--Get Job Component data:
	SELECT @JOB_COMPONENT_ACCT_NBR = ACCT_NBR,
		@JOB_COMPONENT_AD_NBR = AD_NBR,
		@JOB_COMPONENT_CREATIVE_INSTR = CREATIVE_INSTR,
		--CASE 
		--	WHEN CAST(ISNULL(CREATIVE_INSTR_HTML, '') AS VARCHAR) = ''
		--		THEN CREATIVE_INSTR
		--	ELSE CREATIVE_INSTR_HTML
		--	END,
		@JOB_COMPONENT_DP_TM_CODE = DP_TM_CODE,
		@JOB_COMPONENT_EMAIL_GR_CODE = EMAIL_GR_CODE,
		@JOB_COMPONENT_EMP_CODE = EMP_CODE,
		@JOB_COMPONENT_JOB_AD_SIZE = JOB_AD_SIZE,
		@JOB_COMPONENT_JOB_CL_PO_NBR = JOB_CL_PO_NBR,
		@JOB_COMPONENT_JOB_COMP_BUDGET_AM = JOB_COMP_BUDGET_AM,
		@JOB_COMPONENT_JOB_COMP_COMMENTS = JOB_COMP_COMMENTS,
		--CASE 
		--	WHEN CAST(ISNULL(JC_COMMENTS_HTML, '') AS VARCHAR) = ''
		--		THEN JOB_COMP_COMMENTS
		--	ELSE JC_COMMENTS_HTML
		--	END,
		@JOB_COMPONENT_JOB_COMP_DATE = CONVERT(VARCHAR, JOB_COMP_DATE, 101),
		@JOB_COMPONENT_JOB_COMP_DESC = JOB_COMP_DESC,
		@JOB_COMPONENT_JOB_COMPONENT_NBR = JOB_COMPONENT_NBR,
		@JOB_COMPONENT_JOB_DEL_INSTRUCT = JOB_DEL_INSTRUCT,
		--CASE 
		--	WHEN CAST(ISNULL(JOB_DEL_INSTR_HTML, '') AS VARCHAR) = ''
		--		THEN JOB_DEL_INSTRUCT
		--	ELSE JOB_DEL_INSTR_HTML
		--	END,
		@JOB_COMPONENT_JOB_FIRST_USE_DATE = CONVERT(VARCHAR, JOB_FIRST_USE_DATE, 101),
		@JOB_COMPONENT_JOB_LAYOUT_COMP = JOB_LAYOUT_COMP,
		@JOB_COMPONENT_JOB_LAYOUT_NONE = JOB_LAYOUT_NONE,
		@JOB_COMPONENT_JOB_LAYOUT_ROUGH = JOB_LAYOUT_ROUGH,
		@JOB_COMPONENT_JOB_LAYOUT_SPC_EXP = JOB_LAYOUT_SPC_EXP,
		@JOB_COMPONENT_JOB_LAYOUT_SPECIAL = JOB_LAYOUT_SPECIAL,
		@JOB_COMPONENT_JOB_LAYOUT_THUMB = JOB_LAYOUT_THUMB,
		@JOB_COMPONENT_JOB_MARKUP_PCT = JOB_MARKUP_PCT,
		@JOB_COMPONENT_JOB_PROCESS_CONTRL = JOB_PROCESS_CONTRL,
		@JOB_COMPONENT_JT_CODE = JT_CODE,
		@JOB_COMPONENT_MARKET_CODE = MARKET_CODE,
		@JOB_COMPONENT_NOBILL_FLAG = NOBILL_FLAG,
		@JOB_COMPONENT_PRD_CONT_CODE = PRD_CONT_CODE,
		@JOB_COMPONENT_START_DATE = CONVERT(VARCHAR, START_DATE, 101),
		@JOB_COMPONENT_TAX_CODE = TAX_CODE,
		@JOB_COMPONENT_TAX_FLAG = TAX_FLAG,
		@JOB_COMPONENT_TRF_SCHEDULE_REQ = TRF_SCHEDULE_REQ,
		@JOB_COMPONENT_UDV1_CODE = UDV1_CODE,
		@JOB_COMPONENT_UDV2_CODE = UDV2_CODE,
		@JOB_COMPONENT_UDV3_CODE = UDV3_CODE,
		@JOB_COMPONENT_UDV4_CODE = UDV4_CODE,
		@JOB_COMPONENT_UDV5_CODE = UDV5_CODE,
		@JOB_COMPONENT_FISCAL_PERIOD_CODE = FISCAL_PERIOD_CODE,
		@JOB_COMPONENT_BLACKPLT_VER_CODE = BLACKPLT_VER_CODE,
		@JOB_COMPONENT_BLACKPLT_VER_DESC = BLACKPLT_VER_DESC,
		@JOB_COMPONENT_BLACKPLT_VER2_CODE = BLACKPLT_VER2_CODE,
		@JOB_COMPONENT_BLACKPLT_VER2_DESC = BLACKPLT_VER2_DESC,
		@JOB_COMPONENT_JOB_QTY = JOB_QTY,
		@JOB_COMPONENT_ESTIMATE_NUMBER = ESTIMATE_NUMBER,
		@JOB_COMPONENT_EST_COMPONENT_NBR = EST_COMPONENT_NBR,
		@JOB_COMPONENT_CDP_CONTACT_ID = CDP_CONTACT_ID,
		@JOB_COMPONENT_ALRT_NOTIFY_HDR_ID = ALRT_NOTIFY_HDR_ID,
		@JOB_COMPONENT_SERVICE_FEE_FLAG = SERVICE_FEE_FLAG,
		@JOB_COMPONENT_SERVICE_FEE_TYPE_ID = SERVICE_FEE_TYPE_ID,
		@JOB_COMPONENT_MEDIA_BILL_DATE = MEDIA_BILL_DATE,
		@JTCODE = ISNULL(JOB_TMPLT_CODE, @JTDEFAULT)
	FROM JOB_COMPONENT WITH (NOLOCK)
	WHERE JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR
		AND JOB_NUMBER = @JOB_NUMBER;

	--Get Job client ref:
	SELECT @JOB_CLI_REF = ISNULL(JOB_CLI_REF, '')
	FROM JOB_LOG WITH (NOLOCK)
	WHERE JOB_NUMBER = @JOB_NUMBER;

	--Get CDP with their descriptions
	SELECT @JOB_CLI_DESCRIPT = (
			SELECT CL_CODE + ' - ' + ISNULL(CL_NAME, '')
			FROM CLIENT WITH(NOLOCK)
			WHERE CL_CODE = @JOB_LOG_CL_CODE
			)

	SELECT @JOB_DIV_DESCRIPT = (
			SELECT DIV_CODE + ' - ' + ISNULL(DIV_NAME, '')
			FROM DIVISION WITH(NOLOCK)
			WHERE CL_CODE = @JOB_LOG_CL_CODE
				AND DIV_CODE = @JOB_LOG_DIV_CODE
			)

	SELECT @JOB_PRD_DESCRIPT = (
			SELECT PRD_CODE + ' - ' + ISNULL(PRD_DESCRIPTION, '')
			FROM PRODUCT WITH(NOLOCK)
			WHERE CL_CODE = @JOB_LOG_CL_CODE
				AND DIV_CODE = @JOB_LOG_DIV_CODE
				AND PRD_CODE = @JOB_LOG_PRD_CODE
			)

	--MAIN SELECT RETURN:
	INSERT INTO @RETURN_TABLE
	SELECT ISNULL(JOB_TMPLT_DTL.ITEM_CODE, '') AS ITEM_CODE,
		ISNULL(JOB_TMPLT_ITEMS.ITEM_TYPE, '') AS ITEM_TYPE,
		ISNULL(JOB_TMPLT_DTL.LABEL, '') AS SHORT_DESC,
		ISNULL(JOB_TMPLT_ITEMS.ITEM_DESC, '') AS LONG_DESC,
		CASE 
			WHEN UDV_LABEL.EDITABLE = 1
				THEN 3
			ELSE ISNULL(JOB_TMPLT_ITEMS.CONTROL_TYPE, 0)
			END AS CONTROL_TYPE,
		JOB_TMPLT_DTL.SECTION_ORDER,
		ISNULL(JOB_TMPLT_DTL.ITEM_ORDER, 0) AS ITEM_ORDER,
		ISNULL(JOB_TMPLT_DTL.REQUIRED, 0) AS TMPLT_REQ,
		ISNULL(JOB_TMPLT_ITEMS.ADVAN_REQ, 0) AS ADVAN_REQ,
		CASE JOB_TMPLT_ITEMS.AGENCY_REQ_COL
			WHEN 'AGENCY.CMP_CODE_R'
				THEN (
						SELECT ISNULL(@AGENCY_CMP_CODE_R, '0')
						)
			WHEN 'AGENCY.JOB_CLI_REF_R'
				THEN (
						SELECT ISNULL(@AGENCY_JOB_CLI_REF_R, '0')
						)
			WHEN 'AGENCY.BILL_COOP_CODE_R'
				THEN (
						SELECT ISNULL(@AGENCY_BILL_COOP_CODE_R, '0')
						)
			WHEN 'AGENCY.PROMO_CODE_R'
				THEN (
						SELECT ISNULL(@AGENCY_PROMO_CODE_R, '0')
						)
			WHEN 'AGENCY.COMPLEX_CODE_R'
				THEN (
						SELECT ISNULL(@AGENCY_COMPLEX_CODE_R, '0')
						)
			WHEN 'AGENCY.FORMAT_SC_CODE_R'
				THEN (
						SELECT ISNULL(@AGENCY_FORMAT_SC_CODE_R, '0')
						)
			WHEN 'AGENCY.JOB_AD_SIZE_R'
				THEN (
						SELECT ISNULL(@AGENCY_JOB_AD_SIZE_R, '0')
						)
			WHEN 'AGENCY.ACCT_NBR_R'
				THEN (
						SELECT ISNULL(@AGENCY_ACCT_NBR_R, '0')
						)
			WHEN 'AGENCY.TAX_FLAG_R'
				THEN (
						SELECT ISNULL(@AGENCY_TAX_FLAG_R, '0')
						)
			WHEN 'AGENCY.JOB_FIRST_USE_DT_R'
				THEN (
						SELECT ISNULL(@AGENCY_JOB_FIRST_USE_DT_R, '0')
						)
			WHEN 'AGENCY.JOB_COMP_BUDGET_R'
				THEN (
						SELECT ISNULL(@AGENCY_JOB_COMP_BUDGET_R, '0')
						)
			WHEN 'AGENCY.JOB_DATE_OPENED_R'
				THEN (
						SELECT ISNULL(@AGENCY_JOB_DATE_OPENED_R, '0')
						)
			WHEN 'AGENCY.MARKET_CODE_R'
				THEN (
						SELECT ISNULL(@AGENCY_MARKET_CODE_R, '0')
						)
			WHEN 'AGENCY.AD_NBR_R'
				THEN (
						SELECT ISNULL(@AGENCY_AD_NBR_R, '0')
						)
			WHEN 'AGENCY.DP_TM_CODE_R'
				THEN (
						SELECT ISNULL(@AGENCY_DP_TM_CODE_R, '0')
						)
			WHEN 'AGENCY.JT_CODE_R'
				THEN (
						SELECT ISNULL(@AGENCY_JT_CODE_R, '0')
						)
			WHEN 'AGENCY.PROD_CONT_CODE_R'
				THEN (
						SELECT ISNULL(@AGENCY_PROD_CONT_CODE_R, '0')
						)
			WHEN 'AGENCY.EMAIL_GR_CODE_R'
				THEN (
						SELECT ISNULL(@AGENCY_EMAIL_GR_CODE_R, '0')
						)
			WHEN 'AGENCY.BLACKPLATE_VER_R'
				THEN (
						SELECT ISNULL(@AGENCY_BLACKPLATE_VER_R, '0')
						)
			WHEN 'AGENCY.BLACKPLATE_VER2_R'
				THEN (
						SELECT ISNULL(@AGENCY_BLACKPLATE_VER2_R, '0')
						)
			WHEN 'AGENCY.FISCAL_PD_R'
				THEN (
						SELECT ISNULL(@AGENCY_FISCAL_PD_R, '0')
						)
			WHEN 'SERVICE_FEE_TYPE_R'
				THEN (
						SELECT ISNULL(@AGENCY_SERVICE_FEE_TYPE_R, '0')
						)
			WHEN 'AGENCY.JOB_LOG_UDV1_R'
				THEN (
						SELECT ISNULL(@AGENCY_JOB_LOG_UDV1_R, '0')
						)
			WHEN 'AGENCY.JOB_LOG_UDV2_R'
				THEN (
						SELECT ISNULL(@AGENCY_JOB_LOG_UDV2_R, '0')
						)
			WHEN 'AGENCY.JOB_LOG_UDV3_R'
				THEN (
						SELECT ISNULL(@AGENCY_JOB_LOG_UDV3_R, '0')
						)
			WHEN 'AGENCY.JOB_LOG_UDV4_R'
				THEN (
						SELECT ISNULL(@AGENCY_JOB_LOG_UDV4_R, '0')
						)
			WHEN 'AGENCY.JOB_LOG_UDV5_R'
				THEN (
						SELECT ISNULL(@AGENCY_JOB_LOG_UDV5_R, '0')
						)
			WHEN 'AGENCY.JOB_CMP_UDV1_R'
				THEN (
						SELECT ISNULL(@AGENCY_JOB_CMP_UDV1_R, '0')
						)
			WHEN 'AGENCY.JOB_CMP_UDV2_R'
				THEN (
						SELECT ISNULL(@AGENCY_JOB_CMP_UDV2_R, '0')
						)
			WHEN 'AGENCY.JOB_CMP_UDV3_R'
				THEN (
						SELECT ISNULL(@AGENCY_JOB_CMP_UDV3_R, '0')
						)
			WHEN 'AGENCY.JOB_CMP_UDV4_R'
				THEN (
						SELECT ISNULL(@AGENCY_JOB_CMP_UDV4_R, '0')
						)
			WHEN 'AGENCY.JOB_CMP_UDV5_R'
				THEN (
						SELECT ISNULL(@AGENCY_JOB_CMP_UDV5_R, '0')
						)
			ELSE ISNULL(AGENCY_REQ_COL, '0')
			END AS AGENCY_REQ
		--, AGENCY_REQ_COL 
		,
		CASE JOB_TMPLT_ITEMS.CLIENT_REQ_COL
			WHEN 'CLIENT.CMP_CODE_R'
				THEN (
						SELECT ISNULL(@CLIENT_CMP_CODE_R, '0')
						)
			WHEN 'CLIENT.JOB_CLI_REF_R'
				THEN (
						SELECT ISNULL(@CLIENT_JOB_CLI_REF_R, '0')
						)
			WHEN 'CLIENT.BILL_COOP_CODE_R'
				THEN (
						SELECT ISNULL(@CLIENT_BILL_COOP_CODE_R, '0')
						)
			WHEN 'CLIENT.PROMO_CODE_R'
				THEN (
						SELECT ISNULL(@CLIENT_PROMO_CODE_R, '0')
						)
			WHEN 'CLIENT.COMPLEX_CODE_R'
				THEN (
						SELECT ISNULL(@CLIENT_COMPLEX_CODE_R, '0')
						)
			WHEN 'CLIENT.FORMAT_SC_CODE_R'
				THEN (
						SELECT ISNULL(@CLIENT_FORMAT_SC_CODE_R, '0')
						)
			WHEN 'CLIENT.JOB_AD_SIZE_R'
				THEN (
						SELECT ISNULL(@CLIENT_JOB_AD_SIZE_R, '0')
						)
			WHEN 'CLIENT.ACCT_NBR_R'
				THEN (
						SELECT ISNULL(@CLIENT_ACCT_NBR_R, '0')
						)
			WHEN 'CLIENT.TAX_FLAG_R'
				THEN (
						SELECT ISNULL(@CLIENT_TAX_FLAG_R, '0')
						)
			WHEN 'CLIENT.JOB_FIRST_USE_DT_R'
				THEN (
						SELECT ISNULL(@CLIENT_JOB_FIRST_USE_DT_R, '0')
						)
			WHEN 'CLIENT.JOB_COMP_BUDGET_R'
				THEN (
						SELECT ISNULL(@CLIENT_JOB_COMP_BUDGET_R, '0')
						)
			WHEN 'CLIENT.JOB_DATE_OPENED_R'
				THEN (
						SELECT ISNULL(@CLIENT_JOB_DATE_OPENED_R, '0')
						)
			WHEN 'CLIENT.MARKET_CODE_R'
				THEN (
						SELECT ISNULL(@CLIENT_MARKET_CODE_R, '0')
						)
			WHEN 'CLIENT.AD_NBR_R'
				THEN (
						SELECT ISNULL(@CLIENT_AD_NBR_R, '0')
						)
			WHEN 'CLIENT.DP_TM_CODE_R'
				THEN (
						SELECT ISNULL(@CLIENT_DP_TM_CODE_R, '0')
						)
			WHEN 'CLIENT.JT_CODE_R'
				THEN (
						SELECT ISNULL(@CLIENT_JT_CODE_R, '0')
						)
			WHEN 'CLIENT.PROD_CONT_CODE_R'
				THEN (
						SELECT ISNULL(@CLIENT_PROD_CONT_CODE_R, '0')
						)
			WHEN 'CLIENT.EMAIL_GR_CODE_R'
				THEN (
						SELECT ISNULL(@CLIENT_EMAIL_GR_CODE_R, '0')
						)
			WHEN 'CLIENT.BLACKPLATE_VER_R'
				THEN (
						SELECT ISNULL(@CLIENT_BLACKPLATE_VER_R, '0')
						)
			WHEN 'CLIENT.BLACKPLATE_VER2_R'
				THEN (
						SELECT ISNULL(@CLIENT_BLACKPLATE_VER2_R, '0')
						)
			WHEN 'CLIENT.FISCAL_PD_R'
				THEN (
						SELECT ISNULL(@CLIENT_FISCAL_PD_R, '0')
						)
			WHEN 'SERVICE_FEE_TYPE_R'
				THEN (
						SELECT ISNULL(@CLIENT_SERVICE_FEE_TYPE_R, '0')
						)
			WHEN 'CLIENT.JOB_LOG_UDV1_R'
				THEN (
						SELECT ISNULL(@CLIENT_JOB_LOG_UDV1_R, '0')
						)
			WHEN 'CLIENT.JOB_LOG_UDV2_R'
				THEN (
						SELECT ISNULL(@CLIENT_JOB_LOG_UDV2_R, '0')
						)
			WHEN 'CLIENT.JOB_LOG_UDV3_R'
				THEN (
						SELECT ISNULL(@CLIENT_JOB_LOG_UDV3_R, '0')
						)
			WHEN 'CLIENT.JOB_LOG_UDV4_R'
				THEN (
						SELECT ISNULL(@CLIENT_JOB_LOG_UDV4_R, '0')
						)
			WHEN 'CLIENT.JOB_LOG_UDV5_R'
				THEN (
						SELECT ISNULL(@CLIENT_JOB_LOG_UDV5_R, '0')
						)
			WHEN 'CLIENT.JOB_CMP_UDV1_R'
				THEN (
						SELECT ISNULL(@CLIENT_JOB_CMP_UDV1_R, '0')
						)
			WHEN 'CLIENT.JOB_CMP_UDV2_R'
				THEN (
						SELECT ISNULL(@CLIENT_JOB_CMP_UDV2_R, '0')
						)
			WHEN 'CLIENT.JOB_CMP_UDV3_R'
				THEN (
						SELECT ISNULL(@CLIENT_JOB_CMP_UDV3_R, '0')
						)
			WHEN 'CLIENT.JOB_CMP_UDV4_R'
				THEN (
						SELECT ISNULL(@CLIENT_JOB_CMP_UDV4_R, '0')
						)
			WHEN 'CLIENT.JOB_CMP_UDV5_R'
				THEN (
						SELECT ISNULL(@CLIENT_JOB_CMP_UDV5_R, '0')
						)
			ELSE ISNULL(CLIENT_REQ_COL, '0')
			END AS CLIENT_REQ,
		0,
		CASE JOB_TMPLT_DTL.ITEM_CODE
			WHEN 'JOB_LOG.BILL_COOP_CODE'
				THEN (
						SELECT ISNULL(@JOB_LOG_BILL_COOP_CODE, '')
						)
			WHEN 'JOB_LOG.CL_CODE'
				THEN (
						SELECT ISNULL(@JOB_CLI_DESCRIPT, '')
						)
			WHEN 'JOB_LOG.CMP_CODE'
				THEN (
						SELECT ISNULL(@JOB_LOG_CMP_CODE, '')
						)
			WHEN 'JOB_LOG.COMPLEX_CODE'
				THEN (
						SELECT ISNULL(@JOB_LOG_COMPLEX_CODE, '')
						)
			WHEN 'JOB_LOG.DIV_CODE'
				THEN (
						SELECT ISNULL(@JOB_DIV_DESCRIPT, '')
						)
			WHEN 'JOB_LOG.FORMAT_SC_CODE'
				THEN (
						SELECT ISNULL(@JOB_LOG_FORMAT_CODE, '')
						)
			WHEN 'JOB_LOG.FORMAT_CODE'
				THEN (
						SELECT ISNULL(@JOB_LOG_FORMAT_CODE, '')
						)
			WHEN 'JOB_LOG.JOB_BILL_COMMENT'
				THEN (
						SELECT ISNULL(@JOB_LOG_JOB_BILL_COMMENT, '')
						)
			WHEN 'JOB_LOG.JOB_COMMENTS'
				THEN (
						SELECT ISNULL(@JOB_LOG_JOB_COMMENTS, '')
						)
			WHEN 'JOB_LOG.JOB_DESC'
				THEN (
						SELECT ISNULL(@JOB_LOG_JOB_DESC, '')
						)
			WHEN 'JOB_LOG.JOB_ESTIMATE_REQ'
				THEN (
						SELECT ISNULL(@JOB_LOG_JOB_ESTIMATE_REQ, '')
						)
			WHEN 'JOB_LOG.JOB_NUMBER'
				THEN (
						SELECT ISNULL(@JOB_LOG_JOB_NUMBER, '')
						)
			WHEN 'JOB_LOG.JOB_RUSH_CHARGES'
				THEN (
						SELECT ISNULL(@JOB_LOG_JOB_RUSH_CHARGES, '')
						)
			WHEN 'JOB_LOG.OFFICE_CODE'
				THEN (
						SELECT ISNULL(@JOB_LOG_OFFICE_CODE, '')
						)
			WHEN 'JOB_LOG.PRD_CODE'
				THEN (
						SELECT ISNULL(@JOB_PRD_DESCRIPT, '')
						)
			WHEN 'JOB_LOG.PROMO_CODE'
				THEN (
						SELECT ISNULL(@JOB_LOG_PROMO_CODE, '')
						)
			WHEN 'JOB_LOG.SC_CODE'
				THEN (
						SELECT JOB_LOG.SC_CODE + '&nbsp;-&nbsp; ' + SALES_CLASS.SC_DESCRIPTION
						FROM JOB_LOG WITH(NOLOCK)
						INNER JOIN SALES_CLASS ON JOB_LOG.SC_CODE = SALES_CLASS.SC_CODE
						WHERE JOB_LOG.JOB_NUMBER = @JOB_NUMBER
						)
			WHEN 'JOB_LOG.UDV1_CODE'
				THEN CASE 
						WHEN UDV_LABEL.EDITABLE = 1
							THEN ISNULL((
										SELECT ISNULL(UDV_DESC, '')
										FROM JOB_LOG_UDV1 WITH(NOLOCK)
										WHERE UDV_CODE = @JOB_LOG_UDV1_CODE
										), '')
						ELSE (
								SELECT ISNULL(@JOB_LOG_UDV1_CODE, '')
								)
						END
			WHEN 'JOB_LOG.UDV2_CODE'
				THEN CASE 
						WHEN UDV_LABEL.EDITABLE = 1
							THEN ISNULL((
										SELECT ISNULL(UDV_DESC, '')
										FROM JOB_LOG_UDV2 WITH(NOLOCK)
										WHERE UDV_CODE = @JOB_LOG_UDV2_CODE
										), '')
						ELSE (
								SELECT ISNULL(@JOB_LOG_UDV2_CODE, '')
								)
						END
			WHEN 'JOB_LOG.UDV3_CODE'
				THEN CASE 
						WHEN UDV_LABEL.EDITABLE = 1
							THEN ISNULL((
										SELECT ISNULL(UDV_DESC, '')
										FROM JOB_LOG_UDV3 WITH(NOLOCK)
										WHERE UDV_CODE = @JOB_LOG_UDV3_CODE
										), '')
						ELSE (
								SELECT ISNULL(@JOB_LOG_UDV3_CODE, '')
								)
						END
			WHEN 'JOB_LOG.UDV4_CODE'
				THEN CASE 
						WHEN UDV_LABEL.EDITABLE = 1
							THEN ISNULL((
										SELECT ISNULL(UDV_DESC, '')
										FROM JOB_LOG_UDV4 WITH(NOLOCK)
										WHERE UDV_CODE = @JOB_LOG_UDV4_CODE
										), '')
						ELSE (
								SELECT ISNULL(@JOB_LOG_UDV4_CODE, '')
								)
						END
			WHEN 'JOB_LOG.UDV5_CODE'
				THEN CASE 
						WHEN UDV_LABEL.EDITABLE = 1
							THEN ISNULL((
										SELECT ISNULL(UDV_DESC, '')
										FROM JOB_LOG_UDV5 WITH(NOLOCK)
										WHERE UDV_CODE = @JOB_LOG_UDV5_CODE
										), '')
						ELSE (
								SELECT ISNULL(@JOB_LOG_UDV5_CODE, '')
								)
						END
			WHEN 'JOB_LOG.USER_ID'
				THEN (
						SELECT ISNULL(@JOB_LOG_USER_ID, '')
						)
			WHEN 'JOB_CLIENT_REF.JOB_CLI_REF'
				THEN (
						SELECT ISNULL(@JOB_CLI_REF, '')
						)
			WHEN 'JOB_COMPONENT.ACCT_NBR'
				THEN (
						SELECT ISNULL(@JOB_COMPONENT_ACCT_NBR, '')
						)
			WHEN 'JOB_COMPONENT.AD_NBR'
				THEN (
						SELECT ISNULL(@JOB_COMPONENT_AD_NBR, '')
						)
			WHEN 'JOB_COMPONENT.CREATIVE_INSTR'
				THEN (
						SELECT ISNULL(@JOB_COMPONENT_CREATIVE_INSTR, '')
						)
			WHEN 'JOB_COMPONENT.DP_TM_CODE'
				THEN (
						SELECT ISNULL(@JOB_COMPONENT_DP_TM_CODE, '')
						)
			WHEN 'JOB_COMPONENT.EMAIL_GR_CODE'
				THEN (
						SELECT ISNULL(@JOB_COMPONENT_EMAIL_GR_CODE, '')
						)
			WHEN 'JOB_COMPONENT.EMP_CODE'
				THEN (
						SELECT ISNULL(@JOB_COMPONENT_EMP_CODE, '')
						)
			WHEN 'JOB_COMPONENT.JOB_AD_SIZE'
				THEN (
						SELECT ISNULL(@JOB_COMPONENT_JOB_AD_SIZE, '')
						)
			WHEN 'JOB_COMPONENT.JOB_CL_PO_NBR'
				THEN (
						SELECT ISNULL(@JOB_COMPONENT_JOB_CL_PO_NBR, '')
						)
			WHEN 'JOB_COMPONENT.JOB_COMP_BUDGET_AM'
				THEN (
						SELECT ISNULL(@JOB_COMPONENT_JOB_COMP_BUDGET_AM, '')
						)
			WHEN 'JOB_COMPONENT.JOB_COMP_COMMENTS'
				THEN (
						SELECT ISNULL(@JOB_COMPONENT_JOB_COMP_COMMENTS, '')
						)
			WHEN 'JOB_COMPONENT.JOB_COMP_DATE'
				THEN (
						SELECT ISNULL(@JOB_COMPONENT_JOB_COMP_DATE, '')
						)
			WHEN 'JOB_COMPONENT.JOB_COMP_DESC'
				THEN (
						SELECT ISNULL(@JOB_COMPONENT_JOB_COMP_DESC, '')
						)
			WHEN 'JOB_COMPONENT.JOB_COMPONENT_NBR'
				THEN (
						SELECT ISNULL(@JOB_COMPONENT_JOB_COMPONENT_NBR, '')
						)
			WHEN 'JOB_COMPONENT.JOB_DEL_INSTRUCT'
				THEN (
						SELECT ISNULL(@JOB_COMPONENT_JOB_DEL_INSTRUCT, '')
						)
			WHEN 'JOB_COMPONENT.JOB_FIRST_USE_DATE'
				THEN (
						SELECT ISNULL(@JOB_COMPONENT_JOB_FIRST_USE_DATE, '')
						)
			WHEN 'JOB_COMPONENT.JOB_LAYOUT_COMP'
				THEN (
						SELECT ISNULL(@JOB_COMPONENT_JOB_LAYOUT_COMP, '')
						)
			WHEN 'JOB_COMPONENT.JOB_LAYOUT_NONE'
				THEN (
						SELECT ISNULL(@JOB_COMPONENT_JOB_LAYOUT_NONE, '')
						)
			WHEN 'JOB_COMPONENT.JOB_LAYOUT_ROUGH'
				THEN (
						SELECT ISNULL(@JOB_COMPONENT_JOB_LAYOUT_ROUGH, '')
						)
			WHEN 'JOB_COMPONENT.JOB_LAYOUT_SPC_EXP'
				THEN (
						SELECT ISNULL(@JOB_COMPONENT_JOB_LAYOUT_SPC_EXP, '')
						)
			WHEN 'JOB_COMPONENT.JOB_LAYOUT_SPECIAL'
				THEN (
						SELECT ISNULL(@JOB_COMPONENT_JOB_LAYOUT_SPECIAL, '')
						)
			WHEN 'JOB_COMPONENT.JOB_LAYOUT_THUMB'
				THEN (
						SELECT ISNULL(@JOB_COMPONENT_JOB_LAYOUT_THUMB, '')
						)
			WHEN 'JOB_COMPONENT.JOB_MARKUP_PCT'
				THEN (
						SELECT ISNULL(@JOB_COMPONENT_JOB_MARKUP_PCT + '%', '')
						)
			WHEN 'JOB_COMPONENT.JOB_PROCESS_CONTRL'
				THEN (
						SELECT CAST(JOB_PROCESS_CONTRL AS VARCHAR) + ' - ' + JOB_PROCESS_DESC
						FROM JOB_PROC_CONTROLS WITH(NOLOCK)
						WHERE (JOB_PROCESS_CONTRL = @JOB_COMPONENT_JOB_PROCESS_CONTRL)
						)
			WHEN 'JOB_COMPONENT.JT_CODE'
				THEN (
						SELECT ISNULL(@JOB_COMPONENT_JT_CODE, '')
						)
			WHEN 'JOB_COMPONENT.MARKET_CODE'
				THEN (
						SELECT ISNULL(@JOB_COMPONENT_MARKET_CODE, '')
						)
			WHEN 'JOB_COMPONENT.NOBILL_FLAG'
				THEN (
						SELECT ISNULL(@JOB_COMPONENT_NOBILL_FLAG, '')
						)
			WHEN 'JOB_COMPONENT.PRD_CONT_CODE'
				THEN (
						SELECT ISNULL(@JOB_COMPONENT_PRD_CONT_CODE, '')
						)
			WHEN 'JOB_COMPONENT.START_DATE'
				THEN (
						SELECT ISNULL(@JOB_COMPONENT_START_DATE, '')
						)
			WHEN 'JOB_COMPONENT.TAX_CODE'
				THEN (
						SELECT ISNULL(@JOB_COMPONENT_TAX_CODE, '')
						)
			WHEN 'JOB_COMPONENT.TAX_FLAG'
				THEN (
						SELECT ISNULL(@JOB_COMPONENT_TAX_FLAG, '')
						)
			WHEN 'JOB_COMPONENT.TRF_SCHEDULE_REQ'
				THEN (
						SELECT ISNULL(@JOB_COMPONENT_TRF_SCHEDULE_REQ, '')
						)
			WHEN 'JOB_COMPONENT.UDV1_CODE'
				THEN CASE 
						WHEN UDV_LABEL.EDITABLE = 1
							THEN ISNULL((
										SELECT ISNULL(UDV_DESC, '')
										FROM JOB_CMP_UDV1 WITH(NOLOCK)
										WHERE UDV_CODE = @JOB_COMPONENT_UDV1_CODE
										), '')
						ELSE (
								SELECT ISNULL(@JOB_COMPONENT_UDV1_CODE, '')
								)
						END
			WHEN 'JOB_COMPONENT.UDV2_CODE'
				THEN CASE 
						WHEN UDV_LABEL.EDITABLE = 1
							THEN ISNULL((
										SELECT ISNULL(UDV_DESC, '')
										FROM JOB_CMP_UDV2 WITH(NOLOCK)
										WHERE UDV_CODE = @JOB_COMPONENT_UDV2_CODE
										), '')
						ELSE (
								SELECT ISNULL(@JOB_COMPONENT_UDV2_CODE, '')
								)
						END
			WHEN 'JOB_COMPONENT.UDV3_CODE'
				THEN CASE 
						WHEN UDV_LABEL.EDITABLE = 1
							THEN ISNULL((
										SELECT ISNULL(UDV_DESC, '')
										FROM JOB_CMP_UDV3 WITH(NOLOCK)
										WHERE UDV_CODE = @JOB_COMPONENT_UDV3_CODE
										), '')
						ELSE (
								SELECT ISNULL(@JOB_COMPONENT_UDV3_CODE, '')
								)
						END
			WHEN 'JOB_COMPONENT.UDV4_CODE'
				THEN CASE 
						WHEN UDV_LABEL.EDITABLE = 1
							THEN ISNULL((
										SELECT ISNULL(UDV_DESC, '')
										FROM JOB_CMP_UDV4 WITH(NOLOCK)
										WHERE UDV_CODE = @JOB_COMPONENT_UDV4_CODE
										), '')
						ELSE (
								SELECT ISNULL(@JOB_COMPONENT_UDV4_CODE, '')
								)
						END
			WHEN 'JOB_COMPONENT.UDV5_CODE'
				THEN CASE 
						WHEN UDV_LABEL.EDITABLE = 1
							THEN ISNULL((
										SELECT ISNULL(UDV_DESC, '')
										FROM JOB_CMP_UDV5 WITH(NOLOCK)
										WHERE UDV_CODE = @JOB_COMPONENT_UDV5_CODE
										), '')
						ELSE (
								SELECT ISNULL(@JOB_COMPONENT_UDV5_CODE, '')
								)
						END
			WHEN 'JOB_COMPONENT.JOB_QTY'
				THEN (
						SELECT ISNULL(@JOB_COMPONENT_JOB_QTY, '')
						)
			WHEN 'ESTIMATE'
				THEN (
						SELECT ISNULL(@JOB_COMPONENT_ESTIMATE_NUMBER, '') + '-' + ISNULL(@JOB_COMPONENT_EST_COMPONENT_NBR, '')
						)
			WHEN 'JOB_COMPONENT.FISCAL_PERIOD_CODE'
				THEN (
						SELECT ISNULL(@JOB_COMPONENT_FISCAL_PERIOD_CODE, '')
						)
			WHEN 'JOB_COMPONENT.BLACKPLT_VER_DESC'
				THEN (
						SELECT ISNULL(@JOB_COMPONENT_BLACKPLT_VER_CODE, '')
						)
			WHEN 'JOB_COMPONENT.BLACKPLT_VER2_DESC'
				THEN (
						SELECT ISNULL(@JOB_COMPONENT_BLACKPLT_VER2_CODE, '')
						)
			WHEN 'JOB_COMPONENT.ALRT_NOTIFY_HDR_ID'
				THEN (
						SELECT ISNULL(@JOB_COMPONENT_ALRT_NOTIFY_HDR_ID, '')
						)
			WHEN 'JOB_COMPONENT.SERVICE_FEE_FLAG'
				THEN (
						SELECT ISNULL(@JOB_COMPONENT_SERVICE_FEE_FLAG, '0')
						)
			WHEN 'SERVICE_FEE_TYPE_ID'
				THEN (
						SELECT ISNULL(@JOB_COMPONENT_SERVICE_FEE_TYPE_ID, '')
						)
			WHEN 'JOB_COMPONENT.MEDIA_BILL_DATE'
				THEN (
						SELECT ISNULL(@JOB_COMPONENT_MEDIA_BILL_DATE, '')
						)
			WHEN 'TOTAL_JOB_BUDGET'
				THEN (
						SELECT CONVERT(VARCHAR, ISNULL(SUM(JOB_COMP_BUDGET_AM), 0))
						FROM JOB_COMPONENT WITH(NOLOCK)
						WHERE JOB_NUMBER = @JOB_NUMBER
						)
			ELSE ''
			END AS FIELD_VALUE
		--This CASE gets the descriptions
		,
		CASE JOB_TMPLT_DTL.ITEM_CODE
			WHEN 'JOB_LOG.BILL_COOP_CODE'
				THEN (
						SELECT TOP 1 ISNULL(BILL_COOP_DESC, '')
						FROM BILLING_COOP
						WHERE BILL_COOP_CODE = @JOB_LOG_BILL_COOP_CODE
						)
			WHEN 'JOB_LOG.CL_CODE'
				THEN (
						SELECT ISNULL(CL_NAME, '')
						FROM CLIENT
						WHERE CL_CODE = @JOB_LOG_CL_CODE
						)
			WHEN 'JOB_LOG.CMP_CODE'
				THEN (
						SELECT ISNULL(CMP_NAME, '')
						FROM CAMPAIGN
						WHERE CMP_IDENTIFIER = @JOB_LOG_CMP_IDENTIFIER
						)
			WHEN 'JOB_LOG.COMPLEX_CODE'
				THEN (
						SELECT ISNULL(COMPLEX_DESC, '')
						FROM COMPLEXITY
						WHERE COMPLEX_CODE = @JOB_LOG_COMPLEX_CODE
						)
			WHEN 'JOB_LOG.DIV_CODE'
				THEN (
						SELECT ISNULL(DIV_NAME, '')
						FROM DIVISION
						WHERE CL_CODE = @JOB_LOG_CL_CODE
							AND DIV_CODE = @JOB_LOG_DIV_CODE
						)
			WHEN 'JOB_LOG.FORMAT_SC_CODE'
				THEN (
						SELECT ISNULL(FORMAT_DESC, '')
						FROM SC_FORMAT
						WHERE FORMAT_CODE = @JOB_LOG_FORMAT_CODE
							AND SC_CODE = @JOB_LOG_SC_CODE
						)
			WHEN 'JOB_LOG.FORMAT_CODE'
				THEN (
						SELECT ISNULL(FORMAT_DESC, '')
						FROM SC_FORMAT
						WHERE FORMAT_CODE = @JOB_LOG_FORMAT_CODE
							AND SC_CODE = @JOB_LOG_SC_CODE
						)
			WHEN 'JOB_LOG.OFFICE_CODE'
				THEN (
						SELECT ISNULL(OFFICE_NAME, '')
						FROM OFFICE
						WHERE OFFICE_CODE = @JOB_LOG_OFFICE_CODE
						)
			WHEN 'JOB_LOG.PRD_CODE'
				THEN (
						SELECT ISNULL(PRD_DESCRIPTION, '')
						FROM PRODUCT
						WHERE CL_CODE = @JOB_LOG_CL_CODE
							AND DIV_CODE = @JOB_LOG_DIV_CODE
							AND PRD_CODE = @JOB_LOG_PRD_CODE
						)
			WHEN 'JOB_LOG.PROMO_CODE'
				THEN (
						SELECT ISNULL(PROMO_DESC, '')
						FROM PROMO_TYPE
						WHERE PROMO_CODE = @JOB_LOG_PROMO_CODE
						)
			WHEN 'JOB_LOG.SC_CODE'
				THEN (
						SELECT ISNULL(SC_DESCRIPTION, '')
						FROM SALES_CLASS
						WHERE SC_CODE = @JOB_LOG_SC_CODE
						)
			WHEN 'JOB_LOG.UDV1_CODE'
				THEN (
						SELECT ISNULL(UDV_DESC, '')
						FROM JOB_LOG_UDV1
						WHERE UDV_CODE = @JOB_LOG_UDV1_CODE
						)
			WHEN 'JOB_LOG.UDV2_CODE'
				THEN (
						SELECT ISNULL(UDV_DESC, '')
						FROM JOB_LOG_UDV2
						WHERE UDV_CODE = @JOB_LOG_UDV2_CODE
						)
			WHEN 'JOB_LOG.UDV3_CODE'
				THEN (
						SELECT ISNULL(UDV_DESC, '')
						FROM JOB_LOG_UDV3
						WHERE UDV_CODE = @JOB_LOG_UDV3_CODE
						)
			WHEN 'JOB_LOG.UDV4_CODE'
				THEN (
						SELECT ISNULL(UDV_DESC, '')
						FROM JOB_LOG_UDV4
						WHERE UDV_CODE = @JOB_LOG_UDV4_CODE
						)
			WHEN 'JOB_LOG.UDV5_CODE'
				THEN (
						SELECT ISNULL(UDV_DESC, '')
						FROM JOB_LOG_UDV5
						WHERE UDV_CODE = @JOB_LOG_UDV5_CODE
						)
			WHEN 'JOB_LOG.USER_ID'
				THEN (
						SELECT ISNULL([USER_NAME], '')
						FROM SEC_USER
						WHERE UPPER(USER_CODE) = UPPER(@JOB_LOG_USER_ID)
						)
			WHEN 'JOB_CLIENT_REF.JOB_CLI_REF'
				THEN (
						SELECT ISNULL(@JOB_CLI_REF, '')
						)
			WHEN 'JOB_COMPONENT.ACCT_NBR'
				THEN (
						SELECT ISNULL(ACCT_NBR_DESC, '')
						FROM ACCT_NUMBER
						WHERE ACCT_NBR = @JOB_COMPONENT_ACCT_NBR
						)
			WHEN 'JOB_COMPONENT.AD_NBR'
				THEN (
						SELECT ISNULL(AD_NBR_DESC, '')
						FROM AD_NUMBER
						WHERE AD_NBR = @JOB_COMPONENT_AD_NBR
						)
			WHEN 'JOB_COMPONENT.DP_TM_CODE'
				THEN (
						SELECT ISNULL(DP_TM_DESC, '')
						FROM DEPT_TEAM
						WHERE DP_TM_CODE = @JOB_COMPONENT_DP_TM_CODE
						)
			WHEN 'JOB_COMPONENT.EMP_CODE'
				THEN (
						SELECT ISNULL(EMP_FNAME, '') + ' ' + ISNULL(EMP_MI + '. ', '') + ISNULL(EMP_LNAME, '')
						FROM EMPLOYEE
						WHERE EMP_CODE = @JOB_COMPONENT_EMP_CODE
						)
			WHEN 'JOB_COMPONENT.JOB_PROCESS_CONTRL'
				THEN (
						SELECT CAST(JOB_PROCESS_CONTRL AS VARCHAR) + ' - ' + JOB_PROCESS_DESC
						FROM JOB_PROC_CONTROLS
						WHERE (JOB_PROCESS_CONTRL = @JOB_COMPONENT_JOB_PROCESS_CONTRL)
						)
			WHEN 'JOB_COMPONENT.JT_CODE'
				THEN (
						SELECT ISNULL(JT_DESC, '')
						FROM JOB_TYPE
						WHERE JT_CODE = @JOB_COMPONENT_JT_CODE
						)
			WHEN 'JOB_COMPONENT.MARKET_CODE'
				THEN (
						SELECT ISNULL(MARKET_DESC, '')
						FROM MARKET
						WHERE MARKET_CODE = @JOB_COMPONENT_MARKET_CODE
						)
			WHEN 'JOB_COMPONENT.PRD_CONT_CODE'
				THEN (
						SELECT ISNULL(CONT_FML, '')
						FROM CDP_CONTACT_HDR
						WHERE CDP_CONTACT_ID = @JOB_COMPONENT_CDP_CONTACT_ID
						)
			WHEN 'JOB_COMPONENT.TAX_CODE'
				THEN (
						SELECT ISNULL(TAX_DESCRIPTION, '')
						FROM SALES_TAX
						WHERE TAX_CODE = @JOB_COMPONENT_TAX_CODE
						)
			WHEN 'JOB_COMPONENT.UDV1_CODE'
				THEN (
						SELECT ISNULL(UDV_DESC, '')
						FROM JOB_CMP_UDV1
						WHERE UDV_CODE = @JOB_COMPONENT_UDV1_CODE
						)
			WHEN 'JOB_COMPONENT.UDV2_CODE'
				THEN (
						SELECT ISNULL(UDV_DESC, '')
						FROM JOB_CMP_UDV2
						WHERE UDV_CODE = @JOB_COMPONENT_UDV2_CODE
						)
			WHEN 'JOB_COMPONENT.UDV3_CODE'
				THEN (
						SELECT ISNULL(UDV_DESC, '')
						FROM JOB_CMP_UDV3
						WHERE UDV_CODE = @JOB_COMPONENT_UDV3_CODE
						)
			WHEN 'JOB_COMPONENT.UDV4_CODE'
				THEN (
						SELECT ISNULL(UDV_DESC, '')
						FROM JOB_CMP_UDV4
						WHERE UDV_CODE = @JOB_COMPONENT_UDV4_CODE
						)
			WHEN 'JOB_COMPONENT.UDV5_CODE'
				THEN (
						SELECT ISNULL(UDV_DESC, '')
						FROM JOB_CMP_UDV5
						WHERE UDV_CODE = @JOB_COMPONENT_UDV5_CODE
						)
			WHEN 'JOB_COMPONENT.FISCAL_PERIOD_CODE'
				THEN (
						SELECT ISNULL(FISCAL_PERIOD_DESC, '')
						FROM FISCAL_PERIOD
						WHERE FISCAL_PERIOD.FISCAL_PERIOD_CODE = @JOB_COMPONENT_FISCAL_PERIOD_CODE
						)
			WHEN 'JOB_COMPONENT.BLACKPLT_VER_DESC'
				THEN (
						SELECT CASE 
								WHEN ISNULL(@JOB_COMPONENT_BLACKPLT_VER_CODE, '') <> ''
									THEN (
											SELECT BLACKPLT_VER_DESC
											FROM BLACKPLT_VERSION
											WHERE BLACKPLT_VERSION.BLACKPLT_VER_CODE = @JOB_COMPONENT_BLACKPLT_VER_CODE
											)
								WHEN ISNULL(@JOB_COMPONENT_BLACKPLT_VER_CODE, '') = ''
									AND ISNULL(@JOB_COMPONENT_BLACKPLT_VER_DESC, '') <> ''
									THEN ISNULL(@JOB_COMPONENT_BLACKPLT_VER_DESC, '')
								ELSE ''
								END
						)
			WHEN 'JOB_COMPONENT.BLACKPLT_VER2_DESC'
				THEN (
						SELECT CASE 
								WHEN ISNULL(@JOB_COMPONENT_BLACKPLT_VER2_CODE, '') <> ''
									THEN (
											SELECT BLACKPLT_VER_DESC
											FROM BLACKPLT_VERSION
											WHERE BLACKPLT_VERSION.BLACKPLT_VER_CODE = @JOB_COMPONENT_BLACKPLT_VER2_CODE
											)
								WHEN ISNULL(@JOB_COMPONENT_BLACKPLT_VER2_CODE, '') = ''
									AND ISNULL(@JOB_COMPONENT_BLACKPLT_VER2_DESC, '') <> ''
									THEN ISNULL(@JOB_COMPONENT_BLACKPLT_VER2_DESC, '')
								ELSE ''
								END
						)
			WHEN 'JOB_COMPONENT.ALRT_NOTIFY_HDR_ID'
				THEN (
						SELECT ISNULL(ALERT_NOTIFY_NAME, '')
						FROM ALERT_NOTIFY_HDR
						WHERE ALRT_NOTIFY_HDR_ID = @JOB_COMPONENT_ALRT_NOTIFY_HDR_ID
						)
			WHEN 'SERVICE_FEE_TYPE_ID'
				THEN (
						SELECT ISNULL(DESCRIPTION, '')
						FROM SERVICE_FEE_TYPE
						WHERE SERVICE_FEE_TYPE_ID = @JOB_COMPONENT_SERVICE_FEE_TYPE_ID
						)
			ELSE ''
			END AS FIELD_DESCRIPT,
		ISNULL(UDV_LABEL.EDITABLE, 0) AS EDITABLE,
		CASE 
			WHEN @SECTIONCHECK = 0
				THEN (
						SELECT DISTINCT LABEL + CAST((SECTION_ORDER) AS VARCHAR(4))
						FROM JOB_TMPLT_DTL JTD
						WHERE JTD.JOB_TMPLT_CODE = ISNULL(@JTCODE, @JTDEFAULT)
							AND (JTD.INCLUDE = 1)
							AND JTD.ITEM_CODE = 'SECTION'
							AND JTD.SECTION_ORDER = JOB_TMPLT_DTL.SECTION_ORDER
						)
			ELSE (
					SELECT DISTINCT LABEL + CAST((SECTION_ORDER - 1) AS VARCHAR(4))
					FROM JOB_TMPLT_DTL JTD
					WHERE JTD.JOB_TMPLT_CODE = ISNULL(@JTCODE, @JTDEFAULT)
						AND (JTD.INCLUDE = 1)
						AND JTD.ITEM_CODE = 'SECTION'
						AND JTD.SECTION_ORDER = JOB_TMPLT_DTL.SECTION_ORDER
					)
			END AS SECTION
	--, JOB_TMPLT_ITEMS.CLIENT_REQ_COL
	--, ISNULL(JOB_TMPLT_ITEMS.ALLOW_MULTI, 0) AS ALLOW_MULTI
	--, JOB_TMPLT_ITEMS.UDV_TABLE_NAME
	FROM JOB_TMPLT_ITEMS WITH (NOLOCK)
	RIGHT JOIN JOB_TMPLT_DTL WITH (NOLOCK) ON JOB_TMPLT_ITEMS.ITEM_CODE = JOB_TMPLT_DTL.ITEM_CODE
	LEFT JOIN UDV_LABEL ON JOB_TMPLT_ITEMS.UDV_TABLE_NAME = UDV_LABEL.UDV_TABLE_NAME
	WHERE (JOB_TMPLT_DTL.JOB_TMPLT_CODE = ISNULL(@JTCODE, @JTDEFAULT))
		AND (JOB_TMPLT_DTL.INCLUDE = 1)
	ORDER BY JOB_TMPLT_DTL.SECTION_ORDER,
		JOB_TMPLT_DTL.ITEM_ORDER;

	UPDATE @RETURN_TABLE
	SET IS_REQUIRED = CASE 
			WHEN ADVAN_REQ = 1
				THEN CASE 
						WHEN ITEM_CODE = 'JOB_LOG.OFFICE_CODE'
							AND @AGENCY_EDIT_OFFICE = 0
							THEN 0
						ELSE 1
						END
			ELSE CASE 
					WHEN AGENCY_REQ = 1
						AND CLIENT_REQ = 1
						THEN CASE 
								WHEN ITEM_CODE = 'JOB_LOG.OFFICE_CODE'
									AND @AGENCY_EDIT_OFFICE = 0
									THEN 0
								ELSE 1
								END
					WHEN AGENCY_REQ = 1
						AND CLIENT_REQ = 0
						THEN CASE 
								WHEN @CLIENT_OVERRIDE_AGENCY_REQS = 1
									THEN 0
								ELSE 1
								END
					WHEN AGENCY_REQ = 0
						AND CLIENT_REQ = 1
						THEN CASE 
								WHEN @CLIENT_OVERRIDE_AGENCY_REQS = 1
									THEN 1
								ELSE 0
								END
					WHEN AGENCY_REQ = 0
						AND CLIENT_REQ = 0
						THEN CASE 
								WHEN TMPLT_REQ = 1
									THEN 1
								ELSE 0
								END
					ELSE 0
					END
			END

/*=======================*/
RETURN
END


GO