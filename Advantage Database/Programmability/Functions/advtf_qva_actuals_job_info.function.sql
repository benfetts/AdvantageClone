IF EXISTS ( SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID( N'[dbo].[advtf_qva_actuals_job_info]' ) AND xtype IN ( N'FN', N'IF', N'TF' ))
BEGIN
	DROP FUNCTION [dbo].[advtf_qva_actuals_job_info]
END
GO

CREATE FUNCTION [dbo].[advtf_qva_actuals_job_info](
@JOB_NUMBER INT,
@JOB_COMPONENT_NBR SMALLINT,
@FNC_CODE VARCHAR(6),
@EMP_CODE VARCHAR(6),
@EMP_ONLY BIT,
@SEPARATE_EMP BIT,
@VIEW int
)
RETURNS 
@RETURN_TABLE TABLE (
	JOB_NUMBER INT,
	JOB_COMPONENT_NBR SMALLINT,
	EMP_CODE VARCHAR(6),
	EMP_DATE SMALLDATETIME,
	FNC_CODE VARCHAR(6),
	FNC_DESCRIPTION VARCHAR(30),
	SUM_EMP_TIME_DTL_EMP_HOURS DECIMAL(32,2),
	SUM_AMOUNT DECIMAL(32,2),
	COMMENTS VARCHAR(MAX),
	FULL_NAME VARCHAR(100),
	ALERT_ID INT
)
AS
BEGIN
/*=======================*/
	IF @SEPARATE_EMP = 1
	BEGIN
		IF @EMP_ONLY = 0
		BEGIN
			if @VIEW = 0
			BEGIN
				INSERT INTO @RETURN_TABLE
				SELECT A.*
				FROM (
					SELECT        
						EMP_TIME_DTL.JOB_NUMBER, 
						EMP_TIME_DTL.JOB_COMPONENT_NBR, 
						EMP_TIME.EMP_CODE, 
						EMP_TIME.EMP_DATE, 
						EMP_TIME_DTL.FNC_CODE, 
						FUNCTIONS.FNC_DESCRIPTION, 
						SUM(EMP_TIME_DTL.EMP_HOURS) AS SUM_EMP_TIME_DTL_EMP_HOURS, 
						SUM(EMP_TIME_DTL.TOTAL_BILL + EMP_TIME_DTL.EXT_MARKUP_AMT) AS SUM_AMOUNT, 
						CONVERT(VARCHAR(MAX), EMP_TIME_DTL_CMTS.EMP_COMMENT) AS COMMENTS, 
						ISNULL(EMPLOYEE.EMP_FNAME + ' ', '') + ISNULL(EMPLOYEE.EMP_MI + '. ', ' ') + ISNULL(EMPLOYEE.EMP_LNAME, '') AS FULL_NAME,0 AS ALERT_ID
					FROM            
						EMP_TIME WITH (NOLOCK) INNER JOIN
						EMP_TIME_DTL WITH (NOLOCK) ON EMP_TIME.ET_ID = EMP_TIME_DTL.ET_ID INNER JOIN
						FUNCTIONS WITH (NOLOCK) ON EMP_TIME_DTL.FNC_CODE = FUNCTIONS.FNC_CODE INNER JOIN
						EMPLOYEE WITH (NOLOCK) ON EMP_TIME.EMP_CODE = EMPLOYEE.EMP_CODE LEFT OUTER JOIN
						EMP_TIME_DTL_CMTS WITH (NOLOCK) ON EMP_TIME_DTL.ET_ID = EMP_TIME_DTL_CMTS.ET_ID AND EMP_TIME_DTL.ET_DTL_ID = EMP_TIME_DTL_CMTS.ET_DTL_ID				
					WHERE 
						EMP_TIME_DTL.JOB_NUMBER = @JOB_NUMBER 
						AND EMP_TIME_DTL.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR 
						AND EMP_TIME_DTL.FNC_CODE = @FNC_CODE 
						AND EMP_TIME.EMP_CODE = @EMP_CODE --AND EMP_TIME_DTL.ALERT_ID IS NULL
					GROUP BY 
						EMP_TIME_DTL.JOB_NUMBER, EMP_TIME_DTL.JOB_COMPONENT_NBR, EMP_TIME.EMP_CODE, EMP_TIME.EMP_DATE, 
						EMP_TIME_DTL.FNC_CODE, FUNCTIONS.FNC_DESCRIPTION, CONVERT(VARCHAR(MAX),EMP_TIME_DTL_CMTS.EMP_COMMENT),
						EMPLOYEE.EMP_FNAME, 
						EMPLOYEE.EMP_MI, 
						EMPLOYEE.EMP_LNAME
					UNION ALL
					SELECT     
						EMP_TIME_DTL.JOB_NUMBER, 
						EMP_TIME_DTL.JOB_COMPONENT_NBR, 
						NULL AS EMP_CODE, 
						EMP_TIME.EMP_DATE, 
						EMP_TIME_DTL.FNC_CODE, 
						FUNCTIONS.FNC_DESCRIPTION, 
						SUM(EMP_TIME_DTL.EMP_HOURS) AS SUM_EMP_TIME_DTL_EMP_HOURS, 
						SUM(EMP_TIME_DTL.TOTAL_BILL + EMP_TIME_DTL.EXT_MARKUP_AMT) AS SUM_AMOUNT, 
						'' AS COMMENTS,
						'Others' AS FULL_NAME,0 AS ALERT_ID
					FROM         
						EMP_TIME WITH (NOLOCK) INNER JOIN
						EMP_TIME_DTL WITH (NOLOCK) ON EMP_TIME.ET_ID = EMP_TIME_DTL.ET_ID INNER JOIN
						FUNCTIONS WITH (NOLOCK) ON EMP_TIME_DTL.FNC_CODE = FUNCTIONS.FNC_CODE INNER JOIN
						EMPLOYEE WITH (NOLOCK) ON EMP_TIME.EMP_CODE = EMPLOYEE.EMP_CODE LEFT OUTER JOIN
						EMP_TIME_DTL_CMTS WITH (NOLOCK) ON EMP_TIME_DTL.ET_ID = EMP_TIME_DTL_CMTS.ET_ID AND EMP_TIME_DTL.ET_DTL_ID = EMP_TIME_DTL_CMTS.ET_DTL_ID				
					WHERE 
						EMP_TIME_DTL.JOB_NUMBER = @JOB_NUMBER 
						AND EMP_TIME_DTL.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR 
						AND EMP_TIME_DTL.FNC_CODE = @FNC_CODE 
						AND EMP_TIME.EMP_CODE <> @EMP_CODE --AND EMP_TIME_DTL.ALERT_ID IS NULL
					GROUP BY 
						EMP_TIME_DTL.JOB_NUMBER, EMP_TIME_DTL.JOB_COMPONENT_NBR, EMP_TIME.EMP_CODE, EMP_TIME.EMP_DATE, 
						EMP_TIME_DTL.FNC_CODE, FUNCTIONS.FNC_DESCRIPTION, CONVERT(VARCHAR(MAX),EMP_TIME_DTL_CMTS.EMP_COMMENT),
						EMPLOYEE.EMP_FNAME, 
						EMPLOYEE.EMP_MI, 
						EMPLOYEE.EMP_LNAME
				) AS A
				WHERE 
					A.SUM_EMP_TIME_DTL_EMP_HOURS > 0
				ORDER BY 
					A.EMP_CODE DESC, A.EMP_DATE DESC;
			END
			IF @VIEW = 1
			BEGIN
				INSERT INTO @RETURN_TABLE
				SELECT A.*
				FROM (
					SELECT        
						EMP_TIME_DTL.JOB_NUMBER, 
						EMP_TIME_DTL.JOB_COMPONENT_NBR, 
						EMP_TIME.EMP_CODE, 
						EMP_TIME.EMP_DATE, 
						EMP_TIME_DTL.FNC_CODE, 
						FUNCTIONS.FNC_DESCRIPTION, 
						SUM(EMP_TIME_DTL.EMP_HOURS) AS SUM_EMP_TIME_DTL_EMP_HOURS, 
						SUM(EMP_TIME_DTL.TOTAL_BILL + EMP_TIME_DTL.EXT_MARKUP_AMT) AS SUM_AMOUNT, 
						CONVERT(VARCHAR(MAX), EMP_TIME_DTL_CMTS.EMP_COMMENT) AS COMMENTS, 
						ISNULL(EMPLOYEE.EMP_FNAME + ' ', '') + ISNULL(EMPLOYEE.EMP_MI + '. ', ' ') + ISNULL(EMPLOYEE.EMP_LNAME, '') AS FULL_NAME, A.ALERT_ID
					FROM            
						EMP_TIME WITH (NOLOCK) INNER JOIN
						EMP_TIME_DTL WITH (NOLOCK) ON EMP_TIME.ET_ID = EMP_TIME_DTL.ET_ID INNER JOIN
						FUNCTIONS WITH (NOLOCK) ON EMP_TIME_DTL.FNC_CODE = FUNCTIONS.FNC_CODE INNER JOIN
						EMPLOYEE WITH (NOLOCK) ON EMP_TIME.EMP_CODE = EMPLOYEE.EMP_CODE LEFT OUTER JOIN
						EMP_TIME_DTL_CMTS WITH (NOLOCK) ON EMP_TIME_DTL.ET_ID = EMP_TIME_DTL_CMTS.ET_ID AND EMP_TIME_DTL.ET_DTL_ID = EMP_TIME_DTL_CMTS.ET_DTL_ID LEFT OUTER JOIN 
						ALERT AS A ON A.ALERT_ID = EMP_TIME_DTL.ALERT_ID				
					WHERE 
						EMP_TIME.EMP_CODE = @EMP_CODE AND
						EMP_TIME_DTL.ALERT_ID IS NOT NULL AND 
						A.JOB_NUMBER = @JOB_NUMBER AND 
						A.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR
					GROUP BY 
						EMP_TIME_DTL.JOB_NUMBER, EMP_TIME_DTL.JOB_COMPONENT_NBR, EMP_TIME.EMP_CODE, EMP_TIME.EMP_DATE, 
						EMP_TIME_DTL.FNC_CODE, FUNCTIONS.FNC_DESCRIPTION, CONVERT(VARCHAR(MAX),EMP_TIME_DTL_CMTS.EMP_COMMENT),
						EMPLOYEE.EMP_FNAME, 
						EMPLOYEE.EMP_MI, 
						EMPLOYEE.EMP_LNAME, A.ALERT_ID
					UNION ALL
					SELECT     
						EMP_TIME_DTL.JOB_NUMBER, 
						EMP_TIME_DTL.JOB_COMPONENT_NBR, 
						NULL AS EMP_CODE, 
						EMP_TIME.EMP_DATE, 
						EMP_TIME_DTL.FNC_CODE, 
						FUNCTIONS.FNC_DESCRIPTION, 
						SUM(EMP_TIME_DTL.EMP_HOURS) AS SUM_EMP_TIME_DTL_EMP_HOURS, 
						SUM(EMP_TIME_DTL.TOTAL_BILL + EMP_TIME_DTL.EXT_MARKUP_AMT) AS SUM_AMOUNT, 
						'' AS COMMENTS,
						'Others' AS FULL_NAME, A.ALERT_ID
					FROM         
						EMP_TIME WITH (NOLOCK) INNER JOIN
						EMP_TIME_DTL WITH (NOLOCK) ON EMP_TIME.ET_ID = EMP_TIME_DTL.ET_ID INNER JOIN
						FUNCTIONS WITH (NOLOCK) ON EMP_TIME_DTL.FNC_CODE = FUNCTIONS.FNC_CODE INNER JOIN
						EMPLOYEE WITH (NOLOCK) ON EMP_TIME.EMP_CODE = EMPLOYEE.EMP_CODE LEFT OUTER JOIN
						EMP_TIME_DTL_CMTS WITH (NOLOCK) ON EMP_TIME_DTL.ET_ID = EMP_TIME_DTL_CMTS.ET_ID AND EMP_TIME_DTL.ET_DTL_ID = EMP_TIME_DTL_CMTS.ET_DTL_ID LEFT OUTER JOIN 
						ALERT AS A ON A.ALERT_ID = EMP_TIME_DTL.ALERT_ID				
					WHERE 
						EMP_TIME.EMP_CODE <> @EMP_CODE AND
						EMP_TIME_DTL.ALERT_ID IS NOT NULL AND 
						A.JOB_NUMBER = @JOB_NUMBER AND 
						A.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR
					GROUP BY 
						EMP_TIME_DTL.JOB_NUMBER, EMP_TIME_DTL.JOB_COMPONENT_NBR, EMP_TIME.EMP_CODE, EMP_TIME.EMP_DATE, 
						EMP_TIME_DTL.FNC_CODE, FUNCTIONS.FNC_DESCRIPTION, CONVERT(VARCHAR(MAX),EMP_TIME_DTL_CMTS.EMP_COMMENT),
						EMPLOYEE.EMP_FNAME, 
						EMPLOYEE.EMP_MI, 
						EMPLOYEE.EMP_LNAME, A.ALERT_ID
				) AS A
				WHERE 
					A.SUM_EMP_TIME_DTL_EMP_HOURS > 0
				ORDER BY 
					A.EMP_CODE DESC, A.EMP_DATE DESC;
			END

			
		END
		ELSE
		BEGIN
			if @VIEW = 0
			BEGIN
				INSERT INTO @RETURN_TABLE
				SELECT A.*
				FROM (
					SELECT     
						EMP_TIME_DTL.JOB_NUMBER, 
						EMP_TIME_DTL.JOB_COMPONENT_NBR, 
						EMP_TIME.EMP_CODE, 
						EMP_TIME.EMP_DATE, 
						EMP_TIME_DTL.FNC_CODE, 
						FUNCTIONS.FNC_DESCRIPTION, 
						SUM(EMP_TIME_DTL.EMP_HOURS) AS SUM_EMP_TIME_DTL_EMP_HOURS, 
						SUM(EMP_TIME_DTL.TOTAL_BILL + EMP_TIME_DTL.EXT_MARKUP_AMT) AS SUM_AMOUNT, 
						CONVERT(VARCHAR(MAX),EMP_TIME_DTL_CMTS.EMP_COMMENT) AS COMMENTS,
						ISNULL(EMPLOYEE.EMP_FNAME + ' ', '') + ISNULL(EMPLOYEE.EMP_MI + '. ',' ') + ISNULL(EMPLOYEE.EMP_LNAME, '') AS FULL_NAME,0 AS ALERT_ID
					FROM         
						EMP_TIME WITH (NOLOCK) INNER JOIN
						EMP_TIME_DTL WITH (NOLOCK) ON EMP_TIME.ET_ID = EMP_TIME_DTL.ET_ID INNER JOIN
						FUNCTIONS WITH (NOLOCK) ON EMP_TIME_DTL.FNC_CODE = FUNCTIONS.FNC_CODE INNER JOIN
						EMPLOYEE WITH (NOLOCK) ON EMP_TIME.EMP_CODE = EMPLOYEE.EMP_CODE LEFT OUTER JOIN
						EMP_TIME_DTL_CMTS WITH (NOLOCK) ON EMP_TIME_DTL.ET_ID = EMP_TIME_DTL_CMTS.ET_ID AND EMP_TIME_DTL.ET_DTL_ID = EMP_TIME_DTL_CMTS.ET_DTL_ID				
					WHERE 
						EMP_TIME_DTL.JOB_NUMBER = @JOB_NUMBER 
						AND EMP_TIME_DTL.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR 
						AND EMP_TIME_DTL.FNC_CODE = @FNC_CODE 
						AND EMP_TIME.EMP_CODE = @EMP_CODE AND EMP_TIME_DTL.ALERT_ID IS NULL
					GROUP BY 
						EMP_TIME_DTL.JOB_NUMBER, EMP_TIME_DTL.JOB_COMPONENT_NBR, EMP_TIME.EMP_CODE, EMP_TIME.EMP_DATE, 
						EMP_TIME_DTL.FNC_CODE, FUNCTIONS.FNC_DESCRIPTION, CONVERT(VARCHAR(MAX),EMP_TIME_DTL_CMTS.EMP_COMMENT),
						EMPLOYEE.EMP_FNAME, 
						EMPLOYEE.EMP_MI, 
						EMPLOYEE.EMP_LNAME
				) AS A
				WHERE 
					A.SUM_EMP_TIME_DTL_EMP_HOURS > 0
				ORDER BY 
					A.EMP_DATE DESC;
			END
			IF @VIEW = 1
			BEGIN
				INSERT INTO @RETURN_TABLE
				SELECT A.*
				FROM (
					SELECT     
						EMP_TIME_DTL.JOB_NUMBER, 
						EMP_TIME_DTL.JOB_COMPONENT_NBR, 
						EMP_TIME.EMP_CODE, 
						EMP_TIME.EMP_DATE, 
						EMP_TIME_DTL.FNC_CODE, 
						FUNCTIONS.FNC_DESCRIPTION, 
						SUM(EMP_TIME_DTL.EMP_HOURS) AS SUM_EMP_TIME_DTL_EMP_HOURS, 
						SUM(EMP_TIME_DTL.TOTAL_BILL + EMP_TIME_DTL.EXT_MARKUP_AMT) AS SUM_AMOUNT, 
						CONVERT(VARCHAR(MAX),EMP_TIME_DTL_CMTS.EMP_COMMENT) AS COMMENTS,
						ISNULL(EMPLOYEE.EMP_FNAME + ' ', '') + ISNULL(EMPLOYEE.EMP_MI + '. ',' ') + ISNULL(EMPLOYEE.EMP_LNAME, '') AS FULL_NAME, A.ALERT_ID
					FROM         
						EMP_TIME WITH (NOLOCK) INNER JOIN
						EMP_TIME_DTL WITH (NOLOCK) ON EMP_TIME.ET_ID = EMP_TIME_DTL.ET_ID INNER JOIN
						FUNCTIONS WITH (NOLOCK) ON EMP_TIME_DTL.FNC_CODE = FUNCTIONS.FNC_CODE INNER JOIN
						EMPLOYEE WITH (NOLOCK) ON EMP_TIME.EMP_CODE = EMPLOYEE.EMP_CODE LEFT OUTER JOIN
						EMP_TIME_DTL_CMTS WITH (NOLOCK) ON EMP_TIME_DTL.ET_ID = EMP_TIME_DTL_CMTS.ET_ID AND EMP_TIME_DTL.ET_DTL_ID = EMP_TIME_DTL_CMTS.ET_DTL_ID	LEFT OUTER JOIN 
						ALERT AS A ON A.ALERT_ID = EMP_TIME_DTL.ALERT_ID				
					WHERE 
						EMP_TIME.EMP_CODE = @EMP_CODE AND
						EMP_TIME_DTL.ALERT_ID IS NOT NULL AND 
						A.JOB_NUMBER = @JOB_NUMBER AND 
						A.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR
					GROUP BY 
						EMP_TIME_DTL.JOB_NUMBER, EMP_TIME_DTL.JOB_COMPONENT_NBR, EMP_TIME.EMP_CODE, EMP_TIME.EMP_DATE, 
						EMP_TIME_DTL.FNC_CODE, FUNCTIONS.FNC_DESCRIPTION, CONVERT(VARCHAR(MAX),EMP_TIME_DTL_CMTS.EMP_COMMENT),
						EMPLOYEE.EMP_FNAME, 
						EMPLOYEE.EMP_MI, 
						EMPLOYEE.EMP_LNAME, A.ALERT_ID
				) AS A
				WHERE 
					A.SUM_EMP_TIME_DTL_EMP_HOURS > 0
				ORDER BY 
					A.EMP_DATE DESC;
			END
			
		END

	END
	ELSE
	BEGIN

		INSERT INTO @RETURN_TABLE
		SELECT A.*
		FROM (
			SELECT     
				EMP_TIME_DTL.JOB_NUMBER, 
				EMP_TIME_DTL.JOB_COMPONENT_NBR, 
				NULL AS EMP_CODE, 
				NULL AS EMP_DATE, 
				EMP_TIME_DTL.FNC_CODE, 
				FUNCTIONS.FNC_DESCRIPTION, 
				SUM(EMP_TIME_DTL.EMP_HOURS) AS SUM_EMP_TIME_DTL_EMP_HOURS, 
				SUM(EMP_TIME_DTL.TOTAL_BILL + EMP_TIME_DTL.EXT_MARKUP_AMT) AS SUM_AMOUNT, 
				NULL AS COMMENTS,
				NULL AS FULL_NAME,0 AS ALERT_ID
			FROM         
					EMP_TIME WITH (NOLOCK) INNER JOIN
					EMP_TIME_DTL WITH (NOLOCK) ON EMP_TIME.ET_ID = EMP_TIME_DTL.ET_ID INNER JOIN
					FUNCTIONS WITH (NOLOCK) ON EMP_TIME_DTL.FNC_CODE = FUNCTIONS.FNC_CODE INNER JOIN
					EMPLOYEE WITH (NOLOCK) ON EMP_TIME.EMP_CODE = EMPLOYEE.EMP_CODE LEFT OUTER JOIN
					EMP_TIME_DTL_CMTS WITH (NOLOCK) ON EMP_TIME_DTL.ET_ID = EMP_TIME_DTL_CMTS.ET_ID AND EMP_TIME_DTL.ET_DTL_ID = EMP_TIME_DTL_CMTS.ET_DTL_ID				
			WHERE 
				EMP_TIME_DTL.JOB_NUMBER = @JOB_NUMBER 
				AND EMP_TIME_DTL.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR 
				AND EMP_TIME_DTL.FNC_CODE = @FNC_CODE 
			GROUP BY 
				EMP_TIME_DTL.JOB_NUMBER, EMP_TIME_DTL.JOB_COMPONENT_NBR, EMP_TIME.EMP_CODE, EMP_TIME.EMP_DATE, 
				EMP_TIME_DTL.FNC_CODE, FUNCTIONS.FNC_DESCRIPTION, CONVERT(VARCHAR(MAX),EMP_TIME_DTL_CMTS.EMP_COMMENT)
		) AS A
		WHERE 
			A.SUM_EMP_TIME_DTL_EMP_HOURS > 0

	END
/*=======================*/

	RETURN

END
GO