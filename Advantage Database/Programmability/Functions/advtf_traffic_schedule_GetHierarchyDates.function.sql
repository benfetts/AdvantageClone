CREATE FUNCTION [dbo].[advtf_traffic_schedule_GetHierarchyDates]
	(@JOB_NUMBER INT, 
	 @JOB_COMPONENT_NBR SMALLINT)
RETURNS
	@HIERARCHY_TABLE TABLE(
								[LEVEL] VARCHAR(50),
								[JOB_NUMBER] INT,
								[JOB_COMPONENT_NBR] SMALLINT,
								[SEQ_NBR] SMALLINT,
								[HAS_CHILDREN] BIT,
								[TASK_START_DATE] SMALLDATETIME NULL,
								[JOB_REVISED_DATE] SMALLDATETIME NULL,
								[JOB_DUE_DATE] SMALLDATETIME NULL,
								[JOB_COMPLETED_DATE] SMALLDATETIME NULL,
								[TEMP_COMP_DATE] SMALLDATETIME NULL,
								[JOB_HRS] DECIMAL(8, 2) NULL,
								[JOB_DAYS] SMALLINT,
								[ROW_ORDER] DECIMAL(38,30) NULL
							)
AS
BEGIN

	DECLARE @TMP_HIERARCHY TABLE(
									[JOB_NUMBER] INT,
									[JOB_COMPONENT_NBR] SMALLINT,
									[SEQ_NBR] SMALLINT, 
									[LEVEL] VARCHAR(50), 
									[TASK_START_DATE] SMALLDATETIME NULL, 
									[JOB_REVISED_DATE] SMALLDATETIME NULL,
									[SCHEDULE_CALC] INT,
									[HAS_CHILDREN] BIT,
									[ROW_ORDER] DECIMAL(38,30)
								);

	WITH Hierarchy AS
	(
		
		SELECT
			[JOB_NUMBER] = JOB_TRAFFIC_DET.JOB_NUMBER,
			[JOB_COMPONENT_NBR] = JOB_TRAFFIC_DET.JOB_COMPONENT_NBR,
			[SEQ_NBR] = JOB_TRAFFIC_DET.SEQ_NBR,
			[LEVEL] = CONVERT(VARCHAR(50), CASE		
												WHEN JOB_TRAFFIC.SCHEDULE_CALC = 1 THEN ROW_NUMBER() OVER (PARTITION BY JOB_TRAFFIC_DET.JOB_NUMBER, JOB_TRAFFIC_DET.JOB_COMPONENT_NBR ORDER BY ISNULL(JOB_TRAFFIC_DET.GRID_ORDER, JOB_TRAFFIC_DET.JOB_ORDER) ASC, ISNULL(JOB_TRAFFIC_DET.GRID_ORDER, JOB_TRAFFIC_DET.SEQ_NBR))
												ELSE ROW_NUMBER() OVER (PARTITION BY JOB_TRAFFIC_DET.JOB_NUMBER, JOB_TRAFFIC_DET.JOB_COMPONENT_NBR ORDER BY JOB_TRAFFIC_DET.JOB_ORDER ASC, ISNULL(JOB_TRAFFIC_DET.GRID_ORDER, JOB_TRAFFIC_DET.SEQ_NBR) ASC) 
											END),
			[TASK_START_DATE] = JOB_TRAFFIC_DET.TASK_START_DATE,
			[JOB_REVISED_DATE] = JOB_TRAFFIC_DET.JOB_REVISED_DATE,
			[SCHEDULE_CALC] = ISNULL(JOB_TRAFFIC.SCHEDULE_CALC, 0)
		FROM
			dbo.JOB_TRAFFIC_DET JOIN
			dbo.JOB_TRAFFIC ON JOB_TRAFFIC_DET.JOB_NUMBER = JOB_TRAFFIC.JOB_NUMBER AND
							   JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = JOB_TRAFFIC.JOB_COMPONENT_NBR
		WHERE 
			1 = CASE 
					WHEN ISNULL(JOB_TRAFFIC.SCHEDULE_CALC, 0) = 0 THEN 1 
					WHEN JOB_TRAFFIC.SCHEDULE_CALC = 1 AND PARENT_TASK_SEQ IS NULL THEN 1 
					ELSE 0
				END AND
			1 = CASE 
					WHEN ISNULL(@JOB_NUMBER, 0) = 0 THEN 1 
					WHEN JOB_TRAFFIC_DET.JOB_NUMBER = @JOB_NUMBER THEN 1
					ELSE 0
				END AND
			1 = CASE
					WHEN ISNULL(@JOB_COMPONENT_NBR, 0) = 0 THEN 1
					WHEN JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR THEN 1
					ELSE 0 
				END

		UNION ALL
		
		SELECT
			[JOB_NUMBER] = JTD.JOB_NUMBER,
			[JOB_COMPONENT_NBR] = JTD.JOB_COMPONENT_NBR,
			[SEQ_NBR] = JTD.SEQ_NBR,
			[LEVEL] = CONVERT(VARCHAR(50), Hierarchy.[LEVEL] + '.' + CONVERT(VARCHAR(5), CASE
																							WHEN JT.SCHEDULE_CALC = 1 THEN ROW_NUMBER() OVER (PARTITION BY JTD.JOB_NUMBER, JTD.JOB_COMPONENT_NBR ORDER BY Hierarchy.[LEVEL], ISNULL(JTD.GRID_ORDER, JTD.JOB_ORDER) ASC, ISNULL(JTD.GRID_ORDER, JTD.SEQ_NBR))
																							ELSE ROW_NUMBER() OVER (PARTITION BY JTD.JOB_NUMBER, JTD.JOB_COMPONENT_NBR ORDER BY JTD.JOB_ORDER ASC, ISNULL(JTD.GRID_ORDER, JTD.SEQ_NBR) ASC) 
																						 END)),
			[TASK_START_DATE] = JTD.TASK_START_DATE,
			[JOB_REVISED_DATE] = JTD.JOB_REVISED_DATE,
			[SCHEDULE_CALC] = ISNULL(JT.SCHEDULE_CALC, 0)
		FROM
			dbo.JOB_TRAFFIC_DET JTD INNER JOIN
			Hierarchy ON Hierarchy.JOB_NUMBER = JTD.JOB_NUMBER AND
						 Hierarchy.JOB_COMPONENT_NBR = JTD.JOB_COMPONENT_NBR AND
						 Hierarchy.SEQ_NBR = JTD.PARENT_TASK_SEQ INNER JOIN
			dbo.JOB_TRAFFIC JT ON JTD.JOB_NUMBER = JT.JOB_NUMBER AND
								  JTD.JOB_COMPONENT_NBR = JT.JOB_COMPONENT_NBR
		WHERE
			1 = CASE 
					WHEN JT.SCHEDULE_CALC = 1 THEN 1 
					ELSE 0 
				END AND
			1 = CASE 
					WHEN ISNULL(@JOB_NUMBER, 0) = 0 THEN 1 
					WHEN JTD.JOB_NUMBER = @JOB_NUMBER THEN 1
					ELSE 0
				END AND
			1 = CASE
					WHEN ISNULL(@JOB_COMPONENT_NBR, 0) = 0 THEN 1
					WHEN JTD.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR THEN 1
					ELSE 0 
				END

	)

	INSERT INTO @TMP_HIERARCHY
		SELECT 
			Hierarchy.JOB_NUMBER,
			Hierarchy.JOB_COMPONENT_NBR,
			Hierarchy.SEQ_NBR, 
			Hierarchy.[LEVEL],
			Hierarchy.TASK_START_DATE, 
			Hierarchy.JOB_REVISED_DATE,
			Hierarchy.SCHEDULE_CALC,
			0,
			NULL
		FROM
			Hierarchy

	UPDATE 
		@TMP_HIERARCHY
	SET
		[ROW_ORDER] = (SELECT
							CONVERT(DECIMAL(38, 30), SUM(CONVERT(DECIMAL(38, 30), CAST(LVLS.SUB_LVL AS DECIMAL(38, 30)) / POWER(CAST(1000 AS NUMERIC), (ROW_NUM - 1)))))
						FROM
							(SELECT 
								ROW_NUM = ROW_NUMBER() OVER (ORDER BY (SELECT 'A')),
								SUB_LVL = items
							FROM
								dbo.udf_split_list([LEVEL], '.')) LVLS)

	UPDATE 
		TH
	SET
		TH.HAS_CHILDREN = TH2MAIN.HAS_CHILDREN
	FROM
		@TMP_HIERARCHY TH INNER JOIN
		(SELECT
			[JOB_NUMBER] = TH2.JOB_NUMBER,
			[JOB_COMPONENT_NBR] = TH2.JOB_COMPONENT_NBR,
			[SEQ_NBR] = TH2.SEQ_NBR,
			[HAS_CHILDREN] = CONVERT(BIT, CASE
											WHEN TH2.SCHEDULE_CALC = 0 THEN 0 
											WHEN (	SELECT 
														COUNT(*) 
													FROM
														@TMP_HIERARCHY THD 
													WHERE 
														THD.[LEVEL] LIKE TH2.[LEVEL] + '.%' AND
														THD.JOB_NUMBER = TH2.JOB_NUMBER AND
														THD.JOB_COMPONENT_NBR = TH2.JOB_COMPONENT_NBR ) > 0 THEN 1 
											ELSE 0 
										END)
		FROM
			@TMP_HIERARCHY TH2) TH2MAIN ON TH.JOB_NUMBER = TH2MAIN.JOB_NUMBER AND
										   TH.JOB_COMPONENT_NBR = TH2MAIN.JOB_COMPONENT_NBR AND
										   TH.SEQ_NBR = TH2MAIN.SEQ_NBR

	INSERT INTO @HIERARCHY_TABLE
		SELECT
			[LEVEL] = SCHEDULE_ITEMS.[LEVEL],
			[JOB_NUMBER] = SCHEDULE_ITEMS.JOB_NUMBER,
			[JOB_COMPONENT_NBR] = SCHEDULE_ITEMS.JOB_COMPONENT_NBR,
			[SEQ_NBR] = SCHEDULE_ITEMS.SEQ_NBR,
			[HAS_CHILDREN] = SCHEDULE_ITEMS.HAS_CHILDREN,
			[TASK_START_DATE] = SCHEDULE_ITEMS.TASK_START_DATE,
			[JOB_REVISED_DATE] = SCHEDULE_ITEMS.JOB_REVISED_DATE,
			[JOB_DUE_DATE] = SCHEDULE_ITEMS.JOB_DUE_DATE,
			[JOB_COMPLETED_DATE] = SCHEDULE_ITEMS.JOB_COMPLETED_DATE,
			[TEMP_COMP_DATE] = SCHEDULE_ITEMS.TEMP_COMP_DATE,
			[JOB_HRS] = SCHEDULE_ITEMS.JOB_HRS,
			[JOB_DAYS] = SCHEDULE_ITEMS.JOB_DAYS,
			[ROW_ORDER] = SCHEDULE_ITEMS.ROW_ORDER		
		FROM
			(SELECT
				[JOB_NUMBER] = TH.JOB_NUMBER,
				[JOB_COMPONENT_NBR] = TH.JOB_COMPONENT_NBR,
				[SEQ_NBR] = TH.SEQ_NBR,
				[HAS_CHILDREN] = TH.HAS_CHILDREN,
				[TASK_START_DATE] = CASE
										WHEN TH.HAS_CHILDREN = 1 THEN ( SELECT 
																			MIN(THD.TASK_START_DATE) 
																		FROM 
																			@TMP_HIERARCHY THD 
																		WHERE 
																			THD.[LEVEL] LIKE TH.[LEVEL] + '.%' AND
																			THD.JOB_NUMBER = TH.JOB_NUMBER AND
																			THD.JOB_COMPONENT_NBR = TH.JOB_COMPONENT_NBR AND
																			THD.HAS_CHILDREN = 0) 
										ELSE TH.TASK_START_DATE
									END,
				[JOB_REVISED_DATE] = CASE
										WHEN TH.HAS_CHILDREN = 1 THEN ( SELECT
																			MAX(THD.JOB_REVISED_DATE) 
																		FROM 
																			@TMP_HIERARCHY THD 
																		WHERE 
																			THD.[LEVEL] LIKE TH.[LEVEL] + '.%' AND
																			THD.JOB_NUMBER = TH.JOB_NUMBER AND
																			THD.JOB_COMPONENT_NBR = TH.JOB_COMPONENT_NBR AND
																			THD.HAS_CHILDREN = 0) 
										ELSE TH.JOB_REVISED_DATE
									END,
				[JOB_DUE_DATE] = CASE WHEN TH.HAS_CHILDREN = 1 THEN NULL ELSE JTD.JOB_DUE_DATE END,
				[JOB_COMPLETED_DATE] = CASE WHEN TH.HAS_CHILDREN = 1 THEN NULL ELSE JTD.JOB_COMPLETED_DATE END,
				[TEMP_COMP_DATE] = CASE WHEN TH.HAS_CHILDREN = 1 THEN NULL ELSE JTD.TEMP_COMP_DATE END,
				[JOB_HRS] = CASE WHEN TH.HAS_CHILDREN = 1 THEN NULL ELSE JTD.JOB_HRS END,
				[JOB_DAYS] = CASE WHEN TH.HAS_CHILDREN = 1 THEN NULL ELSE JTD.JOB_DAYS END,
				[LEVEL] = TH.[LEVEL],
				[ROW_ORDER] = TH.ROW_ORDER
			FROM
				(SELECT
					[JOB_NUMBER] = TH.JOB_NUMBER,
					[JOB_COMPONENT_NBR] = TH.JOB_COMPONENT_NBR,
					[SEQ_NBR] = TH.SEQ_NBR,
					[LEVEL] = TH.[LEVEL],
					[TASK_START_DATE] = TH.TASK_START_DATE,
					[JOB_REVISED_DATE] = TH.JOB_REVISED_DATE,
					[HAS_CHILDREN] = TH.HAS_CHILDREN,
					[ROW_ORDER] = TH.ROW_ORDER
				 FROM
					@TMP_HIERARCHY TH) TH JOIN
			dbo.JOB_TRAFFIC_DET JTD ON TH.JOB_NUMBER = JTD.JOB_NUMBER AND
										TH.JOB_COMPONENT_NBR = JTD.JOB_COMPONENT_NBR AND
										TH.SEQ_NBR = JTD.SEQ_NBR) SCHEDULE_ITEMS

	RETURN

END