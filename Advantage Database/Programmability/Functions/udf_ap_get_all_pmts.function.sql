
CREATE FUNCTION [dbo].udf_ap_get_all_pmts (@al_ap_id INT, @as_vn_category VARCHAR(1))
RETURNS decimal(14,2)
/*Returns payments for given AP ( @al_ap_id )  */
AS
BEGIN

   DECLARE @ldec_prod_amt decimal(14,2)
   DECLARE @ldec_ab_amt decimal(14,2)
   DECLARE @ldec_media_amt decimal(14,2)
   DECLARE @ldec_total_amt decimal(14,2)
   DECLARE @ltemp as varchar(250)

IF @as_vn_category = 'P'
BEGIN
SET @ldec_prod_amt = (
SELECT COALESCE(SUM(CR_PAY_AMT), 0.00) + COALESCE(SUM(CR_ADJ_AMT), 0.00)
FROM CR_CLIENT_DTL CR
WHERE EXISTS (

	SELECT AP_ID
	FROM AP_PRODUCTION AP  ---Join using JOB_COMPONENT_NBR, JOB_NUMBER, AP_ID
	WHERE AP.AR_INV_NBR = CR.AR_INV_NBR 
		AND (MODIFY_DELETE IS NULL OR MODIFY_DELETE = 0) AND EXISTS (
	
		SELECT AP_PRODUCTION.AP_ID
		FROM AP_PRODUCTION 
		WHERE AP_PRODUCTION.AP_ID=AP.AP_ID AND AP_PRODUCTION.AP_ID = @al_ap_id
			AND AP_PRODUCTION.JOB_NUMBER=AP.JOB_NUMBER AND 
			AP_PRODUCTION.JOB_COMPONENT_NBR=AP.JOB_COMPONENT_NBR
		GROUP BY AP_PRODUCTION.AP_ID, AP_PRODUCTION.JOB_NUMBER, AP_PRODUCTION.JOB_COMPONENT_NBR
		HAVING COALESCE(SUM(AP_PROD_EXT_AMT), 0.00) + COALESCE(SUM(EXT_NONRESALE_TAX), 0.00) <> 0 

	)
	
	GROUP BY AP.AP_ID, AP.JOB_NUMBER, AP.JOB_COMPONENT_NBR, AP.AR_INV_NBR
	HAVING (AP.AR_INV_NBR Is Not Null)

  )

)
--IF @adec_prod_adv_amt <> 0
SET @ldec_ab_amt = (
SELECT COALESCE(SUM(CR_PAY_AMT), 0.00) + COALESCE(SUM(CR_ADJ_AMT), 0.00)
FROM CR_CLIENT_DTL CR
	WHERE AR_INV_NBR IN (
		SELECT AR_INV_NBR FROM ADVANCE_BILLING AA 
		WHERE EXISTS (
			SELECT AB.JOB_NUMBER
			FROM ADVANCE_BILLING AB, AP_PRODUCTION AP 
			WHERE AB.JOB_NUMBER = AP.JOB_NUMBER AND AB.JOB_COMPONENT_NBR = AP.JOB_COMPONENT_NBR
				AND AP.AP_ID = @al_ap_id AND AB.JOB_NUMBER = AA.JOB_NUMBER 
				AND AB.JOB_COMPONENT_NBR = AA.JOB_COMPONENT_NBR
			GROUP BY AB.JOB_NUMBER, AB.JOB_COMPONENT_NBR
				HAVING SUM(AB.ADV_BILL_NET_AMT) <> 0
		)
	)

)
END

IF @as_vn_category = 'N'
	SET @ldec_media_amt = (
SELECT COALESCE(SUM(CR_PAY_AMT), 0.00) + COALESCE(SUM(CR_ADJ_AMT), 0.00)
FROM CR_CLIENT_DTL CR
WHERE EXISTS (SELECT AR_INV_NBR
	FROM V_NEWS_DETAIL RD, AP_NEWSPAPER AP 
	WHERE AP_ID = @al_ap_id AND AP.ORDER_NBR=RD.ORDER_NBR AND AP.ORDER_LINE_NBR=RD.LINE_NBR
	AND CR.AR_INV_NBR=RD.AR_INV_NBR
	AND EXISTS (
	SELECT ORDER_NBR FROM AP_NEWSPAPER AA
	WHERE AA.ORDER_NBR = AP.ORDER_NBR AND AA.ORDER_LINE_NBR  = AP.ORDER_LINE_NBR
	GROUP BY AP_ID, ORDER_NBR
	HAVING COALESCE(SUM(NET_PLUS), 0.00) + COALESCE(SUM(VENDOR_TAX), 0.00) <> 0)
	)
)
ELSE
IF @as_vn_category = 'M'
	SET @ldec_media_amt = (
SELECT COALESCE(SUM(CR_PAY_AMT), 0.00) + COALESCE(SUM(CR_ADJ_AMT), 0.00)
FROM CR_CLIENT_DTL CR
WHERE EXISTS (SELECT AR_INV_NBR
	FROM V_MAG_DETAIL RD, AP_MAGAZINE AP 
	WHERE AP_ID = @al_ap_id AND AP.ORDER_NBR=RD.ORDER_NBR AND AP.ORDER_LINE_NBR=RD.LINE_NBR
	AND CR.AR_INV_NBR=RD.AR_INV_NBR
	AND EXISTS (
	SELECT ORDER_NBR FROM AP_MAGAZINE AA
	WHERE AA.ORDER_NBR = AP.ORDER_NBR AND AA.ORDER_LINE_NBR  = AP.ORDER_LINE_NBR
	GROUP BY AP_ID, ORDER_NBR
	HAVING COALESCE(SUM(NET_PLUS), 0.00) + COALESCE(SUM(VENDOR_TAX), 0.00) <> 0)
	)
)
ELSE
IF @as_vn_category = 'R'
	SET @ldec_media_amt = (
SELECT COALESCE(SUM(CR_PAY_AMT), 0.00) + COALESCE(SUM(CR_ADJ_AMT), 0.00)
FROM CR_CLIENT_DTL CR
WHERE CR_PAY_AMT > 0 AND AR_INV_NBR IN ( --Eliminate credits
	SELECT MON_AR_INV_NBR --year
	FROM V_RADIO_DETAIL RD, AP_RADIO AP 
	WHERE AP_ID = @al_ap_id AND AP.ORDER_NBR=RD.ORDER_NBR 
	AND AP.BRDCAST_YEAR=RD.BRDCAST_YEAR
	AND AP.BRDCAST_MONTH=RD.MONTH_SHORT 
	AND (MODIFY_DELETE IS NULL OR MODIFY_DELETE = 0)
	AND EXISTS (
		SELECT ORDER_NBR FROM AP_RADIO AA
		WHERE AA.ORDER_NBR = AP.ORDER_NBR
		AND AA.BRDCAST_YEAR=AP.BRDCAST_YEAR
		AND AA.BRDCAST_MONTH=AP.BRDCAST_MONTH
		GROUP BY ORDER_NBR, REV_NBR, BRDCAST_YEAR, BRDCAST_MONTH
		HAVING COALESCE(SUM(EXT_NET_AMT), 0.00) + COALESCE(SUM(VENDOR_TAX), 0.00) <> 0
		)
	GROUP BY RD.BRDCAST_YEAR, RD.MONTH_SHORT, MON_AR_INV_NBR
	HAVING COALESCE(SUM(RD.LINE_TOTAL), 0.00) <> 0
	)
)
ELSE
IF @as_vn_category = 'T'
	SET @ldec_media_amt = (
SELECT COALESCE(SUM(CR_PAY_AMT), 0.00) + COALESCE(SUM(CR_ADJ_AMT), 0.00)
FROM CR_CLIENT_DTL CR 
WHERE CR_PAY_AMT > 0 AND AR_INV_NBR IN ( --Eliminate credits
	SELECT MON_AR_INV_NBR --year
	FROM V_TV_DETAIL RD, AP_TV AP 
	WHERE AP_ID = @al_ap_id AND AP.ORDER_NBR=RD.ORDER_NBR 
	AND AP.BRDCAST_YEAR=RD.BRDCAST_YEAR
	AND AP.BRDCAST_MONTH=RD.MONTH_SHORT 
	AND (MODIFY_DELETE IS NULL OR MODIFY_DELETE = 0)
	AND EXISTS (
		SELECT ORDER_NBR FROM AP_TV AA
		WHERE AA.ORDER_NBR = AP.ORDER_NBR
		AND AA.BRDCAST_YEAR=AP.BRDCAST_YEAR
		AND AA.BRDCAST_MONTH=AP.BRDCAST_MONTH
		GROUP BY ORDER_NBR, REV_NBR, BRDCAST_YEAR, BRDCAST_MONTH
		HAVING COALESCE(SUM(EXT_NET_AMT), 0.00) + COALESCE(SUM(VENDOR_TAX), 0.00) <> 0
		)
	GROUP BY RD.BRDCAST_YEAR, RD.MONTH_SHORT, MON_AR_INV_NBR
	HAVING COALESCE(SUM(RD.LINE_TOTAL), 0.00) <> 0
	)
)
ELSE
IF @as_vn_category = 'O'
	SET @ldec_media_amt = (
SELECT COALESCE(SUM(CR_PAY_AMT), 0.00) + COALESCE(SUM(CR_ADJ_AMT), 0.00)
FROM CR_CLIENT_DTL CR
WHERE EXISTS (SELECT AR_INV_NBR
	FROM OUTDOOR_DETAIL RD, AP_OUTDOOR AP 
	WHERE AP_ID = @al_ap_id
	AND AP.ORDER_NBR=RD.ORDER_NBR AND AP.ORDER_LINE_NBR=RD.LINE_NBR
	AND CR.AR_INV_NBR=RD.AR_INV_NBR
	AND EXISTS (
	SELECT ORDER_NBR FROM AP_OUTDOOR AA
	WHERE AA.ORDER_NBR = AP.ORDER_NBR AND AA.ORDER_LINE_NBR  = AP.ORDER_LINE_NBR
	GROUP BY AP_ID, ORDER_NBR
	HAVING COALESCE(SUM(NET_AMT), 0.00) + COALESCE(SUM(VENDOR_TAX), 0.00) <> 0)
	)
)
ELSE
IF @as_vn_category = 'I'
	SET @ldec_media_amt = (
SELECT COALESCE(SUM(CR_PAY_AMT), 0.00) + COALESCE(SUM(CR_ADJ_AMT), 0.00)
FROM CR_CLIENT_DTL CR
WHERE EXISTS (SELECT AR_INV_NBR
	FROM INTERNET_DETAIL RD, AP_INTERNET AP 
	WHERE AP_ID = @al_ap_id
	AND AP.ORDER_NBR=RD.ORDER_NBR AND AP.ORDER_LINE_NBR=RD.LINE_NBR
	AND CR.AR_INV_NBR=RD.AR_INV_NBR
	AND EXISTS (
	SELECT ORDER_NBR FROM AP_INTERNET AA
	WHERE AA.ORDER_NBR = AP.ORDER_NBR AND AA.ORDER_LINE_NBR  = AP.ORDER_LINE_NBR
	GROUP BY AP_ID, ORDER_NBR
	HAVING COALESCE(SUM(NET_AMT), 0.00) + COALESCE(SUM(VENDOR_TAX), 0.00) <> 0)
	)
)
IF @ldec_media_amt IS NULL
	SET @ldec_media_amt = 0
IF @ldec_prod_amt IS NULL
	SET @ldec_prod_amt = 0
IF @ldec_ab_amt IS NULL
	SET @ldec_ab_amt = 0

SET @ldec_total_amt = @ldec_media_amt + @ldec_prod_amt + @ldec_ab_amt

RETURN @ldec_total_amt

END

