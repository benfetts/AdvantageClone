CREATE  FUNCTION [dbo].[wvfn_alert_get_last_user_name] ( @ALERT_ID int )  		  	
RETURNS VARCHAR(61) AS  	
BEGIN  

	DECLARE 
		@EMP_NAME VARCHAR(61),
		@LAST_COMMENT_USER_CODE VARCHAR(100),
		@LAST_COMMENT_USER_CODE_CP INT,
		@IS_CP_ALERT SMALLINT
		
		SELECT @IS_CP_ALERT = ISNULL(ALERT.CP_ALERT,0) FROM ALERT WITH(NOLOCK) WHERE ALERT.ALERT_ID = @ALERT_ID;
		
		IF @IS_CP_ALERT = 0
		BEGIN
			SET @LAST_COMMENT_USER_CODE = (
				SELECT TOP 1 ALERT_COMMENT.USER_CODE 
				FROM ALERT_COMMENT WITH(NOLOCK) 
				WHERE ALERT_ID = @ALERT_ID 
				ORDER BY ALERT_COMMENT.GENERATED_DATE DESC
			);
			IF (@LAST_COMMENT_USER_CODE IS NULL) 
			BEGIN
				SELECT @LAST_COMMENT_USER_CODE = ALERT.ALERT_USER FROM ALERT WITH(NOLOCK) WHERE ALERT.ALERT_ID = @ALERT_ID;
			END
			IF (@LAST_COMMENT_USER_CODE IS NOT NULL)
			BEGIN
				SET @EMP_NAME = (SELECT [dbo].[advfn_get_user_name](@LAST_COMMENT_USER_CODE)); 
			END
		END
		
		IF @IS_CP_ALERT = 1
		BEGIN
			SET @LAST_COMMENT_USER_CODE_CP = (
				SELECT TOP 1 ALERT_COMMENT.USER_CODE_CP 
				FROM ALERT_COMMENT WITH(NOLOCK) 
				WHERE ALERT_ID = @ALERT_ID 
				ORDER BY ALERT_COMMENT.GENERATED_DATE DESC
			);
			IF (@LAST_COMMENT_USER_CODE_CP IS NULL) 
			BEGIN
				SELECT @LAST_COMMENT_USER_CODE_CP = ALERT.ALERT_USER_CP FROM ALERT WITH(NOLOCK) WHERE ALERT.ALERT_ID = @ALERT_ID;
			END
			IF (@LAST_COMMENT_USER_CODE_CP IS NOT NULL)
			BEGIN
				SET @EMP_NAME = (SELECT CONT_FML FROM CDP_CONTACT_HDR WITH (NOLOCK) WHERE CDP_CONTACT_ID = @LAST_COMMENT_USER_CODE_CP); 
			END
		END
	
	RETURN ISNULL(@EMP_NAME, '')

END