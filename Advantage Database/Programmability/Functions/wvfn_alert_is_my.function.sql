/*

If we had a field to track this status of the alert, we wouldn't need this function

*/
if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[wvfn_alert_is_my]') and xtype in (N'FN', N'IF', N'TF'))
drop function [dbo].[wvfn_alert_is_my]
GO
CREATE FUNCTION [dbo].[wvfn_alert_is_my] 
(
@ALERT_ID INT, 
@EMP_CODE VARCHAR(6)
)
RETURNS INT
AS
BEGIN

	DECLARE
	@RETURN_VALUE TINYINT
	-- 0 = NOT MY ANYTHING

	-- 1 = MY ALERT
	-- 2 = MY ASSIGNMENT

	-- 3 = MY ALERT DISMISSED
	-- 4 = MY ASSIGNMENT COMPLETED

	-- 5 = NOT MY ASSIGNMENT
	-- 6 = NOT MY ASSIGNMENT COMPLETED

	-- 7 = NOT MY ALERT
	-- 8 = NOT MY ALERT DISMISSED

	SET @RETURN_VALUE = 0;

	IF @RETURN_VALUE = 0
	BEGIN

		IF EXISTS (SELECT 1 FROM ALERT_RCPT WITH(NOLOCK) WHERE ALERT_RCPT.EMP_CODE = @EMP_CODE AND ALERT_RCPT.ALERT_ID = @ALERT_ID AND (ALERT_RCPT.CURRENT_NOTIFY = 0 OR ALERT_RCPT.CURRENT_NOTIFY IS NULL))
		BEGIN

			SET @RETURN_VALUE = 1;

		END

	END

	IF @RETURN_VALUE = 0
	BEGIN

		IF EXISTS (SELECT 1 FROM ALERT_RCPT WITH(NOLOCK) WHERE ALERT_RCPT.EMP_CODE = @EMP_CODE AND ALERT_RCPT.ALERT_ID = @ALERT_ID AND ALERT_RCPT.CURRENT_NOTIFY = 1)
		BEGIN

			SET @RETURN_VALUE = 2;

		END

	END

	IF @RETURN_VALUE = 0
	BEGIN

		IF EXISTS (SELECT 1 FROM ALERT_RCPT_DISMISSED WITH(NOLOCK) WHERE ALERT_RCPT_DISMISSED.EMP_CODE = @EMP_CODE AND ALERT_RCPT_DISMISSED.ALERT_ID = @ALERT_ID AND (ALERT_RCPT_DISMISSED.CURRENT_NOTIFY = 0 OR ALERT_RCPT_DISMISSED.CURRENT_NOTIFY IS NULL))
		BEGIN

			SET @RETURN_VALUE = 3;

		END

	END

	IF @RETURN_VALUE = 0
	BEGIN

		IF EXISTS (SELECT 1 FROM ALERT_RCPT_DISMISSED WITH(NOLOCK) WHERE ALERT_RCPT_DISMISSED.EMP_CODE = @EMP_CODE AND ALERT_RCPT_DISMISSED.ALERT_ID = @ALERT_ID AND ALERT_RCPT_DISMISSED.CURRENT_NOTIFY = 1)
		BEGIN

			SET @RETURN_VALUE = 4;

		END

	END

	IF @RETURN_VALUE = 0
	BEGIN

		IF EXISTS (SELECT 1 FROM ALERT_RCPT WITH(NOLOCK) WHERE ALERT_RCPT.EMP_CODE <> @EMP_CODE AND ALERT_RCPT.ALERT_ID = @ALERT_ID AND ALERT_RCPT.CURRENT_NOTIFY = 1)
		BEGIN

			SET @RETURN_VALUE = 5;

		END

	END

	IF @RETURN_VALUE = 0
	BEGIN

		IF EXISTS (SELECT 1 FROM ALERT_RCPT_DISMISSED WITH(NOLOCK) WHERE ALERT_RCPT_DISMISSED.EMP_CODE <> @EMP_CODE AND ALERT_RCPT_DISMISSED.ALERT_ID = @ALERT_ID AND ALERT_RCPT_DISMISSED.CURRENT_NOTIFY = 1)
		BEGIN

			SET @RETURN_VALUE = 6;

		END

	END

	IF @RETURN_VALUE = 0
	BEGIN

		IF EXISTS (SELECT 1 FROM ALERT_RCPT WITH(NOLOCK) WHERE ALERT_RCPT.EMP_CODE <> @EMP_CODE AND ALERT_RCPT.ALERT_ID = @ALERT_ID AND (ALERT_RCPT.CURRENT_NOTIFY = 0 OR ALERT_RCPT.CURRENT_NOTIFY IS NULL))
		BEGIN

			SET @RETURN_VALUE = 7;

		END

	END

	IF @RETURN_VALUE = 0
	BEGIN

		IF EXISTS (SELECT 1 FROM ALERT_RCPT_DISMISSED WITH(NOLOCK) WHERE ALERT_RCPT_DISMISSED.EMP_CODE <> @EMP_CODE AND ALERT_RCPT_DISMISSED.ALERT_ID = @ALERT_ID AND (ALERT_RCPT_DISMISSED.CURRENT_NOTIFY = 0 OR ALERT_RCPT_DISMISSED.CURRENT_NOTIFY IS NULL))
		BEGIN

			SET @RETURN_VALUE = 8;

		END

	END

RETURN @RETURN_VALUE;

END