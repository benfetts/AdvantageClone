--DROP FUNCTION dbo.wvfn_next_task_seq_nbr
CREATE FUNCTION dbo.wvfn_next_task_seq_nbr
(

@JOB_NUMBER INT,
@JOB_COMPONENT_NBR SMALLINT,
@SEQ_NBR SMALLINT

)
RETURNS SMALLINT
AS
BEGIN
/*=========== QUERY ===========*/

	DECLARE @TASKS_TO_PROCESS TABLE (
		[ID] [int] IDENTITY(1,1) NOT NULL,
		SEQ_NBR SMALLINT,
		TASK_STATUS VARCHAR(1)
		);
		
	INSERT INTO @TASKS_TO_PROCESS
	SELECT SEQ_NBR, TASK_STATUS
	FROM JOB_TRAFFIC_DET
	WHERE 
		JOB_NUMBER = @JOB_NUMBER 
		AND JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR
	ORDER BY 
		JOB_TRAFFIC_DET.TASK_START_DATE, 
		JOB_TRAFFIC_DET.JOB_REVISED_DATE, 
		JOB_TRAFFIC_DET.JOB_DUE_DATE, 
		JOB_TRAFFIC_DET.JOB_ORDER ASC, 
		JOB_TRAFFIC_DET.SEQ_NBR ASC;
		
	DECLARE
		@CURRENT_TASK_ORDER_ID INT,
		@NEXT_SEQ_NBR SMALLINT
	
	SELECT @CURRENT_TASK_ORDER_ID = [ID] FROM @TASKS_TO_PROCESS WHERE SEQ_NBR = @SEQ_NBR;
	 
	SELECT @NEXT_SEQ_NBR = A.SEQ_NBR
	FROM (	 
		SELECT TOP 1 SEQ_NBR 
		FROM @TASKS_TO_PROCESS 
		WHERE [ID] > @CURRENT_TASK_ORDER_ID ORDER BY [ID]
	) AS A
	
/*=========== QUERY ===========*/

	RETURN @NEXT_SEQ_NBR;
	
END
                      

