--DROP FUNCTION dbo.wvfn_open_assignment_count
CREATE FUNCTION dbo.wvfn_open_assignment_count
(
@JOB_NUMBER INT,
@JOB_COMPONENT_NBR SMALLINT
)
RETURNS INT
AS
BEGIN

	DECLARE @COUNT AS INT;

	IF @JOB_COMPONENT_NBR IS NULL OR @JOB_COMPONENT_NBR < 1
	BEGIN
		SELECT 
			@COUNT = COUNT(1)
		FROM         
			ALERT WITH(NOLOCK) INNER JOIN
			ALERT_RCPT WITH(NOLOCK) ON ALERT.ALERT_ID = ALERT_RCPT.ALERT_ID
		WHERE     
			(ALERT.JOB_NUMBER = @JOB_NUMBER)
			AND (NOT ALERT.ALRT_NOTIFY_HDR_ID IS NULL AND NOT ALERT.ALERT_STATE_ID IS NULL)
			AND (ALERT_RCPT.CURRENT_NOTIFY = 1);
	END
	ELSE
	BEGIN
		SELECT 
			@COUNT = COUNT(1)
		FROM         
			ALERT WITH(NOLOCK) INNER JOIN
			ALERT_RCPT WITH(NOLOCK) ON ALERT.ALERT_ID = ALERT_RCPT.ALERT_ID
		WHERE     
			(ALERT.JOB_NUMBER = @JOB_NUMBER)
			AND (ALERT.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR)
			AND (NOT ALERT.ALRT_NOTIFY_HDR_ID IS NULL AND NOT ALERT.ALERT_STATE_ID IS NULL)
			AND (ALERT_RCPT.CURRENT_NOTIFY = 1);
	END

	RETURN ISNULL(@COUNT, 0)
	
END