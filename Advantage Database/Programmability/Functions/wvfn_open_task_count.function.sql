--DROP FUNCTION dbo.wvfn_open_task_count
CREATE FUNCTION dbo.wvfn_open_task_count
(
	@JOB_NUMBER INT,
	@JOB_COMPONENT_NBR SMALLINT,
	@INCLUDE_EVENT_TASKS BIT
)
RETURNS INT
AS
BEGIN
	DECLARE @COUNT AS INT
	
		SELECT 
			@COUNT = COUNT(1)
		FROM         
			JOB_TRAFFIC_DET WITH(NOLOCK)
		WHERE     
			(JOB_TRAFFIC_DET.JOB_NUMBER = @JOB_NUMBER)
			AND (JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR)
			AND (JOB_TRAFFIC_DET.JOB_COMPLETED_DATE IS NULL)
			
		SET @COUNT = ISNULL(@COUNT, 0)
			
		IF @INCLUDE_EVENT_TASKS = 1
		BEGIN
		
			SELECT     
				@COUNT = @COUNT + COUNT(1)
			FROM         
				EVENT INNER JOIN
				EVENT_TASK ON EVENT.EVENT_ID = EVENT_TASK.EVENT_ID
			WHERE 
				EVENT.JOB_NUMBER = @JOB_NUMBER
				AND EVENT.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR
				AND EVENT_TASK.TEMP_COMP_DATE IS NULL    
		
		END	
			
	RETURN ISNULL(@COUNT, 0)
	
END
                      

