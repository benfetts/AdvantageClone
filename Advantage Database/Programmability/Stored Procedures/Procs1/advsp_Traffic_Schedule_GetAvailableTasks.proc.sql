CREATE PROCEDURE [dbo].[advsp_Traffic_Schedule_GetAvailableTasks]
	@SHOW_PRESET BIT
AS
BEGIN

	IF @SHOW_PRESET = 1
	BEGIN
		
		SELECT	[ID] = TRF_PRESET_DTL.ROWID,
				[TaskTemplateCode] = TRF_PRESET_HDR.TRF_PRESET_CODE,
				[TaskTemplateDescription] = TRF_PRESET_HDR.TRF_PRESET_DESC,
				[TaskCode] = TRF_PRESET_DTL.FNC_CODE,
				[TaskDescription] = TRAFFIC_FNC.TRF_DESC,
				[ProcessOrderNumber] = TRF_PRESET_DTL.TRF_PRESET_ORDER,
				[DaysToComplete] = TRF_PRESET_DTL.TRF_PRESET_DAYS,
				[HoursAllowed] = TRF_PRESET_DTL.TRF_PRESET_HRS,
				[PhaseID] = TRF_PRESET_DTL.TRAFFIC_PHASE_ID,
				[PhaseDescription] = TRAFFIC_PHASE.PHASE_DESC,
				[IsMilestone] = TRF_PRESET_DTL.MILESTONE,
				[ParentTaskCode] = TRF_PRESET_DTL.PARENT_TASK,
				[DefaultEmployeeCode] = TRF_PRESET_DTL.DEFAULT_EMP,
				[RushDaysToComplete] = TRF_PRESET_DTL.RUSH_DAYS,
				[RushHoursToComplete] = TRF_PRESET_DTL.RUSH_HOURS,
				[FunctionCode] = CASE WHEN TRF_PRESET_DTL.EST_FNC_CODE IS NULL THEN TRAFFIC_FNC.FNC_CODE ELSE TRF_PRESET_DTL.EST_FNC_CODE END,
				[RoleCode] = CASE WHEN TRF_PRESET_DTL.DEF_TRF_ROLE IS NULL THEN TRAFFIC_FNC.DEF_TRF_ROLE ELSE TRF_PRESET_DTL.DEF_TRF_ROLE END,
				[StatusCode] = TRAFFIC_FNC.DEF_STATUS
		FROM dbo.TRF_PRESET_DTL WITH(NOLOCK)
		INNER JOIN dbo.TRF_PRESET_HDR WITH(NOLOCK) ON TRF_PRESET_DTL.TRF_PRESET_CODE = TRF_PRESET_HDR.TRF_PRESET_CODE 
		LEFT OUTER JOIN dbo.TRAFFIC_PHASE WITH(NOLOCK) ON TRF_PRESET_DTL.TRAFFIC_PHASE_ID = TRAFFIC_PHASE.TRAFFIC_PHASE_ID
		INNER JOIN dbo.TRAFFIC_FNC WITH(NOLOCK) ON TRF_PRESET_DTL.FNC_CODE = TRAFFIC_FNC.TRF_CODE
		WHERE (TRF_PRESET_HDR.INACTIVE_FLAG IS NULL OR TRF_PRESET_HDR.INACTIVE_FLAG = 0) AND
			  (TRAFFIC_FNC.TRF_INACTIVE IS NULL OR TRAFFIC_FNC.TRF_INACTIVE = 0)
		ORDER BY TRF_PRESET_HDR.TRF_PRESET_CODE,
				 TRF_PRESET_DTL.TRF_PRESET_ORDER;

	END

	IF @SHOW_PRESET = 0 OR @SHOW_PRESET IS NULL
	BEGIN
	
		SELECT	[ID] = 0,
				[TaskTemplateCode] = NULL,
				[TaskTemplateDescription] = NULL,
				[TaskCode] = TRAFFIC_FNC.TRF_CODE,
				[TaskDescription] = TRAFFIC_FNC.TRF_DESC,
				[ProcessOrderNumber] = TRAFFIC_FNC.TRF_ORDER,
				[DaysToComplete] = TRAFFIC_FNC.TRF_DAYS,
				[HoursAllowed] = TRAFFIC_FNC.TRF_HRS,
				[PhaseID] = NULL,
				[PhaseDescription] = NULL,
				[IsMilestone] = TRAFFIC_FNC.MILESTONE,
				[ParentTaskCode] = NULL,
				[DefaultEmployeeCode] = NULL,
				[RushDaysToComplete] = NULL,
				[RushHoursToComplete] = NULL,
				[FunctionCode] = TRAFFIC_FNC.FNC_CODE,
				[RoleCode] = TRAFFIC_FNC.DEF_TRF_ROLE,
				[StatusCode] = TRAFFIC_FNC.DEF_STATUS
		FROM dbo.TRAFFIC_FNC WITH(NOLOCK)
		WHERE (TRF_INACTIVE IS NULL OR TRF_INACTIVE = 0)
		ORDER BY TRAFFIC_FNC.TRF_CODE,
				 TRAFFIC_FNC.TRF_ORDER;
				 
	END
	
END