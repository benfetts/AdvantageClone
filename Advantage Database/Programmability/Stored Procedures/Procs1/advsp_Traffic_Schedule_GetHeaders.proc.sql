CREATE PROCEDURE [dbo].[advsp_Traffic_Schedule_GetHeaders] 
	@USER_ID VARCHAR(100),
	@PHASE_ID INT = NULL,
	@ROLE_CODE VARCHAR(6) = NULL,
	@TASK_CODE VARCHAR(10) = NULL,
	@EMP_CODE VARCHAR(6) = NULL,
	@PENDING_TASKS_ONLY BIT = 0,
	@EXCLUDE_PROJECTED_TASKS BIT = 0,
	@INCLUDE_COMPLETED_TASKS BIT = 0,
	@INCLUDE_CLOSED_JOBS BIT = 0,
	@CUT_OFF_DATE SMALLDATETIME = NULL
AS
BEGIN

	DECLARE @RESTRICTIONS INT
	DECLARE @MGR_COL VARCHAR(20) 
	
	SELECT @RESTRICTIONS = COUNT(*) FROM dbo.SEC_CLIENT WHERE SEC_CLIENT.[USER_ID] = @USER_ID

	SELECT @MGR_COL = CAST( AGY_SETTINGS_VALUE AS VARCHAR(20) ) FROM dbo.AGY_SETTINGS WHERE AGY_SETTINGS_CODE = 'TRAFFIC_MGR_COL'
	
	IF @PENDING_TASKS_ONLY = 1
		SET @INCLUDE_COMPLETED_TASKS = 0

	SELECT 
			[ScheduleID] = JOB_TRAFFIC.ROWID,
			[OfficeCode] = JOB_LOG.OFFICE_CODE,
			[OfficeName] = OFFICE.OFFICE_NAME,
			[ClientCode] = JOB_LOG.CL_CODE,
			[ClientName] = CLIENT.CL_NAME,
			[DivisionCode] = JOB_LOG.DIV_CODE,
			[DivisionName] = DIVISION.DIV_NAME,
			[ProductCode] = JOB_LOG.PRD_CODE,
			[ProductDescription] = PRODUCT.PRD_DESCRIPTION,
			[JobNumber] = JOB_TRAFFIC.JOB_NUMBER,
			[JobDescription] = JOB_LOG.JOB_DESC,
			[JobComponentNumber] = JOB_TRAFFIC.JOB_COMPONENT_NBR,
			[JobComponentDescription] = JOB_COMPONENT.JOB_COMP_DESC,
			[CampaignID] = JOB_LOG.CMP_IDENTIFIER,
			[CampaignCode] = CAMPAIGN.CMP_CODE,
			[CampaignName] = CAMPAIGN.CMP_NAME,
			[SalesClassCode] = JOB_LOG.SC_CODE,
			[SalesClassDescription] = SALES_CLASS.SC_DESCRIPTION,
			[StatusCode] = JOB_TRAFFIC.TRF_CODE,
			[StatusDescription] = TRAFFIC.TRF_DESCRIPTION,
			[AccountExecutiveEmployeeCode] = JOB_COMPONENT.EMP_CODE,
			[AccountExecutiveEmployeeName] = COALESCE((RTRIM(AE_EMPLOYEE.EMP_FNAME) + ' '),'') + COALESCE((AE_EMPLOYEE.EMP_MI + '. '),'') + COALESCE(AE_EMPLOYEE.EMP_LNAME,''),	
			[ManagerEmployeeCode] = JOB_TRAFFIC.MGR_EMP_CODE,
			[ManagerEmployeeName] = COALESCE((RTRIM(MGR_EMPLOYEE.EMP_FNAME) + ' '),'') + COALESCE((MGR_EMPLOYEE.EMP_MI + '. '),'') + COALESCE(MGR_EMPLOYEE.EMP_LNAME,''),
			[StartDate] = JOB_COMPONENT.[START_DATE],
			[JobFirstUseDate] = JOB_COMPONENT.JOB_FIRST_USE_DATE,
			[CompletedDate] = JOB_TRAFFIC.COMPLETED_DATE,
			[GutPercentComplete] = JOB_TRAFFIC.PERCENT_COMPLETE,
			[Comments] = JOB_TRAFFIC.TRF_COMMENTS
	FROM (SELECT JOB_TRAFFIC.ROWID,
				 JOB_TRAFFIC.JOB_NUMBER,
				 JOB_TRAFFIC.JOB_COMPONENT_NBR,
				 JOB_TRAFFIC.TRF_CODE,
				 JOB_TRAFFIC.COMPLETED_DATE,
				 JOB_TRAFFIC.PERCENT_COMPLETE,
				 JOB_TRAFFIC.TRF_COMMENTS,
				 MGR_EMP_CODE = CASE WHEN @MGR_COL = 'TR_TITLE1' THEN JOB_TRAFFIC.ASSIGN_1 
									 WHEN @MGR_COL = 'TR_TITLE2' THEN JOB_TRAFFIC.ASSIGN_2 
									 WHEN @MGR_COL = 'TR_TITLE3' THEN JOB_TRAFFIC.ASSIGN_3 
									 WHEN @MGR_COL = 'TR_TITLE4' THEN JOB_TRAFFIC.ASSIGN_4 
									 WHEN @MGR_COL = 'TR_TITLE5' THEN JOB_TRAFFIC.ASSIGN_5 
									 ELSE NULL
								END
		  FROM dbo.JOB_TRAFFIC) AS JOB_TRAFFIC 
	LEFT OUTER JOIN (SELECT JOB_TRAFFIC_DET.JOB_NUMBER, 
						    JOB_TRAFFIC_DET.JOB_COMPONENT_NBR, 
						    [PHASE_ID_MATCHES] = COUNT(CASE WHEN @PHASE_ID IS NULL THEN 1 WHEN @PHASE_ID = -1 AND JOB_TRAFFIC_DET.TRAFFIC_PHASE_ID IS NULL THEN 1 WHEN JOB_TRAFFIC_DET.TRAFFIC_PHASE_ID = @PHASE_ID THEN 1 ELSE NULL END), 
						    [ROLE_CODE_MATCHES] = COUNT(CASE WHEN @ROLE_CODE IS NULL THEN 1 WHEN JOB_TRAFFIC_DET.TRF_ROLE = @ROLE_CODE THEN 1 ELSE NULL END),
						    [TASK_CODE_MATCHES] = COUNT(CASE WHEN @TASK_CODE IS NULL THEN 1 WHEN JOB_TRAFFIC_DET.FNC_CODE = @TASK_CODE THEN 1 ELSE NULL END),
						    [EXCLUDE_PROJECTED_TASKS_MATCHES] = COUNT(CASE WHEN @EXCLUDE_PROJECTED_TASKS = 0 THEN 1 WHEN JOB_TRAFFIC_DET.TASK_STATUS <> 'P' OR JOB_TRAFFIC_DET.TASK_STATUS IS NULL THEN 1 ELSE NULL END),
						    [INCLUDE_COMPLETED_TASKS_MATCHES] = COUNT(CASE WHEN @INCLUDE_COMPLETED_TASKS = 1 THEN 1 WHEN JOB_TRAFFIC_DET.JOB_COMPLETED_DATE IS NULL THEN 1 ELSE NULL END),
						    [CUT_OFF_DATE_MATCHES] = COUNT(CASE WHEN @CUT_OFF_DATE IS NULL THEN 1 WHEN JOB_TRAFFIC_DET.JOB_REVISED_DATE IS NULL OR JOB_TRAFFIC_DET.JOB_REVISED_DATE < @CUT_OFF_DATE THEN 1 ELSE NULL END),
						    [PENDING_TASKS_ONLY_MATCHES] = COUNT(CASE WHEN @PENDING_TASKS_ONLY = 0 THEN 1 WHEN JOB_TRAFFIC_DET.TEMP_COMP_DATE IS NULL THEN 1 ELSE NULL END)
					 FROM dbo.JOB_TRAFFIC_DET
					 GROUP BY JOB_TRAFFIC_DET.JOB_NUMBER,
							  JOB_TRAFFIC_DET.JOB_COMPONENT_NBR) AS JOB_TRAFFIC_DET ON JOB_TRAFFIC.JOB_NUMBER = JOB_TRAFFIC_DET.JOB_NUMBER AND
																	JOB_TRAFFIC.JOB_COMPONENT_NBR = JOB_TRAFFIC_DET.JOB_COMPONENT_NBR
	LEFT OUTER JOIN (SELECT JOB_TRAFFIC_DET_EMPS.JOB_NUMBER,
							JOB_TRAFFIC_DET_EMPS.JOB_COMPONENT_NBR,
							[EMP_CODE_MATCHES] = COUNT(CASE WHEN @EMP_CODE IS NULL THEN 1 WHEN JOB_TRAFFIC_DET_EMPS.EMP_CODE = @EMP_CODE THEN 1 ELSE NULL END)
					 FROM dbo.JOB_TRAFFIC_DET_EMPS
					 GROUP BY JOB_TRAFFIC_DET_EMPS.JOB_NUMBER,
							  JOB_TRAFFIC_DET_EMPS.JOB_COMPONENT_NBR) AS JOB_TRAFFIC_DET_EMPS ON JOB_TRAFFIC.JOB_NUMBER = JOB_TRAFFIC_DET_EMPS.JOB_NUMBER AND
																								 JOB_TRAFFIC.JOB_COMPONENT_NBR = JOB_TRAFFIC_DET_EMPS.JOB_COMPONENT_NBR
	INNER JOIN dbo.JOB_COMPONENT WITH(NOLOCK) ON JOB_TRAFFIC.JOB_NUMBER = JOB_COMPONENT.JOB_NUMBER AND
												 JOB_TRAFFIC.JOB_COMPONENT_NBR = JOB_COMPONENT.JOB_COMPONENT_NBR
	INNER JOIN dbo.JOB_LOG WITH(NOLOCK) ON JOB_TRAFFIC.JOB_NUMBER = JOB_LOG.JOB_NUMBER
	INNER JOIN dbo.PRODUCT WITH(NOLOCK) ON JOB_LOG.CL_CODE = PRODUCT.CL_CODE AND
										   JOB_LOG.DIV_CODE = PRODUCT.DIV_CODE AND
										   JOB_LOG.PRD_CODE = PRODUCT.PRD_CODE
	INNER JOIN dbo.DIVISION WITH(NOLOCK) ON JOB_LOG.CL_CODE = DIVISION.CL_CODE AND
											JOB_LOG.DIV_CODE = DIVISION.DIV_CODE
	INNER JOIN dbo.CLIENT WITH(NOLOCK) ON JOB_LOG.CL_CODE = CLIENT.CL_CODE
	INNER JOIN dbo.OFFICE WITH(NOLOCK) ON PRODUCT.OFFICE_CODE = OFFICE.OFFICE_CODE
	LEFT OUTER JOIN dbo.CAMPAIGN WITH(NOLOCK) ON JOB_LOG.CMP_IDENTIFIER = CAMPAIGN.CMP_IDENTIFIER
	LEFT OUTER JOIN dbo.SALES_CLASS WITH(NOLOCK) ON JOB_LOG.SC_CODE = SALES_CLASS.SC_CODE 
	LEFT OUTER JOIN dbo.TRAFFIC WITH(NOLOCK) ON JOB_TRAFFIC.TRF_CODE = TRAFFIC.TRF_CODE
	LEFT OUTER JOIN (SELECT SEC_CLIENT.CL_CODE,
							SEC_CLIENT.DIV_CODE,
							SEC_CLIENT.PRD_CODE,
							SEC_CLIENT.[USER_ID],
							SEC_CLIENT.TIME_ENTRY 
					 FROM dbo.SEC_CLIENT WITH(NOLOCK)
					 WHERE SEC_CLIENT.[USER_ID] = @USER_ID) AS SEC_CLIENT ON JOB_LOG.CL_CODE = SEC_CLIENT.CL_CODE AND
																			 JOB_LOG.DIV_CODE = SEC_CLIENT.DIV_CODE AND
																			 JOB_LOG.PRD_CODE = SEC_CLIENT.PRD_CODE
	INNER JOIN dbo.EMPLOYEE AS AE_EMPLOYEE ON JOB_COMPONENT.EMP_CODE = AE_EMPLOYEE.EMP_CODE
	LEFT OUTER JOIN dbo.EMPLOYEE AS MGR_EMPLOYEE ON JOB_TRAFFIC.MGR_EMP_CODE = MGR_EMPLOYEE.EMP_CODE
	WHERE 1 = CASE WHEN @RESTRICTIONS = 0 THEN 1 WHEN SEC_CLIENT.[USER_ID] = @USER_ID AND (SEC_CLIENT.TIME_ENTRY IS NULL OR SEC_CLIENT.TIME_ENTRY = 0) THEN 1 ELSE 0 END AND
		  1 = CASE WHEN @PHASE_ID IS NULL THEN 1 WHEN JOB_TRAFFIC_DET.PHASE_ID_MATCHES > 0 THEN 1 ELSE 0 END AND
		  1 = CASE WHEN @ROLE_CODE IS NULL THEN 1 WHEN JOB_TRAFFIC_DET.ROLE_CODE_MATCHES > 0 THEN 1 ELSE 0 END AND
		  1 = CASE WHEN @TASK_CODE IS NULL THEN 1 WHEN JOB_TRAFFIC_DET.TASK_CODE_MATCHES > 0 THEN 1 ELSE 0 END AND
		  1 = CASE WHEN @EMP_CODE IS NULL THEN 1 WHEN JOB_TRAFFIC_DET_EMPS.EMP_CODE_MATCHES > 0 THEN 1 ELSE 0 END AND
		  1 = CASE WHEN @PENDING_TASKS_ONLY = 0 THEN 1 WHEN JOB_TRAFFIC_DET.INCLUDE_COMPLETED_TASKS_MATCHES > 0 THEN 1 ELSE 0 END AND
		  1 = CASE WHEN @EXCLUDE_PROJECTED_TASKS = 0 THEN 1 WHEN JOB_TRAFFIC_DET.EXCLUDE_PROJECTED_TASKS_MATCHES > 0 THEN 1 ELSE 0 END AND
		  1 = CASE WHEN @INCLUDE_COMPLETED_TASKS = 1 THEN 1 WHEN JOB_TRAFFIC_DET.INCLUDE_COMPLETED_TASKS_MATCHES > 0 THEN 1 ELSE 0 END AND
		  1 = CASE WHEN @INCLUDE_CLOSED_JOBS = 1 THEN 1 WHEN JOB_COMPONENT.JOB_PROCESS_CONTRL NOT IN (6, 12) THEN 1 ELSE 0 END AND
		  1 = CASE WHEN @CUT_OFF_DATE IS NULL THEN 1 WHEN JOB_TRAFFIC_DET.CUT_OFF_DATE_MATCHES > 0 THEN 1 ELSE 0 END
		  
END