IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[advsp_agile_check_for_missing_brd_alert]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
    DROP PROCEDURE [dbo].[advsp_agile_check_for_missing_brd_alert]
GO

CREATE PROCEDURE [dbo].[advsp_agile_check_for_missing_brd_alert]
@JOB_NUMBER INT,
@JOB_COMPONENT_NBR SMALLINT,
@USER_CODE VARCHAR(100)
AS
/*=========== QUERY ===========*/
BEGIN

	DECLARE @CURR_SEQ_NBR SMALLINT

	DECLARE DTL_CURSOR CURSOR FOR
	SELECT DISTINCT
		JTD.SEQ_NBR
	FROM 
		JOB_TRAFFIC_DET JTD 
		FULL OUTER JOIN ALERT A ON A.JOB_NUMBER = JTD.JOB_NUMBER AND A.JOB_COMPONENT_NBR = JTD.JOB_COMPONENT_NBR AND A.TASK_SEQ_NBR = JTD.SEQ_NBR
	WHERE 
		(A.ALERT_ID IS NULL OR A.ALERT_LEVEL <> 'BRD')
		AND JTD.JOB_NUMBER = @JOB_NUMBER 
		AND JTD.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR

	OPEN DTL_CURSOR;
	FETCH NEXT FROM DTL_CURSOR INTO @CURR_SEQ_NBR;

	WHILE (@@FETCH_STATUS = 0)
	BEGIN

		IF NOT EXISTS (SELECT * FROM ALERT A WHERE A.JOB_NUMBER = @JOB_NUMBER AND A.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR AND A.TASK_SEQ_NBR = @CURR_SEQ_NBR AND A.ALERT_LEVEL = 'BRD')
		BEGIN

			EXEC [dbo].[advsp_agile_add_assignment_from_task] @JOB_NUMBER, @JOB_COMPONENT_NBR, @CURR_SEQ_NBR, @USER_CODE;

		END

		FETCH NEXT FROM DTL_CURSOR INTO @CURR_SEQ_NBR;

	END

	CLOSE DTL_CURSOR;
	DEALLOCATE DTL_CURSOR;

END
/*=========== QUERY ===========*/
GO