IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[advsp_alert_clear_noncurrent_state]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[advsp_alert_clear_noncurrent_state]
GO
CREATE PROCEDURE [dbo].[advsp_alert_clear_noncurrent_state] 
@ALERT_ID INT
AS
/*=========== QUERY ===========*/
BEGIN
	UPDATE ALERT_RCPT SET ALERT_STATE_ID = NULL
	FROM
		ALERT A
		INNER JOIN ALERT_RCPT X ON A.ALERT_ID = X.ALERT_ID AND A.ALRT_NOTIFY_HDR_ID = X.ALRT_NOTIFY_HDR_ID 
	WHERE
		A.ALERT_ID = X.ALERT_ID
		AND A.IS_WORK_ITEM = 1
		AND NOT A.ALRT_NOTIFY_HDR_ID IS NULL
		AND NOT A.ALERT_STATE_ID IS NULL
		AND X.CURRENT_NOTIFY = 1
		AND X.ALERT_STATE_ID <> A.ALERT_STATE_ID
		AND A.ALERT_ID = @ALERT_ID;
	UPDATE ALERT_RCPT_DISMISSED SET ALERT_STATE_ID = NULL
	FROM
		ALERT A
		INNER JOIN ALERT_RCPT_DISMISSED X ON A.ALERT_ID = X.ALERT_ID AND A.ALRT_NOTIFY_HDR_ID = X.ALRT_NOTIFY_HDR_ID 
	WHERE
		A.ALERT_ID = X.ALERT_ID
		AND A.IS_WORK_ITEM = 1
		AND NOT A.ALRT_NOTIFY_HDR_ID IS NULL
		AND NOT A.ALERT_STATE_ID IS NULL
		AND X.CURRENT_NOTIFY = 1
		AND X.ALERT_STATE_ID <> A.ALERT_STATE_ID
		AND A.ALERT_ID = @ALERT_ID;
END
/*=========== QUERY ===========*/