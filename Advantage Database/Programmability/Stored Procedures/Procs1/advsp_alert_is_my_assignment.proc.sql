IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[advsp_alert_is_my_assignment]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
    DROP PROCEDURE [dbo].[advsp_alert_is_my_assignment]
GO
CREATE PROCEDURE [dbo].[advsp_alert_is_my_assignment] 
@ALERT_ID INT,
@EMP_CODE VARCHAR(6)
AS
BEGIN

	DECLARE
		@IS_MY_ASSIGNMENT BIT,
		@IS_WORK_ITEM BIT,
		@ASSIGNED_EMP_CODE VARCHAR(6),
		@IS_MY_ASSIGNMENT_OPEN BIT

	SELECT 
		@IS_WORK_ITEM = ISNULL(IS_WORK_ITEM, 0), 
		@ASSIGNED_EMP_CODE = ASSIGNED_EMP_CODE
	FROM 
		ALERT WITH(NOLOCK)
	WHERE 
		ALERT_ID = @ALERT_ID;

	IF @IS_MY_ASSIGNMENT = 0
	BEGIN
		IF @IS_WORK_ITEM = 1 AND @ASSIGNED_EMP_CODE = @EMP_CODE -- HANDLE ROUTED
		BEGIN
			SET @IS_MY_ASSIGNMENT = 1;
		END
	END
	IF @IS_MY_ASSIGNMENT = 0
	BEGIN
		IF @IS_WORK_ITEM = 1 AND (@ASSIGNED_EMP_CODE IS NULL OR DATALENGTH(@ASSIGNED_EMP_CODE) = 0)  -- HANDLE NON-ROUTED
		BEGIN
			IF EXISTS (SELECT 1 FROM ALERT_RCPT AS AR WITH(NOLOCK)  WHERE AR.ALERT_ID = @ALERT_ID AND AR.EMP_CODE = @EMP_CODE AND (AR.CURRENT_NOTIFY = 1))
			BEGIN
				SET @IS_MY_ASSIGNMENT = 1;
				SET @IS_MY_ASSIGNMENT_OPEN = 1;
			END
			IF EXISTS (SELECT 1 FROM ALERT_RCPT_DISMISSED AS AR WITH(NOLOCK)  WHERE AR.ALERT_ID = @ALERT_ID AND AR.EMP_CODE = @EMP_CODE AND (AR.CURRENT_NOTIFY = 1))
			BEGIN
				SET @IS_MY_ASSIGNMENT = 1;
				SET @IS_MY_ASSIGNMENT_OPEN = 0;
			END
		END
	END

	SELECT
		[IsMyAssignment] = ISNULL(@IS_MY_ASSIGNMENT, 0);

END