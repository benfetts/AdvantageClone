IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[advsp_alert_notifications]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
    DROP PROCEDURE [dbo].[advsp_alert_notifications]
GO

CREATE PROCEDURE [dbo].[advsp_alert_notifications]
@EMP_CODE VARCHAR(6),
@CDP_CONTACT_ID INT
AS
/*=========== QUERY ===========*/
BEGIN
    IF NOT @CDP_CONTACT_ID IS NULL AND @CDP_CONTACT_ID > 0
    BEGIN
	   SELECT TOP 100 PERCENT 
		     A.ALERT_ID AS AlertID,
			ISNULL(A.PRIORITY, 3) AS Priority,
			CASE
			    WHEN LEN(A.SUBJECT) > 42
			    THEN SUBSTRING(A.SUBJECT, 0, 42)+'...'
			    ELSE A.SUBJECT
			END AS ShortSubject,
			A.SUBJECT AS Subject,
			CASE
			    WHEN(NOT A.ALRT_NOTIFY_HDR_ID IS NULL
				    AND NOT A.ALERT_STATE_ID IS NULL)
			    THEN CAST(1 AS BIT)
			    ELSE CAST(0 AS BIT)
			END AS IsAssignment,
			ISNULL(A.JOB_NUMBER, 0) AS JobNumber,
			ISNULL(A.JOB_COMPONENT_NBR, 0) AS JobComponentNumber,
			ISNULL(A.TASK_SEQ_NBR,0) AS SequenceNumber,
			CAST(ISNULL(A.IS_CS_REVIEW, 0) AS BIT) AS IsConceptShareReview,
			ISNULL(A.CS_PROJECT_ID, 0) AS ConceptShareProjectID,
			ISNULL(A.CS_REVIEW_ID, 0) AS ConceptShareReviewID,
			A.ASSIGNED_EMP_CODE AS AssignedEmployeeCode,
			CAST(ISNULL(CP_ALERT_RCPT.CURRENT_NOTIFY, 0) AS BIT) AS CurrentNotify,
			CAST(ISNULL(A.IS_WORK_ITEM, 0) AS BIT) AS IsWorkItem,
			ISNULL(SD.SPRINT_HDR_ID, 0) AS SprintID,
			SU.EMP_CODE AS LastUpdatedEmployeeCode,
			A.LAST_UPDATED_FML AS LastUpdatedFullName
	   FROM ALERT A WITH (NOLOCK)
		   INNER JOIN CP_ALERT_RCPT WITH (NOLOCK) ON A.ALERT_ID = CP_ALERT_RCPT.ALERT_ID
		   LEFT OUTER JOIN SPRINT_DTL SD ON SD.ALERT_ID = A.ALERT_ID
		   LEFT OUTER JOIN SEC_USER SU ON A.LAST_UPDATED_USER_CODE = SU.USER_CODE
	   WHERE 
		    (A.IS_DRAFT IS NULL OR A.IS_DRAFT = 0)
		    AND CP_ALERT_RCPT.READ_ALERT IS NULL
		    AND CP_ALERT_RCPT.CDP_CONTACT_ID = @CDP_CONTACT_ID
	   ORDER BY A.LAST_UPDATED DESC, A.GENERATED DESC, A.PRIORITY DESC
    END
    IF NOT @EMP_CODE IS NULL
    BEGIN
	   SELECT DISTINCT RSLT.*
	   FROM
	   (
	   SELECT TOP 100 PERCENT 
		     A.ALERT_ID AS AlertID,
			 A.LAST_UPDATED AS LastUpdated,
			 A.GENERATED AS Generated,
			ISNULL(A.PRIORITY, 3) AS Priority,
			CASE
			    WHEN LEN(A.SUBJECT) > 42
			    THEN SUBSTRING(A.SUBJECT, 0, 42)+'...'
			    ELSE A.SUBJECT
			END AS ShortSubject,
			A.SUBJECT AS Subject,
			CASE
			    WHEN(NOT A.ALRT_NOTIFY_HDR_ID IS NULL
				    AND NOT A.ALERT_STATE_ID IS NULL)
			    THEN CAST(1 AS BIT)
			    ELSE CAST(0 AS BIT)
			END AS IsAssignment,
			ISNULL(A.JOB_NUMBER, 0) AS JobNumber,
			ISNULL(A.JOB_COMPONENT_NBR, 0) AS JobComponentNumber,
			ISNULL(A.TASK_SEQ_NBR,0) AS SequenceNumber,
			CAST(ISNULL(A.IS_CS_REVIEW, 0) AS BIT) AS IsConceptShareReview,
			ISNULL(A.CS_PROJECT_ID, 0) AS ConceptShareProjectID,
			ISNULL(A.CS_REVIEW_ID, 0) AS ConceptShareReviewID,
			A.ASSIGNED_EMP_CODE AS AssignedEmployeeCode,
			CAST(ISNULL(ALERT_RCPT.CURRENT_NOTIFY, 0) AS BIT) AS CurrentNotify,
			CAST(ISNULL(A.IS_WORK_ITEM, 0) AS BIT) AS IsWorkItem,
			ISNULL(SD.SPRINT_HDR_ID, 0) AS SprintID,
			SU.EMP_CODE AS LastUpdatedEmployeeCode,
			A.LAST_UPDATED_FML AS LastUpdatedFullName
	   FROM ALERT A WITH (NOLOCK)
		   LEFT OUTER JOIN ALERT_RCPT WITH (NOLOCK) ON A.ALERT_ID = ALERT_RCPT.ALERT_ID
		   LEFT OUTER JOIN SPRINT_DTL SD ON SD.ALERT_ID = A.ALERT_ID
		   LEFT OUTER JOIN SEC_USER SU ON A.LAST_UPDATED_USER_CODE = SU.USER_CODE
		   LEFT OUTER JOIN JOB_TRAFFIC_DET_EMPS JTE ON  A.JOB_NUMBER = JTE.JOB_NUMBER AND A.JOB_COMPONENT_NBR = JTE.JOB_COMPONENT_NBR AND A.TASK_SEQ_NBR = JTE.SEQ_NBR
	   WHERE 
		    (A.IS_DRAFT IS NULL OR A.IS_DRAFT = 0)
		    AND ( 
				(A.ASSIGNED_EMP_CODE = @EMP_CODE 
				    AND @EMP_CODE NOT IN (SELECT EMP_CODE FROM ALERT_RCPT_DISMISSED WHERE ALERT_RCPT_DISMISSED.ALERT_ID = A.ALERT_ID AND ALERT_RCPT_DISMISSED.EMP_CODE = @EMP_CODE AND ALERT_RCPT_DISMISSED.CURRENT_NOTIFY = 1)
				    AND (ALERT_RCPT.EMP_CODE = @EMP_CODE AND (ALERT_RCPT.READ_ALERT IS NULL OR ALERT_RCPT.READ_ALERT = 0) AND ALERT_RCPT.CURRENT_NOTIFY = 1)
				 ) -- CURR ASSIGN
				 OR (A.ALRT_NOTIFY_HDR_ID IS NULL AND A.ALERT_STATE_ID IS NULL AND JTE.EMP_CODE = @EMP_CODE AND (JTE.READ_ALERT IS NULL OR JTE.READ_ALERT = 0))
				 OR (A.ALRT_NOTIFY_HDR_ID IS NULL AND A.ALERT_STATE_ID IS NULL AND (ALERT_RCPT.READ_ALERT IS NULL OR ALERT_RCPT.READ_ALERT = 0) AND ALERT_RCPT.CURRENT_NOTIFY = 1 AND ALERT_RCPT.EMP_CODE = @EMP_CODE) -- MULTI ASSIGN
				 OR ((ALERT_RCPT.READ_ALERT IS NULL OR ALERT_RCPT.READ_ALERT = 0) AND ALERT_RCPT.EMP_CODE = @EMP_CODE AND (ALERT_RCPT.CURRENT_RCPT IS NULL OR ALERT_RCPT.CURRENT_RCPT = 0) AND (ALERT_RCPT.CURRENT_NOTIFY IS NULL OR ALERT_RCPT.CURRENT_NOTIFY = 0)) -- CC
			    )
			  ) AS RSLT
		ORDER BY LastUpdated DESC, Generated DESC, Priority DESC
    END
END
/*=========== QUERY ===========*/
-- TRIGGER AN UPDATE!