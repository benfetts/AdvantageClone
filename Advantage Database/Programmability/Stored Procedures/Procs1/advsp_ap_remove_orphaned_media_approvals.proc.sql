CREATE PROC advsp_ap_remove_orphaned_media_approvals @ap_id int

AS

DELETE dbo.AP_MEDIA_APPROVAL
FROM dbo.AP_MEDIA_APPROVAL AMP
	LEFT OUTER JOIN (SELECT AP_ID, ORDER_NBR, ORDER_LINE_NBR, 'I' AS SRC
					FROM dbo.AP_INTERNET 
					WHERE AP_ID = @ap_id
					AND COALESCE(MODIFY_DELETE, 0) = 0
					UNION
					SELECT AP_ID, ORDER_NBR, ORDER_LINE_NBR, 'M' AS SRC
					FROM dbo.AP_MAGAZINE 
					WHERE AP_ID = @ap_id
					AND COALESCE(MODIFY_DELETE, 0) = 0
					UNION
					SELECT AP_ID, ORDER_NBR, ORDER_LINE_NBR, 'N' AS SRC
					FROM dbo.AP_NEWSPAPER 
					WHERE AP_ID = @ap_id
					AND COALESCE(MODIFY_DELETE, 0) = 0
					UNION
					SELECT AP_ID, ORDER_NBR, ORDER_LINE_NBR, 'O' AS SRC
					FROM dbo.AP_OUTDOOR 
					WHERE AP_ID = @ap_id
					AND COALESCE(MODIFY_DELETE, 0) = 0
					UNION
					SELECT AP_ID, ORDER_NBR, ORDER_LINE_NBR, 'R' AS SRC
					FROM dbo.AP_RADIO 
					WHERE AP_ID = @ap_id
					AND COALESCE(MODIFY_DELETE, 0) = 0
					UNION
					SELECT AP_ID, ORDER_NBR, ORDER_LINE_NBR, 'T' AS SRC
					FROM dbo.AP_TV 
					WHERE AP_ID = @ap_id
					AND COALESCE(MODIFY_DELETE, 0) = 0
					) orders ON orders.AP_ID = AMP.AP_ID AND orders.ORDER_NBR = AMP.ORDER_NBR AND orders.ORDER_LINE_NBR = AMP.LINE_NBR AND orders.SRC = AMP.[SOURCE]
WHERE AMP.AP_ID = @ap_id
AND AMP.ACTIVE_REV = 1
AND [STATUS] = 1
AND orders.AP_ID IS NULL

GO
