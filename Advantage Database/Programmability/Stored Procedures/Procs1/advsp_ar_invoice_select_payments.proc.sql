CREATE PROCEDURE advsp_ar_invoice_select_payments @ARInvoiceNumber int, @ARInvoiceSequenceNumber smallint

AS

SELECT	[CheckNumber] = CR_CLIENT.CR_CHECK_NBR,
		[CheckDate] = CR_CLIENT.CR_CHECK_DATE,
		[AmountPaid] = SUM(COALESCE(CR_CLIENT_DTL.CR_PAY_AMT, 0)),
        [AdjustmentAmount] = SUM(COALESCE(CR_CLIENT_DTL.CR_ADJ_AMT, 0)),
        [GLACodeAdjustment] = CR_CLIENT_DTL.GLACODE_ADJ,
        [ClientCashReceiptID] = CR_CLIENT_DTL.REC_ID,
		[PaymentType] = CR_PAYMENT_TYPE.[DESCRIPTION]
FROM dbo.CR_CLIENT_DTL 
		INNER JOIN dbo.CR_CLIENT ON CR_CLIENT_DTL.REC_ID = CR_CLIENT.REC_ID
		LEFT OUTER JOIN dbo.CR_PAYMENT_TYPE ON CR_PAYMENT_TYPE.CR_PAYMENT_TYPE_ID = CR_CLIENT.CR_PAYMENT_TYPE_ID
WHERE	AR_INV_NBR = @ARInvoiceNumber
AND		AR_INV_SEQ = @ARInvoiceSequenceNumber
AND		CR_CLIENT.[STATUS] IS NULL
GROUP BY CR_CLIENT_DTL.REC_ID,
         CR_CLIENT.CR_CHECK_NBR,
         CR_CLIENT.CR_CHECK_DATE,
         CR_CLIENT_DTL.GLACODE_ADJ,
		 CR_PAYMENT_TYPE.[DESCRIPTION]
HAVING   SUM(COALESCE(CR_CLIENT_DTL.CR_PAY_AMT, 0)) <> 0 OR SUM(COALESCE(CR_CLIENT_DTL.CR_ADJ_AMT, 0)) <> 0
ORDER BY CR_CLIENT_DTL.REC_ID ASC

GO