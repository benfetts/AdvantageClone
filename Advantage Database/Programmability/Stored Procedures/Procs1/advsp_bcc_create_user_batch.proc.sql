CREATE PROCEDURE [dbo].[advsp_bcc_create_user_batch] @UserCode varchar(100), @BatchName varchar(25), @BCCID integer OUTPUT, @ErrorMessage varchar(200) OUTPUT

AS
BEGIN

	SET NOCOUNT ON;

	DECLARE @seq_no smallint,
			@DATE_CUTOFF_TO_USE smallint

	IF LEN(@UserCode) > 98
	BEGIN
		SELECT @ErrorMessage = 'User Code exceeds 98 character limit.'
		RETURN
	END
	
	IF EXISTS (SELECT BCC_ID FROM dbo.BILLING_CMD_CENTER
				WHERE UPPER(SUBSTRING(BILLING_USER, 1, LEN(BILLING_USER) - 2)) = UPPER(@UserCode)
				AND UPPER(BATCH_NAME) = UPPER(@BatchName))
	BEGIN
		SELECT @ErrorMessage = 'Batch Name exists for User.'
		RETURN
	END

	DECLARE @COUNTER int

	DECLARE @SEQS TABLE (
		SEQ_NO int NOT NULL
	)

	SET @COUNTER = 1
	WHILE @COUNTER < 100
	BEGIN
		INSERT INTO @SEQS (SEQ_NO) VALUES (@COUNTER)
		SET @COUNTER = @COUNTER + 1
	END

	SELECT @seq_no = MIN(s.SEQ_NO)
	FROM @SEQS s 
	WHERE s.SEQ_NO NOT IN (SELECT SEQ_NO FROM dbo.BILLING_CMD_CENTER WHERE UPPER(SUBSTRING(BILLING_USER, 1, LEN(BILLING_USER) - 2)) = UPPER(@UserCode))
		
	IF @seq_no IS NULL
	BEGIN
		SELECT @ErrorMessage = 'User exceeded 99 batch limit.'
		RETURN
	END
	
	SELECT @DATE_CUTOFF_TO_USE = STRING_VALUE
	FROM dbo.SEC_USER_SETTING sus
		INNER JOIN dbo.SEC_USER su ON sus.SEC_USER_ID = su.SEC_USER_ID AND sus.SETTING_CODE = 'BCCLastMediaDateToUse'
	WHERE UPPER(su.USER_CODE) = UPPER(@UserCode)
	AND ISNUMERIC(STRING_VALUE) = 1

	INSERT INTO dbo.BILLING_CMD_CENTER ( BILLING_USER, CREATE_DATE, P_SELECT_BY, 
				PROD_FLAG, SEL_OPTION, P_ET_CUTOFF_DATE, P_IO_CUTOFF_DATE, 
				P_AB_CUTOFF_DATE, BA_BATCH_ID, MEDIA_FLAG, M_SELECT_BY, 
				M_START_DATE, M_CUTOFF_DATE, NEWSPAPER, MAGAZINE, RADIO, TELEVISION, 
				OUT_OF_HOME, INTERNET, M_BRDCAST_MTH1, M_BRDCAST_MTH2, INCL_UNBILLED_ONLY, 
				INCL_ZERO_SPOTS, DATE_CUTOFF_TO_USE, RADIO_DAILY, TV_DAILY, RADIO_MONTHLY,
				TV_MONTHLY, P_AP_CUTOFF_PPD, BATCH_NAME, SEQ_NO )
	   VALUES ( CAST(@UserCode as varchar) + RIGHT('00' + CAST(@seq_no as varchar), 2), getdate(), 0, 0, 1, NULL, NULL, NULL,
				NULL, 0, 0, NULL, NULL, 0, 0, 0, 0, 0, 0, NULL, NULL, 1, 1, COALESCE(@DATE_CUTOFF_TO_USE, 2), 0, 0, 0, 0, NULL, @BatchName, @seq_no )

	SELECT @BCCID = @@IDENTITY
	
END
GO
