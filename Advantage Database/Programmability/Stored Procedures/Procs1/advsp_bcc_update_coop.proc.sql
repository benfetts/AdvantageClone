CREATE PROCEDURE [dbo].[advsp_bcc_update_coop] @ARFunctionID integer, @CostAmount decimal(18,2), @IncomeAmount decimal(18,2), @BillingUser varchar(100)

AS

BEGIN

UPDATE dbo.W_AR_FUNCTION SET
		AB_INC_AMT = CASE WHEN FNC_TYPE IN ('E','I') THEN @IncomeAmount ELSE 0 END,
		AB_COMMISSION_AMT = CASE WHEN FNC_TYPE = 'V' THEN @IncomeAmount ELSE 0 END,
		AB_COST_AMT = CASE WHEN FNC_TYPE = 'V' THEN @CostAmount ELSE 0 END,
		MODIFIED_FLAG = 1 
WHERE ( AR_FUNCTION_ID = @ARFunctionID )
AND	JOB_AB_FLAG = 2

UPDATE dbo.W_AR_FUNCTION SET
		EMP_TIME_AMT = CASE WHEN FNC_TYPE = 'E' THEN @IncomeAmount ELSE 0 END,
		INC_ONLY_AMT = CASE WHEN FNC_TYPE = 'I' THEN @IncomeAmount ELSE 0 END,
		COMMISSION_AMT = CASE WHEN FNC_TYPE = 'V' THEN @IncomeAmount ELSE 0 END,
		COST_AMT = CASE WHEN FNC_TYPE = 'V' THEN @CostAmount ELSE 0 END,
		MODIFIED_FLAG = 1
WHERE ( AR_FUNCTION_ID = @ARFunctionID ) 
AND	COALESCE(JOB_AB_FLAG, 0) = 0

IF(SELECT CAST(AGY_SETTINGS_VALUE as int) FROM dbo.AGY_SETTINGS WHERE AGY_SETTINGS_CODE = 'AVATAX_ENABLED') = 1
BEGIN
	UPDATE dbo.W_AR_FUNCTION SET
		STATE_TAX_AMT = 0,
		CNTY_TAX_AMT = 0,
		CITY_TAX_AMT = 0,
		AVATAX_CALCULATED = NULL
	WHERE ( AR_FUNCTION_ID = @ARFunctionID ) AND ( MODIFIED_FLAG = 1 ) AND ( INV_TAX_FLAG = 1 ) 
END
ELSE
BEGIN
	UPDATE dbo.W_AR_FUNCTION SET
		STATE_TAX_AMT = CASE 
					WHEN ( COALESCE ( TAX_COMM , 0 ) = 1 AND COALESCE ( TAX_COMM_ONLY , 0 ) = 0 ) THEN 
						dbo.advfn_calc_prod_resale ( COALESCE ( EMP_TIME_AMT , 0.00 ) + COALESCE ( INC_ONLY_AMT , 0.00 ) + COALESCE ( AB_SALE_AMT , 0.00 ) + 
						COALESCE ( AB_INC_AMT , 0.00 ) + COALESCE ( COST_AMT , 0.00 ) + COALESCE ( AB_COST_AMT , 0.00 ) , COALESCE ( COMMISSION_AMT , 0.00 ) + 
						COALESCE ( AB_COMMISSION_AMT , 0.00 ) , TAX_STATE_PCT ) 
					WHEN ( COALESCE ( TAX_COMM , 0 ) = 1 AND COALESCE ( TAX_COMM_ONLY , 0 ) = 1 ) THEN 
						dbo.advfn_calc_prod_resale ( 0.00 , COALESCE ( COMMISSION_AMT , 0.00 ) + COALESCE ( AB_COMMISSION_AMT , 0.00 ) , TAX_STATE_PCT ) 
					ELSE dbo.advfn_calc_prod_resale ( COALESCE ( EMP_TIME_AMT , 0.00 ) + COALESCE ( INC_ONLY_AMT , 0.00 ) + COALESCE ( AB_SALE_AMT , 0.00 ) + 
						COALESCE ( AB_INC_AMT , 0.00 ) + COALESCE ( COST_AMT , 0.00 ) + COALESCE ( AB_COST_AMT , 0.00 ) , 0.00 , TAX_STATE_PCT ) END ,
		CNTY_TAX_AMT = CASE 
					WHEN ( COALESCE ( TAX_COMM , 0 ) = 1 AND COALESCE ( TAX_COMM_ONLY , 0 ) = 0 ) THEN 
						dbo.advfn_calc_prod_resale ( COALESCE ( EMP_TIME_AMT , 0.00 ) + COALESCE ( INC_ONLY_AMT , 0.00 ) + COALESCE ( AB_SALE_AMT , 0.00 ) + 
						COALESCE ( AB_INC_AMT , 0.00 ) + COALESCE ( COST_AMT , 0.00 ) + COALESCE ( AB_COST_AMT , 0.00 ) , COALESCE ( COMMISSION_AMT , 0.00 ) + 
						COALESCE ( AB_COMMISSION_AMT , 0.00 ) , TAX_COUNTY_PCT ) 
					WHEN ( COALESCE ( TAX_COMM , 0 ) = 1 AND COALESCE ( TAX_COMM_ONLY , 0 ) = 1 ) THEN 
						dbo.advfn_calc_prod_resale ( 0.00 , COALESCE ( COMMISSION_AMT , 0.00 ) + COALESCE ( AB_COMMISSION_AMT , 0.00 ) , TAX_COUNTY_PCT ) 
					ELSE dbo.advfn_calc_prod_resale ( COALESCE ( EMP_TIME_AMT , 0.00 ) + COALESCE ( INC_ONLY_AMT , 0.00 ) + COALESCE ( AB_SALE_AMT , 0.00 ) + 
						COALESCE ( AB_INC_AMT , 0.00 ) + COALESCE ( COST_AMT , 0.00 ) + COALESCE ( AB_COST_AMT , 0.00 ) , 0.00 , TAX_COUNTY_PCT ) END , 
		CITY_TAX_AMT = CASE 
					WHEN ( COALESCE ( TAX_COMM , 0 ) = 1 AND COALESCE ( TAX_COMM_ONLY , 0 ) = 0 ) THEN
						dbo.advfn_calc_prod_resale ( COALESCE ( EMP_TIME_AMT , 0.00 ) + COALESCE ( INC_ONLY_AMT , 0.00 ) + COALESCE ( AB_SALE_AMT , 0.00 ) + 
						COALESCE ( AB_INC_AMT , 0.00 ) + COALESCE ( COST_AMT , 0.00 ) + COALESCE ( AB_COST_AMT , 0.00 ) , COALESCE ( COMMISSION_AMT , 0.00 ) + 
						COALESCE ( AB_COMMISSION_AMT , 0.00 ) , TAX_CITY_PCT ) 
					WHEN ( COALESCE ( TAX_COMM , 0 ) = 1 AND COALESCE ( TAX_COMM_ONLY , 0 ) = 1 ) THEN 
						dbo.advfn_calc_prod_resale ( 0.00 , COALESCE ( COMMISSION_AMT , 0.00 ) + COALESCE ( AB_COMMISSION_AMT , 0.00 ) , TAX_CITY_PCT ) 
					ELSE dbo.advfn_calc_prod_resale ( COALESCE ( EMP_TIME_AMT , 0.00 ) + COALESCE ( INC_ONLY_AMT , 0.00 ) + COALESCE ( AB_SALE_AMT , 0.00 ) + 
						COALESCE ( AB_INC_AMT , 0.00 ) + COALESCE ( COST_AMT , 0.00 ) + COALESCE ( AB_COST_AMT , 0.00 ) , 0.00 , TAX_CITY_PCT ) END 
	WHERE ( AR_FUNCTION_ID = @ARFunctionID ) AND ( MODIFIED_FLAG = 1 ) AND ( INV_TAX_FLAG = 1 ) 
END

UPDATE dbo.W_AR_FUNCTION SET 
	TOTAL_BILL = ( COALESCE ( EMP_TIME_AMT , 0.00 ) + COALESCE ( INC_ONLY_AMT , 0.00 ) + COALESCE ( COMMISSION_AMT , 0.00 ) + 
		COALESCE ( COST_AMT , 0.00 ) + COALESCE ( AB_COST_AMT , 0.00 ) + COALESCE ( AB_INC_AMT , 0.00 ) + COALESCE ( AB_COMMISSION_AMT , 0.00 ) + 
		COALESCE ( AB_SALE_AMT , 0.00 ) + COALESCE ( STATE_TAX_AMT , 0.00 ) + COALESCE ( CNTY_TAX_AMT , 0.00 ) + COALESCE ( CITY_TAX_AMT , 0.00 ) + 
		COALESCE ( NON_RESALE_AMT , 0.00 ) + COALESCE ( AB_NONRESALE_AMT , 0.00 ) ) 
WHERE ( BILLING_USER = @BillingUser ) AND ( FNC_TYPE IS NOT NULL ) 
END
GO
