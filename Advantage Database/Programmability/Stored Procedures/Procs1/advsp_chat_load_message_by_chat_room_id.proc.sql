--DROP PROCEDURE [dbo].[advsp_chat_load_message_by_chat_room_id]
CREATE PROCEDURE [dbo].[advsp_chat_load_message_by_chat_room_id]
@CHAT_ROOM_ID INT,
@HIDE_SYSTEM_MESSAGES BIT
AS
BEGIN
	
	IF @HIDE_SYSTEM_MESSAGES = 1 
	BEGIN

		SELECT        
			CHAT_MESSAGE.ID AS ID, 
			CHAT_MESSAGE.CHAT_ROOM_ID AS ChatRoomID, 
			CHAT_MESSAGE.USER_CODE AS UserCode, 
			CHAT_MESSAGE.[MESSAGE] AS [Message], 
			CHAT_MESSAGE.MESSAGE_DATE AS MessageDate, 
			CHAT_MESSAGE.IS_SYSTEM_MESSAGE AS IsSystemMessage, 
			EMPLOYEE_PICTURE.EMP_IMAGE AS EmployeePicture,
			COALESCE (RTRIM(EMPLOYEE.EMP_FNAME) + ' ', '') + COALESCE (EMPLOYEE.EMP_MI + '. ', '') + COALESCE (EMPLOYEE.EMP_LNAME, '') AS FullName
		FROM            
			CHAT_MESSAGE WITH(NOLOCK) 
			INNER JOIN SEC_USER WITH(NOLOCK)  ON UPPER(CHAT_MESSAGE.USER_CODE) = UPPER(SEC_USER.USER_CODE) 
			INNER JOIN EMPLOYEE WITH(NOLOCK)  ON SEC_USER.EMP_CODE = EMPLOYEE.EMP_CODE 
			LEFT OUTER JOIN EMPLOYEE_PICTURE WITH(NOLOCK)  ON EMPLOYEE.EMP_CODE = EMPLOYEE_PICTURE.EMP_CODE
		WHERE
			CHAT_MESSAGE.CHAT_ROOM_ID = @CHAT_ROOM_ID
			AND IS_SYSTEM_MESSAGE = 0
		ORDER BY
			CHAT_MESSAGE.MESSAGE_DATE, CHAT_MESSAGE.ID;

	END
	ELSE
	BEGIN

		SELECT        
			CHAT_MESSAGE.ID AS ID, 
			CHAT_MESSAGE.CHAT_ROOM_ID AS ChatRoomID, 
			CHAT_MESSAGE.USER_CODE AS UserCode, 
			CHAT_MESSAGE.[MESSAGE] AS [Message], 
			CHAT_MESSAGE.MESSAGE_DATE AS MessageDate, 
			CHAT_MESSAGE.IS_SYSTEM_MESSAGE AS IsSystemMessage, 
			EMPLOYEE_PICTURE.EMP_IMAGE AS EmployeePicture,
			COALESCE (RTRIM(EMPLOYEE.EMP_FNAME) + ' ', '') + COALESCE (EMPLOYEE.EMP_MI + '. ', '') + COALESCE (EMPLOYEE.EMP_LNAME, '') AS FullName
		FROM            
			CHAT_MESSAGE WITH(NOLOCK) 
			INNER JOIN SEC_USER WITH(NOLOCK)  ON UPPER(CHAT_MESSAGE.USER_CODE) = UPPER(SEC_USER.USER_CODE)
			INNER JOIN EMPLOYEE WITH(NOLOCK)  ON SEC_USER.EMP_CODE = EMPLOYEE.EMP_CODE 
			LEFT OUTER JOIN EMPLOYEE_PICTURE WITH(NOLOCK)  ON EMPLOYEE.EMP_CODE = EMPLOYEE_PICTURE.EMP_CODE
		WHERE
			CHAT_MESSAGE.CHAT_ROOM_ID = @CHAT_ROOM_ID
		ORDER BY
			CHAT_MESSAGE.MESSAGE_DATE, CHAT_MESSAGE.ID;

	END

END;