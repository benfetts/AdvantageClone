--DROP PROCEDURE dbo.advsp_chat_load_users
CREATE PROCEDURE dbo.advsp_chat_load_users
@JOB_NUMBER INT,
@JOB_COMPONENT_NBR SMALLINT,
@ALERT_ID INT,
@EMPLOYEE_TYPE SMALLINT,
@USER_CODE VARCHAR(100)
AS
BEGIN
/*=========== QUERY ===========*/

/*
    Private Enum EmployeeType

        AlertGroup = 1
        ScheduleAssignments = 2
        TaskAssignments = 3
        AccountExecutive = 4
        AlertRecipients = 5
		ProjectManager = 6
    End Enum

*/

DECLARE @CHAT_USERS TABLE (USER_CODE VARCHAR(100), EMP_CODE VARCHAR(6), FML VARCHAR(200), EMP_IMAGE IMAGE, EMP_NICKNAME VARCHAR(100))
DECLARE
	@ASSIGN1 VARCHAR(6),
	@ASSIGN2 VARCHAR(6),
	@ASSIGN3 VARCHAR(6),
	@ASSIGN4 VARCHAR(6),
	@ASSIGN5 VARCHAR(6)

IF @EMPLOYEE_TYPE = 0
BEGIN
	INSERT INTO @CHAT_USERS (EMP_CODE, FML, EMP_IMAGE, EMP_NICKNAME)
	SELECT DISTINCT
		E.EMP_CODE,
		COALESCE((RTRIM(E.EMP_FNAME) + ' '),'') + COALESCE((E.EMP_MI + '. '),'') + COALESCE(E.EMP_LNAME,'') AS FML,
		CAST(EP.EMP_IMAGE AS VARBINARY(MAX)) AS EMP_IMAGE,
		EP.EMP_NICKNAME
	FROM
		EMPLOYEE E 
		LEFT OUTER JOIN EMPLOYEE_PICTURE EP ON E.EMP_CODE = EP.EMP_CODE
	WHERE
		(E.EMP_TERM_DATE IS NULL OR E.EMP_TERM_DATE > GETDATE());
END

IF @EMPLOYEE_TYPE = 1
BEGIN
	DECLARE
		@EMAIL_GR_CODE VARCHAR(50)

	SELECT @EMAIL_GR_CODE = EMAIL_GR_CODE FROM JOB_COMPONENT WHERE JOB_NUMBER = @JOB_NUMBER AND JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR;
	
	INSERT INTO @CHAT_USERS (EMP_CODE, FML, EMP_IMAGE, EMP_NICKNAME)
	SELECT DISTINCT
		E.EMP_CODE,
		COALESCE((RTRIM(E.EMP_FNAME) + ' '),'') + COALESCE((E.EMP_MI + '. '),'') + COALESCE(E.EMP_LNAME,'') AS FML,
		CAST(EP.EMP_IMAGE AS VARBINARY(MAX)) AS EMP_IMAGE,
		EP.EMP_NICKNAME
	FROM
		EMPLOYEE E
		LEFT OUTER JOIN EMPLOYEE_PICTURE EP ON E.EMP_CODE = EP.EMP_CODE
	WHERE
		(E.EMP_TERM_DATE IS NULL OR E.EMP_TERM_DATE > GETDATE())
		AND E.EMP_CODE IN (SELECT DISTINCT EMP_CODE FROM EMAIL_GROUP WHERE EMAIL_GR_CODE = @EMAIL_GR_CODE);
END
IF @EMPLOYEE_TYPE = 2 OR @EMPLOYEE_TYPE = 6
BEGIN	

	SELECT @ASSIGN1 = ASSIGN_1, @ASSIGN2 = ASSIGN_2, @ASSIGN3 = ASSIGN_3, @ASSIGN4 = ASSIGN_4, @ASSIGN5 = ASSIGN_5  
	FROM JOB_TRAFFIC WHERE JOB_NUMBER = @JOB_NUMBER AND JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR;
END
IF @EMPLOYEE_TYPE = 2
BEGIN
	INSERT INTO @CHAT_USERS (EMP_CODE, FML, EMP_IMAGE, EMP_NICKNAME)
	SELECT DISTINCT
		E.EMP_CODE,
		COALESCE((RTRIM(E.EMP_FNAME) + ' '),'') + COALESCE((E.EMP_MI + '. '),'') + COALESCE(E.EMP_LNAME,'') AS FML,
		CAST(EP.EMP_IMAGE AS VARBINARY(MAX)) AS EMP_IMAGE,
		EP.EMP_NICKNAME
	FROM
		EMPLOYEE E 
		LEFT OUTER JOIN EMPLOYEE_PICTURE EP ON E.EMP_CODE = EP.EMP_CODE
	WHERE
		(E.EMP_TERM_DATE IS NULL OR E.EMP_TERM_DATE > GETDATE())
		AND E.EMP_CODE IN (@ASSIGN1, @ASSIGN2, @ASSIGN3, @ASSIGN4, @ASSIGN5);
END
IF @EMPLOYEE_TYPE = 3
BEGIN
	INSERT INTO @CHAT_USERS (EMP_CODE, FML, EMP_IMAGE, EMP_NICKNAME)
	SELECT DISTINCT
		E.EMP_CODE,
		COALESCE((RTRIM(E.EMP_FNAME) + ' '),'') + COALESCE((E.EMP_MI + '. '),'') + COALESCE(E.EMP_LNAME,'') AS FML,
		CAST(EP.EMP_IMAGE AS VARBINARY(MAX)) AS EMP_IMAGE,
		EP.EMP_NICKNAME
	FROM
		EMPLOYEE E 
		LEFT OUTER JOIN EMPLOYEE_PICTURE EP ON E.EMP_CODE = EP.EMP_CODE
	WHERE
		(E.EMP_TERM_DATE IS NULL OR E.EMP_TERM_DATE > GETDATE())
		AND E.EMP_CODE IN (SELECT DISTINCT EMP_CODE FROM JOB_TRAFFIC_DET_EMPS WHERE JOB_NUMBER = @JOB_NUMBER AND JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR);
END
IF @EMPLOYEE_TYPE = 4
BEGIN
	INSERT INTO @CHAT_USERS (EMP_CODE, FML, EMP_IMAGE, EMP_NICKNAME)
	SELECT DISTINCT
		E.EMP_CODE,
		COALESCE((RTRIM(E.EMP_FNAME) + ' '),'') + COALESCE((E.EMP_MI + '. '),'') + COALESCE(E.EMP_LNAME,'') AS FML,
		CAST(EP.EMP_IMAGE AS VARBINARY(MAX)) AS EMP_IMAGE,
		EP.EMP_NICKNAME
	FROM
		EMPLOYEE E 
		LEFT OUTER JOIN EMPLOYEE_PICTURE EP ON E.EMP_CODE = EP.EMP_CODE
	WHERE
		(E.EMP_TERM_DATE IS NULL OR E.EMP_TERM_DATE > GETDATE())
		AND E.EMP_CODE IN (SELECT EMP_CODE FROM JOB_COMPONENT WHERE JOB_NUMBER = @JOB_NUMBER AND JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR);
END
IF @EMPLOYEE_TYPE = 5
BEGIN
	INSERT INTO @CHAT_USERS (EMP_CODE, FML, EMP_IMAGE, EMP_NICKNAME)
	SELECT DISTINCT
		E.EMP_CODE,
		COALESCE((RTRIM(E.EMP_FNAME) + ' '),'') + COALESCE((E.EMP_MI + '. '),'') + COALESCE(E.EMP_LNAME,'') AS FML,
		CAST(EP.EMP_IMAGE AS VARBINARY(MAX)) AS EMP_IMAGE,
		EP.EMP_NICKNAME
	FROM
		EMPLOYEE E 
		LEFT OUTER JOIN EMPLOYEE_PICTURE EP ON E.EMP_CODE = EP.EMP_CODE
	WHERE
		(E.EMP_TERM_DATE IS NULL OR E.EMP_TERM_DATE > GETDATE())
		AND E.EMP_CODE IN (SELECT EMP_CODE FROM ALERT_RCPT WHERE ALERT_ID = @ALERT_ID UNION SELECT EMP_CODE FROM ALERT_RCPT_DISMISSED WHERE ALERT_ID = @ALERT_ID);
END
IF @EMPLOYEE_TYPE = 6
BEGIN
	
	DECLARE @PM AS VARCHAR(6), @MGR_COL VARCHAR(20)
	SELECT @MGR_COL = CAST(AGY_SETTINGS_VALUE AS VARCHAR(20)) FROM AGY_SETTINGS WHERE AGY_SETTINGS_CODE = 'TRAFFIC_MGR_COL';

	SELECT @PM = CASE
					WHEN @MGR_COL = 'TR_TITLE1' THEN (SELECT ASSIGN_1 FROM JOB_TRAFFIC WHERE JOB_NUMBER = @JOB_NUMBER AND JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR)
					WHEN @MGR_COL = 'TR_TITLE2' THEN (SELECT ASSIGN_2 FROM JOB_TRAFFIC WHERE JOB_NUMBER = @JOB_NUMBER AND JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR)
					WHEN @MGR_COL = 'TR_TITLE3' THEN (SELECT ASSIGN_3 FROM JOB_TRAFFIC WHERE JOB_NUMBER = @JOB_NUMBER AND JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR)
					WHEN @MGR_COL = 'TR_TITLE4' THEN (SELECT ASSIGN_4 FROM JOB_TRAFFIC WHERE JOB_NUMBER = @JOB_NUMBER AND JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR)
					WHEN @MGR_COL = 'TR_TITLE5' THEN (SELECT ASSIGN_5 FROM JOB_TRAFFIC WHERE JOB_NUMBER = @JOB_NUMBER AND JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR)
				 END
	IF NOT @PM IS NULL
	BEGIN
		INSERT INTO @CHAT_USERS (EMP_CODE, FML, EMP_IMAGE, EMP_NICKNAME)
		SELECT DISTINCT
			E.EMP_CODE,
			COALESCE((RTRIM(E.EMP_FNAME) + ' '),'') + COALESCE((E.EMP_MI + '. '),'') + COALESCE(E.EMP_LNAME,'') AS FML,
			CAST(EP.EMP_IMAGE AS VARBINARY(MAX)) AS EMP_IMAGE,
			EP.EMP_NICKNAME
		FROM
			EMPLOYEE E 
			LEFT OUTER JOIN EMPLOYEE_PICTURE EP ON E.EMP_CODE = EP.EMP_CODE
		WHERE
			(E.EMP_TERM_DATE IS NULL OR E.EMP_TERM_DATE > GETDATE())
			AND E.EMP_CODE = @PM;
	END
END

UPDATE @CHAT_USERS
SET USER_CODE = SU.USER_CODE
FROM @CHAT_USERS CU INNER JOIN SEC_USER SU ON CU.EMP_CODE = SU.EMP_CODE

--IF NOT EXISTS (SELECT USER_CODE FROM @CHAT_USERS WHERE USER_CODE = @USER_CODE)
--BEGIN
--	INSERT INTO @CHAT_USERS (USER_CODE, EMP_CODE, FML, EMP_IMAGE, EMP_NICKNAME)
--	SELECT 
--		@USER_CODE,
--		E.EMP_CODE,
--		COALESCE((RTRIM(E.EMP_FNAME) + ' '),'') + COALESCE((E.EMP_MI + '. '),'') + COALESCE(E.EMP_LNAME,'') AS FML,
--		CAST(EP.EMP_IMAGE AS VARBINARY(MAX)) AS EMP_IMAGE,
--		EP.EMP_NICKNAME
--	FROM
--		SEC_USER SU 
--		INNER JOIN EMPLOYEE E ON SU.EMP_CODE = E.EMP_CODE
--		LEFT OUTER JOIN EMPLOYEE_PICTURE EP ON E.EMP_CODE = EP.EMP_CODE
--	WHERE
--		(E.EMP_TERM_DATE IS NULL OR E.EMP_TERM_DATE > GETDATE())
--		AND SU.USER_CODE = @USER_CODE;
--END

	SELECT 
	 USER_CODE AS UserCode,
	 EMP_CODE AS EmployeeCode,
	 FML AS FullName,
	 EMP_IMAGE AS Picture,
	 EMP_NICKNAME AS Nickname 
	FROM @CHAT_USERS 
	ORDER BY FML;
/*=========== QUERY ===========*/
END