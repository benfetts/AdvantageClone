CREATE PROC [dbo].[advsp_doubleclick_validate_profileid]
	@PROFILE_ID bigint
AS

declare	@IsValid as int,
		@Token varchar(MAX),
        @ClientCode varchar(6)

SET @IsValid = 0

IF EXISTS(SELECT 1 FROM dbo.AGY_SETTINGS WHERE AGY_SETTINGS_CODE = 'DC_ENABLED' AND AGY_SETTINGS_VALUE = 1) AND 
	EXISTS(SELECT 1 FROM dbo.AGY_SETTINGS WHERE AGY_SETTINGS_CODE = 'DC_PROFILE_ID' AND AGY_SETTINGS_VALUE = @PROFILE_ID) AND
	EXISTS(SELECT 1 FROM dbo.AGY_SETTINGS WHERE AGY_SETTINGS_CODE = 'DC_OAUTH2_TOKEN' AND NULLIF(AGY_SETTINGS_VALUE,'') IS NOT NULL)
BEGIN
	SET @IsValid = 1
	SELECT @Token = CAST(AGY_SETTINGS_VALUE as varchar(MAX)) FROM dbo.AGY_SETTINGS WHERE AGY_SETTINGS_CODE = 'DC_OAUTH2_TOKEN'
    SET @ClientCode = NULL
END ELSE BEGIN
	IF EXISTS(SELECT 1 FROM dbo.CLIENT WHERE DC_PROFILE_ID = @PROFILE_ID AND DC_ENABLED = 1 AND NULLIF(DC_OAUTH2_TOKEN,'') IS NOT NULL)
	BEGIN
		SET @IsValid = 1
		SELECT @Token = DC_OAUTH2_TOKEN, @ClientCode = CL_CODE FROM dbo.CLIENT WHERE DC_PROFILE_ID = @PROFILE_ID AND DC_ENABLED = 1
	END
END

SELECT 
    IsValid = @IsValid,
    GoogleToken = @Token,
    ClientCode = @ClientCode

GO
