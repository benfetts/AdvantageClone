if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[advsp_estimate_approval_check]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[advsp_estimate_approval_check]
GO

CREATE PROCEDURE [dbo].[advsp_estimate_approval_check]
	@EstimateNumber int,
	@EstimateComponentNumber smallint,
	@EstimateQuoteNumber smallint,
	@EstimateRevisionNumber smallint,
	@JobNumber int,
	@CompNumber smallint,
	@Action varchar(20)

AS

DECLARE @MaxRevision int, @Spec_Version int, @Spec_Revision int, @JobQty int, @TaxCode varchar(10), @TAX_COMM int,
						@TAX_COMM_ONLY int,	@TAX_RESALE int,@EST_COMM_FLAG int,	@EST_TAX_FLAG int,@EST_NONBILL_FLAG int,@FEE_TIME int,
						@EST_FNC_TYPE varchar(6),@EST_CPM_FLAG int, @TAX_CODE varchar (4), @ROW_STATE_PERCENT DECIMAL(8,4),
						@ROW_COUNTY_PERCENT DECIMAL(8,4),@ROW_CITY_PERCENT DECIMAL(8,4), @MARKUP_AMT DECIMAL(9,3), @STATE_RESALE DECIMAL(14,2),
						@COUNTY_RESALE DECIMAL(14,2), @CITY_RESALE DECIMAL(14,2), @STATE_RESALE_MU DECIMAL(14,2), @CONT_PCT decimal(6, 3),
						@COUNTY_RESALE_MU DECIMAL(14,2), @CITY_RESALE_MU DECIMAL(14,2), @STATE_CONT DECIMAL(14,2),@COUNTY_CONT DECIMAL(14,2), @CITY_CONT DECIMAL(14,2),
						@MU_CONT DECIMAL(14,2), @NONRESALE_TAX DECIMAL(14,2), @NR_CONT DECIMAL(14,2), @CONTINGENCY DECIMAL(14,2), @AMOUNT DECIMAL(15,2), @STATE_NONRESALE DECIMAL(14,2),
						@COUNTY_NONRESALE DECIMAL(14,2), @CITY_NONRESALE DECIMAL(14,2), @LINE_TOTAL decimal(14, 2), @LINE_TOTAL_CONT decimal(14, 2), @SC_CODE varchar(6), @EMP_CODE varchar(6)

BEGIN

	CREATE TABLE #EstimateData(
		RowID int IDENTITY(1, 1), 
		EstimateNumber int,
		EstimateCompNumber int,
		QuoteNunber int,
		RevisionNumber int,
		SeqNumber int,
		ClientCode Varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
		DivisionCode Varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
		ProductCode Varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
		JobNumber int,
		JobComponentNumber smallint,
		FunctionCode varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
		Quantity decimal(15,2),
		Amount decimal(15,2),		
		Markup decimal(15,2),
		Approval int
		)
	
	
	If @Action = 'Quote'
	Begin
		INSERT INTO #EstimateData
		SELECT ESTIMATE_REV_DET.ESTIMATE_NUMBER, ESTIMATE_REV_DET.EST_COMPONENT_NBR, ESTIMATE_REV_DET.EST_QUOTE_NBR, 
					   ESTIMATE_REV_DET.EST_REV_NBR, ESTIMATE_REV_DET.SEQ_NBR,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
					FROM ESTIMATE_REV_DET INNER JOIN
						 ESTIMATE_REV ON ESTIMATE_REV_DET.ESTIMATE_NUMBER = ESTIMATE_REV.ESTIMATE_NUMBER AND 
						 ESTIMATE_REV_DET.EST_COMPONENT_NBR = ESTIMATE_REV.EST_COMPONENT_NBR AND 
						 ESTIMATE_REV_DET.EST_QUOTE_NBR = ESTIMATE_REV.EST_QUOTE_NBR AND 
						 ESTIMATE_REV_DET.EST_REV_NBR = ESTIMATE_REV.EST_REV_NBR INNER JOIN
						 ESTIMATE_LOG INNER JOIN
						 ESTIMATE_COMPONENT ON ESTIMATE_LOG.ESTIMATE_NUMBER = ESTIMATE_COMPONENT.ESTIMATE_NUMBER ON 
						 ESTIMATE_REV.ESTIMATE_NUMBER = ESTIMATE_COMPONENT.ESTIMATE_NUMBER AND 
						 ESTIMATE_REV.EST_COMPONENT_NBR = ESTIMATE_COMPONENT.EST_COMPONENT_NBR INNER JOIN
						 JOB_COMPONENT ON ESTIMATE_COMPONENT.ESTIMATE_NUMBER = JOB_COMPONENT.ESTIMATE_NUMBER AND 
						 ESTIMATE_COMPONENT.EST_COMPONENT_NBR = JOB_COMPONENT.EST_COMPONENT_NBR
					WHERE JOB_COMPONENT.JOB_NUMBER = @JobNumber

		DELETE FROM #EstimateData
		WHERE EstimateNumber = @EstimateNumber AND EstimateCompNumber = @EstimateComponentNumber

		IF EXISTS (SELECT * FROM #EstimateData)
		   BEGIN
				SELECT 1
		   END
		   ELSE
		   BEGIN
				SELECT 0
		   END

		
	End
	Else
	Begin
		INSERT INTO #EstimateData
		SELECT ESTIMATE_REV_DET.ESTIMATE_NUMBER, ESTIMATE_REV_DET.EST_COMPONENT_NBR, ESTIMATE_REV_DET.EST_QUOTE_NBR, 
					   ESTIMATE_REV_DET.EST_REV_NBR, ESTIMATE_REV_DET.SEQ_NBR, ESTIMATE_LOG.CL_CODE, ESTIMATE_LOG.DIV_CODE, ESTIMATE_LOG.PRD_CODE, V_ESTIMATEAPPR.JOB_NUMBER, 
					   V_ESTIMATEAPPR.JOB_COMPONENT_NBR, ESTIMATE_REV_DET.FNC_CODE, ISNULL(ESTIMATE_REV_DET.EST_REV_QUANTITY,0) AS EST_REV_QUANTITY, 
					   ISNULL(ESTIMATE_REV_DET.EST_REV_EXT_AMT,0) AS EST_REV_EXT_AMT, ISNULL(ESTIMATE_REV_DET.EXT_MARKUP_AMT,0) AS EXT_MARKUP_AMT, V_ESTIMATEAPPR.[TYPE]
					FROM ESTIMATE_REV_DET INNER JOIN
						 ESTIMATE_REV ON ESTIMATE_REV_DET.ESTIMATE_NUMBER = ESTIMATE_REV.ESTIMATE_NUMBER AND 
						 ESTIMATE_REV_DET.EST_COMPONENT_NBR = ESTIMATE_REV.EST_COMPONENT_NBR AND 
						 ESTIMATE_REV_DET.EST_QUOTE_NBR = ESTIMATE_REV.EST_QUOTE_NBR AND 
						 ESTIMATE_REV_DET.EST_REV_NBR = ESTIMATE_REV.EST_REV_NBR INNER JOIN
						 ESTIMATE_LOG INNER JOIN
						 ESTIMATE_COMPONENT ON ESTIMATE_LOG.ESTIMATE_NUMBER = ESTIMATE_COMPONENT.ESTIMATE_NUMBER ON 
						 ESTIMATE_REV.ESTIMATE_NUMBER = ESTIMATE_COMPONENT.ESTIMATE_NUMBER AND 
						 ESTIMATE_REV.EST_COMPONENT_NBR = ESTIMATE_COMPONENT.EST_COMPONENT_NBR INNER JOIN
						 V_ESTIMATEAPPR ON ESTIMATE_REV_DET.ESTIMATE_NUMBER = V_ESTIMATEAPPR.ESTIMATE_NUMBER AND 
						 ESTIMATE_REV_DET.EST_COMPONENT_NBR = V_ESTIMATEAPPR.EST_COMPONENT_NBR AND 
						 ESTIMATE_REV_DET.EST_QUOTE_NBR = V_ESTIMATEAPPR.EST_QUOTE_NBR AND 
						 ESTIMATE_REV_DET.EST_REV_NBR = V_ESTIMATEAPPR.EST_REVISION_NBR
					WHERE V_ESTIMATEAPPR.JOB_NUMBER = @JobNumber

		DELETE FROM #EstimateData
		WHERE EstimateNumber = @EstimateNumber AND EstimateCompNumber = @EstimateComponentNumber

		IF EXISTS (SELECT * FROM #EstimateData)
		   BEGIN
				SELECT 1
		   END
		   ELSE
		   BEGIN
				SELECT 0
		   END

		
	End

	

	
    


END