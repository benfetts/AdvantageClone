CREATE PROCEDURE [dbo].[advsp_gl_budget_data_update](
	@GLBDHCODE AS varchar(20))
AS
BEGIN

	SET NOCOUNT ON;

	CREATE TABLE #BUDGET_DATA(
		[ROW_ID] int IDENTITY(1,1),
		[GLACODE] varchar(30) NOT NULL,
		[MONTH] smallint NOT NULL,
		[AMOUNT] float NULL)

	DECLARE @BUDGET_ORDER AS smallint
	DECLARE @BUDGET_YEAR AS smallint
	DECLARE @ROW_COUNT AS int
	DECLARE @ROW_ID AS int
	DECLARE @GLACODE AS varchar(30)
	DECLARE @MONTH smallint
	DECLARE @AMOUNT float
	DECLARE @PPPERIOD AS varchar(6)
	
	SET @BUDGET_ORDER = 0
	SET @BUDGET_YEAR = 0

	IF EXISTS(SELECT * FROM dbo.GLBUDGETAPPRV GLBA WHERE GLBA.GLBDGTAPPR1 = @GLBDHCODE) BEGIN

		SELECT @BUDGET_ORDER = GLBA.GLBDGTORDER1, @BUDGET_YEAR = GLBA.GLBDGTAPPR_FY FROM dbo.GLBUDGETAPPRV GLBA WHERE GLBA.GLBDGTAPPR1 = @GLBDHCODE
		
	END
	 
	IF EXISTS(SELECT * FROM dbo.GLBUDGETAPPRV GLBA WHERE GLBA.GLBDGTAPPR2 = @GLBDHCODE) BEGIN

		SELECT @BUDGET_ORDER = GLBA.GLBDGTORDER2, @BUDGET_YEAR = GLBA.GLBDGTAPPR_FY FROM dbo.GLBUDGETAPPRV GLBA WHERE GLBA.GLBDGTAPPR2 = @GLBDHCODE
		
	END
	 
	IF EXISTS(SELECT * FROM dbo.GLBUDGETAPPRV GLBA WHERE GLBA.GLBDGTAPPR3 = @GLBDHCODE) BEGIN

		SELECT @BUDGET_ORDER = GLBA.GLBDGTORDER3, @BUDGET_YEAR = GLBA.GLBDGTAPPR_FY FROM dbo.GLBUDGETAPPRV GLBA WHERE GLBA.GLBDGTAPPR3 = @GLBDHCODE
		
	END
	 
	IF EXISTS(SELECT * FROM dbo.GLBUDGETAPPRV GLBA WHERE GLBA.GLBDGTAPPR4 = @GLBDHCODE) BEGIN

		SELECT @BUDGET_ORDER = GLBA.GLBDGTORDER4, @BUDGET_YEAR = GLBA.GLBDGTAPPR_FY FROM dbo.GLBUDGETAPPRV GLBA WHERE GLBA.GLBDGTAPPR4 = @GLBDHCODE
		
	END
	 
	IF @BUDGET_ORDER <> 0 BEGIN

		INSERT INTO #BUDGET_DATA
		SELECT 
			GLBD.GLBDTGLCODE, 
			M.[MONTH], 
			CASE WHEN M.[MONTH] = 1 THEN GLBD.GLBDTPPAMT1
				 WHEN M.[MONTH] = 2 THEN GLBD.GLBDTPPAMT2
				 WHEN M.[MONTH] = 3 THEN GLBD.GLBDTPPAMT3
				 WHEN M.[MONTH] = 4 THEN GLBD.GLBDTPPAMT4
				 WHEN M.[MONTH] = 5 THEN GLBD.GLBDTPPAMT5
				 WHEN M.[MONTH] = 6 THEN GLBD.GLBDTPPAMT6
				 WHEN M.[MONTH] = 7 THEN GLBD.GLBDTPPAMT7
				 WHEN M.[MONTH] = 8 THEN GLBD.GLBDTPPAMT8
				 WHEN M.[MONTH] = 9 THEN GLBD.GLBDTPPAMT9
				 WHEN M.[MONTH] = 10 THEN GLBD.GLBDTPPAMT10
				 WHEN M.[MONTH] = 11 THEN GLBD.GLBDTPPAMT11
				 WHEN M.[MONTH] = 12 THEN GLBD.GLBDTPPAMT12 END
		FROM 
			dbo.GLBUDGETTRL GLBD CROSS JOIN 
			(SELECT [MONTH] = 1 UNION 
			SELECT [MONTH] = 2 UNION 
			SELECT [MONTH] = 3 UNION 
			SELECT [MONTH] = 4 UNION 
			SELECT [MONTH] = 5 UNION 
			SELECT [MONTH] = 6 UNION 
			SELECT [MONTH] = 7 UNION 
			SELECT [MONTH] = 8 UNION 
			SELECT [MONTH] = 9 UNION 
			SELECT [MONTH] = 10 UNION 
			SELECT [MONTH] = 11 UNION 
			SELECT [MONTH] = 12) AS M
		WHERE 
			GLBD.GLBDTCODE = @GLBDHCODE 
		
		SET @ROW_COUNT = @@ROWCOUNT
		SET @ROW_ID = 1

		WHILE @ROW_ID <= @ROW_COUNT BEGIN

			SELECT
				@GLACODE = [GLACODE],
				@MONTH = [MONTH],
				@AMOUNT = ISNULL([AMOUNT], 0)
			FROM
				#BUDGET_DATA
			WHERE
				[ROW_ID] = @ROW_ID

			SET @PPPERIOD = (SELECT TOP 1 PP.PPPERIOD FROM dbo.POSTPERIOD PP WHERE PP.PPGLMONTH = @MONTH AND PP.PPGLYEAR = CAST(@BUDGET_YEAR AS varchar(5)))

			IF @BUDGET_ORDER = 1 BEGIN

				IF EXISTS(SELECT GLSCODE FROM dbo.GLSUMMARY WHERE GLSCODE = @GLACODE AND GLSPP = @PPPERIOD) BEGIN
				
					UPDATE 
						dbo.GLSUMMARY
					SET
						GLSBUDGET = @AMOUNT
					WHERE
						GLSCODE = @GLACODE AND
						GLSPP = (SELECT TOP 1 PP.PPPERIOD FROM dbo.POSTPERIOD PP WHERE PP.PPGLMONTH = @MONTH AND PP.PPGLYEAR = CAST(@BUDGET_YEAR AS varchar(5)))

				END ELSE BEGIN 
				
					INSERT INTO dbo.GLSUMMARY(GLSCODE, GLSPP, GLSDEBIT, GLSCREDIT, GLSQTY, GLSBUDGET, GLSBUD2, GLSBUD3, GLSMOD, GLSBUD4)
					VALUES(@GLACODE, @PPPERIOD, 0, 0, 0, @AMOUNT, 0, 0, 'X', 0)
					
				END
				
			END ELSE IF @BUDGET_ORDER = 2 BEGIN

				IF EXISTS(SELECT GLSCODE FROM dbo.GLSUMMARY WHERE GLSCODE = @GLACODE AND GLSPP = @PPPERIOD) BEGIN
					
					UPDATE 
						dbo.GLSUMMARY
					SET
						GLSBUD2 = @AMOUNT
					WHERE
						GLSCODE = @GLACODE AND
						GLSPP = (SELECT TOP 1 PP.PPPERIOD FROM dbo.POSTPERIOD PP WHERE PP.PPGLMONTH = @MONTH AND PP.PPGLYEAR = CAST(@BUDGET_YEAR AS varchar(5)))

				END ELSE BEGIN 
				
					INSERT INTO dbo.GLSUMMARY(GLSCODE, GLSPP, GLSDEBIT, GLSCREDIT, GLSQTY, GLSBUDGET, GLSBUD2, GLSBUD3, GLSMOD, GLSBUD4)
					VALUES(@GLACODE, @PPPERIOD, 0, 0, 0, 0, @AMOUNT, 0, 'X', 0)
					
				END
				
			END ELSE IF @BUDGET_ORDER = 3 BEGIN

				IF EXISTS(SELECT GLSCODE FROM dbo.GLSUMMARY WHERE GLSCODE = @GLACODE AND GLSPP = @PPPERIOD) BEGIN
					
					UPDATE 
						dbo.GLSUMMARY
					SET
						GLSBUD3 = @AMOUNT
					WHERE
						GLSCODE = @GLACODE AND
						GLSPP = (SELECT TOP 1 PP.PPPERIOD FROM dbo.POSTPERIOD PP WHERE PP.PPGLMONTH = @MONTH AND PP.PPGLYEAR = CAST(@BUDGET_YEAR AS varchar(5)))

				END ELSE BEGIN 
				
					INSERT INTO dbo.GLSUMMARY(GLSCODE, GLSPP, GLSDEBIT, GLSCREDIT, GLSQTY, GLSBUDGET, GLSBUD2, GLSBUD3, GLSMOD, GLSBUD4)
					VALUES(@GLACODE, @PPPERIOD, 0, 0, 0, 0, 0, @AMOUNT, 'X', 0)
					
				END
				
			END ELSE IF @BUDGET_ORDER = 4 BEGIN

				IF EXISTS(SELECT GLSCODE FROM dbo.GLSUMMARY WHERE GLSCODE = @GLACODE AND GLSPP = @PPPERIOD) BEGIN
					
					UPDATE 
						dbo.GLSUMMARY
					SET
						GLSBUD4 = @AMOUNT
					WHERE
						GLSCODE = @GLACODE AND
						GLSPP = (SELECT TOP 1 PP.PPPERIOD FROM dbo.POSTPERIOD PP WHERE PP.PPGLMONTH = @MONTH AND PP.PPGLYEAR = CAST(@BUDGET_YEAR AS varchar(5)))

				END ELSE BEGIN 
				
					INSERT INTO dbo.GLSUMMARY(GLSCODE, GLSPP, GLSDEBIT, GLSCREDIT, GLSQTY, GLSBUDGET, GLSBUD2, GLSBUD3, GLSMOD, GLSBUD4)
					VALUES(@GLACODE, @PPPERIOD, 0, 0, 0, 0, 0, 0, 'X', @AMOUNT)
					
				END
				
			END

			SET @ROW_ID = @ROW_ID + 1
				
		END
		
	END

	DROP TABLE #BUDGET_DATA

END
GO


