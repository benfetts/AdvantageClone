CREATE PROCEDURE [dbo].[advsp_gl_update_to_summary]
	@SOURCE_TYPE varchar(2),
	@PP_CODE varchar(6)
AS

UPDATE dbo.GLSUMMARY SET GLSDEBIT = 0, GLSCREDIT = 0
WHERE GLSPP = @PP_CODE

SELECT
	h.GLEHXACT
INTO #TRANSACTIONS
FROM dbo.GLENTHDR h
	INNER JOIN dbo.GLENTTRL t ON h.GLEHXACT = t.GLETXACT 
WHERE h.GLEHPP = @PP_CODE 
AND 
	(
		(h.GLEHPOSTSUM IS NOT NULL AND h.GLEHSOURCE <> @SOURCE_TYPE)
		OR
		(h.GLEHSOURCE = @SOURCE_TYPE)
	)

SELECT SUM(Debit) Debit, Sum(Credit) Credit, GLETCODE
INTO #UPDATETABLE
FROM (
	SELECT
		Debit = CASE WHEN t.GLETAMT > 0 THEN t.GLETAMT ELSE 0 END,
		Credit = CASE WHEN t.GLETAMT < 0 THEN t.GLETAMT ELSE 0 END,
		t.GLETCODE
	FROM dbo.GLENTHDR h
		INNER JOIN dbo.GLENTTRL t ON h.GLEHXACT = t.GLETXACT 
    WHERE h.GLEHXACT IN (SELECT GLEHXACT FROM #TRANSACTIONS)
	) data
GROUP BY GLETCODE

UPDATE GLS SET GLSDEBIT = U.Debit, GLSCREDIT = U.Credit 
FROM dbo.GLSUMMARY GLS
	INNER JOIN #UPDATETABLE U ON GLS.GLSCODE = U.GLETCODE 
WHERE GLS.GLSPP = @PP_CODE 

INSERT INTO dbo.GLSUMMARY (GLSCODE, GLSPP, GLSDEBIT, GLSCREDIT, GLSQTY, GLSBUDGET, GLSBUD2, GLSBUD3, GLSMOD, GLSBUD4)
SELECT U.GLETCODE, @PP_CODE, U.Debit, U.Credit, 0, 0, 0, 0, 0, 0
FROM #UPDATETABLE U
	LEFT OUTER JOIN dbo.GLSUMMARY GLS ON U.GLETCODE = GLS.GLSCODE AND GLS.GLSPP = @PP_CODE 
WHERE GLS.GLSCODE IS NULL

UPDATE dbo.GLENTHDR SET GLEHPOSTSUM = getdate() 
WHERE GLEHPP = @PP_CODE 
AND GLEHSOURCE = @SOURCE_TYPE
AND GLEHPOSTSUM IS NULL
AND GLEHXACT IN (SELECT GLEHXACT FROM #TRANSACTIONS)

GO
