CREATE PROCEDURE [dbo].[advsp_income_only_load_job_comp_select_list] 
	@USER_CODE VARCHAR(100),
	@COMPS_WITH_RECORDS_ONLY BIT = 0
AS
BEGIN

	SELECT 
		[ID] = JOB_COMPONENT.ROWID,
		[OfficeCode] = JOB_LOG.OFFICE_CODE,
		[OfficeName] = OFFICE.OFFICE_NAME,
		[ClientCode] = JOB_LOG.CL_CODE,
		[ClientName] = CLIENT.CL_NAME,
		[DivisionCode] = JOB_LOG.DIV_CODE,
		[DivisionName] = DIVISION.DIV_NAME,
		[ProductCode] = JOB_LOG.PRD_CODE,
		[ProductName] = PRODUCT.PRD_DESCRIPTION,
		[JobNumber] = JOB_COMPONENT.JOB_NUMBER,
		[JobDescription] = JOB_LOG.JOB_DESC,
		[JobComponentNumber] = JOB_COMPONENT.JOB_COMPONENT_NBR,
		[JobComponentDescription] = JOB_COMPONENT.JOB_COMP_DESC,
		[SalesClassCode] = JOB_LOG.SC_CODE,
		[SalesClassDescription] = SALES_CLASS.SC_DESCRIPTION,
		[ServiceFeeFlag] = JOB_COMPONENT.SERVICE_FEE_FLAG,
		[ServiceFeeTypeID] = JOB_COMPONENT.SERVICE_FEE_TYPE_ID,
		[ServiceFeeTypeCode] = SERVICE_FEE_TYPE.CODE,
		[ServiceFeeTypeDescription] = SERVICE_FEE_TYPE.[DESCRIPTION]
	FROM
		dbo.JOB_COMPONENT JOIN
		dbo.JOB_LOG ON JOB_COMPONENT.JOB_NUMBER = JOB_LOG.JOB_NUMBER JOIN
		dbo.CLIENT ON JOB_LOG.CL_CODE = CLIENT.CL_CODE JOIN
		dbo.DIVISION ON JOB_LOG.CL_CODE = DIVISION.CL_CODE AND
						JOB_LOG.DIV_CODE = DIVISION.DIV_CODE JOIN
		dbo.PRODUCT ON JOB_LOG.CL_CODE = PRODUCT.CL_CODE AND
						JOB_LOG.DIV_CODE = PRODUCT.DIV_CODE AND
						JOB_LOG.PRD_CODE = PRODUCT.PRD_CODE LEFT OUTER JOIN
		dbo.OFFICE ON JOB_LOG.OFFICE_CODE = OFFICE.OFFICE_CODE LEFT OUTER JOIN
		dbo.SALES_CLASS ON JOB_LOG.SC_CODE = SALES_CLASS.SC_CODE LEFT OUTER JOIN
		dbo.SERVICE_FEE_TYPE ON JOB_COMPONENT.SERVICE_FEE_TYPE_ID = SERVICE_FEE_TYPE.SERVICE_FEE_TYPE_ID LEFT OUTER JOIN
		(SELECT	
			INCOME_ONLY.JOB_NUMBER,
			INCOME_ONLY.JOB_COMPONENT_NBR,
			IO_COUNT = COUNT(*)
		 FROM
			dbo.INCOME_ONLY JOIN
			(SELECT 
				[IO_ID] = INCOME_ONLY.IO_ID, 
				[SEQ_NBR] = MAX(INCOME_ONLY.SEQ_NBR) 
			 FROM 
				dbo.INCOME_ONLY
			 GROUP BY
				INCOME_ONLY.IO_ID) IO_MAX ON INCOME_ONLY.IO_ID = IO_MAX.IO_ID AND
										     INCOME_ONLY.SEQ_NBR = IO_MAX.SEQ_NBR
		 WHERE
			ISNULL(INCOME_ONLY.DELETE_FLAG, 0) = 0
		 GROUP BY
			INCOME_ONLY.JOB_NUMBER,
			INCOME_ONLY.JOB_COMPONENT_NBR) INCOME_ONLY ON JOB_COMPONENT.JOB_NUMBER = INCOME_ONLY.JOB_NUMBER AND
														  JOB_COMPONENT.JOB_COMPONENT_NBR = INCOME_ONLY.JOB_COMPONENT_NBR INNER JOIN
		dbo.advtf_user_job_limits(@USER_CODE) JL ON JOB_LOG.JOB_NUMBER = JL.JOB_NUMBER
	WHERE
		JOB_COMPONENT.JOB_PROCESS_CONTRL IN (1, 8, 9, 10, 11) AND
		1 = CASE WHEN @COMPS_WITH_RECORDS_ONLY = 0 THEN 1 WHEN ISNULL(INCOME_ONLY.IO_COUNT, 0) > 0 THEN 1 ELSE 0 END
		
END