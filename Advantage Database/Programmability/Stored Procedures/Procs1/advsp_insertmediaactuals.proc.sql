SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

SET ANSI_PADDING OFF
GO

IF EXISTS ( SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID(N'[dbo].[advsp_insertmediaactuals]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1 )
	DROP PROCEDURE [dbo].[advsp_insertmediaactuals]
GO


CREATE PROCEDURE [dbo].[advsp_insertmediaactuals] ( @from_period int, @to_period int )
AS

SET ANSI_WARNINGS OFF

BEGIN
	SET NOCOUNT ON;


-- ======================================================================================
-- MAIN DATA TABLE - MEDIA ORDER DETAIL
-- ======================================================================================
DECLARE @MediaOrderDetail TABLE (
	[REC_TYPE]				varchar(20) COLLATE SQL_Latin1_General_CP1_CS_AS, 		
	[ORDER_NBR]				int NOT NULL,
	[LINE_NBR]				int NULL,
	[REV_NBR]				smallint NULL,
	[SEQ_NBR]				smallint NULL,
	[MONTH]					smallint NULL,
	[YEAR]					int NULL,
	[INSERT_DATE]			datetime NULL,
	[JOB_NUMBER]			int NULL,
	[JOB_COMPONENT_NBR]		smallint NULL,
	[BILLED_TYPE_FLAG]		smallint NULL, --various sources for different media types
	[LINE_CANCELLED]		smallint NULL,
	[NON_BILL_FLAG]			smallint NULL, 
	[RECONCILE_LINE]		smallint NULL,
	[DO_NOT_BILL]			smallint NULL,
	[EXT_NET_AMT]			decimal(15,2) NULL,
	[NETCHARGES]			decimal(15,2) NULL,
	[DISCOUNTS]				decimal(15,2) NULL,
	[ADDL_CHARGE]			decimal(15,2) NULL,
	[COMM_AMT]				decimal(15,2) NULL,
	[REBATE_AMT]			decimal(15,2) NULL,
	[NON_RESALE_TAX]		decimal(15,2) NULL,
	[STATE_AMT]				decimal(15,2) NULL,
	[COUNTY_AMT]			decimal(15,2) NULL,
	[CITY_AMT]				decimal(15,2) NULL,
	[LINE_TOTAL]			decimal(15,2) NULL,
	[BILLING_AMT]			decimal(15,2) NULL)

-- ===============================================================================
-- MAIN TABLE DATA - MEDIA DETAIL
-- ===============================================================================
-- INTERNET, MAGAZINE, NEWSPAPER, OUTDOOR ORDERED AMOUNTS
-- ======================================================
-- Magazine Order Amounts
INSERT INTO @MediaOrderDetail
SELECT 'M' AS [REC_TYPE], 
	d.ORDER_NBR,
	d.LINE_NBR,
	d.REV_NBR,
	d.SEQ_NBR,
	MONTH(d.START_DATE) AS [MONTH],
	YEAR (d.START_DATE) AS [YEAR],
	d.START_DATE AS INSERT_DATE,
	d.JOB_NUMBER,
	d.JOB_COMPONENT_NBR,
	NULL AS BILLED_TYPE_FLAG,
	d.LINE_CANCELLED,
	d.NON_BILL_FLAG,
	0 AS RECONCILE_LINE,
	0 AS DO_NOT_BILL,
	ISNULL(d.EXT_NET_AMT,0) AS EXT_NET_AMT,
	ISNULL(d.NETCHARGE,0) AS NETCHARGES,
	ISNULL(d.DISCOUNT_AMT,0) AS DISCOUNTS,
	ISNULL(d.ADDL_CHARGE,0) AS ADDL_CHARGE,
	ISNULL(d.COMM_AMT,0) AS COMM_AMT,
	ISNULL(d.REBATE_AMT,0) AS REBATE_AMT,
	ISNULL(d.NON_RESALE_AMT,0) AS NON_RESALE_TAX,
	ISNULL(d.STATE_AMT,0) AS STATE_AMT,
	ISNULL(d.COUNTY_AMT,0) AS COUNTY_AMT,
	ISNULL(d.CITY_AMT,0) AS CITY_AMT,
	ISNULL(d.LINE_TOTAL,0) AS LINE_TOTAL,
	ISNULL(d.BILLING_AMT,0) AS BILLING_AMT
FROM dbo.MAGAZINE_DETAIL AS d
INNER JOIN dbo.V_MEDIA_ORDER_MAX_REV_SEQ AS m
	ON d.ORDER_NBR = m.ORDER_NBR
	AND d.LINE_NBR = m.LINE_NBR
	AND d.REV_NBR = m.MAX_REV
	AND d.SEQ_NBR = m.MAX_SEQ
WHERE ISNULL(d.LINE_CANCELLED,0) = 0
	AND YEAR(d.START_DATE) * 100 + MONTH(d.START_DATE) BETWEEN @from_period AND @to_period

-- Newspaper Order Amounts
INSERT INTO @MediaOrderDetail
SELECT 'N' AS [REC_TYPE], 
	d.ORDER_NBR,
	d.LINE_NBR,
	d.REV_NBR,
	d.SEQ_NBR,
	MONTH(d.START_DATE) AS [MONTH],
	YEAR (d.START_DATE) AS [YEAR],
	d.START_DATE AS INSERT_DATE,
	d.JOB_NUMBER,
	d.JOB_COMPONENT_NBR,
	NULL AS BILLED_TYPE_FLAG,
	d.LINE_CANCELLED,
	d.NON_BILL_FLAG,
	0 AS RECONCILE_LINE,
	0 AS DO_NOT_BILL,
	ISNULL(d.EXT_NET_AMT,0) AS EXT_NET_AMT,
	ISNULL(d.NETCHARGE,0) AS NETCHARGES,
	ISNULL(d.DISCOUNT_AMT,0) AS DISCOUNTS,
	ISNULL(d.ADDL_CHARGE,0) AS ADDL_CHARGE,
	ISNULL(d.COMM_AMT,0) AS COMM_AMT,
	ISNULL(d.REBATE_AMT,0) AS REBATE_AMT,
	ISNULL(d.NON_RESALE_AMT,0) AS NON_RESALE_TAX,
	ISNULL(d.STATE_AMT,0) AS STATE_AMT,
	ISNULL(d.COUNTY_AMT,0) AS COUNTY_AMT,
	ISNULL(d.CITY_AMT,0) AS CITY_AMT,
	ISNULL(d.LINE_TOTAL,0) AS LINE_TOTAL,
	ISNULL(d.BILLING_AMT,0) AS BILLING_AMT
FROM dbo.NEWSPAPER_DETAIL AS d
INNER JOIN dbo.V_MEDIA_ORDER_MAX_REV_SEQ AS m
	ON d.ORDER_NBR = m.ORDER_NBR
	AND d.LINE_NBR = m.LINE_NBR
	AND d.REV_NBR = m.MAX_REV
	AND d.SEQ_NBR = m.MAX_SEQ
WHERE ISNULL(d.LINE_CANCELLED,0) = 0
	AND YEAR(d.START_DATE) * 100 + MONTH(d.START_DATE) BETWEEN @from_period AND @to_period

-- Internet Order Amounts
INSERT INTO @MediaOrderDetail
SELECT 'I' AS [REC_TYPE], 
	d.ORDER_NBR,
	d.LINE_NBR,
	d.REV_NBR,
	d.SEQ_NBR,
	MONTH(d.START_DATE) AS [MONTH],
	YEAR (d.START_DATE) AS [YEAR],
	d.START_DATE AS INSERT_DATE,
	d.JOB_NUMBER,
	d.JOB_COMPONENT_NBR,
	NULL AS BILLED_TYPE_FLAG,
	d.LINE_CANCELLED,
	d.NON_BILL_FLAG,
	0 AS RECONCILE_LINE,
	0 AS DO_NOT_BILL,
	ISNULL(d.EXT_NET_AMT,0) AS EXT_NET_AMT,
	ISNULL(d.NETCHARGE,0) AS NETCHARGES,
	ISNULL(d.DISCOUNT_AMT,0) AS DISCOUNTS,
	ISNULL(d.ADDL_CHARGE,0) AS ADDL_CHARGE,
	ISNULL(d.COMM_AMT,0) AS COMM_AMT,
	ISNULL(d.REBATE_AMT,0) AS REBATE_AMT,
	ISNULL(d.NON_RESALE_AMT,0) AS NON_RESALE_TAX,
	ISNULL(d.STATE_AMT,0) AS STATE_AMT,
	ISNULL(d.COUNTY_AMT,0) AS COUNTY_AMT,
	ISNULL(d.CITY_AMT,0) AS CITY_AMT,
	ISNULL(d.LINE_TOTAL,0) AS LINE_TOTAL,
	ISNULL(d.BILLING_AMT,0) AS BILLING_AMT
FROM dbo.INTERNET_DETAIL AS d
INNER JOIN dbo.V_MEDIA_ORDER_MAX_REV_SEQ AS m
	ON d.ORDER_NBR = m.ORDER_NBR
	AND d.LINE_NBR = m.LINE_NBR
	AND d.REV_NBR = m.MAX_REV
	AND d.SEQ_NBR = m.MAX_SEQ
WHERE ISNULL(d.LINE_CANCELLED,0) = 0
	AND YEAR(d.START_DATE) * 100 + MONTH(d.START_DATE) BETWEEN @from_period AND @to_period

-- Outdoor Order Amounts
INSERT INTO @MediaOrderDetail
SELECT 'O' AS [REC_TYPE], 
	d.ORDER_NBR,
	d.LINE_NBR,
	d.REV_NBR,
	d.SEQ_NBR,
	MONTH(d.POST_DATE) AS [MONTH],
	YEAR (d.POST_DATE) AS [YEAR],
	d.POST_DATE AS INSERT_DATE,
	d.JOB_NUMBER,
	d.JOB_COMPONENT_NBR,
	NULL AS BILLED_TYPE_FLAG,
	d.LINE_CANCELLED,
	d.NON_BILL_FLAG,
	0 AS RECONCILE_LINE,
	0 AS DO_NOT_BILL,
	ISNULL(d.EXT_NET_AMT,0) AS EXT_NET_AMT,
	ISNULL(d.NETCHARGE,0) AS NETCHARGES,
	ISNULL(d.DISCOUNT_AMT,0) AS DISCOUNTS,
	ISNULL(d.ADDL_CHARGE,0) AS ADDL_CHARGE,
	ISNULL(d.COMM_AMT,0) AS COMM_AMT,
	ISNULL(d.REBATE_AMT,0) AS REBATE_AMT,
	ISNULL(d.NON_RESALE_AMT,0) AS NON_RESALE_TAX,
	ISNULL(d.STATE_AMT,0) AS STATE_AMT,
	ISNULL(d.COUNTY_AMT,0) AS COUNTY_AMT,
	ISNULL(d.CITY_AMT,0) AS CITY_AMT,
	ISNULL(d.LINE_TOTAL,0) AS LINE_TOTAL,
	ISNULL(d.BILLING_AMT,0) AS BILLING_AMT
FROM dbo.OUTDOOR_DETAIL AS d
INNER JOIN dbo.V_MEDIA_ORDER_MAX_REV_SEQ AS m
	ON d.ORDER_NBR = m.ORDER_NBR
	AND d.LINE_NBR = m.LINE_NBR
	AND d.REV_NBR = m.MAX_REV
	AND d.SEQ_NBR = m.MAX_SEQ
WHERE ISNULL(d.LINE_CANCELLED,0) = 0
	AND YEAR(d.POST_DATE) * 100 + MONTH(d.POST_DATE) BETWEEN @from_period AND @to_period


-- RADIO, TV ORDERED LINE AMOUNTS
INSERT INTO @MediaOrderDetail
SELECT 'T' AS [REC_TYPE], 
	d.ORDER_NBR,
	d.LINE_NBR,
	d.REV_NBR,
	d.SEQ_NBR,
	MONTH_NBR AS [MONTH],
	YEAR_NBR AS [YEAR],
	d.START_DATE AS INSERT_DATE,
	d.JOB_NUMBER,
	d.JOB_COMPONENT_NBR,
	NULL AS BILLED_TYPE_FLAG,
	d.LINE_CANCELLED,
	d.NON_BILL_FLAG,
	0 AS RECONCILE_LINE,
	0 AS DO_NOT_BILL,
	ISNULL(d.EXT_NET_AMT,0) AS EXT_NET_AMT,
	ISNULL(d.NETCHARGE,0) AS NETCHARGES,
	ISNULL(d.DISCOUNT_AMT,0) AS DISCOUNTS,
	ISNULL(d.ADDL_CHARGE,0) AS ADDL_CHARGE,
	ISNULL(d.COMM_AMT,0) AS COMM_AMT,
	ISNULL(d.REBATE_AMT,0) AS REBATE_AMT,
	ISNULL(d.NON_RESALE_AMT,0) AS NON_RESALE_TAX,
	ISNULL(d.STATE_AMT,0) AS STATE_AMT,
	ISNULL(d.COUNTY_AMT,0) AS COUNTY_AMT,
	ISNULL(d.CITY_AMT,0) AS CITY_AMT,
	ISNULL(d.LINE_TOTAL,0) AS LINE_TOTAL,
	ISNULL(d.BILLING_AMT,0) AS BILLING_AMT
FROM dbo.TV_DETAIL AS d
INNER JOIN dbo.V_MEDIA_ORDER_MAX_REV_SEQ AS m
	ON d.ORDER_NBR = m.ORDER_NBR
	AND d.LINE_NBR = m.LINE_NBR
	AND d.REV_NBR = m.MAX_REV
	AND d.SEQ_NBR = m.MAX_SEQ
WHERE ISNULL(d.LINE_CANCELLED,0) = 0
	AND YEAR(d.START_DATE) * 100 + MONTH(d.START_DATE) BETWEEN @from_period AND @to_period

INSERT INTO @MediaOrderDetail
SELECT 'R' AS [REC_TYPE], 
	d.ORDER_NBR,
	d.LINE_NBR,
	d.REV_NBR,
	d.SEQ_NBR,
	MONTH_NBR AS [MONTH],
	YEAR_NBR AS [YEAR],
	d.START_DATE AS INSERT_DATE,
	d.JOB_NUMBER,
	d.JOB_COMPONENT_NBR,
	NULL AS BILLED_TYPE_FLAG,
	d.LINE_CANCELLED,
	d.NON_BILL_FLAG,
	0 AS RECONCILE_LINE,
	0 AS DO_NOT_BILL,
	ISNULL(d.EXT_NET_AMT,0) AS EXT_NET_AMT,
	ISNULL(d.NETCHARGE,0) AS NETCHARGES,
	ISNULL(d.DISCOUNT_AMT,0) AS DISCOUNTS,
	ISNULL(d.ADDL_CHARGE,0) AS ADDL_CHARGE,
	ISNULL(d.COMM_AMT,0) AS COMM_AMT,
	ISNULL(d.REBATE_AMT,0) AS REBATE_AMT,
	ISNULL(d.NON_RESALE_AMT,0) AS NON_RESALE_TAX,
	ISNULL(d.STATE_AMT,0) AS STATE_AMT,
	ISNULL(d.COUNTY_AMT,0) AS COUNTY_AMT,
	ISNULL(d.CITY_AMT,0) AS CITY_AMT,
	ISNULL(d.LINE_TOTAL,0) AS LINE_TOTAL,
	ISNULL(d.BILLING_AMT,0) AS BILLING_AMT
FROM dbo.RADIO_DETAIL AS d
INNER JOIN dbo.V_MEDIA_ORDER_MAX_REV_SEQ AS m
	ON d.ORDER_NBR = m.ORDER_NBR
	AND d.LINE_NBR = m.LINE_NBR
	AND d.REV_NBR = m.MAX_REV
	AND d.SEQ_NBR = m.MAX_SEQ
WHERE ISNULL(d.LINE_CANCELLED,0) = 0
	AND YEAR(d.START_DATE) * 100 + MONTH(d.START_DATE) BETWEEN @from_period AND @to_period


DECLARE @ACTUAL_MEDIA TABLE(
	OFFICE_CODE 	VARCHAR(4) COLLATE SQL_Latin1_General_CP1_CS_AS,
	CL_CODE 	VARCHAR(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	DIV_CODE 	VARCHAR(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	PRD_CODE 	VARCHAR(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	PPERIOD 	VARCHAR(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	JOB_NUMBER	  INTEGER,
	JOB_COMPONENT_NBR INTEGER,
	SC_CODE 	VARCHAR(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	NET_AMOUNT	DECIMAL(18,2),
	BILLING_AMT	DECIMAL(18,2)
)

INSERT INTO @ACTUAL_MEDIA (OFFICE_CODE, CL_CODE, DIV_CODE, PRD_CODE, PPERIOD, JOB_NUMBER, JOB_COMPONENT_NBR, SC_CODE, NET_AMOUNT, BILLING_AMT)
SELECT h.OFFICE_CODE,
	h.CL_CODE,
	h.DIV_CODE,
	h.PRD_CODE,
	d.[YEAR] * 100 + d.[MONTH] AS MONTH_YEAR,
	d.JOB_NUMBER,
	d.JOB_COMPONENT_NBR,
	h.MEDIA_TYPE,
	ISNULL(SUM(d.EXT_NET_AMT + d.NETCHARGES + d.DISCOUNTS + d.NON_RESALE_TAX),0) AS NET_AMOUNT,
	ISNULL(SUM(d.BILLING_AMT - d.STATE_AMT - d.COUNTY_AMT - d.CITY_AMT),0) AS BILLING_AMT
FROM @MediaOrderDetail AS d
INNER JOIN dbo.V_MEDIA_HDR2 AS h
	ON d.ORDER_NBR = h.ORDER_NBR

GROUP BY h.OFFICE_CODE, h.CL_CODE, h.DIV_CODE, h.PRD_CODE, d.[YEAR], d.[MONTH], d.JOB_NUMBER, d.JOB_COMPONENT_NBR, h.MEDIA_TYPE

/* 10/13/16- Changed BILL_PERIOD from '' to NULL */
--Insert into ACTUAL_ACC Table
INSERT INTO ACTUALS_ACC (CATEGORY_CODE, OFFICE_CODE, CL_CODE, DIV_CODE, PRD_CODE, PPERIOD, JOB_NUMBER, JOB_COMPONENT_NBR, ACTUALS_TYPE, SC_CODE, FNC_CODE, BILL_PERIOD, AMOUNT, ACTUAL_GRP)
SELECT 'cos', OFFICE_CODE, CL_CODE, DIV_CODE, PRD_CODE, PPERIOD, JOB_NUMBER, JOB_COMPONENT_NBR, 'M', SC_CODE, NULL, /* '' */ NULL, NET_AMOUNT, 3
FROM @ACTUAL_MEDIA

INSERT INTO ACTUALS_ACC (CATEGORY_CODE, OFFICE_CODE, CL_CODE, DIV_CODE, PRD_CODE, PPERIOD, JOB_NUMBER, JOB_COMPONENT_NBR, ACTUALS_TYPE, SC_CODE, FNC_CODE, BILL_PERIOD, AMOUNT, ACTUAL_GRP)
SELECT 'com', OFFICE_CODE, CL_CODE, DIV_CODE, PRD_CODE, PPERIOD, JOB_NUMBER, JOB_COMPONENT_NBR, 'M', SC_CODE, NULL, /* '' */ NULL, BILLING_AMT - NET_AMOUNT, 3
FROM @ACTUAL_MEDIA


/* OLD CODE */

/*
-- ================================================================================
-- Temp Table #MediaAmts
DECLARE @MediaAmts TABLE( 
	ORDER_NBR						int NULL, 
	LINE_NBR						smallint NULL, 
	REV_NBR							smallint NULL, 
	SEQ_NBR							smallint NULL, 
	LINE_NET						decimal(15,2) NULL, 
	COMM_AMT						decimal(15,2) NULL, 
	REBATE_AMT						decimal(15,2) NULL, 
	LINE_DISC						decimal(15,2) NULL, 
	VENDOR_TAX						decimal(15,2) NULL, 
	STATE_TAX						decimal(15,2) NULL, 
	COUNTY_TAX						decimal(15,2) NULL, 
	CITY_TAX						decimal(15,2) NULL, 
	SPOTS							smallint NULL, 
	BILL_AMT						decimal(15,2) NULL, 
	AR_INV_NBR						int NULL,
	MONTH_IND						tinyint NULL, 
	[MONTH]							varchar(3) COLLATE SQL_Latin1_General_CP1_CS_AS, 
	[YEAR]							int NULL, 
	MEDIA_TYPE						varchar(15) COLLATE SQL_Latin1_General_CP1_CS_AS, 
	RECONCILE_LINE					smallint NULL, 
	DO_NOT_BILL						smallint NULL, 
	BILL_TYPE_FLAG					smallint NULL,
	LINE_CANCELLED					smallint NULL)

-- Radio Amounts============================================
INSERT INTO @MediaAmts
SELECT d.ORDER_NBR,
	d.LINE_NBR,
	NULL AS REV_NBR,
	NULL AS SEQ_NBR,
	SUM(d.[LINE_NET]) AS [LINE_NET], 
	SUM(d.[COMM_AMT]) AS [COMM_AMT],
	SUM(d.[REBATE_AMT]) AS [REBATE_AMT],
	SUM(d.[DISCOUNT]) AS [LINE_DISC],
	SUM(d.[VENDOR_TAX]) AS [VENDOR_TAX],
	SUM(d.[STATE_TAX]) AS [STATE_TAX],
	SUM(d.[COUNTY_TAX]) AS [COUNTY_TAX],
	SUM(d.[CITY_TAX]) AS [CITY_TAX], 
	SUM(d.[SPOTS]) AS [SPOTS],
	SUM(d.[BILLING_AMT]) AS [BILL_AMT],
	d.AR_INV_NBR AS [AR_INV_NBR],
	d.MONTH_IND AS MONTH_IND, 
	d.MONTH_SHORT AS [MONTH], 
	d.BRDCAST_YEAR AS [YEAR],
	d.MEDIA_TYPE,
	d.RECONCILE_LINE,
	d.DO_NOT_BILL,
	NULL AS BILL_TYPE_FLAG,
	d.LINE_CANCELLED
FROM dbo.V_RADIO_DETAIL1 AS d 
WHERE d.BRDCAST_YEAR * 100 + d.MONTH_IND BETWEEN @from_period AND @to_period
GROUP BY d.ORDER_NBR, d.LINE_NBR, d.AR_INV_NBR, d.MONTH_IND, d.MONTH_SHORT, d.BRDCAST_YEAR, d.MEDIA_TYPE, d.RECONCILE_LINE, 
	d.DO_NOT_BILL, d.LINE_CANCELLED 
HAVING SUM(d.SPOTS)<>0

SELECT * FROM @MediaAmts

-- Television Amounts============================================
INSERT INTO @MediaAmts
SELECT d.ORDER_NBR,
	d.LINE_NBR,
	NULL AS REV_NBR,
	NULL AS SEQ_NBR,
	SUM(d.[LINE_NET]) AS [LINE_NET], 
	SUM(d.[COMM_AMT]) AS [COMM_AMT],
	SUM(d.[REBATE_AMT]) AS [REBATE_AMT],
	SUM(d.[DISCOUNT]) AS [LINE_DISC],
	SUM(d.[VENDOR_TAX]) AS [VENDOR_TAX],
	SUM(d.[STATE_TAX]) AS [STATE_TAX],
	SUM(d.[COUNTY_TAX]) AS [COUNTY_TAX],
	SUM(d.[CITY_TAX]) AS [CITY_TAX], 
	SUM(d.[SPOTS]) AS [SPOTS],
	SUM(d.[BILLING_AMT]) AS [BILL_AMT],
	d.AR_INV_NBR AS [AR_INV_NBR],
	d.MONTH_IND AS MONTH_IND, 
	d.MONTH_SHORT AS [MONTH], 
	d.BRDCAST_YEAR AS [YEAR],
	d.MEDIA_TYPE,
	d.RECONCILE_LINE,
	d.DO_NOT_BILL,
	NULL AS BILL_TYPE_FLAG,
	d.LINE_CANCELLED
FROM dbo.V_TV_DETAIL1 AS d 
WHERE d.BRDCAST_YEAR * 100 + d.MONTH_IND BETWEEN @from_period AND @to_period
GROUP BY d.ORDER_NBR, d.LINE_NBR, d.AR_INV_NBR, d.MONTH_IND, d.MONTH_SHORT, d.BRDCAST_YEAR, d.MEDIA_TYPE, d.RECONCILE_LINE, 
	d.DO_NOT_BILL, d.LINE_CANCELLED 
HAVING SUM(d.SPOTS)<>0

SELECT * FROM @MediaAmts

-- ====================================================================================================
-- Radio/TV Order Amounts
INSERT INTO @MediaOrderDetail
SELECT 'B_ORDER', --REC_TYPE
	ma.ORDER_NBR,
	ma.LINE_NBR, --LINE_NBR
	ma.REV_NBR,	--NULL
	ma.SEQ_NBR,	--NULL
	ma.MONTH_IND,
	ma.[YEAR],
	NULL AS INSERT_DATE,
	ms.JOB_NUMBER AS JOB_NUMBER,
	ms.JOB_COMPONENT_NBR AS JOB_COMPONENT_NBR,
	ma.BILL_TYPE_FLAG,
	ma.LINE_CANCELLED,
	0, --NON_BILL_FLAG	Added 8/7/08 - JR
	ma.RECONCILE_LINE,
	ma.DO_NOT_BILL,
	ma.LINE_NET,
	0, --NETCHARGES not in temp table
	ma.LINE_DISC,
	0, --ADDL CHARGE
	ma.COMM_AMT,
	ma.REBATE_AMT,
	ma.VENDOR_TAX,
	ma.STATE_TAX,
	ma.COUNTY_TAX,
	ma.CITY_TAX,
	ma.LINE_NET + ma.LINE_DISC + ma.COMM_AMT + ma.REBATE_AMT + ma.VENDOR_TAX + ma.STATE_TAX + ma.COUNTY_TAX + ma.CITY_TAX AS [LINE_TOTAL],
	ma.BILL_AMT
FROM @MediaAmts AS ma
INNER JOIN dbo.V_MEDIA_ORDER_MAX_REV_SEQ AS ms
	ON ma.ORDER_NBR = ms.ORDER_NBR
	AND ma.LINE_NBR = ms.LINE_NBR
	
*/



END
