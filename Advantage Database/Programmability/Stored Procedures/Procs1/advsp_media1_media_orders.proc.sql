--insert the next (3) statements at the top of the script while debugging
if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[advsp_media1_media_orders]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[advsp_media1_media_orders]
GO

CREATE PROCEDURE [dbo].[advsp_media1_media_orders] 
	@user_id varchar(100)

-- Stored procedure to extract MEDIA ORDER information
-- #00 08/28/14 - initial release
-- #01 09/06/14 - added newspaper other charges

AS
BEGIN
SET NOCOUNT ON;


 /* NOT USED IN .Net AT THIS POINT */

-- Identify the current Advantage user
IF ISNULL(@user_id, '') > '' BEGIN
	SET @user_id = UPPER(@user_id)
END
ELSE BEGIN
	SET @user_id = ''
	--SELECT @user_id = UPPER(dbo.78())
END

-- Used by extraction sprocs in (A) to get order data from MEDIA_RPT_ORDERS 
-- Note: extraction sprocs default to data for the active revision from the detail tables

--SELECT @user_id

-- ==========================================================
-- NEWSPAPER OTHER CHARGE TEMP TABLES										--#01
-- ==========================================================
-- Additional charges
CREATE TABLE #nspr_af_desc (
	ORDER_NBR					int NOT NULL,
	LINE_NBR					smallint NOT NULL,
	CHG_TYPE					varchar(3) COLLATE SQL_Latin1_General_CP1_CS_AS,
	NBR_ITEMS					smallint NOT NULL,
	CHG_DESC					varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS )
INSERT INTO #nspr_af_desc
SELECT
	ORDER_NBR,
	LINE_NBR,
	CHG_TYPE,
	COUNT(ORDER_NBR),
	MIN(CHG_DESC)
FROM dbo.NEWSPAPER_OTH_CHGS AS n
WHERE CHG_TYPE = 'AF'
GROUP BY ORDER_NBR, LINE_NBR, CHG_TYPE	
--SELECT * FROM #nspr_af_desc

-- Netcharges
CREATE TABLE #nspr_nc_desc (
	ORDER_NBR					int NOT NULL,
	LINE_NBR					smallint NOT NULL,
	CHG_TYPE					varchar(3) COLLATE SQL_Latin1_General_CP1_CS_AS,
	NBR_ITEMS					smallint NOT NULL,
	CHG_DESC					varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS )
INSERT INTO #nspr_nc_desc
SELECT
	ORDER_NBR,
	LINE_NBR,
	CHG_TYPE,
	COUNT(ORDER_NBR),
	MIN(CHG_DESC)
FROM dbo.NEWSPAPER_OTH_CHGS AS n
WHERE CHG_TYPE = 'NC'
GROUP BY ORDER_NBR, LINE_NBR, CHG_TYPE	
--SELECT * FROM #nspr_nc_desc

-- Rate charges
CREATE TABLE #nspr_rc_desc (
	ORDER_NBR					int NOT NULL,
	LINE_NBR					smallint NOT NULL,
	CHG_TYPE					varchar(3) COLLATE SQL_Latin1_General_CP1_CS_AS,
	NBR_ITEMS					smallint NOT NULL,
	CHG_DESC					varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS )
INSERT INTO #nspr_rc_desc
SELECT
	ORDER_NBR,
	LINE_NBR,
	CHG_TYPE,
	COUNT(ORDER_NBR),
	MIN(CHG_DESC)
FROM dbo.NEWSPAPER_OTH_CHGS AS n
WHERE CHG_TYPE = 'RC'
GROUP BY ORDER_NBR, LINE_NBR, CHG_TYPE	
--SELECT * FROM #nspr_rc_desc

-- ==========================================================
-- MAIN DATA TABLES
-- ==========================================================
-- #media_order_header
CREATE TABLE #media_order_header (
	ORDER_TYPE					varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	MEDIA_TYPE					varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,	
	ORDER_NBR					int NOT NULL,
	OFFICE_CODE					varchar(4) COLLATE SQL_Latin1_General_CP1_CS_AS,
	CL_CODE						varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	DIV_CODE					varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	PRD_CODE					varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	ORDER_DESC					varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS,
	VN_CODE						varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	VR_CODE						varchar(4) COLLATE SQL_Latin1_General_CP1_CS_AS,
	VR_CODE2					varchar(4) COLLATE SQL_Latin1_General_CP1_CS_AS,
	CMP_CODE					varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	CMP_IDENTIFIER				smallint NULL,
	CMP_NAME					varchar(128) COLLATE SQL_Latin1_General_CP1_CS_AS,
	--BILL_TYPE_FLAG				tinyint NULL,
	--POST_BILL					tinyint NULL,
	NET_GROSS					tinyint NULL,
	MARKET_CODE					varchar(10) COLLATE SQL_Latin1_General_CP1_CS_AS,
	MARKET_DESC					varchar(40) COLLATE SQL_Latin1_General_CP1_CS_AS,
	ORDER_DATE					smalldatetime NULL,
	REVISED_FLAG				smallint NULL,
	MODIFIED_DATE				smalldatetime NULL,
	FLIGHT_FROM					smalldatetime NULL,
	FLIGHT_TO					smalldatetime NULL,
	ORD_PROCESS_CONTRL			tinyint NULL,
	BUYER						varchar(40) COLLATE SQL_Latin1_General_CP1_CS_AS,
	CLIENT_PO					varchar(25) COLLATE SQL_Latin1_General_CP1_CS_AS,
	ORDER_ACCEPTED				tinyint NULL,
	BILL_COOP_CODE				varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	FISCAL_PERIOD_CODE			varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	ORDER_COMMENT				text,
	HOUSE_COMMENT				text,
	UNITS						varchar(2) COLLATE SQL_Latin1_General_CP1_CS_AS,
	LINK_ID						int NULL,
	CL_FOOTER					text)	
	
-- #media_order_detail
CREATE TABLE #media_order_detail(
	ORDER_TYPE						varchar(1) COLLATE SQL_Latin1_General_CP1_CS_AS,
	MEDIA_TYPE						varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS, 
	ORDER_NBR						int NOT NULL,
	LINE_NBR						smallint NULL,
	REV_NBR							smallint NULL,
	SEQ_NBR							smallint NULL,
	ACTIVE_REV						smallint NULL,
	[MONTH]							tinyint NULL,
	[YEAR]							smallint NULL,	
	EXT_CLOSE_DATE					smalldatetime NULL, 
	[START_DATE]					smalldatetime NULL,
	END_DATE						smalldatetime NULL, 
	DATE_TO_BILL					smalldatetime NULL, 
	CLOSE_DATE						smalldatetime NULL, 
	MATL_CLOSE_DATE					smalldatetime NULL, 
	EXT_MATL_DATE					smalldatetime NULL, 
	MAT_COMP						datetime NULL,
	SIZE_CODE						varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	EDITION_ISSUE					varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS,
	SECTION							varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS,
	MATERIAL						varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS,
	[SIZE]							varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS,
	PRODUCTION_SIZE					varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS,
	HEADLINE						varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS,
	PRINT_COLUMNS					decimal(6,2) NULL,
	PRINT_INCHES					decimal(6,2) NULL,
	PRINT_LINES						decimal(11,2) NULL,
	COST_TYPE						varchar(3) COLLATE SQL_Latin1_General_CP1_CS_AS,
	RATE_TYPE						varchar(3) COLLATE SQL_Latin1_General_CP1_CS_AS,
	PROJ_IMPRESSIONS				int NULL,
	GUARANTEED_IMPRESS				int NULL,
	ACT_IMPRESSIONS					int NULL,
	URL								varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS,
	TARGET_AUDIENCE					varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS,
	COPY_AREA						varchar(40) COLLATE SQL_Latin1_General_CP1_CS_AS,
	CREATIVE_SIZE					varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS,
	PLACEMENT_1						varchar(256) COLLATE SQL_Latin1_General_CP1_CS_AS,
	PLACEMENT_2						varchar(160) COLLATE SQL_Latin1_General_CP1_CS_AS,
	COST_RATE						decimal(16,4) NULL,
	NET_BASE_RATE					decimal(16,4) NULL,
	GROSS_BASE_RATE					decimal(16,4) NULL,
	SUB_TYPE						varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	SUB_TYPE_DESC					varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS,
	LOCATION						varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS,
	RATE_CARD						int NULL,
	RATE_DESC						varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS,
	CIRCULATION						int NULL,
	PRINT_QUANTITY					decimal(14,3) NULL,
	BLACKPLT_VER1					varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS,
	BLACKPLT_VER2					varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS,
	BUY_TYPE						varchar(12) COLLATE SQL_Latin1_General_CP1_CS_AS,
	DATE1							smalldatetime NULL,
	DATE2							smalldatetime NULL,
	DATE3							smalldatetime NULL,
	DATE4							smalldatetime NULL,
	DATE5							smalldatetime NULL,
	DATE6							smalldatetime NULL,
	DATE7							smalldatetime NULL,
	[DAYS]							varchar(20) COLLATE SQL_Latin1_General_CP1_CS_AS,
	SPOTS1							int NULL,
	SPOTS2							int NULL,
	SPOTS3							int NULL,
	SPOTS4							int NULL,
	SPOTS5							int NULL,
	SPOTS6							int NULL,
	SPOTS7							int NULL,
	TOTAL_SPOTS						smallint NULL,
	START_TIME						varchar(10) COLLATE SQL_Latin1_General_CP1_CS_AS,
	END_TIME						varchar(10) COLLATE SQL_Latin1_General_CP1_CS_AS,
	[LENGTH]						smallint NULL,
	PROGRAMMING						varchar(50) COLLATE SQL_Latin1_General_CP1_CS_AS,
	TAG								varchar(10) COLLATE SQL_Latin1_General_CP1_CS_AS,
	REMARKS							varchar(254) COLLATE SQL_Latin1_General_CP1_CS_AS,
	JOB_NUMBER						int NULL,
	JOB_DESC						varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS,	 
	JOB_COMPONENT_NBR				smallint NULL, 
	JOB_COMP_DESC					varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS, 
	BILL_TYPE_FLAG					smallint NULL,
	LINE_CANCELLED					smallint NULL,
	NON_BILL_FLAG					smallint NULL,
	RECONCILE_LINE					smallint NULL,
	DO_NOT_BILL						smallint NULL,
	INSTRUCTIONS					text, 
	ORDER_COPY						text, 
	POSITION_INFO					text,
	RATE_INFO						text,
	CLOSE_INFO						text,
	MISC_INFO						text, 
	MATL_NOTES						text, 
	IN_HOUSE_CMTS					text,
	AD_NUMBER						varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS,
	AD_NBR_DESC						varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS,
	RATE							decimal(16,4) NULL,
	NET_RATE						decimal(16,4) NULL,
	GROSS_RATE						decimal(16,4) NULL,
	FLAT_NET						decimal(15,4) NULL, 
	FLAT_GROSS						decimal(15,4) NULL, 
	EXT_NET_AMT						decimal(15,2) NULL,
	EXT_GROSS_AMT					decimal(15,2) NULL,
	COMM_AMT						decimal(15,2) NULL,
	REBATE_AMT						decimal(15,2) NULL,
	DISCOUNT_AMT					decimal(15,2) NULL,
	DISCOUNT_DESC					varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS,
	STATE_AMT						decimal(15,2) NULL,
	COUNTY_AMT						decimal(15,2) NULL,
	CITY_AMT						decimal(15,2) NULL,
	NON_RESALE_AMT					decimal(15,2) NULL,
	NETCHARGE						decimal(15,2) NULL,
	NETCHARGE_DESC					varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS,
	ADDL_CHARGE						decimal(15,2) NULL,
	ADDL_CHARGE_DESC				varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS,
	PROD_CHARGE						decimal(15,2) NULL,
	PROD_DESC						varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS,
	COLOR_CHARGE					decimal(15,3) NULL,
	COLOR_DESC						varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS,
	BLEED_PCT						decimal(7,3) NULL,
	BLEED_AMT						decimal(15,2) NULL,
	POSITION_PCT					decimal(7,3) NULL,
	POSITION_AMT					decimal(15,2) NULL,
	PREMIUM_PCT						decimal(7,3) NULL,
	PREMIUM_AMT						decimal(15,2) NULL,
	BILLING_AMT						decimal(15,2) NULL,
	LINE_TOTAL						decimal(15,2) NULL,
	--BILLING_USER					varchar(100) COLLATE SQL_Latin1_General_CP1_CS_AS,
	--AR_INV_NBR					int NULL,
	--AR_TYPE						varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS,
	--AR_INV_SEQ					smallint NULL,
	MARKUP_PCT						decimal(7,3) NULL, 
	COMM_PCT						decimal(7,3) NULL, 
	REBATE_PCT						decimal(7,3) NULL,
	EST_NBR							int NULL,
	EST_LINE_NBR					smallint NULL,
	EST_REV_NBR						smallint NULL)
	
-- ======================================================================
-- SECTION A - EXTRACTION ROUTINES USING EXISTING SPROCS LISTED BELOW
-- ======================================================================
--Header**********************************************************************************
--Print Header (dbo.advsp_media1_order_print_header)
CREATE TABLE #print_order_header(
	ORDER_TYPE						varchar(1) COLLATE SQL_Latin1_General_CP1_CS_AS,
	MEDIA_TYPE						varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	ORDER_NBR						int NOT NULL,
	ORDER_DATE						smalldatetime NULL,
	MODIFIED_DATE					smalldatetime NULL,
	REVISED_FLAG					smallint NULL,
	ORDER_DESC						varchar(40) COLLATE SQL_Latin1_General_CP1_CS_AS,
	LINK_ID							int NULL,
	OFFICE_CODE						varchar(4) COLLATE SQL_Latin1_General_CP1_CS_AS, 
	CL_CODE							varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS, 
	DIV_CODE						varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS, 
	PRD_CODE						varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	CMP_CODE						varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	CMP_IDENTIFIER					int NULL,
	NET_GROSS						smallint NULL,
	ORD_PROCESS_CONTRL				smallint NULL,
	MARKET_CODE						varchar(10) COLLATE SQL_Latin1_General_CP1_CS_AS,
	CLIENT_PO						varchar(25) COLLATE SQL_Latin1_General_CP1_CS_AS,
	CLIENT_REF						varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS,
	BUYER							varchar(40) COLLATE SQL_Latin1_General_CP1_CS_AS,
	VN_CODE							varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	PUB								smallint NULL,
	VR_CODE							varchar(4) COLLATE SQL_Latin1_General_CP1_CS_AS,
	REP1							smallint NULL,
	VR_CODE2						varchar(4) COLLATE SQL_Latin1_General_CP1_CS_AS,
	REP2							smallint NULL,
	ORDER_COMMENT					text,
	HOUSE_COMMENT					text,
	PRINTED							smallint NULL,
	FONT_SIZE						smallint NULL,
	CL_FOOTER						text,
	BILL_COOP_CODE					varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	FISCAL_PERIOD_CODE				varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	UNITS							varchar(2) COLLATE SQL_Latin1_General_CP1_CS_AS,
	ORDER_ACCEPTED					tinyint NULL)
INSERT INTO #print_order_header EXECUTE dbo.advsp_media1_order_print_header @user_id
--SELECT * FROM #print_order_header	

--Broadcast Header (new) (dbo.advsp_media1_order_bcst_header2)
CREATE TABLE #bcst_new_header(
	ORDER_TYPE						varchar(1) COLLATE SQL_Latin1_General_CP1_CS_AS,
	MEDIA_TYPE						varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	UNITS							varchar(2) COLLATE SQL_Latin1_General_CP1_CS_AS, 
	ORDER_NBR						int NOT NULL,
	MAX_REV							smallint NULL,
	LINK_ID							int NULL, 
	OFFICE_CODE						varchar(4) COLLATE SQL_Latin1_General_CP1_CS_AS,
	CL_CODE							varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	DIV_CODE						varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS, 
	PRD_CODE						varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS, 
	ORDER_DESC						varchar(40) COLLATE SQL_Latin1_General_CP1_CS_AS, 
	ORDER_DATE						smalldatetime NULL, 
	VN_CODE							varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS, 
	VR_CODE							varchar(4) COLLATE SQL_Latin1_General_CP1_CS_AS, 
	VR_CODE2						varchar(4) COLLATE SQL_Latin1_General_CP1_CS_AS,
	CMP_IDENTIFIER					int NULL,
	NET_GROSS						smallint NULL,
	MARKET_CODE						varchar(10) COLLATE SQL_Latin1_General_CP1_CS_AS,
	ORD_PROCESS_CONTRL				smallint NULL,
	STATION							smallint NULL,
	REP1							smallint NULL,
	REP2							smallint NULL,
	BUYER							varchar(40) COLLATE SQL_Latin1_General_CP1_CS_AS,  
	CLIENT_PO						varchar(25) COLLATE SQL_Latin1_General_CP1_CS_AS,
	ORDER_COMMENT					text,
	HOUSE_COMMENT					text,
	CREATE_DATE						smalldatetime NULL,
	[START_DATE]					smalldatetime NULL,
	END_DATE						smalldatetime NULL,
	FONT_SIZE						smallint NULL,
	CL_FOOTER						text,
	BILL_COOP_CODE					varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	FISCAL_PERIOD_CODE				varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	ORDER_ACCEPTED					tinyint NULL)
INSERT INTO #bcst_new_header EXECUTE dbo.advsp_media1_order_bcst_header2 @user_id
--SELECT * FROM #bcst_new_header

--Detail********************************************************************************
--Print detail (dbo.advsp_media1_order_print_detail)
CREATE TABLE #print_detail(
	ORDER_TYPE						varchar(1) COLLATE SQL_Latin1_General_CP1_CS_AS,
	MEDIA_TYPE						varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS, 
	ORDER_NBR						int NOT NULL,
	LINE_NBR						smallint NULL,
	REV_NBR							smallint NULL,
	SEQ_NBR							smallint NULL,
	ACTIVE_REV						smallint NULL,
	EXT_CLOSE_DATE					smalldatetime NULL, 
	[START_DATE]					smalldatetime NULL,
	END_DATE						smalldatetime NULL, 
	DATE_TO_BILL					smalldatetime NULL, 
	CLOSE_DATE						smalldatetime NULL, 
	MATL_CLOSE_DATE					smalldatetime NULL, 
	EXT_MATL_DATE					smalldatetime NULL, 
	MAT_COMP						datetime NULL,
	SIZE_CODE						varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	EDITION_ISSUE					varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS,
	SECTION							varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS,
	MATERIAL						varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS,
	[SIZE]							varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS,
	PRODUCTION_SIZE					varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS,
	HEADLINE						varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS,
	PRINT_COLUMNS					decimal(6,2) NULL,
	PRINT_INCHES					decimal(6,2) NULL,
	PRINT_LINES						decimal(11,2) NULL,
	COST_TYPE						varchar(3) COLLATE SQL_Latin1_General_CP1_CS_AS,
	RATE_TYPE						varchar(3) COLLATE SQL_Latin1_General_CP1_CS_AS,
	PROJ_IMPRESSIONS				int NULL,
	GUARANTEED_IMPRESS				int NULL,
	ACT_IMPRESSIONS					int NULL,
	URL								varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS,
	TARGET_AUDIENCE					varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS,
	COPY_AREA						varchar(40) COLLATE SQL_Latin1_General_CP1_CS_AS,
	CREATIVE_SIZE					varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS,
	PLACEMENT_1						varchar(256) COLLATE SQL_Latin1_General_CP1_CS_AS,
	PLACEMENT_2						varchar(160) COLLATE SQL_Latin1_General_CP1_CS_AS,
	COST_RATE						decimal(16,4) NULL,
	NET_BASE_RATE					decimal(16,4) NULL,
	GROSS_BASE_RATE					decimal(16,4) NULL,
	SUB_TYPE						varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	SUB_TYPE_DESC					varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS,
	LOCATION						varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS,
	RATE_CARD						int NULL,
	RATE_DESC						varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS,
	JOB_NUMBER						int NULL,
	JOB_DESC						varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS,	 
	JOB_COMPONENT_NBR				smallint NULL, 
	JOB_COMP_DESC					varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS, 
	BILL_TYPE_FLAG					smallint NULL,
	LINE_CANCELLED					smallint NULL,
	NON_BILL_FLAG					smallint NULL,
	RECONCILE_LINE					smallint NULL,
	DO_NOT_BILL						smallint NULL,
	INSTRUCTIONS					text, 
	ORDER_COPY						text, 
	POSITION_INFO					text,
	RATE_INFO						text,
	CLOSE_INFO						text,
	MISC_INFO						text, 
	MATL_NOTES						text, 
	IN_HOUSE_CMTS					text,
	AD_NUMBER						varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS,
	AD_NBR_DESC						varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS,
	PRINTED							smallint NULL,
	RATE							decimal(16,4) NULL,
	NET_RATE						decimal(16,4) NULL,
	GROSS_RATE						decimal(16,4) NULL,
	FLAT_NET						decimal(15,4) NULL, 
	FLAT_GROSS						decimal(15,4) NULL, 
	EXT_NET_AMT						decimal(15,2) NULL,
	EXT_GROSS_AMT					decimal(15,2) NULL,
	COMM_AMT						decimal(15,2) NULL,
	REBATE_AMT						decimal(15,2) NULL,
	DISCOUNT_AMT					decimal(15,2) NULL,
	DISCOUNT_DESC					varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS,
	STATE_AMT						decimal(15,2) NULL,
	COUNTY_AMT						decimal(15,2) NULL,
	CITY_AMT						decimal(15,2) NULL,
	NON_RESALE_AMT					decimal(15,2) NULL,
	NETCHARGE						decimal(15,2) NULL,
	NETCHARGE_DESC					varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS,
	ADDL_CHARGE						decimal(15,2) NULL,
	ADDL_CHARGE_DESC				varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS,
	PROD_CHARGE						decimal(15,2) NULL,
	PROD_DESC						varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS,
	COLOR_CHARGE					decimal(15,3) NULL,
	COLOR_DESC						varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS,
	BLEED_PCT						decimal(7,3) NULL,
	BLEED_AMT						decimal(15,2) NULL,
	POSITION_PCT					decimal(7,3) NULL,
	POSITION_AMT					decimal(15,2) NULL,
	PREMIUM_PCT						decimal(7,3) NULL,
	PREMIUM_AMT						decimal(15,2) NULL,
	BILLING_AMT						decimal(15,2) NULL,
	LINE_TOTAL						decimal(15,2) NULL,
	BILLING_USER					varchar(100) COLLATE SQL_Latin1_General_CP1_CS_AS,
	AR_INV_NBR						int NULL,
	AR_TYPE							varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS,
	AR_INV_SEQ						smallint NULL,
	MARKUP_PCT						decimal(7,3) NULL, 
	COMM_PCT						decimal(7,3) NULL, 
	REBATE_PCT						decimal(7,3) NULL,
	EST_NBR							int NULL,
	EST_LINE_NBR					smallint NULL,
	EST_REV_NBR						smallint NULL,
	CIRCULATION						int NULL,
	PRINT_QUANTITY					decimal(14,3) NULL,
	BLACKPLT_VER1					varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS,
	BLACKPLT_VER2					varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS)
 INSERT INTO #print_detail EXECUTE dbo.advsp_media1_order_print_detail @user_id 
 --SELECT * FROM #print_detail  

--Broadcast detail (new) (dbo.advsp_media1_order_bcst_detail2)
CREATE TABLE #bcst_new_detail(
	ORDER_TYPE						varchar(1) COLLATE SQL_Latin1_General_CP1_CS_AS,
	ORDER_NBR						int NOT NULL, 
	LINE_NBR						smallint NULL,
	REV_NBR							smallint NULL,
	SEQ_NBR							smallint NULL, 
	ACTIVE_REV						smallint NULL,
	BUY_TYPE						varchar(12) COLLATE SQL_Latin1_General_CP1_CS_AS,
	[START_DATE]					smalldatetime NULL,
	END_DATE						smalldatetime NULL,
	MONTH_NBR						smallint NULL,
	YEAR_NBR						smallint NULL,
	DATE1							smalldatetime NULL,
	DATE2							smalldatetime NULL,
	DATE3							smalldatetime NULL,
	DATE4							smalldatetime NULL,
	DATE5							smalldatetime NULL,
	DATE6							smalldatetime NULL,
	DATE7							smalldatetime NULL,
	[DAYS]							varchar(20) COLLATE SQL_Latin1_General_CP1_CS_AS,
	SPOTS1							int NULL,
	SPOTS2							int NULL,
	SPOTS3							int NULL,
	SPOTS4							int NULL,
	SPOTS5							int NULL,
	SPOTS6							int NULL,
	SPOTS7							int NULL,
	TOTAL_SPOTS						int NULL,
	JOB_NUMBER						int NULL,
	JOB_COMPONENT_NBR				smallint NULL,
	START_TIME						varchar(10) COLLATE SQL_Latin1_General_CP1_CS_AS, 
	END_TIME						varchar(10) COLLATE SQL_Latin1_General_CP1_CS_AS, 
	[LENGTH]						smallint NULL,
	CLOSE_DATE						smalldatetime NULL,
	MATL_CLOSE_DATE					smalldatetime NULL,   
	MAT_COMP						smalldatetime NULL,   
	AD_NUMBER						varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS,
	PROGRAMMING						varchar(50) COLLATE SQL_Latin1_General_CP1_CS_AS,
	TAG								varchar(10) COLLATE SQL_Latin1_General_CP1_CS_AS, 
	REMARKS							varchar(254) COLLATE SQL_Latin1_General_CP1_CS_AS,
	RATE							decimal(16,4) NULL,
	GROSS_RATE						decimal(16,4) NULL,
	NET_RATE						decimal(16,4) NULL,
	EXT_NET_AMT						decimal(15,2) NULL,
	EXT_GROSS_AMT					decimal(15,2) NULL,
	COMM_AMT						decimal(15,2) NULL,
	REBATE_AMT						decimal(15,2) NULL,
	DISCOUNT_AMT					decimal(15,2) NULL,
	DISCOUNT_DESC					varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS,
	STATE_AMT						decimal(15,2) NULL,
	COUNTY_AMT						decimal(15,2) NULL,
	CITY_AMT						decimal(15,2) NULL,
	NON_RESALE_AMT					decimal(15,2) NULL,
	NETCHARGE						decimal(16,4) NULL,
	NCDESC							varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS,
	ADDL_CHARGE						decimal(14,2) NULL,
	ADDL_CHARGE_DESC				varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS,
	LINE_TOTAL						decimal(15,2) NULL,
	BILLING_AMT						decimal(15,2) NULL,
	BILL_TYPE_FLAG					smallint NULL,
	LINE_CANCELLED					smallint NULL,
	NON_BILL_FLAG					smallint NULL,
	RECONCILE_FLAG					smallint NULL,
	DATE_TO_BILL					smalldatetime,
	BILLING_USER					varchar(100) COLLATE SQL_Latin1_General_CP1_CS_AS,
	AR_INV_NBR						int NULL,
	AR_TYPE							varchar(2) COLLATE SQL_Latin1_General_CP1_CS_AS,
	AR_INV_SEQ						smallint NULL,
	EST_NBR							int NULL,
	EST_LINE_NBR					smallint NULL,
	EST_REV_NBR						smallint NULL)
INSERT INTO #bcst_new_detail EXECUTE dbo.advsp_media1_order_bcst_detail2 @user_id
--SELECT * FROM #bcst_new_detail

--Broadcast comments (new) (dbo.advsp_media1_order_bcst_detail2)
CREATE TABLE #bcst_new_comments(
	ORDER_NBR						int NOT NULL, 
	LINE_NBR						smallint NULL,
	INSTRUCTIONS					text,
	ORDER_COPY						text,
	MATL_NOTES						text,
	POSITION_INFO					text, 
	CLOSE_INFO						text, 
	RATE_INFO						text, 
	MISC_INFO						text, 
	IN_HOUSE_CMTS					text)
INSERT INTO #bcst_new_comments EXECUTE dbo.advsp_media1_order_bcst_comments2 @user_id
--SELECT * FROM #bcst_new_comments

-- ==========================================================
-- SECTION B - POPULATE MEDIA ORDER HEADER TABLE #media_order_header
-- ==========================================================
--Print header------------------------------------------------------
INSERT INTO #media_order_header
SELECT
	h.ORDER_TYPE,
	h.MEDIA_TYPE,
	h.ORDER_NBR,
	h.OFFICE_CODE,
	h.CL_CODE,
	h.DIV_CODE,
	h.PRD_CODE,
	h.ORDER_DESC,
	h.VN_CODE,
	h.VR_CODE,
	h.VR_CODE2,
	c.CMP_CODE,
	h.CMP_IDENTIFIER,
	c.CMP_NAME,
	--CASE
	--	WHEN p.PRD_MAG_COM_ONLY = 1 THEN 1
	--	WHEN p.PRD_MAG_BILL_NET = 1 THEN 2
	--	ELSE 3
	--END,
	--ISNULL(p.PRD_MAG_PRE_POST,0),
	h.NET_GROSS,
	h.MARKET_CODE,
	m.MARKET_DESC,
	h.ORDER_DATE,
	h.REVISED_FLAG,
	h.MODIFIED_DATE,
	NULL,
	NULL,
	h.ORD_PROCESS_CONTRL,
	h.BUYER,
	h.CLIENT_PO,
	h.ORDER_ACCEPTED,
	h.BILL_COOP_CODE,
	h.FISCAL_PERIOD_CODE,
	h.ORDER_COMMENT,
	h.HOUSE_COMMENT,
	h.UNITS,
	h.LINK_ID,
	h.CL_FOOTER									
FROM #print_order_header AS h
JOIN dbo.PRODUCT AS p
	ON h.CL_CODE = p.CL_CODE
	AND h.DIV_CODE = p.DIV_CODE
	AND h.PRD_CODE = p.PRD_CODE
LEFT JOIN dbo.CAMPAIGN AS c
	ON h.CMP_IDENTIFIER = c.CMP_IDENTIFIER
LEFT JOIN dbo.MARKET AS m
	ON h.MARKET_CODE = m.MARKET_CODE
--SELECT * FROM #print_order_header

--Broadcast header (new)------------------------------------------------------
INSERT INTO #media_order_header
SELECT	
	h.ORDER_TYPE,
	h.MEDIA_TYPE,
	h.ORDER_NBR,
	h.OFFICE_CODE,
	h.CL_CODE,
	h.DIV_CODE,
	h.PRD_CODE,
	h.ORDER_DESC,
	h.VN_CODE,
	h.VR_CODE,
	h.VR_CODE2,
	c.CMP_CODE,
	h.CMP_IDENTIFIER,
	c.CMP_NAME,
	--CASE
	--	WHEN p.PRD_RADIO_COM_ONLY = 1 THEN 1
	--	WHEN p.PRD_RADIO_BILL_NET = 1 THEN 2
	--	ELSE 3
	--END,
	--ISNULL(p.PRD_RADIO_PRE_POST,0),
	h.NET_GROSS,
	h.MARKET_CODE,
	m.MARKET_DESC,
	h.ORDER_DATE,
	NULL,								--h.REVISED_FLAG,
	NULL,								--h.MODIFIED_DATE,
	h.[START_DATE],
	h.END_DATE,
	h.ORD_PROCESS_CONTRL,
	h.BUYER,
	h.CLIENT_PO,
	h.ORDER_ACCEPTED,
	h.BILL_COOP_CODE,
	h.FISCAL_PERIOD_CODE,	
	h.ORDER_COMMENT,
	h.HOUSE_COMMENT,
	h.UNITS,
	h.LINK_ID,
	h.CL_FOOTER		
FROM #bcst_new_header AS h
JOIN dbo.PRODUCT AS p
	ON h.CL_CODE = p.CL_CODE
	AND h.DIV_CODE = p.DIV_CODE
	AND h.PRD_CODE = p.PRD_CODE
LEFT JOIN dbo.CAMPAIGN AS c
	ON h.CMP_IDENTIFIER = c.CMP_IDENTIFIER
LEFT JOIN dbo.MARKET AS m
	ON h.MARKET_CODE = m.MARKET_CODE
--SELECT * FROM #media_order_header
-- END OF SECTION B			

-- ==========================================================
-- SECTION C - POPULATE MEDIA ORDER DETAIL TABLE #media_order_detail
-- ==========================================================
--Print detail------------------------------------------------------
INSERT INTO #media_order_detail
SELECT
	d.ORDER_TYPE,
	d.MEDIA_TYPE,
	d.ORDER_NBR,
	d.LINE_NBR,
	d.REV_NBR,
	d.SEQ_NBR,
	d.ACTIVE_REV,
	MONTH(d.[START_DATE]),
	YEAR(d.[START_DATE]),
	d.EXT_CLOSE_DATE,
	d.[START_DATE],							
	d.END_DATE,									
	d.DATE_TO_BILL,
	d.CLOSE_DATE,
	d.MATL_CLOSE_DATE,
	d.EXT_MATL_DATE,
	d.MAT_COMP,
	d.SIZE_CODE,
	d.EDITION_ISSUE,
	d.SECTION,
	d.MATERIAL,
	d.SIZE,										
	d.PRODUCTION_SIZE,
	d.HEADLINE,
	d.PRINT_COLUMNS,
	d.PRINT_INCHES,
	d.PRINT_LINES,
	d.COST_TYPE,
	d.RATE_TYPE,			
	d.PROJ_IMPRESSIONS,	
	d.GUARANTEED_IMPRESS,
	d.ACT_IMPRESSIONS,
	d.URL,										
	d.TARGET_AUDIENCE,
	d.COPY_AREA,
	d.CREATIVE_SIZE,
	d.PLACEMENT_1,
	d.PLACEMENT_2,
	d.COST_RATE,
	d.NET_BASE_RATE,
	d.GROSS_BASE_RATE,	
	d.SUB_TYPE,
	d.SUB_TYPE_DESC,
	d.LOCATION,
	d.RATE_CARD,			
	d.RATE_DESC,
	d.CIRCULATION,
	d.PRINT_QUANTITY,
	d.BLACKPLT_VER1,
	d.BLACKPLT_VER2,		
	NULL,					--d.BUY_TYPE,
	NULL,					--d.DATE1,
	NULL,					--d.DATE2,
	NULL,					--d.DATE3,
	NULL,					--d.DATE4,
	NULL,					--d.DATE5,
	NULL,					--d.DATE6,
	NULL,					--d.DATE7,
	NULL,					--d.[DAYS],
	NULL,					--d.SPOTS1,
	NULL,					--d.SPOTS2,
	NULL,					--d.SPOTS3,
	NULL,					--d.SPOTS4,
	NULL,					--d.SPOTS5,
	NULL,					--d.SPOTS6,
	NULL,					--d.SPOTS7,
	NULL,					--d.START_TIME,
	NULL,					--d.END_TIME,
	NULL,					--d.[LENGTH],
	NULL,					--d.PROGRAMMING,
	NULL,					--d.TAG,
	NULL,					--d.REMARKS,
	NULL,					--d.TOTAL_SPOTS,		
	d.JOB_NUMBER,
	d.JOB_DESC,
	d.JOB_COMPONENT_NBR,
	d.JOB_COMP_DESC,
	d.BILL_TYPE_FLAG,
	d.LINE_CANCELLED,
	d.NON_BILL_FLAG,
	d.RECONCILE_LINE,
	d.DO_NOT_BILL,
	d.INSTRUCTIONS,
	d.ORDER_COPY,
	d.POSITION_INFO,
	d.RATE_INFO,
	d.CLOSE_INFO,
	d.MISC_INFO,	
	d.MATL_NOTES,
	d.IN_HOUSE_CMTS,
	d.AD_NUMBER,
	d.AD_NBR_DESC,
	--d.PRINTED,
	d.RATE,
	d.NET_RATE,
	d.GROSS_RATE,
	d.FLAT_NET,
	d.FLAT_GROSS,
	d.EXT_NET_AMT,
	d.EXT_GROSS_AMT,
	d.COMM_AMT,
	d.REBATE_AMT,
	d.DISCOUNT_AMT,
	d.DISCOUNT_DESC,
	d.STATE_AMT,
	d.COUNTY_AMT,
	d.CITY_AMT,
	d.NON_RESALE_AMT,
	d.NETCHARGE,
	--d.NETCHARGE_DESC,
	CASE 
		WHEN n.NBR_ITEMS = 1 THEN ISNULL(n.CHG_DESC, 'Various Net Charges')			--#01
		WHEN n.NBR_ITEMS > 1 THEN 'Various Net Charges'
		ELSE NULL
	END,	
	d.ADDL_CHARGE,
	--d.ADDL_CHARGE_DESC,
	CASE
		WHEN a.NBR_ITEMS = 1 THEN ISNULL(a.CHG_DESC, 'Various Fee Charges')			--#01
		WHEN a.NBR_ITEMS > 1 THEN 'Various Fee Charges'
		ELSE NULL
	END,	
	d.PROD_CHARGE,
	d.PROD_DESC,
	d.COLOR_CHARGE,
	--d.COLOR_DESC,
	CASE
		WHEN r.NBR_ITEMS = 1 THEN ISNULL(r.CHG_DESC, 'Various Rate Charges')		--#01
		WHEN r.NBR_ITEMS > 1 THEN 'Various Rate Charges'
		ELSE NULL
	END,	
	d.BLEED_PCT,
	d.BLEED_AMT,
	d.POSITION_PCT,
	d.POSITION_AMT,
	d.PREMIUM_PCT,
	d.PREMIUM_AMT,
	d.BILLING_AMT,
	d.LINE_TOTAL,
	--d.BILLING_USER,
	--d.AR_INV_NBR,
	--d.AR_TYPE,
	--d.AR_INV_SEQ,
	d.MARKUP_PCT,
	d.COMM_PCT,
	d.REBATE_PCT,
	d.EST_NBR,
	d.EST_LINE_NBR,
	d.EST_REV_NBR										
FROM #print_detail AS d
LEFT JOIN #nspr_af_desc AS a
	ON d.ORDER_NBR = a.ORDER_NBR
	AND d.LINE_NBR = a.LINE_NBR
LEFT JOIN #nspr_nc_desc AS n
	ON d.ORDER_NBR = n.ORDER_NBR
	AND d.LINE_NBR = n.LINE_NBR
LEFT JOIN #nspr_rc_desc AS r
	ON d.ORDER_NBR = r.ORDER_NBR
	AND d.LINE_NBR = r.LINE_NBR 
	
--SELECT * FROM #media_order_detail

----Broadcast detail (new)------------------------------------------------------
INSERT INTO #media_order_detail
SELECT
	d.ORDER_TYPE,
	NULL,						--d.MEDIA_TYPE,
	d.ORDER_NBR,
	d.LINE_NBR,
	d.REV_NBR,
	d.SEQ_NBR,
	d.ACTIVE_REV,
	MONTH(d.[START_DATE]),		
	YEAR(d.[START_DATE]),		
	NULL,						--d.EXT_CLOSE_DATE,
	d.[START_DATE],							
	d.END_DATE,									
	d.DATE_TO_BILL,
	d.CLOSE_DATE,
	d.MATL_CLOSE_DATE,
	NULL,						--d.EXT_MATL_DATE,
	d.MAT_COMP,
	NULL,						--d.SIZE_CODE,
	NULL,						--d.EDITION_ISSUE,
	NULL,						--d.SECTION,
	NULL,						--d.MATERIAL,
	NULL,						--d.SIZE,										
	NULL,						--d.PRODUCTION_SIZE,
	NULL,						--d.HEADLINE,
	NULL,						--d.PRINT_COLUMNS,
	NULL,						--d.PRINT_INCHES,
	NULL,						--d.PRINT_LINES,
	NULL,						--d.COST_TYPE,
	NULL,						--d.RATE_TYPE,			
	NULL,						--d.PROJ_IMPRESSIONS,	
	NULL,						--d.GUARANTEED_IMPRESS,
	NULL,						--d.ACT_IMPRESSIONS,
	NULL,						--d.URL,										
	NULL,						--d.TARGET_AUDIENCE,
	NULL,						--d.COPY_AREA,
	NULL,						--d.CREATIVE_SIZE,
	NULL,						--d.PLACEMENT_1,
	NULL,						--d.PLACEMENT_2,
	NULL,						--d.COST_RATE,
	NULL,						--d.NET_BASE_RATE,
	NULL,						--d.GROSS_BASE_RATE,	
	NULL,						--d.SUB_TYPE,
	NULL,						--d.SUB_TYPE_DESC,
	NULL,						--d.LOCATION,
	NULL,						--d.RATE_CARD,			
	NULL,						--d.RATE_DESC,
	NULL,						--d.CIRCULATION,
	NULL,						--d.PRINT_QUANTITY,
	NULL,						--d.BLACKPLT_VER1,
	NULL,						--d.BLACKPLT_VER2,	
	d.BUY_TYPE,
	d.DATE1,
	d.DATE2,
	d.DATE3,
	d.DATE4,
	d.DATE5,
	d.DATE6,
	d.DATE7,
	d.[DAYS],
	d.SPOTS1,
	d.SPOTS2,
	d.SPOTS3,
	d.SPOTS4,
	d.SPOTS5,
	d.SPOTS6,
	d.SPOTS7,
	d.TOTAL_SPOTS,
	d.START_TIME,
	d.END_TIME,
	d.[LENGTH],
	d.PROGRAMMING,
	d.TAG,
	d.REMARKS,	
	d.JOB_NUMBER,
	j.JOB_DESC,
	d.JOB_COMPONENT_NBR,
	jc.JOB_COMP_DESC,
	d.BILL_TYPE_FLAG,
	d.LINE_CANCELLED,
	d.NON_BILL_FLAG,
	d.RECONCILE_FLAG,			--note diff name
	NULL,						--d.DO_NOT_BILL,
	c.INSTRUCTIONS,
	c.ORDER_COPY,
	c.POSITION_INFO,
	c.RATE_INFO,
	c.CLOSE_INFO,
	c.MISC_INFO,	
	c.MATL_NOTES,
	c.IN_HOUSE_CMTS,
	d.AD_NUMBER,
	an.AD_NBR_DESC,
	--d.PRINTED,
	d.RATE,
	d.NET_RATE,
	d.GROSS_RATE,
	NULL,						--d.FLAT_NET,
	NULL,						--d.FLAT_GROSS,
	d.EXT_NET_AMT,
	d.EXT_GROSS_AMT,
	d.COMM_AMT,
	d.REBATE_AMT,
	d.DISCOUNT_AMT,
	d.DISCOUNT_DESC,
	d.STATE_AMT,
	d.COUNTY_AMT,
	d.CITY_AMT,
	d.NON_RESALE_AMT,
	d.NETCHARGE,
	d.NCDESC,					--note diff name
	d.ADDL_CHARGE,
	d.ADDL_CHARGE_DESC,
	NULL,						--d.PROD_CHARGE,
	NULL,						--d.PROD_DESC,
	NULL,						--d.COLOR_CHARGE,
	NULL,						--d.COLOR_DESC,
	NULL,						--d.BLEED_PCT,
	NULL,						--d.BLEED_AMT,
	NULL,						--d.POSITION_PCT,
	NULL,						--d.POSITION_AMT,
	NULL,						--d.PREMIUM_PCT,
	NULL,						--d.PREMIUM_AMT,
	d.BILLING_AMT,
	d.LINE_TOTAL,
	--d.BILLING_USER,
	--d.AR_INV_NBR,
	--d.AR_TYPE,
	--d.AR_INV_SEQ,
	NULL,						--d.MARKUP_PCT,
	NULL,						--d.COMM_PCT,
	NULL,						--d.REBATE_PCT,
	d.EST_NBR,
	d.EST_LINE_NBR,
	d.EST_REV_NBR
FROM #bcst_new_detail AS d
LEFT JOIN #bcst_new_comments AS c
	ON d.ORDER_NBR = c.ORDER_NBR
	AND d.LINE_NBR = c.LINE_NBR	
LEFT JOIN dbo.JOB_LOG AS j
	ON d.JOB_NUMBER = j.JOB_NUMBER
LEFT JOIN dbo.JOB_COMPONENT AS jc
	ON d.JOB_NUMBER = jc.JOB_NUMBER
	AND d.JOB_COMPONENT_NBR = jc.JOB_COMPONENT_NBR
LEFT JOIN dbo.AD_NUMBER AS an
	ON d.AD_NUMBER = an.AD_NBR		
--SELECT * FROM #media_order_detail
-- END OF SECTION C

-- ==========================================================
-- SECTION D - LINK TEMP TABLES AND ADDRESS TABLES FOR COMPOSITE DATASET
-- ==========================================================
SELECT  
	[OrderType] = h.ORDER_TYPE,
	[MediaType] = h.MEDIA_TYPE, 
	[MediaTypeDescription] = sc.SC_DESCRIPTION, 
	[Units] = h.UNITS,
	[OrderNumber] = h.ORDER_NBR, 
	[OrderDescription] = h.ORDER_DESC, 
	[OfficeCode] = h.OFFICE_CODE, 
	[OfficeName] = o.OFFICE_NAME, 
	[ClientCode] = h.CL_CODE, 
	[ClientName] = cl.CL_NAME, 
	[DivisionCode] = h.DIV_CODE, 
	[DivisionName] = dv.DIV_NAME, 
	[ProductCode] = h.PRD_CODE, 
	[ProductDescription] = pr.PRD_DESCRIPTION, 
	[VendorCode] = h.VN_CODE, 
	[VendorName] = v.VN_NAME, 
	[VendorRepCode] = h.VR_CODE, 
	[VendorRepName] = vr1.VR_FIRM_NAME, 
	[VendorRepCode2] = h.VR_CODE2, 
	[VendorRepName2] = vr2.VR_FIRM_NAME, 
	[CampaignCode] = h.CMP_CODE, 
	[CampaignID] = h.CMP_IDENTIFIER, 
	[CampaignName] = h.CMP_NAME,  
	[NetGrossFlag] = h.NET_GROSS, 
	[MarketCode] = h.MARKET_CODE, 
	[MarketDescription] = h.MARKET_DESC,
	[OrderDate] = h.ORDER_DATE,
	[RevisionFlag] = h.REVISED_FLAG,  
	[ModifiedDate] = h.MODIFIED_DATE,
	[BcstOrderFlightFrom] = h.FLIGHT_FROM, 
	[BcstOrderFlightTo] = h.FLIGHT_TO, 
	[OrderProcessControl] = h.ORD_PROCESS_CONTRL, 
	[Buyer] = h.BUYER, 
	[ClientPO] = h.CLIENT_PO, 
	[LinkID] = h.LINK_ID, 
	[OrderAccepted] = h.ORDER_ACCEPTED,
	[BillingCoopCode] = h.BILL_COOP_CODE,
	[FiscalPeriodCode= h.FISCAL_PERIOD_CODE,   
	[OrderComment] = h.ORDER_COMMENT,
	[OrderHouseComment = h.HOUSE_COMMENT,
	[ClientFooterComment] = h.CL_FOOTER,
	[LineNumber] = d.LINE_NBR, 
	[LineRevisionNumber] = d.REV_NBR, 
	[LineSequenceNumber] = d.SEQ_NBR, 
	[ActiveRevision] = d.ACTIVE_REV, 
	[OrderPeriod] = d.[YEAR] * 100 + d.[MONTH], 
	[OrderMonth] = d.[MONTH], 
	[Orderyear] = d.[YEAR], 
	[InsertionDate] = d.[START_DATE], 
	[OrderEndDate] = d.END_DATE, 
	[DateToBill] = d.DATE_TO_BILL, 
	[CloseDate] = d.CLOSE_DATE, 
	[MaterialCloseDate] = d.MATL_CLOSE_DATE,
	[ExtendedCloseDate] = d.EXT_CLOSE_DATE,
	[ExtendedMatlCloseDate] = d.EXT_MATL_DATE,  
	[MaterialComposition] = d.MAT_COMP,
	[SizeCode] = d.SIZE_CODE,
	[AdSize] = d.SIZE, 
	[ProductionSize] = d.PRODUCTION_SIZE,
	[EditionIssue] = d.EDITION_ISSUE, 
	[Material] = d.MATERIAL, 
	[Headline] = d.HEADLINE,
	[NewspaperSection] = d.SECTION, 
	[NewspaperColumns] = d.PRINT_COLUMNS,
	[NewspaperInches] = d.PRINT_INCHES,
	[NewspaperLines] = d.PRINT_LINES,
	[NewspaperCostType] = d.COST_TYPE,
	[RateType] = d.RATE_TYPE,
	[ProjectedImpressions] = d.PROJ_IMPRESSIONS,
	[GuaranteedImpressions] = d.GUARANTEED_IMPRESS,
	[ActualImpressions] = d.ACT_IMPRESSIONS,
	[URL] = d.URL, 
	[TargetAudience] = d.TARGET_AUDIENCE,
	[CopyArea] = d.COPY_AREA,
	[CreativeSize] = d.CREATIVE_SIZE,
	[Placement1] = d.PLACEMENT_1,
	[Placement2] = d.PLACEMENT_2,
	[CostRate] = d.COST_RATE,
	[NetBaseRate] = d.NET_BASE_RATE,
	[GrossBaseRate] = d.GROSS_BASE_RATE,
	[SubType] = d.SUB_TYPE,
	[SubTypeDescription] = d.SUB_TYPE_DESC,
	[Location] = d.LOCATION,
	[RateCard] = d.RATE_CARD,
	[RateDescription] = d.RATE_DESC,
	[Circulation] = d.CIRCULATION,
	[PrintQuantity] = d.PRINT_QUANTITY,
	[BlackplateVersion1] = d.BLACKPLT_VER1,
	[BlackplateVersion2] = d.BLACKPLT_VER2,
	[BcstBuyType] = d.BUY_TYPE,
	[BcstDate1] = d.DATE1,
	[BcstDate2] = d.DATE2,
	[BcstDate3] = d.DATE3,
	[BcstDate4] = d.DATE4,
	[BcstDate5] = d.DATE5,
	[BcstDate6] = d.DATE6,
	[BcstDate7] = d.DATE7,
	[BcstDays] = d.[DAYS],
	[BcstSpots1] = d.SPOTS1,
	[BcstSpots2] = d.SPOTS2,
	[BcstSpots3] = d.SPOTS3,
	[BcstSpots4] = d.SPOTS4,
	[BcstSpots5] = d.SPOTS5,
	[BcstSpots6] = d.SPOTS6,
	[BcstSpots7] = d.SPOTS7,
	[BcstTotalSpots] = d.TOTAL_SPOTS,
	[BcstStartTime] = d.START_TIME,
	[BcstEndTime] = d.END_TIME,
	[BcstComLength] = d.[LENGTH],
	[BcstProgramName] = d.PROGRAMMING,
	[BcstTag] = d.TAG,
	[BcstRemarks] = d.REMARKS,
	[JobNumber] = d.JOB_NUMBER, 
	[JobDescription] = d.JOB_DESC, 
	[JobComponentNumber] = d.JOB_COMPONENT_NBR, 
	[JobComponentDescription] = d.JOB_COMP_DESC,
	[BillTypeFlag] = d.BILL_TYPE_FLAG,
	[LineCancelled] = d.LINE_CANCELLED,
	[NonBillableFlag] = d.NON_BILL_FLAG,
	--[ReconcileLineFlag] = d.RECONCILE_LINE,
	--[DoNotBill] = d.DO_NOT_BILL,
	[Instructions] = d.INSTRUCTIONS,
	[OrderCopy] = d.ORDER_COPY,
	[PositionInfo] = d.POSITION_INFO, 
	[RateInfo] = d.RATE_INFO,
	[CloseInfo] = d.CLOSE_INFO, 
	[MiscellaneousInfo] = d.MISC_INFO,
	[MaterialNotes] = d.MATL_NOTES,
	[InHouseComments] = d.IN_HOUSE_CMTS,
	[AdNumber] = d.AD_NUMBER,
	[AdNumberDescription] = d.AD_NBR_DESC,	
	[Rate] = d.RATE,
	[NetRate] = d.NET_RATE,
	[GrossRate] = d.GROSS_RATE,
	[FlatNetRate] = d.FLAT_NET,
	[FlatGrossRate] = d.FLAT_GROSS,
	[ExtendedNetAmount] = d.EXT_NET_AMT,
	[ExtendedGrossAmount] = d.EXT_GROSS_AMT,
	[CommissionAmount] = d.COMM_AMT, 
	[RebateAmount] = d.REBATE_AMT, 
	[DiscountAmount] = d.DISCOUNT_AMT,
	[DiscountDescription] = d.DISCOUNT_DESC,
	[StateResaleTaxAmount] = d.STATE_AMT,
	[CountyResaleTaxAmount] = d.COUNTY_AMT, 
	[CityResaleTaxAmount] = d.CITY_AMT,
	[TotalResaleTaxAmount] = d.STATE_AMT + d.COUNTY_AMT + d.CITY_AMT,  
	[VendorTaxAmount] = d.NON_RESALE_AMT, 
	[NetChargeAmount] = d.NETCHARGE,
	[NetChargeDescription] = d.NETCHARGE_DESC, 
	[AdditionalChargeAmount] = d.ADDL_CHARGE,
	[AdditionalChargeDesc] = d.ADDL_CHARGE_DESC,
	--[ProductionCharge] = d.PROD_CHARGE,
	--[ProductionChargeDesc] = d.PROD_DESC,
	[RateCharge] = d.COLOR_CHARGE,
	[RateChargeDesc] = d.COLOR_DESC,
	[BleedPercent] = d.BLEED_PCT,
	[BleedAmount] = d.BLEED_AMT,
	[PositionPercent] = d.POSITION_PCT,
	[PositionAmount] = d.POSITION_AMT,
	[PremiumPercent] = d.PREMIUM_PCT,
	[PremiumAmount] = d.PREMIUM_AMT,
	[LineTotalAmount] = d.LINE_TOTAL, 
	[BillAmount] = d.BILLING_AMT,	
	[MarkupPercent] = d.MARKUP_PCT,
	[CommissionPercent] = d.COMM_PCT,
	[RebatePercent] = d.REBATE_PCT,
	[EstimateNumber] = d.EST_NBR,
	[EstimateLineNumber] = d.EST_LINE_NBR,
	[EstimateRevisionNumber] = d.EST_REV_NBR,
	[VendorAddress1] = v.VN_ADDRESS1,
	[VendorAddress2] = v.VN_ADDRESS2,
	[VendorCityStateZip] = COALESCE((RTRIM(v.VN_CITY) + ' '),'') + COALESCE((v.VN_STATE + ', '),'') + COALESCE(v.VN_ZIP,''),
	[VendorCountry] = v.VN_COUNTRY,
	[VendorPhone] = v.VN_PHONE,
	[VendorPhoneExtension] = v.VN_PHONE_EXT,
	[VendorFax] = v.VN_FAX_NUMBER,
	[VendorFaxExtension] = v.VN_FAX_EXTENTION,
	[VendorEmail] = v.VN_EMAIL,
	[VendorTaxID] = v.VN_TAX_ID,	
	[VendorShippingName] = v.SHIP_NAME,
	[VendorShippingAddress1] = v.SHIP_ADDR1,
	[VendorShippingAddress2] = v.SHIP_ADDR2,
	[VendorShippingCityStateZip] = COALESCE((RTRIM(v.SHIP_CITY) + ' '),'') + COALESCE((v.SHIP_STATE + ', '),'') + COALESCE(v.SHIP_ZIP,''),
	[VendorShippingCountry] = v.SHIP_COUNTRY,
	[VendorShippingPhone] = v.SHIP_PHONE,
	[VendorShippingPhoneExt] = v.SHIP_PHONE_EXT,
	[VendorRep1ContactName] = COALESCE((RTRIM(vr1.VR_FNAME) + ' '),'') + COALESCE((vr1.VR_MI + '. '),'') + COALESCE(vr1.VR_LNAME,''),
	[VendorRep1FirmName] = vr1.VR_FIRM_NAME,
	[VendorRep1Address1] = vr1.VR_ADDRESS1,
	[VendorRep1Address2] = vr1.VR_ADDRESS2,
	[VendorRep1CityStateZip] = COALESCE((RTRIM(vr1.VR_CITY) + ' '),'') + COALESCE((vr1.VR_STATE + ', '),'') + COALESCE(vr1.VR_ZIP,''),
	[VendorRep1Country] = vr1.VR_COUNTRY,
	[VendorRep1Phone] = vr1.VR_TELEPHONE,
	[VendorRep1PhoneExt] = vr1.VR_EXTENTION,
	[VendorRep1Fax] = vr1.VR_FAX,
	[VendorRep1FaxExt] = vr1.VR_FAX_EXTENTION,
	[VendorRep1Email] = vr1.EMAIL_ADDRESS,
	[VendorRep2ContactName] = COALESCE((RTRIM(vr2.VR_FNAME) + ' '),'') + COALESCE((vr2.VR_MI + '. '),'') + COALESCE(vr2.VR_LNAME,''),
	[VendorRep2FirmName] = vr2.VR_FIRM_NAME,
	[VendorRep2Address1] = vr2.VR_ADDRESS1,
	[VendorRep2Address2] = vr2.VR_ADDRESS2,
	[VendorRep2CityStateZip] = COALESCE((RTRIM(vr2.VR_CITY) + ' '),'') + COALESCE((vr2.VR_STATE + ', '),'') + COALESCE(vr2.VR_ZIP,''),
	[VendorRep2Country] = vr2.VR_COUNTRY,
	[VendorRep2Phone] = vr2.VR_TELEPHONE,
	[VendorRep2PhoneExt] = vr1.VR_EXTENTION,
	[VendorRep2Fax] = vr2.VR_FAX,
	[VendorRep2FaxExt] = vr2.VR_FAX_EXTENTION,
	[VendorRep2Email] = vr2.EMAIL_ADDRESS		
FROM #media_order_header AS h
JOIN #media_order_detail AS d
	ON h.ORDER_NBR =d. ORDER_NBR
JOIN dbo.VENDOR AS v
	ON h.VN_CODE = v.VN_CODE
LEFT JOIN dbo.VEN_REP AS vr1
	ON h.VN_CODE = vr1.VN_CODE
	AND h.VR_CODE = vr1.VR_CODE
LEFT JOIN dbo.VEN_REP AS vr2
	ON h.VN_CODE = vr2.VN_CODE
	AND h.VR_CODE2 = vr2.VR_CODE
LEFT JOIN dbo.OFFICE AS o
	ON h.OFFICE_CODE = o.OFFICE_CODE	
JOIN dbo.CLIENT AS cl
	ON h.CL_CODE = cl.CL_CODE
JOIN dbo.DIVISION AS dv
	ON h.CL_CODE = dv.CL_CODE
	AND h.DIV_CODE = dv.DIV_CODE
JOIN dbo.PRODUCT AS pr
	ON h.CL_CODE = pr.CL_CODE
	AND h.DIV_CODE = pr.DIV_CODE
	AND h.PRD_CODE = pr.PRD_CODE
LEFT JOIN dbo.SALES_CLASS AS sc
	ON h.MEDIA_TYPE = sc.SC_CODE	

END


GO


