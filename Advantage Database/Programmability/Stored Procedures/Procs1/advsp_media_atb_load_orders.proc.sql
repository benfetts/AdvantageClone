CREATE PROCEDURE [dbo].[advsp_media_atb_load_orders]
@ATB_NUMBER INT = 0,
@DESCRIPTION VARCHAR(MAX) = '',
@CMP_IDENTIFIER INT = 0,
@CL_CODE VARCHAR(6) = '',
@DIV_CODE VARCHAR(6) = '',
@PRD_CODE VARCHAR(6) = '',
@SHOW_CLOSED BIT = 0, 
@USER_ID VARCHAR(100)
AS
BEGIN
	
	DECLARE @REVISIONS TABLE([ATBNumber] INT, 
							 [Description] VARCHAR(100),
							 [RevisionNumber] INT,
							 [CampaignID] INT,
							 [CampaignCode] VARCHAR(6),
							 [CampaignName] VARCHAR(128),
							 [ClientCode] VARCHAR(6),
							 [ClientName] VARCHAR(40),
							 [DivisionCode] VARCHAR(6),
							 [DivisionName] VARCHAR(40),
							 [ProductCode] VARCHAR(6),
							 [ProductDescription] VARCHAR(40),
							 [IsClosed] BIT)

	DECLARE @OfficeRestrictions AS INT;
	DECLARE @EMP_CODE AS VARCHAR(6);

	SELECT TOP 1 @EMP_CODE = EMP_CODE FROM [dbo].[SEC_USER] WHERE UPPER([USER_CODE]) = UPPER(@USER_ID);
	SELECT @OfficeRestrictions = COUNT(*) FROM EMP_OFFICE WHERE EMP_CODE = @EMP_CODE;

	IF EXISTS(SELECT * FROM dbo.SEC_CLIENT WHERE [USER_ID] = @USER_ID)
	BEGIN
		IF @OfficeRestrictions > 0
		BEGIN
			INSERT INTO @REVISIONS
			SELECT [ATBNumber] = ATB_HDR.ATB_NUMBER,
				   [Description] = ATB_REV.ATB_DESCRIPTION,
				   [RevisionNumber] = ATB_REV.REV_NBR,
				   [CampaignID] = ATB_REV.CMP_IDENTIFIER,
				   [CampaignCode] = CAMPAIGN.CMP_CODE,
				   [CampaignName] = CAMPAIGN.CMP_NAME,
				   [ClientCode] = ATB_HDR.CL_CODE,
				   [ClientName] = V_PRODUCT.CL_NAME,
				   [DivisionCode] = ATB_HDR.DIV_CODE,
				   [DivisionName] = V_PRODUCT.DIV_NAME,
				   [ProductCode] = ATB_HDR.PRD_CODE,
				   [ProductDescription] = V_PRODUCT.PRD_DESCRIPTION,
				   [IsClosed] = ISNULL(ATB_HDR.INACTIVE_FLAG, 0)
			FROM dbo.ATB_HDR
			INNER JOIN dbo.ATB_REV ON ATB_HDR.ATB_NUMBER = ATB_REV.ATB_NUMBER
			INNER JOIN dbo.SEC_CLIENT ON ATB_HDR.CL_CODE = SEC_CLIENT.CL_CODE AND
								   ATB_HDR.DIV_CODE = SEC_CLIENT.DIV_CODE AND
								   ATB_HDR.PRD_CODE = SEC_CLIENT.PRD_CODE
			INNER JOIN dbo.V_PRODUCT ON ATB_HDR.CL_CODE = V_PRODUCT.CL_CODE AND
								  ATB_HDR.DIV_CODE = V_PRODUCT.DIV_CODE AND
								  ATB_HDR.PRD_CODE = V_PRODUCT.PRD_CODE
			INNER JOIN dbo.EMP_OFFICE ON V_PRODUCT.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = @EMP_CODE
			LEFT OUTER JOIN dbo.CAMPAIGN ON ATB_REV.CMP_IDENTIFIER = CAMPAIGN.CMP_IDENTIFIER
			WHERE 1 = CASE WHEN @ATB_NUMBER <= 0 THEN 1 WHEN @ATB_NUMBER > 0 AND ATB_HDR.ATB_NUMBER = @ATB_NUMBER THEN 1 ELSE 0 END AND
				  1 = CASE WHEN @DESCRIPTION = '' THEN 1 WHEN UPPER(ATB_REV.ATB_DESCRIPTION) LIKE '%' + UPPER(@DESCRIPTION) + '%' THEN 1 ELSE 0 END AND
				  1 = CASE WHEN @CMP_IDENTIFIER <= 0 THEN 1 WHEN ATB_REV.CMP_IDENTIFIER = @CMP_IDENTIFIER THEN 1 ELSE 0 END AND
				  1 = CASE WHEN @CL_CODE = '' THEN 1 WHEN ATB_HDR.CL_CODE = @CL_CODE THEN 1 ELSE 0 END AND
				  1 = CASE WHEN @DIV_CODE = '' THEN 1 WHEN ATB_HDR.CL_CODE = @CL_CODE AND ATB_HDR.DIV_CODE = @DIV_CODE THEN 1 ELSE 0 END AND
				  1 = CASE WHEN @PRD_CODE = '' THEN 1 WHEN ATB_HDR.CL_CODE = @CL_CODE AND ATB_HDR.DIV_CODE = @DIV_CODE AND ATB_HDR.PRD_CODE = @PRD_CODE THEN 1 ELSE 0 END AND
				  1 = CASE WHEN @SHOW_CLOSED = 1 THEN 1 WHEN ISNULL(ATB_HDR.INACTIVE_FLAG, 0) = 0 THEN 1 ELSE 0 END
				  AND UPPER(SEC_CLIENT.USER_ID) = UPPER(@USER_ID)
				  AND (SEC_CLIENT.TIME_ENTRY = 0 OR SEC_CLIENT.TIME_ENTRY IS NULL)

		END
		ELSE
		BEGIN
			INSERT INTO @REVISIONS
			SELECT [ATBNumber] = ATB_HDR.ATB_NUMBER,
				   [Description] = ATB_REV.ATB_DESCRIPTION,
				   [RevisionNumber] = ATB_REV.REV_NBR,
				   [CampaignID] = ATB_REV.CMP_IDENTIFIER,
				   [CampaignCode] = CAMPAIGN.CMP_CODE,
				   [CampaignName] = CAMPAIGN.CMP_NAME,
				   [ClientCode] = ATB_HDR.CL_CODE,
				   [ClientName] = V_PRODUCT.CL_NAME,
				   [DivisionCode] = ATB_HDR.DIV_CODE,
				   [DivisionName] = V_PRODUCT.DIV_NAME,
				   [ProductCode] = ATB_HDR.PRD_CODE,
				   [ProductDescription] = V_PRODUCT.PRD_DESCRIPTION,
				   [IsClosed] = ISNULL(ATB_HDR.INACTIVE_FLAG, 0)
			FROM dbo.ATB_HDR
			INNER JOIN dbo.ATB_REV ON ATB_HDR.ATB_NUMBER = ATB_REV.ATB_NUMBER
			INNER JOIN dbo.SEC_CLIENT ON ATB_HDR.CL_CODE = SEC_CLIENT.CL_CODE AND
								   ATB_HDR.DIV_CODE = SEC_CLIENT.DIV_CODE AND
								   ATB_HDR.PRD_CODE = SEC_CLIENT.PRD_CODE
			INNER JOIN dbo.V_PRODUCT ON ATB_HDR.CL_CODE = V_PRODUCT.CL_CODE AND
								  ATB_HDR.DIV_CODE = V_PRODUCT.DIV_CODE AND
								  ATB_HDR.PRD_CODE = V_PRODUCT.PRD_CODE
			LEFT OUTER JOIN dbo.CAMPAIGN ON ATB_REV.CMP_IDENTIFIER = CAMPAIGN.CMP_IDENTIFIER
			WHERE 1 = CASE WHEN @ATB_NUMBER <= 0 THEN 1 WHEN @ATB_NUMBER > 0 AND ATB_HDR.ATB_NUMBER = @ATB_NUMBER THEN 1 ELSE 0 END AND
				  1 = CASE WHEN @DESCRIPTION = '' THEN 1 WHEN UPPER(ATB_REV.ATB_DESCRIPTION) LIKE '%' + UPPER(@DESCRIPTION) + '%' THEN 1 ELSE 0 END AND
				  1 = CASE WHEN @CMP_IDENTIFIER <= 0 THEN 1 WHEN ATB_REV.CMP_IDENTIFIER = @CMP_IDENTIFIER THEN 1 ELSE 0 END AND
				  1 = CASE WHEN @CL_CODE = '' THEN 1 WHEN ATB_HDR.CL_CODE = @CL_CODE THEN 1 ELSE 0 END AND
				  1 = CASE WHEN @DIV_CODE = '' THEN 1 WHEN ATB_HDR.CL_CODE = @CL_CODE AND ATB_HDR.DIV_CODE = @DIV_CODE THEN 1 ELSE 0 END AND
				  1 = CASE WHEN @PRD_CODE = '' THEN 1 WHEN ATB_HDR.CL_CODE = @CL_CODE AND ATB_HDR.DIV_CODE = @DIV_CODE AND ATB_HDR.PRD_CODE = @PRD_CODE THEN 1 ELSE 0 END AND
				  1 = CASE WHEN @SHOW_CLOSED = 1 THEN 1 WHEN ISNULL(ATB_HDR.INACTIVE_FLAG, 0) = 0 THEN 1 ELSE 0 END
				  AND UPPER(SEC_CLIENT.USER_ID) = UPPER(@USER_ID)
				  AND (SEC_CLIENT.TIME_ENTRY = 0 OR SEC_CLIENT.TIME_ENTRY IS NULL)
		END		
	END
	ELSE
	BEGIN
		IF @OfficeRestrictions > 0
		BEGIN
			INSERT INTO @REVISIONS
			SELECT [ATBNumber] = ATB_HDR.ATB_NUMBER,
				   [Description] = ATB_REV.ATB_DESCRIPTION,
				   [RevisionNumber] = ATB_REV.REV_NBR,
				   [CampaignID] = ATB_REV.CMP_IDENTIFIER,
				   [CampaignCode] = CAMPAIGN.CMP_CODE,
				   [CampaignName] = CAMPAIGN.CMP_NAME,
				   [ClientCode] = ATB_HDR.CL_CODE,
				   [ClientName] = V_PRODUCT.CL_NAME,
				   [DivisionCode] = ATB_HDR.DIV_CODE,
				   [DivisionName] = V_PRODUCT.DIV_NAME,
				   [ProductCode] = ATB_HDR.PRD_CODE,
				   [ProductDescription] = V_PRODUCT.PRD_DESCRIPTION,
				   [IsClosed] = ISNULL(ATB_HDR.INACTIVE_FLAG, 0)
			FROM dbo.ATB_HDR
			INNER JOIN dbo.ATB_REV ON ATB_HDR.ATB_NUMBER = ATB_REV.ATB_NUMBER
			INNER JOIN dbo.V_PRODUCT ON ATB_HDR.CL_CODE = V_PRODUCT.CL_CODE AND
								  ATB_HDR.DIV_CODE = V_PRODUCT.DIV_CODE AND
								  ATB_HDR.PRD_CODE = V_PRODUCT.PRD_CODE
			INNER JOIN dbo.EMP_OFFICE ON V_PRODUCT.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = @EMP_CODE
			LEFT OUTER JOIN dbo.CAMPAIGN ON ATB_REV.CMP_IDENTIFIER = CAMPAIGN.CMP_IDENTIFIER
			WHERE 1 = CASE WHEN @ATB_NUMBER <= 0 THEN 1 WHEN @ATB_NUMBER > 0 AND ATB_HDR.ATB_NUMBER = @ATB_NUMBER THEN 1 ELSE 0 END AND
				  1 = CASE WHEN @DESCRIPTION = '' THEN 1 WHEN UPPER(ATB_REV.ATB_DESCRIPTION) LIKE '%' + UPPER(@DESCRIPTION) + '%' THEN 1 ELSE 0 END AND
				  1 = CASE WHEN @CMP_IDENTIFIER <= 0 THEN 1 WHEN ATB_REV.CMP_IDENTIFIER = @CMP_IDENTIFIER THEN 1 ELSE 0 END AND
				  1 = CASE WHEN @CL_CODE = '' THEN 1 WHEN ATB_HDR.CL_CODE = @CL_CODE THEN 1 ELSE 0 END AND
				  1 = CASE WHEN @DIV_CODE = '' THEN 1 WHEN ATB_HDR.CL_CODE = @CL_CODE AND ATB_HDR.DIV_CODE = @DIV_CODE THEN 1 ELSE 0 END AND
				  1 = CASE WHEN @PRD_CODE = '' THEN 1 WHEN ATB_HDR.CL_CODE = @CL_CODE AND ATB_HDR.DIV_CODE = @DIV_CODE AND ATB_HDR.PRD_CODE = @PRD_CODE THEN 1 ELSE 0 END AND
				  1 = CASE WHEN @SHOW_CLOSED = 1 THEN 1 WHEN ISNULL(ATB_HDR.INACTIVE_FLAG, 0) = 0 THEN 1 ELSE 0 END
		END
		ELSE
		BEGIN
			INSERT INTO @REVISIONS
			SELECT [ATBNumber] = ATB_HDR.ATB_NUMBER,
				   [Description] = ATB_REV.ATB_DESCRIPTION,
				   [RevisionNumber] = ATB_REV.REV_NBR,
				   [CampaignID] = ATB_REV.CMP_IDENTIFIER,
				   [CampaignCode] = CAMPAIGN.CMP_CODE,
				   [CampaignName] = CAMPAIGN.CMP_NAME,
				   [ClientCode] = ATB_HDR.CL_CODE,
				   [ClientName] = V_PRODUCT.CL_NAME,
				   [DivisionCode] = ATB_HDR.DIV_CODE,
				   [DivisionName] = V_PRODUCT.DIV_NAME,
				   [ProductCode] = ATB_HDR.PRD_CODE,
				   [ProductDescription] = V_PRODUCT.PRD_DESCRIPTION,
				   [IsClosed] = ISNULL(ATB_HDR.INACTIVE_FLAG, 0)
			FROM dbo.ATB_HDR
			INNER JOIN dbo.ATB_REV ON ATB_HDR.ATB_NUMBER = ATB_REV.ATB_NUMBER
			INNER JOIN dbo.V_PRODUCT ON ATB_HDR.CL_CODE = V_PRODUCT.CL_CODE AND
								  ATB_HDR.DIV_CODE = V_PRODUCT.DIV_CODE AND
								  ATB_HDR.PRD_CODE = V_PRODUCT.PRD_CODE
			LEFT OUTER JOIN dbo.CAMPAIGN ON ATB_REV.CMP_IDENTIFIER = CAMPAIGN.CMP_IDENTIFIER
			WHERE 1 = CASE WHEN @ATB_NUMBER <= 0 THEN 1 WHEN @ATB_NUMBER > 0 AND ATB_HDR.ATB_NUMBER = @ATB_NUMBER THEN 1 ELSE 0 END AND
				  1 = CASE WHEN @DESCRIPTION = '' THEN 1 WHEN UPPER(ATB_REV.ATB_DESCRIPTION) LIKE '%' + UPPER(@DESCRIPTION) + '%' THEN 1 ELSE 0 END AND
				  1 = CASE WHEN @CMP_IDENTIFIER <= 0 THEN 1 WHEN ATB_REV.CMP_IDENTIFIER = @CMP_IDENTIFIER THEN 1 ELSE 0 END AND
				  1 = CASE WHEN @CL_CODE = '' THEN 1 WHEN ATB_HDR.CL_CODE = @CL_CODE THEN 1 ELSE 0 END AND
				  1 = CASE WHEN @DIV_CODE = '' THEN 1 WHEN ATB_HDR.CL_CODE = @CL_CODE AND ATB_HDR.DIV_CODE = @DIV_CODE THEN 1 ELSE 0 END AND
				  1 = CASE WHEN @PRD_CODE = '' THEN 1 WHEN ATB_HDR.CL_CODE = @CL_CODE AND ATB_HDR.DIV_CODE = @DIV_CODE AND ATB_HDR.PRD_CODE = @PRD_CODE THEN 1 ELSE 0 END AND
				  1 = CASE WHEN @SHOW_CLOSED = 1 THEN 1 WHEN ISNULL(ATB_HDR.INACTIVE_FLAG, 0) = 0 THEN 1 ELSE 0 END
		END
	END

	SELECT DISTINCT R.* 
	FROM @REVISIONS AS R
	JOIN (SELECT ATBNumber, 
				 [MaxRev] = MAX(RevisionNumber) 
		  FROM @REVISIONS 
		  GROUP BY ATBNumber) TopRev ON R.ATBNumber = TopRev.ATBNumber AND
									    R.RevisionNumber = TopRev.MaxRev
	ORDER BY R.ATBNumber

END