CREATE PROCEDURE [dbo].[advsp_media_atb_rpt] 
	@DATE_TYPE AS int,
	@START_DATE AS smalldatetime,
	@END_DATE AS smalldatetime
AS
BEGIN

	SELECT	
		[ID] = NEWID(),
		[ClientCode] = ATB_HDR.CL_CODE,
		[ClientName] = CLIENT.CL_NAME,
		[DivisionCode] = ATB_HDR.DIV_CODE,
		[DivisionName] = DIVISION.DIV_NAME,
		[ProductCode] = ATB_HDR.PRD_CODE,
		[ProductName] = PRODUCT.PRD_DESCRIPTION,
		[ATBNumber] = REPLACE(STR(ATB_HDR.ATB_NUMBER, 6), SPACE(1), '0'),
		[ATBDescription] = ATB_REV.ATB_DESCRIPTION,
		[RevisionNumber] = REPLACE(STR(ATB_REV.REV_NBR, 3), SPACE(1), '0'),
		[DateOfRequest] = ATB_REV.REQ_DATE,
		[CampaignID] = ATB_REV.CMP_IDENTIFIER,
		[CampaignCode] = CAMPAIGN.CMP_CODE,
		[CampaignName] = CAMPAIGN.CMP_NAME,
		[StartDate] = ATB_REV.CMP_START_DATE,
		[EndDate] = ATB_REV.CMP_END_DATE,
		[ClientBudget] = ATB_REV.CMP_CL_BUDGET,
		[BuyGrossOrNet] = CASE WHEN ISNULL(ATB_REV.ATB_BUY_GROSS_NET, 0) = 0 THEN 'Net' ELSE 'Gross' END,
		[SalesClassCode] = ATB_REV.SC_CODE,
		[SalesClassDescription] = SALES_CLASS.SC_DESCRIPTION,
		[Comment] = ATB_REV.ATB_COMMENT,
		[BillingComment] = ATB_REV.BILL_COMMENT,
		[BillingDate] = ATB_REV.BILL_DATE,
		[ClientPO] = ATB_REV.CL_PO,
		[BillingMethod] = CASE WHEN ATB_REV.BILLING_METHOD = 0 THEN 'Full Flight'
							   WHEN ATB_REV.BILLING_METHOD = 1 THEN 'By Day'
							   WHEN ATB_REV.BILLING_METHOD = 2 THEN 'By Week'
							   WHEN ATB_REV.BILLING_METHOD = 3 THEN 'By Month'
							   WHEN ATB_REV.BILLING_METHOD = 4 THEN 'By Quarter' 
						  ELSE '' END,
		[CreatedDate] = ATB_REV.CREATED_DATE,
		[ModifiedDate] = ATB_REV.MODIFIED_DATE,
		[CreatedByUserCode] = ATB_REV.USER_CREATED,
		[ModifiedByUserCode] = ATB_REV.USER_MODIFIED,
		[ApprovedByUserCode] = ATB_REV.APPROVED_BY,
		[ApprovedDate] = ATB_REV.APPROVED_DATE,
		[VendorCode] = ATB_REV_DTL.VN_CODE,
		[VendorName] = VENDOR.VN_NAME,
		[Amount] = ATB_REV_DTL.EXT_AMT,
		[MarkupAmount] = ATB_REV_DTL.MARKUP_AMT,
		[NetSpend] = ATB_REV_DTL.NET_SPEND,
		[LineTotal] = ATB_REV_DTL.LINE_TOTAL,
		[OrderID] = ATB_REV_DTL.ORDER_ID,
		[OrderLineID] = ATB_REV_DTL.ORDER_LINE_ID,
		[OrderLineNumber] = ATB_REV_DTL.ORDER_LINE_NBR,
		[OrderNumber] = ATB_REV_DTL.ORDER_NBR,
		[IsClosed] = CASE WHEN ISNULL(ATB_HDR.INACTIVE_FLAG, 0) = 1 THEN 'Y' ELSE 'N' END
	FROM 
		dbo.ATB_HDR INNER JOIN 
		dbo.ATB_REV ON ATB_HDR.ATB_NUMBER = ATB_REV.ATB_NUMBER INNER JOIN 
		(SELECT 
			ATB_NUMBER,
			[REV_NUMBER] = CASE WHEN NOT EXISTS(SELECT REV_NBR FROM dbo.ATB_REV WHERE ISNULL(APPROVAL_FLAG, 0) = 1 AND ATB_NUMBER = ATBH.ATB_NUMBER)
								THEN (SELECT ISNULL(MAX(REV_NBR), 0) FROM dbo.ATB_REV WHERE ATB_NUMBER = ATBH.ATB_NUMBER)
								ELSE (SELECT ISNULL(MAX(REV_NBR), 0) FROM dbo.ATB_REV WHERE ISNULL(APPROVAL_FLAG, 0) = 1 AND ATB_NUMBER = ATBH.ATB_NUMBER) END
		FROM 
			dbo.ATB_HDR AS ATBH) AS ATB_REV_SEL ON ATB_REV_SEL.ATB_NUMBER = ATB_REV.ATB_NUMBER AND
												   ATB_REV_SEL.[REV_NUMBER] = ATB_REV.REV_NBR LEFT OUTER JOIN 
		dbo.ATB_REV_DTL ON ATB_REV.ATB_REV_ID = ATB_REV_DTL.ATB_REV_ID INNER JOIN 
		dbo.CLIENT ON ATB_HDR.CL_CODE = CLIENT.CL_CODE INNER JOIN 
		dbo.DIVISION ON ATB_HDR.CL_CODE = DIVISION.CL_CODE AND 
						ATB_HDR.DIV_CODE = DIVISION.DIV_CODE INNER JOIN 
		dbo.PRODUCT ON ATB_HDR.CL_CODE = PRODUCT.CL_CODE AND
					   ATB_HDR.DIV_CODE = PRODUCT.DIV_CODE AND
					   ATB_HDR.PRD_CODE = PRODUCT.PRD_CODE LEFT OUTER JOIN 
		dbo.CAMPAIGN ON ATB_REV.CMP_IDENTIFIER = CAMPAIGN.CMP_IDENTIFIER INNER JOIN 
		dbo.SALES_CLASS ON ATB_REV.SC_CODE = SALES_CLASS.SC_CODE LEFT OUTER JOIN 
		dbo.VENDOR ON ATB_REV_DTL.VN_CODE = VENDOR.VN_CODE
	WHERE 
		1 = CASE WHEN @DATE_TYPE = 0 THEN CASE WHEN ATB_REV.CREATED_DATE >= @START_DATE AND ATB_REV.CREATED_DATE <= CONVERT(DATETIME, @END_DATE +' 23:59:59', 101) THEN 1 ELSE 0 END
				 WHEN @DATE_TYPE = 1 THEN CASE WHEN ATB_REV.REQ_DATE >= @START_DATE AND ATB_REV.REQ_DATE <= CONVERT(DATETIME, @END_DATE +' 23:59:59', 101) THEN 1 ELSE 0 END END

END