CREATE PROCEDURE [dbo].[advsp_media_broadcast_schedule_report_detail]
	@MEDIA_BROADCAST_WORKSHEET_MARKET_ID	VARCHAR(3000) = ''
	,@START_YEAR_MONTH						VARCHAR(10) = ''
	,@END_YEAR_MONTH						VARCHAR(10) = ''
	,@USE_PRIMARY_DEMO						VARCHAR(10) = ''
	,@HEADER								VARCHAR(3000) = ''
	,@LOCATION_NAME							VARCHAR(3000) = ''
	,@VENDOR_FILTER							VARCHAR(3000) = ''
	,@NET_COST_INT							INT
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE @NET_COST DECIMAL(18,3) = 1.00

	IF (@NET_COST_INT <> 1000)
		SET @NET_COST = (@NET_COST_INT * 1.00)/100000.00

	DECLARE @Debug			INT = 0
	DECLARE @Today			DATE = GETDATE()
	DECLARE @BucketRez		INT = 1

	DECLARE @MEDIA_BROADCAST_WORKSHEET_ID INT

	CREATE TABLE #VendorFilterTable (VN_CODE VARCHAR(20) COLLATE SQL_Latin1_General_CP1_CS_AS)

	CREATE UNIQUE INDEX VendorFilterTable_MarketID ON #VendorFilterTable (VN_CODE)

	CREATE TABLE #HeaderLineTable (
		MEDIA_BROADCAST_WORKSHEET_MARKET_ID INT
		,START_DATE							DATE
		,END_DATE							DATE
	)

	CREATE UNIQUE INDEX HeaderLineTable_MarketID ON #HeaderLineTable (MEDIA_BROADCAST_WORKSHEET_MARKET_ID)

	DECLARE @START_DATE DATE
	DECLARE @END_DATE	DATE
	DECLARE @PRIMARY_DEMO INT

	IF (@START_YEAR_MONTH IS NOT NULL)
		SET @START_DATE = CONVERT(DATE,CONVERT(VARCHAR,(CONVERT(INT,@START_YEAR_MONTH) % 100))+'/01/'+CONVERT(VARCHAR,(CONVERT(INT,@START_YEAR_MONTH) / 100)))
	ELSE
		SET @START_DATE = NULL
	
	IF (@END_YEAR_MONTH IS NOT NULL)
		SET @END_DATE = DATEADD(DAY,-1,DATEADD(MONTH,1,CONVERT(DATE,CONVERT(VARCHAR,(CONVERT(INT,@END_YEAR_MONTH) % 100))+'/01/'+CONVERT(VARCHAR,(CONVERT(INT,@END_YEAR_MONTH) / 100)))))
	ELSE
		SET @END_DATE = NULL
	
	IF (@USE_PRIMARY_DEMO IS NOT NULL)
		SET @PRIMARY_DEMO = 1
	ELSE
		SET @PRIMARY_DEMO = 0

	INSERT INTO #HeaderLineTable 
	SELECT 
		WORKSHEET.vint [MEDIA_BROADCAST_WORKSHEET_MARKET_ID]
		,@START_DATE [START_DATE]
		,@END_DATE [END_DATE]
	FROM
		[dbo].[charlist_to_table_int](@MEDIA_BROADCAST_WORKSHEET_MARKET_ID,',') WORKSHEET

	UPDATE #HeaderLineTable
		SET
			START_DATE = [dbo].[advfn_broadcast_date](START_DATE,'B',HLT.MEDIA_BROADCAST_WORKSHEET_MARKET_ID)
			,END_DATE =  [dbo].[advfn_broadcast_date](END_DATE,'E',HLT.MEDIA_BROADCAST_WORKSHEET_MARKET_ID)
	FROM
		#HeaderLineTable HLT

	IF (LEN(@VENDOR_FILTER) = 0)
		BEGIN			
			INSERT INTO #VendorFilterTable
			SELECT DISTINCT
				MBW_MD.VN_CODE
			FROM 
				MEDIA_BROADCAST_WORKSHEET MBW WITH (NOLOCK)
					INNER JOIN MEDIA_BROADCAST_WORKSHEET_MARKET MBW_M WITH (NOLOCK)
						ON MBW.MEDIA_BROADCAST_WORKSHEET_ID = MBW.MEDIA_BROADCAST_WORKSHEET_ID
					INNER JOIN MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL MBW_MD WITH (NOLOCK)
						ON MBW_M.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = MBW_MD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID
					INNER JOIN #HeaderLineTable HLT
						ON MBW_M.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = HLT.MEDIA_BROADCAST_WORKSHEET_MARKET_ID
			WHERE (1=1)
				AND MBW.IS_INACTIVE = 0
		END
	ELSE
		BEGIN
			INSERT INTO #VendorFilterTable
			SELECT
				VF.vstr
			FROM 
				dbo.charlist_to_table_tsa(@VENDOR_FILTER,',') VF
		END

	SELECT TOP 1
		@BucketRez = (CASE WHEN (MBW.MEDIA_BROADCAST_WORKSHEET_DATE_TYPE_ID =1) THEN 1 ELSE 7 END)
	FROM
		MEDIA_BROADCAST_WORKSHEET MBW WITH (NOLOCK)
			INNER JOIN MEDIA_BROADCAST_WORKSHEET_MARKET MBW_M WITH (NOLOCK)
				ON MBW.MEDIA_BROADCAST_WORKSHEET_ID = MBW_M.MEDIA_BROADCAST_WORKSHEET_ID
			INNER JOIN #HeaderLineTable HLT
				ON HLT.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = MBW_M.MEDIA_BROADCAST_WORKSHEET_MARKET_ID

	DECLARE @Dates [dbo].[MEDIA_BROADCAST_WORKSHEETMARKET_DATE_TYPE]

	DECLARE @BucketList TABLE
	(
		WorksheetMarketID		INT
		,BucketBeginDate		DATE
		,BucketEndDate			DATE
		,BucketNumber			INT
		,BucketRow				INT
		,BucketSlot				INT
		,BucketLastRow			BIT
	)

	INSERT INTO @Dates (WORKSHEETMARKETID,RPTDATE) 
	(SELECT DISTINCT
		MBW_M.MEDIA_BROADCAST_WORKSHEET_MARKET_ID
		,MBW_MDD.DATE
	FROM
		MEDIA_BROADCAST_WORKSHEET MBW WITH (NOLOCK)
			INNER JOIN MEDIA_BROADCAST_WORKSHEET_MARKET MBW_M WITH (NOLOCK)
				ON MBW.MEDIA_BROADCAST_WORKSHEET_ID = MBW_M.MEDIA_BROADCAST_WORKSHEET_ID
			INNER JOIN MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL MBW_MD WITH (NOLOCK)
				ON MBW_M.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = MBW_MD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID
			INNER JOIN (SELECT 
							MEDIA_BROADCAST_WORKSHEET_MARKET_ID, REVISION_NUMBER = MAX(REVISION_NUMBER) 
						FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL WITH (NOLOCK)
						GROUP BY MEDIA_BROADCAST_WORKSHEET_MARKET_ID) AS MMB_WM 
							ON MMB_WM.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = MBW_MD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID AND MBW_MD.REVISION_NUMBER = MMB_WM.REVISION_NUMBER
			INNER JOIN MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_DATE MBW_MDD WITH (NOLOCK)
				ON MBW_MD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID = MBW_MDD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID
			INNER JOIN #HeaderLineTable HLT
				ON HLT.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = MBW_M.MEDIA_BROADCAST_WORKSHEET_MARKET_ID
			INNER JOIN #VendorFilterTable VFT
				ON MBW_MD.VN_CODE = VFT.VN_CODE

	WHERE (1=1)
		AND (MBW_MDD.DATE BETWEEN HLT.START_DATE AND HLT.END_DATE)
	)

	INSERT INTO @BucketList
	SELECT * FROM [dbo].[advtf_date_range_buckets] (@Dates,14,@BucketRez)

	DECLARE @StationGross TABLE
	(
		MEDIA_BROADCAST_WORKSHEET_ID			INT
		,MEDIA_BROADCAST_WORKSHEET_MARKET_ID	INT
		,BucketRow			INT
		,VN_CODE			VARCHAR(20)
		,LINE_NUMBER		INT
		,MAKEGOOD_NUMBER	INT
		,RATE				DECIMAL(18,3)
		,StationGross		DECIMAL(18,3)
	)

	INSERT INTO @StationGross
	SELECT
		MBW_M.MEDIA_BROADCAST_WORKSHEET_ID
		,MBW_M.MEDIA_BROADCAST_WORKSHEET_MARKET_ID
		,BL.BucketRow
		,MBW_MD.VN_CODE
		,MBW_MD.LINE_NUMBER
		,MBW_MD.MAKEGOOD_NUMBER		
		,CONVERT(DECIMAL(18,3),(MBW_MDD.RATE * 0.00001) * @NET_COST_INT )
		,CONVERT(DECIMAL(18,3),SUM(MBW_MDD.RATE * (MBW_MDD.SPOTS * @NET_COST_INT)) * 0.00001)
	FROM
		MEDIA_BROADCAST_WORKSHEET_MARKET MBW_M WITH (NOLOCK)
			INNER JOIN #HeaderLineTable  HLT
				ON MBW_M.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = HLT.MEDIA_BROADCAST_WORKSHEET_MARKET_ID
			INNER JOIN MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL MBW_MD WITH (NOLOCK)
				ON MBW_M.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = MBW_MD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID
			INNER JOIN (SELECT 
							MEDIA_BROADCAST_WORKSHEET_MARKET_ID, REVISION_NUMBER = MAX(REVISION_NUMBER) 
						FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL WITH (NOLOCK)
						GROUP BY MEDIA_BROADCAST_WORKSHEET_MARKET_ID) AS MMB_WM 
							ON MMB_WM.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = MBW_MD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID AND MBW_MD.REVISION_NUMBER = MMB_WM.REVISION_NUMBER
			INNER JOIN MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_DATE MBW_MDD WITH (NOLOCK)
				ON MBW_MD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID = MBW_MDD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID
			INNER JOIN #VendorFilterTable VFT
				ON MBW_MD.VN_CODE = VFT.VN_CODE
			INNER JOIN @BucketList BL
								ON MBW_MDD.DATE BETWEEN BL.BucketBeginDate AND BL.BucketEndDate
								AND MBW_M.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = BL.WorksheetMarketID
	WHERE (1=1)
		AND (MBW_MDD.DATE BETWEEN HLT.START_DATE AND HLT.END_DATE)
	GROUP BY
		MBW_M.MEDIA_BROADCAST_WORKSHEET_ID
		,MBW_M.MEDIA_BROADCAST_WORKSHEET_MARKET_ID
		,BL.BucketRow
		,MBW_MD.VN_CODE
		,MBW_MD.LINE_NUMBER
		,MBW_MD.MAKEGOOD_NUMBER		
		,MBW_MDD.RATE

	DECLARE @MaxOrderNumber TABLE ( MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID INT, ORDER_NBR INT )

	INSERT INTO @MaxOrderNumber
	SELECT
		MBW_MDD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID
		,MAX(MBW_MDD.ORDER_NBR) ORDER_NBR
	FROM
		MEDIA_BROADCAST_WORKSHEET MBW WITH (NOLOCK)
		INNER JOIN MEDIA_BROADCAST_WORKSHEET_MARKET MBW_M WITH (NOLOCK)
			ON MBW.MEDIA_BROADCAST_WORKSHEET_ID = MBW_M.MEDIA_BROADCAST_WORKSHEET_ID
		INNER JOIN MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL MBW_MD WITH (NOLOCK)
			ON MBW_M.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = MBW_MD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID 
		INNER JOIN MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_DATE MBW_MDD WITH (NOLOCK)
			ON MBW_MD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID = MBW_MDD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID
		INNER JOIN #HeaderLineTable HLT
				ON HLT.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = MBW_M.MEDIA_BROADCAST_WORKSHEET_MARKET_ID
		INNER JOIN #VendorFilterTable VFT
				ON MBW_MD.VN_CODE = VFT.VN_CODE
	WHERE (1=1)
		AND (MBW_MDD.DATE BETWEEN HLT.START_DATE AND HLT.END_DATE)
		AND (MBW_MDD.ORDER_NBR IS NOT NULL)
	GROUP BY
		MBW_MDD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID


	SELECT DISTINCT
		MBW.MEDIA_TYPE_CODE
		,MBW.CL_CODE
		,MBW.IS_GROSS
		,MBW.DIV_CODE
		,MBW.PRD_CODE
		,MBW_M.MEDIA_BROADCAST_WORKSHEET_MARKET_ID
		,MBW_MD.REVISION_NUMBER BuyRevision
		,CONVERT(VARCHAR,MAXORD.ORDER_NBR) BuyOrder
		,MAXORD.ORDER_NBR
		,BL.BucketRow
		,BL.BucketLastRow
		,MBW_MD.LINE_NUMBER
		,MBW_MD.COMMENTS Comments
		,MBW_MD.BOOKEND IsBookend
		,MBW_MD.VALUE_ADDED IsAddedValue
		,MBW_MD.MAKEGOOD_NUMBER
		,MBW_MD.DAYS + ' / ' + MBW_MD.START_TIME + '-' + MBW_MD.END_TIME [DAYS]
		,MBW_MD.VN_CODE VendorCode
		,MBW_MD.LENGTH
		,DP.DAY_PART_CODE + ' -' + DP.DESCRIPTION					[DayPartName]
		,ISNULL(MBW_MD.CABLE_NETWORK_STATION_CODE,'')				[CableNetwork]
		,CASE WHEN (MBW_M.IS_CABLE = 1) THEN 1 ELSE 0 END			[IsCable]
		,MBW_MD.PROGRAM												[ProgramName]

		,CASE WHEN (BL.BucketSlot = 1) THEN BL.BucketBeginDate ELSE NULL END WEEK1_DATE
		,CASE WHEN (BL.BucketSlot = 2) THEN BL.BucketBeginDate ELSE NULL END WEEK2_DATE
		,CASE WHEN (BL.BucketSlot = 3) THEN BL.BucketBeginDate ELSE NULL END WEEK3_DATE
		,CASE WHEN (BL.BucketSlot = 4) THEN BL.BucketBeginDate ELSE NULL END WEEK4_DATE
		,CASE WHEN (BL.BucketSlot = 5) THEN BL.BucketBeginDate ELSE NULL END WEEK5_DATE
		,CASE WHEN (BL.BucketSlot = 6) THEN BL.BucketBeginDate ELSE NULL END WEEK6_DATE
		,CASE WHEN (BL.BucketSlot = 7) THEN BL.BucketBeginDate ELSE NULL END WEEK7_DATE
		,CASE WHEN (BL.BucketSlot = 8) THEN BL.BucketBeginDate ELSE NULL END WEEK8_DATE
		,CASE WHEN (BL.BucketSlot = 9) THEN BL.BucketBeginDate ELSE NULL END WEEK9_DATE
		,CASE WHEN (BL.BucketSlot = 10) THEN BL.BucketBeginDate ELSE NULL END WEEK10_DATE
		,CASE WHEN (BL.BucketSlot = 11) THEN BL.BucketBeginDate ELSE NULL END WEEK11_DATE
		,CASE WHEN (BL.BucketSlot = 12) THEN BL.BucketBeginDate ELSE NULL END WEEK12_DATE
		,CASE WHEN (BL.BucketSlot = 13) THEN BL.BucketBeginDate ELSE NULL END WEEK13_DATE
		,CASE WHEN (BL.BucketSlot = 0) THEN BL.BucketBeginDate ELSE NULL END WEEK14_DATE

		,M_D.DESCRIPTION				[DEMO_GROUP1_NAME]
		,SM_D.DESCRIPTION				[DEMO_GROUP2_NAME]

		, (MBW_MD.PRIMARY_RATING + MBW_MD.PRIMARY_AQH_RATING)			[DEMO_GROUP1_RTG]  
		, (MBW_MD.SECONDARY_RATING + MBW_MD.SECONDARY_AQH_RATING)		[DEMO_GROUP2_RTG]  

		, (MBW_MD.PRIMARY_IMPRESSIONS + MBW_MD.PRIMARY_AQH) * 1.0		[DEMO_GROUP1_IMP]
		, (MBW_MD.SECONDARY_IMPRESSIONS + MBW_MD.SECONDARY_AQH) * 1.0	[DEMO_GROUP2_IMP]

		,MBW_MD.[PRIMARY_CPP]			[DEMO_GROUP1_CPP]
		,MBW_MD.[SECONDARY_CPP]			[DEMO_GROUP2_CPP]

		,MBW_MD.[PRIMARY_CPM]			[DEMO_GROUP1_CPM]
		,MBW_MD.[SECONDARY_CPM]			[DEMO_GROUP2_CPM]

		,MBW_MD.[PRIMARY_GRP]			[DEMO_GROUP1_GRP]
		,MBW_MD.[SECONDARY_GRP]			[DEMO_GROUP2_GRP]
						
		,DIV.DIV_NAME					[DivisionName]

		,SUM(MBW_MDD.SPOTS) AS TotalSpots
		,CONVERT(DECIMAL(18,3),(MBW_MDD.RATE * 0.00001) * @NET_COST_INT )	As Rate
						
		,SUM(CASE WHEN (BL.BucketSlot = 1) THEN MBW_MDD.SPOTS ELSE 0 END) WEEK1_SPOTS
		,SUM(CASE WHEN (BL.BucketSlot = 2) THEN MBW_MDD.SPOTS ELSE 0 END) WEEK2_SPOTS
		,SUM(CASE WHEN (BL.BucketSlot = 3) THEN MBW_MDD.SPOTS ELSE 0 END) WEEK3_SPOTS
		,SUM(CASE WHEN (BL.BucketSlot = 4) THEN MBW_MDD.SPOTS ELSE 0 END) WEEK4_SPOTS
		,SUM(CASE WHEN (BL.BucketSlot = 5) THEN MBW_MDD.SPOTS ELSE 0 END) WEEK5_SPOTS
		,SUM(CASE WHEN (BL.BucketSlot = 6) THEN MBW_MDD.SPOTS ELSE 0 END) WEEK6_SPOTS
		,SUM(CASE WHEN (BL.BucketSlot = 7) THEN MBW_MDD.SPOTS ELSE 0 END) WEEK7_SPOTS
		,SUM(CASE WHEN (BL.BucketSlot = 8) THEN MBW_MDD.SPOTS ELSE 0 END) WEEK8_SPOTS
		,SUM(CASE WHEN (BL.BucketSlot = 9) THEN MBW_MDD.SPOTS ELSE 0 END) WEEK9_SPOTS
		,SUM(CASE WHEN (BL.BucketSlot = 10) THEN MBW_MDD.SPOTS ELSE 0 END) WEEK10_SPOTS
		,SUM(CASE WHEN (BL.BucketSlot = 11) THEN MBW_MDD.SPOTS ELSE 0 END) WEEK11_SPOTS
		,SUM(CASE WHEN (BL.BucketSlot = 12) THEN MBW_MDD.SPOTS ELSE 0 END) WEEK12_SPOTS
		,SUM(CASE WHEN (BL.BucketSlot = 13) THEN MBW_MDD.SPOTS ELSE 0 END) WEEK13_SPOTS
		,SUM(CASE WHEN (BL.BucketSlot = 0) THEN MBW_MDD.SPOTS ELSE 0 END) WEEK14_SPOTS

		,SUM(CASE WHEN (BL.BucketSlot = 1 ) THEN (MBW_MDD.SPOTS * @NET_COST_INT) * MBW_MDD.RATE * 0.00001 ELSE 0.0000 END) WEEK1_COSTS
		,SUM(CASE WHEN (BL.BucketSlot = 2 ) THEN (MBW_MDD.SPOTS * @NET_COST_INT) * MBW_MDD.RATE * 0.00001 ELSE 0.0000 END) WEEK2_COSTS
		,SUM(CASE WHEN (BL.BucketSlot = 3 ) THEN (MBW_MDD.SPOTS * @NET_COST_INT) * MBW_MDD.RATE * 0.00001 ELSE 0.0000 END) WEEK3_COSTS
		,SUM(CASE WHEN (BL.BucketSlot = 4 ) THEN (MBW_MDD.SPOTS * @NET_COST_INT) * MBW_MDD.RATE * 0.00001 ELSE 0.0000 END) WEEK4_COSTS
		,SUM(CASE WHEN (BL.BucketSlot = 5 ) THEN (MBW_MDD.SPOTS * @NET_COST_INT) * MBW_MDD.RATE * 0.00001 ELSE 0.0000 END) WEEK5_COSTS
		,SUM(CASE WHEN (BL.BucketSlot = 6 ) THEN (MBW_MDD.SPOTS * @NET_COST_INT) * MBW_MDD.RATE * 0.00001 ELSE 0.0000 END) WEEK6_COSTS
		,SUM(CASE WHEN (BL.BucketSlot = 7 ) THEN (MBW_MDD.SPOTS * @NET_COST_INT) * MBW_MDD.RATE * 0.00001 ELSE 0.0000 END) WEEK7_COSTS
		,SUM(CASE WHEN (BL.BucketSlot = 8 ) THEN (MBW_MDD.SPOTS * @NET_COST_INT) * MBW_MDD.RATE * 0.00001 ELSE 0.0000 END) WEEK8_COSTS
		,SUM(CASE WHEN (BL.BucketSlot = 9 ) THEN (MBW_MDD.SPOTS * @NET_COST_INT) * MBW_MDD.RATE * 0.00001 ELSE 0.0000 END) WEEK9_COSTS
		,SUM(CASE WHEN (BL.BucketSlot = 10) THEN (MBW_MDD.SPOTS * @NET_COST_INT) * MBW_MDD.RATE * 0.00001 ELSE 0.0000 END) WEEK10_COSTS
		,SUM(CASE WHEN (BL.BucketSlot = 11) THEN (MBW_MDD.SPOTS * @NET_COST_INT) * MBW_MDD.RATE * 0.00001 ELSE 0.0000 END) WEEK11_COSTS
		,SUM(CASE WHEN (BL.BucketSlot = 12) THEN (MBW_MDD.SPOTS * @NET_COST_INT) * MBW_MDD.RATE * 0.00001 ELSE 0.0000 END) WEEK12_COSTS
		,SUM(CASE WHEN (BL.BucketSlot = 13) THEN (MBW_MDD.SPOTS * @NET_COST_INT) * MBW_MDD.RATE * 0.00001 ELSE 0.0000 END) WEEK13_COSTS
		,SUM(CASE WHEN (BL.BucketSlot = 0 ) THEN (MBW_MDD.SPOTS * @NET_COST_INT) * MBW_MDD.RATE * 0.00001 ELSE 0.0000 END) WEEK14_COSTS

		,SUM(CASE WHEN (BL.BucketSlot = 1) THEN MBW_MD.PRIMARY_CPM ELSE NULL END) WEEK1_PRIMARY_CPM
		,SUM(CASE WHEN (BL.BucketSlot = 2) THEN MBW_MD.PRIMARY_CPM ELSE NULL END) WEEK2_PRIMARY_CPM
		,SUM(CASE WHEN (BL.BucketSlot = 3) THEN MBW_MD.PRIMARY_CPM ELSE NULL END) WEEK3_PRIMARY_CPM
		,SUM(CASE WHEN (BL.BucketSlot = 4) THEN MBW_MD.PRIMARY_CPM ELSE NULL END) WEEK4_PRIMARY_CPM
		,SUM(CASE WHEN (BL.BucketSlot = 5) THEN MBW_MD.PRIMARY_CPM ELSE NULL END) WEEK5_PRIMARY_CPM
		,SUM(CASE WHEN (BL.BucketSlot = 6) THEN MBW_MD.PRIMARY_CPM ELSE NULL END) WEEK6_PRIMARY_CPM
		,SUM(CASE WHEN (BL.BucketSlot = 7) THEN MBW_MD.PRIMARY_CPM ELSE NULL END) WEEK7_PRIMARY_CPM
		,SUM(CASE WHEN (BL.BucketSlot = 8) THEN MBW_MD.PRIMARY_CPM ELSE NULL END) WEEK8_PRIMARY_CPM
		,SUM(CASE WHEN (BL.BucketSlot = 9) THEN MBW_MD.PRIMARY_CPM ELSE NULL END) WEEK9_PRIMARY_CPM
		,SUM(CASE WHEN (BL.BucketSlot = 10) THEN MBW_MD.PRIMARY_CPM ELSE NULL END) WEEK10_PRIMARY_CPM
		,SUM(CASE WHEN (BL.BucketSlot = 11) THEN MBW_MD.PRIMARY_CPM ELSE NULL END) WEEK11_PRIMARY_CPM
		,SUM(CASE WHEN (BL.BucketSlot = 12) THEN MBW_MD.PRIMARY_CPM ELSE NULL END) WEEK12_PRIMARY_CPM
		,SUM(CASE WHEN (BL.BucketSlot = 13) THEN MBW_MD.PRIMARY_CPM ELSE NULL END) WEEK13_PRIMARY_CPM
		,SUM(CASE WHEN (BL.BucketSlot = 0) THEN MBW_MD.PRIMARY_CPM ELSE NULL END) WEEK14_PRIMARY_CPM

		,SUM( (MBW_MD.PRIMARY_RATING + MBW_MD.PRIMARY_AQH_RATING) * MBW_MDD.SPOTS)		TOTAL_PRIMARY_GRP
		,SUM( (MBW_MD.SECONDARY_RATING + MBW_MD.SECONDARY_AQH_RATING) * MBW_MDD.SPOTS)	TOTAL_SECONDARY_GRP

		,SUM(CASE 
				WHEN (BL.BucketSlot = 1) THEN (MBW_MD.PRIMARY_RATING + MBW_MD.PRIMARY_AQH_RATING) * MBW_MDD.SPOTS 
				ELSE 0.00
			END) WEEK1_PRIMARY_GRP
		,SUM(CASE 
				WHEN (BL.BucketSlot = 2) THEN (MBW_MD.PRIMARY_RATING + MBW_MD.PRIMARY_AQH_RATING) * MBW_MDD.SPOTS 
				ELSE 0.00 
			END) WEEK2_PRIMARY_GRP
		,SUM(CASE 
				WHEN (BL.BucketSlot = 3) THEN (MBW_MD.PRIMARY_RATING + MBW_MD.PRIMARY_AQH_RATING) * MBW_MDD.SPOTS 					
				ELSE 0.00
			END) WEEK3_PRIMARY_GRP
		,SUM(CASE 
				WHEN (BL.BucketSlot = 4) THEN (MBW_MD.PRIMARY_RATING + MBW_MD.PRIMARY_AQH_RATING) * MBW_MDD.SPOTS 
				ELSE 0.00 
			END) WEEK4_PRIMARY_GRP
		,SUM(CASE 
				WHEN (BL.BucketSlot = 5) THEN (MBW_MD.PRIMARY_RATING + MBW_MD.PRIMARY_AQH_RATING) * MBW_MDD.SPOTS 
				ELSE 0.00 
			END) WEEK5_PRIMARY_GRP
		,SUM(CASE 
				WHEN (BL.BucketSlot = 6) THEN (MBW_MD.PRIMARY_RATING + MBW_MD.PRIMARY_AQH_RATING) * MBW_MDD.SPOTS 
				ELSE 0.00 
			END) WEEK6_PRIMARY_GRP
		,SUM(CASE 
				WHEN (BL.BucketSlot = 7) THEN (MBW_MD.PRIMARY_RATING + MBW_MD.PRIMARY_AQH_RATING) * MBW_MDD.SPOTS 
				ELSE 0.00 
			END) WEEK7_PRIMARY_GRP
		,SUM(CASE 
				WHEN (BL.BucketSlot = 8) THEN (MBW_MD.PRIMARY_RATING + MBW_MD.PRIMARY_AQH_RATING) * MBW_MDD.SPOTS 
				ELSE 0.00 
			END) WEEK8_PRIMARY_GRP
		,SUM(CASE 
				WHEN (BL.BucketSlot = 9) THEN (MBW_MD.PRIMARY_RATING + MBW_MD.PRIMARY_AQH_RATING) * MBW_MDD.SPOTS 
				ELSE 0.00 
			END) WEEK9_PRIMARY_GRP
		,SUM(CASE 
				WHEN (BL.BucketSlot = 10) THEN (MBW_MD.PRIMARY_RATING + MBW_MD.PRIMARY_AQH_RATING) * MBW_MDD.SPOTS 
				ELSE 0.00 
			END) WEEK10_PRIMARY_GRP
		,SUM(CASE 
				WHEN (BL.BucketSlot = 11) THEN (MBW_MD.PRIMARY_RATING + MBW_MD.PRIMARY_AQH_RATING) * MBW_MDD.SPOTS 
				ELSE 0.00 
			END) WEEK11_PRIMARY_GRP
		,SUM(CASE 
				WHEN (BL.BucketSlot = 12) THEN (MBW_MD.PRIMARY_RATING + MBW_MD.PRIMARY_AQH_RATING) * MBW_MDD.SPOTS 
				ELSE 0.00 
			END) WEEK12_PRIMARY_GRP
			,SUM(CASE 
				WHEN (BL.BucketSlot = 13) THEN (MBW_MD.PRIMARY_RATING + MBW_MD.PRIMARY_AQH_RATING) * MBW_MDD.SPOTS 
				ELSE 0.00 
			END) WEEK13_PRIMARY_GRP
		,SUM(CASE 
			WHEN (BL.BucketSlot = 0) THEN (MBW_MD.PRIMARY_RATING + MBW_MD.PRIMARY_AQH_RATING) * MBW_MDD.SPOTS 
			ELSE 0.00 
		END) WEEK14_PRIMARY_GRP

		,SUM(CASE 
				WHEN (BL.BucketSlot = 1) THEN (MBW_MD.SECONDARY_RATING + MBW_MD.SECONDARY_AQH_RATING) * MBW_MDD.SPOTS 
				ELSE 0.00 
			END) WEEK1_SECONDARY_GRP
		,SUM(CASE 
				WHEN (BL.BucketSlot = 2) THEN (MBW_MD.SECONDARY_RATING + MBW_MD.SECONDARY_AQH_RATING) * MBW_MDD.SPOTS 
				ELSE 0.00 
			END) WEEK2_SECONDARY_GRP
		,SUM(CASE 
				WHEN (BL.BucketSlot = 3) THEN (MBW_MD.SECONDARY_RATING + MBW_MD.SECONDARY_AQH_RATING) * MBW_MDD.SPOTS 
				ELSE 0.00 
			END) WEEK3_SECONDARY_GRP
		,SUM(CASE 
				WHEN (BL.BucketSlot = 4) THEN (MBW_MD.SECONDARY_RATING + MBW_MD.SECONDARY_AQH_RATING) * MBW_MDD.SPOTS 
				ELSE 0.00 
			END) WEEK4_SECONDARY_GRP
		,SUM(CASE 
				WHEN (BL.BucketSlot = 5) THEN (MBW_MD.SECONDARY_RATING + MBW_MD.SECONDARY_AQH_RATING) * MBW_MDD.SPOTS 
				ELSE 0.00 
			END) WEEK5_SECONDARY_GRP
		,SUM(CASE 
				WHEN (BL.BucketSlot = 6) THEN (MBW_MD.SECONDARY_RATING + MBW_MD.SECONDARY_AQH_RATING) * MBW_MDD.SPOTS 
				ELSE 0.00 
			END) WEEK6_SECONDARY_GRP
		,SUM(CASE 
				WHEN (BL.BucketSlot = 7) THEN (MBW_MD.SECONDARY_RATING + MBW_MD.SECONDARY_AQH_RATING) * MBW_MDD.SPOTS 
				ELSE 0.00 
			END) WEEK7_SECONDARY_GRP
		,SUM(CASE 
				WHEN (BL.BucketSlot = 8) THEN (MBW_MD.SECONDARY_RATING + MBW_MD.SECONDARY_AQH_RATING) * MBW_MDD.SPOTS 
				ELSE 0.00 
			END) WEEK8_SECONDARY_GRP
		,SUM(CASE 
				WHEN (BL.BucketSlot = 9) THEN (MBW_MD.SECONDARY_RATING + MBW_MD.SECONDARY_AQH_RATING) * MBW_MDD.SPOTS 
				ELSE 0.00 
			END) WEEK9_SECONDARY_GRP
		,SUM(CASE 
				WHEN (BL.BucketSlot = 10) THEN (MBW_MD.SECONDARY_RATING + MBW_MD.SECONDARY_AQH_RATING) * MBW_MDD.SPOTS 
				ELSE 0.00 
			END) WEEK10_SECONDARY_GRP
		,SUM(CASE 
				WHEN (BL.BucketSlot = 11) THEN (MBW_MD.SECONDARY_RATING + MBW_MD.SECONDARY_AQH_RATING) * MBW_MDD.SPOTS 
				ELSE 0.00 
			END) WEEK11_SECONDARY_GRP
		,SUM(CASE 
				WHEN (BL.BucketSlot = 12) THEN (MBW_MD.SECONDARY_RATING + MBW_MD.SECONDARY_AQH_RATING) * MBW_MDD.SPOTS 
				ELSE 0.00 
			END) WEEK12_SECONDARY_GRP
		,SUM(CASE 
			WHEN (BL.BucketSlot = 13) THEN (MBW_MD.SECONDARY_RATING + MBW_MD.SECONDARY_AQH_RATING) * MBW_MDD.SPOTS 
			ELSE 0.00 
		END) WEEK13_SECONDARY_GRP
		,SUM(CASE 
			WHEN (BL.BucketSlot = 0) THEN (MBW_MD.SECONDARY_RATING + MBW_MD.SECONDARY_AQH_RATING) * MBW_MDD.SPOTS 
			ELSE 0.00 
		END) WEEK14_SECONDARY_GRP


		,SUM( (MBW_MD.PRIMARY_IMPRESSIONS + MBW_MD.PRIMARY_AQH) * MBW_MDD.SPOTS ) PRIMARY_GROSS_IMPRESSIONS
		,SUM( (MBW_MD.SECONDARY_IMPRESSIONS + MBW_MD.SECONDARY_AQH) * MBW_MDD.SPOTS ) SECONDARY_GROSS_IMPRESSIONS

		,SUM(CASE 
				WHEN (BL.BucketSlot = 1) THEN (MBW_MD.PRIMARY_IMPRESSIONS + MBW_MD.PRIMARY_AQH) * MBW_MDD.SPOTS * 1.000
				ELSE 0.00
			END) WEEK1_PRIMARY_GROSS_IMPRESSIONS
		,SUM(CASE 
				WHEN (BL.BucketSlot = 2) THEN (MBW_MD.PRIMARY_IMPRESSIONS + MBW_MD.PRIMARY_AQH) * MBW_MDD.SPOTS * 1.000
				ELSE 0.00
			END) WEEK2_PRIMARY_GROSS_IMPRESSIONS
		,SUM(CASE 
				WHEN (BL.BucketSlot = 3) THEN (MBW_MD.PRIMARY_IMPRESSIONS + MBW_MD.PRIMARY_AQH) * MBW_MDD.SPOTS * 1.000
				ELSE 0.00
			END) WEEK3_PRIMARY_GROSS_IMPRESSIONS
		,SUM(CASE 
				WHEN (BL.BucketSlot = 4) THEN (MBW_MD.PRIMARY_IMPRESSIONS + MBW_MD.PRIMARY_AQH) * MBW_MDD.SPOTS * 1.000
				ELSE 0.00
			END) WEEK4_PRIMARY_GROSS_IMPRESSIONS
		,SUM(CASE 
				WHEN (BL.BucketSlot = 5) THEN (MBW_MD.PRIMARY_IMPRESSIONS + MBW_MD.PRIMARY_AQH) * MBW_MDD.SPOTS * 1.000
				ELSE 0.00
			END) WEEK5_PRIMARY_GROSS_IMPRESSIONS
		,SUM(CASE 
				WHEN (BL.BucketSlot = 6) THEN (MBW_MD.PRIMARY_IMPRESSIONS + MBW_MD.PRIMARY_AQH) * MBW_MDD.SPOTS * 1.000
				ELSE 0.00
			END) WEEK6_PRIMARY_GROSS_IMPRESSIONS
		,SUM(CASE 
				WHEN (BL.BucketSlot = 7) THEN (MBW_MD.PRIMARY_IMPRESSIONS + MBW_MD.PRIMARY_AQH) * MBW_MDD.SPOTS * 1.000
				ELSE 0.00
			END) WEEK7_PRIMARY_GROSS_IMPRESSIONS
		,SUM(CASE 
				WHEN (BL.BucketSlot = 8) THEN (MBW_MD.PRIMARY_IMPRESSIONS + MBW_MD.PRIMARY_AQH) * MBW_MDD.SPOTS * 1.000
				ELSE 0.00
			END) WEEK8_PRIMARY_GROSS_IMPRESSIONS
		,SUM(CASE 
				WHEN (BL.BucketSlot = 9) THEN (MBW_MD.PRIMARY_IMPRESSIONS + MBW_MD.PRIMARY_AQH) * MBW_MDD.SPOTS * 1.000
				ELSE 0.00
			END) WEEK9_PRIMARY_GROSS_IMPRESSIONS
		,SUM(CASE 
				WHEN (BL.BucketSlot = 10) THEN (MBW_MD.PRIMARY_IMPRESSIONS + MBW_MD.PRIMARY_AQH) * MBW_MDD.SPOTS * 1.000
				ELSE 0.00
			END) WEEK10_PRIMARY_GROSS_IMPRESSIONS
		,SUM(CASE 
				WHEN (BL.BucketSlot = 11) THEN (MBW_MD.PRIMARY_IMPRESSIONS + MBW_MD.PRIMARY_AQH) * MBW_MDD.SPOTS * 1.000
				ELSE 0.00
			END) WEEK11_PRIMARY_GROSS_IMPRESSIONS
		,SUM(CASE 
				WHEN (BL.BucketSlot = 12) THEN (MBW_MD.PRIMARY_IMPRESSIONS + MBW_MD.PRIMARY_AQH) * MBW_MDD.SPOTS * 1.000
				ELSE 0.00
			END) WEEK12_PRIMARY_GROSS_IMPRESSIONS
		,SUM(CASE 
				WHEN (BL.BucketSlot = 13) THEN (MBW_MD.PRIMARY_IMPRESSIONS + MBW_MD.PRIMARY_AQH) * MBW_MDD.SPOTS * 1.000
				ELSE 0.00
			END) WEEK13_PRIMARY_GROSS_IMPRESSIONS
		,SUM(CASE 
				WHEN (BL.BucketSlot = 0) THEN (MBW_MD.PRIMARY_IMPRESSIONS + MBW_MD.PRIMARY_AQH) * MBW_MDD.SPOTS * 1.000
				ELSE 0.00
			END) WEEK14_PRIMARY_GROSS_IMPRESSIONS




		,SUM(CASE 
				WHEN (BL.BucketSlot = 1) THEN (MBW_MD.SECONDARY_IMPRESSIONS + MBW_MD.SECONDARY_AQH) * MBW_MDD.SPOTS * 1.000
				ELSE 0.00
			END) WEEK1_SECONDARY_GROSS_IMPRESSIONS
		,SUM(CASE 
				WHEN (BL.BucketSlot = 2) THEN (MBW_MD.SECONDARY_IMPRESSIONS + MBW_MD.SECONDARY_AQH) * MBW_MDD.SPOTS * 1.000
				ELSE 0.00
			END) WEEK2_SECONDARY_GROSS_IMPRESSIONS
		,SUM(CASE 
				WHEN (BL.BucketSlot = 3) THEN (MBW_MD.SECONDARY_IMPRESSIONS + MBW_MD.SECONDARY_AQH) * MBW_MDD.SPOTS * 1.000
				ELSE 0.00
			END) WEEK3_SECONDARY_GROSS_IMPRESSIONS
		,SUM(CASE 
				WHEN (BL.BucketSlot = 4) THEN (MBW_MD.SECONDARY_IMPRESSIONS + MBW_MD.SECONDARY_AQH) * MBW_MDD.SPOTS * 1.000
				ELSE 0.00
			END) WEEK4_SECONDARY_GROSS_IMPRESSIONS
		,SUM(CASE 
				WHEN (BL.BucketSlot = 5) THEN (MBW_MD.SECONDARY_IMPRESSIONS + MBW_MD.SECONDARY_AQH) * MBW_MDD.SPOTS * 1.000
				ELSE 0.00
			END) WEEK5_SECONDARY_GROSS_IMPRESSIONS
		,SUM(CASE 
				WHEN (BL.BucketSlot = 6) THEN (MBW_MD.SECONDARY_IMPRESSIONS + MBW_MD.SECONDARY_AQH) * MBW_MDD.SPOTS * 1.000
				ELSE 0.00
			END) WEEK6_SECONDARY_GROSS_IMPRESSIONS
		,SUM(CASE 
				WHEN (BL.BucketSlot = 7) THEN (MBW_MD.SECONDARY_IMPRESSIONS + MBW_MD.SECONDARY_AQH) * MBW_MDD.SPOTS * 1.000
				ELSE 0.00
			END) WEEK7_SECONDARY_GROSS_IMPRESSIONS
		,SUM(CASE 
				WHEN (BL.BucketSlot = 8) THEN (MBW_MD.SECONDARY_IMPRESSIONS + MBW_MD.SECONDARY_AQH) * MBW_MDD.SPOTS * 1.000
				ELSE 0.00
			END) WEEK8_SECONDARY_GROSS_IMPRESSIONS
		,SUM(CASE 
				WHEN (BL.BucketSlot = 9) THEN (MBW_MD.SECONDARY_IMPRESSIONS + MBW_MD.SECONDARY_AQH) * MBW_MDD.SPOTS * 1.000
				ELSE 0.00
			END) WEEK9_SECONDARY_GROSS_IMPRESSIONS
		,SUM(CASE 
				WHEN (BL.BucketSlot = 10) THEN (MBW_MD.SECONDARY_IMPRESSIONS + MBW_MD.SECONDARY_AQH) * MBW_MDD.SPOTS * 1.000
				ELSE 0.00
			END) WEEK10_SECONDARY_GROSS_IMPRESSIONS
		,SUM(CASE 
				WHEN (BL.BucketSlot = 11) THEN (MBW_MD.SECONDARY_IMPRESSIONS + MBW_MD.SECONDARY_AQH) * MBW_MDD.SPOTS * 1.000
				ELSE 0.00
			END) WEEK11_SECONDARY_GROSS_IMPRESSIONS
		,SUM(CASE 
				WHEN (BL.BucketSlot = 12) THEN (MBW_MD.SECONDARY_IMPRESSIONS + MBW_MD.SECONDARY_AQH) * MBW_MDD.SPOTS * 1.000
				ELSE 0.00
			END) WEEK12_SECONDARY_GROSS_IMPRESSIONS
		,SUM(CASE 
				WHEN (BL.BucketSlot = 13) THEN (MBW_MD.SECONDARY_IMPRESSIONS + MBW_MD.SECONDARY_AQH) * MBW_MDD.SPOTS * 1.000
				ELSE 0.00
			END) WEEK13_SECONDARY_GROSS_IMPRESSIONS
		,SUM(CASE 
				WHEN (BL.BucketSlot = 0) THEN (MBW_MD.SECONDARY_IMPRESSIONS + MBW_MD.SECONDARY_AQH) * MBW_MDD.SPOTS * 1.000
				ELSE 0.00
			END) WEEK14_SECONDARY_GROSS_IMPRESSIONS


		,SUM(CASE 
			WHEN (BL.BucketSlot = 1) THEN (MBW_MD.PRIMARY_RATING + MBW_MD.PRIMARY_AQH_RATING) * MBW_MDD.RATE * @NET_COST
			ELSE 0.0 
		END) WEEK1_PRIMARY_CPP
		,SUM(CASE 
			WHEN (BL.BucketSlot = 2) THEN (MBW_MD.PRIMARY_RATING + MBW_MD.PRIMARY_AQH_RATING) * MBW_MDD.RATE * @NET_COST
			ELSE 0.0 
		END) WEEK2_PRIMARY_CPP
		,SUM(CASE 
			WHEN (BL.BucketSlot = 3) THEN (MBW_MD.PRIMARY_RATING + MBW_MD.PRIMARY_AQH_RATING) * MBW_MDD.RATE * @NET_COST
			ELSE 0.0 
		END) WEEK3_PRIMARY_CPP
		,SUM(CASE 
			WHEN (BL.BucketSlot = 4) THEN (MBW_MD.PRIMARY_RATING + MBW_MD.PRIMARY_AQH_RATING) * MBW_MDD.RATE * @NET_COST
			ELSE 0.0 
		END) WEEK4_PRIMARY_CPP
		,SUM(CASE 
			WHEN (BL.BucketSlot = 5) THEN (MBW_MD.PRIMARY_RATING + MBW_MD.PRIMARY_AQH_RATING) * MBW_MDD.RATE * @NET_COST
			ELSE 0.0 
		END) WEEK5_PRIMARY_CPP
		,SUM(CASE 
			WHEN (BL.BucketSlot = 6) THEN (MBW_MD.PRIMARY_RATING + MBW_MD.PRIMARY_AQH_RATING) * MBW_MDD.RATE * @NET_COST
			ELSE 0.0 
		END) WEEK6_PRIMARY_CPP
		,SUM(CASE 
			WHEN (BL.BucketSlot = 7) THEN (MBW_MD.PRIMARY_RATING + MBW_MD.PRIMARY_AQH_RATING) * MBW_MDD.RATE * @NET_COST
			ELSE 0.0 
		END) WEEK7_PRIMARY_CPP
		,SUM(CASE 
			WHEN (BL.BucketSlot = 8) THEN (MBW_MD.PRIMARY_RATING + MBW_MD.PRIMARY_AQH_RATING) * MBW_MDD.RATE * @NET_COST
			ELSE 0.0 
		END) WEEK8_PRIMARY_CPP
		,SUM(CASE 
			WHEN (BL.BucketSlot = 9) THEN (MBW_MD.PRIMARY_RATING + MBW_MD.PRIMARY_AQH_RATING) * MBW_MDD.RATE * @NET_COST
			ELSE 0.0 
		END) WEEK9_PRIMARY_CPP
		,SUM(CASE 
			WHEN (BL.BucketSlot = 10) THEN (MBW_MD.PRIMARY_RATING + MBW_MD.PRIMARY_AQH_RATING) * MBW_MDD.RATE * @NET_COST
			ELSE 0.0 
		END) WEEK10_PRIMARY_CPP
		,SUM(CASE 
			WHEN (BL.BucketSlot = 11) THEN (MBW_MD.PRIMARY_RATING + MBW_MD.PRIMARY_AQH_RATING) * MBW_MDD.RATE * @NET_COST
			ELSE 0.0 
		END) WEEK11_PRIMARY_CPP
		,SUM(CASE 
			WHEN (BL.BucketSlot = 12) THEN (MBW_MD.PRIMARY_RATING + MBW_MD.PRIMARY_AQH_RATING) * MBW_MDD.RATE * @NET_COST
			ELSE 0.0 
		END) WEEK12_PRIMARY_CPP
		,SUM(CASE 
			WHEN (BL.BucketSlot = 13) THEN (MBW_MD.PRIMARY_RATING + MBW_MD.PRIMARY_AQH_RATING) * MBW_MDD.RATE * @NET_COST
			ELSE 0.0 
		END) WEEK13_PRIMARY_CPP
		,SUM(CASE 
			WHEN (BL.BucketSlot = 0) THEN (MBW_MD.PRIMARY_RATING + MBW_MD.PRIMARY_AQH_RATING) * MBW_MDD.RATE * @NET_COST
			ELSE 0.0 
		END) WEEK14_PRIMARY_CPP
	INTO #LineItems
	FROM
		MEDIA_BROADCAST_WORKSHEET MBW WITH (NOLOCK)
			LEFT JOIN [dbo].[DIVISION] DIV WITH (NOLOCK)
				ON MBW.CL_CODE = DIV.CL_CODE
					AND MBW.DIV_CODE = DIV.DIV_CODE
			LEFT OUTER JOIN [dbo].[MEDIA_DEMO] M_D WITH (NOLOCK)
				ON MBW.PRIMARY_MEDIA_DEMO_ID = M_D.MEDIA_DEMO_ID
			INNER JOIN MEDIA_BROADCAST_WORKSHEET_MARKET MBW_M WITH (NOLOCK)
				ON MBW.MEDIA_BROADCAST_WORKSHEET_ID = MBW_M.MEDIA_BROADCAST_WORKSHEET_ID
				INNER JOIN #HeaderLineTable HLT
					ON HLT.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = MBW_M.MEDIA_BROADCAST_WORKSHEET_MARKET_ID
			INNER JOIN MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL MBW_MD WITH (NOLOCK)
				ON MBW_M.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = MBW_MD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID
			INNER JOIN #VendorFilterTable VFT
				ON MBW_MD.VN_CODE = VFT.VN_CODE
			LEFT JOIN @MaxOrderNumber MAXORD
				ON MBW_MD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID = MAXORD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID
			INNER JOIN (SELECT 
							MEDIA_BROADCAST_WORKSHEET_MARKET_ID, REVISION_NUMBER = MAX(REVISION_NUMBER) 
						FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL WITH (NOLOCK)
						GROUP BY MEDIA_BROADCAST_WORKSHEET_MARKET_ID) AS MMB_WM 
							ON MMB_WM.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = MBW_MD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID AND MBW_MD.REVISION_NUMBER = MMB_WM.REVISION_NUMBER
			INNER JOIN MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_DATE MBW_MDD WITH (NOLOCK)
				ON MBW_MD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID = MBW_MDD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID
			INNER JOIN @BucketList BL
				ON MBW_MDD.DATE BETWEEN BL.BucketBeginDate AND BL.BucketEndDate
					AND MBW_M.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = BL.WorksheetMarketID
			LEFT JOIN [dbo].[DAY_PART] DP WITH (NOLOCK)
				ON MBW_MD.DAY_PART_ID = DP.DAY_PART_ID
			LEFT JOIN MEDIA_DEMO SM_D WITH (NOLOCK)
				ON MBW_M.SECONDARY_MEDIA_DEMO_ID = SM_D.MEDIA_DEMO_ID
	
	WHERE (1=1)
		AND (MBW_MDD.DATE BETWEEN HLT.START_DATE and HLT.END_DATE)
	GROUP BY
		MBW.MEDIA_TYPE_CODE
		,MBW.CL_CODE
		,MBW.IS_GROSS
		,MBW.DIV_CODE
		,MBW.PRD_CODE

		,DIV.DIV_NAME
		,M_D.DESCRIPTION
		,SM_D.DESCRIPTION

		,MBW_M.IS_CABLE
		,MBW_M.MEDIA_BROADCAST_WORKSHEET_MARKET_ID

		,MBW.MEDIA_TYPE_CODE
		,MBW_MD.REVISION_NUMBER
		,MBW_MD.LINE_NUMBER
		,MBW_MD.COMMENTS
		,MBW_MD.BOOKEND
		,MBW_MD.VALUE_ADDED
		,MBW_MD.MAKEGOOD_NUMBER
		,MBW_MD.DAYS
		,MBW_MD.START_TIME
		,MBW_MD.END_TIME
		,MBW_MD.VN_CODE
		,MBW_MD.CABLE_NETWORK_STATION_CODE
		,MBW_MD.PROGRAM
		,MBW_MD.LENGTH
		,MBW_MD.PRIMARY_RATING
		,MBW_MD.PRIMARY_AQH_RATING
		,MBW_MD.PRIMARY_IMPRESSIONS
		,MBW_MD.PRIMARY_AQH
		,MBW_MD.PRIMARY_CPP
		,MBW_MD.PRIMARY_CPM
		,MBW_MD.PRIMARY_GRP
		,MBW_MD.SECONDARY_RATING
		,MBW_MD.SECONDARY_AQH_RATING
		,MBW_MD.SECONDARY_IMPRESSIONS
		,MBW_MD.SECONDARY_AQH
		,MBW_MD.SECONDARY_CPP
		,MBW_MD.SECONDARY_CPM
		,MBW_MD.SECONDARY_GRP

		,MAXORD.ORDER_NBR

		,DP.DAY_PART_CODE
		,DP.DESCRIPTION

		,MBW_MDD.RATE
		,MBW_MDD.SPOTS

		,BL.BucketRow
		,BL.BucketSlot
		,BL.BucketLastRow
		,BL.BucketBeginDate

	CREATE INDEX LineItems ON #LineItems (MEDIA_BROADCAST_WORKSHEET_MARKET_ID,VendorCode)

	IF (@Debug = 1)
		BEGIN
			--SELECT * FROM #HeaderLineTable
			--SELECT * FROM @Dates
			--SELECT * FROM @BucketList
			--SELECT * FROM #VendorFilterTable
			SELECT * FROM @StationGross
			--SELECT * FROM @MaxOrderNumber
			--SELECT * FROM #LineItems WHERE WEEK1_DATE = '06/25/2018'
		END

	SELECT
		RDD.CL_CODE
		,RDD.DIV_CODE
		,RDD.PRD_CODE
		,RDD.IS_GROSS [IsGross]
		,RH.PageHeaderComment
		,RH.PageHeaderLogoPathLand
		,RDD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID	[MediaBroadcastWorksheetMarketID]
		,RDD.BuyRevision
		,CASE 
			WHEN (RDD.BuyOrder > '') THEN RDD.BuyOrder
			ELSE 'Unordered'
		 END								BuyOrder
		,RDD.ORDER_NBR
		,RDD.Rate
		,RH.VendorCode			
		,RH.VendorName	
		,RDD.LINE_NUMBER		[LineNumber]
		,RDD.MAKEGOOD_NUMBER	[MakeGoodNumber]
		,RDD.Comments
		,RDD.IsBookend
		,RDD.IsAddedValue
		,RDD.DAYS
		,RDD.BucketRow
		,RDD.BucketLastRow
		
		,RH.[ClientName]
		,RH.[WorksheetName]
		,RH.[HeaderBand]
		,RH.[Media]
		,RH.[Product]
		,RH.MARKET_DESC   [Market]
		,RH.[PrimaryDemographic]
		,RH.[EstimateComments]
		,RH.[Description]
		,RH.[StartDate]
		,RH.[EndDate]
		,RH.[Survey]
		,RH.[SurveyLine2]
		,RH.[Buyer]
				
		,RH.[VendorAddress1]
		,RH.[VendorAddress2]
		,RH.[VendorAddress3]
		,RH.VendorAddressCity	[VendorCity]
		,RH.VendorAddressState	[VendorState]
		,RH.VendorAddressZip	[VendorZip]
		,RH.[VendorPhone]
		,RH.[VendorPhoneExtension]
		,RH.[VendorFax]
		,RH.[VendorFaxExtension]
		,RH.[VendorCode]
		,RH.[BuyOrder]
		,RH.[BillingName]
		,RH.[BillingAddress1]
		,RH.[BillingAddress2]
		,RH.BillingAddressCity		[BillingCity]
		,RH.BillingAddressState		[BillingState]
		,RH.BillingAddressZip		[BillingZip]
		,RH.[BillingPhone]
		,RH.[BillingPhoneExtension]
		,RH.[BillingFax]
		,RH.[BillingFaxExtension]
		,RH.[DivisionName]
		,RH.[RatingsServiceID]
		,RH.[SharebookNielsenTVBookID]
		,RH.[HutputNielsenTVBookID]
		,RH.[RadioBookID1]
		,RH.[RadioBookID2]
		,RH.[RadioBookID3]
		,RH.[RadioBookID4]
		,RH.[RadioBookID5]
		,RH.[TRSource1]
		,RH.[TRSource2]
		,RDD.DayPartName
		,RDD.ProgramName
		,RDD.CableNetwork
		,RH.[IsCable]
		,RH.[MediaTypeCode]
		,RH.RadioSource

		

		,CASE 
			WHEN (RH.UsePrimaryDemo = 1) THEN RDD.DEMO_GROUP1_NAME
			ELSE RDD.DEMO_GROUP2_NAME
		 END									[DemographicGroupName]

		,CASE
			WHEN (RH.UsePrimaryDemo = 1) THEN RDD.DEMO_GROUP1_RTG
			ELSE RDD.DEMO_GROUP2_RTG
		 END									[DemographicGroupRTG]

		,CASE
			WHEN (RH.UsePrimaryDemo = 1) THEN RDD.DEMO_GROUP1_IMP
			ELSE RDD.DEMO_GROUP2_IMP
		END										[DemographicGroupIMP]
		
		,CASE
			WHEN (RH.UsePrimaryDemo = 1) THEN RDD.DEMO_GROUP1_CPP * @NET_COST
			ELSE RDD.DEMO_GROUP2_CPP * @NET_COST
		 END									[DemographicGroupCPP]

		,CASE 
			WHEN (RH.UsePrimaryDemo = 1) THEN RDD.DEMO_GROUP1_CPM
			ELSE RDD.DEMO_GROUP2_CPM
		 END									[DemographicGroupCPM]

		,CASE 
			WHEN (RH.UsePrimaryDemo = 1) THEN RDD.DEMO_GROUP1_GRP
			ELSE RDD.DEMO_GROUP2_GRP			
		 END									[DemographicGroupGRP]

		,CONVERT(INT, RDD.[LENGTH])				[Length]

		
		,SG.StationGross						[StationGross]

		,MAX(RDD.WEEK1_DATE) Week1Date
		,MAX(RDD.WEEK2_DATE) Week2Date
		,MAX(RDD.WEEK3_DATE) Week3Date
		,MAX(RDD.WEEK4_DATE) Week4Date
		,MAX(RDD.WEEK5_DATE) Week5Date
		,MAX(RDD.WEEK6_DATE) Week6Date
		,MAX(RDD.WEEK7_DATE) Week7Date
		,MAX(RDD.WEEK8_DATE) Week8Date
		,MAX(RDD.WEEK9_DATE) Week9Date
		,MAX(RDD.WEEK10_DATE) Week10Date
		,MAX(RDD.WEEK11_DATE) Week11Date
		,MAX(RDD.WEEK12_DATE) Week12Date
		,MAX(RDD.WEEK13_DATE) Week13Date
		,MAX(RDD.WEEK14_DATE) Week14Date

		,SUM(RDD.WEEK1_SPOTS) Week1Spots
		,SUM(RDD.WEEK2_SPOTS) Week2Spots
		,SUM(RDD.WEEK3_SPOTS) Week3Spots
		,SUM(RDD.WEEK4_SPOTS) Week4Spots
		,SUM(RDD.WEEK5_SPOTS) Week5Spots
		,SUM(RDD.WEEK6_SPOTS) Week6Spots
		,SUM(RDD.WEEK7_SPOTS) Week7Spots
		,SUM(RDD.WEEK8_SPOTS) Week8Spots
		,SUM(RDD.WEEK9_SPOTS) Week9Spots
		,SUM(RDD.WEEK10_SPOTS) Week10Spots
		,SUM(RDD.WEEK11_SPOTS) Week11Spots
		,SUM(RDD.WEEK12_SPOTS) Week12Spots
		,SUM(RDD.WEEK13_SPOTS) Week13Spots
		,SUM(RDD.WEEK14_SPOTS) Week14Spots

		,(SUM(RDD.WEEK1_SPOTS) 
		 + SUM(RDD.WEEK2_SPOTS) 
		 + SUM(RDD.WEEK3_SPOTS) 
		 + SUM(RDD.WEEK4_SPOTS)
		 + SUM(RDD.WEEK5_SPOTS) 
		 + SUM(RDD.WEEK6_SPOTS) 
		 + SUM(RDD.WEEK7_SPOTS) 
		 + SUM(RDD.WEEK8_SPOTS) 
		 + SUM(RDD.WEEK9_SPOTS) 
		 + SUM(RDD.WEEK10_SPOTS) 
		 + SUM(RDD.WEEK11_SPOTS) 
		 + SUM(RDD.WEEK12_SPOTS) 
		 + SUM(RDD.WEEK13_SPOTS) 
		 + SUM(RDD.WEEK14_SPOTS)) TotalSpots
		

		,CASE 
			WHEN (RH.UsePrimaryDemo = 1) THEN SUM(RDD.WEEK1_PRIMARY_GRP)
			ELSE SUM(RDD.WEEK1_SECONDARY_GRP)
		END	Week1PrimaryGRP

		,CASE 
			WHEN (RH.UsePrimaryDemo = 1) THEN SUM(RDD.WEEK2_PRIMARY_GRP)
			ELSE SUM(RDD.WEEK2_SECONDARY_GRP)
		END	Week2PrimaryGRP

		,CASE 
			WHEN (RH.UsePrimaryDemo = 1) THEN SUM(RDD.WEEK3_PRIMARY_GRP)
			ELSE SUM(RDD.WEEK3_SECONDARY_GRP)
		END	Week3PrimaryGRP

		,CASE 
			WHEN (RH.UsePrimaryDemo = 1) THEN SUM(RDD.WEEK4_PRIMARY_GRP)
			ELSE SUM(RDD.WEEK4_SECONDARY_GRP)
		END	Week4PrimaryGRP

		,CASE 
			WHEN (RH.UsePrimaryDemo = 1) THEN SUM(RDD.WEEK5_PRIMARY_GRP)
			ELSE SUM(RDD.WEEK5_SECONDARY_GRP)
		END	Week5PrimaryGRP
		
		,CASE 
			WHEN (RH.UsePrimaryDemo = 1) THEN SUM(RDD.WEEK6_PRIMARY_GRP)
			ELSE SUM(RDD.WEEK6_SECONDARY_GRP)
		END	Week6PrimaryGRP

		,CASE 
			WHEN (RH.UsePrimaryDemo = 1) THEN SUM(RDD.WEEK7_PRIMARY_GRP)
			ELSE SUM(RDD.WEEK7_SECONDARY_GRP)
		END	Week7PrimaryGRP

		,CASE 
			WHEN (RH.UsePrimaryDemo = 1) THEN SUM(RDD.WEEK8_PRIMARY_GRP)
			ELSE SUM(RDD.WEEK8_SECONDARY_GRP)
		END	Week8PrimaryGRP

		,CASE 
			WHEN (RH.UsePrimaryDemo = 1) THEN SUM(RDD.WEEK9_PRIMARY_GRP)
			ELSE SUM(RDD.WEEK9_SECONDARY_GRP)
		END	Week9PrimaryGRP

		,CASE 
			WHEN (RH.UsePrimaryDemo = 1) THEN SUM(RDD.WEEK10_PRIMARY_GRP)
			ELSE SUM(RDD.WEEK10_SECONDARY_GRP)
		END	Week10PrimaryGRP

		,CASE 
			WHEN (RH.UsePrimaryDemo = 1) THEN SUM(RDD.WEEK11_PRIMARY_GRP)
			ELSE SUM(RDD.WEEK11_SECONDARY_GRP)
		END	Week11PrimaryGRP

		,CASE 
			WHEN (RH.UsePrimaryDemo = 1) THEN SUM(RDD.WEEK12_PRIMARY_GRP)
			ELSE SUM(RDD.WEEK12_SECONDARY_GRP)
		END	Week12PrimaryGRP

		,CASE 
			WHEN (RH.UsePrimaryDemo = 1) THEN SUM(RDD.WEEK13_PRIMARY_GRP)
			ELSE SUM(RDD.WEEK13_SECONDARY_GRP)
		END	Week13PrimaryGRP

		,CASE 
			WHEN (RH.UsePrimaryDemo = 1) THEN SUM(RDD.WEEK14_PRIMARY_GRP)
			ELSE SUM(RDD.WEEK14_SECONDARY_GRP)
		END	Week14PrimaryGRP


		,CASE 
			WHEN (RH.UsePrimaryDemo = 1) THEN SUM(RDD.TOTAL_PRIMARY_GRP)
			ELSE SUM(RDD.TOTAL_SECONDARY_GRP)
		END	TotalGrp
		
		,CASE 
			WHEN (RH.UsePrimaryDemo = 1) THEN SUM(RDD.WEEK1_PRIMARY_GROSS_IMPRESSIONS)
			ELSE SUM(RDD.WEEK1_SECONDARY_GROSS_IMPRESSIONS)
		 END												[Week1PrimaryGrossImpressions]
		,CASE 
			WHEN (RH.UsePrimaryDemo = 1) THEN SUM(RDD.WEEK2_PRIMARY_GROSS_IMPRESSIONS)
			ELSE SUM(RDD.WEEK2_SECONDARY_GROSS_IMPRESSIONS)
		 END												[Week2PrimaryGrossImpressions]
		,CASE 
			WHEN (RH.UsePrimaryDemo = 1) THEN SUM(RDD.WEEK3_PRIMARY_GROSS_IMPRESSIONS)
			ELSE SUM(RDD.WEEK3_SECONDARY_GROSS_IMPRESSIONS)
		 END												[Week3PrimaryGrossImpressions]
		,CASE 
			WHEN (RH.UsePrimaryDemo = 1) THEN SUM(RDD.WEEK4_PRIMARY_GROSS_IMPRESSIONS)
			ELSE SUM(RDD.WEEK4_SECONDARY_GROSS_IMPRESSIONS)
		 END												[Week4PrimaryGrossImpressions]
		,CASE 
			WHEN (RH.UsePrimaryDemo = 1) THEN SUM(RDD.WEEK5_PRIMARY_GROSS_IMPRESSIONS)
			ELSE SUM(RDD.WEEK5_SECONDARY_GROSS_IMPRESSIONS)
		 END												[Week5PrimaryGrossImpressions]
		,CASE 
			WHEN (RH.UsePrimaryDemo = 1) THEN SUM(RDD.WEEK6_PRIMARY_GROSS_IMPRESSIONS)
			ELSE SUM(RDD.WEEK6_SECONDARY_GROSS_IMPRESSIONS)
		 END												[Week6PrimaryGrossImpressions]
		,CASE 
			WHEN (RH.UsePrimaryDemo = 1) THEN SUM(RDD.WEEK7_PRIMARY_GROSS_IMPRESSIONS)
			ELSE SUM(RDD.WEEK7_SECONDARY_GROSS_IMPRESSIONS)
		 END												[Week7PrimaryGrossImpressions]
		,CASE 
			WHEN (RH.UsePrimaryDemo = 1) THEN SUM(RDD.WEEK8_PRIMARY_GROSS_IMPRESSIONS)
			ELSE SUM(RDD.WEEK8_SECONDARY_GROSS_IMPRESSIONS)
		 END												[Week8PrimaryGrossImpressions]
		,CASE 
			WHEN (RH.UsePrimaryDemo = 1) THEN SUM(RDD.WEEK9_PRIMARY_GROSS_IMPRESSIONS)
			ELSE SUM(RDD.WEEK9_SECONDARY_GROSS_IMPRESSIONS)
		 END												[Week9PrimaryGrossImpressions]
		,CASE 
			WHEN (RH.UsePrimaryDemo = 1) THEN SUM(RDD.WEEK10_PRIMARY_GROSS_IMPRESSIONS)
			ELSE SUM(RDD.WEEK10_SECONDARY_GROSS_IMPRESSIONS)
		 END												[Week10PrimaryGrossImpressions]
		,CASE 
			WHEN (RH.UsePrimaryDemo = 1) THEN SUM(RDD.WEEK11_PRIMARY_GROSS_IMPRESSIONS)
			ELSE SUM(RDD.WEEK11_SECONDARY_GROSS_IMPRESSIONS)
		 END												[Week11PrimaryGrossImpressions]
		,CASE 
			WHEN (RH.UsePrimaryDemo = 1) THEN SUM(RDD.WEEK12_PRIMARY_GROSS_IMPRESSIONS)
			ELSE SUM(RDD.WEEK12_SECONDARY_GROSS_IMPRESSIONS)
		 END												[Week12PrimaryGrossImpressions]
		,CASE 
			WHEN (RH.UsePrimaryDemo = 1) THEN SUM(RDD.WEEK13_PRIMARY_GROSS_IMPRESSIONS)
			ELSE SUM(RDD.WEEK13_SECONDARY_GROSS_IMPRESSIONS)
		 END												[Week13PrimaryGrossImpressions]
		,CASE 
			WHEN (RH.UsePrimaryDemo = 1) THEN SUM(RDD.WEEK14_PRIMARY_GROSS_IMPRESSIONS)
			ELSE SUM(RDD.WEEK14_SECONDARY_GROSS_IMPRESSIONS)
		 END												[Week14PrimaryGrossImpressions]

		

		, CASE
			WHEN (RH.UsePrimaryDemo = 1) THEN
				SUM(RDD.PRIMARY_GROSS_IMPRESSIONS * 1.000)
			ELSE
				SUM(RDD.SECONDARY_GROSS_IMPRESSIONS* 1.000)
		  END							TotalGIMP

		,SUM( RDD.WEEK1_PRIMARY_CPP)		[Week1PrimaryCPP]
		,SUM(RDD.WEEK2_PRIMARY_CPP)		[Week2PrimaryCPP]
		,SUM(RDD.WEEK3_PRIMARY_CPP)		[Week3PrimaryCPP]
		,SUM(RDD.WEEK4_PRIMARY_CPP)		[Week4PrimaryCPP]
		,SUM(RDD.WEEK5_PRIMARY_CPP)		[Week5PrimaryCPP]
		,SUM(RDD.WEEK6_PRIMARY_CPP)		[Week6PrimaryCPP]
		,SUM(RDD.WEEK7_PRIMARY_CPP)		[Week7PrimaryCPP]
		,SUM(RDD.WEEK8_PRIMARY_CPP)		[Week8PrimaryCPP]
		,SUM(RDD.WEEK9_PRIMARY_CPP)		[Week9PrimaryCPP]
		,SUM(RDD.WEEK10_PRIMARY_CPP)		[Week10PrimaryCPP]
		,SUM(RDD.WEEK11_PRIMARY_CPP)		[Week11PrimaryCPP]
		,SUM(RDD.WEEK12_PRIMARY_CPP)		[Week12PrimaryCPP]
		,SUM(RDD.WEEK13_PRIMARY_CPP)		[Week13PrimaryCPP]
		,SUM(RDD.WEEK14_PRIMARY_CPP)		[Week14PrimaryCPP]

		,SUM(RDD.WEEK1_PRIMARY_CPM)		[Week1PrimaryCPM]
		,SUM(RDD.WEEK2_PRIMARY_CPM)		[Week2PrimaryCPM]
		,SUM(RDD.WEEK3_PRIMARY_CPM)		[Week3PrimaryCPM]
		,SUM(RDD.WEEK4_PRIMARY_CPM)		[Week4PrimaryCPM]
		,SUM(RDD.WEEK5_PRIMARY_CPM)		[Week5PrimaryCPM]
		,SUM(RDD.WEEK6_PRIMARY_CPM)		[Week6PrimaryCPM]
		,SUM(RDD.WEEK7_PRIMARY_CPM)		[Week7PrimaryCPM]
		,SUM(RDD.WEEK8_PRIMARY_CPM)		[Week8PrimaryCPM]
		,SUM(RDD.WEEK9_PRIMARY_CPM)		[Week9PrimaryCPM]
		,SUM(RDD.WEEK10_PRIMARY_CPM)		[Week10PrimaryCPM]
		,SUM(RDD.WEEK11_PRIMARY_CPM)		[Week11PrimaryCPM]
		,SUM(RDD.WEEK12_PRIMARY_CPM)		[Week12PrimaryCPM]
		,SUM(RDD.WEEK13_PRIMARY_CPM)		[Week13PrimaryCPM]
		,SUM(RDD.WEEK14_PRIMARY_CPM)		[Week14PrimaryCPM]

		,SUM(RDD.WEEK1_COSTS) [Week1Costs]
		,SUM(RDD.WEEK2_COSTS) [Week2Costs]
		,SUM(RDD.WEEK3_COSTS) [Week3Costs]
		,SUM(RDD.WEEK4_COSTS) [Week4Costs]
		,SUM(RDD.WEEK5_COSTS) [Week5Costs]
		,SUM(RDD.WEEK6_COSTS) [Week6Costs]
		,SUM(RDD.WEEK7_COSTS) [Week7Costs]
		,SUM(RDD.WEEK8_COSTS) [Week8Costs]
		,SUM(RDD.WEEK9_COSTS) [Week9Costs]
		,SUM(RDD.WEEK10_COSTS) [Week10Costs]
		,SUM(RDD.WEEK11_COSTS) [Week11Costs]
		,SUM(RDD.WEEK12_COSTS) [Week12Costs]
		,SUM(RDD.WEEK13_COSTS) [Week13Costs]
		,SUM(RDD.WEEK14_COSTS) [Week14Costs]
	FROM
		dbo.advtf_media_broadcast_schedule_header(@MEDIA_BROADCAST_WORKSHEET_MARKET_ID,@USE_PRIMARY_DEMO, @HEADER, @LOCATION_NAME, @VENDOR_FILTER) RH
		INNER JOIN #LineItems RDD
		ON RH.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = RDD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID
			AND RH.VendorCode = RDD.VendorCode
		INNER JOIN @StationGross SG
			ON RH.MEDIA_BROADCAST_WORKSHEET_ID = SG.MEDIA_BROADCAST_WORKSHEET_ID
				AND RDD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = SG.MEDIA_BROADCAST_WORKSHEET_MARKET_ID
				AND RH.VendorCode = SG.VN_CODE
				AND RDD.BucketRow = SG.BucketRow
				AND RDD.LINE_NUMBER = SG.LINE_NUMBER
				AND RDD.MAKEGOOD_NUMBER = SG.MAKEGOOD_NUMBER
				AND RDD.Rate = SG.RATE
	GROUP BY
		RH.UsePrimaryDemo
		,RDD.CL_CODE
		,RDD.DIV_CODE
		,RDD.PRD_CODE
		,RDD.IS_GROSS
		,RH.PageHeaderComment
		,RH.PageHeaderLogoPathLand
		,RDD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID
		,RDD.BuyRevision
		,RDD.BuyOrder
		,RDD.ORDER_NBR
		,RDD.Rate
		,RH.VendorCode			
		,RH.VendorName
		,RDD.LINE_NUMBER
		,RDD.MAKEGOOD_NUMBER
		,RDD.Comments
		,RDD.IsBookend
		,RDD.IsAddedValue
		,RDD.DAYS
		
		,RDD.BucketRow
		,RDD.BucketLastRow
		
		,RH.[ClientName]
		,RH.[WorksheetName]
		,RH.[HeaderBand]
		,RH.[Media]
		,RH.[Product]
		,RH.MARKET_DESC
		,RH.[PrimaryDemographic]
		,RH.[EstimateComments]
		,RH.[Description]
		,RH.[StartDate]
		,RH.[EndDate]
		,RH.[Survey]
		,RH.[SurveyLine2]
		,RH.[Buyer]	

		,RH.[VendorAddress1]
		,RH.[VendorAddress2]
		,RH.[VendorAddress3]
		,RH.VendorAddressCity	
		,RH.VendorAddressState	
		,RH.VendorAddressZip	
		,RH.[VendorPhone]
		,RH.[VendorPhoneExtension]
		,RH.[VendorFax]
		,RH.[VendorFaxExtension]
		,RH.[VendorCode]
		,RH.[BuyOrder]

		,RH.[BillingName]
		,RH.[BillingAddress1]
		,RH.[BillingAddress2]
		,RH.BillingAddressCity		
		,RH.BillingAddressState		
		,RH.BillingAddressZip		
		,RH.[BillingPhone]
		,RH.[BillingPhoneExtension]
		,RH.[BillingFax]
		,RH.[BillingFaxExtension]
		,RH.[DivisionName]
		,RH.[RatingsServiceID]
		,RH.[SharebookNielsenTVBookID]
		,RH.[HutputNielsenTVBookID]
		,RH.[RadioBookID1]
		,RH.[RadioBookID2]
		,RH.[RadioBookID3]
		,RH.[RadioBookID4]
		,RH.[RadioBookID5]
		,RH.[TRSource1]
		,RH.[TRSource2]
		,RDD.DayPartName
		,RDD.ProgramName
		,RDD.CableNetwork
		,RH.[IsCable]
		,RH.[MediaTypeCode]
		,RH.RadioSource

		,RDD.DEMO_GROUP1_NAME					
		,RDD.DEMO_GROUP1_RTG					
		,RDD.DEMO_GROUP1_IMP					
		
		,RDD.DEMO_GROUP1_CPP					
		,RDD.DEMO_GROUP1_CPM					
		,RDD.DEMO_GROUP1_GRP					

		,RDD.DEMO_GROUP2_NAME					
		,RDD.DEMO_GROUP2_RTG					
		,RDD.DEMO_GROUP2_IMP					
		
		,RDD.DEMO_GROUP2_CPP					
		,RDD.DEMO_GROUP2_CPM					
		,RDD.DEMO_GROUP2_GRP	

		,SG.StationGross
		,RDD.[LENGTH]				
	ORDER BY 
		RH.MARKET_DESC		
		,RH.VendorCode
		,RDD.BucketRow
		,RDD.LINE_NUMBER
		,RDD.MAKEGOOD_NUMBER
		,RDD.Rate

END
GO