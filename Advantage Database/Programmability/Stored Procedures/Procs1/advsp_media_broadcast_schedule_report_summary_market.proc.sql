CREATE PROCEDURE [dbo].[advsp_media_broadcast_schedule_report_summary_market] 
	@MEDIA_BROADCAST_WORKSHEET_MARKET_ID	VARCHAR(MAX) = '1'
	,@START_YEAR_MONTH						VARCHAR(10) = ''
	,@END_YEAR_MONTH						VARCHAR(10) = ''
	,@USE_PRIMARY_DEMO						VARCHAR(10) = ''
	,@HEADER								VARCHAR(100) = ''
	,@LOCATION_NAME							VARCHAR(100) = ''
	,@VENDOR_FILTER							VARCHAR(MAX) = ''
	,@NET_COST_INT							INT
AS
BEGIN

	SET NOCOUNT ON;
	DECLARE @Debug INT = 0
	DECLARE @NET_COST DECIMAL(18,3) = 1.00

	IF (@NET_COST_INT <> 100)
		SET @NET_COST = (@NET_COST_INT * 1.00)/100.00

	DECLARE @Today DATE = GETDATE()
	
	CREATE TABLE #VendorFilterTable (VN_CODE VARCHAR(20) COLLATE SQL_Latin1_General_CP1_CS_AS)

	CREATE UNIQUE INDEX VendorFilterTable_MarketID ON #VendorFilterTable (VN_CODE)

	CREATE TABLE #HeaderLineTable (
		MEDIA_BROADCAST_WORKSHEET_MARKET_ID INT
		,START_DATE							DATE
		,END_DATE							DATE
	)

	CREATE UNIQUE INDEX HeaderLineTable_MarketID ON #HeaderLineTable (MEDIA_BROADCAST_WORKSHEET_MARKET_ID)

	DECLARE @START_DATE DATE
	DECLARE @END_DATE	DATE
	DECLARE @PRIMARY_DEMO INT

	IF (@START_YEAR_MONTH IS NOT NULL)
		SET @START_DATE = CONVERT(DATE,CONVERT(VARCHAR,(CONVERT(INT,@START_YEAR_MONTH) % 100))+'/01/'+CONVERT(VARCHAR,(CONVERT(INT,@START_YEAR_MONTH) / 100)))
	ELSE
		SET @START_DATE = NULL
	
	IF (@END_YEAR_MONTH IS NOT NULL)
		SET @END_DATE = DATEADD(DAY,-1,DATEADD(MONTH,1,CONVERT(DATE,CONVERT(VARCHAR,(CONVERT(INT,@END_YEAR_MONTH) % 100))+'/01/'+CONVERT(VARCHAR,(CONVERT(INT,@END_YEAR_MONTH) / 100)))))
	ELSE
		SET @END_DATE = NULL
	
	IF (@USE_PRIMARY_DEMO IS NOT NULL)
		SET @PRIMARY_DEMO = 1
	ELSE
		SET @PRIMARY_DEMO = 0

	INSERT INTO #HeaderLineTable 
	SELECT 
		WORKSHEET.vint [MEDIA_BROADCAST_WORKSHEET_MARKET_ID]
		,@START_DATE	[START_DATE]
		,@END_DATE		[END_DATE]
	FROM
		[dbo].[charlist_to_table_int](@MEDIA_BROADCAST_WORKSHEET_MARKET_ID,',') WORKSHEET
			

	UPDATE #HeaderLineTable
		SET
			START_DATE = [dbo].[advfn_broadcast_date](START_DATE,'B',HLT.MEDIA_BROADCAST_WORKSHEET_MARKET_ID)
			,END_DATE =  [dbo].[advfn_broadcast_date](END_DATE,'E', HLT.MEDIA_BROADCAST_WORKSHEET_MARKET_ID)
		FROM
			#HeaderLineTable HLT


	IF (LEN(@VENDOR_FILTER) = 0)
		BEGIN			
			INSERT INTO #VendorFilterTable
			SELECT DISTINCT
				MBW_MD.VN_CODE
			FROM 
				MEDIA_BROADCAST_WORKSHEET MBW WITH (NOLOCK)
					INNER JOIN MEDIA_BROADCAST_WORKSHEET_MARKET MBW_M WITH (NOLOCK)
						ON MBW.MEDIA_BROADCAST_WORKSHEET_ID = MBW.MEDIA_BROADCAST_WORKSHEET_ID
					INNER JOIN MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL MBW_MD WITH (NOLOCK)
						ON MBW_M.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = MBW_MD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID
					INNER JOIN (SELECT 
									MEDIA_BROADCAST_WORKSHEET_MARKET_ID, REVISION_NUMBER = MAX(REVISION_NUMBER) 
								FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL WITH (NOLOCK)
								GROUP BY MEDIA_BROADCAST_WORKSHEET_MARKET_ID) AS MMB_WM 
									ON MMB_WM.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = MBW_MD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID AND MBW_MD.REVISION_NUMBER = MMB_WM.REVISION_NUMBER
					INNER JOIN #HeaderLineTable HLT
						ON MBW_M.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = HLT.MEDIA_BROADCAST_WORKSHEET_MARKET_ID
			WHERE (1=1)
				AND MBW.IS_INACTIVE = 0
		END
	ELSE
		BEGIN
			INSERT INTO #VendorFilterTable
			SELECT
				VF.vstr
			FROM 
				dbo.charlist_to_table_tsa(@VENDOR_FILTER,',') VF
		END

	CREATE TABLE #TotalsTable
	(
		MEDIA_BROADCAST_WORKSHEET_MARKET_ID INT
		,MARKET_CODE						VARCHAR(100) COLLATE SQL_Latin1_General_CP1_CS_AS

		,PrimaryUniverse					BIGINT
		,PrimaryCume						BIGINT
		,PrimaryCumeImpressions				BIGINT
		,PrimaryGrossImpressions			BIGINT
		,PrimaryImpressions					BIGINT
		,PrimaryCPP							DECIMAL
		,PrimaryGRP							FLOAT

		,SecondaryUniverse					BIGINT
		,SecondaryCume						BIGINT
		,SecondaryCumeImpressions			BIGINT
		,SecondaryGrossImpressions			BIGINT
		,SecondaryImpressions				BIGINT
		,SecondaryCPP						DECIMAL
		,SecondaryGRP						FLOAT

		,Spots								INT
		,StationGross						DECIMAL(18,3)
		,Group1TotalGRP						FLOAT
		,Group2TotalGRP						FLOAT
	)

	CREATE UNIQUE INDEX TotalsTable_MarketID ON #TotalsTable (MEDIA_BROADCAST_WORKSHEET_MARKET_ID)

	INSERT INTO #TotalsTable
	SELECT
		MBW_M.MEDIA_BROADCAST_WORKSHEET_MARKET_ID
		,MBW_M.MARKET_CODE
	
		,SUM(MBW_MD.PRIMARY_UNIVERSE)
		,SUM(MBW_MD.PRIMARY_CUME)
		,SUM(MBW_MD.PRIMARY_CUME_IMPRESSIONS) 
		,CASE 
			WHEN (MBW.MEDIA_TYPE_CODE='T') THEN SUM(MBW_MDD.SPOTS * MBW_MD.PRIMARY_IMPRESSIONS)
			ELSE SUM(MBW_MDD.SPOTS * MBW_MD.PRIMARY_AQH)
		 END
		,CASE
			WHEN (MBW.MEDIA_TYPE_CODE='T') THEN SUM(MBW_MD.PRIMARY_IMPRESSIONS) 
			ELSE SUM(MBW_MD.PRIMARY_AQH) 
		 END
		,SUM(MBW_MD.PRIMARY_CPP)*1.0 
		,CASE
			WHEN (MBW.MEDIA_TYPE_CODE='T') THEN SUM(MBW_MD.PRIMARY_RATING * MBW_MDD.SPOTS * 1.000 )
			ELSE SUM(MBW_MD.PRIMARY_AQH_RATING * MBW_MDD.SPOTS * 1.000)
		 END

		,SUM(MBW_MD.SECONDARY_UNIVERSE) 
		,SUM(MBW_MD.SECONDARY_CUME) 
		,SUM(MBW_MD.SECONDARY_CUME_IMPRESSIONS) 
		,CASE 
			WHEN (MBW.MEDIA_TYPE_CODE='T') THEN SUM(MBW_MDD.SPOTS * MBW_MD.SECONDARY_IMPRESSIONS)
			ELSE SUM(MBW_MDD.SPOTS * MBW_MD.SECONDARY_AQH)
		 END
		,CASE 
			WHEN (MBW.MEDIA_TYPE_CODE='T') THEN SUM(MBW_MD.SECONDARY_IMPRESSIONS) 
			ELSE SUM(MBW_MD.SECONDARY_AQH)
		END
		,SUM(MBW_MD.SECONDARY_CPP)*1.0 
		,CASE
			WHEN (MBW.MEDIA_TYPE_CODE='T') THEN SUM(MBW_MD.SECONDARY_RATING * MBW_MDD.SPOTS * 1.000)
			ELSE SUM(MBW_MD.SECONDARY_AQH_RATING * MBW_MDD.SPOTS * 1.000 )
		 END

		,SUM(MBW_MDD.SPOTS) 
		,SUM(MBW_MDD.TOTAL)
		,SUM(MBW_MD.PRIMARY_GRP)
		,SUM(MBW_MD.SECONDARY_GRP)
	FROM
		MEDIA_BROADCAST_WORKSHEET MBW WITH (NOLOCK)
		INNER JOIN MEDIA_BROADCAST_WORKSHEET_MARKET MBW_M WITH (NOLOCK)
			ON MBW_M.MEDIA_BROADCAST_WORKSHEET_ID = MBW.MEDIA_BROADCAST_WORKSHEET_ID
		INNER JOIN MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL MBW_MD WITH (NOLOCK)
			ON MBW_MD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = MBW_M.MEDIA_BROADCAST_WORKSHEET_MARKET_ID
		INNER JOIN (SELECT 
						MEDIA_BROADCAST_WORKSHEET_MARKET_ID, REVISION_NUMBER = MAX(REVISION_NUMBER) 
					FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL WITH (NOLOCK)
					GROUP BY MEDIA_BROADCAST_WORKSHEET_MARKET_ID) AS MMB_WM 
						ON MMB_WM.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = MBW_MD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID AND MBW_MD.REVISION_NUMBER = MMB_WM.REVISION_NUMBER
		INNER JOIN #VendorFilterTable VFT
			ON MBW_MD.VN_CODE = VFT.VN_CODE
		INNER JOIN (SELECT 
						MDD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID, 
						SPOTS = SUM(MDD.SPOTS),
						TOTAL = SUM(MDD.RATE * MDD.SPOTS * @NET_COST) 
					FROM 
						dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_DATE MDD WITH (NOLOCK) 
						INNER JOIN MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL MD ON MD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID = MDD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID
						INNER JOIN #HeaderLineTable HLT ON HLT.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = MD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID
					WHERE 
						MDD.DATE BETWEEN HLT.START_DATE AND HLT.END_DATE
					GROUP BY MDD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID) AS MBW_MDD ON MBW_MDD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID = MBW_MD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID
		INNER JOIN #HeaderLineTable HLT
			ON HLT.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = MBW_M.MEDIA_BROADCAST_WORKSHEET_MARKET_ID
	WHERE (1=1)
		AND (MBW.IS_INACTIVE = 0)
		AND (MBW_MD.ON_HOLD = 0)
	GROUP BY
		MBW.MEDIA_TYPE_CODE
		,MBW_M.MEDIA_BROADCAST_WORKSHEET_MARKET_ID
		,MBW_M.MARKET_CODE

	DECLARE @SumTotalStationGross DECIMAL(18,3)
	DECLARE @SumTotalGroup1GRP FLOAT
	DECLARE @SumTotalGroup2GRP FLOAT

	SELECT
		@SumTotalStationGross = SUM(TT.StationGross)
		,@SumTotalGroup1GRP = SUM(TT.PrimaryGRP)
		,@SumTotalGroup2GRP = SUM(TT.SecondaryGRP)
	FROM #TotalsTable TT

	IF (@Debug = 1)
		BEGIN
			SELECT * FROM #HeaderLineTable
			SELECT * FROM #VendorFilterTable
			SELECT * FROM #TotalsTable
		END

	SELECT DISTINCT
		RH.MEDIA_BROADCAST_WORKSHEET_ID			
		,RH.MEDIA_BROADCAST_WORKSHEET_MARKET_ID					[MediaBroadcastWorksheetMarketID]
		--,RH.VendorCode						
		,RH.BuyOrder
		,RH.BuyRevision
		,RH.MARKET_DESC											[MarketDescription]	
		,RH.MARKET_CODE											[MarketCode]
		,RH.IsGross
		,RH.GROUP1_NAME											[Group1Name]					
		,RH.GROUP1_ID								
		,RH.GROUP2_NAME											[Group2Name]			
		,RH.GROUP2_ID								
		,RH.EstimateComments						
		,RH.Estitmate								
		,RH.Description							
		,RH.ClientName								
		,RH.WorksheetName	
		,RH.HeaderBand								
		,RH.Media									
		,RH.Product								
		,RH.Market									
		,RH.PrimaryDemographic												
		,RH.StartDate								
		,RH.EndDate												
		,RH.DivisionName							
		,RH.RatingsServiceID						
		,RH.SharebookNielsenTVBookID				
		,RH.HutputNielsenTVBookID
		,RH.RadioBookID1
		,RH.RadioBookID2							
		,RH.RadioBookID3
		,RH.RadioBookID4
		,RH.RadioBookID5
		,RH.Survey
		,RH.TRSource1
		,RH.TRSource2
		,RH.SurveyLine2
		,RH.PageHeaderComment
		,RH.PageHeaderLogoPathLand
		,RH.Buyer
		,RH.RatingsSource
		,RH.UsePrimaryDemo
		,RH.[Geography]
		,RH.MediaTypeCode
		,RH.RadioSource

		,TT.PrimaryUniverse			
		,TT.PrimaryCume				
		,TT.PrimaryCumeImpressions		
		,TT.PrimaryGrossImpressions	
		,TT.PrimaryImpressions			
		,TT.PrimaryCPP			Group1PrimaryCPP		
		,TT.PrimaryGRP			Group1PrimaryGRP			
		,TT.Group1TotalGRP
		,TT.SecondaryUniverse			
		,TT.SecondaryCume				
		,TT.SecondaryCumeImpressions	
		,TT.SecondaryGrossImpressions	
		,TT.SecondaryImpressions		
		,TT.SecondaryCPP		Group2PrimaryCPP		
		,TT.SecondaryGRP		Group2PrimaryGRP		
		,TT.Group2TotalGRP
		,TT.Spots						
		,TT.StationGross
		,CASE 
			WHEN (@SumTotalStationGross = 0) THEN 0.00
			ELSE TT.StationGross/@SumTotalStationGross
		END [Percent]

		,CASE
			WHEN (TT.PrimaryUniverse = 0) THEN 0.00
			ELSE (TT.PrimaryImpressions *1.0)/TT.PrimaryUniverse
		 END			PrimaryRating

		,CASE
			WHEN (TT.SecondaryUniverse = 0) THEN 0.00
			ELSE (TT.SecondaryImpressions * 1.0)/TT.SecondaryUniverse
		 END			SecondaryRating

		 ,CASE
			WHEN (TT.PrimaryUniverse = 0) THEN 0.00
			ELSE (TT.PrimaryUniverse * MBW_MD.BOOK_PRIMARY_RATING * 0.01)/TT.PrimaryUniverse
		  END			BookPrimaryRating

		,CASE
			WHEN (TT.SecondaryUniverse = 0) THEN 0.00
			ELSE (TT.SecondaryImpressions * MBW_MD.BOOK_SECONDARY_RATING *  0.01)/TT.SecondaryUniverse
		 END			BookSecondaryRating

		 ,CASE
			WHEN (TT.PrimaryUniverse = 0) THEN 0.00
			ELSE (TT.PrimaryUniverse * MBW_MD.BOOK_SECONDARY_AQH_RATING * 0.01)/TT.PrimaryUniverse
		  END			BookPrimaryAHQRating

		,CASE
			WHEN (TT.SecondaryUniverse = 0) THEN 0.00
			ELSE (TT.SecondaryImpressions * MBW_MD.BOOK_SECONDARY_AQH_RATING * 0.01)/TT.SecondaryUniverse
		 END			BookSecondaryAHQRating
		 ,@SumTotalGroup1GRP TotalGroup1GRP
		 ,@SumTotalGroup2GRP TotalGroup2GRP
		 ,CASE	
			WHEN (PrimaryGrossImpressions = 0) THEN 0.0
			ELSE StationGross/(PrimaryGrossImpressions * 0.001)
		  End			Group1CPM
		,CASE	
			WHEN (SecondaryGrossImpressions = 0) THEN 0.0
			ELSE StationGross/(SecondaryGrossImpressions * 0.001)
		  End			Group2CPM
 
	

	FROM 
		dbo.advtf_media_broadcast_schedule_header(@MEDIA_BROADCAST_WORKSHEET_MARKET_ID,@USE_PRIMARY_DEMO, @HEADER, @LOCATION_NAME, @VENDOR_FILTER) RH
			INNER JOIN 
				(	SELECT
						MBW_MD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID
						,MBW_MD.REVISION_NUMBER
						,SUM(MBW_MD.BOOK_PRIMARY_RATING) BOOK_PRIMARY_RATING
						,SUM(MBW_MD.BOOK_PRIMARY_AQH_RATING) BOOK_PRIMARY_AQH_RATING
						,SUM(MBW_MD.BOOK_SECONDARY_RATING) BOOK_SECONDARY_RATING
						,SUM(MBW_MD.BOOK_SECONDARY_AQH_RATING) BOOK_SECONDARY_AQH_RATING
					FROM 
						[dbo].[MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL] MBW_MD WITH (NOLOCK)
						INNER JOIN #VendorFilterTable VFT
							ON MBW_MD.VN_CODE = VFT.VN_CODE
					GROUP BY
						MBW_MD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID
						,MBW_MD.REVISION_NUMBER) MBW_MD
					ON RH.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = MBW_MD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID
			INNER JOIN (SELECT 
							MEDIA_BROADCAST_WORKSHEET_MARKET_ID, REVISION_NUMBER = MAX(REVISION_NUMBER) 
						FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL WITH (NOLOCK)
						GROUP BY MEDIA_BROADCAST_WORKSHEET_MARKET_ID) AS MMB_WM 
							ON MMB_WM.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = MBW_MD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID AND MBW_MD.REVISION_NUMBER = MMB_WM.REVISION_NUMBER
			INNER JOIN #TotalsTable TT
				ON RH.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = TT.MEDIA_BROADCAST_WORKSHEET_MARKET_ID
					AND RH.MARKET_CODE = TT.MARKET_CODE
		GROUP BY
		RH.MEDIA_BROADCAST_WORKSHEET_ID			
		,RH.MEDIA_BROADCAST_WORKSHEET_MARKET_ID
		--,RH.VendorCode
		,RH.BuyOrder
		,RH.BuyRevision	
		,RH.MARKET_DESC							
		,RH.MARKET_CODE	
		,RH.IsGross						
		,RH.GROUP1_NAME							
		,RH.GROUP1_ID								
		,RH.GROUP2_NAME							
		,RH.GROUP2_ID								
		,RH.EstimateComments						
		,RH.Estitmate								
		,RH.Description							
		,RH.ClientName	
		,RH.WorksheetName								
		,RH.HeaderBand								
		,RH.Media									
		,RH.Product								
		,RH.Market									
		,RH.PrimaryDemographic													
		,RH.StartDate								
		,RH.EndDate												
		,RH.DivisionName							
		,RH.RatingsServiceID						
		,RH.SharebookNielsenTVBookID				
		,RH.HutputNielsenTVBookID
		,RH.RadioBookID1
		,RH.RadioBookID2
		,RH.RadioBookID3
		,RH.RadioBookID4
		,RH.RadioBookID5											
		,RH.Survey
		,RH.TRSource1
		,RH.TRSource2
		,RH.SurveyLine2
		,RH.PageHeaderComment
		,RH.PageHeaderLogoPathLand
		,RH.Buyer
		,RH.RatingsSource
		,RH.UsePrimaryDemo
		,RH.MediaCode
		,RH.[Geography]
		,RH.MediaTypeCode
		,RH.RadioSource

		,TT.PrimaryUniverse			
		,TT.PrimaryCume				
		,TT.PrimaryCumeImpressions		
		,TT.PrimaryGrossImpressions	
		,TT.PrimaryImpressions			
		,TT.PrimaryCPP					
		,TT.PrimaryGRP					
		,TT.Group1TotalGRP
		,TT.SecondaryUniverse			
		,TT.SecondaryCume				
		,TT.SecondaryCumeImpressions	
		,TT.SecondaryGrossImpressions	
		,TT.SecondaryImpressions		
		,TT.SecondaryCPP				
		,TT.SecondaryGRP				
		,TT.Group2TotalGRP
		,TT.Spots						
		,TT.StationGross	
		,MBW_MD.BOOK_PRIMARY_RATING
		,MBW_MD.BOOK_PRIMARY_AQH_RATING
		,MBW_MD.BOOK_SECONDARY_RATING
		,MBW_MD.BOOK_SECONDARY_AQH_RATING
	ORDER BY
		RH.MARKET_CODE
		,RH.MARKET_DESC	
END


GO