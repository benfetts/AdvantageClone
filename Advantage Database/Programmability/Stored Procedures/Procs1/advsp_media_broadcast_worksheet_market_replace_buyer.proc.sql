CREATE PROCEDURE [dbo].[advsp_media_broadcast_worksheet_market_replace_buyer]
	@FIND_BUYER_EMP_CODE varchar(6),
	@REPLACE_BUYER_EMP_CODE varchar(6)
AS

SELECT MBWMDD.ORDER_NBR 
INTO #order_updates
FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_DATE MBWMDD
	INNER JOIN dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL MBWMD ON MBWMD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID = MBWMDD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID 
	INNER JOIN dbo.MEDIA_BROADCAST_WORKSHEET_MARKET MBWM ON MBWM.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = MBWMD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID 
WHERE BUYER_EMP_CODE = @FIND_BUYER_EMP_CODE 
AND MBWMDD.ORDER_NBR IS NOT NULL

UPDATE dbo.MEDIA_BROADCAST_WORKSHEET_MARKET SET BUYER_EMP_CODE = @REPLACE_BUYER_EMP_CODE 
WHERE BUYER_EMP_CODE = @FIND_BUYER_EMP_CODE 

UPDATE dbo.TV_HDR SET BUYER_EMP_CODE = @REPLACE_BUYER_EMP_CODE, BUYER = [dbo].[advfn_get_emp_name](@REPLACE_BUYER_EMP_CODE,'FML')
WHERE BUYER_EMP_CODE = @FIND_BUYER_EMP_CODE
AND ORDER_NBR IN (SELECT ORDER_NBR FROM #order_updates)

UPDATE dbo.RADIO_HDR SET BUYER_EMP_CODE = @REPLACE_BUYER_EMP_CODE, BUYER = [dbo].[advfn_get_emp_name](@REPLACE_BUYER_EMP_CODE,'FML')
WHERE BUYER_EMP_CODE = @FIND_BUYER_EMP_CODE
AND ORDER_NBR IN (SELECT ORDER_NBR FROM #order_updates)

GO
