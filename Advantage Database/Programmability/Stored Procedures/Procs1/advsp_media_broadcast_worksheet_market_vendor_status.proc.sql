CREATE PROCEDURE [dbo].[advsp_media_broadcast_worksheet_market_vendor_status]
	@MEDIA_BROADCAST_WORKSHEET_MARKET_ID int
AS

DECLARE @MEDIA_TYPE_CODE char(1)


SELECT @MEDIA_TYPE_CODE = MBW.MEDIA_TYPE_CODE 
FROM MEDIA_BROADCAST_WORKSHEET_MARKET MBWM
	INNER JOIN MEDIA_BROADCAST_WORKSHEET MBW ON MBWM.MEDIA_BROADCAST_WORKSHEET_ID = MBW.MEDIA_BROADCAST_WORKSHEET_ID
WHERE MBWM.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = @MEDIA_BROADCAST_WORKSHEET_MARKET_ID

IF @MEDIA_TYPE_CODE = 'T'
	SELECT DISTINCT
		MediaBroadcastWorksheetMarketID = MBWMD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID,
        VendorCode = MBWMD.VN_CODE,
        VendorName = V.VN_NAME,
        Syscode = null,
        CreateDate = H.CREATE_DATE,
        LastStatusDate = (SELECT TOP 1 REVISED_DATE FROM dbo.TV_ORDER_STATUS tos WHERE MBWMDD.ORDER_NBR = tos.ORDER_NBR ORDER BY REVISED_DATE DESC),
        [Status] = (SELECT TOP 1 os.STATUS_DESC FROM dbo.TV_ORDER_STATUS tos INNER JOIN dbo.ORDER_STATUS os ON tos.[STATUS] = os.[STATUS] WHERE MBWMDD.ORDER_NBR = tos.ORDER_NBR ORDER BY REVISED_DATE DESC)
	FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL MBWMD
		INNER JOIN dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_DATE MBWMDD ON MBWMD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID = MBWMDD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID 
		INNER JOIN dbo.TV_HDR H ON MBWMDD.ORDER_NBR = H.ORDER_NBR 
		INNER JOIN dbo.VENDOR V ON H.VN_CODE = V.VN_CODE
	WHERE MBWMD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = @MEDIA_BROADCAST_WORKSHEET_MARKET_ID
ELSE IF @MEDIA_TYPE_CODE = 'R'
	SELECT DISTINCT
		MediaBroadcastWorksheetMarketID = MBWMD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID,
        VendorCode = MBWMD.VN_CODE,
        VendorName = V.VN_NAME,
        Syscode = null,
        CreateDate = H.CREATE_DATE,
        LastStatusDate = (SELECT TOP 1 REVISED_DATE FROM dbo.RADIO_ORDER_STATUS tos WHERE MBWMDD.ORDER_NBR = tos.ORDER_NBR ORDER BY REVISED_DATE DESC),
        [Status] = (SELECT TOP 1 os.STATUS_DESC FROM dbo.RADIO_ORDER_STATUS tos INNER JOIN dbo.ORDER_STATUS os ON tos.[STATUS] = os.[STATUS] WHERE MBWMDD.ORDER_NBR = tos.ORDER_NBR ORDER BY REVISED_DATE DESC)
	FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL MBWMD
		INNER JOIN dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_DATE MBWMDD ON MBWMD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID = MBWMDD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID 
		INNER JOIN dbo.RADIO_HDR H ON MBWMDD.ORDER_NBR = H.ORDER_NBR 
		INNER JOIN dbo.VENDOR V ON H.VN_CODE = V.VN_CODE
	WHERE MBWMD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = @MEDIA_BROADCAST_WORKSHEET_MARKET_ID
GO