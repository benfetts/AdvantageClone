CREATE PROCEDURE [dbo].[advsp_media_broadcast_worksheets_with_pending_makegoods]

AS

SELECT MAX(REVISED_DATE) as MAX_REVISED_DATE, ORDER_NBR
INTO #LATEST_TV
FROM dbo.TV_ORDER_STATUS 
WHERE ORDER_NBR IN (SELECT DISTINCT ORDER_NBR FROM dbo.TV_ORDER_STATUS WHERE [STATUS] = 16)
GROUP BY ORDER_NBR

SELECT MAX(REVISED_DATE) as MAX_REVISED_DATE, ORDER_NBR
INTO #LATEST_RADIO
FROM dbo.RADIO_ORDER_STATUS 
WHERE ORDER_NBR IN (SELECT DISTINCT ORDER_NBR FROM dbo.RADIO_ORDER_STATUS WHERE [STATUS] = 16)
GROUP BY ORDER_NBR

--SELECT * FROM #LATEST_TV

--SELECT COUNT(1), tos.ORDER_NBR, tos.[STATUS]
--FROM #LATEST_TV l
--	INNER JOIN dbo.TV_ORDER_STATUS tos ON l.ORDER_NBR = tos.ORDER_NBR AND l.MAX_REVISED_DATE = tos.REVISED_DATE 
--GROUP BY tos.ORDER_NBR, tos.[STATUS]
--HAVING tos.[STATUS] = 16

SELECT
	MediaBroadcastWorksheetID = MBW.MEDIA_BROADCAST_WORKSHEET_ID, 
	MediaBroadcastWorksheetMarketID = MBWM.MEDIA_BROADCAST_WORKSHEET_MARKET_ID 
FROM dbo.MEDIA_BROADCAST_WORKSHEET MBW
	INNER JOIN dbo.MEDIA_BROADCAST_WORKSHEET_MARKET MBWM ON MBW.MEDIA_BROADCAST_WORKSHEET_ID = MBWM.MEDIA_BROADCAST_WORKSHEET_ID 
WHERE MBWM.MEDIA_BROADCAST_WORKSHEET_MARKET_ID IN (
	SELECT MBWMD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID --, MAX(MBWMD.REVISION_NUMBER) as MAXREV, 
	FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL MBWMD
	WHERE MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID IN (
		SELECT DISTINCT MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID
		FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_DATE MBWMDD
		WHERE
			MBWMDD.ORDER_NBR IN (
								SELECT ORDER_NBR
								FROM (
									SELECT COUNT(1) as mycount, tos.ORDER_NBR, tos.[STATUS]
									FROM #LATEST_TV l
										INNER JOIN dbo.TV_ORDER_STATUS tos ON l.ORDER_NBR = tos.ORDER_NBR AND l.MAX_REVISED_DATE = tos.REVISED_DATE 
									GROUP BY tos.ORDER_NBR, tos.[STATUS]
									HAVING tos.[STATUS] = 16) mgs

								UNION

								SELECT ORDER_NBR
								FROM (
									SELECT COUNT(1) as mycount, tos.ORDER_NBR, tos.[STATUS]
									FROM #LATEST_RADIO l
										INNER JOIN dbo.RADIO_ORDER_STATUS tos ON l.ORDER_NBR = tos.ORDER_NBR AND l.MAX_REVISED_DATE = tos.REVISED_DATE 
									GROUP BY tos.ORDER_NBR, tos.[STATUS]
									HAVING tos.[STATUS] = 16) mgs
								)
		)
	GROUP BY MBWMD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID 
	) 
GO
