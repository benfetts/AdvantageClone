IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[advsp_media_order_lines]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[advsp_media_order_lines]
GO

CREATE PROCEDURE [dbo].[advsp_media_order_lines]
@USER_CODE VARCHAR(100),
@JOB_NUMBER INT,
@JOB_COMPONENT_NBR SMALLINT,
@CL_CODE VARCHAR(6),
@DIV_CODE VARCHAR(6),
@PRD_CODE VARCHAR(6),
@INCL_CDP_MEDIA BIT
AS
/*=========== QUERY ===========*/

-- INIT
BEGIN
	CREATE TABLE #MEDIA_ORDERS ( 	
								OrderType					VARCHAR(10) NOT NULL,
								OrderTypeName				VARCHAR(20) NOT NULL,
								MediaType					VARCHAR(20) NULL,
								[Status]					VARCHAR(3) NULL,
								IsOrder						BIT NULL,
								OrderDate					SMALLDATETIME NULL,
								OrderNumber					INT NULL,
								OrderDescription			VARCHAR(40) NULL,
								OrderLineStatus				SMALLINT NULL,
								OrderLineStatusDescription	VARCHAR(100) NULL,
								OrderLineStartDate			SMALLDATETIME NULL,
								OrderLineEndDate			SMALLDATETIME NULL,
								OfficeCode					VARCHAR(4) NULL,
								ClientCode					VARCHAR(6) NULL,
								ClientName					VARCHAR(40) NULL,
								DivisionCode				VARCHAR(6) NULL,
								DivisionName				VARCHAR(40) NULL,
								ProductCode					VARCHAR(6) NULL,
								ProductDescription			VARCHAR(40) NULL,
								JobNumber					INT NULL,
								JobComponentNumber			SMALLINT NULL,
								CampaignIdentifier			INT NULL,
								CampaignCode				VARCHAR(6) NULL,
								CampaignName				VARCHAR(128) NULL,
								VendorCode					VARCHAR(6) NULL,
								VendorName					VARCHAR(40) NULL,
								Buyer						VARCHAR(50) NULL,
								ClientPO					VARCHAR(30) NULL,
								MarketCode					VARCHAR(30) NULL,
								MarketDescription			VARCHAR(40) NULL,
								OrderAccepted				BIT NULL,
								LineNumber					INT NULL,
								ActiveRevision				BIT NULL,
								FlightDates					VARCHAR(200) NULL,
								StartDate					SMALLDATETIME,
								EndDate						SMALLDATETIME,
								MediaMonth					VARCHAR(50) NULL,
								MediaYear					VARCHAR(50) NULL,
								CloseDate					SMALLDATETIME NULL,
								MatlCloseDate				SMALLDATETIME NULL,
								ExtCloseDate				SMALLDATETIME NULL,
								ExtMatlCloseDate			SMALLDATETIME NULL,
								Size						VARCHAR(100) NULL,
								PrintColumn					DECIMAL(18,0) NULL,
								PrintInches					DECIMAL(18,0) NULL,
								PrintLines					DECIMAL(18,0) NULL,
								AdNumber					VARCHAR(30) NULL,
								AdNumberDescription			VARCHAR(60) NULL,
								Headline					VARCHAR(200) NULL,
								InternetType				VARCHAR(10) NULL,
								OutdoorType					VARCHAR(10) NULL,
								Material					VARCHAR(60) NULL,
								EditionIssue				VARCHAR(30) NULL,
								Section						VARCHAR(30) NULL,
								StartTime					VARCHAR(50) NULL,
								EndTime						VARCHAR(50) NULL,
								[Length]					VARCHAR(50) NULL,
								Tag							VARCHAR(50) NULL,
								Programming					VARCHAR(50) NULL,
								MatlNotes					VARCHAR(500) NULL,
								Remarks						VARCHAR(300) NULL,
								ProductionSize				VARCHAR(30) NULL,
								EstimateNumber				INT NULL,
								EstimateLineNumber			INT NULL,
								EstimateRevisionNumber		INT NULL,
								LineTotal					DECIMAL(14,2) NULL,
								CostPer						DECIMAL(18,0) NULL,
								Impressions					DECIMAL(18,0) NULL,
								LineIsCancelled				BIT NULL,
								RevisionNumber				INT NULL,
								MatCompDate					SMALLDATETIME,
								AdSizeCode					VARCHAR(6) NULL,
								AdSizeDescription			VARCHAR(30) NULL,
								DateToBill					SMALLDATETIME NULL,
								OrderProcessingControl		SMALLINT NULL,
								Quantity					DECIMAL(14,2) NULL,
								Rate						DECIMAL(14,2) NULL,
								BillingAmount				DECIMAL(14,2) NULL,
								GrossAmount					DECIMAL(14,2) NULL,
								NetAmount					DECIMAL(14,2) NULL,
								SequenceNumber				SMALLINT NULL,
								IsInJob						BIT NULL,
								IsInJobText					VARCHAR(500) NULL
								);

	DECLARE
		@SQL NVARCHAR(MAX),
		@PARAMETER_LIST NVARCHAR(MAX),
		@LOAD_AVAILABLE_FOR_CDP BIT

	IF (@JOB_NUMBER IS NULL AND @JOB_COMPONENT_NBR IS NULL)
		AND (NOT @CL_CODE IS NULL AND NOT @DIV_CODE IS NULL AND NOT @PRD_CODE IS NULL)
	BEGIN
		SET @LOAD_AVAILABLE_FOR_CDP = 1;
	END
	ELSE
	BEGIN
		SET @LOAD_AVAILABLE_FOR_CDP = 0;
	END

	SET @INCL_CDP_MEDIA = ISNULL(@INCL_CDP_MEDIA, 0);

	IF (@INCL_CDP_MEDIA = 1) AND (NOT @JOB_NUMBER IS NULL)
	BEGIN
		SELECT 
			@CL_CODE = CL_CODE, 
			@DIV_CODE = DIV_CODE, 
			@PRD_CODE = PRD_CODE 
		FROM 
			JOB_LOG WITH(NOLOCK) 
		WHERE 
			JOB_NUMBER = @JOB_NUMBER;
	END

	DECLARE @OfficeRestrictions AS INTEGER	
	DECLARE @EMP_CODE AS varchar(6)

	SELECT @EMP_CODE = EMP_CODE FROM [dbo].[SEC_USER] WHERE UPPER([USER_CODE]) = UPPER(@USER_CODE)
	SELECT @OfficeRestrictions = COUNT(*) FROM EMP_OFFICE WHERE EMP_CODE = @EMP_CODE


END;

-- INTERNET
BEGIN

	SET @SQL = '
			INSERT INTO #MEDIA_ORDERS
			SELECT 
				''I'', 
				''Internet'',
				HDR.MEDIA_TYPE, 
				HDR.[STATUS],
				CASE WHEN HDR.[STATUS] IS NULL OR HDR.[STATUS] = ''0'' THEN 1 ELSE 0 END,
				HDR.ORDER_DATE,
				HDR.ORDER_NBR, 
				HDR.ORDER_DESC, 
				IOS.STATUS,
				OS.STATUS_DESC,
				NULL,
				NULL,
				HDR.OFFICE_CODE, 
				HDR.CL_CODE,
				CL.CL_NAME, 
				HDR.DIV_CODE, 
				D.DIV_NAME, 
				HDR.PRD_CODE, 
				P.PRD_DESCRIPTION, 
				DTL.JOB_NUMBER, 
				DTL.JOB_COMPONENT_NBR, 
				HDR.CMP_IDENTIFIER, 
				HDR.CMP_CODE, 
				C.CMP_NAME, 
				HDR.VN_CODE, 
				V.VN_NAME, 
				HDR.BUYER, 
				HDR.CLIENT_PO, 
				HDR.MARKET_CODE, 
				M.MARKET_DESC, 
				CAST(ISNULL(HDR.ORDER_ACCEPTED, 0) AS BIT), 
				DTL.LINE_NBR, 
				DTL.ACTIVE_REV,
				NULL, 
				DTL.[START_DATE], 
				DTL.END_DATE, 
				NULL, 
				NULL,
				DTL.CLOSE_DATE, 
				DTL.MATL_CLOSE_DATE, 
				DTL.EXT_CLOSE_DATE, 
				DTL.EXT_MATL_DATE, 
				DTL.CREATIVE_SIZE,
				0, 
				0, 
				0, 
				DTL.AD_NUMBER, 
				AN.AD_NBR_DESC,
				DTL.HEADLINE, 
				DTL.INTERNET_TYPE, 
				NULL, 
				NULL,
				NULL,
				NULL, 
				NULL, 
				NULL,
				NULL, 
				NULL, 
				NULL,
				NULL, 
				NULL, 
				NULL, 
				DTL.EST_NBR, 
				DTL.EST_LINE_NBR, 
				DTL.EST_REV_NBR, 
				DTL.LINE_TOTAL,
				DTL.COST_RATE,  
				DTL.GUARANTEED_IMPRESS, 
				CAST(ISNULL(DTL.LINE_CANCELLED, 0) AS BIT), 
				DTL.REV_NBR, 
				DTL.MAT_COMP, 
				DTL.SIZE,
				AD_SIZE.SIZE_DESC,
				DTL.DATE_TO_BILL,
				HDR.ORD_PROCESS_CONTRL,
				DTL.QUANTITY,
				DTL.RATE,
				DTL.BILLING_AMT,
				DTL.EXT_GROSS_AMT,
				DTL.EXT_NET_AMT,
				DTL.SEQ_NBR,
				CASE WHEN (DTL.JOB_NUMBER IS NULL AND DTL.JOB_COMPONENT_NBR IS NULL) THEN 0 ELSE 1 END,
				CASE WHEN (DTL.JOB_NUMBER IS NULL AND DTL.JOB_COMPONENT_NBR IS NULL) THEN ''Media available to include with this job*'' ELSE ''Currently in this job'' END
			FROM 
				INTERNET_HEADER HDR WITH(NOLOCK)
				INNER JOIN INTERNET_DETAIL DTL WITH(NOLOCK) ON HDR.ORDER_NBR = DTL.ORDER_NBR
				INNER JOIN CLIENT AS CL WITH(NOLOCK) ON HDR.CL_CODE = CL.CL_CODE 
				INNER JOIN DIVISION AS D WITH(NOLOCK) ON CL.CL_CODE = D.CL_CODE 
				INNER JOIN PRODUCT AS P WITH(NOLOCK) ON HDR.CL_CODE = P.CL_CODE AND HDR.DIV_CODE = P.DIV_CODE AND HDR.PRD_CODE = P.PRD_CODE AND D.CL_CODE = P.CL_CODE AND D.DIV_CODE = P.DIV_CODE
				INNER JOIN VENDOR V WITH(NOLOCK) ON HDR.VN_CODE = V.VN_CODE
				LEFT OUTER JOIN CAMPAIGN C WITH(NOLOCK) ON HDR.CMP_IDENTIFIER = C.CMP_IDENTIFIER
				LEFT OUTER JOIN MARKET M WITH(NOLOCK) ON HDR.MARKET_CODE = M.MARKET_CODE
				LEFT OUTER JOIN AD_NUMBER AN WITH(NOLOCK) ON DTL.AD_NUMBER = AN.AD_NBR
				LEFT OUTER JOIN AD_SIZE WITH(NOLOCK) ON DTL.SIZE = AD_SIZE.SIZE_CODE AND AD_SIZE.MEDIA_TYPE = ''I''
				LEFT OUTER JOIN INTERNET_ORDER_STATUS IOS ON IOS.ORDER_NBR = DTL.ORDER_NBR AND IOS.LINE_NBR = DTL.LINE_NBR AND IOS.REV_NBR = DTL.REV_NBR
				LEFT OUTER JOIN ORDER_STATUS OS ON IOS.STATUS = OS.STATUS'
				if @OfficeRestrictions > 0
				Begin
					SET @SQL = @SQL + ' INNER JOIN EMP_OFFICE ON V.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = ''' + @EMP_CODE + ''''
				End
			SET @SQL = @SQL + ' WHERE DTL.ACTIVE_REV = 1 AND HDR.ORD_PROCESS_CONTRL NOT IN (6)'

	IF (NOT @JOB_NUMBER IS NULL AND NOT @JOB_COMPONENT_NBR IS NULL) AND (@INCL_CDP_MEDIA = 0)
	BEGIN		
		SET @SQL = @SQL + '
				AND (DTL.JOB_NUMBER = @JOB_NUMBER AND DTL.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR)
		'
	END
	IF (NOT @JOB_NUMBER IS NULL AND NOT @JOB_COMPONENT_NBR IS NULL) AND (@INCL_CDP_MEDIA = 1)
	BEGIN		
		SET @SQL = @SQL + '
				AND ((DTL.JOB_NUMBER = @JOB_NUMBER AND DTL.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR) OR (DTL.JOB_NUMBER IS NULL AND DTL.JOB_COMPONENT_NBR IS NULL))
		'
	END
	IF NOT @CL_CODE IS NULL 
	BEGIN		
		SET @SQL = @SQL + '
				AND HDR.CL_CODE = @CL_CODE
		'
	END
	IF NOT @DIV_CODE IS NULL 
	BEGIN		
		SET @SQL = @SQL + '
				AND HDR.DIV_CODE = @DIV_CODE
		'
	END
	IF NOT @PRD_CODE IS NULL 
	BEGIN		
		SET @SQL = @SQL + '
				AND HDR.PRD_CODE = @PRD_CODE
		'
	END
	SET @SQL = @SQL + ';'

	SET @PARAMETER_LIST = '@JOB_NUMBER INT, @JOB_COMPONENT_NBR SMALLINT, @CL_CODE VARCHAR(6), @DIV_CODE VARCHAR(6), @PRD_CODE VARCHAR(6)';
	EXEC sp_executesql @SQL, @PARAMETER_LIST, @JOB_NUMBER, @JOB_COMPONENT_NBR, @CL_CODE, @DIV_CODE, @PRD_CODE;

END;
-- MAGAZINE
BEGIN
	SET @SQL = '
			INSERT INTO #MEDIA_ORDERS
			SELECT 
				''M'', 
				''Magazine'',
				HDR.MEDIA_TYPE, 
				HDR.[STATUS],
				CASE WHEN HDR.[STATUS] IS NULL OR HDR.[STATUS] = ''0'' THEN 1 ELSE 0 END,
				HDR.ORDER_DATE,
				HDR.ORDER_NBR,
				HDR.ORDER_DESC, 
				IOS.STATUS,
				OS.STATUS_DESC,
				NULL,
				NULL,
				HDR.OFFICE_CODE, 
				HDR.CL_CODE,
				CL.CL_NAME, 
				HDR.DIV_CODE, 
				D.DIV_NAME, 
				HDR.PRD_CODE, 
				P.PRD_DESCRIPTION, 
				DTL.JOB_NUMBER, 
				DTL.JOB_COMPONENT_NBR, 
				HDR.CMP_IDENTIFIER, 
				HDR.CMP_CODE, 
				C.CMP_NAME, 
				HDR.VN_CODE, 
				V.VN_NAME, 
				HDR.BUYER, 
				HDR.CLIENT_PO, 
				HDR.MARKET_CODE, 
				M.MARKET_DESC, 
				CAST(ISNULL(HDR.ORDER_ACCEPTED, 0) AS BIT), 
				DTL.LINE_NBR, 
				DTL.ACTIVE_REV,
				NULL AS FLIGHT_DATES, 
				DTL.[START_DATE], 
				DTL.END_DATE, 
				NULL, 
				NULL,
				DTL.CLOSE_DATE, 
				DTL.MATL_CLOSE_DATE, 
				DTL.EXT_CLOSE_DATE,
				DTL.EXT_MATL_DATE, 
				DTL.SIZE,
				0, 
				0, 
				0, 
				DTL.AD_NUMBER, 
				AN.AD_NBR_DESC,
				DTL.HEADLINE, 
				NULL, 
				NULL, 
				DTL.MATERIAL, 
				DTL.EDITION_ISSUE, 
				NULL, 
				NULL AS START_TIME, 
				NULL AS END_TIME,
				NULL AS LENGTH, 
				NULL AS TAG, 
				NULL AS PROGRAMMING,
				NULL, 
				NULL AS REMARKS,
				DTL.PRODUCTION_SIZE,
				DTL.EST_NBR, 
				DTL.EST_LINE_NBR, 
				DTL.EST_REV_NBR, 
				DTL.LINE_TOTAL, 
				0, 
				0, 
				CAST(ISNULL(DTL.LINE_CANCELLED, 0) AS BIT), 
				DTL.REV_NBR, 
				DTL.MAT_COMP, 
				DTL.SIZE_CODE,
				AD_SIZE.SIZE_DESC,
				DTL.DATE_TO_BILL,
				HDR.ORD_PROCESS_CONTRL,
				DTL.QUANTITY,
				DTL.RATE,
				DTL.BILLING_AMT,
				DTL.EXT_GROSS_AMT,
				DTL.EXT_NET_AMT,
				DTL.SEQ_NBR,
				CASE WHEN (DTL.JOB_NUMBER IS NULL AND DTL.JOB_COMPONENT_NBR IS NULL) THEN 0 ELSE 1 END,
				CASE WHEN (DTL.JOB_NUMBER IS NULL AND DTL.JOB_COMPONENT_NBR IS NULL) THEN ''Media available to include with this job*'' ELSE ''Currently in this job'' END
			FROM 
				MAGAZINE_HEADER HDR WITH(NOLOCK) 
				INNER JOIN MAGAZINE_DETAIL DTL WITH(NOLOCK) ON HDR.ORDER_NBR = DTL.ORDER_NBR
				INNER JOIN CLIENT AS CL WITH(NOLOCK) ON HDR.CL_CODE = CL.CL_CODE 
				INNER JOIN DIVISION AS D WITH(NOLOCK) ON CL.CL_CODE = D.CL_CODE 
				INNER JOIN PRODUCT AS P WITH(NOLOCK) ON HDR.CL_CODE = P.CL_CODE AND HDR.DIV_CODE = P.DIV_CODE AND HDR.PRD_CODE = P.PRD_CODE AND D.CL_CODE = P.CL_CODE AND D.DIV_CODE = P.DIV_CODE	
				INNER JOIN VENDOR V WITH(NOLOCK) ON HDR.VN_CODE = V.VN_CODE
				LEFT OUTER JOIN CAMPAIGN C WITH(NOLOCK) ON HDR.CMP_IDENTIFIER = C.CMP_IDENTIFIER
				LEFT OUTER JOIN MARKET M WITH(NOLOCK) ON HDR.MARKET_CODE = M.MARKET_CODE
				LEFT OUTER JOIN AD_NUMBER AN WITH(NOLOCK) ON DTL.AD_NUMBER = AN.AD_NBR
				LEFT OUTER JOIN AD_SIZE WITH(NOLOCK) ON DTL.SIZE_CODE = AD_SIZE.SIZE_CODE AND AD_SIZE.MEDIA_TYPE = ''M''
				LEFT OUTER JOIN MAGAZINE_ORDER_STATUS IOS ON IOS.ORDER_NBR = DTL.ORDER_NBR AND IOS.LINE_NBR = DTL.LINE_NBR AND IOS.REV_NBR = DTL.REV_NBR
				LEFT OUTER JOIN ORDER_STATUS OS ON IOS.STATUS = OS.STATUS'
				if @OfficeRestrictions > 0
				Begin
					SET @SQL = @SQL + ' INNER JOIN EMP_OFFICE ON V.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = ''' + @EMP_CODE + ''''
				End
			SET @SQL = @SQL + '	WHERE DTL.ACTIVE_REV = 1 AND HDR.ORD_PROCESS_CONTRL NOT IN (6)'
	IF (NOT @JOB_NUMBER IS NULL AND NOT @JOB_COMPONENT_NBR IS NULL) AND (@INCL_CDP_MEDIA = 0)
	BEGIN		
		SET @SQL = @SQL + '
				AND (DTL.JOB_NUMBER = @JOB_NUMBER AND DTL.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR)
		'
	END
	IF (NOT @JOB_NUMBER IS NULL AND NOT @JOB_COMPONENT_NBR IS NULL) AND (@INCL_CDP_MEDIA = 1)
	BEGIN		
		SET @SQL = @SQL + '
				AND ((DTL.JOB_NUMBER = @JOB_NUMBER AND DTL.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR) OR (DTL.JOB_NUMBER IS NULL AND DTL.JOB_COMPONENT_NBR IS NULL))
		'
	END
	IF NOT @CL_CODE IS NULL 
	BEGIN		
		SET @SQL = @SQL + '
				AND HDR.CL_CODE = @CL_CODE
		'
	END
	IF NOT @DIV_CODE IS NULL 
	BEGIN		
		SET @SQL = @SQL + '
				AND HDR.DIV_CODE = @DIV_CODE
		'
	END
	IF NOT @PRD_CODE IS NULL 
	BEGIN		
		SET @SQL = @SQL + '
				AND HDR.PRD_CODE = @PRD_CODE
		'
	END
	SET @SQL = @SQL + ';'

	SET @PARAMETER_LIST = '@JOB_NUMBER INT, @JOB_COMPONENT_NBR SMALLINT, @CL_CODE VARCHAR(6), @DIV_CODE VARCHAR(6), @PRD_CODE VARCHAR(6)';
	EXEC sp_executesql @SQL, @PARAMETER_LIST, @JOB_NUMBER, @JOB_COMPONENT_NBR, @CL_CODE, @DIV_CODE, @PRD_CODE;
END;
-- NEWSPAPER
BEGIN
	SET @SQL = '
			INSERT INTO #MEDIA_ORDERS
			SELECT 
				''N'',
				''Newspaper'', 
				HDR.MEDIA_TYPE, 
				HDR.[STATUS],
				CASE WHEN HDR.[STATUS] IS NULL OR HDR.[STATUS] = ''0'' THEN 1 ELSE 0 END,
				HDR.ORDER_DATE,
				HDR.ORDER_NBR, 
				HDR.ORDER_DESC, 
				IOS.STATUS,
				OS.STATUS_DESC,
				NULL,
				NULL,
				HDR.OFFICE_CODE, 
				HDR.CL_CODE,
				CL.CL_NAME, 
				HDR.DIV_CODE, 
				D.DIV_NAME, 
				HDR.PRD_CODE, 
				P.PRD_DESCRIPTION, 
				DTL.JOB_NUMBER, 
				DTL.JOB_COMPONENT_NBR, 
				HDR.CMP_IDENTIFIER, 
				HDR.CMP_CODE, 
				C.CMP_NAME, 
				HDR.VN_CODE, 
				V.VN_NAME, 
				HDR.BUYER, 
				HDR.CLIENT_PO, 
				HDR.MARKET_CODE, 
				M.MARKET_DESC, 
				CAST(ISNULL(HDR.ORDER_ACCEPTED, 0) AS BIT), 
				DTL.LINE_NBR, 
				DTL.ACTIVE_REV,NULL AS FLIGHT_DATES, 
				DTL.[START_DATE], 
				DTL.END_DATE, 
				NULL, 
				NULL,
				DTL.CLOSE_DATE, 
				DTL.MATL_CLOSE_DATE, 
				DTL.EXT_CLOSE_DATE, 
				DTL.EXT_MATL_DATE, 
				DTL.SIZE,
				DTL.PRINT_COLUMNS, 
				DTL.PRINT_INCHES, 
				DTL.PRINT_LINES,
				DTL.AD_NUMBER,	
				AN.AD_NBR_DESC,
				DTL.HEADLINE,
				NULL, 
				NULL,
				DTL.MATERIAL, 
				DTL.EDITION_ISSUE, 
				DTL.SECTION,
				NULL AS START_TIME, 
				NULL AS END_TIME,
				NULL AS LENGTH, 
				NULL AS TAG, 
				NULL AS PROGRAMMING,
				NULL, 
				NULL AS REMARKS,
				DTL.PRODUCTION_SIZE, 
				DTL.EST_NBR, 
				DTL.EST_LINE_NBR, 
				DTL.EST_REV_NBR, 
				DTL.LINE_TOTAL,
				0, 
				0, 
				CAST(ISNULL(DTL.LINE_CANCELLED, 0) AS BIT), 
				DTL.REV_NBR, 
				DTL.MAT_COMP, 
				DTL.SIZE_CODE,
				AD_SIZE.SIZE_DESC,
				DTL.DATE_TO_BILL,
				HDR.ORD_PROCESS_CONTRL,
				DTL.QUANTITY,
				DTL.RATE,
				DTL.BILLING_AMT,
				DTL.EXT_GROSS_AMT,
				DTL.EXT_NET_AMT,
				DTL.SEQ_NBR,
				CASE WHEN (DTL.JOB_NUMBER IS NULL AND DTL.JOB_COMPONENT_NBR IS NULL) THEN 0 ELSE 1 END,
				CASE WHEN (DTL.JOB_NUMBER IS NULL AND DTL.JOB_COMPONENT_NBR IS NULL) THEN ''Media available to include with this job*'' ELSE ''Currently in this job'' END
			FROM 
				NEWSPAPER_HEADER HDR WITH(NOLOCK) 
				INNER JOIN NEWSPAPER_DETAIL DTL WITH(NOLOCK) ON HDR.ORDER_NBR = DTL.ORDER_NBR
				INNER JOIN CLIENT AS CL WITH(NOLOCK) ON HDR.CL_CODE = CL.CL_CODE 
				INNER JOIN DIVISION AS D WITH(NOLOCK) ON CL.CL_CODE = D.CL_CODE 
				INNER JOIN PRODUCT AS P WITH(NOLOCK) ON HDR.CL_CODE = P.CL_CODE AND HDR.DIV_CODE = P.DIV_CODE AND HDR.PRD_CODE = P.PRD_CODE AND D.CL_CODE = P.CL_CODE AND D.DIV_CODE = P.DIV_CODE
				INNER JOIN VENDOR V WITH(NOLOCK) ON HDR.VN_CODE = V.VN_CODE
				LEFT OUTER JOIN CAMPAIGN C WITH(NOLOCK) ON HDR.CMP_IDENTIFIER = C.CMP_IDENTIFIER
				LEFT OUTER JOIN MARKET M WITH(NOLOCK) ON HDR.MARKET_CODE = M.MARKET_CODE
				LEFT OUTER JOIN AD_NUMBER AN WITH(NOLOCK) ON DTL.AD_NUMBER = AN.AD_NBR	
				LEFT OUTER JOIN AD_SIZE WITH(NOLOCK) ON DTL.SIZE_CODE = AD_SIZE.SIZE_CODE AND AD_SIZE.MEDIA_TYPE = ''N''
				LEFT OUTER JOIN NEWSPAPER_ORDER_STATUS IOS ON IOS.ORDER_NBR = DTL.ORDER_NBR AND IOS.LINE_NBR = DTL.LINE_NBR AND IOS.REV_NBR = DTL.REV_NBR
				LEFT OUTER JOIN ORDER_STATUS OS ON IOS.STATUS = OS.STATUS'
				if @OfficeRestrictions > 0
				Begin
					SET @SQL = @SQL + ' INNER JOIN EMP_OFFICE ON V.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = ''' + @EMP_CODE + ''''
				End
			SET @SQL = @SQL + '	WHERE DTL.ACTIVE_REV = 1 AND HDR.ORD_PROCESS_CONTRL NOT IN (6) '
	IF (NOT @JOB_NUMBER IS NULL AND NOT @JOB_COMPONENT_NBR IS NULL) AND (@INCL_CDP_MEDIA = 0)
	BEGIN		
		SET @SQL = @SQL + '
				AND (DTL.JOB_NUMBER = @JOB_NUMBER AND DTL.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR)
		'
	END
	IF (NOT @JOB_NUMBER IS NULL AND NOT @JOB_COMPONENT_NBR IS NULL) AND (@INCL_CDP_MEDIA = 1)
	BEGIN		
		SET @SQL = @SQL + '
				AND ((DTL.JOB_NUMBER = @JOB_NUMBER AND DTL.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR) OR (DTL.JOB_NUMBER IS NULL AND DTL.JOB_COMPONENT_NBR IS NULL))
		'
	END
	IF NOT @CL_CODE IS NULL 
	BEGIN		
		SET @SQL = @SQL + '
				AND HDR.CL_CODE = @CL_CODE
		'
	END
	IF NOT @DIV_CODE IS NULL 
	BEGIN		
		SET @SQL = @SQL + '
				AND HDR.DIV_CODE = @DIV_CODE
		'
	END
	IF NOT @PRD_CODE IS NULL 
	BEGIN		
		SET @SQL = @SQL + '
				AND HDR.PRD_CODE = @PRD_CODE
		'
	END
	SET @SQL = @SQL + ';'

	SET @PARAMETER_LIST = '@JOB_NUMBER INT, @JOB_COMPONENT_NBR SMALLINT, @CL_CODE VARCHAR(6), @DIV_CODE VARCHAR(6), @PRD_CODE VARCHAR(6)';
	EXEC sp_executesql @SQL, @PARAMETER_LIST, @JOB_NUMBER, @JOB_COMPONENT_NBR, @CL_CODE, @DIV_CODE, @PRD_CODE;

END;
-- OUT OF HOME
BEGIN

	SET @SQL = '
			INSERT INTO #MEDIA_ORDERS
			SELECT 
				''O'', 
				''Out of Home'',
				HDR.MEDIA_TYPE, 
				HDR.[STATUS],
				CASE WHEN HDR.[STATUS] IS NULL OR HDR.[STATUS] = ''0'' THEN 1 ELSE 0 END,
				HDR.ORDER_DATE,
				HDR.ORDER_NBR, 
				HDR.ORDER_DESC, 
				IOS.STATUS,
				OS.STATUS_DESC,
				NULL,
				NULL,
				HDR.OFFICE_CODE, 
				HDR.CL_CODE,
				CL.CL_NAME, 
				HDR.DIV_CODE, 
				D.DIV_NAME, 
				HDR.PRD_CODE, 
				P.PRD_DESCRIPTION, 
				DTL.JOB_NUMBER, 
				DTL.JOB_COMPONENT_NBR, 
				HDR.CMP_IDENTIFIER, 
				HDR.CMP_CODE, 
				C.CMP_NAME, 
				HDR.VN_CODE, 
				V.VN_NAME, 
				HDR.BUYER,
				HDR.CLIENT_PO, 
				HDR.MARKET_CODE, 
				M.MARKET_DESC, 
				CAST(ISNULL(HDR.ORDER_ACCEPTED, 0) AS BIT), 
				DTL.LINE_NBR, 
				DTL.ACTIVE_REV,
				NULL, 
				DTL.POST_DATE,
				DTL.END_DATE,
				NULL, 
				NULL,
				DTL.CLOSE_DATE, 
				DTL.MATL_CLOSE_DATE, 
				DTL.EXT_CLOSE_DATE, 
				DTL.EXT_MATL_DATE, 
				DTL.SIZE,
				0, 
				0, 
				0,	
				DTL.AD_NUMBER,
				AN.AD_NBR_DESC,
				DTL.HEADLINE, 
				NULL, 
				DTL.OUTDOOR_TYPE,
				NULL,
				NULL,
				NULL, 
				NULL AS START_TIME, 
				NULL AS END_TIME,
				NULL AS LENGTH, 
				NULL AS TAG, 
				NULL AS PROGRAMMING,
				NULL, 
				NULL AS REMARKS, 
				NULL, 
				DTL.EST_NBR, 
				DTL.EST_LINE_NBR, 
				DTL.EST_REV_NBR, 
				DTL.LINE_TOTAL, 
				0, 
				0, 
				CAST(ISNULL(DTL.LINE_CANCELLED, 0) AS BIT), 
				DTL.REV_NBR, 
				DTL.MAT_COMP, 
				DTL.SIZE,
				AD_SIZE.SIZE_DESC,
				DTL.DATE_TO_BILL,
				HDR.ORD_PROCESS_CONTRL,
				DTL.QUANTITY,
				DTL.RATE,
				DTL.BILLING_AMT,
				DTL.EXT_GROSS_AMT,
				DTL.EXT_NET_AMT,
				DTL.SEQ_NBR,
				CASE WHEN (DTL.JOB_NUMBER IS NULL AND DTL.JOB_COMPONENT_NBR IS NULL) THEN 0 ELSE 1 END,
				CASE WHEN (DTL.JOB_NUMBER IS NULL AND DTL.JOB_COMPONENT_NBR IS NULL) THEN ''Media available to include with this job*'' ELSE ''Currently in this job'' END
			FROM 
				OUTDOOR_HEADER HDR WITH(NOLOCK) 
				INNER JOIN OUTDOOR_DETAIL DTL WITH(NOLOCK) ON HDR.ORDER_NBR = DTL.ORDER_NBR
				INNER JOIN CLIENT AS CL WITH(NOLOCK) ON HDR.CL_CODE = CL.CL_CODE 
				INNER JOIN DIVISION AS D WITH(NOLOCK) ON CL.CL_CODE = D.CL_CODE 
				INNER JOIN PRODUCT AS P WITH(NOLOCK) ON HDR.CL_CODE = P.CL_CODE AND HDR.DIV_CODE = P.DIV_CODE AND HDR.PRD_CODE = P.PRD_CODE AND D.CL_CODE = P.CL_CODE AND D.DIV_CODE = P.DIV_CODE
				INNER JOIN VENDOR V WITH(NOLOCK) ON HDR.VN_CODE = V.VN_CODE
				LEFT OUTER JOIN CAMPAIGN C WITH(NOLOCK) ON HDR.CMP_IDENTIFIER = C.CMP_IDENTIFIER
				LEFT OUTER JOIN MARKET M WITH(NOLOCK) ON HDR.MARKET_CODE = M.MARKET_CODE 
				LEFT OUTER JOIN AD_NUMBER AN WITH(NOLOCK) ON DTL.AD_NUMBER = AN.AD_NBR
				LEFT OUTER JOIN AD_SIZE WITH(NOLOCK) ON DTL.SIZE = AD_SIZE.SIZE_CODE AND AD_SIZE.MEDIA_TYPE = ''O''
				LEFT OUTER JOIN OUTDOOR_ORDER_STATUS IOS ON IOS.ORDER_NBR = DTL.ORDER_NBR AND IOS.LINE_NBR = DTL.LINE_NBR AND IOS.REV_NBR = DTL.REV_NBR
				LEFT OUTER JOIN ORDER_STATUS OS ON IOS.STATUS = OS.STATUS'
				if @OfficeRestrictions > 0
				Begin
					SET @SQL = @SQL + ' INNER JOIN EMP_OFFICE ON V.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = ''' + @EMP_CODE + ''''
				End
			SET @SQL = @SQL + '	WHERE DTL.ACTIVE_REV = 1 AND HDR.ORD_PROCESS_CONTRL NOT IN (6) '
	IF (NOT @JOB_NUMBER IS NULL AND NOT @JOB_COMPONENT_NBR IS NULL) AND (@INCL_CDP_MEDIA = 0)
	BEGIN		
		SET @SQL = @SQL + '
				AND (DTL.JOB_NUMBER = @JOB_NUMBER AND DTL.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR)
		'
	END
	IF (NOT @JOB_NUMBER IS NULL AND NOT @JOB_COMPONENT_NBR IS NULL) AND (@INCL_CDP_MEDIA = 1)
	BEGIN		
		SET @SQL = @SQL + '
				AND ((DTL.JOB_NUMBER = @JOB_NUMBER AND DTL.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR) OR (DTL.JOB_NUMBER IS NULL AND DTL.JOB_COMPONENT_NBR IS NULL))
		'
	END
	IF NOT @CL_CODE IS NULL 
	BEGIN		
		SET @SQL = @SQL + '
				AND HDR.CL_CODE = @CL_CODE
		'
	END
	IF NOT @DIV_CODE IS NULL 
	BEGIN		
		SET @SQL = @SQL + '
				AND HDR.DIV_CODE = @DIV_CODE
		'
	END
	IF NOT @PRD_CODE IS NULL 
	BEGIN		
		SET @SQL = @SQL + '
				AND HDR.PRD_CODE = @PRD_CODE
		'
	END
	SET @SQL = @SQL + ';'

	SET @PARAMETER_LIST = '@JOB_NUMBER INT, @JOB_COMPONENT_NBR SMALLINT, @CL_CODE VARCHAR(6), @DIV_CODE VARCHAR(6), @PRD_CODE VARCHAR(6)';
	EXEC sp_executesql @SQL, @PARAMETER_LIST, @JOB_NUMBER, @JOB_COMPONENT_NBR, @CL_CODE, @DIV_CODE, @PRD_CODE;

END;
-- RADIO
BEGIN

	SET @SQL = '
			INSERT INTO #MEDIA_ORDERS
			SELECT 
				''R'', 
				''Radio'',
				HDR.MEDIA_TYPE, 
				HDR.[STATUS],
				CASE WHEN HDR.[STATUS] IS NULL OR HDR.[STATUS] = ''0'' THEN 1 ELSE 0 END,
				HDR.ORDER_DATE,
				HDR.ORDER_NBR, 
				HDR.ORDER_DESC, 
				IOS.STATUS,
				OS.STATUS_DESC,
				NULL,
				NULL,
				HDR.OFFICE_CODE,
				HDR.CL_CODE,
				CL.CL_NAME, 
				HDR.DIV_CODE, 
				D.DIV_NAME, 
				HDR.PRD_CODE, 
				P.PRD_DESCRIPTION, 
				DTL.JOB_NUMBER, 
				DTL.JOB_COMPONENT_NBR, 
				HDR.CMP_IDENTIFIER, 
				CAMPAIGN.CMP_CODE, 
				CAMPAIGN.CMP_NAME,
				HDR.VN_CODE, 
				VENDOR.VN_NAME, 
				HDR.BUYER, 
				HDR.CLIENT_PO, 
				HDR.MARKET_CODE, 
				MARKET.MARKET_DESC, 
				0, 
				DTL.LINE_NBR, 
				DTL.ACTIVE_REV,
				(CONVERT(VARCHAR(30), DTL.[START_DATE], 101) + '' - '' + CONVERT(VARCHAR(30), DTL.END_DATE, 101)) AS FLIGHT_DATES, 
				DTL.[START_DATE], 
				DTL.END_DATE,
				DTL.MONTH_NBR, 
				DTL.YEAR_NBR, 
				DTL.CLOSE_DATE, 
				DTL.MATL_CLOSE_DATE,
				DTL.EXT_CLOSE_DATE, 
				DTL.EXT_MATL_DATE,
				NULL, 
				0, 
				0, 
				0, 
				NULL, 
				NULL,
				NULL,
				NULL, 
				NULL, 
				NULL, 
				NULL, 
				NULL, 
				DTL.START_TIME, 
				DTL.END_TIME,
				DTL.[LENGTH], 
				DTL.TAG,
				DTL.PROGRAMMING, 
				NULL, 
				DTL.REMARKS,
				NULL, 
				0 , 
				0, 
				0, 
				0, 
				0,
				0, 
				CAST(ISNULL(DTL.LINE_CANCELLED, 0) AS BIT), 
				DTL.REV_NBR, 
				DTL.MAT_COMP, 
				NULL,
				NULL,
				DTL.DATE_TO_BILL,
				HDR.ORD_PROCESS_CONTRL,
				DTL.QUANTITY,
				DTL.RATE,
				DTL.BILLING_AMT,
				DTL.EXT_GROSS_AMT,
				DTL.EXT_NET_AMT,
				DTL.SEQ_NBR,
				CASE WHEN (DTL.JOB_NUMBER IS NULL AND DTL.JOB_COMPONENT_NBR IS NULL) THEN 0 ELSE 1 END,
				CASE WHEN (DTL.JOB_NUMBER IS NULL AND DTL.JOB_COMPONENT_NBR IS NULL) THEN ''Media available to include with this job*'' ELSE ''Currently in this job'' END
			FROM  
				RADIO_HDR HDR WITH(NOLOCK) 
				INNER JOIN RADIO_DETAIL DTL WITH(NOLOCK) ON HDR.ORDER_NBR = DTL.ORDER_NBR 
				INNER JOIN CLIENT AS CL WITH(NOLOCK) ON HDR.CL_CODE = CL.CL_CODE 
				INNER JOIN DIVISION AS D WITH(NOLOCK) ON CL.CL_CODE = D.CL_CODE 
				INNER JOIN PRODUCT AS P WITH(NOLOCK) ON HDR.CL_CODE = P.CL_CODE AND HDR.DIV_CODE = P.DIV_CODE AND HDR.PRD_CODE = P.PRD_CODE AND D.CL_CODE = P.CL_CODE AND D.DIV_CODE = P.DIV_CODE
				INNER JOIN VENDOR WITH(NOLOCK) ON HDR.VN_CODE = VENDOR.VN_CODE 
				LEFT OUTER JOIN MARKET WITH(NOLOCK) ON HDR.MARKET_CODE = MARKET.MARKET_CODE 
				LEFT OUTER JOIN CAMPAIGN WITH(NOLOCK) ON HDR.CMP_IDENTIFIER = CAMPAIGN.CMP_IDENTIFIER
				LEFT OUTER JOIN RADIO_ORDER_STATUS IOS ON IOS.ORDER_NBR = DTL.ORDER_NBR AND IOS.LINE_NBR = DTL.LINE_NBR AND IOS.REV_NBR = DTL.REV_NBR
				LEFT OUTER JOIN ORDER_STATUS OS ON IOS.STATUS = OS.STATUS'
				if @OfficeRestrictions > 0
				Begin
					SET @SQL = @SQL + ' INNER JOIN EMP_OFFICE ON VENDOR.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = ''' + @EMP_CODE + ''''
				End
			SET @SQL = @SQL + '	WHERE DTL.ACTIVE_REV = 1 AND HDR.ORD_PROCESS_CONTRL NOT IN (6)	'
	IF (NOT @JOB_NUMBER IS NULL AND NOT @JOB_COMPONENT_NBR IS NULL) AND (@INCL_CDP_MEDIA = 0)
	BEGIN		
		SET @SQL = @SQL + '
				AND (DTL.JOB_NUMBER = @JOB_NUMBER AND DTL.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR)
		'
	END
	IF (NOT @JOB_NUMBER IS NULL AND NOT @JOB_COMPONENT_NBR IS NULL) AND (@INCL_CDP_MEDIA = 1)
	BEGIN		
		SET @SQL = @SQL + '
				AND ((DTL.JOB_NUMBER = @JOB_NUMBER AND DTL.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR) OR (DTL.JOB_NUMBER IS NULL AND DTL.JOB_COMPONENT_NBR IS NULL))
		'
	END
	IF NOT @CL_CODE IS NULL 
	BEGIN		
		SET @SQL = @SQL + '
				AND HDR.CL_CODE = @CL_CODE
		'
	END
	IF NOT @DIV_CODE IS NULL 
	BEGIN		
		SET @SQL = @SQL + '
				AND HDR.DIV_CODE = @DIV_CODE
		'
	END
	IF NOT @PRD_CODE IS NULL 
	BEGIN		
		SET @SQL = @SQL + '
				AND HDR.PRD_CODE = @PRD_CODE
		'
	END
	SET @SQL = @SQL + ';'

	SET @PARAMETER_LIST = '@JOB_NUMBER INT, @JOB_COMPONENT_NBR SMALLINT, @CL_CODE VARCHAR(6), @DIV_CODE VARCHAR(6), @PRD_CODE VARCHAR(6)';
	EXEC sp_executesql @SQL, @PARAMETER_LIST, @JOB_NUMBER, @JOB_COMPONENT_NBR, @CL_CODE, @DIV_CODE, @PRD_CODE;


END;
-- TV
BEGIN

	SET @SQL = '
			INSERT INTO #MEDIA_ORDERS
			SELECT 
				''T'', 
				''TV'',
				HDR.MEDIA_TYPE, 
				HDR.[STATUS],
				CASE WHEN HDR.[STATUS] IS NULL OR HDR.[STATUS] = ''0'' THEN 1 ELSE 0 END,
				HDR.ORDER_DATE,
				HDR.ORDER_NBR, 
				HDR.ORDER_DESC, 
				IOS.STATUS,
				OS.STATUS_DESC,
				NULL,
				NULL,
				HDR.OFFICE_CODE,
				HDR.CL_CODE,
				CL.CL_NAME, 
				HDR.DIV_CODE, 
				D.DIV_NAME, 
				HDR.PRD_CODE, 
				P.PRD_DESCRIPTION, 
				DTL.JOB_NUMBER, 
				DTL.JOB_COMPONENT_NBR, 
				HDR.CMP_IDENTIFIER, 
				CAMPAIGN.CMP_CODE, 
				CAMPAIGN.CMP_NAME,
				HDR.VN_CODE, 
				VENDOR.VN_NAME, 
				HDR.BUYER, 
				HDR.CLIENT_PO, 
				HDR.MARKET_CODE, 
				MARKET.MARKET_DESC, 
				0,
				DTL.LINE_NBR, 
				DTL.ACTIVE_REV,  
				(CONVERT(VARCHAR(30), DTL.[START_DATE], 101) + '' - '' + CONVERT(VARCHAR(30), DTL.END_DATE, 101)) AS FLIGHT_DATES, 
				DTL.[START_DATE], 
				DTL.END_DATE,
				DTL.MONTH_NBR, 
				DTL.YEAR_NBR,
				DTL.CLOSE_DATE, 
				DTL.MATL_CLOSE_DATE, 
				DTL.EXT_CLOSE_DATE, 
				DTL.EXT_MATL_DATE, 
				NULL, 
				0, 
				0, 
				0, 
				NULL, 
				NULL,
				NULL,
				NULL, 
				NULL, 
				NULL, 
				NULL, 
				NULL,
				DTL.START_TIME, 
				DTL.END_TIME,
				DTL.[LENGTH], 
				DTL.TAG,
				DTL.PROGRAMMING, 
				NULL, 
				DTL.REMARKS,
				NULL, 
				0, 
				0, 
				0, 
				0, 
				0, 
				0, 
				CAST(ISNULL(DTL.LINE_CANCELLED, 0) AS BIT), 
				DTL.REV_NBR, 
				DTL.MAT_COMP, 
				NULL,
				NULL,
				DTL.DATE_TO_BILL,
				HDR.ORD_PROCESS_CONTRL,
				DTL.QUANTITY,
				DTL.RATE,
				DTL.BILLING_AMT,
				DTL.EXT_GROSS_AMT,
				DTL.EXT_NET_AMT,
				DTL.SEQ_NBR,
				CASE WHEN (DTL.JOB_NUMBER IS NULL AND DTL.JOB_COMPONENT_NBR IS NULL) THEN 0 ELSE 1 END,
				CASE WHEN (DTL.JOB_NUMBER IS NULL AND DTL.JOB_COMPONENT_NBR IS NULL) THEN ''Media available to include with this job*'' ELSE ''Currently in this job'' END
			FROM  
				TV_HDR HDR WITH(NOLOCK) 
				INNER JOIN TV_DETAIL DTL WITH(NOLOCK) ON HDR.ORDER_NBR = DTL.ORDER_NBR 
				INNER JOIN CLIENT AS CL WITH(NOLOCK) ON HDR.CL_CODE = CL.CL_CODE 
				INNER JOIN DIVISION AS D WITH(NOLOCK) ON CL.CL_CODE = D.CL_CODE 
				INNER JOIN PRODUCT AS P WITH(NOLOCK) ON HDR.CL_CODE = P.CL_CODE AND HDR.DIV_CODE = P.DIV_CODE AND HDR.PRD_CODE = P.PRD_CODE AND D.CL_CODE = P.CL_CODE AND D.DIV_CODE = P.DIV_CODE
				INNER JOIN VENDOR WITH(NOLOCK) ON HDR.VN_CODE = VENDOR.VN_CODE 
				LEFT OUTER JOIN MARKET WITH(NOLOCK) ON HDR.MARKET_CODE = MARKET.MARKET_CODE 
				LEFT OUTER JOIN CAMPAIGN WITH(NOLOCK) ON HDR.CMP_IDENTIFIER = CAMPAIGN.CMP_IDENTIFIER
				LEFT OUTER JOIN TV_ORDER_STATUS IOS ON IOS.ORDER_NBR = DTL.ORDER_NBR AND IOS.LINE_NBR = DTL.LINE_NBR AND IOS.REV_NBR = DTL.REV_NBR
				LEFT OUTER JOIN ORDER_STATUS OS ON IOS.STATUS = OS.STATUS'
				if @OfficeRestrictions > 0
				Begin
					SET @SQL = @SQL + ' INNER JOIN EMP_OFFICE ON VENDOR.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = ''' + @EMP_CODE + ''''
				End
			SET @SQL = @SQL + '	WHERE DTL.ACTIVE_REV = 1 AND HDR.ORD_PROCESS_CONTRL NOT IN (6) '
	IF (NOT @JOB_NUMBER IS NULL AND NOT @JOB_COMPONENT_NBR IS NULL) AND (@INCL_CDP_MEDIA = 0)
	BEGIN		
		SET @SQL = @SQL + '
				AND (DTL.JOB_NUMBER = @JOB_NUMBER AND DTL.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR)
		'
	END
	IF (NOT @JOB_NUMBER IS NULL AND NOT @JOB_COMPONENT_NBR IS NULL) AND (@INCL_CDP_MEDIA = 1)
	BEGIN		
		SET @SQL = @SQL + '
				AND ((DTL.JOB_NUMBER = @JOB_NUMBER AND DTL.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR) OR (DTL.JOB_NUMBER IS NULL AND DTL.JOB_COMPONENT_NBR IS NULL))
		'
	END
	IF NOT @CL_CODE IS NULL 
	BEGIN		
		SET @SQL = @SQL + '
				AND HDR.CL_CODE = @CL_CODE
		'
	END
	IF NOT @DIV_CODE IS NULL 
	BEGIN		
		SET @SQL = @SQL + '
				AND HDR.DIV_CODE = @DIV_CODE
		'
	END
	IF NOT @PRD_CODE IS NULL 
	BEGIN		
		SET @SQL = @SQL + '
				AND HDR.PRD_CODE = @PRD_CODE
		'
	END
	SET @SQL = @SQL + ';'

	SET @PARAMETER_LIST = '@JOB_NUMBER INT, @JOB_COMPONENT_NBR SMALLINT, @CL_CODE VARCHAR(6), @DIV_CODE VARCHAR(6), @PRD_CODE VARCHAR(6)';
	EXEC sp_executesql @SQL, @PARAMETER_LIST, @JOB_NUMBER, @JOB_COMPONENT_NBR, @CL_CODE, @DIV_CODE, @PRD_CODE;

END;

-- FINAL SELECT
BEGIN
	SELECT 
		* 
	FROM 
		#MEDIA_ORDERS
	ORDER BY
		IsInJob DESC,
		OrderType,
		OrderDate DESC
		;
END

-- CLEAN UP
BEGIN
	DROP TABLE #MEDIA_ORDERS;
END

/*=========== QUERY ===========*/
