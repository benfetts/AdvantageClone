CREATE PROCEDURE [dbo].[advsp_media_order_ok_to_generate]
	@MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_IDs varchar(max),
	@ORDER_NUMBERS varchar(max)
AS

--declare @MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_IDs varchar(max)
--set @MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_IDs = '15822,20541'--,15816,20540'

--select IS_ORIGINAL, IS_SUBMITTED, * from MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL
--where MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID IN (SELECT items FROM dbo.udf_split_list(@MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_IDs, ','))

IF @MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_IDs IS NULL 
BEGIN
	SELECT @MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_IDs = STUFF((SELECT DISTINCT ',' + CAST(MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID as varchar)
		FROM MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_DATE 
		WHERE ORDER_NBR IN (SELECT items FROM dbo.udf_split_list(@ORDER_NUMBERS, ','))
		FOR XML PATH('')),1,1,'')
END

IF EXISTS(SELECT 1 FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL 
			WHERE IS_ORIGINAL = 0 
			AND IS_SUBMITTED = 1
			AND MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID IN (SELECT items FROM dbo.udf_split_list(@MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_IDs, ','))
			)
BEGIN
	SELECT DISTINCT VendorCode = VN_CODE, OrderNumber = MDD.ORDER_NBR, IsSubmitted = CAST(1 as bit)		--,MD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID
	FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL MD
		INNER JOIN dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_DATE MDD ON MD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID = MDD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID 
		INNER JOIN dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL MSD ON MD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID = MSD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID 
																			AND MSD.IS_ORIGINAL = 0 AND MSD.IS_SUBMITTED = 1
	WHERE MD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID IN (SELECT items FROM dbo.udf_split_list(@MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_IDs, ','))
	AND MDD.ORDER_NBR IS NOT NULL
END
ELSE IF EXISTS(SELECT 1 FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL 
			WHERE IS_ORIGINAL = 0 
			AND IS_SUBMITTED = 0
			AND MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID IN (SELECT items FROM dbo.udf_split_list(@MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_IDs, ','))
			)
BEGIN
	SELECT DISTINCT VendorCode = VN_CODE, OrderNumber = MDD.ORDER_NBR, IsSubmitted = CAST(0	as bit)	--,MD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID
	FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL MD
		INNER JOIN dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_DATE MDD ON MD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID = MDD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID 
		INNER JOIN dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL MSD ON MD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID = MSD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID 
																			AND MSD.IS_ORIGINAL = 0 AND MSD.IS_SUBMITTED = 0
	WHERE MD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID IN (SELECT items FROM dbo.udf_split_list(@MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_IDs, ','))
	AND MDD.ORDER_NBR IS NOT NULL
END
