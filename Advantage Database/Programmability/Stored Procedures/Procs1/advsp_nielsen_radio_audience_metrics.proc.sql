CREATE PROCEDURE [dbo].[advsp_nielsen_radio_audience_metrics]
	@NIELSEN_RADIO_REPORT_TYPE_CODE varchar(2),
	@NIELSEN_RADIO_PERIOD_ID int,
	@NIELSEN_RADIO_MARKET_NUMBER int,
	@GEO_INDICATOR smallint,
	@NIELSEN_RADIO_QUALITATIVE_ID int,
	@NIELSEN_RADIO_DAYPART_ID int,
	@LISTENING_LOCATION char(1),
	@STATION_COMBO_TYPE smallint,
	@SelectedMediaDemographicIDs varchar(max)
AS
BEGIN
/*
DECLARE	@NIELSEN_RADIO_REPORT_TYPE_CODE varchar(2),	--parent
		@NIELSEN_RADIO_PERIOD_ID int,				--parent
		@NIELSEN_RADIO_MARKET_NUMBER int,			--parent
		@GEO_INDICATOR smallint,					--parent
		@NIELSEN_RADIO_QUALITATIVE_ID int,			--parent
		@NIELSEN_RADIO_DAYPART_ID int,				--child
		@LISTENING_LOCATION char(1),				--child
		@STATION_COMBO_TYPE smallint,				--child
		@SelectedMediaDemographicIDs varchar(max)

SET @NIELSEN_RADIO_REPORT_TYPE_CODE = '5'
SET @NIELSEN_RADIO_PERIOD_ID = 2
SET @NIELSEN_RADIO_MARKET_NUMBER = 1
SET @GEO_INDICATOR = 1
SET @NIELSEN_RADIO_QUALITATIVE_ID = 1
SET @NIELSEN_RADIO_DAYPART_ID = 10
SET @LISTENING_LOCATION = '1'
SET @STATION_COMBO_TYPE = 1 
SET @SelectedMediaDemographicIDs = '139'
*/
	DECLARE @NIELSEN_RADIO_SEGMENT_PARENT_ID int

	SELECT @NIELSEN_RADIO_SEGMENT_PARENT_ID = NIELSEN_RADIO_SEGMENT_PARENT_ID
	FROM dbo.NIELSEN_RADIO_SEGMENT_PARENT 
	WHERE NIELSEN_RADIO_PERIOD_ID = @NIELSEN_RADIO_PERIOD_ID
	AND NIELSEN_RADIO_REPORT_TYPE_CODE = @NIELSEN_RADIO_REPORT_TYPE_CODE
	AND NIELSEN_RADIO_MARKET_NUMBER = @NIELSEN_RADIO_MARKET_NUMBER
	AND GEO_INDICATOR = @GEO_INDICATOR 
	AND NIELSEN_RADIO_QUALITATIVE_ID = @NIELSEN_RADIO_QUALITATIVE_ID 

	--SELECT @NIELSEN_RADIO_SEGMENT_CHILD_ID = NIELSEN_RADIO_SEGMENT_CHILD_ID
	--FROM dbo.NIELSEN_RADIO_SEGMENT_CHILD 
	--WHERE NIELSEN_RADIO_DAYPART_ID = @NIELSEN_RADIO_DAYPART_ID 
	--AND LISTENING_LOCATION = @LISTENING_LOCATION 
	--AND STATION_COMBO_TYPE = @STATION_COMBO_TYPE 
	
	--SELECT @NIELSEN_RADIO_SEGMENT_CHILD_ID_PUR = NIELSEN_RADIO_SEGMENT_CHILD_ID
	--FROM dbo.NIELSEN_RADIO_SEGMENT_CHILD 
	--WHERE NIELSEN_RADIO_DAYPART_ID = @NIELSEN_RADIO_DAYPART_ID 
	--AND LISTENING_LOCATION = @LISTENING_LOCATION 
	--AND STATION_COMBO_TYPE = 9 
	--AND NIELSEN_RADIO_STATION_COMBO_ID = 999999

	--SELECT * FROM dbo.[advtf_nielsen_radio_universe_get](@NIELSEN_RADIO_SEGMENT_PARENT_ID)
	--SELECT * FROM dbo.[advtf_nielsen_radio_pur_get_pur](@NIELSEN_RADIO_SEGMENT_PARENT_ID, @NIELSEN_RADIO_SEGMENT_CHILD_ID_PUR, @SelectedMediaDemographicIDs)
	--SELECT * FROM dbo.[advtf_nielsen_radio_intab_get_intab](@NIELSEN_RADIO_SEGMENT_PARENT_ID, @SelectedMediaDemographicIDs)

	SELECT
		[Demographic] = md.[DESCRIPTION],
		[Universe] = SUM(Universe),
		[Impressions] = SUM([Impressions]),
		[Rating] = CASE WHEN SUM(Universe) = 0 THEN 0 ELSE CAST(SUM(Impressions) * 100 as decimal) / CAST(SUM(Universe) as decimal) END,
		[PUR] = SUM([PUR]),
		[PURPercent] = CASE WHEN SUM(Universe) = 0 THEN 0 ELSE CAST(SUM(PUR) * 100 as decimal) / CAST(SUM(Universe) as decimal) END,
		[Share] = CASE WHEN SUM(PUR) = 0 THEN 0 ELSE CAST(SUM(Impressions) * 100 as decimal) / CAST(SUM(PUR) as decimal) END,
		[Intab] = SUM([Intab]),
		[StationName] = NRS.NAME
	FROM (
		SELECT
			AQH.nielsen_demo_code,
			[Universe] = UE.ue,
			[Impressions] = AQH.aph,
			[PUR] = PUR.pur,
			[Intab] = INTAB.intab,
			AQH.MEDIA_DEMO_ID,
			AQH.NIELSEN_RADIO_STATION_COMBO_ID
		FROM dbo.[advtf_nielsen_radio_audience_get_aqh](@NIELSEN_RADIO_SEGMENT_PARENT_ID, @NIELSEN_RADIO_DAYPART_ID, @LISTENING_LOCATION, @STATION_COMBO_TYPE, @SelectedMediaDemographicIDs) AQH
			INNER JOIN dbo.[advtf_nielsen_radio_universe_get](@NIELSEN_RADIO_SEGMENT_PARENT_ID) UE
				ON AQH.nielsen_demo_code = UE.nielsen_demo_code 
			INNER JOIN dbo.[advtf_nielsen_radio_pur_get_pur](@NIELSEN_RADIO_SEGMENT_PARENT_ID, @NIELSEN_RADIO_DAYPART_ID, @LISTENING_LOCATION, @SelectedMediaDemographicIDs) PUR
				ON PUR.nielsen_demo_code = AQH.nielsen_demo_code AND PUR.MEDIA_DEMO_ID = AQH.MEDIA_DEMO_ID 
			INNER JOIN dbo.[advtf_nielsen_radio_intab_get_intab](@NIELSEN_RADIO_SEGMENT_PARENT_ID, @SelectedMediaDemographicIDs) INTAB
				ON INTAB.nielsen_demo_code = AQH.nielsen_demo_code AND INTAB.MEDIA_DEMO_ID = AQH.MEDIA_DEMO_ID 
		) radiodata
		INNER JOIN dbo.MEDIA_DEMO md
			ON radiodata.MEDIA_DEMO_ID = md.MEDIA_DEMO_ID
		INNER JOIN dbo.NIELSEN_RADIO_STATION NRS
			ON NRS.NIELSEN_RADIO_MARKET_NUMBER = @NIELSEN_RADIO_MARKET_NUMBER AND NRS.COMBO_ID = radiodata.NIELSEN_RADIO_STATION_COMBO_ID
	GROUP BY 
		md.[DESCRIPTION], NRS.NAME
END
GO
