CREATE PROCEDURE [dbo].[advsp_po_load_approved_est] 
		@JOB_NUMBER INT = 0, 
		@JOB_COMP_NUMBER SMALLINT = 0,
		@CAMPAIGN_ID INT = 0,
		@VN_CODE VARCHAR(6) = NULL,
		@INCLUDE_CLOSED_COMPS BIT = 1
AS
BEGIN

SELECT [JobNumber] = V_ESTIMATEAPPR.JOB_NUMBER,
	   [JobDescription] = JOB_LOG.JOB_DESC, 
	   [JobComponentNumber] = V_ESTIMATEAPPR.JOB_COMPONENT_NBR, 
	   [JobComponentDescription] = JOB_COMPONENT.JOB_COMP_DESC,
	   [CampaignID] = CAMPAIGN.CMP_IDENTIFIER,
	   [CampaignCode] = CAMPAIGN.CMP_CODE,
	   [CampaignName] = CAMPAIGN.CMP_NAME,
	   [NonBillable] = JOB_COMPONENT.NOBILL_FLAG,
	   [EstimateNumber] = ESTIMATE_REV_DET.ESTIMATE_NUMBER, 
	   [EstimateComponentNumber] = ESTIMATE_REV_DET.EST_COMPONENT_NBR,
	   [EstimateQuoteNumber] = V_ESTIMATEAPPR.EST_QUOTE_NBR,
	   [FunctionCode] = ESTIMATE_REV_DET.FNC_CODE,
	   [FunctionDescription] = FUNCTIONS.FNC_DESCRIPTION,
	   [VendorCode] = ESTIMATE_REV_DET.EST_REV_SUP_BY_CDE,
	   [VendorName] = VENDOR.VN_NAME,
	   [Quantity] = ESTIMATE_REV_DET.EST_REV_QUANTITY,
	   [Rate] = ESTIMATE_REV_DET.EST_REV_RATE,
	   [ExtendedAmount] = ESTIMATE_REV_DET.EST_REV_EXT_AMT,
	   [MarkupPercent] = ESTIMATE_REV_DET.EST_REV_COMM_PCT,
	   [ExtendedMarkupAmount] = ESTIMATE_REV_DET.EXT_MARKUP_AMT
FROM dbo.ESTIMATE_REV_DET INNER JOIN
	 dbo.V_ESTIMATEAPPR ON ESTIMATE_REV_DET.ESTIMATE_NUMBER = V_ESTIMATEAPPR.ESTIMATE_NUMBER AND 
						   ESTIMATE_REV_DET.EST_COMPONENT_NBR = V_ESTIMATEAPPR.EST_COMPONENT_NBR AND
						   ESTIMATE_REV_DET.EST_QUOTE_NBR = V_ESTIMATEAPPR.EST_QUOTE_NBR AND
						   ESTIMATE_REV_DET.EST_REV_NBR = V_ESTIMATEAPPR.EST_REVISION_NBR INNER JOIN
	 dbo.JOB_LOG ON V_ESTIMATEAPPR.JOB_NUMBER = JOB_LOG.JOB_NUMBER INNER JOIN
	 dbo.JOB_COMPONENT ON V_ESTIMATEAPPR.JOB_NUMBER = JOB_COMPONENT.JOB_NUMBER AND 
						  V_ESTIMATEAPPR.JOB_COMPONENT_NBR = JOB_COMPONENT.JOB_COMPONENT_NBR INNER JOIN
	 dbo.FUNCTIONS ON ESTIMATE_REV_DET.FNC_CODE = FUNCTIONS.FNC_CODE LEFT OUTER JOIN
	 dbo.VENDOR ON ESTIMATE_REV_DET.EST_REV_SUP_BY_CDE = VENDOR.VN_CODE LEFT OUTER JOIN
	 dbo.CAMPAIGN ON JOB_LOG.CMP_CODE = CAMPAIGN.CMP_CODE AND
					 JOB_LOG.CL_CODE = CAMPAIGN.CL_CODE AND 
					 1 = CASE WHEN CAMPAIGN.DIV_CODE IS NULL THEN 1 WHEN JOB_LOG.DIV_CODE = CAMPAIGN.DIV_CODE THEN 1 ELSE 0 END AND
					 1 = CASE WHEN CAMPAIGN.PRD_CODE IS NULL THEN 1 WHEN JOB_LOG.PRD_CODE = CAMPAIGN.PRD_CODE THEN 1 ELSE 0 END 
WHERE [FUNCTIONS].FNC_TYPE = 'V' AND
	  1 = CASE 
			WHEN @JOB_NUMBER = 0 THEN 1 
			WHEN V_ESTIMATEAPPR.JOB_NUMBER = @JOB_NUMBER THEN 1 
			ELSE 0 
		  END AND
	  1 = CASE 
			WHEN @JOB_NUMBER = 0 AND @JOB_COMP_NUMBER = 0 THEN 1 
			WHEN V_ESTIMATEAPPR.JOB_NUMBER = @JOB_NUMBER AND V_ESTIMATEAPPR.JOB_COMPONENT_NBR = @JOB_COMP_NUMBER THEN 1 
			ELSE 0 
		  END AND
	  1 = CASE 
			WHEN @CAMPAIGN_ID IS NULL OR @CAMPAIGN_ID = 0 THEN 1 
			WHEN CAMPAIGN.CMP_IDENTIFIER = @CAMPAIGN_ID THEN 1 
			ELSE 0 
		  END AND
	  1 = CASE 
			WHEN @VN_CODE IS NULL OR @VN_CODE = '' THEN 1
			WHEN ESTIMATE_REV_DET.EST_REV_SUP_BY_CDE = @VN_CODE THEN 1
			ELSE 0
		  END AND
	  1 = CASE 
			WHEN @INCLUDE_CLOSED_COMPS = 1 THEN 1
			WHEN JOB_COMPONENT.JOB_PROCESS_CONTRL NOT IN (6,12) THEN 1
			ELSE 0 
		  END
	  
END