CREATE PROCEDURE [dbo].[advsp_populate_billing_cmd_center]
	@bill_user_in varchar(100),
	@ret_val integer OUTPUT 
AS

SET NOCOUNT ON

DECLARE @ar_pp varchar(6), @bcc_id integer	
	
SELECT @ar_pp = ( SELECT PPPERIOD FROM dbo.POSTPERIOD WHERE PPARCURMTH = 'C' )

SELECT @bcc_id = ( SELECT TOP 1 bcc.BCC_ID
                     FROM dbo.BILLING_CMD_CENTER bcc 
                    WHERE bcc.BILLING_USER = @bill_user_in )

IF ( @bcc_id IS NULL )
BEGIN
	INSERT INTO dbo.BILLING_CMD_CENTER ( BILLING_USER, CREATE_DATE, P_SELECT_BY, 
				PROD_FLAG, SEL_OPTION, P_ET_CUTOFF_DATE, P_IO_CUTOFF_DATE, 
				P_AB_CUTOFF_DATE, P_AP_CUTOFF_PPD, BA_BATCH_ID, MEDIA_FLAG, M_SELECT_BY, 
				M_START_DATE, M_CUTOFF_DATE, NEWSPAPER, MAGAZINE, RADIO, TELEVISION, 
				OUT_OF_HOME, INTERNET, M_BRDCAST_MTH1, M_BRDCAST_MTH2, INCL_UNBILLED_ONLY, 
	            INCL_ZERO_SPOTS, DATE_CUTOFF_TO_USE, RADIO_DAILY, TV_DAILY, RADIO_MONTHLY,
	            TV_MONTHLY )
	   VALUES ( @bill_user_in, getdate( ), 0, 0, 1, NULL, NULL, NULL,
				NULL, NULL, 0, 0, NULL, NULL, 0, 0, 0, 0, 0, 0, NULL, NULL, 1, 1, 1, 0, 0, 0, 0 )
				
	SELECT @bcc_id = @@IDENTITY			 	
END

 SELECT bcc.BCC_ID,
		COALESCE( bcc.PROD_FLAG, 0 ) AS PROD_FLAG,
		bcc.P_SELECT_BY, 
		bcc.SEL_OPTION,
		bcc.P_AP_CUTOFF_PPD,
		CONVERT( varchar(10), bcc.P_ET_CUTOFF_DATE, 101 ) AS P_ET_CUTOFF_DATE, 
		CONVERT( varchar(10), bcc.P_IO_CUTOFF_DATE, 101 ) AS P_IO_CUTOFF_DATE, 
		CONVERT( varchar(10), bcc.P_AB_CUTOFF_DATE, 101 ) AS P_AB_CUTOFF_DATE,
		bcc.BA_BATCH_ID,
		bab.BA_BATCH_DESC,
		bcc.SELECTED_JOBS, 
		COALESCE( bcc.MEDIA_FLAG, 0 ) AS MEDIA_FLAG,
		COALESCE( bcc.M_SELECT_BY, 0 ) AS M_SELECT_BY,
		CONVERT( varchar(10), bcc.M_START_DATE, 101 ) AS M_START_DATE,		 
		CONVERT( varchar(10), bcc.M_CUTOFF_DATE, 101 ) AS M_CUTOFF_DATE, 
		bcc.NEWSPAPER, bcc.MAGAZINE, bcc.RADIO,	
		bcc.TELEVISION,	bcc.OUT_OF_HOME, bcc.INTERNET, 
		CONVERT( varchar(10), bcc.M_BRDCAST_MTH1, 101 ) AS M_BRDCAST_MTH1,
		CONVERT( varchar(10), bcc.M_BRDCAST_MTH2, 101 ) AS M_BRDCAST_MTH2,
		COALESCE( bcc.INCL_UNBILLED_ONLY, 1 ) AS INCL_UNBILLED_ONLY, 
		COALESCE( bcc.INCL_ZERO_SPOTS, 1 ) AS INCL_ZERO_SPOTS, 
		COALESCE( bcc.DATE_CUTOFF_TO_USE, 1 ) AS DATE_TO_USE,
		bcc.SELECTED_ORDERS, bcc.RADIO_DAILY, bcc.TV_DAILY,	
		bcc.RADIO_MONTHLY, bcc.TV_MONTHLY, @ar_pp AS AR_PPD_CURRENT
   FROM dbo.BILLING_CMD_CENTER bcc LEFT OUTER JOIN dbo.BILL_APPR_BATCH bab
     ON ( bcc.BA_BATCH_ID = bab.BA_BATCH_ID )
  WHERE bcc.BCC_ID = @bcc_id
  
