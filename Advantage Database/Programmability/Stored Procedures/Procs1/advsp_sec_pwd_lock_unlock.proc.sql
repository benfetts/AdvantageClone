IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id(N'[advsp_sec_pwd_lock_unlock]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
    DROP PROCEDURE [dbo].[advsp_sec_pwd_lock_unlock]
GO
CREATE PROCEDURE [dbo].[advsp_sec_pwd_lock_unlock]
@USER_CODE VARCHAR(100),
@ACTION_ID SMALLINT -- 0 = LOCK, 1 = UNLOCK, 2 = LOCK ALL, 3 = UNLOCK ALL, 4 = CLEAR ALL PASSWORDS
AS
/*=========== QUERY ===========*/
BEGIN
	--  INIT
	BEGIN
		DECLARE
			@SEC_PWD_LOCK_ID INT,			
			@IS_LOCKED BIT
			;
		SELECT
			@IS_LOCKED = 0,
			@SEC_PWD_LOCK_ID = 0
			;
	END
	--  SINGLE USER ACTIONS
	IF @ACTION_ID IN (0, 1)
	BEGIN
		--  PROCESS
		IF @USER_CODE IS NOT NULL AND DATALENGTH(@USER_CODE) > 0
		BEGIN
			DECLARE @REC TABLE (ID INT, USER_CODE VARCHAR(100), ATTEMPTS INT, LOCK_DATE SMALLDATETIME);
			INSERT INTO @REC
			EXEC [dbo].[advsp_sec_pwd_lock_load] @USER_CODE;
			--  IF HAS REC
			IF (SELECT COUNT(1) FROM @REC) > 0
			BEGIN
				--  GET REC
				BEGIN
					SELECT @SEC_PWD_LOCK_ID = (SELECT TOP 1 ID FROM @REC);
				END
				--  IF REC FOUND
				IF @SEC_PWD_LOCK_ID IS NOT NULL AND @SEC_PWD_LOCK_ID > 0
				BEGIN
					--  LOCK OR UNLOCK
					BEGIN
						IF @ACTION_ID = 0	--  LOCK
						BEGIN
							UPDATE SEC_PWD_LOCK WITH(ROWLOCK)
							SET LOCK_DATE = GETDATE()
							WHERE
								ID = @SEC_PWD_LOCK_ID;					
						END
						IF @ACTION_ID = 1  --  UNLOCK
						BEGIN
							UPDATE SEC_PWD_LOCK WITH(ROWLOCK)
							SET ATTEMPTS = 0, LOCK_DATE = NULL
							WHERE
								ID = @SEC_PWD_LOCK_ID
						END
					END
				END
			END
		END
		--  SET RETURN
		BEGIN
			SELECT
				@IS_LOCKED =	CASE
									WHEN SPL.LOCK_DATE IS NOT NULL THEN 1
									ELSE 0
								END
			FROM
				SEC_PWD_LOCK SPL WITH(NOLOCK)
			WHERE
				SPL.ID = @SEC_PWD_LOCK_ID;
		END
	END
	IF @ACTION_ID IN (2, 3)
	BEGIN
		--  MAKE SURE ALL CURRENT USERS ARE IN LOCK TABLE
		INSERT INTO SEC_PWD_LOCK (USER_CODE)
		SELECT
			SU.USER_CODE
		FROM
			SEC_USER SU WITH(NOLOCK)
			LEFT OUTER JOIN SEC_PWD_LOCK SPL WITH(NOLOCK) ON SU.USER_CODE = SPL.USER_CODE
		WHERE
			SPL.USER_CODE IS NULL
			;
		--  LOCK ALL
		IF @ACTION_ID = 2
		BEGIN
			UPDATE SEC_PWD_LOCK WITH(ROWLOCK)
			SET 
				ATTEMPTS = 0,
				LOCK_DATE = GETDATE();
			SELECT @IS_LOCKED = 1;
		END
		--  UNLOCK ALL
		IF @ACTION_ID = 3
		BEGIN
			UPDATE SEC_PWD_LOCK WITH(ROWLOCK)
			SET 
				ATTEMPTS = 0,
				LOCK_DATE = NULL
			SELECT @IS_LOCKED = 0;
		END
	END
	--  CLEAR ALL PASSWORDS
	IF @ACTION_ID = 4
	BEGIN
		UPDATE SEC_USER WITH(ROWLOCK)
		SET
			[PASSWORD] = '';
		UPDATE SEC_PWD_LOCK WITH(ROWLOCK)
		SET
			LOCK_DATE = NULL,
			ATTEMPTS =  0;
	END
	SELECT
		ISNULL(@IS_LOCKED, 0);
END
/*=========== QUERY ===========*/
