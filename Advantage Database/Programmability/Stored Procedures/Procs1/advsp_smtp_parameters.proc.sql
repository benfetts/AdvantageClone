
CREATE PROCEDURE [dbo].[advsp_smtp_parameters] ( @user_code varchar(100) )
AS
BEGIN
	SET NOCOUNT ON;
	DECLARE @emp_code varchar(6)
	SET @emp_code = (SELECT EMP_CODE FROM dbo.APP_SECURITY WHERE UPPER(USER_CODE) = UPPER(@user_code))

	 SELECT @user_code AS USER_CODE,
			@emp_code AS EMP_CODE,
			ISNULL( a.SMTP_SERVER, '' ) AS SMTP_SERVER,
			a.SMTP_USE_EMP_FROM AS SMTP_USE_EMP_FROM,
			CASE
				WHEN ( a.SMTP_USE_EMP_LOGIN = 1 AND e.EMAIL_USERNAME IS NOT NULL ) THEN e.EMP_EMAIL
				ELSE ISNULL( a.SMTP_SENDER, '' )
			END AS SMTP_SENDER,
			CASE
				WHEN ( a.SMTP_USE_EMP_LOGIN = 1 AND e.EMAIL_USERNAME IS NOT NULL ) THEN e.EMAIL_USERNAME
				ELSE ISNULL( a.EMAIL_USERNAME, '' )
			END AS EMAIL_USERNAME,
			CASE
				WHEN ( a.SMTP_USE_EMP_LOGIN = 1 AND e.EMAIL_USERNAME IS NOT NULL ) THEN e.EMAIL_PWD
				ELSE ISNULL(a.EMAIL_PWD,'')
			END AS EMAIL_PWD,
			CASE
				WHEN ( e.EMAIL_REPLY_TO IS NOT NULL ) THEN e.EMAIL_REPLY_TO
				ELSE ISNULL( a.EMAIL_REPLY_TO, '' )
			END AS EMAIL_REPLY_TO,
			ISNULL( a.SMTP_AUTH_METHOD, 1 ) AS SMTP_AUTH_METHOD,
			ISNULL( a.SMTP_PORT_NUMBER, 25 ) AS SMTP_PORT_NUMBER,
			ISNULL( a.SMTP_SECURE_TYPE, 0 ) AS SMTP_SECURE_TYPE,
			a.ACCESS_RPT_PATH,
			a.MB_KEY,
			e.EMP_EMAIL	
	   FROM dbo.AGENCY AS a	CROSS JOIN dbo.EMPLOYEE AS e
	  WHERE e.EMP_CODE = @emp_code	
END
