/****** Object:  StoredProcedure [dbo].[advsp_traffic_schedule_FindAndReplace_Dates]    Script Date: 10/8/2021 1:02:02 PM ******/
SET ANSI_NULLS OFF
GO

SET QUOTED_IDENTIFIER OFF
GO

CREATE PROCEDURE [dbo].[advsp_traffic_schedule_FindAndReplace_Dates] 
	@TYPE SMALLINT,
	@DATE_FROM SMALLDATETIME, 
	@DATE_TO SMALLDATETIME,
	@NEW_DATE SMALLDATETIME,
	@COMPONENTS VARCHAR(MAX)
AS
BEGIN

	DECLARE @JOB_COMPONENTS TABLE(JOB_NUMBER INT, JOB_COMPONENT_NBR SMALLINT)
		
	INSERT INTO @JOB_COMPONENTS
		SELECT DISTINCT
			[JOB_NUMBER] = CONVERT(INT, LEFT(items, CHARINDEX(',', items) - 1)),
			[JOB_COMPONENT_NBR] = CONVERT(SMALLINT, RIGHT(items, LEN(items) - CHARINDEX(',', items)))
		FROM
			dbo.udf_split_list(@COMPONENTS, '|')

	IF @TYPE = 0 OR @TYPE = 1 OR @TYPE = 2
	BEGIN
		UPDATE
			JTD
		SET
			TASK_START_DATE = CASE WHEN @TYPE = 0 THEN @NEW_DATE ELSE TASK_START_DATE END,
			JOB_REVISED_DATE = CASE WHEN @TYPE = 1 THEN @NEW_DATE ELSE JOB_REVISED_DATE END,
			JOB_COMPLETED_DATE = CASE WHEN @TYPE = 2 THEN @NEW_DATE ELSE JOB_COMPLETED_DATE END
		FROM 
			dbo.JOB_TRAFFIC_DET JTD
		INNER JOIN
			@JOB_COMPONENTS JC ON JTD.JOB_NUMBER = JC.JOB_NUMBER AND
								  JTD.JOB_COMPONENT_NBR = JC.JOB_COMPONENT_NBR
		WHERE
			1 = CASE
					WHEN @TYPE = 0 AND TASK_START_DATE BETWEEN @DATE_FROM AND @DATE_TO THEN 1
					WHEN @TYPE = 0 AND TASK_START_DATE IS NULL AND @DATE_FROM IS NULL AND @DATE_TO IS NULL THEN 1
					WHEN @TYPE = 1 AND JOB_REVISED_DATE BETWEEN @DATE_FROM AND @DATE_TO THEN 1
					WHEN @TYPE = 1 AND JOB_REVISED_DATE IS NULL AND @DATE_FROM IS NULL AND @DATE_TO IS NULL THEN 1
					WHEN @TYPE = 2 AND JOB_COMPLETED_DATE BETWEEN @DATE_FROM AND @DATE_TO THEN 1
					WHEN @TYPE = 2 AND JOB_COMPLETED_DATE IS NULL AND @DATE_FROM IS NULL AND @DATE_TO IS NULL THEN 1
					ELSE 0 
				END
		
		SELECT @@ROWCOUNT
	END

	IF @TYPE = 3 OR @TYPE = 4
	BEGIN
		if @DATE_FROM IS NULL AND @DATE_TO IS NULL
		BEGIN
			UPDATE
				JCS
			SET
				[START_DATE] = CASE WHEN @TYPE = 3 THEN @NEW_DATE ELSE [START_DATE] END,
				JOB_FIRST_USE_DATE = CASE WHEN @TYPE = 4 THEN @NEW_DATE ELSE JOB_FIRST_USE_DATE END
			FROM 
				dbo.JOB_COMPONENT JCS
			INNER JOIN
				@JOB_COMPONENTS JC ON JCS.JOB_NUMBER = JC.JOB_NUMBER AND
									  JCS.JOB_COMPONENT_NBR = JC.JOB_COMPONENT_NBR
			WHERE
				1 = CASE
						WHEN @TYPE = 3 AND [START_DATE] IS NULL THEN 1
						WHEN @TYPE = 4 AND JOB_FIRST_USE_DATE IS NULL THEN 1
						ELSE 0 
					END
		
			SELECT @@ROWCOUNT
		END
		ELSE
		BEGIN
			UPDATE
				JCS
			SET
				[START_DATE] = CASE WHEN @TYPE = 3 THEN @NEW_DATE ELSE [START_DATE] END,
				JOB_FIRST_USE_DATE = CASE WHEN @TYPE = 4 THEN @NEW_DATE ELSE JOB_FIRST_USE_DATE END
			FROM 
				dbo.JOB_COMPONENT JCS
			INNER JOIN
				@JOB_COMPONENTS JC ON JCS.JOB_NUMBER = JC.JOB_NUMBER AND
									  JCS.JOB_COMPONENT_NBR = JC.JOB_COMPONENT_NBR
			WHERE
				1 = CASE
						WHEN @TYPE = 3 AND [START_DATE] BETWEEN @DATE_FROM AND @DATE_TO THEN 1
						WHEN @TYPE = 4 AND JOB_FIRST_USE_DATE BETWEEN @DATE_FROM AND @DATE_TO THEN 1
						ELSE 0 
					END
		
			SELECT @@ROWCOUNT
		END
		
	END

	IF @TYPE = 5
	BEGIN
		if @DATE_FROM IS NULL AND @DATE_TO IS NULL
		BEGIN
			UPDATE
				JT
			SET
				COMPLETED_DATE = CASE WHEN @TYPE = 5 THEN @NEW_DATE ELSE COMPLETED_DATE END
			FROM 
				dbo.JOB_TRAFFIC JT
			INNER JOIN
				@JOB_COMPONENTS JC ON JT.JOB_NUMBER = JC.JOB_NUMBER AND
									  JT.JOB_COMPONENT_NBR = JC.JOB_COMPONENT_NBR
			WHERE
				1 = CASE
						WHEN @TYPE = 5 AND COMPLETED_DATE IS NULL THEN 1
						ELSE 0 
					END
		
			SELECT @@ROWCOUNT
		END
		ELSE
		BEGIN
			UPDATE
				JT
			SET
				COMPLETED_DATE = CASE WHEN @TYPE = 5 THEN @NEW_DATE ELSE COMPLETED_DATE END
			FROM 
				dbo.JOB_TRAFFIC JT
			INNER JOIN
				@JOB_COMPONENTS JC ON JT.JOB_NUMBER = JC.JOB_NUMBER AND
									  JT.JOB_COMPONENT_NBR = JC.JOB_COMPONENT_NBR
			WHERE
				1 = CASE
						WHEN @TYPE = 5 AND COMPLETED_DATE BETWEEN @DATE_FROM AND @DATE_TO THEN 1
						ELSE 0 
					END
		
			SELECT @@ROWCOUNT
		END
		
	END

			
	

END
GO
