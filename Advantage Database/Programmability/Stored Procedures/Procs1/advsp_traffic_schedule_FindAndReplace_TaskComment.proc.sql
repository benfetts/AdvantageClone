CREATE PROCEDURE [dbo].[advsp_traffic_schedule_FindAndReplace_TaskComment] 
	@NEW_COMMENT VARCHAR(MAX),
	@FNC_CODE VARCHAR(10),
	@COMPONENTS VARCHAR(MAX)
AS
BEGIN

	DECLARE @JOB_COMPONENTS TABLE(JOB_NUMBER INT, JOB_COMPONENT_NBR SMALLINT)
	
	INSERT INTO @JOB_COMPONENTS
		SELECT DISTINCT
			[JOB_NUMBER] = CONVERT(INT, LEFT(items, CHARINDEX(',', items) - 1)),
			[JOB_COMPONENT_NBR] = CONVERT(SMALLINT, RIGHT(items, LEN(items) - CHARINDEX(',', items)))
		FROM
			dbo.udf_split_list(@COMPONENTS, '|')	
	

		UPDATE 
			JTD
		SET
			JTD.FNC_COMMENTS = @NEW_COMMENT
		FROM
			dbo.JOB_TRAFFIC_DET JTD
		INNER JOIN
			@JOB_COMPONENTS JC ON JC.JOB_NUMBER = JTD.JOB_NUMBER AND
								   JC.JOB_COMPONENT_NBR = JTD.JOB_COMPONENT_NBR
		WHERE			
			1 = CASE WHEN ISNULL(@FNC_CODE, '') = '' THEN 1 WHEN @FNC_CODE = JTD.FNC_CODE THEN 1 ELSE 0 END

	

	SELECT @@ROWCOUNT

END