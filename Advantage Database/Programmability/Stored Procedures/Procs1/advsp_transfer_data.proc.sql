--insert the next (3) statements at the top of the script while debugging
if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[advsp_transfer_data]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[advsp_transfer_data]
GO

CREATE PROCEDURE [dbo].[advsp_transfer_data] (
	@ap_include tinyint = 1,				-- 0=do not include
	@et_include tinyint = 1,				-- 0=do not include
	@io_include tinyint = 1,				-- 0=do not include
	@start_date datetime = '1/1/1900',
	@end_date datetime = '12/31/2199')

-- ===============================================================================
-- advsp_transfer_data
-- #00 03/05/14 - initial
-- #01 03/06/14 - added english language field labels
-- ==============================================================================

AS
BEGIN
	SET NOCOUNT ON;

	SET @end_date = dateadd(s, -1, dateadd(d,1,@end_date))
-- ======================================================================================
-- MAIN DATA TABLE
-- ======================================================================================
CREATE TABLE #transfer_data(	
	REC_SOURCE						varchar(2) COLLATE SQL_Latin1_General_CP1_CS_AS,
	REC_ID							int NULL,
	REC_SEQ							smallint NULL,
	VN_EMP_CODE						varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	VN_EMP_NAME						varchar(255) COLLATE SQL_Latin1_General_CP1_CS_AS,
	INV_VCHR						varchar(26) COLLATE SQL_Latin1_General_CP1_CS_AS,
	[DATE]							datetime NULL,
	WIP_POST_PERIOD					varchar(8) COLLATE SQL_Latin1_General_CP1_CS_AS,
	LINE_NUMBER						int NULL,
	CL_CODE							varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	DIV_CODE						varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	PRD_CODE						varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	JOB_NUMBER						int NULL,
	JOB_DESC						varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS,
	JOB_COMPONENT_NBR				smallint NULL,
	FNC_CODE						varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	QTY								decimal(15,2) NULL,
	[HOURS]                         decimal(15,2) NULL,
	BILL_RATE						decimal(15,2) NULL,
	NET_AMT							decimal(15,2) NULL,
	NONRESALE_TAX					decimal(15,2) NULL,
	MARKUP_AMT						decimal(15,2) NULL,
	STATE_RESALE					decimal(15,2) NULL,
	COUNTY_RESALE					decimal(15,2) NULL,
	CITY_RESALE						decimal(15,2) NULL,
	LINE_TOTAL						decimal(15,2) NULL,
	NOBILL_FLG						tinyint NULL,
	BILL_HOLD_FLG					tinyint NULL,
	AR_INV_NBR						int NULL,
	AR_INV_SEQ						smallint NULL,
	AR_TYPE							varchar(3) COLLATE SQL_Latin1_General_CP1_CS_AS,
	AR_INV_DATE						smalldatetime NULL,
	AB_FLAG							tinyint NULL,
	MODIFY_DELETE					tinyint NULL,
	DELETE_FLAG						tinyint NULL,
	XFER_FROM_CLIENT				varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	XFER_FROM_DIVISION				varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	XFER_FROM_PRODUCT				varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	XFER_FROM_JOB					int NULL,
	XFER_FROM_JOB_DESC				varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS,
	XFER_FROM_JOB_COMP				smallint NULL,
	XFER_FROM_JOB_COMP_DESC			varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS,
	XFER_FROM_FNC					varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	XFER_FROM_ID					int NULL,
	XFER_FROM_SEQ					smallint NULL,
	XFER_FROM_LINE_NBR				smallint NULL,
	XFER_FROM_QTY					decimal(15,2) NULL,
	XFER_FROM_HOURS					decimal(15,2) NULL,
	XFER_FROM_BILL_RATE				decimal(15,2) NULL, 
	XFER_FROM_NET_AMT				decimal(15,2) NULL,
	XFER_FROM_NONRESALE_TAX			decimal(15,2) NULL,
	XFER_FROM_MARKUP_AMT			decimal(15,2) NULL, 
	XFER_FROM_STATE_RESALE			decimal(15,2) NULL, 
	XFER_FROM_COUNTY_RESALE			decimal(15,2) NULL, 
	XFER_FROM_CITY_RESALE			decimal(15,2) NULL, 
	XFER_FROM_LINE_TOTAL			decimal(15,2) NULL,
	XFER_FROM_NOBILL_FLG			tinyint NULL,
	XFER_FROM_BILL_HOLD_FLG			tinyint NULL,
	XFER_FROM_AR_INV_NBR			int NULL,
	XFER_FROM_AB_FLAG				tinyint NULL,
	XFER_FROM_MODIFY_DELETE			tinyint NULL,
	XFER_FROM_DELETE_FLAG			tinyint NULL,
	XFER_ADJ_USER					varchar(100) COLLATE SQL_Latin1_General_CP1_CS_AS,
	XFER_ADJ_DATE					datetime NULL,
	XFER_ADJ_DATE_VALUE				datetime NULL) 
	
CREATE TABLE #transfer_data_temp(	
	REC_SOURCE						varchar(2) COLLATE SQL_Latin1_General_CP1_CS_AS,
	REC_ID							int NULL,
	REC_SEQ							smallint NULL,
	VN_EMP_CODE						varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	VN_EMP_NAME						varchar(255) COLLATE SQL_Latin1_General_CP1_CS_AS,
	INV_VCHR						varchar(26) COLLATE SQL_Latin1_General_CP1_CS_AS,
	[DATE]							datetime NULL,
	WIP_POST_PERIOD					varchar(8) COLLATE SQL_Latin1_General_CP1_CS_AS,
	LINE_NUMBER						int NULL,
	CL_CODE							varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	DIV_CODE						varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	PRD_CODE						varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	JOB_NUMBER						int NULL,
	JOB_DESC						varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS,
	JOB_COMPONENT_NBR				smallint NULL,
	FNC_CODE						varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	QTY								decimal(15,2) NULL,
	[HOURS]                         decimal(15,2) NULL,
	BILL_RATE						decimal(15,2) NULL,
	NET_AMT							decimal(15,2) NULL,
	NONRESALE_TAX					decimal(15,2) NULL,
	MARKUP_AMT						decimal(15,2) NULL,
	STATE_RESALE					decimal(15,2) NULL,
	COUNTY_RESALE					decimal(15,2) NULL,
	CITY_RESALE						decimal(15,2) NULL,
	LINE_TOTAL						decimal(15,2) NULL,
	NOBILL_FLG						tinyint NULL,
	BILL_HOLD_FLG					tinyint NULL,
	AR_INV_NBR						int NULL,
	AR_INV_SEQ						smallint NULL,
	AR_TYPE							varchar(3) COLLATE SQL_Latin1_General_CP1_CS_AS,
	AR_INV_DATE						smalldatetime NULL,
	AB_FLAG							tinyint NULL,
	MODIFY_DELETE					tinyint NULL,
	DELETE_FLAG						tinyint NULL,
	--XFER_FROM_CLIENT				varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	--XFER_FROM_DIVISION				varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	--XFER_FROM_PRODUCT				varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	XFER_FROM_JOB					int NULL,
	--XFER_FROM_JOB_DESC				varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS,
	XFER_FROM_JOB_COMP				smallint NULL,
	XFER_FROM_FNC					varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS,
	XFER_FROM_ID					int NULL,
	XFER_FROM_SEQ					smallint NULL,
	XFER_FROM_LINE_NBR				smallint NULL,
	--XFER_FROM_QTY					decimal(15,2) NULL,
	--XFER_FROM_HOURS					decimal(15,2) NULL,
	--XFER_FROM_BILL_RATE				decimal(15,2) NULL, 
	--XFER_FROM_NET_AMT				decimal(15,2) NULL,
	--XFER_FROM_NONRESALE_TAX			decimal(15,2) NULL,
	--XFER_FROM_MARKUP_AMT			decimal(15,2) NULL, 
	--XFER_FROM_STATE_RESALE			decimal(15,2) NULL, 
	--XFER_FROM_COUNTY_RESALE			decimal(15,2) NULL, 
	--XFER_FROM_CITY_RESALE			decimal(15,2) NULL, 
	--XFER_FROM_LINE_TOTAL			decimal(15,2) NULL,
	--XFER_FROM_NOBILL_FLG			tinyint NULL,
	--XFER_FROM_BILL_HOLD_FLG			tinyint NULL,
	--XFER_FROM_AR_INV_NBR			int NULL,
	--XFER_FROM_AB_FLAG				tinyint NULL,
	--XFER_FROM_MODIFY_DELETE			tinyint NULL,
	--XFER_FROM_DELETE_FLAG			tinyint NULL,
	XFER_ADJ_USER					varchar(100) COLLATE SQL_Latin1_General_CP1_CS_AS,
	XFER_ADJ_DATE					datetime NULL,
	XFER_ADJ_DATE_VALUE				datetime NULL) 

-- ==========================================================
-- SECONDARY TABLES
-- ==========================================================
-- Temp table #ap_header_max_seq
CREATE TABLE #ap_header_max_seq(
	AP_ID				int NOT NULL,
	AP_SEQ				smallint NULL)
INSERT INTO #ap_header_max_seq
SELECT
	AP_ID,
	MAX(AP_SEQ)
FROM dbo.AP_HEADER
GROUP BY AP_ID		

-- ===========================================================================
-- EXTRACTION ROUTINES
-- ===========================================================================
-- ACCOUNTS PAYABLE===========================================================
-- AP transfer from to #transfer_data_temp
IF @ap_include = 1
BEGIN
INSERT INTO #transfer_data_temp ( 
	REC_SOURCE, 
	REC_ID, 
	REC_SEQ, 
	VN_EMP_CODE, 
	VN_EMP_NAME, 
	INV_VCHR, 
	[DATE], 
	WIP_POST_PERIOD, 
	LINE_NUMBER, 
	CL_CODE, 
	DIV_CODE, 
	PRD_CODE, 
	JOB_NUMBER, 
	JOB_DESC, 
	JOB_COMPONENT_NBR, 
	FNC_CODE,
	QTY, 
	BILL_RATE, 
	NET_AMT, 
	NONRESALE_TAX, 
	MARKUP_AMT, 
	STATE_RESALE, 
	COUNTY_RESALE, 
	CITY_RESALE, 
	LINE_TOTAL, 
	NOBILL_FLG, 
	BILL_HOLD_FLG, 
	AR_INV_NBR, 
	AR_INV_SEQ,
	AR_TYPE,
	AR_INV_DATE,
	AB_FLAG, 
	MODIFY_DELETE, 
	DELETE_FLAG, 
	XFER_FROM_JOB, 
	XFER_FROM_JOB_COMP, 
	XFER_FROM_FNC, 
	XFER_FROM_ID, 
	XFER_FROM_SEQ, 
	XFER_FROM_LINE_NBR, 
	XFER_ADJ_USER, 
	XFER_ADJ_DATE, 
	XFER_ADJ_DATE_VALUE )
SELECT 
	'AP' AS REC_SOURCE, 
	d.AP_ID, 
	d.AP_SEQ, 
	h.VN_FRL_EMP_CODE, 
	v.VN_NAME, 
	h.AP_INV_VCHR, 
	h.AP_INV_DATE, 
	d.POST_PERIOD, 
	d.LINE_NUMBER, 
	j.CL_CODE, 
	j.DIV_CODE, 
	j.PRD_CODE, 
	d.JOB_NUMBER, 
	j.JOB_DESC, 
	d.JOB_COMPONENT_NBR, 
	d.FNC_CODE, 
	d.AP_PROD_QUANTITY, 
	d.AP_PROD_RATE, 
	d.AP_PROD_EXT_AMT, 
	d.EXT_NONRESALE_TAX, 
	d.EXT_MARKUP_AMT, 
	d.EXT_STATE_RESALE, 
	d.EXT_COUNTY_RESALE, 
	d.EXT_CITY_RESALE, 
	d.LINE_TOTAL, 
	d.AP_PROD_NOBILL_FLG, 
	d.AP_PROD_BILL_HOLD, 
	d.AR_INV_NBR, 
	d.AR_INV_SEQ,
	d.AR_TYPE,
	ar.AR_INV_DATE,
	d.AB_FLAG, 
	d.MODIFY_DELETE, 
	d.DELETE_FLAG, 
	d.XFER_FROM_JOB, 
	d.XFER_FROM_JOB_COMP, 
	d.XFER_FROM_FNC, 
	d.XFER_FROM_AP_ID, 
	d.XFER_FROM_AP_SEQ, 
	d.XFER_FROM_LINE_NBR, 
	d.XFER_ADJ_USER, 
	d.XFER_ADJ_DATE, 
	ISNULL(CONVERT(datetime, d.XFER_ADJ_DATE, 101),NULL)
FROM dbo.AP_PRODUCTION AS d 
INNER JOIN [#ap_header_max_seq] AS ms 
	ON d.AP_ID = ms.AP_ID
INNER JOIN dbo.AP_HEADER AS h 
	ON ms.AP_SEQ = h.AP_SEQ 
	AND ms.AP_ID = h.AP_ID 
INNER JOIN dbo.JOB_LOG AS j 
	ON d.JOB_NUMBER = j.JOB_NUMBER 
INNER JOIN dbo.VENDOR AS v 
	ON h.VN_FRL_EMP_CODE = v.VN_CODE
LEFT OUTER JOIN dbo.ACCT_REC ar ON d.AR_INV_NBR = ar.AR_INV_NBR AND d.AR_INV_SEQ = ar.AR_INV_SEQ AND d.AR_TYPE = ar.AR_TYPE 
WHERE d.XFER_FROM_JOB IS NOT NULL

-- AP transfer temp data to #transfer_data
INSERT INTO #transfer_data ( 
	REC_SOURCE, 
	REC_ID, 
	REC_SEQ, 
	VN_EMP_CODE, 
	VN_EMP_NAME, 
	INV_VCHR, 
	[DATE], 
	WIP_POST_PERIOD, 
	LINE_NUMBER, 
	CL_CODE, 
	DIV_CODE, 
	PRD_CODE, 
	JOB_NUMBER, 
	JOB_DESC, 
	JOB_COMPONENT_NBR, 
	FNC_CODE, 
	QTY, 
	[HOURS], 
	BILL_RATE, 
	NET_AMT, 
	NONRESALE_TAX, 
	MARKUP_AMT, 
	STATE_RESALE, 
	COUNTY_RESALE, 
	CITY_RESALE, 
	LINE_TOTAL, 
	NOBILL_FLG, 
	BILL_HOLD_FLG, 
	AR_INV_NBR, 
	AR_INV_SEQ,
	AR_TYPE,
	AR_INV_DATE, 
	AB_FLAG, 
	MODIFY_DELETE, 
	DELETE_FLAG, 
	XFER_FROM_CLIENT, 
	XFER_FROM_DIVISION, 
	XFER_FROM_PRODUCT, 
	XFER_FROM_JOB, 
	XFER_FROM_JOB_DESC, 
	XFER_FROM_JOB_COMP, 
	XFER_FROM_JOB_COMP_DESC,
	XFER_FROM_FNC, 
	XFER_FROM_ID, 
	XFER_FROM_SEQ, 
	XFER_FROM_LINE_NBR, 
	XFER_FROM_QTY, 
	XFER_FROM_BILL_RATE, 
	XFER_FROM_NET_AMT, 
	XFER_FROM_NONRESALE_TAX, 
	XFER_FROM_MARKUP_AMT, 
	XFER_FROM_STATE_RESALE, 
	XFER_FROM_COUNTY_RESALE, 
	XFER_FROM_CITY_RESALE, 
	XFER_FROM_LINE_TOTAL, 
	XFER_FROM_NOBILL_FLG, 
	XFER_FROM_BILL_HOLD_FLG, 
	XFER_FROM_AR_INV_NBR, 
	XFER_FROM_AB_FLAG, 
	XFER_FROM_MODIFY_DELETE, 
	XFER_FROM_DELETE_FLAG, 
	XFER_ADJ_USER, 
	XFER_ADJ_DATE, 
	XFER_ADJ_DATE_VALUE )
SELECT 
	t.REC_SOURCE, 
	t.REC_ID, 
	t.REC_SEQ, 
	t.VN_EMP_CODE, 
	t.VN_EMP_NAME, 
	t.INV_VCHR, 
	t.[DATE], 
	t.WIP_POST_PERIOD, 
	t.LINE_NUMBER, 
	t.CL_CODE, 
	t.DIV_CODE, 
	t.PRD_CODE, 
	t.JOB_NUMBER, 
	t.JOB_DESC, 
	t.JOB_COMPONENT_NBR, 
	t.FNC_CODE, 
	t.QTY, 
	t.[HOURS], 
	t.BILL_RATE, 
	t.NET_AMT, 
	t.NONRESALE_TAX, 
	t.MARKUP_AMT, 
	t.STATE_RESALE, 
	t.COUNTY_RESALE, 
	t.CITY_RESALE, 
	t.LINE_TOTAL, 
	t.NOBILL_FLG, 
	t.BILL_HOLD_FLG, 
	t.AR_INV_NBR, 
	t.AR_INV_SEQ,
	t.AR_TYPE,
	t.AR_INV_DATE,
	t.AB_FLAG, 
	t.MODIFY_DELETE, 
	t.DELETE_FLAG, 
	j.CL_CODE, 
	j.DIV_CODE, 
	j.PRD_CODE, 
	t.XFER_FROM_JOB, 
	j.JOB_DESC, 
	t.XFER_FROM_JOB_COMP, 
	jc.JOB_COMP_DESC,
	t.XFER_FROM_FNC, 
	t.XFER_FROM_ID, 
	t.XFER_FROM_SEQ, 
	t.XFER_FROM_LINE_NBR, 
	d.AP_PROD_QUANTITY, 
	d.AP_PROD_RATE, 
	d.AP_PROD_EXT_AMT, 
	d.EXT_NONRESALE_TAX, 
	d.EXT_MARKUP_AMT, 
	d.EXT_STATE_RESALE, 
	d.EXT_COUNTY_RESALE, 
	d.EXT_CITY_RESALE, 
	d.LINE_TOTAL, 
	d.AP_PROD_NOBILL_FLG, 
	d.AP_PROD_BILL_HOLD, 
	d.AR_INV_NBR, 
	d.AB_FLAG, 
	d.MODIFY_DELETE, 
	d.DELETE_FLAG, 
	t.XFER_ADJ_USER, 
	t.XFER_ADJ_DATE, 
	t.XFER_ADJ_DATE_VALUE
FROM #transfer_data_temp AS t 
INNER JOIN dbo.AP_PRODUCTION AS d 
	ON t.XFER_FROM_LINE_NBR = d.LINE_NUMBER 
	AND t.XFER_FROM_SEQ = d.AP_SEQ 
	AND t.XFER_FROM_ID = d.AP_ID 
INNER JOIN dbo.JOB_LOG AS j 
	ON d.JOB_NUMBER = j.JOB_NUMBER
INNER JOIN dbo.JOB_COMPONENT AS jc 
	ON d.JOB_NUMBER = jc.JOB_NUMBER AND d.JOB_COMPONENT_NBR = jc.JOB_COMPONENT_NBR
WHERE t.XFER_ADJ_DATE_VALUE >= @start_date AND t.XFER_ADJ_DATE_VALUE <= @end_date	

DELETE FROM #transfer_data_temp
END

--SELECT * FROM #transfer_data

-- EMPLOYEE TIME===========================================================
-- ET transfer from to #transfer_data_temp
IF @et_include = 1
BEGIN
INSERT INTO #transfer_data_temp ( 
	REC_SOURCE, 
	REC_ID, 
	REC_SEQ, 
	VN_EMP_CODE, 
	VN_EMP_NAME, 
	[DATE], 
	LINE_NUMBER, 
	CL_CODE, 
	DIV_CODE, 
	PRD_CODE, 
	JOB_NUMBER, 
	JOB_DESC, 
	JOB_COMPONENT_NBR, 
	FNC_CODE, 
	[HOURS], 
	BILL_RATE, 
	NET_AMT, 
	MARKUP_AMT, 
	STATE_RESALE, 
	COUNTY_RESALE, 
	CITY_RESALE, 
	LINE_TOTAL, 
	NOBILL_FLG, 
	BILL_HOLD_FLG, 
	AR_INV_NBR, 
	AR_INV_SEQ,
	AR_TYPE,
	AR_INV_DATE, 
	AB_FLAG, 
	MODIFY_DELETE, 
	XFER_FROM_JOB, 
	XFER_FROM_JOB_COMP, 
	XFER_FROM_FNC, 
	XFER_FROM_ID, 
	XFER_FROM_SEQ, 
	XFER_FROM_LINE_NBR, 
	XFER_ADJ_USER, 
	XFER_ADJ_DATE, 
	XFER_ADJ_DATE_VALUE )
SELECT 
	'ET' AS REC_SOURCE, 
	d.ET_ID, 
	d.SEQ_NBR, 
	h.EMP_CODE, 
	e.[EMP_FNAME] + ' ' + e.[EMP_LNAME], 
	h.EMP_DATE, 
	0, 
	j.CL_CODE, 
	j.DIV_CODE, 
	j.PRD_CODE, 
	d.JOB_NUMBER, 
	j.JOB_DESC, 
	d.JOB_COMPONENT_NBR, 
	d.FNC_CODE, 
	d.EMP_HOURS, 
	d.EMP_BILL_RATE, 
	d.TOTAL_BILL, 
	d.EXT_MARKUP_AMT, 
	d.EXT_STATE_RESALE, 
	d.EXT_COUNTY_RESALE, 
	d.EXT_CITY_RESALE, 
	d.LINE_TOTAL, 
	d.EMP_NON_BILL_FLAG, 
	d.BILL_HOLD_FLG, 
	d.AR_INV_NBR, 
	d.AR_INV_SEQ,
	d.AR_TYPE,
	ar.AR_INV_DATE,
	d.AB_FLAG, 
	d.EDIT_FLAG, 
	d.XFER_FROM_JOB, 
	d.XFER_FROM_JOB_COMP, 
	d.XFER_FROM_FNC, 
	d.XFER_FROM_ET_ID, 
	d.XFER_FROM_SEQ_NBR, 		 
	CASE 
		WHEN d.XFER_FROM_JOB IS NOT NULL THEN 0					--IIf(Not IsNull([SYSADM_EMP_TIME_DTL]![XFER_FROM_JOB]),0,Null) AS XFER_FROM_LINE_NBR,
	END,	
	d.XFER_ADJ_USER, 
	d.XFER_ADJ_DATE, 
	ISNULL(CONVERT(datetime, d.XFER_ADJ_DATE, 101),NULL)		--IIf(Not IsNull([XFER_ADJ_DATE]),DateValue([XFER_ADJ_DATE]),Null) AS XFER_ADJ_DATE_VALUE
FROM dbo.EMP_TIME_DTL AS d 
INNER JOIN dbo.EMP_TIME AS h 
	ON d.ET_ID = h.ET_ID 
INNER JOIN dbo.JOB_LOG AS j 
	ON d.JOB_NUMBER = j.JOB_NUMBER 
INNER JOIN dbo.EMPLOYEE AS e 
	ON h.EMP_CODE = e.EMP_CODE
LEFT OUTER JOIN dbo.ACCT_REC ar ON d.AR_INV_NBR = ar.AR_INV_NBR AND d.AR_INV_SEQ = ar.AR_INV_SEQ AND d.AR_TYPE = ar.AR_TYPE
WHERE d.XFER_FROM_JOB IS NOT NULL

-- ET transfer temp data to #transfer_data
INSERT INTO #transfer_data ( 
	REC_SOURCE, 
	REC_ID, 
	REC_SEQ, 
	VN_EMP_CODE, 
	VN_EMP_NAME, 
	INV_VCHR, 
	[Date], 
	WIP_POST_PERIOD, 
	LINE_NUMBER, 
	CL_CODE, 
	DIV_CODE, 
	PRD_CODE, 
	JOB_NUMBER, 
	JOB_DESC, 
	JOB_COMPONENT_NBR, 
	FNC_CODE, 
	QTY, 
	[HOURS], 
	BILL_RATE, 
	NET_AMT, 
	NONRESALE_TAX, 
	MARKUP_AMT, 
	STATE_RESALE, 
	COUNTY_RESALE, 
	CITY_RESALE, 
	LINE_TOTAL, 
	NOBILL_FLG, 
	BILL_HOLD_FLG, 
	AR_INV_NBR, 
	AR_INV_SEQ,
	AR_TYPE,
	AR_INV_DATE,
	AB_FLAG, 
	MODIFY_DELETE, 
	DELETE_FLAG, 
	XFER_FROM_CLIENT, 
	XFER_FROM_DIVISION, 
	XFER_FROM_PRODUCT, 
	XFER_FROM_JOB, 
	XFER_FROM_JOB_DESC, 
	XFER_FROM_JOB_COMP, 
	XFER_FROM_JOB_COMP_DESC,
	XFER_FROM_FNC, 
	XFER_FROM_ID, 
	XFER_FROM_SEQ, 
	XFER_FROM_LINE_NBR, 
	XFER_FROM_HOURS, 
	XFER_FROM_BILL_RATE, 
	XFER_FROM_NET_AMT, 
	XFER_FROM_MARKUP_AMT, 
	XFER_FROM_STATE_RESALE, 
	XFER_FROM_COUNTY_RESALE, 
	XFER_FROM_CITY_RESALE, 
	XFER_FROM_LINE_TOTAL, 
	XFER_FROM_NOBILL_FLG, 
	XFER_FROM_BILL_HOLD_FLG, 
	XFER_FROM_AR_INV_NBR, 
	XFER_FROM_AB_FLAG, 
	XFER_FROM_MODIFY_DELETE, 
	XFER_ADJ_USER, XFER_ADJ_DATE, 
	XFER_ADJ_DATE_VALUE )
SELECT 
	t.REC_SOURCE, 
	t.REC_ID, 
	t.REC_SEQ, 
	t.VN_EMP_CODE, 
	t.VN_EMP_NAME, 
	t.INV_VCHR, 
	t.[Date], 
	t.WIP_POST_PERIOD, 
	t.LINE_NUMBER, 
	t.CL_CODE, 
	t.DIV_CODE, 
	t.PRD_CODE, 
	t.JOB_NUMBER, 
	t.JOB_DESC, 
	t.JOB_COMPONENT_NBR, 
	t.FNC_CODE, 
	t.QTY, 
	t.[HOURS], 
	t.BILL_RATE, 
	t.NET_AMT, 
	t.NONRESALE_TAX, 
	t.MARKUP_AMT, 
	t.STATE_RESALE, 
	t.COUNTY_RESALE, 
	t.CITY_RESALE, 
	t.LINE_TOTAL, 
	t.NOBILL_FLG, 
	t.BILL_HOLD_FLG, 
	t.AR_INV_NBR, 
	t.AR_INV_SEQ,
	t.AR_TYPE,
	t.AR_INV_DATE,
	t.AB_FLAG, 
	t.MODIFY_DELETE, 
	t.DELETE_FLAG, 
	j.CL_CODE, 
	j.DIV_CODE, 
	j.PRD_CODE, 
	t.XFER_FROM_JOB, 
	j.JOB_DESC, 
	t.XFER_FROM_JOB_COMP, 
	jc.JOB_COMP_DESC,
	t.XFER_FROM_FNC, 
	t.XFER_FROM_ID, 
	t.XFER_FROM_SEQ, 
	t.XFER_FROM_LINE_NBR, 
	d.EMP_HOURS, 
	d.EMP_BILL_RATE, 
	d.TOTAL_BILL, 
	d.EXT_MARKUP_AMT, 
	d.EXT_STATE_RESALE, 
	d.EXT_COUNTY_RESALE, 
	d.EXT_CITY_RESALE, 
	d.LINE_TOTAL, 
	d.EMP_NON_BILL_FLAG, 
	d.BILL_HOLD_FLG, 
	d.AR_INV_NBR, 
	d.AB_FLAG, 
	d.EDIT_FLAG, 
	t.XFER_ADJ_USER, 
	t.XFER_ADJ_DATE, 
	t.XFER_ADJ_DATE_VALUE
FROM #transfer_data_temp AS t 
INNER JOIN dbo.EMP_TIME_DTL AS d 
	ON t.XFER_FROM_SEQ = d.SEQ_NBR 
	AND t.XFER_FROM_ID = d.ET_ID 
INNER JOIN dbo.JOB_LOG AS j 
	ON d.JOB_NUMBER = j.JOB_NUMBER
INNER JOIN dbo.JOB_COMPONENT AS jc 
	ON d.JOB_NUMBER = jc.JOB_NUMBER AND d.JOB_COMPONENT_NBR = jc.JOB_COMPONENT_NBR
WHERE t.XFER_ADJ_DATE_VALUE >= @start_date AND t.XFER_ADJ_DATE_VALUE <= @end_date 

DELETE FROM #transfer_data_temp
END

-- INCOME ONLY===========================================================
-- IO transfer from to #transfer_data_temp
IF @io_include = 1
BEGIN
INSERT INTO #transfer_data_temp ( 
	REC_SOURCE, 
	REC_ID, 
	REC_SEQ, 
	VN_EMP_NAME, 
	INV_VCHR, 
	[DATE], 
	LINE_NUMBER, 
	CL_CODE, 
	DIV_CODE, 
	PRD_CODE, 
	JOB_NUMBER, 
	JOB_DESC, 
	JOB_COMPONENT_NBR, 
	FNC_CODE, 
	QTY, 
	BILL_RATE, 
	NET_AMT, 
	MARKUP_AMT, 
	STATE_RESALE, 
	COUNTY_RESALE, 
	CITY_RESALE, 
	LINE_TOTAL, 
	NOBILL_FLG, 
	BILL_HOLD_FLG, 
	AR_INV_NBR, 
	AR_INV_SEQ,
	AR_TYPE,
	AR_INV_DATE,
	AB_FLAG, 
	MODIFY_DELETE, 
	DELETE_FLAG, 
	XFER_FROM_JOB, 
	XFER_FROM_JOB_COMP, 
	XFER_FROM_FNC, 
	XFER_FROM_ID, 
	XFER_FROM_SEQ, 
	XFER_FROM_LINE_NBR, 
	XFER_ADJ_USER, 
	XFER_ADJ_DATE, 
	XFER_ADJ_DATE_VALUE )
SELECT 
	'IO' AS REC_SOURCE, 
	d.IO_ID, 
	d.SEQ_NBR, 
	d.IO_DESC, 
	d.IO_INV_NBR, 
	d.IO_INV_DATE, 
	0, 
	j.CL_CODE, 
	j.DIV_CODE, 
	j.PRD_CODE, 
	d.JOB_NUMBER, 
	j.JOB_DESC, 
	d.JOB_COMPONENT_NBR, 
	d.FNC_CODE, 
	d.IO_QTY, 
	d.IO_RATE, 
	d.IO_AMOUNT, 
	d.EXT_MARKUP_AMT, 
	d.EXT_STATE_RESALE, 
	d.EXT_COUNTY_RESALE, 
	d.EXT_CITY_RESALE, 
	d.LINE_TOTAL, 
	d.NON_BILL_FLAG, 
	d.BILL_HOLD_FLAG, 
	d.AR_INV_NBR, 
	d.AR_INV_SEQ,
	d.AR_TYPE,
	ar.AR_INV_DATE,
	d.AB_FLAG, 
	d.MODIFY_FLAG, 
	d.DELETE_FLAG, 
	d.XFER_FROM_JOB, 
	d.XFER_FROM_JOB_COMP, 
	d.XFER_FROM_FNC, 
	d.XFER_FROM_IO_ID, 
	d.XFER_FROM_SEQ_NBR, 		 
	CASE
		WHEN d.XFER_FROM_JOB IS NOT NULL THEN 0					--IIf(Not IsNull([SYSADM_INCOME_ONLY]![XFER_FROM_JOB]),0,Null) AS XFER_FROM_LINE_NBR,
	END,	
	d.XFER_ADJ_USER, 
	d.XFER_ADJ_DATE, 
	ISNULL(CONVERT(datetime, d.XFER_ADJ_DATE, 101),NULL)		--IIf(Not IsNull([XFER_ADJ_DATE]),DateValue([XFER_ADJ_DATE]),Null) AS XFER_ADJ_DATE_VALUE
FROM dbo.INCOME_ONLY AS d 
INNER JOIN dbo.JOB_LOG AS j 
	ON d.JOB_NUMBER = j.JOB_NUMBER
LEFT OUTER JOIN dbo.ACCT_REC ar ON d.AR_INV_NBR = ar.AR_INV_NBR AND d.AR_INV_SEQ = ar.AR_INV_SEQ AND d.AR_TYPE = ar.AR_TYPE

-- IO transfer temp data to #transfer_data
INSERT INTO #transfer_data ( 
	REC_SOURCE, 
	REC_ID, 
	REC_SEQ, 
	VN_EMP_CODE, 
	VN_EMP_NAME, 
	INV_VCHR, 
	[DATE], 
	WIP_POST_PERIOD, 
	LINE_NUMBER, 
	CL_CODE, 
	DIV_CODE, 
	PRD_CODE, 
	JOB_NUMBER, 
	JOB_DESC, 
	JOB_COMPONENT_NBR, 
	FNC_CODE, 
	QTY, 
	[HOURS], 
	BILL_RATE, 
	NET_AMT, 
	NONRESALE_TAX, 
	MARKUP_AMT, 
	STATE_RESALE, 
	COUNTY_RESALE, 
	CITY_RESALE, 
	LINE_TOTAL, 
	NOBILL_FLG, 
	BILL_HOLD_FLG, 
	AR_INV_NBR, 
	AR_INV_SEQ,
	AR_TYPE,
	AR_INV_DATE,
	AB_FLAG, 
	MODIFY_DELETE, 
	DELETE_FLAG, 
	XFER_FROM_CLIENT, 
	XFER_FROM_DIVISION, 
	XFER_FROM_PRODUCT, 
	XFER_FROM_JOB, 
	XFER_FROM_JOB_DESC, 
	XFER_FROM_JOB_COMP, 
	XFER_FROM_JOB_COMP_DESC,
	XFER_FROM_FNC, 
	XFER_FROM_ID, 
	XFER_FROM_SEQ, 
	XFER_FROM_LINE_NBR, 
	XFER_FROM_QTY, 
	XFER_FROM_BILL_RATE, 
	XFER_FROM_NET_AMT, 
	XFER_FROM_MARKUP_AMT, 
	XFER_FROM_STATE_RESALE, 
	XFER_FROM_COUNTY_RESALE, 
	XFER_FROM_CITY_RESALE, 
	XFER_FROM_LINE_TOTAL, 
	XFER_FROM_NOBILL_FLG, 
	XFER_FROM_BILL_HOLD_FLG, 
	XFER_FROM_AR_INV_NBR, 
	XFER_FROM_AB_FLAG, 
	XFER_FROM_MODIFY_DELETE, 
	XFER_FROM_DELETE_FLAG, 
	XFER_ADJ_USER, 
	XFER_ADJ_DATE, 
	XFER_ADJ_DATE_VALUE )
SELECT 
	t.REC_SOURCE, 
	t.REC_ID, 
	t.REC_SEQ, 
	t.VN_EMP_CODE, 
	t.VN_EMP_NAME, 
	t.INV_VCHR, 
	t.[DATE], 
	t.WIP_POST_PERIOD, 
	t.LINE_NUMBER, 
	t.CL_CODE, 
	t.DIV_CODE, 
	t.PRD_CODE, 
	t.JOB_NUMBER, 
	t.JOB_DESC, 
	t.JOB_COMPONENT_NBR, 
	t.FNC_CODE, 
	t.QTY, 
	t.[HOURS], 
	t.BILL_RATE, 
	t.NET_AMT, 
	t.NONRESALE_TAX, 
	t.MARKUP_AMT, 
	t.STATE_RESALE, 
	t.COUNTY_RESALE, 
	t.CITY_RESALE, 
	t.LINE_TOTAL, 
	t.NOBILL_FLG, 
	t.BILL_HOLD_FLG, 
	t.AR_INV_NBR, 
	t.AR_INV_SEQ,
	t.AR_TYPE,
	t.AR_INV_DATE,
	t.AB_FLAG, 
	t.MODIFY_DELETE, 
	t.DELETE_FLAG, 
	j.CL_CODE, 
	j.DIV_CODE, 
	j.PRD_CODE, 
	t.XFER_FROM_JOB, 
	j.JOB_DESC, 
	t.XFER_FROM_JOB_COMP, 
	jc.JOB_COMP_DESC,
	t.XFER_FROM_FNC, 
	t.XFER_FROM_ID, 
	t.XFER_FROM_SEQ, 
	t.XFER_FROM_LINE_NBR, 
	d.IO_QTY, 
	d.IO_RATE, 
	d.IO_AMOUNT, 
	d.EXT_MARKUP_AMT, 
	d.EXT_STATE_RESALE, 
	d.EXT_COUNTY_RESALE, 
	d.EXT_CITY_RESALE, 
	d.LINE_TOTAL, 
	d.NON_BILL_FLAG, 
	d.BILL_HOLD_FLAG, 
	d.AR_INV_NBR, 
	d.AB_FLAG, 
	d.MODIFY_FLAG, 
	d.DELETE_FLAG, 
	t.XFER_ADJ_USER, 
	t.XFER_ADJ_DATE, 
	t.XFER_ADJ_DATE_VALUE
FROM #transfer_data_temp AS t 
INNER JOIN dbo.INCOME_ONLY AS d 
	ON t.XFER_FROM_SEQ = d.SEQ_NBR 
	AND t.XFER_FROM_ID = d.IO_ID 
INNER JOIN dbo.JOB_LOG AS j 
	ON d.JOB_NUMBER = j.JOB_NUMBER
INNER JOIN dbo.JOB_COMPONENT AS jc 
	ON d.JOB_NUMBER = jc.JOB_NUMBER AND d.JOB_COMPONENT_NBR = jc.JOB_COMPONENT_NBR
WHERE t.XFER_ADJ_DATE_VALUE >= @start_date AND t.XFER_ADJ_DATE_VALUE <= @end_date

DELETE FROM #transfer_data_temp
END

SELECT																--#01
	t.REC_SOURCE AS RecordSource, 
	t.REC_ID AS RecordID, 
	t.REC_SEQ AS RecordSequence, 
	t.VN_EMP_CODE AS VendorEmployeeCode, 
	t.VN_EMP_NAME AS VendorEmployeeName, 
	t.INV_VCHR AS VoucherNumber, 
	t.[DATE] AS VoucherDate, 
	t.WIP_POST_PERIOD AS WIPPostPeriod, 
	t.LINE_NUMBER AS LineNumber, 
	t.CL_CODE AS ClientCode,
	C.CL_NAME AS ClientName, 
	t.DIV_CODE AS DivisionCode, 
	D.DIV_NAME AS DivisionName,
	t.PRD_CODE AS ProductCode, 
	P.PRD_DESCRIPTION AS ProductDescription,
	t.JOB_NUMBER AS JobNumber, 
	t.JOB_DESC AS JobDescription, 
	t.JOB_COMPONENT_NBR AS JobComponentNumber,
	jc.JOB_COMP_DESC AS JobComponentDescription, 
	t.FNC_CODE AS FunctionCode,
	CASE WHEN t.REC_SOURCE = 'ET' THEN t.[HOURS] ELSE t.QTY END AS Quantity, 
	t.BILL_RATE AS BillRate, 
	t.NET_AMT AS NetAmount, 
	ISNULL(t.NONRESALE_TAX,0) AS VendorTaxAmount, 
	t.MARKUP_AMT AS MarkupAmount, 
	t.STATE_RESALE AS StateTaxAmount, 
	t.COUNTY_RESALE AS CountyTaxAmount, 
	t.CITY_RESALE AS CityTaxAmount, 
	t.LINE_TOTAL AS LineTotal, 
	t.NOBILL_FLG AS NonBillableFlag, 
	t.BILL_HOLD_FLG AS BillHoldFlag, 
	t.AR_INV_NBR AS InvoiceNumber, 
	t.AR_INV_SEQ AS InvoiceSequence, 
	t.AR_TYPE AS InvoiceType, 
	t.AR_INV_DATE AS InvoiceDate, 
	t.AB_FLAG AS AdvanceBillingFlag, 
	t.MODIFY_DELETE AS ModifyDeleteFlag, 
	t.DELETE_FLAG AS DeleteFlag, 
	t.XFER_FROM_CLIENT AS TransferFromClient,
	TC.CL_NAME AS TransferFromClientName,
	t.XFER_FROM_DIVISION AS TransferFromDivision,
	TD.DIV_NAME AS TransferFromDivisionName,
	t.XFER_FROM_PRODUCT AS TransferFromProduct,
	TP.PRD_DESCRIPTION AS TransferFromProductDescription,
	t.XFER_FROM_JOB AS TransferFromJobNumber, 
	t.XFER_FROM_JOB_DESC AS TransferFromJobDescription,
	t.XFER_FROM_JOB_COMP AS TransferFromJobComponentNumber, 
	t.XFER_FROM_JOB_COMP_DESC AS TransferFromJobComponentDescription,
	t.XFER_FROM_FNC AS TransferFromFunctionCode, 
	t.XFER_FROM_QTY AS TransferFromQuantity,
	t.XFER_FROM_ID AS TransferFromRecordID, 
	t.XFER_FROM_SEQ AS TransferFromRecordSequence, 
	t.XFER_FROM_LINE_NBR AS TransferFromLineNumber, 
	t.XFER_ADJ_USER AS TransferAdjustedUserID, 
	t.XFER_ADJ_DATE AS TransferAdjustedDate
FROM #transfer_data AS t
INNER JOIN PRODUCT P ON P.PRD_CODE = t.PRD_CODE AND P.DIV_CODE = t.DIV_CODE AND P.CL_CODE = t.CL_CODE INNER JOIN
		   DIVISION D ON D.DIV_CODE = P.DIV_CODE AND D.CL_CODE = P.CL_CODE INNER JOIN
		   CLIENT C ON C.CL_CODE = D.CL_CODE
INNER JOIN PRODUCT TP ON TP.PRD_CODE = t.XFER_FROM_PRODUCT AND TP.DIV_CODE = t.XFER_FROM_DIVISION AND TP.CL_CODE = t.XFER_FROM_CLIENT INNER JOIN
		   DIVISION TD ON TD.DIV_CODE = TP.DIV_CODE AND TD.CL_CODE = TP.CL_CODE INNER JOIN
		   CLIENT TC ON TC.CL_CODE = TD.CL_CODE
INNER JOIN JOB_COMPONENT AS jc
	ON t.JOB_NUMBER = jc.JOB_NUMBER
	AND t.JOB_COMPONENT_NBR = jc.JOB_COMPONENT_NBR	
END

GO

