







CREATE PROCEDURE [dbo].[proc_WV_PO_Budget_Comparisons]
@PODate DateTime,
@GlaCode as Varchar(30)
AS
Declare @ppYear varchar(5),
		@ppMonth int,
		@EarliestDate Datetime,
		@GLBudgetCode varchar(20)

-- ************* Create Temp Table ***********************
CREATE TABLE #period(
	GLAccount		VarChar(30), 	
	Budget		    Decimal(15,2),
	POUsed		    Decimal(15,2),
	Balance         Decimal(15,2)	
	) 


SELECT @ppMonth = PPGLMONTH, @ppYear = PPGLYEAR 
FROM POSTPERIOD
WHERE @PODate >= PPSRTDATE AND @PODate <= PPENDDATE

SET @EarliestDate = (SELECT PPSRTDATE 
					FROM POSTPERIOD 
					WHERE PPGLYEAR = @ppYear AND PPGLMONTH = 1)

SET @GLBudgetCode = (SELECT CASE WHEN GLBDGTAPPR4 IS NOT NULL THEN GLBDGTAPPR4
								 WHEN GLBDGTAPPR3 IS NOT NULL THEN GLBDGTAPPR3
								 WHEN GLBDGTAPPR2 IS NOT NULL THEN GLBDGTAPPR2
								 WHEN GLBDGTAPPR1 IS NOT NULL THEN GLBDGTAPPR1 ELSE '' END
					 FROM GLBUDGETAPPRV
					 WHERE GLBDGTAPPR_FY = @ppYear)

if @ppMonth = 12
	Begin
		INSERT INTO #period 
		SELECT GLBDTGLCODE, (GLBDTPPAMT1 + GLBDTPPAMT2 + GLBDTPPAMT3 + GLBDTPPAMT4 + GLBDTPPAMT5 + 
			   GLBDTPPAMT6 + GLBDTPPAMT7 + GLBDTPPAMT8 + GLBDTPPAMT9 + GLBDTPPAMT10 + 
               GLBDTPPAMT11 + GLBDTPPAMT12), 0.0, 0.0
		FROM GLBUDGETTRL
		WHERE GLBDTCODE = @GLBudgetCode AND GLBDTGLCODE = @GlaCode
	End

if @ppMonth = 11
	Begin
		INSERT INTO #period 
		SELECT GLBDTGLCODE, (GLBDTPPAMT1 + GLBDTPPAMT2 + GLBDTPPAMT3 + GLBDTPPAMT4 + GLBDTPPAMT5 + 
			   GLBDTPPAMT6 + GLBDTPPAMT7 + GLBDTPPAMT8 + GLBDTPPAMT9 + GLBDTPPAMT10 + 
               GLBDTPPAMT11), 0.0, 0.0
		FROM GLBUDGETTRL
		WHERE GLBDTCODE = @GLBudgetCode AND GLBDTGLCODE = @GlaCode
	End

if @ppMonth = 10
	Begin
		INSERT INTO #period 
		SELECT GLBDTGLCODE, (GLBDTPPAMT1 + GLBDTPPAMT2 + GLBDTPPAMT3 + GLBDTPPAMT4 + GLBDTPPAMT5 + 
			   GLBDTPPAMT6 + GLBDTPPAMT7 + GLBDTPPAMT8 + GLBDTPPAMT9 + GLBDTPPAMT10), 0.0, 0.0
		FROM GLBUDGETTRL
		WHERE GLBDTCODE = @GLBudgetCode AND GLBDTGLCODE = @GlaCode
	End

if @ppMonth = 9
	Begin
		INSERT INTO #period 
		SELECT GLBDTGLCODE, (GLBDTPPAMT1 + GLBDTPPAMT2 + GLBDTPPAMT3 + GLBDTPPAMT4 + GLBDTPPAMT5 + 
			   GLBDTPPAMT6 + GLBDTPPAMT7 + GLBDTPPAMT8 + GLBDTPPAMT9), 0.0, 0.0
		FROM GLBUDGETTRL
		WHERE GLBDTCODE = @GLBudgetCode AND GLBDTGLCODE = @GlaCode
	End

if @ppMonth = 8
	Begin
		INSERT INTO #period 
		SELECT GLBDTGLCODE, (GLBDTPPAMT1 + GLBDTPPAMT2 + GLBDTPPAMT3 + GLBDTPPAMT4 + GLBDTPPAMT5 + 
			   GLBDTPPAMT6 + GLBDTPPAMT7 + GLBDTPPAMT8), 0.0, 0.0
		FROM GLBUDGETTRL
		WHERE GLBDTCODE = @GLBudgetCode AND GLBDTGLCODE = @GlaCode
	End

if @ppMonth = 7
	Begin
		INSERT INTO #period 
		SELECT GLBDTGLCODE, (GLBDTPPAMT1 + GLBDTPPAMT2 + GLBDTPPAMT3 + GLBDTPPAMT4 + GLBDTPPAMT5 + 
			   GLBDTPPAMT6 + GLBDTPPAMT7), 0.0, 0.0
		FROM GLBUDGETTRL
		WHERE GLBDTCODE = @GLBudgetCode AND GLBDTGLCODE = @GlaCode
	End

if @ppMonth = 6
	Begin
		INSERT INTO #period 
		SELECT GLBDTGLCODE, (GLBDTPPAMT1 + GLBDTPPAMT2 + GLBDTPPAMT3 + GLBDTPPAMT4 + GLBDTPPAMT5 + 
			   GLBDTPPAMT6), 0.0, 0.0
		FROM GLBUDGETTRL
		WHERE GLBDTCODE = @GLBudgetCode AND GLBDTGLCODE = @GlaCode
	End

if @ppMonth = 5
	Begin
		INSERT INTO #period 
		SELECT GLBDTGLCODE, (GLBDTPPAMT1 + GLBDTPPAMT2 + GLBDTPPAMT3 + GLBDTPPAMT4 + GLBDTPPAMT5), 0.0, 0.0
		FROM GLBUDGETTRL
		WHERE GLBDTCODE = @GLBudgetCode AND GLBDTGLCODE = @GlaCode
	End

if @ppMonth = 4
	Begin
		INSERT INTO #period 
		SELECT GLBDTGLCODE, (GLBDTPPAMT1 + GLBDTPPAMT2 + GLBDTPPAMT3 + GLBDTPPAMT4), 0.0, 0.0
		FROM GLBUDGETTRL
		WHERE GLBDTCODE = @GLBudgetCode AND GLBDTGLCODE = @GlaCode
	End

if @ppMonth = 3
	Begin
		INSERT INTO #period 
		SELECT GLBDTGLCODE, (GLBDTPPAMT1 + GLBDTPPAMT2 + GLBDTPPAMT3), 0.0, 0.0
		FROM GLBUDGETTRL
		WHERE GLBDTCODE = @GLBudgetCode AND GLBDTGLCODE = @GlaCode
	End

if @ppMonth = 2
	Begin
		INSERT INTO #period 
		SELECT GLBDTGLCODE, (GLBDTPPAMT1 + GLBDTPPAMT2), 0.0, 0.0
		FROM GLBUDGETTRL
		WHERE GLBDTCODE = @GLBudgetCode AND GLBDTGLCODE = @GlaCode
	End

if @ppMonth = 1
	Begin
		INSERT INTO #period 
		SELECT GLBDTGLCODE, GLBDTPPAMT1, 0.0, 0.0
		FROM GLBUDGETTRL
		WHERE GLBDTCODE = @GLBudgetCode AND GLBDTGLCODE = @GlaCode
	End

UPDATE #period
SET POUsed = 
(SELECT     SUM(PURCHASE_ORDER_DET.PO_EXT_AMOUNT)
 FROM       PURCHASE_ORDER INNER JOIN
                      PURCHASE_ORDER_DET ON PURCHASE_ORDER.PO_NUMBER = PURCHASE_ORDER_DET.PO_NUMBER
 WHERE     (PURCHASE_ORDER_DET.GLACODE = @GlaCode) AND (PURCHASE_ORDER.VOID_FLAG IS NULL) AND 
          (PURCHASE_ORDER.PO_DATE >= @EarliestDate) AND (PURCHASE_ORDER.PO_DATE <= @PODate))


UPDATE #period
SET Balance = (SELECT (Budget - POUsed) FROM #period)




SELECT * FROM #period

drop table #period













