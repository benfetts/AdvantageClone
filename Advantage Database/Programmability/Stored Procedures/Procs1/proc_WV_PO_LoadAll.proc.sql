CREATE PROCEDURE [dbo].[proc_WV_PO_LoadAll](@filter INTEGER, @str1 VARCHAR(15), @str2 VARCHAR(15), @str3 smalldatetime, @str4 smalldatetime, @str5 VARCHAR(15),
  @str6 VARCHAR(25), @str7 VARCHAR(15), @str8 VARCHAR(15), @str9 VARCHAR(15), @str10 VARCHAR(15),
  @str11 smalldatetime,
  @str12 VARCHAR(10),
  @sort VARCHAR(50), @currentpage INTEGER, @maxrows INTEGER, @str13 AS VARCHAR(15), @printed AS SMALLINT, @str14 AS VARCHAR(15), @voided AS SMALLINT, @closed AS SMALLINT, @UserID VARCHAR(100)
  --@totalrows INTEGER OUTPUT
  ) AS
BEGIN

/*
declare @out INTEGER
exec proc_WV_PO_LoadAll 1, '', '', '', '', '', 'hamil', '','','','','', 1, 1, 10, @out OUTPUT
print @out
*/

	CREATE TABLE #t1
	   (REF_ID int IDENTITY PRIMARY KEY,
		PO_NUMBER INTEGER,
		PO_PAD CHAR(15),
		DISPLAY_PO_NUMBER VARCHAR(12),
		PO_CREATE_DATE smalldatetime,
		ISSUED_BY  VARCHAR(100),
		VN_CODE  VARCHAR(15),
		EMP_CODE VARCHAR(15),
		PO_DATE smalldatetime,
		PO_DUE_DATE smalldatetime,
		PO_DESCRIPTION VARCHAR(40),
		PO_COMPLETE bit,
		VOID_FLAG INTEGER,
		VOID_INFO VARCHAR(255),
		PO_REVISION INTEGER,
		PO_WORK_COMPLETE bit,
		VN_NAME VARCHAR(255),
		ISSUED_BY_EMP VARCHAR(255),
		SEARCH_CODE VARCHAR(25),
		PO_APPROVAL_FLAG SMALLINT
		)

	CREATE TABLE #PO_LIST
		(REF_ID int IDENTITY PRIMARY KEY,
		 PO_NUMBER INTEGER,
		 SEARCH_CODE VARCHAR(25))
	 
	IF @filter = 1
	BEGIN


		IF @str1 <> '' -- PO Number
		BEGIN

			INSERT INTO #PO_LIST(PO_NUMBER, SEARCH_CODE)
			SELECT  
				[PO_NUMBER] = PURCHASE_ORDER.PO_NUMBER,
				[SEARCH_CODE] = 'PO Number'
			FROM 
				dbo.PURCHASE_ORDER
			WHERE 
				PURCHASE_ORDER.PO_NUMBER = CAST(@str1 AS INTEGER) AND 
				PURCHASE_ORDER.PO_NUMBER NOT IN (SELECT PO_NUMBER FROM #PO_LIST)
			
		END
	
		IF @str2 <> ''  -- PO Description
		BEGIN
	
		INSERT INTO #PO_LIST(PO_NUMBER, SEARCH_CODE)
		SELECT  
			[PO_NUMBER] = PURCHASE_ORDER.PO_NUMBER,
			[SEARCH_CODE] = 'PO Number'
		FROM 
			dbo.PURCHASE_ORDER
		WHERE 
			UPPER(PURCHASE_ORDER.PO_DESCRIPTION) LIKE '%' + UPPER(@str2) + '%' AND 
			PURCHASE_ORDER.PO_NUMBER NOT IN (SELECT PO_NUMBER FROM #PO_LIST)
		
		END
	
		IF @str3 <> ''  -- PO Issue Date
		BEGIN
	
			INSERT INTO #PO_LIST(PO_NUMBER, SEARCH_CODE)
			SELECT  
				[PO_NUMBER] = PURCHASE_ORDER.PO_NUMBER,
				[SEARCH_CODE] = 'Issue Date'
			FROM 
				dbo.PURCHASE_ORDER
			WHERE 
				PURCHASE_ORDER.PO_DATE BETWEEN CAST(@str3 AS DATETIME) AND (CASE WHEN @str11 = '' THEN DATEADD(HOUR, 23.9, CAST(@str3 AS DATETIME)) ELSE DATEADD(HOUR, 23.9, CAST(@str11 AS DATETIME)) END) AND 
				PURCHASE_ORDER.PO_NUMBER NOT IN (SELECT PO_NUMBER FROM #PO_LIST)
		
		END
	
		IF @str4 <> ''  -- PO Due Date
		BEGIN
	
			INSERT INTO #PO_LIST(PO_NUMBER, SEARCH_CODE)
			SELECT  
				[PO_NUMBER] = PURCHASE_ORDER.PO_NUMBER,
				[SEARCH_CODE] = 'Due Date'
			FROM 
				dbo.PURCHASE_ORDER
			WHERE 
				PURCHASE_ORDER.PO_DUE_DATE = CAST(@str4 AS DATETIME)  AND 
				PURCHASE_ORDER.PO_NUMBER NOT IN (SELECT PO_NUMBER FROM #PO_LIST)
		
		END
	
		IF @str5 <> ''  -- Employee Code
		BEGIN
	
			INSERT INTO #PO_LIST(PO_NUMBER, SEARCH_CODE)
			SELECT  
				[PO_NUMBER] = PURCHASE_ORDER.PO_NUMBER,
				[SEARCH_CODE] = 'Emp. Code'
			FROM 
				dbo.PURCHASE_ORDER
			WHERE 
				PURCHASE_ORDER.EMP_CODE = @str5 AND 
				PURCHASE_ORDER.PO_NUMBER NOT IN (SELECT PO_NUMBER FROM #PO_LIST)
		
		END
	
		IF @str6 <> ''  -- Vendor Code
		BEGIN
	
			INSERT INTO #PO_LIST(PO_NUMBER, SEARCH_CODE)
			SELECT  
				[PO_NUMBER] = PURCHASE_ORDER.PO_NUMBER,
				[SEARCH_CODE] = 'Vendor Code'
			FROM 
				dbo.PURCHASE_ORDER
			WHERE 
				PURCHASE_ORDER.VN_CODE = @str6 AND 
				PURCHASE_ORDER.PO_NUMBER NOT IN (SELECT PO_NUMBER FROM #PO_LIST)
		
		END
	
		IF @str7 <> ''  -- Client Code (Job)
		BEGIN
	
			INSERT INTO #PO_LIST(PO_NUMBER, SEARCH_CODE)
			SELECT DISTINCT
				[PO_NUMBER] = PURCHASE_ORDER.PO_NUMBER,
				[SEARCH_CODE] = 'Client (Job)'
			FROM 
				dbo.PURCHASE_ORDER JOIN
				dbo.PURCHASE_ORDER_DET ON PURCHASE_ORDER.PO_NUMBER = PURCHASE_ORDER_DET.PO_NUMBER JOIN
				dbo.JOB_LOG ON PURCHASE_ORDER_DET.JOB_NUMBER = JOB_LOG.JOB_NUMBER
			WHERE 
				JOB_LOG.CL_CODE = @str7 AND
				PURCHASE_ORDER.PO_NUMBER NOT IN (SELECT PO_NUMBER FROM #PO_LIST)
		
		END
	
		IF @str8 <> ''  -- Div. Code (Job)
		BEGIN
	
			INSERT INTO #PO_LIST(PO_NUMBER, SEARCH_CODE)
			SELECT DISTINCT
				[PO_NUMBER] = PURCHASE_ORDER.PO_NUMBER,
				[SEARCH_CODE] = 'Division (Job)'
			FROM 
				dbo.PURCHASE_ORDER JOIN
				dbo.PURCHASE_ORDER_DET ON PURCHASE_ORDER.PO_NUMBER = PURCHASE_ORDER_DET.PO_NUMBER JOIN
				dbo.JOB_LOG ON PURCHASE_ORDER_DET.JOB_NUMBER = JOB_LOG.JOB_NUMBER
			WHERE 
				JOB_LOG.DIV_CODE = @str8 AND
				PURCHASE_ORDER.PO_NUMBER NOT IN (SELECT PO_NUMBER FROM #PO_LIST)
		
		END
	
		IF @str9 <> ''  -- Product Code (Job)
		BEGIN
	
			INSERT INTO #PO_LIST(PO_NUMBER, SEARCH_CODE)
		SELECT DISTINCT
			[PO_NUMBER] = PURCHASE_ORDER.PO_NUMBER,
			[SEARCH_CODE] = 'Product (Job)'
		FROM 
			dbo.PURCHASE_ORDER JOIN
			dbo.PURCHASE_ORDER_DET ON PURCHASE_ORDER.PO_NUMBER = PURCHASE_ORDER_DET.PO_NUMBER JOIN
			dbo.JOB_LOG ON PURCHASE_ORDER_DET.JOB_NUMBER = JOB_LOG.JOB_NUMBER
		WHERE 
			JOB_LOG.PRD_CODE = @str9 AND
			PURCHASE_ORDER.PO_NUMBER NOT IN (SELECT PO_NUMBER FROM #PO_LIST)
		
		END
	
		IF @str10 <> ''  AND ISNUMERIC(@str12) = 0  -- Job Number.. no component specified...
		BEGIN
	
			INSERT INTO #PO_LIST(PO_NUMBER, SEARCH_CODE)
			SELECT DISTINCT
				[PO_NUMBER] = PURCHASE_ORDER.PO_NUMBER,
				[SEARCH_CODE] = 'Job'
			FROM 
				dbo.PURCHASE_ORDER JOIN
				dbo.PURCHASE_ORDER_DET ON PURCHASE_ORDER.PO_NUMBER = PURCHASE_ORDER_DET.PO_NUMBER
			WHERE 
				PURCHASE_ORDER_DET.JOB_NUMBER = CAST(@str10 AS INTEGER) AND
				PURCHASE_ORDER.PO_NUMBER NOT IN (SELECT PO_NUMBER FROM #PO_LIST)
		
		END
	
		IF @str10 <> ''  AND ISNUMERIC(@str12) = 1  -- Job Number.. Component specified...
		BEGIN
	
			INSERT INTO #PO_LIST(PO_NUMBER, SEARCH_CODE)
			SELECT DISTINCT
				[PO_NUMBER] = PURCHASE_ORDER.PO_NUMBER,
				[SEARCH_CODE] = 'Job'
			FROM 
				dbo.PURCHASE_ORDER JOIN
				dbo.PURCHASE_ORDER_DET ON PURCHASE_ORDER.PO_NUMBER = PURCHASE_ORDER_DET.PO_NUMBER
			WHERE 
				PURCHASE_ORDER_DET.JOB_NUMBER = CAST(@str10 AS INTEGER) AND
				PURCHASE_ORDER_DET.JOB_COMPONENT_NBR = CAST(@str12 AS INTEGER) AND
				PURCHASE_ORDER.PO_NUMBER NOT IN (SELECT PO_NUMBER FROM #PO_LIST)
		
		END
	
		IF @str13 <> '0'  -- PO Request Status
		BEGIN
	
			INSERT INTO #PO_LIST(PO_NUMBER, SEARCH_CODE)
			SELECT DISTINCT
				[PO_NUMBER] = PURCHASE_ORDER.PO_NUMBER,
				[SEARCH_CODE] = 'PO Status'
			FROM 
				dbo.PURCHASE_ORDER
			WHERE 
				PURCHASE_ORDER.PO_APPROVAL_FLAG = CAST(@str13 AS INTEGER) AND
				PURCHASE_ORDER.PO_NUMBER NOT IN (SELECT PO_NUMBER FROM #PO_LIST)
		
		END
	
		IF @printed = 1  -- PO Printed 
		BEGIN
	
			INSERT INTO #PO_LIST(PO_NUMBER, SEARCH_CODE)
			SELECT DISTINCT
				[PO_NUMBER] = PURCHASE_ORDER.PO_NUMBER,
				[SEARCH_CODE] = 'PO Print'
			FROM 
				dbo.PURCHASE_ORDER
			WHERE 
				PURCHASE_ORDER.PO_PRINTED = @printed AND
				PURCHASE_ORDER.PO_NUMBER NOT IN (SELECT PO_NUMBER FROM #PO_LIST)
		
		END

		IF @str14 <> ''  -- PO Approver
		BEGIN
	
			INSERT INTO #PO_LIST(PO_NUMBER, SEARCH_CODE)
			SELECT DISTINCT
				[PO_NUMBER] = PURCHASE_ORDER.PO_NUMBER,
				[SEARCH_CODE] = 'Emp. Code'
			FROM 
				dbo.PURCHASE_ORDER INNER JOIN
				dbo.PO_APPROVAL ON PURCHASE_ORDER.PO_NUMBER = PO_APPROVAL.PO_NUMBER INNER JOIN
				dbo.PO_APPR_RULE_EMP ON PO_APPROVAL.PO_APPR_RULE_ID = PO_APPR_RULE_EMP.PO_APPR_RULE_ID
			WHERE 
				PO_APPR_RULE_EMP.EMP_CODE = @str14 AND
				PURCHASE_ORDER.PO_NUMBER NOT IN (SELECT PO_NUMBER FROM #PO_LIST)
		
		END

		SELECT COUNT(PO_NUMBER) FROM #t1 AS TOTAL_ROWS

		SELECT 
			[REF_ID] = POL.REF_ID,
			[PO_NUMBER] = PURCHASE_ORDER.PO_NUMBER,
			[PO_PAD] = RIGHT('00000000' + CONVERT(VARCHAR(8), PURCHASE_ORDER.PO_NUMBER),8), 
			[DISPLAY_PO_NUMBER] = V_PURCHASE_ORDER.DISPLAY_PO_NUMBER,
			[PO_CREATE_DATE] = PURCHASE_ORDER.PO_CREATE_DATE,
			[ISSUED_BY] = dbo.udf_get_empl_name(PURCHASE_ORDER.[EMP_CODE], 'FML'), 
			[VN_CODE] = PURCHASE_ORDER.VN_CODE, 
			[EMP_CODE] = PURCHASE_ORDER.EMP_CODE,
			[PO_DATE] = PURCHASE_ORDER.PO_DATE,
			[PO_DUE_DATE] = CASE WHEN PURCHASE_ORDER.PO_DUE_DATE IS NOT NULL THEN PURCHASE_ORDER.PO_DUE_DATE ELSE NULL END,
			[PO_DESCRIPTION] = PURCHASE_ORDER.PO_DESCRIPTION, 
			[PO_COMPLETE] = ISNULL(PURCHASE_ORDER.PO_COMPLETE, 0),
			[VOID_FLAG] = ISNULL(PURCHASE_ORDER.VOID_FLAG, 0), 
			[VOID_INFO] = CASE WHEN PURCHASE_ORDER.VOID_FLAG = 1 THEN 'Voided ' + CONVERT(CHAR(10), PURCHASE_ORDER.VOID_DATE,101) + ' by ' + LTRIM(PURCHASE_ORDER.VOIDED_BY) ELSE '' END,
			[PO_REVISION] = ISNULL(PURCHASE_ORDER.PO_REVISION,0),
			[PO_WORK_COMPLETE] = ISNULL(PO_WORK_COMPLETE,0),
			[VN_NAME] = V_PURCHASE_ORDER.VN_NAME,
			[ISSUED_BY_EMP] = EMPLOYEE.EMP_LNAME + ', ' + EMPLOYEE.EMP_FNAME, 
			[SEARCH_CODE] = POL.SEARCH_CODE, 
			[PO_APPROVAL_FLAG] = ISNULL(PURCHASE_ORDER.PO_APPROVAL_FLAG,'0')
		FROM 
			#PO_LIST AS POL INNER JOIN
			dbo.PURCHASE_ORDER ON POL.PO_NUMBER = PURCHASE_ORDER.PO_NUMBER INNER JOIN
			dbo.V_PURCHASE_ORDER ON PURCHASE_ORDER.PO_NUMBER = V_PURCHASE_ORDER.PO_NUMBER LEFT OUTER JOIN
			dbo.EMPLOYEE ON PURCHASE_ORDER.EMP_CODE = EMPLOYEE.EMP_CODE
		WHERE
			1 = CASE WHEN @voided = 1 AND @closed = 1 THEN CASE WHEN ISNULL(PURCHASE_ORDER.VOID_FLAG, 0) = 0 AND ISNULL(PURCHASE_ORDER.PO_COMPLETE, 0) = 0 THEN 1 ELSE 0 END 
					 WHEN @voided = 1 THEN CASE WHEN ISNULL(PURCHASE_ORDER.VOID_FLAG, 0) = 0 THEN 1 ELSE 0 END
					 WHEN @closed = 1 THEN CASE WHEN ISNULL(PURCHASE_ORDER.VOID_FLAG, 0) = 0 AND ISNULL(PURCHASE_ORDER.PO_COMPLETE, 0) = 0 THEN 1 ELSE 0 END 
					 ELSE 1 END
		ORDER BY
			SEARCH_CODE,
			PO_NUMBER DESC

	END
	ELSE 
	IF @filter = 2
	BEGIN

		INSERT INTO #t1(PO_NUMBER, PO_PAD, DISPLAY_PO_NUMBER, PO_CREATE_DATE, ISSUED_BY, EMP_CODE, PO_DATE, PO_DUE_DATE,
						PO_DESCRIPTION, VN_CODE, PO_COMPLETE, VOID_FLAG, VOID_INFO, PO_REVISION, PO_WORK_COMPLETE, VN_NAME,
						ISSUED_BY_EMP, SEARCH_CODE, PO_APPROVAL_FLAG)
		EXEC proc_WV_PO_Search_LoadAll 1, @str1,@str2,@str3,@str4,@str5,@str6,@str7,@str8,@str9,@str10,@str11,@str12,'default',@str13,@printed,@str14,@voided,@closed,@UserID

		SELECT count(PO_NUMBER) FROM #t1 AS TOTAL_ROWS
		
		SELECT 
			[REF_ID] = t.REF_ID,
			[PO_NUMBER] = t.PO_NUMBER,
			[PO_PAD] = t.PO_PAD,
			[DISPLAY_PO_NUMBER] = t.DISPLAY_PO_NUMBER,
			[PO_CREATE_DATE] = t.PO_CREATE_DATE,
			[ISSUED_BY] = t.ISSUED_BY,
			[VN_CODE] = t.VN_CODE,
			[EMP_CODE] = t.EMP_CODE,
			[PO_DATE] = t.PO_DATE,
			[PO_DUE_DATE] = t.PO_DUE_DATE,
			[PO_DESCRIPTION] = t.PO_DESCRIPTION,
			[PO_COMPLETE] = t.PO_COMPLETE,
			[VOID_FLAG] = t.VOID_FLAG ,
			[VOID_INFO] = t.VOID_INFO,
			[PO_REVISION] = ISNULL(t.PO_REVISION,0),
			[PO_WORK_COMPLETE] = t.PO_WORK_COMPLETE ,
			[VN_NAME] = t.VN_NAME ,
			[ISSUED_BY_EMP] = t.ISSUED_BY_EMP ,
			[SEARCH_CODE] = t.SEARCH_CODE,
			[PO_APPROVAL_FLAG] = t.PO_APPROVAL_FLAG 
		FROM 
			#t1 t
  
	END
	
	DROP TABLE #PO_LIST

	DROP TABLE #t1

END

 