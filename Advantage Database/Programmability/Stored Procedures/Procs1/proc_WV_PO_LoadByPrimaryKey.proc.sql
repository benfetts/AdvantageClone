CREATE PROCEDURE [dbo].[proc_WV_PO_LoadByPrimaryKey](@ref_id integer, @option as varchar(25)) AS
-- retrieve Purchase Order Header

--exec proc_WV_PO_LoadByPrimaryKey 26, null

SELECT	[PO_CREATE_DATE] = PURCHASE_ORDER.PO_DATE,
		[ISSUED_BY] = PURCHASE_ORDER.[USER_ID], 
		[VN_CODE] = PURCHASE_ORDER.VN_CODE, 
		[EMP_CODE] = PURCHASE_ORDER.EMP_CODE,
		[PO_DATE] = PURCHASE_ORDER.PO_DATE,
		[PO_DUE_DATE] = CASE WHEN PURCHASE_ORDER.PO_DUE_DATE IS NOT NULL THEN PURCHASE_ORDER.PO_DUE_DATE ELSE NULL END,
		[PO_DESCRIPTION] = PURCHASE_ORDER.PO_DESCRIPTION, 
		[PO_COMPLETE] = ISNULL(PURCHASE_ORDER.PO_COMPLETE, 0),
		[VOID_INFO] = CASE WHEN PURCHASE_ORDER.VOID_FLAG = 1 THEN '**Voided** ' + CONVERT(CHAR(10),PURCHASE_ORDER.VOID_DATE,101) + ' by ' + LTRIM(PURCHASE_ORDER.VOIDED_BY) ELSE '' END,
		[PO_REVISION] = ISNULL(PURCHASE_ORDER.PO_REVISION,0),
		[PO_WORK_COMPLETE] = ISNULL(PURCHASE_ORDER.PO_WORK_COMPLETE,0),
		[VN_NAME] = VENDOR.VN_NAME,
		[VN_ADDRESS1] = ISNULL(VENDOR.VN_ADDRESS1,''),
		[VN_ADDRESS2] = ISNULL(VENDOR.VN_ADDRESS2,''),
		[VN_ADDRESS3] = ISNULL(VENDOR.VN_ADDRESS3,''),
		[VN_CITYSTATEZIP] = ISNULL(VENDOR.VN_CITY,'') + ', ' + ISNULL(VENDOR.VN_STATE,'') + ' ' + ISNULL(VENDOR.VN_ZIP,''),
		[ISSUED_BY_EMP] = EMPLOYEE.EMP_LNAME + ', ' + EMPLOYEE.EMP_FNAME + ' ' + ISNULL(EMPLOYEE.EMP_MI,''),
		[VN_CONT_CODE] = ISNULL(PURCHASE_ORDER.VN_CONT_CODE,''),
		[VN_CONTACT_NAME] =  ISNULL(VEN_CONT.VC_LNAME,'') + CASE WHEN VEN_CONT.VC_LNAME IS NOT NULL THEN ', ' ELSE '' END + ISNULL(VEN_CONT.VC_FNAME,'') + ' ' +  ISNULL(VEN_CONT.VC_MI,''),
		[VN_EMAIL] = ISNULL(VEN_CONT.EMAIL_ADDRESS,''),
		[PO_TOTAL] = ISNULL((SELECT SUM(PO_EXT_AMOUNT) FROM PURCHASE_ORDER_DET WHERE PO_NUMBER=@ref_id),0),
		[PO_FOOTER] = PURCHASE_ORDER.PO_FOOTER, 
		[PO_MAIN_INSTRUCT] = PURCHASE_ORDER.PO_MAIN_INSTRUCT, 
		[VOID_FLAG] = ISNULL(PURCHASE_ORDER.VOID_FLAG,0),
		[PO_PAD] = RIGHT('00000000' + CONVERT(VARCHAR(8), PURCHASE_ORDER.PO_NUMBER),8), 
		[PO_APPROVAL_FLAG] = ISNULL(PURCHASE_ORDER.PO_APPROVAL_FLAG, 0),
		[PO_APPR_RULE_CODE] = ISNULL(PURCHASE_ORDER.PO_APPR_RULE_CODE, ''), 
		[EXCEED] = ISNULL(PURCHASE_ORDER.EXCEED,0), 
		[PO_PRINTED] = ISNULL(PURCHASE_ORDER.PO_PRINTED,0), 
		[VOID_DATE] = PURCHASE_ORDER.VOID_DATE, 
		[VOIDED_BY] = PURCHASE_ORDER.VOIDED_BY, 
		[USER_MODIFIED] = PURCHASE_ORDER.USER_MODIFIED, 
		[MODIFIED_DATE] = PURCHASE_ORDER.MODIFIED_DATE
FROM dbo.PURCHASE_ORDER
JOIN dbo.VENDOR ON VENDOR.VN_CODE = PURCHASE_ORDER.VN_CODE
LEFT JOIN dbo.EMPLOYEE ON EMPLOYEE.EMP_CODE = PURCHASE_ORDER.[EMP_CODE]
LEFT JOIN dbo.VEN_CONT ON VEN_CONT.VC_CODE = PURCHASE_ORDER.VN_CONT_CODE AND VEN_CONT.VN_CODE = PURCHASE_ORDER.VN_CODE
WHERE PURCHASE_ORDER.PO_NUMBER = @ref_id

SET QUOTED_IDENTIFIER ON 
