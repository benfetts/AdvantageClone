--sp_media_med_acc
-- #01 10/04/12 - revised to re_dimension REV_NBR as smallint, and statements at top to drop procedure, etc.

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

SET ANSI_PADDING OFF
GO

IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[dbo].[sp_media_med_acc]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [dbo].[sp_media_med_acc]
GO

CREATE PROCEDURE [dbo].[sp_media_med_acc]
AS
BEGIN
	SET NOCOUNT ON;

--	MAIN DATA TABLE =======================================================
	CREATE TABLE #MedAcc(
		[ORDER_NBR] int NOT NULL,
		[LINE_NBR] int NULL,
		[MONTH] tinyint NULL,
		[YEAR] smallint NULL,
		[DISCOUNT] decimal(15,2) NULL,
		[NETCHARGE] decimal(15,2) NULL,
		[TAX] decimal(15,2) NULL,
		[LINE_NET] decimal(15,2) NULL,
		[GLACODE_WIP] varchar(30),
		[GLEXACT] int NULL,
		[GLESEQ_WIP] smallint NULL,
		[TYPE] varchar(10) NULL,
		[VN_FRL_EMP_CODE] varchar(6) NULL,
		[AP_INV_VCHR] varchar(20) NULL,
		[AR_INV_NBR] int NULL,
		[AR_INV_SEQ] tinyint NULL,
		[AR_TYPE] varchar(3) NULL,
		[PERIOD] varchar(8) NULL)

--	=======================================================================	
--	BROADCAST MEDIA_AMTS
--	=======================================================================
CREATE TABLE #Media_Amts ( 
	ORDER_NBR						int NULL, 
	LINE_NBR						smallint NULL, 
	REV_NBR							smallint NULL, 
	SEQ_NBR							smallint NULL, 
	LINE_NET						decimal(15,2) NULL, 
	COMM_AMT						decimal(15,2) NULL, 
	REBATE_AMT						decimal(15,2) NULL, 
	LINE_DISC						decimal(15,2) NULL, 
	VENDOR_TAX						decimal(15,2) NULL, 
	STATE_TAX						decimal(15,2) NULL, 
	COUNTY_TAX						decimal(15,2) NULL, 
	CITY_TAX						decimal(15,2) NULL, 
	SPOTS							smallint NULL, 
	BILL_AMT						decimal(15,2) NULL, 
	AR_INV_NBR						int NULL, 
	AR_TYPE							varchar(3) COLLATE SQL_Latin1_General_CP1_CS_AS, 
	AR_INV_SEQ						smallint NULL, 
	[MONTH]							varchar(3) COLLATE SQL_Latin1_General_CP1_CS_AS, 
	[YEAR]							int NULL, 
	BILLING_USER					varchar(100) COLLATE SQL_Latin1_General_CP1_CS_AS, 
	MEDIA_TYPE						varchar(15) COLLATE SQL_Latin1_General_CP1_CS_AS, 
	GLACODE_CITY					varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS, 
	GLACODE_COS						varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS, 
	GLACODE_COUNTY					varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS, 
	GLACODE_SALES					varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS, 
	GLACODE_STATE					varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS, 
	GLACODE_WIP						varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS, 
	GLESEQ_CITY						smallint NULL, 
	GLESEQ_COS						smallint NULL, 
	GLESEQ_COUNTY					smallint NULL, 
	GLESEQ_SALES					smallint NULL, 
	GLESEQ_STATE					smallint NULL, 
	GLESEQ_WIP						smallint NULL, 
	GLEXACT							int NULL, 
	GLEXACT_DEF						int NULL, 
	RECONCILE_LINE					smallint NULL, 
	DO_NOT_BILL						smallint NULL, 
	BILL_TYPE_FLAG					smallint NULL)

-- RADIO ==========================================================================
--January media amounts
INSERT INTO #Media_Amts
SELECT 
	d.ORDER_NBR, 
	d.LINE_NBR, 
	d.REV_NBR, 
	d.SEQ_NBR, 
	d.JAN_LINE_NET, 
	d.JAN_COMM_AMT, 
	d.JAN_REBATE_AMT, 
	d.JAN_DISCOUNT, 
	d.JAN_VENDOR_TAX, 
	d.JAN_STATE_TAX, 
	d.JAN_COUNTY_TAX, 
	d.JAN_CITY_TAX, 
	d.JAN_SPOTS, 
	d.JAN_BILLING_AMT, 
	d.JAN_AR_INV_NBR, 
	d.JAN_AR_TYPE, 
	d.JAN_AR_INV_SEQ, 
	'JAN', 
	d.BRDCAST_YEAR, 
	d.BILLING_USER, 
	'RADIO', 
	g.JAN_GLACODE_CITY, 
	g.JAN_GLACODE_COS, 
	g.JAN_GLACODE_COUNTY, 
	g.JAN_GLACODE_SALES, 
	g.JAN_GLACODE_STATE, 
	g.JAN_GLACODE_WIP, 
	g.JAN_GLESEQ_CITY, 
	g.JAN_GLESEQ_COS, 
	g.JAN_GLESEQ_COUNTY, 
	g.JAN_GLESEQ_SALES, 
	g.JAN_GLESEQ_STATE, 
	g.JAN_GLESEQ_WIP, 
	g.JAN_GLEXACT, 
	g.JAN_GLEXACT_DEF, 
	d.RECONCILE_LINE, 
	d.DO_NOT_BILL, 
	NULL
FROM dbo.RADIO_DETAIL1 AS d 
INNER JOIN dbo.RADIO_GL AS g 
	ON (d.ORDER_NBR = g.ORDER_NBR) 
		AND (d.REV_NBR = g.REV_NBR) 
		AND (d.LINE_NBR = g.LINE_NBR) 
		AND (d.SEQ_NBR = g.SEQ_NBR) 
		AND (d.BRDCAST_YEAR = g.BRDCAST_YEAR)
WHERE ((d.JAN_LINE_NET <>0 Or d.JAN_DISCOUNT <>0 Or d.JAN_VENDOR_TAX <>0 Or d.JAN_BILLING_AMT <> 0) AND d.JAN_AR_INV_NBR IS NOT NULL)
		OR (d.RECONCILE_LINE = 1 AND d.DO_NOT_BILL = 1)

--February media amounts
INSERT INTO #Media_Amts
SELECT 
	d.ORDER_NBR, 
	d.LINE_NBR, 
	d.REV_NBR, 
	d.SEQ_NBR, 
	d.FEB_LINE_NET, 
	d.FEB_COMM_AMT, 
	d.FEB_REBATE_AMT, 
	d.FEB_DISCOUNT, 
	d.FEB_VENDOR_TAX, 
	d.FEB_STATE_TAX, 
	d.FEB_COUNTY_TAX, 
	d.FEB_CITY_TAX, 
	d.FEB_SPOTS, 
	d.FEB_BILLING_AMT, 
	d.FEB_AR_INV_NBR, 
	d.FEB_AR_TYPE, 
	d.FEB_AR_INV_SEQ, 
	'FEB', 
	d.BRDCAST_YEAR, 
	d.BILLING_USER, 
	'RADIO', 
	g.FEB_GLACODE_CITY, 
	g.FEB_GLACODE_COS, 
	g.FEB_GLACODE_COUNTY, 
	g.FEB_GLACODE_SALES, 
	g.FEB_GLACODE_STATE, 
	g.FEB_GLACODE_WIP, 
	g.FEB_GLESEQ_CITY, 
	g.FEB_GLESEQ_COS, 
	g.FEB_GLESEQ_COUNTY, 
	g.FEB_GLESEQ_SALES, 
	g.FEB_GLESEQ_STATE, 
	g.FEB_GLESEQ_WIP, 
	g.FEB_GLEXACT, 
	g.FEB_GLEXACT_DEF, 
	d.RECONCILE_LINE, 
	d.DO_NOT_BILL, 
	NULL
FROM dbo.RADIO_DETAIL1 AS d  
INNER JOIN dbo.RADIO_GL AS g 
	ON (d.ORDER_NBR = g.ORDER_NBR) 
		AND (d.REV_NBR = g.REV_NBR) 
		AND (d.LINE_NBR = g.LINE_NBR) 
		AND (d.SEQ_NBR = g.SEQ_NBR) 
		AND (d.BRDCAST_YEAR = g.BRDCAST_YEAR)
WHERE ((d.FEB_LINE_NET <>0 Or d.FEB_DISCOUNT <>0 Or d.FEB_VENDOR_TAX <>0 Or d.FEB_BILLING_AMT <> 0) AND d.FEB_AR_INV_NBR IS NOT NULL)
		OR (d.RECONCILE_LINE = 1 AND d.DO_NOT_BILL = 1)

--March media amounts
INSERT INTO #Media_Amts
SELECT 
	d.ORDER_NBR, 
	d.LINE_NBR, 
	d.REV_NBR, 
	d.SEQ_NBR, 
	d.MAR_LINE_NET, 
	d.MAR_COMM_AMT, 
	d.MAR_REBATE_AMT, 
	d.MAR_DISCOUNT, 
	d.MAR_VENDOR_TAX, 
	d.MAR_STATE_TAX, 
	d.MAR_COUNTY_TAX, 
	d.MAR_CITY_TAX, 
	d.MAR_SPOTS, 
	d.MAR_BILLING_AMT, 
	d.MAR_AR_INV_NBR, 
	d.MAR_AR_TYPE, 
	d.MAR_AR_INV_SEQ, 
	'MAR', 
	d.BRDCAST_YEAR, 
	d.BILLING_USER, 
	'RADIO', 
	g.MAR_GLACODE_CITY, 
	g.MAR_GLACODE_COS, 
	g.MAR_GLACODE_COUNTY, 
	g.MAR_GLACODE_SALES, 
	g.MAR_GLACODE_STATE, 
	g.MAR_GLACODE_WIP, 
	g.MAR_GLESEQ_CITY, 
	g.MAR_GLESEQ_COS, 
	g.MAR_GLESEQ_COUNTY, 
	g.MAR_GLESEQ_SALES, 
	g.MAR_GLESEQ_STATE, 
	g.MAR_GLESEQ_WIP, 
	g.MAR_GLEXACT, 
	g.MAR_GLEXACT_DEF, 
	d.RECONCILE_LINE, 
	d.DO_NOT_BILL, 
	NULL 
FROM dbo.RADIO_DETAIL1 AS d  
INNER JOIN dbo.RADIO_GL AS g 
	ON (d.ORDER_NBR = g.ORDER_NBR) 
		AND (d.REV_NBR = g.REV_NBR) 
		AND (d.LINE_NBR = g.LINE_NBR) 
		AND (d.SEQ_NBR = g.SEQ_NBR) 
		AND (d.BRDCAST_YEAR = g.BRDCAST_YEAR)
WHERE ((d.MAR_LINE_NET <>0 Or d.MAR_DISCOUNT <>0 Or d.MAR_VENDOR_TAX <>0 Or d.MAR_BILLING_AMT <> 0) AND d.MAR_AR_INV_NBR IS NOT NULL)
		OR (d.RECONCILE_LINE = 1 AND d.DO_NOT_BILL = 1)

--April media amounts
INSERT INTO #Media_Amts
SELECT 
	d.ORDER_NBR, 
	d.LINE_NBR, 
	d.REV_NBR, 
	d.SEQ_NBR, 
	d.APR_LINE_NET, 
	d.APR_COMM_AMT, 
	d.APR_REBATE_AMT, 
	d.APR_DISCOUNT, 
	d.APR_VENDOR_TAX, 
	d.APR_STATE_TAX, 
	d.APR_COUNTY_TAX, 
	d.APR_CITY_TAX, 
	d.APR_SPOTS, 
	d.APR_BILLING_AMT, 
	d.APR_AR_INV_NBR, 
	d.APR_AR_TYPE, 
	d.APR_AR_INV_SEQ, 
	'APR', 
	d.BRDCAST_YEAR, 
	d.BILLING_USER, 
	'RADIO', 
	g.APR_GLACODE_CITY, 
	g.APR_GLACODE_COS, 
	g.APR_GLACODE_COUNTY, 
	g.APR_GLACODE_SALES, 
	g.APR_GLACODE_STATE, 
	g.APR_GLACODE_WIP, 
	g.APR_GLESEQ_CITY, 
	g.APR_GLESEQ_COS, 
	g.APR_GLESEQ_COUNTY, 
	g.APR_GLESEQ_SALES, 
	g.APR_GLESEQ_STATE, 
	g.APR_GLESEQ_WIP, 
	g.APR_GLEXACT, 
	g.APR_GLEXACT_DEF, 
	d.RECONCILE_LINE, 
	d.DO_NOT_BILL, 
	NULL
FROM dbo.RADIO_DETAIL1 AS d 
INNER JOIN dbo.RADIO_GL AS g 
	ON (d.ORDER_NBR = g.ORDER_NBR) 
		AND (d.REV_NBR = g.REV_NBR) 
		AND (d.LINE_NBR = g.LINE_NBR) 
		AND (d.SEQ_NBR = g.SEQ_NBR) 
		AND (d.BRDCAST_YEAR = g.BRDCAST_YEAR)
WHERE ((d.APR_LINE_NET <>0 Or d.APR_DISCOUNT <>0 Or d.APR_VENDOR_TAX <>0 Or d.APR_BILLING_AMT <> 0) AND d.APR_AR_INV_NBR IS NOT NULL)
		OR (d.RECONCILE_LINE = 1 AND d.DO_NOT_BILL = 1)
 
--May media amounts
INSERT INTO #Media_Amts
SELECT 
	d.ORDER_NBR, 
	d.LINE_NBR, 
	d.REV_NBR, 
	d.SEQ_NBR, 
	d.MAY_LINE_NET, 
	d.MAY_COMM_AMT, 
	d.MAY_REBATE_AMT, 
	d.MAY_DISCOUNT, 
	d.MAY_VENDOR_TAX, 
	d.MAY_STATE_TAX, 
	d.MAY_COUNTY_TAX, 
	d.MAY_CITY_TAX, 
	d.MAY_SPOTS, 
	d.MAY_BILLING_AMT, 
	d.MAY_AR_INV_NBR, 
	d.MAY_AR_TYPE, 
	d.MAY_AR_INV_SEQ, 
	'MAY', 
	d.BRDCAST_YEAR, 
	d.BILLING_USER, 
	'RADIO', 
	g.MAY_GLACODE_CITY, 
	g.MAY_GLACODE_COS, 
	g.MAY_GLACODE_COUNTY, 
	g.MAY_GLACODE_SALES, 
	g.MAY_GLACODE_STATE, 
	g.MAY_GLACODE_WIP, 
	g.MAY_GLESEQ_CITY, 
	g.MAY_GLESEQ_COS, 
	g.MAY_GLESEQ_COUNTY, 
	g.MAY_GLESEQ_SALES, 
	g.MAY_GLESEQ_STATE, 
	g.MAY_GLESEQ_WIP, 
	g.MAY_GLEXACT, 
	g.MAY_GLEXACT_DEF, 
	d.RECONCILE_LINE, 
	d.DO_NOT_BILL, 
	NULL
FROM dbo.RADIO_DETAIL1 AS d 
INNER JOIN dbo.RADIO_GL AS g 
	ON (d.ORDER_NBR = g.ORDER_NBR) 
		AND (d.REV_NBR = g.REV_NBR) 
		AND (d.LINE_NBR = g.LINE_NBR) 
		AND (d.SEQ_NBR = g.SEQ_NBR) 
		AND (d.BRDCAST_YEAR = g.BRDCAST_YEAR)
WHERE ((d.MAY_LINE_NET <>0 Or d.MAY_DISCOUNT <>0 Or d.MAY_VENDOR_TAX <>0 Or d.MAY_BILLING_AMT <> 0) AND d.MAY_AR_INV_NBR IS NOT NULL)
		OR (d.RECONCILE_LINE = 1 AND d.DO_NOT_BILL = 1)

--June media amounts
INSERT INTO #Media_Amts
SELECT 
	d.ORDER_NBR, 
	d.LINE_NBR, 
	d.REV_NBR, 
	d.SEQ_NBR, 
	d.JUN_LINE_NET, 
	d.JUN_COMM_AMT, 
	d.JUN_REBATE_AMT, 
	d.JUN_DISCOUNT, 
	d.JUN_VENDOR_TAX, 
	d.JUN_STATE_TAX, 
	d.JUN_COUNTY_TAX, 
	d.JUN_CITY_TAX, 
	d.JUN_SPOTS, 
	d.JUN_BILLING_AMT, 
	d.JUN_AR_INV_NBR, 
	d.JUN_AR_TYPE, 
	d.JUN_AR_INV_SEQ, 
	'JUN', 
	d.BRDCAST_YEAR, 
	d.BILLING_USER, 
	'RADIO', 
	g.JUN_GLACODE_CITY, 
	g.JUN_GLACODE_COS, 
	g.JUN_GLACODE_COUNTY, 
	g.JUN_GLACODE_SALES, 
	g.JUN_GLACODE_STATE, 
	g.JUN_GLACODE_WIP, 
	g.JUN_GLESEQ_CITY, 
	g.JUN_GLESEQ_COS, 
	g.JUN_GLESEQ_COUNTY, 
	g.JUN_GLESEQ_SALES, 
	g.JUN_GLESEQ_STATE, 
	g.JUN_GLESEQ_WIP, 
	g.JUN_GLEXACT, 
	g.JUN_GLEXACT_DEF, 
	d.RECONCILE_LINE, 
	d.DO_NOT_BILL, 
	NULL
FROM dbo.RADIO_DETAIL1 AS d 
INNER JOIN dbo.RADIO_GL AS g 
	ON (d.ORDER_NBR = g.ORDER_NBR) 
		AND (d.REV_NBR = g.REV_NBR) 
		AND (d.LINE_NBR = g.LINE_NBR) 
		AND (d.SEQ_NBR = g.SEQ_NBR) 
		AND (d.BRDCAST_YEAR = g.BRDCAST_YEAR)
WHERE ((d.JUN_LINE_NET <>0 Or d.JUN_DISCOUNT <>0 Or d.JUN_VENDOR_TAX <>0 Or d.JUN_BILLING_AMT <> 0) AND d.JUN_AR_INV_NBR IS NOT NULL)
		OR (d.RECONCILE_LINE = 1 AND d.DO_NOT_BILL = 1)

--July media amounts
INSERT INTO #Media_Amts
SELECT 
	d.ORDER_NBR, 
	d.LINE_NBR, 
	d.REV_NBR, 
	d.SEQ_NBR, 
	d.JUL_LINE_NET, 
	d.JUL_COMM_AMT, 
	d.JUL_REBATE_AMT, 
	d.JUL_DISCOUNT, 
	d.JUL_VENDOR_TAX, 
	d.JUL_STATE_TAX, 
	d.JUL_COUNTY_TAX, 
	d.JUL_CITY_TAX, 
	d.JUL_SPOTS, 
	d.JUL_BILLING_AMT, 
	d.JUL_AR_INV_NBR, 
	d.JUL_AR_TYPE, 
	d.JUL_AR_INV_SEQ, 
	'JUL', 
	d.BRDCAST_YEAR, 
	d.BILLING_USER, 
	'RADIO', 
	g.JUL_GLACODE_CITY, 
	g.JUL_GLACODE_COS, 
	g.JUL_GLACODE_COUNTY, 
	g.JUL_GLACODE_SALES, 
	g.JUL_GLACODE_STATE, 
	g.JUL_GLACODE_WIP, 
	g.JUL_GLESEQ_CITY, 
	g.JUL_GLESEQ_COS, 
	g.JUL_GLESEQ_COUNTY, 
	g.JUL_GLESEQ_SALES, 
	g.JUL_GLESEQ_STATE, 
	g.JUL_GLESEQ_WIP, 
	g.JUL_GLEXACT, 
	g.JUL_GLEXACT_DEF, 
	d.RECONCILE_LINE, 
	d.DO_NOT_BILL, 
	NULL
FROM dbo.RADIO_DETAIL1 AS d 
INNER JOIN dbo.RADIO_GL AS g 
	ON (d.ORDER_NBR = g.ORDER_NBR) 
		AND (d.REV_NBR = g.REV_NBR) 
		AND (d.LINE_NBR = g.LINE_NBR) 
		AND (d.SEQ_NBR = g.SEQ_NBR) 
		AND (d.BRDCAST_YEAR = g.BRDCAST_YEAR)
WHERE ((d.JUL_LINE_NET <>0 Or d.JUL_DISCOUNT <>0 Or d.JUL_VENDOR_TAX <>0 Or d.JUL_BILLING_AMT <> 0) AND d.JUL_AR_INV_NBR IS NOT NULL)
		OR (d.RECONCILE_LINE = 1 AND d.DO_NOT_BILL = 1)

--August media amounts
INSERT INTO #Media_Amts
SELECT 
	d.ORDER_NBR, 
	d.LINE_NBR, 
	d.REV_NBR, 
	d.SEQ_NBR, 
	d.AUG_LINE_NET, 
	d.AUG_COMM_AMT, 
	d.AUG_REBATE_AMT, 
	d.AUG_DISCOUNT, 
	d.AUG_VENDOR_TAX, 
	d.AUG_STATE_TAX, 
	d.AUG_COUNTY_TAX, 
	d.AUG_CITY_TAX, 
	d.AUG_SPOTS, 
	d.AUG_BILLING_AMT, 
	d.AUG_AR_INV_NBR, 
	d.AUG_AR_TYPE, 
	d.AUG_AR_INV_SEQ, 
	'AUG', 
	d.BRDCAST_YEAR, 
	d.BILLING_USER, 
	'RADIO', 
	g.AUG_GLACODE_CITY, 
	g.AUG_GLACODE_COS, 
	g.AUG_GLACODE_COUNTY, 
	g.AUG_GLACODE_SALES, 
	g.AUG_GLACODE_STATE, 
	g.AUG_GLACODE_WIP, 
	g.AUG_GLESEQ_CITY, 
	g.AUG_GLESEQ_COS, 
	g.AUG_GLESEQ_COUNTY, 
	g.AUG_GLESEQ_SALES, 
	g.AUG_GLESEQ_STATE, 
	g.AUG_GLESEQ_WIP, 
	g.AUG_GLEXACT, 
	g.AUG_GLEXACT_DEF, 
	d.RECONCILE_LINE, 
	d.DO_NOT_BILL, 
	NULL
FROM dbo.RADIO_DETAIL1 AS d 
INNER JOIN dbo.RADIO_GL AS g 
	ON (d.ORDER_NBR = g.ORDER_NBR) 
		AND (d.REV_NBR = g.REV_NBR) 
		AND (d.LINE_NBR = g.LINE_NBR) 
		AND (d.SEQ_NBR = g.SEQ_NBR) 
		AND (d.BRDCAST_YEAR = g.BRDCAST_YEAR)
WHERE ((d.AUG_LINE_NET <>0 Or d.AUG_DISCOUNT <>0 Or d.AUG_VENDOR_TAX <>0 Or d.AUG_BILLING_AMT <> 0) AND d.AUG_AR_INV_NBR IS NOT NULL)
		OR (d.RECONCILE_LINE = 1 AND d.DO_NOT_BILL = 1)

--September media amounts
INSERT INTO #Media_Amts
SELECT 
	d.ORDER_NBR, 
	d.LINE_NBR, 
	d.REV_NBR, 
	d.SEQ_NBR, 
	d.SEP_LINE_NET, 
	d.SEP_COMM_AMT, 
	d.SEP_REBATE_AMT, 
	d.SEP_DISCOUNT, 
	d.SEP_VENDOR_TAX, 
	d.SEP_STATE_TAX, 
	d.SEP_COUNTY_TAX, 
	d.SEP_CITY_TAX, 
	d.SEP_SPOTS, 
	d.SEP_BILLING_AMT, 
	d.SEP_AR_INV_NBR, 
	d.SEP_AR_TYPE, 
	d.SEP_AR_INV_SEQ, 
	'SEP', 
	d.BRDCAST_YEAR, 
	d.BILLING_USER, 
	'RADIO', 
	g.SEP_GLACODE_CITY, 
	g.SEP_GLACODE_COS, 
	g.SEP_GLACODE_COUNTY, 
	g.SEP_GLACODE_SALES, 
	g.SEP_GLACODE_STATE, 
	g.SEP_GLACODE_WIP, 
	g.SEP_GLESEQ_CITY, 
	g.SEP_GLESEQ_COS, 
	g.SEP_GLESEQ_COUNTY, 
	g.SEP_GLESEQ_SALES, 
	g.SEP_GLESEQ_STATE, 
	g.SEP_GLESEQ_WIP, 
	g.SEP_GLEXACT, 
	g.SEP_GLEXACT_DEF, 
	d.RECONCILE_LINE, 
	d.DO_NOT_BILL, 
	NULL
FROM dbo.RADIO_DETAIL1 AS d 
INNER JOIN dbo.RADIO_GL AS g 
	ON (d.ORDER_NBR = g.ORDER_NBR) 
		AND (d.REV_NBR = g.REV_NBR) 
		AND (d.LINE_NBR = g.LINE_NBR) 
		AND (d.SEQ_NBR = g.SEQ_NBR) 
		AND (d.BRDCAST_YEAR = g.BRDCAST_YEAR)
WHERE ((d.SEP_LINE_NET <>0 Or d.SEP_DISCOUNT <>0 Or d.SEP_VENDOR_TAX <>0 Or d.SEP_BILLING_AMT <> 0) AND d.SEP_AR_INV_NBR IS NOT NULL)
		OR (d.RECONCILE_LINE = 1 AND d.DO_NOT_BILL = 1)

--October media amounts
INSERT INTO #Media_Amts
SELECT 
	d.ORDER_NBR, 
	d.LINE_NBR, 
	d.REV_NBR, 
	d.SEQ_NBR, 
	d.OCT_LINE_NET, 
	d.OCT_COMM_AMT, 
	d.OCT_REBATE_AMT, 
	d.OCT_DISCOUNT, 
	d.OCT_VENDOR_TAX, 
	d.OCT_STATE_TAX, 
	d.OCT_COUNTY_TAX, 
	d.OCT_CITY_TAX, 
	d.OCT_SPOTS, 
	d.OCT_BILLING_AMT, 
	d.OCT_AR_INV_NBR, 
	d.OCT_AR_TYPE, 
	d.OCT_AR_INV_SEQ, 
	'OCT', 
	d.BRDCAST_YEAR, 
	d.BILLING_USER, 
	'RADIO', 
	g.OCT_GLACODE_CITY, 
	g.OCT_GLACODE_COS, 
	g.OCT_GLACODE_COUNTY, 
	g.OCT_GLACODE_SALES, 
	g.OCT_GLACODE_STATE, 
	g.OCT_GLACODE_WIP, 
	g.OCT_GLESEQ_CITY, 
	g.OCT_GLESEQ_COS, 
	g.OCT_GLESEQ_COUNTY, 
	g.OCT_GLESEQ_SALES, 
	g.OCT_GLESEQ_STATE, 
	g.OCT_GLESEQ_WIP, 
	g.OCT_GLEXACT, 
	g.OCT_GLEXACT_DEF, 
	d.RECONCILE_LINE, 
	d.DO_NOT_BILL, 
	NULL
FROM dbo.RADIO_DETAIL1 AS d 
INNER JOIN dbo.RADIO_GL AS g 
	ON (d.ORDER_NBR = g.ORDER_NBR) 
		AND (d.REV_NBR = g.REV_NBR) 
		AND (d.LINE_NBR = g.LINE_NBR) 
		AND (d.SEQ_NBR = g.SEQ_NBR) 
		AND (d.BRDCAST_YEAR = g.BRDCAST_YEAR)
WHERE ((d.OCT_LINE_NET <>0 Or d.OCT_DISCOUNT <>0 Or d.OCT_VENDOR_TAX <>0 Or d.OCT_BILLING_AMT <> 0) AND d.OCT_AR_INV_NBR IS NOT NULL)
		OR (d.RECONCILE_LINE = 1 AND d.DO_NOT_BILL = 1)

--November media amounts
INSERT INTO #Media_Amts
SELECT 
	d.ORDER_NBR, 
	d.LINE_NBR, 
	d.REV_NBR, 
	d.SEQ_NBR, 
	d.NOV_LINE_NET, 
	d.NOV_COMM_AMT, 
	d.NOV_REBATE_AMT, 
	d.NOV_DISCOUNT, 
	d.NOV_VENDOR_TAX, 
	d.NOV_STATE_TAX, 
	d.NOV_COUNTY_TAX, 
	d.NOV_CITY_TAX, 
	d.NOV_SPOTS, 
	d.NOV_BILLING_AMT, 
	d.NOV_AR_INV_NBR, 
	d.NOV_AR_TYPE, 
	d.NOV_AR_INV_SEQ, 
	'NOV', 
	d.BRDCAST_YEAR, 
	d.BILLING_USER, 
	'RADIO', 
	g.NOV_GLACODE_CITY, 
	g.NOV_GLACODE_COS, 
	g.NOV_GLACODE_COUNTY, 
	g.NOV_GLACODE_SALES, 
	g.NOV_GLACODE_STATE, 
	g.NOV_GLACODE_WIP, 
	g.NOV_GLESEQ_CITY, 
	g.NOV_GLESEQ_COS, 
	g.NOV_GLESEQ_COUNTY, 
	g.NOV_GLESEQ_SALES, 
	g.NOV_GLESEQ_STATE, 
	g.NOV_GLESEQ_WIP, 
	g.NOV_GLEXACT, 
	g.NOV_GLEXACT_DEF, 
	d.RECONCILE_LINE, 
	d.DO_NOT_BILL, 
	NULL
FROM dbo.RADIO_DETAIL1 AS d 
INNER JOIN dbo.RADIO_GL AS g 
	ON (d.ORDER_NBR = g.ORDER_NBR) 
		AND (d.REV_NBR = g.REV_NBR) 
		AND (d.LINE_NBR = g.LINE_NBR) 
		AND (d.SEQ_NBR = g.SEQ_NBR) 
		AND (d.BRDCAST_YEAR = g.BRDCAST_YEAR)
WHERE ((d.NOV_LINE_NET <>0 Or d.NOV_DISCOUNT <>0 Or d.NOV_VENDOR_TAX <>0 Or d.NOV_BILLING_AMT <> 0) AND d.NOV_AR_INV_NBR IS NOT NULL)
		OR (d.RECONCILE_LINE = 1 AND d.DO_NOT_BILL = 1)

----December media amounts
INSERT INTO #Media_Amts
SELECT 
	d.ORDER_NBR, 
	d.LINE_NBR, 
	d.REV_NBR, 
	d.SEQ_NBR, 
	d.DEC_LINE_NET, 
	d.DEC_COMM_AMT, 
	d.DEC_REBATE_AMT, 
	d.DEC_DISCOUNT, 
	d.DEC_VENDOR_TAX, 
	d.DEC_STATE_TAX, 
	d.DEC_COUNTY_TAX, 
	d.DEC_CITY_TAX, 
	d.DEC_SPOTS, 
	d.DEC_BILLING_AMT, 
	d.DEC_AR_INV_NBR, 
	d.DEC_AR_TYPE, 
	d.DEC_AR_INV_SEQ, 
	'DEC', 
	d.BRDCAST_YEAR, 
	d.BILLING_USER, 
	'RADIO', 
	g.DEC_GLACODE_CITY, 
	g.DEC_GLACODE_COS, 
	g.DEC_GLACODE_COUNTY, 
	g.DEC_GLACODE_SALES, 
	g.DEC_GLACODE_STATE, 
	g.DEC_GLACODE_WIP, 
	g.DEC_GLESEQ_CITY, 
	g.DEC_GLESEQ_COS, 
	g.DEC_GLESEQ_COUNTY, 
	g.DEC_GLESEQ_SALES, 
	g.DEC_GLESEQ_STATE, 
	g.DEC_GLESEQ_WIP, 
	g.DEC_GLEXACT, 
	g.DEC_GLEXACT_DEF, 
	d.RECONCILE_LINE, 
	d.DO_NOT_BILL, 
	NULL
FROM dbo.RADIO_DETAIL1 AS d 
INNER JOIN dbo.RADIO_GL AS g 
	ON (d.ORDER_NBR = g.ORDER_NBR) 
		AND (d.REV_NBR = g.REV_NBR) 
		AND (d.LINE_NBR = g.LINE_NBR) 
		AND (d.SEQ_NBR = g.SEQ_NBR) 
		AND (d.BRDCAST_YEAR = g.BRDCAST_YEAR)
WHERE ((d.DEC_LINE_NET <>0 Or d.DEC_DISCOUNT <>0 Or d.DEC_VENDOR_TAX <>0 Or d.DEC_BILLING_AMT <> 0) AND d.DEC_AR_INV_NBR IS NOT NULL)
		OR (d.RECONCILE_LINE = 1 AND d.DO_NOT_BILL = 1)

-- TELEVISION =========================================================================
--January media amounts
INSERT INTO #Media_Amts
SELECT 
	d.ORDER_NBR, 
	d.LINE_NBR, 
	d.REV_NBR, 
	d.SEQ_NBR, 
	d.JAN_LINE_NET, 
	d.JAN_COMM_AMT, 
	d.JAN_REBATE_AMT, 
	d.JAN_DISCOUNT, 
	d.JAN_VENDOR_TAX, 
	d.JAN_STATE_TAX, 
	d.JAN_COUNTY_TAX, 
	d.JAN_CITY_TAX, 
	d.JAN_SPOTS, 
	d.JAN_BILLING_AMT, 
	d.JAN_AR_INV_NBR, 
	d.JAN_AR_TYPE, 
	d.JAN_AR_INV_SEQ, 
	'JAN', 
	d.BRDCAST_YEAR, 
	d.BILLING_USER, 
	'TV', 
	g.JAN_GLACODE_CITY, 
	g.JAN_GLACODE_COS, 
	g.JAN_GLACODE_COUNTY, 
	g.JAN_GLACODE_SALES, 
	g.JAN_GLACODE_STATE, 
	g.JAN_GLACODE_WIP, 
	g.JAN_GLESEQ_CITY, 
	g.JAN_GLESEQ_COS, 
	g.JAN_GLESEQ_COUNTY, 
	g.JAN_GLESEQ_SALES, 
	g.JAN_GLESEQ_STATE, 
	g.JAN_GLESEQ_WIP, 
	g.JAN_GLEXACT, 
	g.JAN_GLEXACT_DEF, 
	d.RECONCILE_LINE, 
	d.DO_NOT_BILL, 
	NULL
FROM dbo.TV_DETAIL1 AS d 
INNER JOIN dbo.TV_GL AS g 
	ON (d.ORDER_NBR = g.ORDER_NBR) 
		AND (d.REV_NBR = g.REV_NBR) 
		AND (d.LINE_NBR = g.LINE_NBR) 
		AND (d.SEQ_NBR = g.SEQ_NBR) 
		AND (d.BRDCAST_YEAR = g.BRDCAST_YEAR)
WHERE ((d.JAN_LINE_NET <>0 Or d.JAN_DISCOUNT <>0 Or d.JAN_VENDOR_TAX <>0 Or d.JAN_BILLING_AMT <> 0) AND d.JAN_AR_INV_NBR IS NOT NULL)
		OR (d.RECONCILE_LINE = 1 AND d.DO_NOT_BILL = 1)

--February media amounts
INSERT INTO #Media_Amts
SELECT 
	d.ORDER_NBR, 
	d.LINE_NBR, 
	d.REV_NBR, 
	d.SEQ_NBR, 
	d.FEB_LINE_NET, 
	d.FEB_COMM_AMT, 
	d.FEB_REBATE_AMT, 
	d.FEB_DISCOUNT, 
	d.FEB_VENDOR_TAX, 
	d.FEB_STATE_TAX, 
	d.FEB_COUNTY_TAX, 
	d.FEB_CITY_TAX, 
	d.FEB_SPOTS, 
	d.FEB_BILLING_AMT, 
	d.FEB_AR_INV_NBR, 
	d.FEB_AR_TYPE, 
	d.FEB_AR_INV_SEQ, 
	'FEB', 
	d.BRDCAST_YEAR, 
	d.BILLING_USER, 
	'TV', 
	g.FEB_GLACODE_CITY, 
	g.FEB_GLACODE_COS, 
	g.FEB_GLACODE_COUNTY, 
	g.FEB_GLACODE_SALES, 
	g.FEB_GLACODE_STATE, 
	g.FEB_GLACODE_WIP, 
	g.FEB_GLESEQ_CITY, 
	g.FEB_GLESEQ_COS, 
	g.FEB_GLESEQ_COUNTY, 
	g.FEB_GLESEQ_SALES, 
	g.FEB_GLESEQ_STATE, 
	g.FEB_GLESEQ_WIP, 
	g.FEB_GLEXACT, 
	g.FEB_GLEXACT_DEF, 
	d.RECONCILE_LINE, 
	d.DO_NOT_BILL, 
	NULL
FROM dbo.TV_DETAIL1 AS d  
INNER JOIN dbo.TV_GL AS g 
	ON (d.ORDER_NBR = g.ORDER_NBR) 
		AND (d.REV_NBR = g.REV_NBR) 
		AND (d.LINE_NBR = g.LINE_NBR) 
		AND (d.SEQ_NBR = g.SEQ_NBR) 
		AND (d.BRDCAST_YEAR = g.BRDCAST_YEAR)
WHERE ((d.FEB_LINE_NET <>0 Or d.FEB_DISCOUNT <>0 Or d.FEB_VENDOR_TAX <>0 Or d.FEB_BILLING_AMT <> 0) AND d.FEB_AR_INV_NBR IS NOT NULL)
		OR (d.RECONCILE_LINE = 1 AND d.DO_NOT_BILL = 1)

--March media amounts
INSERT INTO #Media_Amts
SELECT 
	d.ORDER_NBR, 
	d.LINE_NBR, 
	d.REV_NBR, 
	d.SEQ_NBR, 
	d.MAR_LINE_NET, 
	d.MAR_COMM_AMT, 
	d.MAR_REBATE_AMT, 
	d.MAR_DISCOUNT, 
	d.MAR_VENDOR_TAX, 
	d.MAR_STATE_TAX, 
	d.MAR_COUNTY_TAX, 
	d.MAR_CITY_TAX, 
	d.MAR_SPOTS, 
	d.MAR_BILLING_AMT, 
	d.MAR_AR_INV_NBR, 
	d.MAR_AR_TYPE, 
	d.MAR_AR_INV_SEQ, 
	'MAR', 
	d.BRDCAST_YEAR, 
	d.BILLING_USER, 
	'TV', 
	g.MAR_GLACODE_CITY, 
	g.MAR_GLACODE_COS, 
	g.MAR_GLACODE_COUNTY, 
	g.MAR_GLACODE_SALES, 
	g.MAR_GLACODE_STATE, 
	g.MAR_GLACODE_WIP, 
	g.MAR_GLESEQ_CITY, 
	g.MAR_GLESEQ_COS, 
	g.MAR_GLESEQ_COUNTY, 
	g.MAR_GLESEQ_SALES, 
	g.MAR_GLESEQ_STATE, 
	g.MAR_GLESEQ_WIP, 
	g.MAR_GLEXACT, 
	g.MAR_GLEXACT_DEF, 
	d.RECONCILE_LINE, 
	d.DO_NOT_BILL, 
	NULL 
FROM dbo.TV_DETAIL1 AS d  
INNER JOIN dbo.TV_GL AS g 
	ON (d.ORDER_NBR = g.ORDER_NBR) 
		AND (d.REV_NBR = g.REV_NBR) 
		AND (d.LINE_NBR = g.LINE_NBR) 
		AND (d.SEQ_NBR = g.SEQ_NBR) 
		AND (d.BRDCAST_YEAR = g.BRDCAST_YEAR)
WHERE ((d.MAR_LINE_NET <>0 Or d.MAR_DISCOUNT <>0 Or d.MAR_VENDOR_TAX <>0 Or d.MAR_BILLING_AMT <> 0) AND d.MAR_AR_INV_NBR IS NOT NULL)
		OR (d.RECONCILE_LINE = 1 AND d.DO_NOT_BILL = 1)

--April media amounts
INSERT INTO #Media_Amts
SELECT 
	d.ORDER_NBR, 
	d.LINE_NBR, 
	d.REV_NBR, 
	d.SEQ_NBR, 
	d.APR_LINE_NET, 
	d.APR_COMM_AMT, 
	d.APR_REBATE_AMT, 
	d.APR_DISCOUNT, 
	d.APR_VENDOR_TAX, 
	d.APR_STATE_TAX, 
	d.APR_COUNTY_TAX, 
	d.APR_CITY_TAX, 
	d.APR_SPOTS, 
	d.APR_BILLING_AMT, 
	d.APR_AR_INV_NBR, 
	d.APR_AR_TYPE, 
	d.APR_AR_INV_SEQ, 
	'APR', 
	d.BRDCAST_YEAR, 
	d.BILLING_USER, 
	'TV', 
	g.APR_GLACODE_CITY, 
	g.APR_GLACODE_COS, 
	g.APR_GLACODE_COUNTY, 
	g.APR_GLACODE_SALES, 
	g.APR_GLACODE_STATE, 
	g.APR_GLACODE_WIP, 
	g.APR_GLESEQ_CITY, 
	g.APR_GLESEQ_COS, 
	g.APR_GLESEQ_COUNTY, 
	g.APR_GLESEQ_SALES, 
	g.APR_GLESEQ_STATE, 
	g.APR_GLESEQ_WIP, 
	g.APR_GLEXACT, 
	g.APR_GLEXACT_DEF, 
	d.RECONCILE_LINE, 
	d.DO_NOT_BILL, 
	NULL
FROM dbo.TV_DETAIL1 AS d 
INNER JOIN dbo.TV_GL AS g 
	ON (d.ORDER_NBR = g.ORDER_NBR) 
		AND (d.REV_NBR = g.REV_NBR) 
		AND (d.LINE_NBR = g.LINE_NBR) 
		AND (d.SEQ_NBR = g.SEQ_NBR) 
		AND (d.BRDCAST_YEAR = g.BRDCAST_YEAR)
WHERE ((d.APR_LINE_NET <>0 Or d.APR_DISCOUNT <>0 Or d.APR_VENDOR_TAX <>0 Or d.APR_BILLING_AMT <> 0) AND d.APR_AR_INV_NBR IS NOT NULL)
		OR (d.RECONCILE_LINE = 1 AND d.DO_NOT_BILL = 1)
 
--May media amounts
INSERT INTO #Media_Amts
SELECT 
	d.ORDER_NBR, 
	d.LINE_NBR, 
	d.REV_NBR, 
	d.SEQ_NBR, 
	d.MAY_LINE_NET, 
	d.MAY_COMM_AMT, 
	d.MAY_REBATE_AMT, 
	d.MAY_DISCOUNT, 
	d.MAY_VENDOR_TAX, 
	d.MAY_STATE_TAX, 
	d.MAY_COUNTY_TAX, 
	d.MAY_CITY_TAX, 
	d.MAY_SPOTS, 
	d.MAY_BILLING_AMT, 
	d.MAY_AR_INV_NBR, 
	d.MAY_AR_TYPE, 
	d.MAY_AR_INV_SEQ, 
	'MAY', 
	d.BRDCAST_YEAR, 
	d.BILLING_USER, 
	'TV', 
	g.MAY_GLACODE_CITY, 
	g.MAY_GLACODE_COS, 
	g.MAY_GLACODE_COUNTY, 
	g.MAY_GLACODE_SALES, 
	g.MAY_GLACODE_STATE, 
	g.MAY_GLACODE_WIP, 
	g.MAY_GLESEQ_CITY, 
	g.MAY_GLESEQ_COS, 
	g.MAY_GLESEQ_COUNTY, 
	g.MAY_GLESEQ_SALES, 
	g.MAY_GLESEQ_STATE, 
	g.MAY_GLESEQ_WIP, 
	g.MAY_GLEXACT, 
	g.MAY_GLEXACT_DEF, 
	d.RECONCILE_LINE, 
	d.DO_NOT_BILL, 
	NULL
FROM dbo.TV_DETAIL1 AS d 
INNER JOIN dbo.TV_GL AS g 
	ON (d.ORDER_NBR = g.ORDER_NBR) 
		AND (d.REV_NBR = g.REV_NBR) 
		AND (d.LINE_NBR = g.LINE_NBR) 
		AND (d.SEQ_NBR = g.SEQ_NBR) 
		AND (d.BRDCAST_YEAR = g.BRDCAST_YEAR)
WHERE ((d.MAY_LINE_NET <>0 Or d.MAY_DISCOUNT <>0 Or d.MAY_VENDOR_TAX <>0 Or d.MAY_BILLING_AMT <> 0) AND d.MAY_AR_INV_NBR IS NOT NULL)
		OR (d.RECONCILE_LINE = 1 AND d.DO_NOT_BILL = 1)

--June media amounts
INSERT INTO #Media_Amts
SELECT 
	d.ORDER_NBR, 
	d.LINE_NBR, 
	d.REV_NBR, 
	d.SEQ_NBR, 
	d.JUN_LINE_NET, 
	d.JUN_COMM_AMT, 
	d.JUN_REBATE_AMT, 
	d.JUN_DISCOUNT, 
	d.JUN_VENDOR_TAX, 
	d.JUN_STATE_TAX, 
	d.JUN_COUNTY_TAX, 
	d.JUN_CITY_TAX, 
	d.JUN_SPOTS, 
	d.JUN_BILLING_AMT, 
	d.JUN_AR_INV_NBR, 
	d.JUN_AR_TYPE, 
	d.JUN_AR_INV_SEQ, 
	'JUN', 
	d.BRDCAST_YEAR, 
	d.BILLING_USER, 
	'TV', 
	g.JUN_GLACODE_CITY, 
	g.JUN_GLACODE_COS, 
	g.JUN_GLACODE_COUNTY, 
	g.JUN_GLACODE_SALES, 
	g.JUN_GLACODE_STATE, 
	g.JUN_GLACODE_WIP, 
	g.JUN_GLESEQ_CITY, 
	g.JUN_GLESEQ_COS, 
	g.JUN_GLESEQ_COUNTY, 
	g.JUN_GLESEQ_SALES, 
	g.JUN_GLESEQ_STATE, 
	g.JUN_GLESEQ_WIP, 
	g.JUN_GLEXACT, 
	g.JUN_GLEXACT_DEF, 
	d.RECONCILE_LINE, 
	d.DO_NOT_BILL, 
	NULL
FROM dbo.TV_DETAIL1 AS d 
INNER JOIN dbo.TV_GL AS g 
	ON (d.ORDER_NBR = g.ORDER_NBR) 
		AND (d.REV_NBR = g.REV_NBR) 
		AND (d.LINE_NBR = g.LINE_NBR) 
		AND (d.SEQ_NBR = g.SEQ_NBR) 
		AND (d.BRDCAST_YEAR = g.BRDCAST_YEAR)
WHERE ((d.JUN_LINE_NET <>0 Or d.JUN_DISCOUNT <>0 Or d.JUN_VENDOR_TAX <>0 Or d.JUN_BILLING_AMT <> 0) AND d.JUN_AR_INV_NBR IS NOT NULL)
		OR (d.RECONCILE_LINE = 1 AND d.DO_NOT_BILL = 1)

--July media amounts
INSERT INTO #Media_Amts
SELECT 
	d.ORDER_NBR, 
	d.LINE_NBR, 
	d.REV_NBR, 
	d.SEQ_NBR, 
	d.JUL_LINE_NET, 
	d.JUL_COMM_AMT, 
	d.JUL_REBATE_AMT, 
	d.JUL_DISCOUNT, 
	d.JUL_VENDOR_TAX, 
	d.JUL_STATE_TAX, 
	d.JUL_COUNTY_TAX, 
	d.JUL_CITY_TAX, 
	d.JUL_SPOTS, 
	d.JUL_BILLING_AMT, 
	d.JUL_AR_INV_NBR, 
	d.JUL_AR_TYPE, 
	d.JUL_AR_INV_SEQ, 
	'JUL', 
	d.BRDCAST_YEAR, 
	d.BILLING_USER, 
	'TV', 
	g.JUL_GLACODE_CITY, 
	g.JUL_GLACODE_COS, 
	g.JUL_GLACODE_COUNTY, 
	g.JUL_GLACODE_SALES, 
	g.JUL_GLACODE_STATE, 
	g.JUL_GLACODE_WIP, 
	g.JUL_GLESEQ_CITY, 
	g.JUL_GLESEQ_COS, 
	g.JUL_GLESEQ_COUNTY, 
	g.JUL_GLESEQ_SALES, 
	g.JUL_GLESEQ_STATE, 
	g.JUL_GLESEQ_WIP, 
	g.JUL_GLEXACT, 
	g.JUL_GLEXACT_DEF, 
	d.RECONCILE_LINE, 
	d.DO_NOT_BILL, 
	NULL
FROM dbo.TV_DETAIL1 AS d 
INNER JOIN dbo.TV_GL AS g 
	ON (d.ORDER_NBR = g.ORDER_NBR) 
		AND (d.REV_NBR = g.REV_NBR) 
		AND (d.LINE_NBR = g.LINE_NBR) 
		AND (d.SEQ_NBR = g.SEQ_NBR) 
		AND (d.BRDCAST_YEAR = g.BRDCAST_YEAR)
WHERE ((d.JUL_LINE_NET <>0 Or d.JUL_DISCOUNT <>0 Or d.JUL_VENDOR_TAX <>0 Or d.JUL_BILLING_AMT <> 0) AND d.JUL_AR_INV_NBR IS NOT NULL)
		OR (d.RECONCILE_LINE = 1 AND d.DO_NOT_BILL = 1)

--August media amounts
INSERT INTO #Media_Amts
SELECT 
	d.ORDER_NBR, 
	d.LINE_NBR, 
	d.REV_NBR, 
	d.SEQ_NBR, 
	d.AUG_LINE_NET, 
	d.AUG_COMM_AMT, 
	d.AUG_REBATE_AMT, 
	d.AUG_DISCOUNT, 
	d.AUG_VENDOR_TAX, 
	d.AUG_STATE_TAX, 
	d.AUG_COUNTY_TAX, 
	d.AUG_CITY_TAX, 
	d.AUG_SPOTS, 
	d.AUG_BILLING_AMT, 
	d.AUG_AR_INV_NBR, 
	d.AUG_AR_TYPE, 
	d.AUG_AR_INV_SEQ, 
	'AUG', 
	d.BRDCAST_YEAR, 
	d.BILLING_USER, 
	'TV', 
	g.AUG_GLACODE_CITY, 
	g.AUG_GLACODE_COS, 
	g.AUG_GLACODE_COUNTY, 
	g.AUG_GLACODE_SALES, 
	g.AUG_GLACODE_STATE, 
	g.AUG_GLACODE_WIP, 
	g.AUG_GLESEQ_CITY, 
	g.AUG_GLESEQ_COS, 
	g.AUG_GLESEQ_COUNTY, 
	g.AUG_GLESEQ_SALES, 
	g.AUG_GLESEQ_STATE, 
	g.AUG_GLESEQ_WIP, 
	g.AUG_GLEXACT, 
	g.AUG_GLEXACT_DEF, 
	d.RECONCILE_LINE, 
	d.DO_NOT_BILL, 
	NULL
FROM dbo.TV_DETAIL1 AS d 
INNER JOIN dbo.TV_GL AS g 
	ON (d.ORDER_NBR = g.ORDER_NBR) 
		AND (d.REV_NBR = g.REV_NBR) 
		AND (d.LINE_NBR = g.LINE_NBR) 
		AND (d.SEQ_NBR = g.SEQ_NBR) 
		AND (d.BRDCAST_YEAR = g.BRDCAST_YEAR)
WHERE ((d.AUG_LINE_NET <>0 Or d.AUG_DISCOUNT <>0 Or d.AUG_VENDOR_TAX <>0 Or d.AUG_BILLING_AMT <> 0) AND d.AUG_AR_INV_NBR IS NOT NULL)
		OR (d.RECONCILE_LINE = 1 AND d.DO_NOT_BILL = 1)

--September media amounts
INSERT INTO #Media_Amts
SELECT 
	d.ORDER_NBR, 
	d.LINE_NBR, 
	d.REV_NBR, 
	d.SEQ_NBR, 
	d.SEP_LINE_NET, 
	d.SEP_COMM_AMT, 
	d.SEP_REBATE_AMT, 
	d.SEP_DISCOUNT, 
	d.SEP_VENDOR_TAX, 
	d.SEP_STATE_TAX, 
	d.SEP_COUNTY_TAX, 
	d.SEP_CITY_TAX, 
	d.SEP_SPOTS, 
	d.SEP_BILLING_AMT, 
	d.SEP_AR_INV_NBR, 
	d.SEP_AR_TYPE, 
	d.SEP_AR_INV_SEQ, 
	'SEP', 
	d.BRDCAST_YEAR, 
	d.BILLING_USER, 
	'TV', 
	g.SEP_GLACODE_CITY, 
	g.SEP_GLACODE_COS, 
	g.SEP_GLACODE_COUNTY, 
	g.SEP_GLACODE_SALES, 
	g.SEP_GLACODE_STATE, 
	g.SEP_GLACODE_WIP, 
	g.SEP_GLESEQ_CITY, 
	g.SEP_GLESEQ_COS, 
	g.SEP_GLESEQ_COUNTY, 
	g.SEP_GLESEQ_SALES, 
	g.SEP_GLESEQ_STATE, 
	g.SEP_GLESEQ_WIP, 
	g.SEP_GLEXACT, 
	g.SEP_GLEXACT_DEF, 
	d.RECONCILE_LINE, 
	d.DO_NOT_BILL, 
	NULL
FROM dbo.TV_DETAIL1 AS d 
INNER JOIN dbo.TV_GL AS g 
	ON (d.ORDER_NBR = g.ORDER_NBR) 
		AND (d.REV_NBR = g.REV_NBR) 
		AND (d.LINE_NBR = g.LINE_NBR) 
		AND (d.SEQ_NBR = g.SEQ_NBR) 
		AND (d.BRDCAST_YEAR = g.BRDCAST_YEAR)
WHERE ((d.SEP_LINE_NET <>0 Or d.SEP_DISCOUNT <>0 Or d.SEP_VENDOR_TAX <>0 Or d.SEP_BILLING_AMT <> 0) AND d.SEP_AR_INV_NBR IS NOT NULL)
		OR (d.RECONCILE_LINE = 1 AND d.DO_NOT_BILL = 1)

--October media amounts
INSERT INTO #Media_Amts
SELECT 
	d.ORDER_NBR, 
	d.LINE_NBR, 
	d.REV_NBR, 
	d.SEQ_NBR, 
	d.OCT_LINE_NET, 
	d.OCT_COMM_AMT, 
	d.OCT_REBATE_AMT, 
	d.OCT_DISCOUNT, 
	d.OCT_VENDOR_TAX, 
	d.OCT_STATE_TAX, 
	d.OCT_COUNTY_TAX, 
	d.OCT_CITY_TAX, 
	d.OCT_SPOTS, 
	d.OCT_BILLING_AMT, 
	d.OCT_AR_INV_NBR, 
	d.OCT_AR_TYPE, 
	d.OCT_AR_INV_SEQ, 
	'OCT', 
	d.BRDCAST_YEAR, 
	d.BILLING_USER, 
	'TV', 
	g.OCT_GLACODE_CITY, 
	g.OCT_GLACODE_COS, 
	g.OCT_GLACODE_COUNTY, 
	g.OCT_GLACODE_SALES, 
	g.OCT_GLACODE_STATE, 
	g.OCT_GLACODE_WIP, 
	g.OCT_GLESEQ_CITY, 
	g.OCT_GLESEQ_COS, 
	g.OCT_GLESEQ_COUNTY, 
	g.OCT_GLESEQ_SALES, 
	g.OCT_GLESEQ_STATE, 
	g.OCT_GLESEQ_WIP, 
	g.OCT_GLEXACT, 
	g.OCT_GLEXACT_DEF, 
	d.RECONCILE_LINE, 
	d.DO_NOT_BILL, 
	NULL
FROM dbo.TV_DETAIL1 AS d 
INNER JOIN dbo.TV_GL AS g 
	ON (d.ORDER_NBR = g.ORDER_NBR) 
		AND (d.REV_NBR = g.REV_NBR) 
		AND (d.LINE_NBR = g.LINE_NBR) 
		AND (d.SEQ_NBR = g.SEQ_NBR) 
		AND (d.BRDCAST_YEAR = g.BRDCAST_YEAR)
WHERE ((d.OCT_LINE_NET <>0 Or d.OCT_DISCOUNT <>0 Or d.OCT_VENDOR_TAX <>0 Or d.OCT_BILLING_AMT <> 0) AND d.OCT_AR_INV_NBR IS NOT NULL)
		OR (d.RECONCILE_LINE = 1 AND d.DO_NOT_BILL = 1)

--November media amounts
INSERT INTO #Media_Amts
SELECT 
	d.ORDER_NBR, 
	d.LINE_NBR, 
	d.REV_NBR, 
	d.SEQ_NBR, 
	d.NOV_LINE_NET, 
	d.NOV_COMM_AMT, 
	d.NOV_REBATE_AMT, 
	d.NOV_DISCOUNT, 
	d.NOV_VENDOR_TAX, 
	d.NOV_STATE_TAX, 
	d.NOV_COUNTY_TAX, 
	d.NOV_CITY_TAX, 
	d.NOV_SPOTS, 
	d.NOV_BILLING_AMT, 
	d.NOV_AR_INV_NBR, 
	d.NOV_AR_TYPE, 
	d.NOV_AR_INV_SEQ, 
	'NOV', 
	d.BRDCAST_YEAR, 
	d.BILLING_USER, 
	'TV', 
	g.NOV_GLACODE_CITY, 
	g.NOV_GLACODE_COS, 
	g.NOV_GLACODE_COUNTY, 
	g.NOV_GLACODE_SALES, 
	g.NOV_GLACODE_STATE, 
	g.NOV_GLACODE_WIP, 
	g.NOV_GLESEQ_CITY, 
	g.NOV_GLESEQ_COS, 
	g.NOV_GLESEQ_COUNTY, 
	g.NOV_GLESEQ_SALES, 
	g.NOV_GLESEQ_STATE, 
	g.NOV_GLESEQ_WIP, 
	g.NOV_GLEXACT, 
	g.NOV_GLEXACT_DEF, 
	d.RECONCILE_LINE, 
	d.DO_NOT_BILL, 
	NULL
FROM dbo.TV_DETAIL1 AS d 
INNER JOIN dbo.TV_GL AS g 
	ON (d.ORDER_NBR = g.ORDER_NBR) 
		AND (d.REV_NBR = g.REV_NBR) 
		AND (d.LINE_NBR = g.LINE_NBR) 
		AND (d.SEQ_NBR = g.SEQ_NBR) 
		AND (d.BRDCAST_YEAR = g.BRDCAST_YEAR)
WHERE ((d.NOV_LINE_NET <>0 Or d.NOV_DISCOUNT <>0 Or d.NOV_VENDOR_TAX <>0 Or d.NOV_BILLING_AMT <> 0) AND d.NOV_AR_INV_NBR IS NOT NULL)
		OR (d.RECONCILE_LINE = 1 AND d.DO_NOT_BILL = 1)

--December media amounts
INSERT INTO #Media_Amts
SELECT 
	d.ORDER_NBR, 
	d.LINE_NBR, 
	d.REV_NBR, 
	d.SEQ_NBR, 
	d.DEC_LINE_NET, 
	d.DEC_COMM_AMT, 
	d.DEC_REBATE_AMT, 
	d.DEC_DISCOUNT, 
	d.DEC_VENDOR_TAX, 
	d.DEC_STATE_TAX, 
	d.DEC_COUNTY_TAX, 
	d.DEC_CITY_TAX, 
	d.DEC_SPOTS, 
	d.DEC_BILLING_AMT, 
	d.DEC_AR_INV_NBR, 
	d.DEC_AR_TYPE, 
	d.DEC_AR_INV_SEQ, 
	'DEC', 
	d.BRDCAST_YEAR, 
	d.BILLING_USER, 
	'TV', 
	g.DEC_GLACODE_CITY, 
	g.DEC_GLACODE_COS, 
	g.DEC_GLACODE_COUNTY, 
	g.DEC_GLACODE_SALES, 
	g.DEC_GLACODE_STATE, 
	g.DEC_GLACODE_WIP, 
	g.DEC_GLESEQ_CITY, 
	g.DEC_GLESEQ_COS, 
	g.DEC_GLESEQ_COUNTY, 
	g.DEC_GLESEQ_SALES, 
	g.DEC_GLESEQ_STATE, 
	g.DEC_GLESEQ_WIP, 
	g.DEC_GLEXACT, 
	g.DEC_GLEXACT_DEF, 
	d.RECONCILE_LINE, 
	d.DO_NOT_BILL, 
	NULL
FROM dbo.TV_DETAIL1 AS d 
INNER JOIN dbo.TV_GL AS g 
	ON (d.ORDER_NBR = g.ORDER_NBR) 
		AND (d.REV_NBR = g.REV_NBR) 
		AND (d.LINE_NBR = g.LINE_NBR) 
		AND (d.SEQ_NBR = g.SEQ_NBR) 
		AND (d.BRDCAST_YEAR = g.BRDCAST_YEAR)
WHERE ((d.DEC_LINE_NET <>0 Or d.DEC_DISCOUNT <>0 Or d.DEC_VENDOR_TAX <>0 Or d.DEC_BILLING_AMT <> 0) AND d.DEC_AR_INV_NBR IS NOT NULL)
		OR (d.RECONCILE_LINE = 1 AND d.DO_NOT_BILL = 1)

--	=======================================================================	
--	BILLED AMOUNTS
--	=======================================================================	
--	BROADCAST =============================================================
--	Broadcast bill flag
CREATE TABLE #broadcast_bill_flag(
	[ORDER_NBR] int NOT NULL,
	[REV_NBR] smallint NOT NULL,
	[RECONCILE_FLAG] tinyint NULL,
	[BILL_TYPE_FLAG] tinyint NULL)

INSERT INTO #broadcast_bill_flag
SELECT h.ORDER_NBR,
	h.REV_NBR,
	ISNULL(h.RECONCILE_FLAG,0),
	ISNULL(h.BILL_TYPE_FLAG,0)
FROM dbo.RADIO_HEADER h
WHERE h.REV_NBR = (SELECT MAX(h2.REV_NBR) FROM dbo.RADIO_HEADER h2
	WHERE h.ORDER_NBR = h2.ORDER_NBR)

INSERT INTO #broadcast_bill_flag
SELECT h.ORDER_NBR,
	h.REV_NBR,
	ISNULL(h.RECONCILE_FLAG,0),
	ISNULL(h.BILL_TYPE_FLAG,0)
FROM dbo.TV_HEADER h
WHERE h.REV_NBR = (SELECT MAX(h2.REV_NBR) FROM dbo.TV_HEADER h2
	WHERE h.ORDER_NBR = h2.ORDER_NBR)

--	Broadcast media billed amounts
	INSERT INTO #MedAcc
	SELECT ma.ORDER_NBR,
		0,
		dbo.fn_month_abbr_nbr(ma.[MONTH]),
		ma.[YEAR],
		ISNULL(ma.LINE_DISC,0),
		0,
		ISNULL(ma.VENDOR_TAX,0),
		(ISNULL(ma.LINE_DISC,0) + ISNULL(ma.VENDOR_TAX,0) 
			+ ma.LINE_NET) * -1,
		ma.GLACODE_WIP,
		ma.GLEXACT,
		ma.GLESEQ_WIP,
		'BILLING',
		NULL,
		NULL,
		ma.AR_INV_NBR,
		ma.AR_INV_SEQ,
		ma.AR_TYPE,
		a.AR_POST_PERIOD
	FROM #Media_Amts ma
	JOIN #broadcast_bill_flag bf
		ON ma.ORDER_NBR = bf.ORDER_NBR
	JOIN V_AR_INVOICE_DATES a
		ON ma.AR_INV_NBR = a.AR_INV_NBR
		AND ma.AR_TYPE = a.AR_TYPE
	WHERE bf.BILL_TYPE_FLAG <> 1
		AND bf.RECONCILE_FLAG = 0

--	Broadcast media reconciled and not-billed amounts
	INSERT INTO #MedAcc
	SELECT ma.ORDER_NBR,
		0,
		dbo.fn_month_abbr_nbr(ma.[MONTH]),
		ma.[YEAR],
		ISNULL(ma.LINE_DISC,0),
		0,
		ISNULL(ma.VENDOR_TAX,0),
		(ISNULL(ma.LINE_DISC,0) + ISNULL(ma.VENDOR_TAX,0) + ISNULL(ma.LINE_NET,0)) * -1,	--JP 04/08/11
		ma.GLACODE_WIP,
		ma.GLEXACT,
		ma.GLESEQ_WIP,
		'RECONCILE',
		NULL,
		NULL,
		0,
		0,
		'IN',
		gl.GLEHPP
	FROM #Media_Amts ma
	JOIN dbo.GLENTHDR gl
		ON ma.GLEXACT = gl.GLEHXACT
	JOIN #broadcast_bill_flag bf
		ON ma.ORDER_NBR = bf.ORDER_NBR
	WHERE ma.RECONCILE_LINE = 1
		AND ma.DO_NOT_BILL = 1
		AND bf.RECONCILE_FLAG = 0

--	Radio net charges
	INSERT INTO #MedAcc
	SELECT d.ORDER_NBR,
		d.LINE_NBR,
		0,
		d.BRDCAST_YEAR,
		0,
		ISNULL(d.NETCHARGES,0),
		ISNULL(d.VENDOR_TAX_NC,0),
		(ISNULL(d.NETCHARGES,0) + ISNULL(d.VENDOR_TAX_NC,0)) * -1,		
		gl.NC_GLACODE_WIP,
		gl.NC_GLEXACT,
		gl.NC_GLESEQ_WIP,
		'BILLING',
		NULL,
		NULL,
		d.AR_INV_NBR,
		d.AR_INV_SEQ,
		d.AR_TYPE,
		a.AR_POST_PERIOD
	FROM dbo.RADIO_DETAIL1 d
	JOIN #broadcast_bill_flag bf
		ON d.ORDER_NBR = bf.ORDER_NBR
	JOIN V_AR_INVOICE_DATES a
		ON d.AR_INV_NBR = a.AR_INV_NBR
		AND d.AR_TYPE = a.AR_TYPE
	JOIN dbo.RADIO_GL gl
		ON d.ORDER_NBR = gl.ORDER_NBR
		AND d.LINE_NBR = gl.LINE_NBR
		AND d.REV_NBR = gl.REV_NBR
		AND d.SEQ_NBR = gl.SEQ_NBR
		AND d.BRDCAST_YEAR = gl.BRDCAST_YEAR
	WHERE bf.BILL_TYPE_FLAG <> 1 
		AND bf.RECONCILE_FLAG = 0
		AND ISNULL(d.NETCHARGES,0)<>0

--	TV net charges
	INSERT INTO #MedAcc
	SELECT d.ORDER_NBR,
		d.LINE_NBR,
		0,
		d.BRDCAST_YEAR,
		0,
		ISNULL(d.NETCHARGES,0),
		ISNULL(d.VENDOR_TAX_NC,0),
		(ISNULL(d.NETCHARGES,0) + ISNULL(d.VENDOR_TAX_NC,0)) * -1,		
		gl.NC_GLACODE_WIP,
		gl.NC_GLEXACT,
		gl.NC_GLESEQ_WIP,
		'BILLING',
		NULL,
		NULL,
		d.AR_INV_NBR,
		d.AR_INV_SEQ,
		d.AR_TYPE,
		a.AR_POST_PERIOD
	FROM dbo.TV_DETAIL1 d
	JOIN #broadcast_bill_flag bf
		ON d.ORDER_NBR = bf.ORDER_NBR
	JOIN V_AR_INVOICE_DATES a
		ON d.AR_INV_NBR = a.AR_INV_NBR
		AND d.AR_TYPE = a.AR_TYPE
	JOIN dbo.TV_GL gl
		ON d.ORDER_NBR = gl.ORDER_NBR
		AND d.LINE_NBR = gl.LINE_NBR
		AND d.REV_NBR = gl.REV_NBR
		AND d.SEQ_NBR = gl.SEQ_NBR
		AND d.BRDCAST_YEAR = gl.BRDCAST_YEAR
	WHERE bf.BILL_TYPE_FLAG <> 1 
		AND bf.RECONCILE_FLAG = 0
		AND ISNULL(d.NETCHARGES,0)<>0

--	MAGAZINE ===========================================================
--	Magazine dates for active rev
	CREATE TABLE #magazine_dates(
		[ORDER_NBR] int NOT NULL,
		[LINE_NBR] smallint NOT NULL,
		[REV_NBR] smallint NOT NULL,
		[SEQ_NBR] tinyint NOT NULL,
		[INSERT_DATE] smalldatetime NULL)

	INSERT INTO #magazine_dates
	SELECT d.ORDER_NBR,
		d.LINE_NBR,
		d.REV_NBR,
		d.SEQ_NBR,
		d.START_DATE
	FROM dbo.MAGAZINE_DETAIL d
	WHERE d.ACTIVE_REV = 1

--	Magazine media billed amounts
	INSERT INTO #MedAcc
	SELECT d.ORDER_NBR,
		d.LINE_NBR,
		MONTH(dt.[INSERT_DATE]),
		YEAR(dt.[INSERT_DATE]),
		ISNULL(d.DISCOUNT_AMT,0),
		ISNULL(d.NETCHARGE,0),
		ISNULL(d.NON_RESALE_AMT,0),
		(ISNULL(d.DISCOUNT_AMT,0) + ISNULL(d.NETCHARGE,0) + ISNULL(d.NON_RESALE_AMT,0) 
			+ ISNULL(d.EXT_NET_AMT,0)) * -1,
		d.GLACODE_WIP,
		d.GLEXACT,
		d.GLESEQ_WIP,
		'BILLING',
		NULL,
		NULL,
		d.AR_INV_NBR,
		ISNULL(d.AR_INV_SEQ,0),
		d.AR_TYPE,
		a.AR_POST_PERIOD
	FROM dbo.MAGAZINE_DETAIL d
	JOIN #magazine_dates dt
		ON d.ORDER_NBR = dt.ORDER_NBR
		AND d.LINE_NBR = dt.LINE_NBR
	JOIN V_AR_INVOICE_DATES a
		ON d.AR_INV_NBR = a.AR_INV_NBR
		AND d.AR_TYPE = a.AR_TYPE
	WHERE ISNULL(d.BILL_TYPE_FLAG,0) <> 1

--	NEWSPAPER ===========================================================
--	Newspaper dates for active rev
	CREATE TABLE #newspaper_dates(
		[ORDER_NBR] int NOT NULL,
		[LINE_NBR] smallint NOT NULL,
		[REV_NBR] smallint NOT NULL,
		[SEQ_NBR] tinyint NOT NULL,
		[INSERT_DATE] smalldatetime NULL)

	INSERT INTO #newspaper_dates
	SELECT d.ORDER_NBR,
		d.LINE_NBR,
		d.REV_NBR,
		d.SEQ_NBR,
		d.START_DATE
	FROM dbo.NEWSPAPER_DETAIL d
	WHERE d.ACTIVE_REV = 1	

--	Newspaper media billed amounts
	INSERT INTO #MedAcc
	SELECT d.ORDER_NBR,
		d.LINE_NBR,
		MONTH(dt.[INSERT_DATE]),
		YEAR(dt.[INSERT_DATE]),
		ISNULL(d.DISCOUNT_AMT,0),
		ISNULL(d.NETCHARGE,0),
		ISNULL(d.NON_RESALE_AMT,0),
		(ISNULL(d.DISCOUNT_AMT,0) + ISNULL(d.NETCHARGE,0) + ISNULL(d.NON_RESALE_AMT,0) 
			+ d.EXT_NET_AMT) * -1,
		d.GLACODE_WIP,
		d.GLEXACT,
		d.GLESEQ_WIP,
		'BILLING',
		NULL,
		NULL,
		d.AR_INV_NBR,
		ISNULL(d.AR_INV_SEQ,0),
		d.AR_TYPE,
		a.AR_POST_PERIOD
	FROM dbo.NEWSPAPER_DETAIL d
	JOIN #newspaper_dates dt
		ON d.ORDER_NBR = dt.ORDER_NBR
		AND d.LINE_NBR = dt.LINE_NBR
	JOIN V_AR_INVOICE_DATES a
		ON d.AR_INV_NBR = a.AR_INV_NBR
		AND d.AR_TYPE = a.AR_TYPE
	WHERE d.BILL_TYPE_FLAG <> 1

--	OUTDOOR ==========================================================
-- Outdoor dates for active rev 
	CREATE TABLE #outdoor_dates(
		[ORDER_NBR] int NOT NULL,
		[LINE_NBR] smallint NOT NULL,
		[REV_NBR] smallint NOT NULL,
		[SEQ_NBR] tinyint NOT NULL,
		[INSERT_DATE] smalldatetime NULL)

	INSERT INTO #outdoor_dates
	SELECT d.ORDER_NBR,
		d.LINE_NBR,
		d.REV_NBR,
		d.SEQ_NBR,
		d.POST_DATE
	FROM dbo.OUTDOOR_DETAIL d
	WHERE d.ACTIVE_REV = 1	

--	Outdoor media billed amounts
	INSERT INTO #MedAcc
	SELECT d.ORDER_NBR,
		d.LINE_NBR,
		MONTH(dt.[INSERT_DATE]),
		YEAR(dt.[INSERT_DATE]),
		ISNULL(d.DISCOUNT_AMT,0),
		ISNULL(d.NETCHARGE,0),
		ISNULL(d.NON_RESALE_AMT,0),
		(ISNULL(d.DISCOUNT_AMT,0) + ISNULL(d.NETCHARGE,0) + ISNULL(d.NON_RESALE_AMT,0) 
			+ d.EXT_NET_AMT) * -1,
		d.GLACODE_WIP,
		d.GLEXACT,
		d.GLESEQ_WIP,
		'BILLING',
		NULL,
		NULL,
		d.AR_INV_NBR,
		ISNULL(d.AR_INV_SEQ,0),
		d.AR_TYPE,
		a.AR_POST_PERIOD
	FROM dbo.OUTDOOR_DETAIL d
	JOIN #outdoor_dates dt
		ON d.ORDER_NBR = dt.ORDER_NBR
		AND d.LINE_NBR = dt.LINE_NBR
	JOIN V_AR_INVOICE_DATES a
		ON d.AR_INV_NBR = a.AR_INV_NBR
		AND d.AR_TYPE = a.AR_TYPE
	WHERE d.BILL_TYPE_FLAG <> 1

--	INTERNET ===========================================================
--	Internet dates for active rev
	CREATE TABLE #internet_dates(
		[ORDER_NBR] int NOT NULL,
		[LINE_NBR] smallint NOT NULL,
		[REV_NBR] smallint NOT NULL,
		[SEQ_NBR] tinyint NOT NULL,
		[INSERT_DATE] smalldatetime NULL)

	INSERT INTO #internet_dates
	SELECT d.ORDER_NBR,
		d.LINE_NBR,
		d.REV_NBR,
		d.SEQ_NBR,
		d.START_DATE
	FROM dbo.INTERNET_DETAIL d
	WHERE d.ACTIVE_REV = 1	

--	Internet media billed amounts
	INSERT INTO #MedAcc
	SELECT d.ORDER_NBR,
		d.LINE_NBR,
		MONTH(dt.[INSERT_DATE]),
		YEAR(dt.[INSERT_DATE]),
		ISNULL(d.DISCOUNT_AMT,0),
		ISNULL(d.NETCHARGE,0),
		ISNULL(d.NON_RESALE_AMT,0),
		(ISNULL(d.DISCOUNT_AMT,0) + ISNULL(d.NETCHARGE,0) + ISNULL(d.NON_RESALE_AMT,0) 
			+ d.EXT_NET_AMT) * -1,
		d.GLACODE_WIP,
		d.GLEXACT,
		d.GLESEQ_WIP,
		'BILLING',
		NULL,
		NULL,
		d.AR_INV_NBR,
		ISNULL(d.AR_INV_SEQ,0),
		d.AR_TYPE,
		a.AR_POST_PERIOD
	FROM dbo.INTERNET_DETAIL d
	JOIN #internet_dates dt
		ON d.ORDER_NBR = dt.ORDER_NBR
		AND d.LINE_NBR = dt.LINE_NBR
	JOIN V_AR_INVOICE_DATES a
		ON d.AR_INV_NBR = a.AR_INV_NBR
		AND d.AR_TYPE = a.AR_TYPE
	WHERE d.BILL_TYPE_FLAG <> 1

--	NEWS ===========================================================
--	News maximum sequence number
	CREATE TABLE #news_max_seq(
		[ORDER_NBR] int NOT NULL,
		[LINE_NBR] smallint NOT NULL,
		[REV_NBR] tinyint NOT NULL,
		[SEQ_NBR] tinyint NOT NULL)

	INSERT INTO #news_max_seq
	SELECT d.ORDER_NBR,
		d.LINE_NBR,
		d.REV_NBR,
		MAX(d.SEQ_NBR)
	FROM dbo.NEWS_DETAIL d
	WHERE d.REV_NBR = (SELECT MAX(d2.REV_NBR) FROM dbo.NEWS_DETAIL d2
		WHERE d.ORDER_NBR = d2.ORDER_NBR
		AND d.LINE_NBR = d2.LINE_NBR)
	GROUP BY d.ORDER_NBR, d.LINE_NBR, d.REV_NBR 

--	News dates for max sequence
	CREATE TABLE #news_dates(
		[ORDER_NBR] int NOT NULL,
		[LINE_NBR] smallint NOT NULL,
		[REV_NBR] tinyint NOT NULL,
		[SEQ_NBR] tinyint NOT NULL,
		[INSERT_DATE] smalldatetime NULL)

	INSERT INTO #news_dates
	SELECT ms.ORDER_NBR,
		ms.LINE_NBR,
		ms.REV_NBR,
		ms.SEQ_NBR,
		d.INSERT_DATE
	FROM #news_max_seq ms
	JOIN dbo.NEWS_DETAIL d
		ON ms.ORDER_NBR = d.ORDER_NBR
		AND ms.LINE_NBR = d.LINE_NBR
		AND ms.REV_NBR = d.REV_NBR
		AND ms.SEQ_NBR = d.SEQ_NBR	
		
--	News media billed amounts
	INSERT INTO #MedAcc
	SELECT ba.ORDER_NBR,
		ba.LINE_NBR,
		MONTH(dt.[INSERT_DATE]),
		YEAR(dt.[INSERT_DATE]),
		ISNULL(ba.LINE_DISC,0),
		ISNULL(ba.NETCHARGES,0),
		ISNULL(ba.VENDOR_TAX,0),
		(ISNULL(ba.LINE_DISC,0) + ISNULL(ba.NETCHARGES,0) + ISNULL(ba.VENDOR_TAX,0)
			+ ba.LINE_NET) * -1,
		ba.GLACODE_WIP,
		ba.GLEXACT,
		ba.GLESEQ_WIP,
		'BILLING',
		NULL,
		NULL,
		ba.AR_INV_NBR,
		ISNULL(ba.AR_INV_SEQ,0),
		ba.AR_TYPE,
		a.AR_POST_PERIOD
	FROM dbo.MEDIA_BILL_AMTS ba
	JOIN #news_dates dt
		ON ba.ORDER_NBR = dt.ORDER_NBR
		AND ba.LINE_NBR = dt.LINE_NBR
	JOIN V_AR_INVOICE_DATES a
		ON ba.AR_INV_NBR = a.AR_INV_NBR
		AND ba.AR_TYPE = a.AR_TYPE
	WHERE ba.BILL_COMM_NET <> 1
		AND ba.MEDIA_TYPE = 'NEWS'
		AND ISNULL(ba.AR_INV_SEQ, 0) <> 99

--	MAG ===========================================================
--	Mag maximum sequence number
	CREATE TABLE #mag_max_seq(
		[ORDER_NBR] int NOT NULL,
		[LINE_NBR] smallint NOT NULL,
		[REV_NBR] tinyint NOT NULL,
		[SEQ_NBR] tinyint NOT NULL)

	INSERT INTO #mag_max_seq
	SELECT d.ORDER_NBR,
		d.LINE_NBR,
		d.REV_NBR,
		MAX(d.SEQ_NBR)
	FROM dbo.MAG_DETAIL d
	WHERE d.REV_NBR = (SELECT MAX(d2.REV_NBR) FROM dbo.MAG_DETAIL d2
		WHERE d.ORDER_NBR = d2.ORDER_NBR
		AND d.LINE_NBR = d2.LINE_NBR) 
	GROUP BY d.ORDER_NBR, d.LINE_NBR, d.REV_NBR

--	Mag dates for max sequence
	CREATE TABLE #mag_dates(
		[ORDER_NBR] int NOT NULL,
		[LINE_NBR] smallint NOT NULL,
		[REV_NBR] tinyint NOT NULL,
		[SEQ_NBR] tinyint NOT NULL,
		[INSERT_DATE] smalldatetime NULL)

	INSERT INTO #mag_dates
	SELECT ms.ORDER_NBR,
		ms.LINE_NBR,
		ms.REV_NBR,
		ms.SEQ_NBR,
		d.INSERT_DATE
	FROM #mag_max_seq ms
	JOIN dbo.MAG_DETAIL d
		ON ms.ORDER_NBR = d.ORDER_NBR
		AND ms.LINE_NBR = d.LINE_NBR
		AND ms.REV_NBR = d.REV_NBR
		AND ms.SEQ_NBR = d.SEQ_NBR

--	Mag media billed amounts
	INSERT INTO #MedAcc
	SELECT ba.ORDER_NBR,
		ba.LINE_NBR,
		MONTH(dt.[INSERT_DATE]),
		YEAR(dt.[INSERT_DATE]),
		ISNULL(ba.LINE_DISC,0),
		ISNULL(ba.NETCHARGES,0),
		ISNULL(ba.VENDOR_TAX,0),
		(ISNULL(ba.LINE_DISC,0) + ISNULL(ba.NETCHARGES,0) + ISNULL(ba.VENDOR_TAX,0)
			+ ba.LINE_NET) * -1,
		ba.GLACODE_WIP,
		ba.GLEXACT,
		ba.GLESEQ_WIP,
		'BILLING',
		NULL,
		NULL,
		ba.AR_INV_NBR,
		ISNULL(ba.AR_INV_SEQ,0),
		ba.AR_TYPE,
		a.AR_POST_PERIOD
	FROM dbo.MEDIA_BILL_AMTS ba
	JOIN #mag_dates dt
		ON ba.ORDER_NBR = dt.ORDER_NBR
		AND ba.LINE_NBR = dt.LINE_NBR
	JOIN V_AR_INVOICE_DATES a
		ON ba.AR_INV_NBR = a.AR_INV_NBR
		AND ba.AR_TYPE = a.AR_TYPE
	WHERE ba.BILL_COMM_NET <> 1
		AND ba.MEDIA_TYPE = 'MAG'
		AND ISNULL(ba.AR_INV_SEQ, 0) <> 99

--	=======================================================================	
--	ACCOUNTS PAYABLE
--	=====================================================================

--	Radio AP ===============================================================
	INSERT INTO #MedAcc
	SELECT ap.ORDER_NBR,
		NULL,
		dbo.fn_month_abbr_nbr(ap.BRDCAST_MONTH),
		ap.BRDCAST_YEAR,
		ISNULL(ap.DISC_AMT,0),
		ISNULL(ap.NETCHARGES,0),
		ISNULL(ap.VENDOR_TAX,0),
		ISNULL(ap.DISC_AMT,0) + ISNULL(ap.NETCHARGES,0) + ISNULL(ap.VENDOR_TAX,0)
			+ ISNULL(EXT_NET_AMT,0),
		ap.GLACODE,
		ap.GLEXACT,
		ap.GLESEQ,
		'AP',
		ah.VN_FRL_EMP_CODE,
		ah.AP_INV_VCHR,
		NULL,
		NULL,
		NULL,
		ap.POST_PERIOD
	FROM dbo.AP_RADIO ap
	JOIN dbo.AP_HEADER ah
		ON ap.AP_ID = ah.AP_ID
		AND ap.AP_SEQ = ah.AP_SEQ
	WHERE ISNULL(ap.RECONCILE_FLAG,0) = 0

--	TV AP ===============================================================
	INSERT INTO #MedAcc
	SELECT ap.ORDER_NBR,
		NULL,
		dbo.fn_month_abbr_nbr(ap.BRDCAST_MONTH),
		ap.BRDCAST_YEAR,
		ISNULL(ap.DISC_AMT,0),
		ISNULL(ap.NETCHARGES,0),
		ISNULL(ap.VENDOR_TAX,0),
		ISNULL(ap.DISC_AMT,0) + ISNULL(ap.NETCHARGES,0) + ISNULL(ap.VENDOR_TAX,0)
			+ ISNULL(EXT_NET_AMT,0),
		ap.GLACODE,
		ap.GLEXACT,
		ap.GLESEQ,
		'AP',
		ah.VN_FRL_EMP_CODE,
		ah.AP_INV_VCHR,
		NULL,
		NULL,
		NULL,
		ap.POST_PERIOD
	FROM dbo.AP_TV ap
	JOIN dbo.AP_HEADER ah
		ON ap.AP_ID = ah.AP_ID
		AND ap.AP_SEQ = ah.AP_SEQ
	WHERE ISNULL(ap.RECONCILE_FLAG,0) = 0

--	Magazine AP ===============================================================
	INSERT INTO #MedAcc
	SELECT ap.ORDER_NBR,
		ap.ORDER_LINE_NBR,
		MONTH(dt.INSERT_DATE),
		YEAR(dt.INSERT_DATE),
		ISNULL(ap.DISCOUNT_LN,0) + ISNULL(ap.DISCOUNT_NC,0),
		ISNULL(ap.NETCHARGES,0),
		ISNULL(ap.VENDOR_TAX,0),
		ISNULL(ap.DISBURSED_AMT,0),
		ap.GLACODE,
		ap.GLEXACT,
		ap.GLESEQ,
		'AP',
		ah.VN_FRL_EMP_CODE,
		ah.AP_INV_VCHR,
		NULL,
		NULL,
		NULL,
		ap.POST_PERIOD
	FROM dbo.AP_MAGAZINE ap
	JOIN dbo.AP_HEADER ah
		ON ap.AP_ID = ah.AP_ID
		AND ap.AP_SEQ = ah.AP_SEQ
	JOIN #magazine_dates dt
		ON ap.ORDER_NBR = dt.ORDER_NBR
		AND ap.ORDER_LINE_NBR = dt.LINE_NBR

--	Newspaper AP ===============================================================
	INSERT INTO #MedAcc
	SELECT ap.ORDER_NBR,
		ap.ORDER_LINE_NBR,
		MONTH(dt.INSERT_DATE),
		YEAR(dt.INSERT_DATE),
		ISNULL(ap.DISCOUNT_LN,0) + ISNULL(ap.DISCOUNT_NC,0),
		ISNULL(ap.NETCHARGES,0),
		ISNULL(ap.VENDOR_TAX,0),
		ISNULL(ap.DISBURSED_AMT,0),
		ap.GLACODE,
		ap.GLEXACT,
		ap.GLESEQ,
		'AP',
		ah.VN_FRL_EMP_CODE,
		ah.AP_INV_VCHR,
		NULL,
		NULL,
		NULL,
		ap.POST_PERIOD
	FROM dbo.AP_NEWSPAPER ap
	JOIN dbo.AP_HEADER ah
		ON ap.AP_ID = ah.AP_ID
		AND ap.AP_SEQ = ah.AP_SEQ
	JOIN #newspaper_dates dt
		ON ap.ORDER_NBR = dt.ORDER_NBR
		AND ap.ORDER_LINE_NBR = dt.LINE_NBR

--	Outdoor AP ===============================================================
	INSERT INTO #MedAcc
	SELECT ap.ORDER_NBR,
		ap.ORDER_LINE_NBR,
		MONTH(dt.INSERT_DATE),
		YEAR(dt.INSERT_DATE),
		ISNULL(ap.DISCOUNT_AMT,0),
		ISNULL(ap.NETCHARGES,0),
		ISNULL(ap.VENDOR_TAX,0),
		ISNULL(ap.DISCOUNT_AMT,0) + ISNULL(ap.NETCHARGES,0) + ISNULL(ap.VENDOR_TAX,0)
			+ ISNULL(ap.NET_AMT,0),
		ap.GLACODE,
		ap.GLEXACT,
		ap.GLESEQ,
		'AP',
		ah.VN_FRL_EMP_CODE,
		ah.AP_INV_VCHR,
		NULL,
		NULL,
		NULL,
		ap.POST_PERIOD
	FROM dbo.AP_OUTDOOR ap
	JOIN dbo.AP_HEADER ah
		ON ap.AP_ID = ah.AP_ID
		AND ap.AP_SEQ = ah.AP_SEQ
	JOIN #outdoor_dates dt
		ON ap.ORDER_NBR = dt.ORDER_NBR
		AND ap.ORDER_LINE_NBR = dt.LINE_NBR

--	Internet AP ===============================================================
	INSERT INTO #MedAcc
	SELECT ap.ORDER_NBR,
		ap.ORDER_LINE_NBR,
		MONTH(dt.INSERT_DATE),
		YEAR(dt.INSERT_DATE),
		ISNULL(ap.DISCOUNT_AMT,0),
		ISNULL(ap.NETCHARGES,0),
		ISNULL(ap.VENDOR_TAX,0),
		ISNULL(ap.DISCOUNT_AMT,0) + ISNULL(ap.NETCHARGES,0) + ISNULL(ap.VENDOR_TAX,0)
			+ ISNULL(ap.NET_AMT,0),
		ap.GLACODE,
		ap.GLEXACT,
		ap.GLESEQ,
		'AP',
		ah.VN_FRL_EMP_CODE,
		ah.AP_INV_VCHR,
		NULL,
		NULL,
		NULL,
		ap.POST_PERIOD
	FROM dbo.AP_INTERNET ap
	JOIN dbo.AP_HEADER ah
		ON ap.AP_ID = ah.AP_ID
		AND ap.AP_SEQ = ah.AP_SEQ
	JOIN #internet_dates dt
		ON ap.ORDER_NBR = dt.ORDER_NBR
		AND ap.ORDER_LINE_NBR = dt.LINE_NBR

--	Mag AP ===============================================================
	INSERT INTO #MedAcc
	SELECT ap.ORDER_NBR,
		ap.ORDER_LINE_NBR,
		MONTH(dt.INSERT_DATE),
		YEAR(dt.INSERT_DATE),
		ISNULL(ap.DISCOUNT_LN,0) + ISNULL(ap.DISCOUNT_NC,0),
		ISNULL(ap.NETCHARGES,0),
		ISNULL(ap.VENDOR_TAX,0),
		ISNULL(ap.DISBURSED_AMT,0),
		ap.GLACODE,
		ap.GLEXACT,
		ap.GLESEQ,
		'AP',
		ah.VN_FRL_EMP_CODE,
		ah.AP_INV_VCHR,
		NULL,
		NULL,
		NULL,
		ap.POST_PERIOD
	FROM dbo.AP_MAGAZINE ap
	JOIN dbo.AP_HEADER ah
		ON ap.AP_ID = ah.AP_ID
		AND ap.AP_SEQ = ah.AP_SEQ
	JOIN #mag_dates dt
		ON ap.ORDER_NBR = dt.ORDER_NBR
		AND ap.ORDER_LINE_NBR = dt.LINE_NBR

--	News AP ===============================================================
	INSERT INTO #MedAcc
	SELECT ap.ORDER_NBR,
		ap.ORDER_LINE_NBR,
		MONTH(dt.INSERT_DATE),
		YEAR(dt.INSERT_DATE),
		ISNULL(ap.DISCOUNT_LN,0) + ISNULL(ap.DISCOUNT_NC,0),
		ISNULL(ap.NETCHARGES,0),
		ISNULL(ap.VENDOR_TAX,0),
		ISNULL(ap.DISBURSED_AMT,0),
		ap.GLACODE,
		ap.GLEXACT,
		ap.GLESEQ,
		'AP',
		ah.VN_FRL_EMP_CODE,
		ah.AP_INV_VCHR,
		NULL,
		NULL,
		NULL,
		ap.POST_PERIOD
	FROM dbo.AP_NEWSPAPER ap
	JOIN dbo.AP_HEADER ah
		ON ap.AP_ID = ah.AP_ID
		AND ap.AP_SEQ = ah.AP_SEQ
	JOIN #news_dates dt
		ON ap.ORDER_NBR = dt.ORDER_NBR
		AND ap.ORDER_LINE_NBR = dt.LINE_NBR

END
	SELECT * FROM #MedAcc
GO

IF ( @@ERROR = 0 )
	GRANT ALL ON [sp_media_med_acc] TO PUBLIC AS dbo
GO	