


























--Timesheet
CREATE PROCEDURE [dbo].[usp_PopulateTime] 
@EmpCode VarChar(6),
@EmpDate DateTime
AS

SET NOCOUNT ON

SELECT     EMP_TIME.ET_ID, EMP_TIME_DTL.ET_DTL_ID, EMP_TIME_DTL.FNC_CODE, SUM(EMP_TIME_DTL.EMP_HOURS) AS EMP_HOURS, JOB_LOG.CL_CODE, JOB_LOG.DIV_CODE, 
                      JOB_LOG.PRD_CODE, EMP_TIME_DTL.JOB_NUMBER, JOB_LOG.JOB_CLI_REF, EMP_TIME_DTL.JOB_COMPONENT_NBR, 
                      EMP_TIME_DTL.DP_TM_CODE, 'D' as TIME_TYPE, JOB_LOG.JOB_DESC,

'EDIT_FLAG' = 
	Case
		When EMP_TIME_DTL.AR_INV_NBR IS NOT NULL Then 1
		When Count(EMP_TIME_DTL.ET_DTL_ID) > 1 Then 2
		When EMP_TIME_DTL.AB_FLAG IN (1,3) Then 3
		When EMP_TIME_DTL.BILLING_USER IS NOT NULL Then 4
		Else 0
	End,
	MAX(EMP_TIME_DTL.SEQ_NBR) AS MAX_SEQ
FROM         EMP_TIME INNER JOIN
                      EMP_TIME_DTL ON EMP_TIME.ET_ID = EMP_TIME_DTL.ET_ID INNER JOIN
                      JOB_LOG ON EMP_TIME_DTL.JOB_NUMBER = JOB_LOG.JOB_NUMBER
WHERE     (EMP_TIME.EMP_CODE = @EmpCode) AND (EMP_TIME.EMP_DATE = @EmpDate)
GROUP BY EMP_TIME.ET_ID, EMP_TIME_DTL.ET_DTL_ID, EMP_TIME_DTL.FNC_CODE, JOB_LOG.CL_CODE, JOB_LOG.DIV_CODE, JOB_LOG.PRD_CODE, JOB_LOG.JOB_CLI_REF, 
EMP_TIME_DTL.JOB_NUMBER, EMP_TIME_DTL.JOB_COMPONENT_NBR, EMP_TIME_DTL.DP_TM_CODE, EMP_TIME_DTL.AR_INV_NBR, EMP_TIME_DTL.AB_FLAG, EMP_TIME_DTL.BILLING_USER, JOB_LOG.JOB_DESC

UNION

SELECT     EMP_TIME_NP.ET_ID, EMP_TIME_NP.ET_DTL_ID, EMP_TIME_NP.CATEGORY AS FNC_CAT, SUM(EMP_TIME_NP.EMP_HOURS) 
                      AS EMP_HOURS, NULL AS CL_CODE, NULL AS DIV_CODE, NULL AS PRD_CODE, NULL AS JOB_NUMBER, NULL AS CLIENT_REF, NULL 
                      AS JOB_COMPONENT, EMP_TIME_NP.DP_TM_CODE, 'N' AS TIME_TYPE, NULL AS JOB_DESC, 0 as EDIT_FLAG, NULL AS MAX_SEQ
FROM         EMP_TIME INNER JOIN
                      EMP_TIME_NP ON EMP_TIME.ET_ID = EMP_TIME_NP.ET_ID
WHERE     (EMP_TIME.EMP_CODE = @EmpCode) AND (EMP_TIME.EMP_DATE = @EmpDate)

GROUP BY EMP_TIME_NP.ET_ID, EMP_TIME_NP.ET_DTL_ID, EMP_TIME_NP.CATEGORY, EMP_TIME_NP.DP_TM_CODE

























