SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS OFF 
GO
IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[usp_cp_GetTheme]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[usp_cp_GetTheme]
GO
CREATE PROCEDURE [dbo].[usp_cp_GetTheme] /*WITH ENCRYPTION*/
@CL_CODE VARCHAR(6)
AS
/*=========== QUERY ===========*/
	IF @CL_CODE = ''
	BEGIN
		SET @CL_CODE = NULL;
	END
	IF NOT EXISTS (SELECT CL_CODE FROM CLIENT WITH(NOLOCK) WHERE CL_CODE = @CL_CODE)
	BEGIN
		SET @CL_CODE = NULL;
	END

	DECLARE
		@WV_BRND_ENABLE BIT ,
		@WV_BRND_BG_TYPE TINYINT,
		@WV_BRND_BG VARCHAR(500) ,
		@WV_BRND_BGCLR VARCHAR(50),
		@WV_BRND_CLK_APP BIT ,
		@WV_BRND_CLK_USR BIT,
		@WV_BRND_FLT_DTO BIT ,
		@WV_BRND_ICON VARCHAR(500) ,
		@WV_BRND_LOGO VARCHAR(500),
		@WV_BRND_SHRT_MNU BIT,
		@WV_BRND_USR_BG BIT ,
		@WV_BRND_USR_THM BIT, 
		@WV_BRND_THEME VARCHAR(50),
		@WV_BRND_WKSPCLR VARCHAR(50),
		@WV_BRND_SBCLR VARCHAR(50),
		@WV_BRND_ICON_STYLE TINYINT,
		
		@HAS_CLIENT_REC BIT,
		@HAS_DEFAULT_REC BIT
		
	SET @HAS_CLIENT_REC = 0;
	SET @HAS_DEFAULT_REC = 0;	

	IF EXISTS (SELECT CL_CODE FROM CP_THEME_SETTINGS WITH(NOLOCK) WHERE CL_CODE IS NULL)
	BEGIN
		SET @HAS_DEFAULT_REC = 1;
	END
	IF NOT @CL_CODE IS NULL
	BEGIN
		IF EXISTS (SELECT CL_CODE FROM CP_THEME_SETTINGS WITH(NOLOCK) WHERE CL_CODE = @CL_CODE)
		BEGIN
			SET @HAS_CLIENT_REC = 1;
		END
	END
	
	--ADD DEFAULT IF DOESN'T EXIST	
	IF @HAS_DEFAULT_REC = 0
	BEGIN
		INSERT INTO CP_THEME_SETTINGS (CL_CODE,
									   WV_BRND_ENABLE, 
									   WV_BRND_BG_TYPE,
									   WV_BRND_BG,
									   WV_BRND_BGCLR,
									   WV_BRND_CLK_APP,
									   WV_BRND_CLK_USR,
									   WV_BRND_FLT_DTO,
									   WV_BRND_ICON,
									   WV_BRND_LOGO,
									   WV_BRND_SHRT_MNU,
									   WV_BRND_USR_BG,
									   WV_BRND_USR_THM,
									   WV_BRND_THEME,
									   WV_BRND_WKSPCLR,
									   WV_BRND_SBCLR,
									   WV_BRND_ICON_STYLE)
								VALUES(NULL,
									   1,
									   1,
									   'heart_twir.jpg',
									   NULL,
									   0,
									   1,
									   1,
									   'Window_Icon.png',
									   'SignIn_Header.png',
									   0,
									   0,
									   0,
									   'Office2007',
									   '#0097A7',
									   '#00BCD4',
									   1);
	   
	   									   
	END
	
	--GET DEFAULT INTO VARS
	SELECT     
		@WV_BRND_ENABLE = WV_BRND_ENABLE, 
		@WV_BRND_BG_TYPE = WV_BRND_BG_TYPE, 
		@WV_BRND_BG = WV_BRND_BG, 
		@WV_BRND_BGCLR = WV_BRND_BGCLR, 
		@WV_BRND_CLK_APP = WV_BRND_CLK_APP, 
		@WV_BRND_CLK_USR = WV_BRND_CLK_USR, 
		@WV_BRND_FLT_DTO = WV_BRND_FLT_DTO, 
		@WV_BRND_ICON = WV_BRND_ICON, 
		@WV_BRND_LOGO = WV_BRND_LOGO, 
		@WV_BRND_SHRT_MNU = WV_BRND_SHRT_MNU, 
		@WV_BRND_USR_BG = WV_BRND_USR_BG, 
		@WV_BRND_USR_THM = WV_BRND_USR_THM, 
		@WV_BRND_THEME = WV_BRND_THEME,
		@WV_BRND_WKSPCLR = WV_BRND_WKSPCLR,
		@WV_BRND_SBCLR = WV_BRND_SBCLR,
		@WV_BRND_ICON_STYLE = WV_BRND_ICON_STYLE
	FROM         
		CP_THEME_SETTINGS WITH(NOLOCK)
	WHERE
		CL_CODE IS NULL;		
	
	--MAKE SURE DATA OK	
	SET @WV_BRND_ENABLE = ISNULL(@WV_BRND_ENABLE, 1);
	SET @WV_BRND_BG_TYPE = ISNULL(@WV_BRND_BG_TYPE, 1);
	SET @WV_BRND_BG = ISNULL(@WV_BRND_BG, 'heart_twir.jpg') ;
	SET @WV_BRND_BGCLR = ISNULL(@WV_BRND_BGCLR, '') ;
	SET @WV_BRND_CLK_APP = ISNULL(@WV_BRND_CLK_APP, 0) ;
	SET @WV_BRND_CLK_USR = ISNULL(@WV_BRND_CLK_USR, 1);
	SET @WV_BRND_FLT_DTO = ISNULL(@WV_BRND_FLT_DTO, 1);
	SET @WV_BRND_ICON = ISNULL(@WV_BRND_ICON, 'Window_Icon.png');
	SET @WV_BRND_LOGO = ISNULL(@WV_BRND_LOGO, 'SignIn_Header.png') ;
	SET @WV_BRND_SHRT_MNU = ISNULL(@WV_BRND_SHRT_MNU, 0); 
	SET @WV_BRND_USR_BG = ISNULL(@WV_BRND_USR_BG, 0);
	SET @WV_BRND_USR_THM = ISNULL(@WV_BRND_USR_THM, 0) ;
	SET @WV_BRND_THEME = ISNULL(@WV_BRND_THEME, 'Office2007') ;
	SET @WV_BRND_WKSPCLR = ISNULL(@WV_BRND_WKSPCLR, '#0097A7') ;
	SET @WV_BRND_SBCLR = ISNULL(@WV_BRND_SBCLR, '#00BCD4') ;
	SET @WV_BRND_ICON_STYLE = ISNULL(@WV_BRND_ICON_STYLE, 1);
	
	--INSERT DEFAULT INTO CLIENT IF DOESN'T EXIST
	IF NOT @CL_CODE IS NULL AND @HAS_CLIENT_REC = 0
	BEGIN

		INSERT INTO CP_THEME_SETTINGS WITH(ROWLOCK) (
									   CL_CODE,
									   WV_BRND_ENABLE, 
									   WV_BRND_BG_TYPE,
									   WV_BRND_BG,
									   WV_BRND_BGCLR,
									   WV_BRND_CLK_APP,
									   WV_BRND_CLK_USR,
									   WV_BRND_FLT_DTO,
									   WV_BRND_ICON,
									   WV_BRND_LOGO,
									   WV_BRND_SHRT_MNU,
									   WV_BRND_USR_BG,
									   WV_BRND_USR_THM,
									   WV_BRND_THEME,
									   WV_BRND_WKSPCLR,
									   WV_BRND_SBCLR,
									   WV_BRND_ICON_STYLE)
								VALUES(@CL_CODE,
									   @WV_BRND_ENABLE,
									   @WV_BRND_BG_TYPE,
									   @WV_BRND_BG,
									   @WV_BRND_BGCLR,
									   @WV_BRND_CLK_APP,
									   @WV_BRND_CLK_USR,
									   @WV_BRND_FLT_DTO,
									   @WV_BRND_ICON_STYLE,
									   @WV_BRND_LOGO,
									   @WV_BRND_SHRT_MNU,
									   @WV_BRND_USR_BG,
									   @WV_BRND_USR_THM,
									   @WV_BRND_THEME,
									   @WV_BRND_WKSPCLR,
									   @WV_BRND_SBCLR,
									   @WV_BRND_ICON_STYLE
									   );
		
	END	
	
	DECLARE
		@DFLT_CP_LOGO VARCHAR(500),
		@DFLT_CP_BG VARCHAR(500)
		
	SELECT @DFLT_CP_LOGO = WV_BRND_LOGO, @DFLT_CP_BG = WV_BRND_BG
	FROM CP_THEME_SETTINGS WITH(NOLOCK) 	
	WHERE CL_CODE IS NULL;
		
	IF @CL_CODE IS NULL
	BEGIN
		SELECT     
			ISNULL(CP_THEME_ID, 0) AS CP_THEME_ID, 
			CL_CODE, 
			0 AS WV_BRND_ENABLE, 
			ISNULL(WV_BRND_BG_TYPE, @WV_BRND_BG_TYPE) AS WV_BRND_BG_TYPE, 
			ISNULL(WV_BRND_BG, @WV_BRND_BG) AS WV_BRND_BG, 
			ISNULL(WV_BRND_BGCLR, @WV_BRND_BGCLR) AS WV_BRND_BGCLR, 
			ISNULL(WV_BRND_CLK_APP, @WV_BRND_CLK_APP) AS WV_BRND_CLK_APP, 
			ISNULL(WV_BRND_CLK_USR, @WV_BRND_CLK_USR) AS WV_BRND_CLK_USR, 
			ISNULL(WV_BRND_FLT_DTO, @WV_BRND_FLT_DTO) AS WV_BRND_FLT_DTO, 
			ISNULL(WV_BRND_ICON, @WV_BRND_ICON) AS WV_BRND_ICON,
			ISNULL(WV_BRND_LOGO, @WV_BRND_LOGO) AS WV_BRND_LOGO, 
			ISNULL(WV_BRND_SHRT_MNU, @WV_BRND_SHRT_MNU) AS WV_BRND_SHRT_MNU, 
			ISNULL(WV_BRND_USR_BG, @WV_BRND_USR_BG) AS WV_BRND_USR_BG, 
			ISNULL(WV_BRND_USR_THM, @WV_BRND_USR_THM) AS WV_BRND_USR_THM, 
			ISNULL(WV_BRND_THEME, 'Office2007') AS WV_BRND_THEME,
			ISNULL(WV_BRND_WKSPCLR, @WV_BRND_WKSPCLR) AS WV_BRND_WKSPCLR,
			ISNULL(WV_BRND_SBCLR, @WV_BRND_SBCLR) AS WV_BRND_SBCLR,
			ISNULL(WV_BRND_ICON_STYLE, @WV_BRND_ICON_STYLE) AS WV_BRND_ICON_STYLE,
			1 AS IS_USING_DFLT_LOGO,
			1 AS IS_USING_DFLT_WALLPAPER
		FROM         
			CP_THEME_SETTINGS WITH (NOLOCK)
		WHERE     
			(CL_CODE IS NULL);
	END
	ELSE
	BEGIN
		SELECT     
			ISNULL(CP_THEME_ID, 0) AS CP_THEME_ID, 
			CL_CODE, 
			ISNULL(WV_BRND_ENABLE, 1) AS WV_BRND_ENABLE, 
			ISNULL(WV_BRND_BG_TYPE, @WV_BRND_BG_TYPE) AS WV_BRND_BG_TYPE, 
			ISNULL(WV_BRND_BG, @WV_BRND_BG) AS WV_BRND_BG, 
			ISNULL(WV_BRND_BGCLR, @WV_BRND_BGCLR) AS WV_BRND_BGCLR, 
			ISNULL(WV_BRND_CLK_APP, @WV_BRND_CLK_APP) AS WV_BRND_CLK_APP, 
			ISNULL(WV_BRND_CLK_USR, @WV_BRND_CLK_USR) AS WV_BRND_CLK_USR, 
			ISNULL(WV_BRND_FLT_DTO, @WV_BRND_FLT_DTO) AS WV_BRND_FLT_DTO, 
			ISNULL(WV_BRND_ICON, @WV_BRND_ICON) AS WV_BRND_ICON,
			ISNULL(WV_BRND_LOGO, @WV_BRND_LOGO) AS WV_BRND_LOGO, 
			ISNULL(WV_BRND_SHRT_MNU, @WV_BRND_SHRT_MNU) AS WV_BRND_SHRT_MNU, 
			ISNULL(WV_BRND_USR_BG, @WV_BRND_USR_BG) AS WV_BRND_USR_BG, 
			ISNULL(WV_BRND_USR_THM, @WV_BRND_USR_THM) AS WV_BRND_USR_THM, 
			ISNULL(WV_BRND_THEME, 'Office2007') AS WV_BRND_THEME,
			ISNULL(WV_BRND_WKSPCLR, @WV_BRND_WKSPCLR) AS WV_BRND_WKSPCLR,
			ISNULL(WV_BRND_SBCLR, @WV_BRND_SBCLR) AS WV_BRND_SBCLR,
			ISNULL(WV_BRND_ICON_STYLE, @WV_BRND_ICON_STYLE) AS WV_BRND_ICON_STYLE,
			CASE 
				WHEN WV_BRND_LOGO IS NULL THEN 1
				WHEN RTRIM(LTRIM(WV_BRND_LOGO)) = '' THEN 1
				WHEN WV_BRND_LOGO = @DFLT_CP_LOGO THEN 1
				ELSE 0
			END AS IS_USING_DFLT_LOGO,
			CASE 
				WHEN WV_BRND_BG IS NULL THEN 1
				WHEN RTRIM(LTRIM(WV_BRND_BG)) = '' THEN 1
				WHEN WV_BRND_BG = @DFLT_CP_BG THEN 1
				ELSE 0
			END AS IS_USING_DFLT_WALLPAPER
		FROM         
			CP_THEME_SETTINGS WITH (NOLOCK)
		WHERE     
			(CL_CODE = @CL_CODE);
	END	
/*=========== QUERY ===========*/
GO
SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO