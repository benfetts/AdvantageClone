CREATE PROCEDURE [dbo].[usp_cp_Get_Alert_EmailRecipients] 
@AlertID int
AS

	SELECT
		AlertID = A.ALERT_ID,
        AlertRecipientID= A.ALERT_RCPT_ID,
        CDPContactID = A.CDP_CONTACT_ID,
        EmailAddress = A.EMAIL_ADDRESS,
        ContactFullName = A.CONT_FML,
        MailBeeTitle = A.MAILBEE_TITLE
	FROM
	(

		SELECT CP_ALERT_RCPT.ALERT_ID,
			   CP_ALERT_RCPT.ALERT_RCPT_ID,
			   CP_ALERT_RCPT.CDP_CONTACT_ID,
			   CDP_CONTACT_HDR.EMAIL_ADDRESS,
			   CDP_CONTACT_HDR.CONT_FML,
			   CDP_CONTACT_HDR.CONT_FML + ' <' + CDP_CONTACT_HDR.EMAIL_ADDRESS + '>' AS MAILBEE_TITLE
		FROM   CP_ALERT_RCPT WITH(NOLOCK)
			   INNER JOIN CDP_CONTACT_HDR WITH(NOLOCK)
					ON  CP_ALERT_RCPT.CDP_CONTACT_ID = CDP_CONTACT_HDR.CDP_CONTACT_ID
		WHERE  (CP_ALERT_RCPT.ALERT_ID = @AlertID)
			   AND (CDP_CONTACT_HDR.CP_USER = 1)
			   AND (CDP_CONTACT_HDR.EMAIL_RCPT = 1)
			   AND (NOT (CDP_CONTACT_HDR.EMAIL_ADDRESS IS NULL))
			   AND (CP_ALERT_RCPT.CURRENT_RCPT = 0 OR CP_ALERT_RCPT.CURRENT_RCPT IS NULL)

		UNION

		SELECT CP_ALERT_RCPT_DISMISSED.ALERT_ID,
			   CP_ALERT_RCPT_DISMISSED.ALERT_RCPT_ID,
			   CP_ALERT_RCPT_DISMISSED.CDP_CONTACT_ID,
			   CDP_CONTACT_HDR.EMAIL_ADDRESS,
			   CDP_CONTACT_HDR.CONT_FML,
			   CDP_CONTACT_HDR.CONT_FML + ' <' + CDP_CONTACT_HDR.EMAIL_ADDRESS + '>' AS MAILBEE_TITLE
		FROM   CP_ALERT_RCPT_DISMISSED WITH(NOLOCK)
			   INNER JOIN CDP_CONTACT_HDR WITH(NOLOCK)
					ON  CP_ALERT_RCPT_DISMISSED.CDP_CONTACT_ID = CDP_CONTACT_HDR.CDP_CONTACT_ID
		WHERE  (CP_ALERT_RCPT_DISMISSED.ALERT_ID = @AlertID)
			   AND (CDP_CONTACT_HDR.CP_USER = 1)
			   AND (CDP_CONTACT_HDR.EMAIL_RCPT = 1)
			   AND (NOT (CDP_CONTACT_HDR.EMAIL_ADDRESS IS NULL))
			   AND (CP_ALERT_RCPT_DISMISSED.CURRENT_RCPT = 0 OR CP_ALERT_RCPT_DISMISSED.CURRENT_RCPT IS NULL)

	) AS A
	ORDER BY A.CONT_FML ASC;