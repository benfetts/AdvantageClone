










CREATE PROCEDURE [dbo].[usp_cp_ProjectList] 
@CDPID int,
@SortVal AS VARCHAR(15)
AS

Set NoCount On
CREATE TABLE #myprojects( 	
	ClientCode VARCHAR(6) NULL,
	DivCode VARCHAR(6) NULL,
	ProductCode VARCHAR(6) NULL,
	CDP VARCHAR(24) NULL,
	Job VARCHAR(100) NULL,
	JobComp VARCHAR(100) NULL,
	JobAndComp VARCHAR(500) NULL,
	StartDate DATETIME NULL,
	DueDate DATETIME NULL,
	Status VARCHAR(50) NULL,
	AE VARCHAR(100) NULL,
	AECode VARCHAR(6) NULL,
	JobNo INT NULL, 
	JobCompNo INT NULL, 
	TrafficCount INT NULL
)

INSERT INTO #myprojects
SELECT 
	JOB_LOG.CL_CODE AS ClientCode, 
	JOB_LOG.DIV_CODE AS DivCode, 
	JOB_LOG.PRD_CODE AS ProductCode, 
	JOB_LOG.CL_CODE+'/'+JOB_LOG.DIV_CODE+'/'+JOB_LOG.PRD_CODE AS CDP, 
	LTRIM(STR(JOB_LOG.JOB_NUMBER)) + ' - ' + JOB_LOG.JOB_DESC AS Job, 
	LTRIM(STR(JOB_COMPONENT.JOB_COMPONENT_NBR)) + ' - ' + JOB_COMPONENT.JOB_COMP_DESC AS JobComp, 
	LTRIM(STR(JOB_LOG.JOB_NUMBER)) + ' - ' + JOB_LOG.JOB_DESC+'<BR />'+LTRIM(STR(JOB_COMPONENT.JOB_COMPONENT_NBR)) + ' - ' + JOB_COMPONENT.JOB_COMP_DESC AS JobAndComp, 
	JOB_COMPONENT.START_DATE AS StartDate, 
	JOB_COMPONENT.JOB_FIRST_USE_DATE AS DueDate, 
	TRAFFIC.TRF_DESCRIPTION AS Status, 
	EMPLOYEE.EMP_FNAME + ' ' + EMPLOYEE.EMP_LNAME  AS AE, 
	JOB_COMPONENT.EMP_CODE AS AECode,
	JOB_LOG.JOB_NUMBER AS JobNo, 
	JOB_COMPONENT.JOB_COMPONENT_NBR AS JobCompNo, 0
FROM   
	JOB_TRAFFIC_DET INNER JOIN
	JOB_TRAFFIC ON JOB_TRAFFIC_DET.JOB_NUMBER = JOB_TRAFFIC.JOB_NUMBER AND 
	JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = JOB_TRAFFIC.JOB_COMPONENT_NBR INNER JOIN
	JOB_LOG ON JOB_TRAFFIC.JOB_NUMBER = JOB_LOG.JOB_NUMBER INNER JOIN
	JOB_COMPONENT ON JOB_TRAFFIC.JOB_NUMBER = JOB_COMPONENT.JOB_NUMBER AND 
	JOB_TRAFFIC.JOB_COMPONENT_NBR = JOB_COMPONENT.JOB_COMPONENT_NBR INNER JOIN
	TRAFFIC ON JOB_TRAFFIC.TRF_CODE = TRAFFIC.TRF_CODE INNER JOIN
	EMPLOYEE ON JOB_COMPONENT.EMP_CODE = EMPLOYEE.EMP_CODE  INNER JOIN
    CP_SEC_CLIENT ON JOB_LOG.CL_CODE = CP_SEC_CLIENT.CL_CODE AND 
    JOB_LOG.DIV_CODE = CP_SEC_CLIENT.DIV_CODE AND JOB_LOG.PRD_CODE = dbo.CP_SEC_CLIENT.PRD_CODE
WHERE  
	((NOT (JOB_COMPONENT.JOB_PROCESS_CONTRL IN (6, 12))) AND 
	(JOB_TRAFFIC.COMPLETED_DATE IS NULL)) AND
	(CP_SEC_CLIENT.CDP_CONTACT_ID = @CDPID)
GROUP BY 
	JOB_LOG.CL_CODE, JOB_LOG.DIV_CODE, JOB_LOG.PRD_CODE, LTRIM(STR(JOB_LOG.JOB_NUMBER)) + ' - ' + JOB_LOG.JOB_DESC,  JOB_LOG.JOB_NUMBER,
	LTRIM(STR(JOB_COMPONENT.JOB_COMPONENT_NBR)) + ' - ' + JOB_COMPONENT.JOB_COMP_DESC, JOB_COMPONENT.START_DATE, 
	JOB_COMPONENT.JOB_FIRST_USE_DATE, TRAFFIC.TRF_DESCRIPTION, EMPLOYEE.EMP_FNAME + ' ' + EMPLOYEE.EMP_LNAME,
	JOB_COMPONENT.EMP_CODE, JOB_LOG.JOB_NUMBER, JOB_COMPONENT.JOB_COMPONENT_NBR,
	JOB_LOG.JOB_DESC, JOB_COMPONENT.JOB_COMP_DESC

UPDATE #myprojects
SET TrafficCount = 	(SELECT COUNT(*)
			FROM JOB_TRAFFIC_DET
			WHERE JOB_TRAFFIC_DET.JOB_NUMBER = #myprojects.JobNo
			AND JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = #myprojects.JobCompNo
			AND JOB_TRAFFIC_DET.JOB_COMPLETED_DATE IS NULL)


IF @SortVal = 'default'
SELECT *
FROM #myprojects
ORDER BY DueDate

IF @SortVal = 'CDP'
SELECT *
FROM #myprojects
ORDER BY ClientCode,DivCode,ProductCode,DueDate

IF @SortVal = 'jobcomp'
SELECT *
FROM #myprojects
ORDER BY JobNo,JobCompNo,DueDate

IF @SortVal = 'startdate' --AND @EmpCode = 'SYSADM'
SELECT *
FROM #myprojects
ORDER BY StartDate,DueDate

IF @SortVal = 'duedate'
SELECT *
FROM #myprojects
ORDER BY DueDate

IF @SortVal = 'status'
SELECT *
FROM #myprojects
ORDER BY Status,DueDate

IF @SortVal = 'ae'
SELECT *
FROM #myprojects
ORDER BY AECode,DueDate

IF @SortVal = 'taskcount'
SELECT *
FROM #myprojects
ORDER BY TrafficCount,DueDate



DROP TABLE #myprojects
			





















