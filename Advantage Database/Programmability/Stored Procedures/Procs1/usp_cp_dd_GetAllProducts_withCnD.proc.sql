





















CREATE PROCEDURE [dbo].[usp_cp_dd_GetAllProducts_withCnD] 
@CPID Int
AS
Declare @Restrictions Int

Set NoCount On

Select @Restrictions = Count(*) 
FROM CP_SEC_CLIENT
WHERE CDP_CONTACT_ID = @CPID

If @Restrictions > 0
	SELECT     CLIENT.CL_CODE + ':' + DIVISION.DIV_CODE + ':' + PRODUCT.PRD_CODE AS Code, 
						  CLIENT.CL_CODE + ' | ' + DIVISION.DIV_CODE + ' | ' + PRODUCT.PRD_CODE + ' - ' + ISNULL(PRODUCT.PRD_DESCRIPTION, '') AS Description
	FROM         CLIENT INNER JOIN
						  DIVISION ON CLIENT.CL_CODE = DIVISION.CL_CODE INNER JOIN
						  PRODUCT ON DIVISION.CL_CODE = PRODUCT.CL_CODE AND DIVISION.DIV_CODE = PRODUCT.DIV_CODE INNER JOIN
						  CP_SEC_CLIENT ON PRODUCT.CL_CODE = CP_SEC_CLIENT.CL_CODE AND PRODUCT.DIV_CODE = CP_SEC_CLIENT.DIV_CODE AND 
						  PRODUCT.PRD_CODE = CP_SEC_CLIENT.PRD_CODE
	WHERE     (PRODUCT.ACTIVE_FLAG = 1) AND (CP_SEC_CLIENT.CDP_CONTACT_ID = @CPID)
					AND (DIVISION.ACTIVE_FLAG = 1)
				AND (CLIENT.ACTIVE_FLAG = 1)

	ORDER BY CLIENT.CL_CODE, DIVISION.DIV_CODE, PRODUCT.PRD_CODE
ELSE
	SELECT     CLIENT.CL_CODE + ':' + DIVISION.DIV_CODE + ':' + PRODUCT.PRD_CODE AS Code, 
						  CLIENT.CL_CODE + ' | ' + DIVISION.DIV_CODE + ' | ' + PRODUCT.PRD_CODE + ' - ' + ISNULL(PRODUCT.PRD_DESCRIPTION, '') AS Description
	FROM         CLIENT INNER JOIN
						  DIVISION ON CLIENT.CL_CODE = DIVISION.CL_CODE INNER JOIN
						  PRODUCT ON DIVISION.CL_CODE = PRODUCT.CL_CODE AND DIVISION.DIV_CODE = PRODUCT.DIV_CODE
	WHERE     (PRODUCT.ACTIVE_FLAG = 1)
					AND (DIVISION.ACTIVE_FLAG = 1)
				AND (CLIENT.ACTIVE_FLAG = 1)

	ORDER BY CLIENT.CL_CODE, DIVISION.DIV_CODE, PRODUCT.PRD_CODE

















