SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS OFF 
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_wv_ALERT_GET_RECIPIENTS]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_wv_ALERT_GET_RECIPIENTS]
GO


CREATE PROCEDURE [dbo].[usp_wv_ALERT_GET_RECIPIENTS] /*WITH ENCRYPTION*/
@ALERT_ID INT
AS
/*=========== QUERY ===========*/
	SELECT TOP 100 PERCENT A.* 
	FROM   (

			   SELECT TOP 100 PERCENT ALERT_RCPT.ALERT_ID AS AlertID,
					  ALERT_RCPT.ALERT_RCPT_ID AS AlertRecipientID,
					  ALERT_RCPT.EMP_CODE AS EmpCode,
					  ALERT_RCPT.EMAIL_ADDRESS AS Email,
					  ALERT_RCPT.PROCESSED AS DismissedTS,
					  ALERT_RCPT.NEW_ALERT,
					  ALERT_RCPT.READ_ALERT,
					  ISNULL(EMPLOYEE.EMP_FNAME + ' ', '') + ISNULL(EMPLOYEE.EMP_MI + '. ', '') + ISNULL(EMPLOYEE.EMP_LNAME, '') AS UserName,
					  ISNULL(ALERT_RCPT.CURRENT_RCPT, 0) AS CURRENT_RCPT, IS_CONTACT = 0
			   FROM   ALERT_RCPT WITH(NOLOCK)
					  INNER JOIN EMPLOYEE WITH(NOLOCK)
						   ON  ALERT_RCPT.EMP_CODE = EMPLOYEE.EMP_CODE
						   AND (
								   ALERT_RCPT.CURRENT_NOTIFY IS NULL
								   OR ALERT_RCPT.CURRENT_NOTIFY = 0
						   )
			   WHERE ALERT_RCPT.ALERT_ID = @ALERT_ID	
			   		   
			   UNION

			   SELECT TOP 100 PERCENT ALERT_RCPT_DISMISSED.ALERT_ID AS AlertID,
					  ALERT_RCPT_DISMISSED.ALERT_RCPT_ID AS AlertRecipientID,
					  ALERT_RCPT_DISMISSED.EMP_CODE AS EmpCode,
					  ALERT_RCPT_DISMISSED.EMAIL_ADDRESS AS Email,
					  ALERT_RCPT_DISMISSED.PROCESSED AS DismissedTS,
					  ALERT_RCPT_DISMISSED.NEW_ALERT,
					  ALERT_RCPT_DISMISSED.READ_ALERT,
					  ISNULL(EMPLOYEE.EMP_FNAME + ' ', '') + ISNULL(EMPLOYEE.EMP_MI + '. ', '') + ISNULL(EMPLOYEE.EMP_LNAME, '') AS UserName,
					  ISNULL(ALERT_RCPT_DISMISSED.CURRENT_RCPT, 0) AS CURRENT_RCPT, IS_CONTACT = 0
			   FROM   ALERT_RCPT_DISMISSED WITH(NOLOCK)
					  INNER JOIN EMPLOYEE WITH(NOLOCK)
						   ON  ALERT_RCPT_DISMISSED.EMP_CODE = EMPLOYEE.EMP_CODE
						   AND (
								   ALERT_RCPT_DISMISSED.CURRENT_NOTIFY IS NULL
								   OR ALERT_RCPT_DISMISSED.CURRENT_NOTIFY = 0
						   )
			   WHERE ALERT_RCPT_DISMISSED.ALERT_ID = @ALERT_ID		
			   
			   UNION
			   
			   SELECT 
					@ALERT_ID AS AlertID,
					CP_ALERT_RCPT.CDP_CONTACT_ID AS AlertRecipientID,						
					  CDP_CONTACT_HDR.CONT_CODE AS EmpCode,
					  CP_ALERT_RCPT.EMAIL_ADDRESS AS Email,
					  CP_ALERT_RCPT.PROCESSED AS DismissedTS,
					  CP_ALERT_RCPT.NEW_ALERT,
					  CP_ALERT_RCPT.READ_ALERT,
					  ISNULL(CDP_CONTACT_HDR.CONT_FNAME + ' ', '') + ISNULL(CDP_CONTACT_HDR.CONT_MI + '. ', '')
					  + ISNULL(CDP_CONTACT_HDR.CONT_LNAME, '') + ' (CC)' AS UserName,
					  ISNULL(CP_ALERT_RCPT.CURRENT_RCPT,0) AS CURRENT_RCPT,
					  1 AS IS_CONTACT
			   FROM   CP_ALERT_RCPT WITH(NOLOCK)
					  INNER JOIN CDP_CONTACT_HDR WITH(NOLOCK)
						   ON  CP_ALERT_RCPT.CDP_CONTACT_ID = CDP_CONTACT_HDR.CDP_CONTACT_ID
			   WHERE  (CP_ALERT_RCPT.ALERT_ID = @ALERT_ID)	
			   		   
			   UNION

			   SELECT TOP 100 PERCENT CP_ALERT_RCPT_DISMISSED.ALERT_ID AS AlertID,
					  CP_ALERT_RCPT_DISMISSED.CDP_CONTACT_ID AS AlertRecipientID,
					  CDP_CONTACT_HDR.CONT_CODE AS EmpCode,
					  CP_ALERT_RCPT_DISMISSED.EMAIL_ADDRESS AS Email,
					  CP_ALERT_RCPT_DISMISSED.PROCESSED AS DismissedTS,
					  CP_ALERT_RCPT_DISMISSED.NEW_ALERT,
					  CP_ALERT_RCPT_DISMISSED.READ_ALERT,
					  ISNULL(CDP_CONTACT_HDR.CONT_FNAME + ' ', '') + ISNULL(CDP_CONTACT_HDR.CONT_MI + '. ', '')
					  + ISNULL(CDP_CONTACT_HDR.CONT_LNAME, '') + ' (CC)' AS UserName,
					  ISNULL(CP_ALERT_RCPT_DISMISSED.CURRENT_RCPT, 0) AS CURRENT_RCPT, IS_CONTACT = 1
			   FROM   CP_ALERT_RCPT_DISMISSED WITH(NOLOCK)
					  INNER JOIN CDP_CONTACT_HDR WITH(NOLOCK)
						   ON  CP_ALERT_RCPT_DISMISSED.CDP_CONTACT_ID = CDP_CONTACT_HDR.CDP_CONTACT_ID
						   AND (
								   CP_ALERT_RCPT_DISMISSED.CURRENT_NOTIFY IS NULL
								   OR CP_ALERT_RCPT_DISMISSED.CURRENT_NOTIFY = 0
						   )
			   WHERE CP_ALERT_RCPT_DISMISSED.ALERT_ID = @ALERT_ID 
			      
		   ) AS A
	ORDER BY
		   A.UserName;

/*=========== QUERY ===========*/

GO
SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO