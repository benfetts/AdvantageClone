
CREATE PROCEDURE [dbo].[usp_wv_ALERT_GET_VERSIONBUILD] /*WITH ENCRYPTION*/
@JOB_NUMBER INT,
@JOB_COMPONENT_NBR SMALLINT
AS
/*=========== QUERY ===========*/
DECLARE
	@VERSION_ID INT,
	@JOB_COUNT INT,
	@JOB_COMP_COUNT INT

	SET @JOB_COMPONENT_NBR = ISNULL(@JOB_COMPONENT_NBR,0);
	
	SELECT @JOB_COUNT = COUNT(1) FROM SOFTWARE_LEVEL WITH(NOLOCK) WHERE JOB_NUMBER = @JOB_NUMBER AND (JOB_COMPONENT_NBR IS NULL OR JOB_COMPONENT_NBR = 0);	
	SELECT @JOB_COMP_COUNT = COUNT(1) FROM SOFTWARE_LEVEL WITH(NOLOCK) WHERE JOB_NUMBER = @JOB_NUMBER AND JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR;

	SET @JOB_COUNT = ISNULL(@JOB_COUNT,0);
	SET @JOB_COMP_COUNT = ISNULL(@JOB_COMP_COUNT,0);

	--SELECT @JOB_COUNT AS JOB_COUNT, @JOB_COMP_COUNT AS JOB_COMP_COUNT
	IF @JOB_COUNT > 0 AND @JOB_COMP_COUNT = 0
	BEGIN
		SELECT TOP 1 @VERSION_ID = VERSION_ID FROM SOFTWARE_LEVEL WITH(NOLOCK) WHERE JOB_NUMBER = @JOB_NUMBER ORDER BY LEVEL_ID DESC;
	END
	IF @JOB_COUNT = 0 AND @JOB_COMP_COUNT > 0
	BEGIN
		SELECT TOP 1 @VERSION_ID = VERSION_ID FROM SOFTWARE_LEVEL WITH(NOLOCK) WHERE JOB_NUMBER = @JOB_NUMBER AND JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR ORDER BY LEVEL_ID DESC;		
	END
	--EXISTS AT JOB AND JOB COMP LEVEL; LET JC OVERRIDE
	IF @JOB_COUNT > 0 AND @JOB_COMP_COUNT > 0
	BEGIN
		SELECT TOP 1 @VERSION_ID = VERSION_ID FROM SOFTWARE_LEVEL WITH(NOLOCK) WHERE JOB_NUMBER = @JOB_NUMBER AND JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR ORDER BY LEVEL_ID DESC;		
	END

	SET @VERSION_ID = ISNULL(@VERSION_ID,0);
	
	SELECT VERSION_ID, VERSION, VERSION_DESC, ACTIVE_FLAG FROM SOFTWARE_VERSION WITH(NOLOCK) WHERE (ACTIVE_FLAG = 1 OR ACTIVE_FLAG IS NULL) AND VERSION_ID = @VERSION_ID;
	SELECT BUILD_ID, VERSION_ID, BUILD, BUILD_DESC, ACTIVE_FLAG FROM SOFTWARE_BUILD WITH(NOLOCK) WHERE (ACTIVE_FLAG = 1 OR ACTIVE_FLAG IS NULL) AND VERSION_ID = @VERSION_ID;
/*=========== QUERY ===========*/
