if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_wv_ALERT_NOTIFY_GET_STATES]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_wv_ALERT_NOTIFY_GET_STATES]
GO

CREATE PROCEDURE [dbo].[usp_wv_ALERT_NOTIFY_GET_STATES] 
@JOB_NUMBER                INT,
@JOB_COMPONENT_NBR         SMALLINT,
@ALRT_NOTIFY_HDR_ID        INT
AS

	DECLARE @THIS_ALRT_NOTIFY_HDR_ID INT
 
	IF @JOB_NUMBER > 0
	   AND @JOB_COMPONENT_NBR > 0
	BEGIN
		SELECT @THIS_ALRT_NOTIFY_HDR_ID = ISNULL(ALRT_NOTIFY_HDR_ID, 0)
		FROM   JOB_COMPONENT WITH(NOLOCK)
		WHERE  JOB_NUMBER = @JOB_NUMBER
			   AND JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR;
	END
    
	IF @ALRT_NOTIFY_HDR_ID > 0
	BEGIN
		SET @THIS_ALRT_NOTIFY_HDR_ID = @ALRT_NOTIFY_HDR_ID;
	END

	IF @THIS_ALRT_NOTIFY_HDR_ID > 0
	BEGIN
		--THIS ONLY HAPPENS WHEN MOVING TO THE LAST POSTION IN THE STATES IN TEMPLATE LIST BOX
		IF EXISTS (
			SELECT     COUNT(1)
			FROM         ALERT_NOTIFY_STATES WITH(NOLOCK)
			WHERE ALRT_NOTIFY_HDR_ID =  @ALRT_NOTIFY_HDR_ID 
			AND IS_COMPLETED = 1 AND (SORT_ORDER IS NULL) )
		BEGIN
			
			DECLARE @MAX_ORDER INT
			SELECT @MAX_ORDER = MAX(SORT_ORDER) FROM ALERT_NOTIFY_STATES WITH(NOLOCK) WHERE ALRT_NOTIFY_HDR_ID = @ALRT_NOTIFY_HDR_ID;
			SET @MAX_ORDER = ISNULL(@MAX_ORDER,0) + 1
			
			UPDATE ALERT_NOTIFY_STATES WITH(ROWLOCK) SET SORT_ORDER = @MAX_ORDER
			WHERE ALRT_NOTIFY_HDR_ID =  @ALRT_NOTIFY_HDR_ID 
			AND IS_COMPLETED = 1 AND (SORT_ORDER IS NULL)

		END
		
		--IF THE JOB COMP HAS A TEMPLATE, THEN GET THE STATES BASED ON THE JOB/COMP'S TEMPLATE ID
		SELECT DISTINCT A.*
		FROM (
				SELECT TOP 100 PERCENT    
					ALERT_STATES.ALERT_STATE_ID, 
					CASE 
						WHEN ALERT_NOTIFY_STATES.IS_COMPLETED = 1 AND (WORKFLOW_ALERT_STATE.WORKFLOW_ALERT_STATE_ID IS NULL) THEN ALERT_STATES.ALERT_STATE_NAME + '*' 
						WHEN (NOT (WORKFLOW_ALERT_STATE.WORKFLOW_ALERT_STATE_ID IS NULL)) AND (ALERT_NOTIFY_STATES.IS_COMPLETED = 0 OR ALERT_NOTIFY_STATES.IS_COMPLETED IS NULL)THEN ALERT_STATES.ALERT_STATE_NAME + '**' 
						WHEN (NOT (WORKFLOW_ALERT_STATE.WORKFLOW_ALERT_STATE_ID IS NULL)) AND (ALERT_NOTIFY_STATES.IS_COMPLETED = 1) THEN ALERT_STATES.ALERT_STATE_NAME + '**' 
						ELSE ALERT_STATES.ALERT_STATE_NAME 
					END AS ALERT_STATE_NAME,
					ISNULL(ALERT_STATES.ACTIVE_FLAG, 1) AS ACTIVE_FLAG, 
					ALERT_STATES.DFLT_ALERT_CAT_ID, 
					ISNULL(ALERT_NOTIFY_STATES.SORT_ORDER, 99999) AS SORT_ORDER, 
					CASE
						WHEN (WORKFLOW_ALERT_STATE.WORKFLOW_ALERT_STATE_ID IS NULL) THEN 0
						ELSE 1
					END AS HAS_WORKFLOW,
					CASE
						WHEN (ALERT_NOTIFY_STATES.IS_COMPLETED = 1) THEN 1
						ELSE 0
					END AS IS_COMPLETED				
				FROM         
					ALERT_NOTIFY_HDR WITH (NOLOCK) INNER JOIN
					ALERT_NOTIFY_STATES WITH (NOLOCK) ON ALERT_NOTIFY_HDR.ALRT_NOTIFY_HDR_ID = ALERT_NOTIFY_STATES.ALRT_NOTIFY_HDR_ID INNER JOIN
					ALERT_STATES WITH (NOLOCK) ON ALERT_NOTIFY_STATES.ALERT_STATE_ID = ALERT_STATES.ALERT_STATE_ID LEFT OUTER JOIN
					WORKFLOW_ALERT_STATE WITH (NOLOCK) ON ALERT_NOTIFY_STATES.ALRT_NOTIFY_HDR_ID = WORKFLOW_ALERT_STATE.ALRT_NOTIFY_HDR_ID AND 
					ALERT_NOTIFY_STATES.ALERT_STATE_ID = WORKFLOW_ALERT_STATE.ALERT_STATE_ID
				WHERE     
					(ALERT_STATES.ACTIVE_FLAG IS NULL OR
					ALERT_STATES.ACTIVE_FLAG = 1) AND (ALERT_NOTIFY_HDR.ALRT_NOTIFY_HDR_ID = @THIS_ALRT_NOTIFY_HDR_ID)
			) AS A
		ORDER BY 
			A.SORT_ORDER, 
			A.ALERT_STATE_NAME
			   
	END

	IF @JOB_NUMBER = 0
	   AND @JOB_COMPONENT_NBR = 0
	   AND (@THIS_ALRT_NOTIFY_HDR_ID = 0 OR @ALRT_NOTIFY_HDR_ID = 0)
	BEGIN
		--GET ALL
		SELECT A.ALERT_STATE_ID,
			   A.ALERT_STATE_NAME,
			   A.ACTIVE_FLAG,
			   A.DFLT_ALERT_CAT_ID,
			   A.HAS_ALERT,
			   A.HAS_ALERT_NOTIFY_EMPS,
			   A.HAS_ALERT_NOTIFY_STATES,
			   CASE 
					WHEN A.HAS_ALERT = 0 AND A.HAS_ALERT_NOTIFY_EMPS = 0 AND A.HAS_ALERT_NOTIFY_STATES 
						 = 0 THEN 1
					ELSE 0
			   END AS CAN_DELETE
		FROM   (
				   SELECT ALERT_STATES.ALERT_STATE_ID,
						  ALERT_STATES.ALERT_STATE_NAME,
						  ISNULL(ALERT_STATES.ACTIVE_FLAG, 1) AS ACTIVE_FLAG,
						  ALERT_STATES.DFLT_ALERT_CAT_ID,
						  (
							  SELECT ISNULL(COUNT(1), 0)
							  FROM   ALERT WITH(NOLOCK)
							  WHERE  ALERT.ALERT_STATE_ID = ALERT_STATES.ALERT_STATE_ID
						  ) AS HAS_ALERT,
						  (
							  SELECT ISNULL(COUNT(1), 0)
							  FROM   ALERT_NOTIFY_EMPS WITH(NOLOCK)
							  WHERE  ALERT_NOTIFY_EMPS.ALERT_STATE_ID = ALERT_STATES.ALERT_STATE_ID
						  ) AS HAS_ALERT_NOTIFY_EMPS,
						  (
							  SELECT ISNULL(COUNT(1), 0)
							  FROM   ALERT_NOTIFY_STATES WITH(NOLOCK)
							  WHERE  ALERT_NOTIFY_STATES.ALERT_STATE_ID = 
									 ALERT_STATES.ALERT_STATE_ID
						  ) AS HAS_ALERT_NOTIFY_STATES
				   FROM   ALERT_STATES WITH (NOLOCK)
				   WHERE
						ALERT_STATES.ALERT_STATE_ID > 0
			   ) AS A
		ORDER BY
			   A.ALERT_STATE_NAME;
	END