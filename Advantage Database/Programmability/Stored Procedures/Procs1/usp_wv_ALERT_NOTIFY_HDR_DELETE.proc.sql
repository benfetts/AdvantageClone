
CREATE PROCEDURE [dbo].[usp_wv_ALERT_NOTIFY_HDR_DELETE] /*WITH ENCRYPTION*/
	@ALRT_NOTIFY_HDR_ID INT
AS
/*=========== QUERY ===========*/
DECLARE
	@HAS_COMPONENT INT,
	@HAS_ALERT INT,
	@RTN_MSG VARCHAR(400)
	SET @RTN_MSG = '';

	SELECT @HAS_COMPONENT = ISNULL(COUNT(1),0) FROM JOB_COMPONENT WITH(NOLOCK) WHERE ALRT_NOTIFY_HDR_ID = @ALRT_NOTIFY_HDR_ID;
	SELECT @HAS_ALERT = ISNULL(COUNT(1),0) FROM ALERT WITH(NOLOCK) WHERE ALRT_NOTIFY_HDR_ID = @ALRT_NOTIFY_HDR_ID;

	
	
	IF @HAS_COMPONENT = 0 AND @HAS_ALERT = 0
	BEGIN
		UPDATE JOB_COMPONENT WITH(ROWLOCK) SET ALRT_NOTIFY_HDR_ID = NULL WHERE ALRT_NOTIFY_HDR_ID = @ALRT_NOTIFY_HDR_ID;
		DELETE FROM ALERT_NOTIFY_EMPS WITH(ROWLOCK) WHERE ALRT_NOTIFY_HDR_ID = @ALRT_NOTIFY_HDR_ID;
		DELETE FROM ALERT_NOTIFY_STATES WITH(ROWLOCK) WHERE ALRT_NOTIFY_HDR_ID = @ALRT_NOTIFY_HDR_ID;
		DELETE FROM ALERT_NOTIFY_HDR WITH(ROWLOCK) WHERE ALRT_NOTIFY_HDR_ID = @ALRT_NOTIFY_HDR_ID;
		SET @RTN_MSG = '';
	END
	IF @HAS_COMPONENT > 0 AND @HAS_ALERT = 0
	BEGIN
		SET @RTN_MSG = 'This template is on a job component and cannot be deleted';
	END
	IF @HAS_COMPONENT = 0 AND @HAS_ALERT > 0
	BEGIN
		SET @RTN_MSG = 'This template is on an alert and cannot be deleted';
	END
	IF @HAS_COMPONENT > 0 AND @HAS_ALERT > 0
	BEGIN
		SET @RTN_MSG = 'This template is on a job component and on an alert and cannot be deleted';
	END
	
	SELECT @RTN_MSG;		
/*=========== QUERY ===========*/
