--DROP PROCEDURE [dbo].[usp_wv_ALERT_NOTIFY_HDR_GET]
CREATE PROCEDURE [dbo].[usp_wv_ALERT_NOTIFY_HDR_GET] /*WITH ENCRYPTION*/
@SHOW_ALL BIT
AS
/*=========== QUERY ===========*/
BEGIN
	IF @SHOW_ALL = 1 
	BEGIN
		SELECT 
			A.ALRT_NOTIFY_HDR_ID,
			A.ALERT_NOTIFY_NAME,
			A.ACTIVE_FLAG,
			A.HAS_ALERT_NOTIFY_EMPS,
			A.HAS_ALERT_NOTIFY_STATES,
			CASE
				WHEN A.HAS_ALERT_NOTIFY_EMPS = 0 AND A.HAS_ALERT_NOTIFY_STATES = 0 THEN 1
				ELSE 0
			END AS CAN_DELETE,
			ISNULL([TYPE], 0) AS [TYPE],
			ISNULL([AUTO_NXT_STATE], 0) AS [AUTO_NXT_STATE]
		FROM
		(
			SELECT	
				ALRT_NOTIFY_HDR_ID,
				ALERT_NOTIFY_NAME,
				ISNULL(ACTIVE_FLAG, 1) AS ACTIVE_FLAG,
				(SELECT ISNULL(COUNT(1),0) FROM ALERT_NOTIFY_EMPS WITH(NOLOCK) WHERE ALERT_NOTIFY_EMPS.ALRT_NOTIFY_HDR_ID = ALERT_NOTIFY_HDR.ALRT_NOTIFY_HDR_ID) AS HAS_ALERT_NOTIFY_EMPS,
				(SELECT ISNULL(COUNT(1),0) FROM ALERT_NOTIFY_STATES WITH(NOLOCK) WHERE ALERT_NOTIFY_STATES.ALRT_NOTIFY_HDR_ID = ALERT_NOTIFY_HDR.ALRT_NOTIFY_HDR_ID) AS HAS_ALERT_NOTIFY_STATES,
				[TYPE],
				[AUTO_NXT_STATE]
			FROM	
				ALERT_NOTIFY_HDR WITH(NOLOCK)
			WHERE	
				ALERT_NOTIFY_HDR.ALERT_NOTIFY_NAME <> 'Basic Board'
		) AS A
		ORDER BY
			A.ALERT_NOTIFY_NAME;	
	END	
	ELSE
	BEGIN
		SELECT 
			A.ALRT_NOTIFY_HDR_ID,
			A.ALERT_NOTIFY_NAME,
			A.ACTIVE_FLAG,
			A.HAS_ALERT_NOTIFY_EMPS,
			A.HAS_ALERT_NOTIFY_STATES,
			CASE
				WHEN A.HAS_ALERT_NOTIFY_EMPS = 0 AND A.HAS_ALERT_NOTIFY_STATES = 0 THEN 1
				ELSE 0
			END AS CAN_DELETE,
			ISNULL([TYPE], 0) AS [TYPE],
			ISNULL([AUTO_NXT_STATE], 0) AS [AUTO_NXT_STATE]
		FROM
		(
			SELECT 
				ALRT_NOTIFY_HDR_ID,
				ALERT_NOTIFY_NAME,
				ISNULL(ACTIVE_FLAG, 1) AS ACTIVE_FLAG,
				(SELECT ISNULL(COUNT(1),0) FROM ALERT_NOTIFY_EMPS WITH(NOLOCK) WHERE ALERT_NOTIFY_EMPS.ALRT_NOTIFY_HDR_ID = ALERT_NOTIFY_HDR.ALRT_NOTIFY_HDR_ID) AS HAS_ALERT_NOTIFY_EMPS,
				(SELECT ISNULL(COUNT(1),0) FROM ALERT_NOTIFY_STATES WITH(NOLOCK) WHERE ALERT_NOTIFY_STATES.ALRT_NOTIFY_HDR_ID = ALERT_NOTIFY_HDR.ALRT_NOTIFY_HDR_ID) AS HAS_ALERT_NOTIFY_STATES,
				[TYPE],
				[AUTO_NXT_STATE]
			FROM   
				ALERT_NOTIFY_HDR WITH(NOLOCK)
			WHERE  
				(ACTIVE_FLAG IS NULL OR ACTIVE_FLAG = 1) AND ALERT_NOTIFY_HDR.ALERT_NOTIFY_NAME <> 'Basic Board'
		) AS A
		ORDER BY
			A.ALERT_NOTIFY_NAME;
	END
END
/*=========== QUERY ===========*/
