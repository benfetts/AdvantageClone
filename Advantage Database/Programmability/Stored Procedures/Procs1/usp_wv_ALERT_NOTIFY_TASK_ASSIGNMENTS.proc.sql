
CREATE PROCEDURE [dbo].[usp_wv_ALERT_NOTIFY_TASK_ASSIGNMENTS] /*WITH ENCRYPTION*/
@JOB_NUMBER INT,
@JOB_COMPONENT_NBR SMALLINT,
@SEQ_NBR SMALLINT
AS
/*=========== QUERY ===========*/

SELECT A.*
FROM
(
	SELECT JOB_TRAFFIC_DET.JOB_NUMBER,
		   JOB_TRAFFIC_DET.JOB_COMPONENT_NBR,
		   JOB_TRAFFIC_DET.SEQ_NBR,
		   ALERT.ALERT_ID,
		   ALERT.ALERT_STATE_ID,
		   ALERT.ALRT_NOTIFY_HDR_ID,
		   ALERT_NOTIFY_HDR.ALERT_NOTIFY_NAME,
		   ALERT_STATES.ALERT_STATE_NAME,
		   ALERT_NOTIFY_STATES.SORT_ORDER,
		   ALERT.SUBJECT,
		   CAST(ALERT.BODY AS VARCHAR) AS BODY,
		   ALERT.GENERATED,
		   ALERT.PRIORITY,
		   ALERT_RCPT.EMP_CODE,
		   [dbo].[udf_get_empl_name](ALERT_RCPT.EMP_CODE, 'FML') USER_NAME,
		   CAST(ALERT.BODY_HTML AS VARCHAR) AS BODY_HTML,
		   ALERT.DUE_DATE,
		   ALERT.TIME_DUE,
		   ALERT.VER,
		   ALERT.BUILD
	FROM   ALERT WITH (NOLOCK)
		   LEFT OUTER JOIN ALERT_NOTIFY_HDR WITH (NOLOCK)
				ON  ALERT.ALRT_NOTIFY_HDR_ID = ALERT_NOTIFY_HDR.ALRT_NOTIFY_HDR_ID
		   INNER JOIN ALERT_RCPT WITH (NOLOCK)
				ON  ALERT.ALERT_ID = ALERT_RCPT.ALERT_ID
		   LEFT OUTER JOIN ALERT_STATES WITH (NOLOCK)
				ON  ALERT.ALERT_STATE_ID = ALERT_STATES.ALERT_STATE_ID
		   INNER JOIN JOB_TRAFFIC_DET WITH (NOLOCK)
				ON  ALERT.JOB_NUMBER = JOB_TRAFFIC_DET.JOB_NUMBER
				AND ALERT.JOB_COMPONENT_NBR = JOB_TRAFFIC_DET.JOB_COMPONENT_NBR
				AND ALERT.TASK_SEQ_NBR = JOB_TRAFFIC_DET.SEQ_NBR
		   LEFT OUTER JOIN ALERT_NOTIFY_STATES WITH (NOLOCK)
				ON  ALERT.ALRT_NOTIFY_HDR_ID = ALERT_NOTIFY_STATES.ALRT_NOTIFY_HDR_ID
				AND ALERT.ALERT_STATE_ID = ALERT_NOTIFY_STATES.ALERT_STATE_ID
	WHERE  --(ALERT_RCPT.CURRENT_NOTIFY = 1)
		   --AND
		    (JOB_TRAFFIC_DET.JOB_NUMBER = @JOB_NUMBER)
		   AND (JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR)
		   AND (JOB_TRAFFIC_DET.SEQ_NBR = @SEQ_NBR)
UNION
	SELECT JOB_TRAFFIC_DET.JOB_NUMBER,
		   JOB_TRAFFIC_DET.JOB_COMPONENT_NBR,
		   JOB_TRAFFIC_DET.SEQ_NBR,
		   ALERT.ALERT_ID,
		   ALERT.ALERT_STATE_ID,
		   ALERT.ALRT_NOTIFY_HDR_ID,
		   ALERT_NOTIFY_HDR.ALERT_NOTIFY_NAME,
		   ALERT_STATES.ALERT_STATE_NAME,
		   ALERT_NOTIFY_STATES.SORT_ORDER,
		   ALERT.SUBJECT,
		   CAST(ALERT.BODY AS VARCHAR) AS BODY,
		   ALERT.GENERATED,
		   ALERT.PRIORITY,
		   ALERT_RCPT_DISMISSED.EMP_CODE,
		   [dbo].[udf_get_empl_name](ALERT_RCPT_DISMISSED.EMP_CODE, 'FML') USER_NAME,
		   CAST(ALERT.BODY_HTML AS VARCHAR) AS BODY_HTML,
		   ALERT.DUE_DATE,
		   ALERT.TIME_DUE,
		   ALERT.VER,
		   ALERT.BUILD
	FROM   ALERT WITH (NOLOCK)
		   LEFT OUTER JOIN ALERT_NOTIFY_HDR WITH (NOLOCK)
				ON  ALERT.ALRT_NOTIFY_HDR_ID = ALERT_NOTIFY_HDR.ALRT_NOTIFY_HDR_ID
		   INNER JOIN ALERT_RCPT_DISMISSED WITH (NOLOCK)
				ON  ALERT.ALERT_ID = ALERT_RCPT_DISMISSED.ALERT_ID
		   LEFT OUTER JOIN ALERT_STATES WITH (NOLOCK)
				ON  ALERT.ALERT_STATE_ID = ALERT_STATES.ALERT_STATE_ID
		   INNER JOIN JOB_TRAFFIC_DET WITH (NOLOCK)
				ON  ALERT.JOB_NUMBER = JOB_TRAFFIC_DET.JOB_NUMBER
				AND ALERT.JOB_COMPONENT_NBR = JOB_TRAFFIC_DET.JOB_COMPONENT_NBR
				AND ALERT.TASK_SEQ_NBR = JOB_TRAFFIC_DET.SEQ_NBR
		   LEFT OUTER JOIN ALERT_NOTIFY_STATES WITH (NOLOCK)
				ON  ALERT.ALRT_NOTIFY_HDR_ID = ALERT_NOTIFY_STATES.ALRT_NOTIFY_HDR_ID
				AND ALERT.ALERT_STATE_ID = ALERT_NOTIFY_STATES.ALERT_STATE_ID
	WHERE  --(ALERT_RCPT_DISMISSED.CURRENT_NOTIFY = 1)
		  -- AND
		   (JOB_TRAFFIC_DET.JOB_NUMBER = @JOB_NUMBER)
		   AND (JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR)
		   AND (JOB_TRAFFIC_DET.SEQ_NBR = @SEQ_NBR)
) AS A		   
	ORDER BY
		   A.ALERT_NOTIFY_NAME,
		   A.SORT_ORDER;
/*=========== QUERY ===========*/
