--DROP PROCEDURE [dbo].[usp_wv_ALERT_SUMMARY]
CREATE PROCEDURE [dbo].[usp_wv_ALERT_SUMMARY] /*WITH ENCRYPTION*/
@EMP_CODE VARCHAR(6)
AS
/*=========== QUERY ===========*/
	--	VARIABLES
	BEGIN
		DECLARE
			@TOTAL_ALERTS INT,
			@HIGH_PRIORITY_ALERTS INT,
			@ALERTS_OVERDUE INT,
			@ALERTS_DUE_TODAY INT,
			@TOTAL_ASSIGNMENTS INT,
			@HIGH_PRIORITY_ASSIGNMENTS INT,
			@ASSIGNMENTS_DUE_TODAY INT,
			@ASSIGNMENTS_DUE_THIS_WEEK INT,
			@ASSIGNMENTS_OVERDUE INT
		DECLARE @ALERTS TABLE (READ_ALERT SMALLINT,
							   PROCESSED SMALLDATETIME,
							   CURRENT_NOTIFY INT,
							   DUE_DATE SMALLDATETIME,
							   [PRIORITY] SMALLINT,
							   CURRENT_RCPT SMALLINT,
							   IS_DRAFT BIT);
	END

	--	DATA
	BEGIN
		INSERT INTO @ALERTS
		SELECT 
			AR.READ_ALERT,
			AR.PROCESSED,
			ISNULL(AR.CURRENT_NOTIFY, 0),
			A.DUE_DATE,
			A.PRIORITY,
			AR.CURRENT_RCPT,
			ISNULL(A.IS_DRAFT, 0)
		FROM
			ALERT A WITH(NOLOCK)
			INNER JOIN ALERT_RCPT AR WITH(NOLOCK) ON A.ALERT_ID = AR.ALERT_ID
		WHERE
			AR.EMP_CODE = @EMP_CODE;
	END
	
	--	ALERTS
	BEGIN
		--TOTAL ALERTS
		SELECT @TOTAL_ALERTS = COUNT(1)
		FROM   @ALERTS A
		WHERE  A.CURRENT_RCPT IS NULL
			   AND A.PROCESSED IS NULL
			   AND A.CURRENT_NOTIFY = 0
			   AND A.IS_DRAFT = 0;
		 --ALERTS OVERDUE
		SELECT @ALERTS_OVERDUE = COUNT(1)
		FROM   @ALERTS A
		WHERE  A.CURRENT_RCPT IS NULL
			   AND A.DUE_DATE < GETDATE()
			   AND A.PROCESSED IS NULL
			   AND A.CURRENT_NOTIFY = 0
			   AND A.IS_DRAFT = 0;
		--ALERTS DUE TODAY
		SELECT @ALERTS_DUE_TODAY = COUNT(1)
		FROM   @ALERTS A
		WHERE  A.CURRENT_RCPT IS NULL
			   AND A.DUE_DATE = GETDATE()
			   AND A.PROCESSED IS NULL
			   AND A.CURRENT_NOTIFY = 0
			   AND A.IS_DRAFT = 0;
		--HIGH PRIORITY ALERTS
		SELECT @HIGH_PRIORITY_ALERTS = COUNT(1)
		FROM   @ALERTS A
		WHERE  A.CURRENT_RCPT IS NULL
			   AND A.PROCESSED IS NULL
			   AND A.PRIORITY = 1
			   AND A.CURRENT_NOTIFY = 0
			   AND A.IS_DRAFT = 0;
	END	

	--	ASSIGNMENTS
	BEGIN
		--ASSIGNMENTS
		SELECT @TOTAL_ASSIGNMENTS = COUNT(1)
		FROM   @ALERTS A
		WHERE  A.PROCESSED IS NULL
			   AND A.CURRENT_NOTIFY = 1
			   AND A.IS_DRAFT = 0;
		 --ASSIGNMENTS OVERDUE
		SELECT @ASSIGNMENTS_OVERDUE = COUNT(1)
		FROM   @ALERTS A
		WHERE  A.DUE_DATE < GETDATE()
			   AND A.PROCESSED IS NULL
			   AND A.CURRENT_NOTIFY = 1
			   AND A.IS_DRAFT = 0;
		--ASSIGNMENTS DUE TODAY
		SELECT @ASSIGNMENTS_DUE_TODAY = COUNT(1)
		FROM   @ALERTS A
		WHERE  A.DUE_DATE = GETDATE()
			   AND A.PROCESSED IS NULL
			   AND A.CURRENT_NOTIFY = 1
			   AND A.IS_DRAFT = 0;
		--HIGH PRIORITY ASSIGNMENTS
		SELECT @HIGH_PRIORITY_ASSIGNMENTS = COUNT(1)
		FROM   @ALERTS A
		WHERE  A.PROCESSED IS NULL
			   AND A.PRIORITY = 1
			   AND A.CURRENT_NOTIFY = 1
			   AND A.IS_DRAFT = 0;
	END
      
	SELECT
		ISNULL(@TOTAL_ALERTS,0) AS TOTAL_ALERTS ,
		ISNULL(@ALERTS_OVERDUE,0) AS ALERTS_OVERDUE,
		ISNULL(@ALERTS_DUE_TODAY,0) AS ALERTS_DUE_TODAY,
		ISNULL(@HIGH_PRIORITY_ALERTS,0) AS HIGH_PRIORITY_ALERTS,
		ISNULL(@TOTAL_ASSIGNMENTS,0) AS TOTAL_ASSIGNMENTS,
		ISNULL(@ASSIGNMENTS_OVERDUE,0) AS ASSIGNMENTS_OVERDUE,
		ISNULL(@ASSIGNMENTS_DUE_TODAY,0) AS ASSIGNMENTS_DUE_TODAY,
		ISNULL(@HIGH_PRIORITY_ASSIGNMENTS,0) AS HIGH_PRIORITY_ASSIGNMENTS,
		ISNULL(@ASSIGNMENTS_DUE_THIS_WEEK,0) AS ASSIGNMENTS_DUE_THIS_WEEK
    
/*=========== QUERY ===========*/