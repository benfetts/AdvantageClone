--DROP PROCEDURE [dbo].[usp_wv_ALERT_UPDATE_RECIPIENTS_CP]
CREATE PROCEDURE [dbo].[usp_wv_ALERT_UPDATE_RECIPIENTS_CP] /*WITH ENCRYPTION*/
@ALERT_ID  INT,
@EMP_LIST_CHECKED VARCHAR(MAX),
@EMP_LIST_UNCHECKED VARCHAR(MAX),
@SET_AS_NEW BIT
AS
/*=========== QUERY ===========*/

	IF RTRIM(LTRIM(@EMP_LIST_CHECKED)) = ''
	BEGIN
		SET @EMP_LIST_CHECKED = NULL;
	END
	
	IF RTRIM(LTRIM(@EMP_LIST_UNCHECKED)) = ''
	BEGIN
		SET @EMP_LIST_UNCHECKED = NULL;
	END
	
	DECLARE 
		@SQL VARCHAR(MAX), 
		@SQL_WHERE VARCHAR(MAX),
		@SQL_WHERE_UNCHECKED VARCHAR(MAX)

	SET @SQL_WHERE =  ' WHERE ALERT_ID = ' + CAST(@ALERT_ID AS VARCHAR) + ' AND CDP_CONTACT_ID IN (' + @EMP_LIST_CHECKED+ ');';
	SET @SQL_WHERE_UNCHECKED =  ' WHERE ALERT_ID = ' + CAST(@ALERT_ID AS VARCHAR) + ' AND CDP_CONTACT_ID IN (' + @EMP_LIST_UNCHECKED+ ');';

	IF (NOT (@EMP_LIST_CHECKED IS NULL)) AND (RTRIM(LTRIM(@EMP_LIST_CHECKED)) <> '')
	BEGIN
		--TAKE THOSE SAME RECORDS AND COPY THEM TO THE MAIN RECIPIENT TABLE (UN-DISMISS)
		SET @SQL = '';
		SET @SQL = '
		INSERT INTO CP_ALERT_RCPT
		SELECT * FROM CP_ALERT_RCPT_DISMISSED';
		EXEC (@SQL + @SQL_WHERE);

		--AFTER COPYING, DELETE FROM THE DISMISSED RECORDS (STILL UN-DISMISS PROCESS)
		SET @SQL = '';
		SET @SQL = '
		DELETE FROM CP_ALERT_RCPT_DISMISSED WITH(ROWLOCK)';
		EXEC (@SQL + @SQL_WHERE);

		--WHEN VIEWING ALERT, THE CURRENT_RCPT FLAG INDICATES WHETHER THE CHECKBOX NEXT TO THE RECIPIENT IS CHECKED.
		-- ZERO = CHECKED

		IF @SET_AS_NEW = 1
		BEGIN
			SET @SQL = ''
			SET @SQL = '
			UPDATE CP_ALERT_RCPT SET PROCESSED = NULL, NEW_ALERT = NULL, READ_ALERT = NULL, CURRENT_RCPT = 0'
			EXEC (@SQL + @SQL_WHERE);

			SET @SQL = ''
			SET @SQL = '
			UPDATE CP_ALERT_RCPT_DISMISSED SET PROCESSED = NULL, NEW_ALERT = NULL, READ_ALERT = NULL, CURRENT_RCPT = 0'
			EXEC (@SQL + @SQL_WHERE);
		END

		--WHEN VIEWING ALERT, THE CURRENT_RCPT FLAG INDICATES WHETHER THE CHECKBOX NEXT TO THE RECIPIENT IS CHECKED.
		-- ZERO = CHECKED
		BEGIN
			SET @SQL = ''
			SET @SQL = '
			UPDATE CP_ALERT_RCPT SET CURRENT_RCPT = 0'
			EXEC (@SQL + @SQL_WHERE);

			SET @SQL = ''
			SET @SQL = '
			UPDATE CP_ALERT_RCPT_DISMISSED SET CURRENT_RCPT = 0'
			EXEC (@SQL + @SQL_WHERE);
		END

	END

	
	IF (NOT (@SQL_WHERE_UNCHECKED IS NULL)) AND (RTRIM(LTRIM(@EMP_LIST_UNCHECKED)) <> '')
	BEGIN 
		
		SET @SQL = ''
		SET @SQL = '
		UPDATE CP_ALERT_RCPT SET CURRENT_RCPT = 1'
		EXEC (@SQL + @SQL_WHERE_UNCHECKED);

		SET @SQL = ''
		SET @SQL = '
		UPDATE CP_ALERT_RCPT_DISMISSED SET CURRENT_RCPT = 1'
		EXEC (@SQL + @SQL_WHERE_UNCHECKED);
		
	END	
	

/*=========== QUERY ===========*/
