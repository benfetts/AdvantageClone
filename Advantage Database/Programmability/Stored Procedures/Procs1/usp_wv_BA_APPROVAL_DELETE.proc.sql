
CREATE PROCEDURE [dbo].[usp_wv_BA_APPROVAL_DELETE]
	@BA_BATCH_ID AS INT,
	@BA_ID AS INT

 AS
 
		--UPDATE EMP_TIME_DTL WITH(ROWLOCK) SET BA_ID = NULL WHERE BA_ID = @BA_ID;
		--UPDATE INCOME_ONLY WITH(ROWLOCK) SET BA_ID = NULL WHERE BA_ID = @BA_ID;
		--UPDATE AP_PRODUCTION WITH(ROWLOCK) SET BA_ID = NULL WHERE BA_ID = @BA_ID;

	
		DELETE FROM BILL_APPR_ITEM WITH(ROWLOCK) WHERE BA_DTL_ID IN 
			(SELECT BA_DTL_ID FROM BILL_APPR_DTL WITH(NOLOCK) WHERE BA_ID = @BA_ID AND BA_ID IN
				(SELECT BA_ID FROM BILL_APPR_HDR WITH(ROWLOCK) WHERE BA_ID = @BA_ID AND APPR_STATUS = 1)
			);

		DELETE FROM BILL_APPR_DTL WITH(ROWLOCK) WHERE BA_ID = @BA_ID AND BA_ID IN 
			(SELECT BA_ID FROM BILL_APPR_HDR WITH(ROWLOCK) WHERE BA_ID = @BA_ID AND APPR_STATUS = 1);	

		DELETE FROM BILL_APPR_HDR WITH(ROWLOCK) WHERE BA_ID = @BA_ID AND APPR_STATUS = 1;	
		
		DECLARE @HDR_COUNT AS INTEGER
		SELECT @HDR_COUNT = COUNT(1) FROM BILL_APPR_HDR WITH(NOLOCK) WHERE BA_ID = @BA_ID;
		IF @HDR_COUNT = 0
		BEGIN
			DELETE FROM BILL_APPR_CL WITH(ROWLOCK) WHERE BA_ID = @BA_ID;	
			DELETE FROM BILL_APPR WITH(ROWLOCK) WHERE BA_ID = @BA_ID AND BA_BATCH_ID = @BA_BATCH_ID;
		END 

