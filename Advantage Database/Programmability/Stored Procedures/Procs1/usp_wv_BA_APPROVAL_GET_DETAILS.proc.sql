
CREATE PROCEDURE [dbo].[usp_wv_BA_APPROVAL_GET_DETAILS]
@BA_ID AS INT --APPROVAL ID

AS


	--VARIABLES:
	DECLARE @THIS_BATCH_ID  AS INT,
			@THIS_CL_CODE   AS VARCHAR(6),
			@HAS_APPROVED   INT

	SET @THIS_BATCH_ID = 0
	SET @THIS_CL_CODE = ''
	SET @HAS_APPROVED = 0
					
	--SET VARIABLES:
	SELECT @THIS_BATCH_ID = BILL_APPR.BA_BATCH_ID,
		   @THIS_CL_CODE = BILL_APPR_CL.CL_CODE
	FROM   BILL_APPR WITH(NOLOCK)
		   INNER JOIN BILL_APPR_CL WITH(NOLOCK)
				ON  BILL_APPR.BA_ID = BILL_APPR_CL.BA_ID
	WHERE  BILL_APPR.BA_ID = @BA_ID;
					
	SELECT @HAS_APPROVED = ISNULL(COUNT(1), 0)
	FROM   BILL_APPR_HDR WITH(NOLOCK)
	WHERE  BA_ID = @BA_ID
		   AND (APPR_STATUS IS NULL OR APPR_STATUS = 0);
		
	--GET APPROVAL HEADER (TABLE 0):	
	SELECT BILL_APPR.BA_ID,
		   BILL_APPR.BA_BATCH_ID,
		   BILL_APPR.CREATE_USER,
		   BILL_APPR.CREATE_DATE,
		   BILL_APPR_CL.CL_CODE,
		   CLIENT.CL_NAME,
		   BILL_APPR_CL.BA_CL_DESC,
		   BILL_APPR_CL.BA_CL_DATE,
		   BILL_APPR_CL.SENT_DATE,
		   BILL_APPR_CL.APPR_DATE,
		   BILL_APPR_CL.CLIENT_PO,
		   BILL_APPR_CL.CREATE_USER AS BILL_APPR_CL_CREATE_USER,
		   BILL_APPR_BATCH.BA_BATCH_DESC,
		   ISNULL(BILL_APPR_BATCH.APPROVED, 0) AS APPROVED,
		   ISNULL(@HAS_APPROVED,0) AS HAS_APPROVED,
		   BILL_APPR_CL.CDP_CONTACT_ID,
		   BILL_APPR_CL.CONT_CODE,
		   CDP_CONTACT_HDR.CONT_FNAME,
		   CDP_CONTACT_HDR.CONT_MI,
		   CDP_CONTACT_HDR.CONT_LNAME,
		   CDP_CONTACT_HDR.CONT_FML AS CDP_CONTACT_FML_NAME
	FROM   BILL_APPR WITH (NOLOCK)
		   INNER JOIN BILL_APPR_CL WITH (NOLOCK)
				ON  BILL_APPR.BA_ID = BILL_APPR_CL.BA_ID
		   INNER JOIN CLIENT WITH (NOLOCK)
				ON  BILL_APPR_CL.CL_CODE = CLIENT.CL_CODE
		   INNER JOIN BILL_APPR_BATCH WITH (NOLOCK)
				ON  BILL_APPR.BA_BATCH_ID = BILL_APPR_BATCH.BA_BATCH_ID
		   LEFT OUTER JOIN CDP_CONTACT_HDR WITH (NOLOCK)
				ON  BILL_APPR_CL.CDP_CONTACT_ID = CDP_CONTACT_HDR.CDP_CONTACT_ID
	WHERE  (BILL_APPR.BA_ID = @BA_ID);				

	--GET COMPONENTS (TABLE 1):
	EXEC usp_wv_BA_BATCH_GET_JOBS @THIS_BATCH_ID,
		 @BA_ID,
		 @THIS_CL_CODE;



				
			
	

