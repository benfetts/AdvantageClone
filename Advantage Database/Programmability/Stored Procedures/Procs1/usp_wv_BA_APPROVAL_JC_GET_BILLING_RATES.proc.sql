

CREATE PROCEDURE [dbo].[usp_wv_BA_APPROVAL_JC_GET_BILLING_RATES] 
	@THIS_FNC_CODE AS VARCHAR(6),
	@THIS_JOB_NUMBER AS INT = NULL,
	@THIS_JOB_COMPONENT_NBR AS SMALLINT = NULL,
	@THIS_BATCH_ID AS INT = NULL,

	@THIS_BILLING_RATE AS DECIMAL(9,2) OUTPUT,
	@THIS_RATE_LEVEL AS SMALLINT OUTPUT,
	@THIS_TAX_CODE AS VARCHAR(4) OUTPUT,
	@THIS_TAX_LEVEL SMALLINT OUTPUT,
	@THIS_NOBILL_FLAG SMALLINT OUTPUT,
	@THIS_NOBILL_LEVEL SMALLINT OUTPUT,
	@THIS_COMM DECIMAL(9,3) OUTPUT,
	@THIS_COMM_LEVEL SMALLINT OUTPUT,
	@THIS_TAX_COMM SMALLINT OUTPUT,
	@THIS_TAX_COMM_ONLY SMALLINT OUTPUT,
	@THIS_TAX_COMM_FLAGS_LEVEL SMALLINT OUTPUT,
	@THIS_FEE_TIME_FLAG SMALLINT OUTPUT,
	@THIS_FEE_TIME_LEVEL SMALLINT  OUTPUT

AS

DECLARE
	@THIS_CL_CODE AS VARCHAR(6),
	@THIS_DIV_CODE AS VARCHAR(6),
	@THIS_PRD_CODE AS VARCHAR(6),
	@THIS_SC_CODE AS VARCHAR(6),
	@THIS_FNC_TYPE AS VARCHAR(1),
	@THIS_EFF_DATE AS SMALLDATETIME
	
--GET DATA FOR SPROC:
	SELECT     
		@THIS_CL_CODE = CL_CODE, 
		@THIS_DIV_CODE = DIV_CODE, 
		@THIS_PRD_CODE = PRD_CODE, 
		@THIS_SC_CODE = SC_CODE
	FROM         
		JOB_LOG WITH(NOLOCK)
	WHERE
		JOB_NUMBER = @THIS_JOB_NUMBER;
	SELECT	
		@THIS_FNC_TYPE = FNC_TYPE
	FROM
		FUNCTIONS WITH(NOLOCK)
	WHERE
	    FNC_CODE = @THIS_FNC_CODE;		
			
	SELECT 
		@THIS_EFF_DATE = BATCH_DATE 
	FROM 
		BILL_APPR_BATCH WITH(NOLOCK) 
	WHERE 
		BA_BATCH_ID = @THIS_BATCH_ID;
	
--RUN BEN'S SPROC:	
	EXECUTE dbo.sp_get_billing_rates
		@emp_code = NULL,
		@eff_date = @THIS_EFF_DATE,
		@fnc_code = @THIS_FNC_CODE,
		@cl_code = @THIS_CL_CODE,
		@div_code = @THIS_DIV_CODE, 
		@prd_code = @THIS_PRD_CODE,
		@sc_code = @THIS_SC_CODE,
		@fnc_type = @THIS_FNC_TYPE, 
		@job_number = @THIS_JOB_NUMBER, 
		@job_component_nbr = @THIS_JOB_COMPONENT_NBR,
		@emp_title_id = NULL,
		@billing_rate = @THIS_BILLING_RATE OUTPUT,
		@rate_level = @THIS_RATE_LEVEL OUTPUT,
		@tax_code = @THIS_TAX_CODE OUTPUT,
		@tax_level = @THIS_TAX_LEVEL OUTPUT,
		@nobill_flag = @THIS_NOBILL_FLAG OUTPUT,
		@nobill_level = @THIS_NOBILL_LEVEL OUTPUT,
		@comm = @THIS_COMM OUTPUT,
		@comm_level = @THIS_COMM_LEVEL OUTPUT,
		@tax_comm = @THIS_TAX_COMM OUTPUT,
		@tax_comm_only = @THIS_TAX_COMM_ONLY OUTPUT,
		@tax_comm_flags_level = @THIS_TAX_COMM_FLAGS_LEVEL OUTPUT,
		@fee_time_flag = @THIS_FEE_TIME_FLAG OUTPUT,
		@fee_time_level = @THIS_FEE_TIME_LEVEL OUTPUT;
	


