 --usp_wv_BA_APPROVAL_SELECT_BATCH
 if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_wv_BA_APPROVAL_SELECT_BATCH]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_wv_BA_APPROVAL_SELECT_BATCH]
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS OFF 
GO

CREATE PROCEDURE [dbo].[usp_wv_BA_APPROVAL_SELECT_BATCH] 
	@BA_BATCH_ID AS INT
AS
				
				
		--GET BATCH DATA:
		DECLARE @JOB_BATCH_COUNT AS INTEGER
		
		SELECT @JOB_BATCH_COUNT = ISNULL(COUNT(1),0) FROM JOB_COMPONENT WITH(NOLOCK) WHERE BA_BATCH_ID = @BA_BATCH_ID;

		SELECT    
			BILL_APPR_BATCH.BA_BATCH_ID, BILL_APPR_BATCH.BA_BATCH_DESC, BILL_APPR_BATCH.BATCH_DATE, BILL_APPR_BATCH.CREATE_USER, BILL_APPR_BATCH.CREATE_DATE, 
			BILL_APPR_BATCH.MODIFY_USER, BILL_APPR_BATCH.MODIFY_DATE, BILL_APPR_BATCH.DATE_CUTOFF, BILL_APPR_BATCH.PERIOD_CUTOFF, BILL_APPR_BATCH.EMP_CODE, 
			ISNULL(EMPLOYEE.EMP_FNAME+' ','')+ISNULL(EMPLOYEE.EMP_MI+'. ','')+ISNULL(EMPLOYEE.EMP_LNAME,'') AS EMP_FML_NAME,
			ISNULL(INCL_NO_DTL,0) AS INCL_NO_DTL, ISNULL(INCL_NB,0) AS INCL_NB, ISNULL(INCL_FEE,0) AS INCL_FEE, ISNULL(INCL_INT,0) AS INCL_INT, ISNULL(INCL_NP,0) AS INCL_NP, ISNULL(INCL_MAG,0) AS INCL_MAG, 
			ISNULL(INCL_OD,0) AS INCL_OD, ISNULL(INCL_RA,0) AS INCL_RA, ISNULL(INCL_TV,0) AS INCL_TV, ISNULL(BA_EXISTS,0) AS BA_EXISTS, ISNULL(APPROVED,0) AS APPROVED, ISNULL(FINISHED,0) AS FINISHED, 
			ISNULL(APPR_METHOD,0) AS APPR_METHOD, ISNULL(BA_EXISTS,0) AS BA_EXISTS, ISNULL(BILLED_ANY,0) AS BILLED_ANY, ISNULL(BILLED_ALL,0) AS BILLED_ALL,
			dbo.wvfn_get_batch_status(BILL_APPR_BATCH.BA_BATCH_ID) AS STATUS,
		CASE
			WHEN EXISTS(SELECT * FROM ALERT WITH(NOLOCK) WHERE BA_BATCH_ID = BILL_APPR_BATCH.BA_BATCH_ID) THEN 'Sent'
			ELSE 'None'
		END AS ALERT_STATUS, @JOB_BATCH_COUNT AS JOB_BATCH_COUNT, 
             SEC_USER.EMP_CODE AS CREATE_USER_EMP_CODE
        FROM        
            BILL_APPR_BATCH WITH (NOLOCK) INNER JOIN
            EMPLOYEE WITH (NOLOCK) ON BILL_APPR_BATCH.EMP_CODE = EMPLOYEE.EMP_CODE LEFT OUTER JOIN
            SEC_USER WITH (NOLOCK)  ON UPPER(BILL_APPR_BATCH.CREATE_USER) = UPPER(SEC_USER.USER_CODE)
        WHERE     
            (BILL_APPR_BATCH.BA_BATCH_ID = @BA_BATCH_ID);


		--GET APPROVALS:		
		SELECT     
			BILL_APPR.BA_BATCH_ID, BILL_APPR.BA_ID, BILL_APPR.CREATE_DATE, BILL_APPR.CREATE_USER, 
			BILL_APPR_CL.CL_CODE, CLIENT.CL_NAME, BILL_APPR_CL.BA_CL_DESC,
			CLIENT.CL_CODE+' - '+CLIENT.CL_NAME AS CLIENT_CODE_NAME
			
		FROM         
			BILL_APPR WITH(NOLOCK) INNER JOIN
			BILL_APPR_CL WITH(NOLOCK) ON BILL_APPR.BA_ID = BILL_APPR_CL.BA_ID INNER JOIN
			CLIENT WITH(NOLOCK) ON BILL_APPR_CL.CL_CODE = CLIENT.CL_CODE
		WHERE     
			(BILL_APPR.BA_BATCH_ID = @BA_BATCH_ID);



GO
SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

