--DROP PROCEDURE [dbo].[usp_wv_BA_BATCH_APPROVE]
CREATE PROCEDURE [dbo].[usp_wv_BA_BATCH_APPROVE] 
@BA_BATCH_ID INT
AS
 BEGIN
/*=========== QUERY ===========*/
	DECLARE
		@FINISHED AS BIT,
		@CURR_APPROVED AS BIT,
		@FLIP_APPROVED AS BIT
	
	SELECT @FINISHED = FINISHED, @CURR_APPROVED = APPROVED 
	FROM 
		BILL_APPR_BATCH WITH(NOLOCK) 
	WHERE 
		BILL_APPR_BATCH.BA_BATCH_ID = @BA_BATCH_ID;
	
	IF @CURR_APPROVED = 1
	BEGIN
		SET @FLIP_APPROVED = 0;
	END
	ELSE
	BEGIN
		SET @FLIP_APPROVED = 1;
	END
			

	IF @FINISHED = 0
	BEGIN
		UPDATE 
			BILL_APPR_BATCH WITH(ROWLOCK)
		SET
			APPROVED = @FLIP_APPROVED
		WHERE
			BILL_APPR_BATCH.BA_BATCH_ID = @BA_BATCH_ID;
	END	

	----WE ARE "UN-APPROVING"
	--IF @FLIP_APPROVED = 0
	--BEGIN

		DELETE FROM BILL_APPR_ITEM WITH(ROWLOCK) WHERE BA_DTL_ID IN
		(
			SELECT BA_DTL_ID FROM BILL_APPR_DTL WITH(ROWLOCK) WHERE
			CAST(BILL_APPR_DTL.BA_ID AS VARCHAR) + '|' + CAST(BILL_APPR_DTL.JOB_NUMBER AS VARCHAR) + '|' + CAST(BILL_APPR_DTL.JOB_COMPONENT_NBR AS VARCHAR) IN
			(
			SELECT CAST(BILL_APPR_HDR.BA_ID AS VARCHAR) + '|' + CAST(BILL_APPR_HDR.JOB_NUMBER AS VARCHAR) + '|' + CAST(BILL_APPR_HDR.JOB_COMPONENT_NBR AS VARCHAR)  FROM BILL_APPR_HDR
			WHERE BILL_APPR_HDR.APPR_STATUS = 1 AND BILL_APPR_HDR.BA_ID IN  (SELECT BILL_APPR.BA_ID FROM BILL_APPR WITH(NOLOCK) WHERE BILL_APPR.BA_BATCH_ID = @BA_BATCH_ID)
			)
		);

		DELETE FROM BILL_APPR_DTL WITH(ROWLOCK) WHERE
		CAST(BILL_APPR_DTL.BA_ID AS VARCHAR) + '|' + CAST(BILL_APPR_DTL.JOB_NUMBER AS VARCHAR) + '|' + CAST(BILL_APPR_DTL.JOB_COMPONENT_NBR AS VARCHAR) IN
		(
		SELECT CAST(BILL_APPR_HDR.BA_ID AS VARCHAR) + '|' + CAST(BILL_APPR_HDR.JOB_NUMBER AS VARCHAR) + '|' + CAST(BILL_APPR_HDR.JOB_COMPONENT_NBR AS VARCHAR)  FROM BILL_APPR_HDR
		WHERE BILL_APPR_HDR.APPR_STATUS = 1 AND BILL_APPR_HDR.BA_ID IN  (SELECT BILL_APPR.BA_ID FROM BILL_APPR WITH(NOLOCK) WHERE BILL_APPR.BA_BATCH_ID = @BA_BATCH_ID)
		);

		DELETE FROM BILL_APPR_HDR WITH(ROWLOCK) WHERE APPR_STATUS = 1 AND BA_ID IN (SELECT BA_ID FROM BILL_APPR WITH(NOLOCK) WHERE BA_BATCH_ID = @BA_BATCH_ID);

	--END

		SELECT @CURR_APPROVED = APPROVED FROM BILL_APPR_BATCH WITH(NOLOCK) WHERE BILL_APPR_BATCH.BA_BATCH_ID = @BA_BATCH_ID;
		IF @CURR_APPROVED = 1
		BEGIN

			DECLARE @UNUSED_BA_ID TABLE (BA_ID INT);
			DECLARE @USED_JOB_COMPS TABLE (JOB_NUMBER INT, JOB_COMPONENT_NBR SMALLINT);
			
			INSERT INTO @USED_JOB_COMPS
			SELECT BAH.JOB_NUMBER, BAH.JOB_COMPONENT_NBR
			FROM 
				BILL_APPR BA WITH(NOLOCK)
				INNER JOIN BILL_APPR_HDR BAH WITH(NOLOCK) ON BA.BA_ID = BAH.BA_ID
				INNER JOIN BILL_APPR_DTL BAD WITH(NOLOCK) ON BA.BA_ID = BAD.BA_ID
			WHERE 
				BA.BA_BATCH_ID = @BA_BATCH_ID
			GROUP BY
				BAH.JOB_NUMBER, BAH.JOB_COMPONENT_NBR

			INSERT INTO @UNUSED_BA_ID
			SELECT BAC.BA_ID
			FROM 
				BILL_APPR_CL BAC WITH(NOLOCK)
				INNER JOIN BILL_APPR BA WITH(NOLOCK) ON BAC.BA_ID = BA.BA_ID
				LEFT OUTER JOIN BILL_APPR_HDR BAH WITH(NOLOCK) ON BAC.BA_ID = BAH.BA_ID
				LEFT OUTER JOIN BILL_APPR_DTL BAD WITH(NOLOCK) ON BAC.BA_ID = BAD.BA_ID
			WHERE 
				BA.BA_BATCH_ID = @BA_BATCH_ID
				AND (BAH.JOB_NUMBER IS NULL AND BAH.JOB_COMPONENT_NBR IS NULL)
				AND (BAD.JOB_NUMBER IS NULL AND BAD.JOB_COMPONENT_NBR IS NULL)
				;

			DELETE BAC
			FROM 
				BILL_APPR_CL BAC
				INNER JOIN @UNUSED_BA_ID UBI ON BAC.BA_ID = UBI.BA_ID;

			DELETE BA
			FROM 
				BILL_APPR BA
				INNER JOIN @UNUSED_BA_ID UBI ON BA.BA_ID = UBI.BA_ID;

			--SELECT JC.JOB_NUMBER, JC.JOB_COMPONENT_NBR, JC.BA_BATCH_ID, UJC.JOB_NUMBER, UJC.JOB_COMPONENT_NBR
			UPDATE JOB_COMPONENT WITH(ROWLOCK) SET BA_BATCH_ID = NULL
			FROM 
				JOB_COMPONENT JC
				LEFT OUTER JOIN @USED_JOB_COMPS UJC ON JC.JOB_NUMBER = UJC.JOB_NUMBER AND JC.JOB_COMPONENT_NBR = UJC.JOB_COMPONENT_NBR
			WHERE
				JC.BA_BATCH_ID = @BA_BATCH_ID
				AND (UJC.JOB_NUMBER IS NULL AND UJC.JOB_COMPONENT_NBR IS NULL);

		END
/*=========== QUERY ===========*/
END