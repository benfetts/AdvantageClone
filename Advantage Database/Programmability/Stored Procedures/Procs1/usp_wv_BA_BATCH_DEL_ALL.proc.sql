
CREATE PROCEDURE [dbo].[usp_wv_BA_BATCH_DEL_ALL] 
@BA_BATCH_ID INT
AS

DECLARE 
	@HAS_BILL_APPR AS INT,
	@MSG AS VARCHAR(150)

	SELECT @HAS_BILL_APPR = COUNT(1) FROM BILL_APPR WITH(NOLOCK) WHERE BA_BATCH_ID = @BA_BATCH_ID
	
	IF @HAS_BILL_APPR = 0
		BEGIN
			--CLEAR THE BA_BATCH_ID FROM THE COMPONENT TABLE:
			UPDATE 
				JOB_COMPONENT WITH(ROWLOCK) 
			SET 
				BA_BATCH_ID = NULL
			WHERE 
				BA_BATCH_ID = @BA_BATCH_ID;

			--DELETE THE AE SELECTIONS:
			DELETE FROM 
				BILL_APPR_BATCH_AE WITH(ROWLOCK)
			WHERE 
				BA_BATCH_ID = @BA_BATCH_ID;
			
			--DELETE THE PM SELECTIONS:
			DELETE FROM 
				BILL_APPR_BATCH_PM WITH(ROWLOCK)
			WHERE 
				BA_BATCH_ID = @BA_BATCH_ID;

			--DELETE THE CAMPAIGN SELECTIONS:
			DELETE FROM 
				BILL_APPR_BATCH_CMP WITH(ROWLOCK)
			WHERE 
				BA_BATCH_ID = @BA_BATCH_ID;
			
			--DELETE CDP SELECTIONS:
			DELETE FROM 
				BILL_APPR_BATCH_CDP WITH(ROWLOCK)
			WHERE 
				BA_BATCH_ID = @BA_BATCH_ID;

			--FINALLY, DELETE THE BATCH RECORD:
			DELETE FROM 
				BILL_APPR_BATCH WITH(ROWLOCK)
			WHERE 
				BA_BATCH_ID = @BA_BATCH_ID;
				
			SET @MSG = ''
		END
	ELSE
		BEGIN
			SET @MSG = 'Batch has approvals and cannot be deleted.'
		END
		
		
SELECT @MSG	
	
	
