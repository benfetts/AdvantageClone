if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_wv_BA_BATCH_VIEW_LIST_OTHER_USERS]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_wv_BA_BATCH_VIEW_LIST_OTHER_USERS]
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS OFF 
GO

CREATE PROCEDURE [dbo].[usp_wv_BA_BATCH_VIEW_LIST_OTHER_USERS]
	@MONTH SMALLINT,
	@YEAR SMALLINT,
	@USER_CODE VARCHAR(100)
AS

	DECLARE
		@START_DATE SMALLDATETIME,
		@END_DATE SMALLDATETIME
			
		SET @START_DATE = CONVERT(DATETIME, CAST(@YEAR AS VARCHAR(4))+'-'+ CAST(@MONTH AS VARCHAR(2)) +'-01 00:00:00', 102)
		SET @END_DATE =  DATEADD(s,-45,DATEADD(mm, DATEDIFF(m,0,@START_DATE)+1,0)) 

	SELECT     
		BILL_APPR_BATCH.BA_BATCH_ID, 
		BILL_APPR_BATCH.BA_BATCH_DESC, 
		BILL_APPR_BATCH.BATCH_DATE, 
		BILL_APPR_BATCH.CREATE_USER, 
		ISNULL(EMPLOYEE.EMP_FNAME+' ','')+ISNULL(EMPLOYEE.EMP_MI+'. ','')+ISNULL(EMPLOYEE.EMP_LNAME,'') AS ASSIGNED_EMP_NAME,
		dbo.wvfn_get_batch_status(BILL_APPR_BATCH.BA_BATCH_ID) AS STATUS,
		CASE
			WHEN EXISTS(SELECT * FROM ALERT WITH(NOLOCK) WHERE BA_BATCH_ID = BILL_APPR_BATCH.BA_BATCH_ID) THEN 'Sent'
			ELSE 'None'
		END AS ALERT_STATUS,
		ISNULL(BILL_APPR_BATCH.BA_EXISTS,0) AS BA_EXISTS, 
		ISNULL(BILL_APPR_BATCH.APPROVED,0) AS APPROVED, 
		ISNULL(BILL_APPR_BATCH.FINISHED	,0) AS FINISHED,
		dbo.wvfn_get_batch_job_count(BILL_APPR_BATCH.BA_BATCH_ID, 1) AS JOB_COUNT,
		dbo.udf_get_empl_name(SEC_USER.EMP_CODE, 'FML') AS USER_NAME
	
	FROM BILL_APPR_BATCH WITH(NOLOCK) 
		LEFT OUTER JOIN EMPLOYEE WITH(NOLOCK) ON BILL_APPR_BATCH.EMP_CODE = EMPLOYEE.EMP_CODE
		LEFT OUTER JOIN SEC_USER WITH(NOLOCK) ON UPPER(BILL_APPR_BATCH.CREATE_USER) = UPPER(SEC_USER.USER_CODE)
	WHERE
		BILL_APPR_BATCH.BATCH_DATE BETWEEN @START_DATE AND @END_DATE
		AND UPPER(BILL_APPR_BATCH.CREATE_USER) <> UPPER(@USER_CODE);
		
		
GO
SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

 