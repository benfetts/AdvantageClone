

CREATE PROCEDURE [dbo].[usp_wv_Dashboard_GetClientTimeData]
(
	@EmpCode varchar(6),
	@StartDate varchar(12),
	@EndDate varchar(12),
	@Client varchar(6),
	@Division varchar(6),
	@Product varchar(6)
)
AS
Declare @Restrictions Int,
		@sql nvarchar(4000),
		@paramlist nvarchar(4000)

SELECT @sql = 'SELECT DASH_DATA_EMP_TIME.CLIENT, CLIENT.CL_NAME, DASH_DATA_EMP_TIME.DIVISION, DIVISION.DIV_NAME, DASH_DATA_EMP_TIME.PRODUCT, PRODUCT.PRD_DESCRIPTION,
					SUM(DASH_DATA_EMP_TIME.DIRECT_HOURS) AS ACTUAL_HOURS, SUM(DASH_DATA_EMP_TIME.DIRECT_AMT) AS ACTUAL_AMOUNT, 
					 SUM(DASH_DATA_EMP_TIME.BILLED_HOURS) AS BILLED_HOURS, SUM(DASH_DATA_EMP_TIME.BILLED_AMT) AS BILLED_AMT, 
					 CASE WHEN SUM(DASH_DATA_EMP_TIME.DIRECT_HOURS) <> 0 THEN (SUM(DASH_DATA_EMP_TIME.BILLED_HOURS)/SUM(DASH_DATA_EMP_TIME.DIRECT_HOURS)) * 100 ELSE 0 END AS PERCENT_BILLED, 
                      SUM(DASH_DATA_EMP_TIME.WIP_HOURS) AS WIP_HOURS, SUM(DASH_DATA_EMP_TIME.WIP_AMT) AS WIP_AMT, 
					  SUM(DASH_DATA_EMP_TIME.DIRECT_NONBILLABLE_HOURS) AS DIRECT_NONBILLABLE_HOURS, SUM(DASH_DATA_EMP_TIME.DIRECT_NONBILLABLE_AMT) AS DIRECT_NONBILLABLE_AMT,
					  SUM(MARK_UP_DOWN_AMT) AS UPDOWN_AMT, CASE WHEN SUM(ISNULL(DIRECT_HOURS,0)) <> 0 THEN SUM(ISNULL(BILLED_AMT,0))/SUM(ISNULL(DIRECT_HOURS,0)) ELSE 0 END AS HOURLY_RATE
			   FROM DASH_DATA_EMP_TIME INNER JOIN
					PRODUCT ON DASH_DATA_EMP_TIME.CLIENT = PRODUCT.CL_CODE AND DASH_DATA_EMP_TIME.DIVISION = PRODUCT.DIV_CODE AND DASH_DATA_EMP_TIME.PRODUCT = PRODUCT.PRD_CODE INNER JOIN
					DIVISION ON DIVISION.CL_CODE =PRODUCT.CL_CODE AND DIVISION.DIV_CODE = PRODUCT.DIV_CODE INNER JOIN
					CLIENT ON .DIVISION.CL_CODE = CLIENT.CL_CODE
			   WHERE 1=1'
			if @EmpCode <> '' 
				Begin
				   SELECT @sql = @sql + ' AND (DASH_DATA_EMP_TIME.EMP_CODE = @EmpCode )'
				End
			if @StartDate <> '' and @EndDate <> ''
				Begin
				   SELECT @sql = @sql + ' AND (DASH_DATA_EMP_TIME.EMP_DATE >= @StartDate) AND (DASH_DATA_EMP_TIME.EMP_DATE <= @EndDate)'
				End
			if @Client <> '' 
				Begin
				   SELECT @sql = @sql + ' AND (DASH_DATA_EMP_TIME.CLIENT = @Client)'
				End
			if @Division <> '' 
				Begin
				   SELECT @sql = @sql + ' AND (DASH_DATA_EMP_TIME.DIVISION = @Division)'
				End
			if @Product <> '' 
				Begin
				   SELECT @sql = @sql + ' AND (DASH_DATA_EMP_TIME.PRODUCT = @Product)'
				End


SELECT @sql = @sql + ' GROUP BY DASH_DATA_EMP_TIME.CLIENT, CLIENT.CL_NAME, DASH_DATA_EMP_TIME.DIVISION, DIVISION.DIV_NAME, DASH_DATA_EMP_TIME.PRODUCT, PRODUCT.PRD_DESCRIPTION'
SELECT @paramlist = '@EmpCode Varchar(6), @StartDate varchar(12), @EndDate varchar(12), @Client VarChar(6), @Product VarChar(6), @Division VarChar(6)'
print @sql
EXEC sp_executesql @sql, @paramlist, @EmpCode, @StartDate, @EndDate, @Client, @Product, @Division






