
CREATE PROCEDURE [dbo].[usp_wv_alert_add_recipient]
@ALERTID as Integer,
@EMP_CODE as VarChar(6),
@EMAIL_ADDRESS as VarChar(100)
AS
	DECLARE @RCPTID         AS INT

	SET NOCOUNT ON

	IF EXISTS(
		   SELECT ALERT_RCPT_ID
		   FROM   ALERT_RCPT
		   WHERE  ALERT_ID = @ALERTID
	   )
		BEGIN
			SELECT @RCPTID = MAX(ALERT_RCPT_ID) + 1
			FROM   ALERT_RCPT WITH(NOLOCK)
			WHERE  ALERT_ID = @ALERTID;
		END
	ELSE
		BEGIN
			SET @RCPTID = 1;
		END

	IF (@EMAIL_ADDRESS IS NULL)
	   OR (LTRIM(RTRIM(@EMAIL_ADDRESS)) = '')
	BEGIN
		SELECT @EMAIL_ADDRESS = EMP_EMAIL
		FROM   EMPLOYEE WITH(NOLOCK)
		WHERE  EMP_CODE = @EMP_CODE;
	END

	INSERT INTO ALERT_RCPT WITH(ROWLOCK)
	  (
		ALERT_ID,
		ALERT_RCPT_ID,
		EMP_CODE,
		EMAIL_ADDRESS
	  )
	VALUES
	  (
		@ALERTID,
		@RCPTID,
		@EMP_CODE,
		@EMAIL_ADDRESS
	  );

