IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[usp_wv_alert_notification]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [dbo].[usp_wv_alert_notification]
GO
CREATE PROCEDURE [dbo].[usp_wv_alert_notification] 
@EMP_CODE VARCHAR(6),
@CLIENT_PORTAL_USER_ID AS INT
AS
BEGIN
	
	DECLARE @ALERTS TABLE (ALERT_ID INT, [PRIORITY] SMALLINT, SHORT_SUBJECT VARCHAR(50), [SUBJECT] VARCHAR(500))

	DECLARE
		@COUNT INT

	IF NOT @CLIENT_PORTAL_USER_ID IS NULL
	BEGIN
		INSERT INTO @ALERTS
		SELECT TOP 25
			ALERT.ALERT_ID, 
			ISNULL(ALERT.[PRIORITY],3), 
			CASE 
				WHEN LEN(ALERT.[SUBJECT]) > 42 THEN SUBSTRING(ALERT.[SUBJECT], 0, 42) + '...' 
				ELSE ALERT.[SUBJECT] 
			END, 
			ALERT.[SUBJECT] 
		FROM   
			ALERT WITH(NOLOCK) 
			INNER JOIN CP_ALERT_RCPT WITH(NOLOCK)  ON  ALERT.ALERT_ID = CP_ALERT_RCPT.ALERT_ID 
		WHERE 
			(ALERT.IS_DRAFT IS NULL OR ALERT.IS_DRAFT = 0) 
			AND  CP_ALERT_RCPT.READ_ALERT IS NULL 
			AND CP_ALERT_RCPT.PROCESSED IS NULL 
			AND CP_ALERT_RCPT.CDP_CONTACT_ID = @CLIENT_PORTAL_USER_ID
		ORDER BY 
			ISNULL(ALERT.LAST_UPDATED, ALERT.GENERATED) DESC, 
			ISNULL(ALERT.[PRIORITY], 3);
		SELECT 
			@COUNT = COUNT(1)
		FROM   
			ALERT WITH(NOLOCK) 
			INNER JOIN CP_ALERT_RCPT WITH(NOLOCK)  ON  ALERT.ALERT_ID = CP_ALERT_RCPT.ALERT_ID 
		WHERE 
			(ALERT.IS_DRAFT IS NULL OR ALERT.IS_DRAFT = 0) 
			AND  CP_ALERT_RCPT.READ_ALERT IS NULL 
			AND CP_ALERT_RCPT.PROCESSED IS NULL 
			AND CP_ALERT_RCPT.CDP_CONTACT_ID = @CLIENT_PORTAL_USER_ID;
	END
	IF NOT @EMP_CODE IS NULL
	BEGIN
		INSERT INTO @ALERTS
		SELECT TOP 25
			ALERT.ALERT_ID, 
			ISNULL(ALERT.[PRIORITY],3), 
			CASE 
				WHEN LEN(ALERT.[SUBJECT]) > 42 THEN SUBSTRING(ALERT.[SUBJECT], 0, 42) + '...' 
				ELSE ALERT.[SUBJECT] 
			END, 
			ALERT.[SUBJECT] 
		FROM   
			ALERT WITH(NOLOCK) 
			INNER JOIN ALERT_RCPT WITH(NOLOCK) ON  ALERT.ALERT_ID = ALERT_RCPT.ALERT_ID 
		WHERE  
			(ALERT.IS_DRAFT IS NULL OR ALERT.IS_DRAFT = 0) 
			AND  ALERT_RCPT.READ_ALERT IS NULL 
			AND ALERT_RCPT.EMP_CODE = @EMP_CODE
		ORDER BY 
			ISNULL(ALERT.LAST_UPDATED, ALERT.GENERATED) DESC, 
			ISNULL(ALERT.[PRIORITY], 3);
		SELECT 
			@COUNT = COUNT(1)
		FROM   
			ALERT WITH(NOLOCK) 
			INNER JOIN ALERT_RCPT WITH(NOLOCK) ON  ALERT.ALERT_ID = ALERT_RCPT.ALERT_ID 
		WHERE  
			(ALERT.IS_DRAFT IS NULL OR ALERT.IS_DRAFT = 0) 
			AND  ALERT_RCPT.READ_ALERT IS NULL 
			AND ALERT_RCPT.EMP_CODE = @EMP_CODE;
	END

	IF @COUNT > 25
	BEGIN
		INSERT INTO @ALERTS (ALERT_ID, [PRIORITY], SHORT_SUBJECT, [SUBJECT]) VALUES ( -1, -1, '...and ' + CAST(@COUNT - 25 AS VARCHAR) + ' more', 
																							  '...and ' + CAST(@COUNT - 25 AS VARCHAR) + ' more')
	END
	SELECT * FROM @ALERTS;

END