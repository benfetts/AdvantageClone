if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_wv_calendar_ddTV]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_wv_calendar_ddTV]
GO





CREATE PROCEDURE [dbo].[usp_wv_calendar_ddTV]
@OrderNumber Int,
@LineNumber Int,
@RevNumber Int,
@Year Int
AS

IF EXISTS (SELECT ORDER_NBR FROM TV_HEADER WHERE ORDER_NBR = @OrderNumber)
BEGIN
	--TV Media Data   
	SELECT     'T' AS Type, 'A' AS EST_ACT, TV_HEADER.OFFICE_CODE, TV_DETAIL1.ORDER_NBR, TV_HEADER.ORDER_DESC, 
                      TV_HEADER.MEDIA_TYPE, TV_HEADER.CL_CODE, TV_HEADER.DIV_CODE, TV_HEADER.PRD_CODE, 
                      TV_HEADER.CMP_IDENTIFIER, CAMPAIGN.CMP_CODE, CAMPAIGN.CMP_NAME, TV_HEADER.VN_CODE, VENDOR.VN_NAME, 
                      TV_HEADER.BUYER, TV_HEADER.CLIENT_PO, TV_HEADER.MARKET_CODE, MARKET.MARKET_DESC, 
                      TV_DETAIL1.LINE_NBR, TV_HEADER.FLIGHT_FROM, TV_HEADER.FLIGHT_TO, TV_DETAIL1.CLOSE_DATE, 
                      TV_DETAIL1.EXT_CLOSE_DATE, TV_DETAIL1.MATL_CLOSE_DATE, TV_DETAIL1.EXT_MATL_DATE, 
                      TV_DETAIL1.START_TIME, TV_DETAIL1.END_TIME, TV_DETAIL1.LENGTH, TV_DETAIL1.TAG, 
                      TV_DETAIL1.PROGRAMMING, TV_DETAIL2.MATL_NOTES, TV_DETAIL1.REMARKS, TV_DETAIL1.JOB_NUMBER, 
                      TV_DETAIL1.JOB_COMPONENT_NBR, TV_HEADER.LINK_ID, TV_DETAIL1.LINE_TOTAL, (SELECT SUM(TOTAL_SPOTS) FROM TV_DETAIL1 WHERE ORDER_NBR = @OrderNumber AND LINE_NBR = @LineNumber) AS TOTAL_SPOTS,  
                      CLIENT.CL_NAME, DIVISION.DIV_NAME, PRODUCT.PRD_DESCRIPTION, VEN_REP_1.VR_FNAME, VEN_REP_1.VR_LNAME, 
                      VEN_REP_1.VR_MI, VEN_REP_1.VR_CODE, VEN_REP.VR_FNAME AS VR_FNAME2, VEN_REP.VR_LNAME AS VR_LNAME2, 
                      VEN_REP.VR_MI AS VR_MI2, VEN_REP.VR_CODE AS VR_CODE2, JOB_COMPONENT.JOB_COMP_DESC, JOB_LOG.JOB_DESC, 
                      TV_HEADER.ORDER_DATE, TV_DETAIL1.REV_NBR, TV_DETAIL1.LINE_CANCELLED, SC.SC_DESCRIPTION, TV_DETAIL1.MAT_COMP, '' AS [START_DATE]
	FROM         TV_HEADER INNER JOIN
                      TV_DETAIL1 ON TV_HEADER.ORDER_NBR = TV_DETAIL1.ORDER_NBR AND 
                      TV_HEADER.REV_NBR = TV_DETAIL1.REV_NBR INNER JOIN
                      TV_DETAIL2 ON TV_DETAIL1.ORDER_NBR = TV_DETAIL2.ORDER_NBR AND 
                      TV_DETAIL1.LINE_NBR = TV_DETAIL2.LINE_NBR AND TV_DETAIL1.REV_NBR = TV_DETAIL2.REV_NBR AND 
                      TV_DETAIL1.SEQ_NBR = TV_DETAIL2.SEQ_NBR AND 
                      TV_DETAIL1.BRDCAST_YEAR = TV_DETAIL2.BRDCAST_YEAR INNER JOIN
                      CLIENT ON TV_HEADER.CL_CODE = CLIENT.CL_CODE INNER JOIN
                      DIVISION ON CLIENT.CL_CODE = DIVISION.CL_CODE INNER JOIN
                      PRODUCT ON TV_HEADER.CL_CODE = PRODUCT.CL_CODE AND TV_HEADER.DIV_CODE = PRODUCT.DIV_CODE AND 
                      TV_HEADER.PRD_CODE = PRODUCT.PRD_CODE AND DIVISION.CL_CODE = PRODUCT.CL_CODE AND 
                      DIVISION.DIV_CODE = PRODUCT.DIV_CODE INNER JOIN
                      VENDOR ON TV_HEADER.VN_CODE = VENDOR.VN_CODE LEFT OUTER JOIN
                      VEN_REP AS VEN_REP_1 ON TV_HEADER.VR_CODE2 = VEN_REP_1.VR_CODE AND 
                      TV_HEADER.VN_CODE = VEN_REP_1.VN_CODE AND TV_HEADER.VN_CODE = VEN_REP_1.VN_CODE LEFT OUTER JOIN
                      VEN_REP ON TV_HEADER.VR_CODE = VEN_REP.VR_CODE AND TV_HEADER.VN_CODE = VEN_REP.VN_CODE AND 
                      TV_HEADER.VN_CODE = VEN_REP.VN_CODE LEFT OUTER JOIN
                      JOB_LOG ON TV_DETAIL1.JOB_NUMBER = JOB_LOG.JOB_NUMBER LEFT OUTER JOIN
                      JOB_COMPONENT ON TV_DETAIL1.JOB_NUMBER = JOB_COMPONENT.JOB_NUMBER AND 
                      TV_DETAIL1.JOB_COMPONENT_NBR = JOB_COMPONENT.JOB_COMPONENT_NBR LEFT OUTER JOIN
                      MARKET ON TV_HEADER.MARKET_CODE = MARKET.MARKET_CODE LEFT OUTER JOIN
                      CAMPAIGN ON TV_HEADER.CMP_IDENTIFIER = CAMPAIGN.CMP_IDENTIFIER LEFT OUTER JOIN
                      SALES_CLASS SC ON TV_HEADER.MEDIA_TYPE = SC.SC_CODE                                                             

	WHERE TV_HEADER.ORDER_NBR = @OrderNumber and TV_DETAIL1.LINE_NBR = @LineNumber and TV_DETAIL1.REV_NBR = @RevNumber and TV_DETAIL1.BRDCAST_YEAR = @Year
END

IF EXISTS (SELECT ORDER_NBR FROM TV_HDR WHERE ORDER_NBR = @OrderNumber) 
BEGIN	
	SELECT     'T' AS Type, 'A' AS EST_ACT, TV_HDR.OFFICE_CODE, TV_DETAIL.ORDER_NBR, TV_HDR.ORDER_DESC, 
                      TV_HDR.MEDIA_TYPE, TV_HDR.CL_CODE, TV_HDR.DIV_CODE, TV_HDR.PRD_CODE, 
                      TV_HDR.CMP_IDENTIFIER, CAMPAIGN.CMP_CODE, CAMPAIGN.CMP_NAME, TV_HDR.VN_CODE, VENDOR.VN_NAME, 
                      TV_HDR.BUYER, TV_HDR.CLIENT_PO, TV_HDR.MARKET_CODE, MARKET.MARKET_DESC, 
                      TV_DETAIL.LINE_NBR, TV_HDR.START_DATE AS FLIGHT_FROM, TV_HDR.END_DATE AS FLIGHT_TO, TV_DETAIL.CLOSE_DATE, 
                      TV_DETAIL.EXT_CLOSE_DATE, TV_DETAIL.MATL_CLOSE_DATE, TV_DETAIL.EXT_MATL_DATE, 
                      TV_DETAIL.START_TIME, TV_DETAIL.END_TIME, TV_DETAIL.LENGTH, TV_DETAIL.TAG, 
                      TV_DETAIL.PROGRAMMING, '' AS MATL_NOTES, TV_DETAIL.REMARKS, TV_DETAIL.JOB_NUMBER, 
                      TV_DETAIL.JOB_COMPONENT_NBR, TV_HDR.LINK_ID, TV_DETAIL.LINE_TOTAL, (SELECT SUM(TOTAL_SPOTS) FROM TV_DETAIL WHERE ORDER_NBR = @OrderNumber AND LINE_NBR = @LineNumber) AS TOTAL_SPOTS,  
                      CLIENT.CL_NAME, DIVISION.DIV_NAME, PRODUCT.PRD_DESCRIPTION, VEN_REP_1.VR_FNAME, VEN_REP_1.VR_LNAME, 
                      VEN_REP_1.VR_MI, VEN_REP_1.VR_CODE, VEN_REP.VR_FNAME AS VR_FNAME2, VEN_REP.VR_LNAME AS VR_LNAME2, 
                      VEN_REP.VR_MI AS VR_MI2, VEN_REP.VR_CODE AS VR_CODE2, JOB_COMPONENT.JOB_COMP_DESC, JOB_LOG.JOB_DESC, 
                      TV_HDR.ORDER_DATE, TV_DETAIL.REV_NBR, TV_DETAIL.LINE_CANCELLED, SC.SC_DESCRIPTION, TV_DETAIL.MAT_COMP, TV_DETAIL.[START_DATE]
	FROM         TV_HDR INNER JOIN
                      TV_DETAIL ON TV_HDR.ORDER_NBR = TV_DETAIL.ORDER_NBR INNER JOIN
                      CLIENT ON TV_HDR.CL_CODE = CLIENT.CL_CODE INNER JOIN
                      DIVISION ON CLIENT.CL_CODE = DIVISION.CL_CODE INNER JOIN
                      PRODUCT ON TV_HDR.CL_CODE = PRODUCT.CL_CODE AND TV_HDR.DIV_CODE = PRODUCT.DIV_CODE AND 
                      TV_HDR.PRD_CODE = PRODUCT.PRD_CODE AND DIVISION.CL_CODE = PRODUCT.CL_CODE AND 
                      DIVISION.DIV_CODE = PRODUCT.DIV_CODE INNER JOIN
                      VENDOR ON TV_HDR.VN_CODE = VENDOR.VN_CODE LEFT OUTER JOIN
                      VEN_REP AS VEN_REP_1 ON TV_HDR.VR_CODE2 = VEN_REP_1.VR_CODE AND 
                      TV_HDR.VN_CODE = VEN_REP_1.VN_CODE AND TV_HDR.VN_CODE = VEN_REP_1.VN_CODE LEFT OUTER JOIN
                      VEN_REP ON TV_HDR.VR_CODE = VEN_REP.VR_CODE AND TV_HDR.VN_CODE = VEN_REP.VN_CODE AND 
                      TV_HDR.VN_CODE = VEN_REP.VN_CODE LEFT OUTER JOIN
                      JOB_LOG ON TV_DETAIL.JOB_NUMBER = JOB_LOG.JOB_NUMBER LEFT OUTER JOIN
                      JOB_COMPONENT ON TV_DETAIL.JOB_NUMBER = JOB_COMPONENT.JOB_NUMBER AND 
                      TV_DETAIL.JOB_COMPONENT_NBR = JOB_COMPONENT.JOB_COMPONENT_NBR LEFT OUTER JOIN
                      MARKET ON TV_HDR.MARKET_CODE = MARKET.MARKET_CODE LEFT OUTER JOIN
                      CAMPAIGN ON TV_HDR.CMP_IDENTIFIER = CAMPAIGN.CMP_IDENTIFIER LEFT OUTER JOIN
                      SALES_CLASS SC ON TV_HDR.MEDIA_TYPE = SC.SC_CODE                                                             

	WHERE TV_HDR.ORDER_NBR = @OrderNumber and TV_DETAIL.LINE_NBR = @LineNumber and TV_DETAIL.REV_NBR = @RevNumber and TV_DETAIL.YEAR_NBR = @Year
END
