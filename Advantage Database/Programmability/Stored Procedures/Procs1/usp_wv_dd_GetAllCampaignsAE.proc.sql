SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS OFF 
GO
IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[usp_wv_dd_GetAllCampaignsAE]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[usp_wv_dd_GetAllCampaignsAE]
GO
CREATE PROCEDURE [dbo].[usp_wv_dd_GetAllCampaignsAE] /*WITH ENCRYPTION*/
@USER_CODE VARCHAR(100),
@OBJECT_ID INT
AS
/*=========== QUERY ===========*/

	DECLARE
		@RESTRICTIONS INT, 
		@EMP_CODE VARCHAR(6),
		@EMPLOYEE_HAS_MGMT_RESTRICTIONS BIT,
		@SQL VARCHAR(MAX), @OfficeCount AS INTEGER;
	        
	SELECT @RESTRICTIONS = COUNT(*) 
	FROM SEC_CLIENT WITH(NOLOCK)
	WHERE UPPER(USER_ID) = UPPER(@USER_CODE);

	SELECT @EMP_CODE = EMP_CODE
	FROM SEC_USER WITH(NOLOCK)
	WHERE UPPER(USER_CODE) = UPPER(@USER_CODE);

	SELECT @EMPLOYEE_HAS_MGMT_RESTRICTIONS = [dbo].[fn_my_objects_employee_has_dynamic_restriction](@EMP_CODE, @OBJECT_ID); 

	SELECT @OfficeCount = COUNT(*) FROM EMP_OFFICE WHERE EMP_CODE = @EMP_CODE;
	
	IF @OBJECT_ID IS NULL OR @OBJECT_ID = 0
	BEGIN
		
		SET @EMPLOYEE_HAS_MGMT_RESTRICTIONS = 0;
		
	END

	If @OfficeCount > 0
	BEGIN

		SET @SQL = '

			SELECT DISTINCT    
				CAMPAIGN.CL_CODE+ '':'' +ISNULL(CAMPAIGN.DIV_CODE,'''')+ '':'' +ISNULL(CAMPAIGN.PRD_CODE,'''')+ '':'' +CAMPAIGN.CMP_CODE+'':'' +CAST(CAMPAIGN.CMP_IDENTIFIER AS VARCHAR) AS Code, 
				CAMPAIGN.CL_CODE+ '' | '' +ISNULL(CAMPAIGN.DIV_CODE,'''')+ '' | '' +ISNULL(CAMPAIGN.PRD_CODE,'''')+ '' | ''  +CMP_CODE + '' - '' + ISNULL(CMP_NAME, '''') AS [Description],
				CAMPAIGN.CL_CODE, CAMPAIGN.DIV_CODE, CAMPAIGN.PRD_CODE, CAMPAIGN.CMP_CODE

			'

	END
	ELSE
	BEGIN

		SET @SQL = '

			SELECT DISTINCT   
				CAMPAIGN.CL_CODE+ '':'' +ISNULL(CAMPAIGN.DIV_CODE,'''')+ '':'' +ISNULL(CAMPAIGN.PRD_CODE,'''')+ '':'' +CAMPAIGN.CMP_CODE+'':'' +CAST(CAMPAIGN.CMP_IDENTIFIER AS VARCHAR) AS Code, 
				CAMPAIGN.CL_CODE+ '' | '' +ISNULL(CAMPAIGN.DIV_CODE,'''')+ '' | '' +ISNULL(CAMPAIGN.PRD_CODE,'''')+ '' | ''  +CMP_CODE + '' - '' + ISNULL(CMP_NAME, '''') AS [Description],
				CAMPAIGN.CL_CODE, CAMPAIGN.DIV_CODE, CAMPAIGN.PRD_CODE, CAMPAIGN.CMP_CODE

			'

	END

	
	IF @RESTRICTIONS > 1
	BEGIN
		SET @SQL = @SQL + '		
				, SEC_CLIENT.CL_CODE, SEC_CLIENT.DIV_CODE, SEC_CLIENT.PRD_CODE
			'
	END
	SET @SQL = @SQL + '			
			FROM        
				CAMPAIGN WITH(NOLOCK) 
			'
	IF @RESTRICTIONS > 0
	BEGIN
		SET @SQL = @SQL + '			
				 INNER JOIN SEC_CLIENT WITH(NOLOCK) ON CAMPAIGN.CL_CODE = SEC_CLIENT.CL_CODE AND CAMPAIGN.DIV_CODE = SEC_CLIENT.DIV_CODE AND 
				CAMPAIGN.PRD_CODE = SEC_CLIENT.PRD_CODE
			'
	END

	If @OfficeCount > 0
	BEGIN

		SET @SQL = @SQL + ' INNER JOIN PRODUCT ON CAMPAIGN.CL_CODE = PRODUCT.CL_CODE 
						AND ( CAMPAIGN.DIV_CODE = PRODUCT.DIV_CODE OR CAMPAIGN.DIV_CODE IS NULL )
						AND ( CAMPAIGN.PRD_CODE = PRODUCT.PRD_CODE OR CAMPAIGN.PRD_CODE IS NULL )
						INNER JOIN EMP_OFFICE ON PRODUCT.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE
						AND EMP_OFFICE.EMP_CODE = ''' + @EMP_CODE + ''' '

	END
	
	IF @EMPLOYEE_HAS_MGMT_RESTRICTIONS = 1
	BEGIN

		SET @SQL = @SQL + ' INNER JOIN [dbo].[fn_my_objects_get_dynamic_restrictions](' + CONVERT(VARCHAR, @OBJECT_ID) + ', ''' + @EMP_CODE + ''') AS DR ON DR.CL_CODE = CAMPAIGN.CL_CODE 
							AND ((DR.DIV_CODE = CAMPAIGN.DIV_CODE) OR (CAMPAIGN.DIV_CODE IS NULL)) 
							AND ((DR.PRD_CODE = CAMPAIGN.PRD_CODE) OR (CAMPAIGN.PRD_CODE IS NULL)) ';
		
	END

	SET @SQL = @SQL + '			
			WHERE     
				CAMPAIGN.CMP_TYPE = 2
				AND (CMP_CLOSED = 0 OR CMP_CLOSED IS NULL)
				'
				
	IF @RESTRICTIONS > 0
	BEGIN
		SET @SQL = @SQL + '				
				AND (UPPER(SEC_CLIENT.USER_ID) = UPPER(''' + @USER_CODE + ''')) AND (SEC_CLIENT.TIME_ENTRY = 0 OR SEC_CLIENT.TIME_ENTRY IS NULL)
			'
	END

	SET @SQL = @SQL + '			
			ORDER BY 
				CAMPAIGN.CL_CODE, CAMPAIGN.DIV_CODE, CAMPAIGN.PRD_CODE, CAMPAIGN.CMP_CODE;

		'

	PRINT(@SQL);
	EXEC(@SQL);

/*=========== QUERY ===========*/
GO
SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO