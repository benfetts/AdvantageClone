
CREATE PROCEDURE [dbo].[usp_wv_dd_GetAllCampaignsWithCDP] 

	@UserID VARCHAR(100)

AS

DECLARE @EMP_CODE AS VARCHAR(6)
DECLARE @OfficeCount AS INTEGER

SELECT @EMP_CODE = EMP_CODE FROM SEC_USER WHERE UPPER(USER_CODE) = UPPER(@UserID)

SELECT @OfficeCount = COUNT(*) FROM EMP_OFFICE WHERE EMP_CODE = @EMP_CODE

DECLARE
    @RESTRICTIONS SMALLINT
        

SELECT @RESTRICTIONS = COUNT(*) FROM SEC_CLIENT WITH(NOLOCK) WHERE UPPER(USER_ID) = UPPER(@UserID);

IF @RESTRICTIONS > 0
	BEGIN
		If @OfficeCount = 0
		Begin
			SELECT     
				CAMPAIGN.CL_CODE+ ':' +ISNULL(CAMPAIGN.DIV_CODE,'')+ ':' +ISNULL(CAMPAIGN.PRD_CODE,'')+ ':' +CAMPAIGN.CMP_CODE+':' +CAST(CAMPAIGN.CMP_IDENTIFIER AS VARCHAR) AS Code, 
				CAMPAIGN.CL_CODE+ ' | ' +ISNULL(CAMPAIGN.DIV_CODE,'')+ ' | ' +ISNULL(CAMPAIGN.PRD_CODE,'')+ ' | '  +CMP_CODE + ' - ' + ISNULL(CMP_NAME, '') AS Description, 
				SEC_CLIENT.CL_CODE, 
				SEC_CLIENT.DIV_CODE, SEC_CLIENT.PRD_CODE
			FROM        
				CAMPAIGN WITH(NOLOCK) INNER JOIN
				SEC_CLIENT WITH(NOLOCK) ON CAMPAIGN.CL_CODE = SEC_CLIENT.CL_CODE AND CAMPAIGN.DIV_CODE = SEC_CLIENT.DIV_CODE AND 
				CAMPAIGN.PRD_CODE = SEC_CLIENT.PRD_CODE
			WHERE     
				CAMPAIGN.CMP_TYPE = 2
				AND (CMP_CLOSED = 0 OR CMP_CLOSED IS NULL )
				AND (UPPER(SEC_CLIENT.USER_ID) = UPPER(@UserID)) AND (SEC_CLIENT.TIME_ENTRY = 0 OR SEC_CLIENT.TIME_ENTRY IS NULL)
			ORDER BY 
				CAMPAIGN.CL_CODE, CAMPAIGN.DIV_CODE, CAMPAIGN.PRD_CODE, CAMPAIGN.CMP_CODE;
		End
		Else
		Begin
			SELECT     
				CAMPAIGN.CL_CODE+ ':' +ISNULL(CAMPAIGN.DIV_CODE,'')+ ':' +ISNULL(CAMPAIGN.PRD_CODE,'')+ ':' +CAMPAIGN.CMP_CODE+':' +CAST(CAMPAIGN.CMP_IDENTIFIER AS VARCHAR) AS Code, 
				CAMPAIGN.CL_CODE+ ' | ' +ISNULL(CAMPAIGN.DIV_CODE,'')+ ' | ' +ISNULL(CAMPAIGN.PRD_CODE,'')+ ' | '  +CMP_CODE + ' - ' + ISNULL(CMP_NAME, '') AS Description, 
				CAMPAIGN.CL_CODE, 
				CAMPAIGN.DIV_CODE, CAMPAIGN.PRD_CODE, CAMPAIGN.CMP_CODE
			FROM        
				CAMPAIGN WITH(NOLOCK) INNER JOIN
				SEC_CLIENT WITH(NOLOCK) ON CAMPAIGN.CL_CODE = SEC_CLIENT.CL_CODE AND CAMPAIGN.DIV_CODE = SEC_CLIENT.DIV_CODE AND 
				CAMPAIGN.PRD_CODE = SEC_CLIENT.PRD_CODE INNER JOIN PRODUCT ON CAMPAIGN.CL_CODE = PRODUCT.CL_CODE 
						AND ( CAMPAIGN.DIV_CODE = PRODUCT.DIV_CODE OR CAMPAIGN.DIV_CODE IS NULL )
						AND ( CAMPAIGN.PRD_CODE = PRODUCT.PRD_CODE OR CAMPAIGN.PRD_CODE IS NULL )
						INNER JOIN EMP_OFFICE ON PRODUCT.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = @EMP_CODE
			WHERE     
				CAMPAIGN.CMP_TYPE = 2
				AND (CMP_CLOSED = 0 OR CMP_CLOSED IS NULL )
				AND (UPPER(SEC_CLIENT.USER_ID) = UPPER(@UserID)) AND (SEC_CLIENT.TIME_ENTRY = 0 OR SEC_CLIENT.TIME_ENTRY IS NULL)
			ORDER BY 
				CAMPAIGN.CL_CODE, CAMPAIGN.DIV_CODE, CAMPAIGN.PRD_CODE, CAMPAIGN.CMP_CODE;
		End
		
	END
ELSE
	BEGIN
		If @OfficeCount = 0
		Begin
			SELECT     
				CL_CODE+ ':' +ISNULL(DIV_CODE,'')+ ':' +ISNULL(PRD_CODE,'')+ ':' +CMP_CODE+':' +CAST(CMP_IDENTIFIER AS VARCHAR) AS Code, 
				CAMPAIGN.CL_CODE+ ' | ' +ISNULL(CAMPAIGN.DIV_CODE,'')+ ' | ' +ISNULL(CAMPAIGN.PRD_CODE,'')+ ' | '  +CMP_CODE + ' - ' + ISNULL(CMP_NAME, '') AS Description, 
				CL_CODE, DIV_CODE, PRD_CODE, CMP_IDENTIFIER
			FROM         
				CAMPAIGN WITH(NOLOCK)
			WHERE     
				CMP_TYPE = 2
			AND (CMP_CLOSED = 0 OR CMP_CLOSED IS NULL )
			ORDER BY
				CAMPAIGN.CL_CODE, CAMPAIGN.DIV_CODE, CAMPAIGN.PRD_CODE, CAMPAIGN.CMP_CODE;
		End
		Else
		Begin
			SELECT DIsTINCT    
				CAMPAIGN.CL_CODE+ ':' +ISNULL(CAMPAIGN.DIV_CODE,'')+ ':' +ISNULL(CAMPAIGN.PRD_CODE,'')+ ':' +CMP_CODE+':' +CAST(CMP_IDENTIFIER AS VARCHAR) AS Code, 
				CAMPAIGN.CL_CODE+ ' | ' +ISNULL(CAMPAIGN.DIV_CODE,'')+ ' | ' +ISNULL(CAMPAIGN.PRD_CODE,'')+ ' | '  +CMP_CODE + ' - ' + ISNULL(CMP_NAME, '') AS Description, 
				CAMPAIGN.CL_CODE, CAMPAIGN.DIV_CODE, CAMPAIGN.PRD_CODE, CMP_IDENTIFIER, CAMPAIGN.CMP_CODE
			FROM         
				CAMPAIGN WITH(NOLOCK) INNER JOIN PRODUCT ON CAMPAIGN.CL_CODE = PRODUCT.CL_CODE 
						AND ( CAMPAIGN.DIV_CODE = PRODUCT.DIV_CODE OR CAMPAIGN.DIV_CODE IS NULL )
						AND ( CAMPAIGN.PRD_CODE = PRODUCT.PRD_CODE OR CAMPAIGN.PRD_CODE IS NULL )
						INNER JOIN EMP_OFFICE ON PRODUCT.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = @EMP_CODE
			WHERE     
				CMP_TYPE = 2
			AND (CMP_CLOSED = 0 OR CMP_CLOSED IS NULL )
			ORDER BY
				CAMPAIGN.CL_CODE, CAMPAIGN.DIV_CODE, CAMPAIGN.PRD_CODE, CAMPAIGN.CMP_CODE;
		End
		
	END

