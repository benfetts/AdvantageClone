





















/*****************************************************************
Gets Divisions for Drop Down
******************************************************************/
CREATE PROCEDURE [dbo].[usp_wv_dd_GetAllDivisions_withclient] 
@UserID VarChar(100)  
AS
Declare @Rescrictions Int

Set NoCount On

DECLARE @EMP_CODE AS VARCHAR(6)
DECLARE @OfficeCount AS INTEGER

SELECT @EMP_CODE = EMP_CODE FROM SEC_USER WHERE UPPER(USER_CODE) = UPPER(@UserID)

SELECT @OfficeCount = COUNT(*) FROM EMP_OFFICE WHERE EMP_CODE = @EMP_CODE

Select @Rescrictions = Count(*) 
FROM SEC_CLIENT
WHERE UPPER(USER_ID) = UPPER(@UserID)

If @Rescrictions > 0
	if @OfficeCount = 0
	Begin
		SELECT     CLIENT.CL_CODE + ':' + DIVISION.DIV_CODE AS Code, CLIENT.CL_CODE + ' | ' + DIVISION.DIV_CODE  + ' - ' + isnull(DIVISION.DIV_NAME, '')  AS Description
		FROM         CLIENT INNER JOIN
							  DIVISION ON CLIENT.CL_CODE = DIVISION.CL_CODE
			INNER JOIN       SEC_CLIENT
				 ON DIVISION.CL_CODE = SEC_CLIENT.CL_CODE AND DIVISION.DIV_CODE = SEC_CLIENT.DIV_CODE
		WHERE     (DIVISION.ACTIVE_FLAG = 1)  AND (UPPER(SEC_CLIENT.USER_ID) = UPPER(@UserID)) AND (SEC_CLIENT.TIME_ENTRY = 0 OR SEC_CLIENT.TIME_ENTRY IS NULL) AND (CLIENT.ACTIVE_FLAG = 1)
		Order By CLIENT.CL_CODE, DIVISION.DIV_CODE
	End
	Else
	Begin
		SELECT DISTINCT CLIENT.CL_CODE + ':' + DIVISION.DIV_CODE AS Code, CLIENT.CL_CODE + ' | ' + DIVISION.DIV_CODE  + ' - ' + isnull(DIVISION.DIV_NAME, '')  AS Description,CLIENT.CL_CODE, DIVISION.DIV_CODE
		FROM         CLIENT INNER JOIN
							  DIVISION ON CLIENT.CL_CODE = DIVISION.CL_CODE INNER JOIN
							   PRODUCT ON DIVISION.CL_CODE = PRODUCT.CL_CODE AND DIVISION.DIV_CODE = PRODUCT.DIV_CODE INNER JOIN 
							   EMP_OFFICE ON PRODUCT.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = @EMP_CODE
			INNER JOIN       SEC_CLIENT
				 ON DIVISION.CL_CODE = SEC_CLIENT.CL_CODE AND DIVISION.DIV_CODE = SEC_CLIENT.DIV_CODE
		WHERE     (DIVISION.ACTIVE_FLAG = 1)  AND (UPPER(SEC_CLIENT.USER_ID) = UPPER(@UserID)) AND (SEC_CLIENT.TIME_ENTRY = 0 OR SEC_CLIENT.TIME_ENTRY IS NULL) AND (CLIENT.ACTIVE_FLAG = 1)
		Order By CLIENT.CL_CODE, DIVISION.DIV_CODE
	End
	

ELSE
	if @OfficeCount = 0
	Begin
		SELECT     CLIENT.CL_CODE + ':' + DIVISION.DIV_CODE AS Code, CLIENT.CL_CODE + ' | ' + DIVISION.DIV_CODE  + ' - ' + isnull(DIVISION.DIV_NAME, '')  AS Description
		FROM         CLIENT INNER JOIN
							  DIVISION ON CLIENT.CL_CODE = DIVISION.CL_CODE
		WHERE     (DIVISION.ACTIVE_FLAG = 1)  AND (CLIENT.ACTIVE_FLAG = 1)
		Order By CLIENT.CL_CODE, DIVISION.DIV_CODE
	End
	Else
	Begin
		SELECT DISTINCT CLIENT.CL_CODE + ':' + DIVISION.DIV_CODE AS Code, CLIENT.CL_CODE + ' | ' + DIVISION.DIV_CODE  + ' - ' + isnull(DIVISION.DIV_NAME, '')  AS Description,CLIENT.CL_CODE, DIVISION.DIV_CODE
		FROM         CLIENT INNER JOIN
							  DIVISION ON CLIENT.CL_CODE = DIVISION.CL_CODE INNER JOIN
							   PRODUCT ON DIVISION.CL_CODE = PRODUCT.CL_CODE AND DIVISION.DIV_CODE = PRODUCT.DIV_CODE INNER JOIN 
							   EMP_OFFICE ON PRODUCT.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = @EMP_CODE
		WHERE     (DIVISION.ACTIVE_FLAG = 1)  AND (CLIENT.ACTIVE_FLAG = 1)
		Order By CLIENT.CL_CODE, DIVISION.DIV_CODE
	End
	





















