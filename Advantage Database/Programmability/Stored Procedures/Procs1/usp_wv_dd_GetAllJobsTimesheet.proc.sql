

/* CHANGE LOG:
==========================================================
BJL, 20060502:
	Changed ORDER BY to descending
JTG, 20090529:
	Change JOB_PROCESS_CONTRL filter to (2,5,6,7,10,11,12) per Ellen
*/

CREATE PROCEDURE [dbo].[usp_wv_dd_GetAllJobsTimesheet] 
@UserID VarChar(100),
@From varchar(100)
AS
Declare @Restrictions Int

Set NoCount On

DECLARE @EMP_CODE AS VARCHAR(6)
DECLARE @OfficeCount AS INTEGER

SELECT @EMP_CODE = EMP_CODE FROM SEC_USER WHERE UPPER(USER_CODE) = UPPER(@UserID)

SELECT @OfficeCount = COUNT(*) FROM EMP_OFFICE WHERE EMP_CODE = @EMP_CODE

Select @Restrictions = Count(*) 
FROM SEC_CLIENT
WHERE UPPER(USER_ID) = UPPER(@UserID)

if @From = 'taskfilter' or @From = 'newalert' or @From = 'alertinbox'
Begin
	If @Restrictions > 0
		if @OfficeCount = 0
		Begin
			SELECT     JOB_LOG.JOB_NUMBER AS Code, LTRIM(STR(JOB_LOG.JOB_NUMBER)) + ' - ' +isnull(JOB_LOG.JOB_DESC, '') 
					 + ' | ' + JOB_LOG.CL_CODE + ' - ' + JOB_LOG.DIV_CODE + ' - ' + JOB_LOG.PRD_CODE + '' AS Description
			FROM         JOB_LOG INNER JOIN
								  JOB_COMPONENT ON JOB_LOG.JOB_NUMBER = JOB_COMPONENT.JOB_NUMBER INNER JOIN
								  SEC_CLIENT ON JOB_LOG.CL_CODE = SEC_CLIENT.CL_CODE AND JOB_LOG.DIV_CODE = SEC_CLIENT.DIV_CODE AND 
								  JOB_LOG.PRD_CODE = SEC_CLIENT.PRD_CODE
			WHERE     (JOB_COMPONENT.JOB_PROCESS_CONTRL NOT IN (2,3,5,6,9,10,12,13)) AND (UPPER(SEC_CLIENT.USER_ID) = UPPER(@UserID)) AND (SEC_CLIENT.TIME_ENTRY = 0 OR SEC_CLIENT.TIME_ENTRY IS NULL)
			--And JOB_TRAFFIC.COMPLETED_DATE IS NULL
			GROUP BY JOB_LOG.JOB_NUMBER, JOB_LOG.JOB_DESC, SEC_CLIENT.USER_ID, JOB_LOG.CL_CODE, JOB_LOG.DIV_CODE, JOB_LOG.PRD_CODE
			ORDER BY JOB_LOG.JOB_NUMBER DESC
		End
		Else
		Begin
			SELECT     JOB_LOG.JOB_NUMBER AS Code, LTRIM(STR(JOB_LOG.JOB_NUMBER)) + ' - ' +isnull(JOB_LOG.JOB_DESC, '') 
					 + ' | ' + JOB_LOG.CL_CODE + ' - ' + JOB_LOG.DIV_CODE + ' - ' + JOB_LOG.PRD_CODE + '' AS Description
			FROM         JOB_LOG INNER JOIN
								  JOB_COMPONENT ON JOB_LOG.JOB_NUMBER = JOB_COMPONENT.JOB_NUMBER INNER JOIN
								  SEC_CLIENT ON JOB_LOG.CL_CODE = SEC_CLIENT.CL_CODE AND JOB_LOG.DIV_CODE = SEC_CLIENT.DIV_CODE AND 
								  JOB_LOG.PRD_CODE = SEC_CLIENT.PRD_CODE INNER JOIN EMP_OFFICE as EMP_OFFICE ON EMP_OFFICE.OFFICE_CODE = JOB_LOG.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = @EMP_CODE
			WHERE     (JOB_COMPONENT.JOB_PROCESS_CONTRL NOT IN (2,3,5,6,9,10,12,13)) AND (UPPER(SEC_CLIENT.USER_ID) = UPPER(@UserID)) AND (SEC_CLIENT.TIME_ENTRY = 0 OR SEC_CLIENT.TIME_ENTRY IS NULL)
			--And JOB_TRAFFIC.COMPLETED_DATE IS NULL
			GROUP BY JOB_LOG.JOB_NUMBER, JOB_LOG.JOB_DESC, SEC_CLIENT.USER_ID, JOB_LOG.CL_CODE, JOB_LOG.DIV_CODE, JOB_LOG.PRD_CODE
			ORDER BY JOB_LOG.JOB_NUMBER DESC
		End		
	ELSE
		if @OfficeCount = 0
		Begin
			SELECT     JOB_LOG.JOB_NUMBER AS Code, LTRIM(STR(JOB_LOG.JOB_NUMBER)) + ' - ' +isnull(JOB_LOG.JOB_DESC, '') 
					 + ' | ' + JOB_LOG.CL_CODE + ' - ' + JOB_LOG.DIV_CODE + ' - ' + JOB_LOG.PRD_CODE + '' AS Description
			FROM         JOB_LOG 
					 INNER JOIN
								  JOB_COMPONENT ON JOB_LOG.JOB_NUMBER = JOB_COMPONENT.JOB_NUMBER 
			WHERE     (JOB_COMPONENT.JOB_PROCESS_CONTRL NOT IN (2,3,5,6,9,10,12,13)) 
			--And JOB_TRAFFIC.COMPLETED_DATE IS NULL
			GROUP BY JOB_LOG.JOB_NUMBER, JOB_LOG.JOB_DESC,  JOB_LOG.CL_CODE, JOB_LOG.DIV_CODE, JOB_LOG.PRD_CODE
			ORDER BY JOB_LOG.JOB_NUMBER DESC
		End
		Else
		Begin
			SELECT     JOB_LOG.JOB_NUMBER AS Code, LTRIM(STR(JOB_LOG.JOB_NUMBER)) + ' - ' +isnull(JOB_LOG.JOB_DESC, '') 
					 + ' | ' + JOB_LOG.CL_CODE + ' - ' + JOB_LOG.DIV_CODE + ' - ' + JOB_LOG.PRD_CODE + '' AS Description
			FROM         JOB_LOG 
					 INNER JOIN
								  JOB_COMPONENT ON JOB_LOG.JOB_NUMBER = JOB_COMPONENT.JOB_NUMBER 
								   INNER JOIN EMP_OFFICE as EMP_OFFICE ON EMP_OFFICE.OFFICE_CODE = JOB_LOG.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = @EMP_CODE
			WHERE     (JOB_COMPONENT.JOB_PROCESS_CONTRL NOT IN (2,3,5,6,9,10,12,13)) 
			--And JOB_TRAFFIC.COMPLETED_DATE IS NULL
			GROUP BY JOB_LOG.JOB_NUMBER, JOB_LOG.JOB_DESC,  JOB_LOG.CL_CODE, JOB_LOG.DIV_CODE, JOB_LOG.PRD_CODE
			ORDER BY JOB_LOG.JOB_NUMBER DESC
		End
		
End
Else
Begin
	If @Restrictions > 0
		if @OfficeCount = 0
		Begin
			SELECT     JOB_LOG.JOB_NUMBER AS Code, LTRIM(STR(JOB_LOG.JOB_NUMBER)) + ' - ' +isnull(JOB_LOG.JOB_DESC, '') 
					 + ' | ' + JOB_LOG.CL_CODE + ' - ' + JOB_LOG.DIV_CODE + ' - ' + JOB_LOG.PRD_CODE + '' AS Description
			FROM         JOB_LOG INNER JOIN
								  JOB_COMPONENT ON JOB_LOG.JOB_NUMBER = JOB_COMPONENT.JOB_NUMBER INNER JOIN
								  SEC_CLIENT ON JOB_LOG.CL_CODE = SEC_CLIENT.CL_CODE AND JOB_LOG.DIV_CODE = SEC_CLIENT.DIV_CODE AND 
								  JOB_LOG.PRD_CODE = SEC_CLIENT.PRD_CODE
			WHERE     (JOB_COMPONENT.JOB_PROCESS_CONTRL NOT IN (2,3,5,6,9,10,12,13)) AND (UPPER(SEC_CLIENT.USER_ID) = UPPER(@UserID))
			--And JOB_TRAFFIC.COMPLETED_DATE IS NULL
			GROUP BY JOB_LOG.JOB_NUMBER, JOB_LOG.JOB_DESC, SEC_CLIENT.USER_ID, JOB_LOG.CL_CODE, JOB_LOG.DIV_CODE, JOB_LOG.PRD_CODE
			ORDER BY JOB_LOG.JOB_NUMBER DESC
		End
		Else
		Begin
			SELECT     JOB_LOG.JOB_NUMBER AS Code, LTRIM(STR(JOB_LOG.JOB_NUMBER)) + ' - ' +isnull(JOB_LOG.JOB_DESC, '') 
					 + ' | ' + JOB_LOG.CL_CODE + ' - ' + JOB_LOG.DIV_CODE + ' - ' + JOB_LOG.PRD_CODE + '' AS Description
			FROM         JOB_LOG INNER JOIN
								  JOB_COMPONENT ON JOB_LOG.JOB_NUMBER = JOB_COMPONENT.JOB_NUMBER INNER JOIN
								  SEC_CLIENT ON JOB_LOG.CL_CODE = SEC_CLIENT.CL_CODE AND JOB_LOG.DIV_CODE = SEC_CLIENT.DIV_CODE AND 
								  JOB_LOG.PRD_CODE = SEC_CLIENT.PRD_CODE INNER JOIN EMP_OFFICE as EMP_OFFICE ON EMP_OFFICE.OFFICE_CODE = JOB_LOG.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = @EMP_CODE
			WHERE     (JOB_COMPONENT.JOB_PROCESS_CONTRL NOT IN (2,3,5,6,9,10,12,13)) AND (UPPER(SEC_CLIENT.USER_ID) = UPPER(@UserID))
			--And JOB_TRAFFIC.COMPLETED_DATE IS NULL
			GROUP BY JOB_LOG.JOB_NUMBER, JOB_LOG.JOB_DESC, SEC_CLIENT.USER_ID, JOB_LOG.CL_CODE, JOB_LOG.DIV_CODE, JOB_LOG.PRD_CODE
			ORDER BY JOB_LOG.JOB_NUMBER DESC
		End
		
	ELSE
		if @OfficeCount = 0
		Begin
			SELECT     JOB_LOG.JOB_NUMBER AS Code, LTRIM(STR(JOB_LOG.JOB_NUMBER)) + ' - ' +isnull(JOB_LOG.JOB_DESC, '') 
					 + ' | ' + JOB_LOG.CL_CODE + ' - ' + JOB_LOG.DIV_CODE + ' - ' + JOB_LOG.PRD_CODE + '' AS Description
			FROM         JOB_LOG 
					 INNER JOIN
								  JOB_COMPONENT ON JOB_LOG.JOB_NUMBER = JOB_COMPONENT.JOB_NUMBER 
			WHERE     (JOB_COMPONENT.JOB_PROCESS_CONTRL NOT IN (2,3,5,6,9,10,12,13)) 
			--And JOB_TRAFFIC.COMPLETED_DATE IS NULL
			GROUP BY JOB_LOG.JOB_NUMBER, JOB_LOG.JOB_DESC,  JOB_LOG.CL_CODE, JOB_LOG.DIV_CODE, JOB_LOG.PRD_CODE
			ORDER BY JOB_LOG.JOB_NUMBER DESC
		End
		Else
		Begin
			SELECT     JOB_LOG.JOB_NUMBER AS Code, LTRIM(STR(JOB_LOG.JOB_NUMBER)) + ' - ' +isnull(JOB_LOG.JOB_DESC, '') 
					 + ' | ' + JOB_LOG.CL_CODE + ' - ' + JOB_LOG.DIV_CODE + ' - ' + JOB_LOG.PRD_CODE + '' AS Description
			FROM         JOB_LOG 
					 INNER JOIN
								  JOB_COMPONENT ON JOB_LOG.JOB_NUMBER = JOB_COMPONENT.JOB_NUMBER 
								   INNER JOIN EMP_OFFICE as EMP_OFFICE ON EMP_OFFICE.OFFICE_CODE = JOB_LOG.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = @EMP_CODE
			WHERE     (JOB_COMPONENT.JOB_PROCESS_CONTRL NOT IN (2,3,5,6,9,10,12,13)) 
			--And JOB_TRAFFIC.COMPLETED_DATE IS NULL
			GROUP BY JOB_LOG.JOB_NUMBER, JOB_LOG.JOB_DESC,  JOB_LOG.CL_CODE, JOB_LOG.DIV_CODE, JOB_LOG.PRD_CODE
			ORDER BY JOB_LOG.JOB_NUMBER DESC
		End
		
End







