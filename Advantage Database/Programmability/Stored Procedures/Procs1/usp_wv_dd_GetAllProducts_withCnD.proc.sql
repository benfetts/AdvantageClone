





















CREATE PROCEDURE [dbo].[usp_wv_dd_GetAllProducts_withCnD] 
@UserID VarChar(100)  
AS
Declare @Rescrictions Int

Set NoCount On

DECLARE @EMP_CODE AS VARCHAR(6)
DECLARE @OfficeCount AS INTEGER

SELECT @EMP_CODE = EMP_CODE FROM SEC_USER WHERE UPPER(USER_CODE) = UPPER(@UserID)

SELECT @OfficeCount = COUNT(*) FROM EMP_OFFICE WHERE EMP_CODE = @EMP_CODE

Select @Rescrictions = Count(*) 
FROM SEC_CLIENT
WHERE UPPER(USER_ID) = UPPER(@UserID)

If @Rescrictions > 0
	If @OfficeCount = 0
	Begin
		SELECT     CLIENT.CL_CODE + ':' + DIVISION.DIV_CODE + ':' + PRODUCT.PRD_CODE AS Code, 
							  CLIENT.CL_CODE + ' | ' + DIVISION.DIV_CODE + ' | ' + PRODUCT.PRD_CODE + ' - ' + ISNULL(PRODUCT.PRD_DESCRIPTION, '') AS Description
		FROM         CLIENT INNER JOIN
							  DIVISION ON CLIENT.CL_CODE = DIVISION.CL_CODE INNER JOIN
							  PRODUCT ON DIVISION.CL_CODE = PRODUCT.CL_CODE AND DIVISION.DIV_CODE = PRODUCT.DIV_CODE INNER JOIN
							  SEC_CLIENT ON PRODUCT.CL_CODE = SEC_CLIENT.CL_CODE AND PRODUCT.DIV_CODE = SEC_CLIENT.DIV_CODE AND 
							  PRODUCT.PRD_CODE = SEC_CLIENT.PRD_CODE
		WHERE     (PRODUCT.ACTIVE_FLAG = 1) AND (UPPER(SEC_CLIENT.USER_ID) = UPPER(@UserID)) AND (SEC_CLIENT.TIME_ENTRY = 0 OR SEC_CLIENT.TIME_ENTRY IS NULL)
						AND (DIVISION.ACTIVE_FLAG = 1)
					AND (CLIENT.ACTIVE_FLAG = 1)

		ORDER BY CLIENT.CL_CODE, DIVISION.DIV_CODE, PRODUCT.PRD_CODE
	End
	Else
	Begin
		SELECT     CLIENT.CL_CODE + ':' + DIVISION.DIV_CODE + ':' + PRODUCT.PRD_CODE AS Code, 
							  CLIENT.CL_CODE + ' | ' + DIVISION.DIV_CODE + ' | ' + PRODUCT.PRD_CODE + ' - ' + ISNULL(PRODUCT.PRD_DESCRIPTION, '') AS Description
		FROM         CLIENT INNER JOIN
							  DIVISION ON CLIENT.CL_CODE = DIVISION.CL_CODE INNER JOIN
							  PRODUCT ON DIVISION.CL_CODE = PRODUCT.CL_CODE AND DIVISION.DIV_CODE = PRODUCT.DIV_CODE INNER JOIN
							  SEC_CLIENT ON PRODUCT.CL_CODE = SEC_CLIENT.CL_CODE AND PRODUCT.DIV_CODE = SEC_CLIENT.DIV_CODE AND 
							  PRODUCT.PRD_CODE = SEC_CLIENT.PRD_CODE INNER JOIN 
							   EMP_OFFICE ON PRODUCT.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = @EMP_CODE
		WHERE     (PRODUCT.ACTIVE_FLAG = 1) AND (UPPER(SEC_CLIENT.USER_ID) = UPPER(@UserID)) AND (SEC_CLIENT.TIME_ENTRY = 0 OR SEC_CLIENT.TIME_ENTRY IS NULL)
						AND (DIVISION.ACTIVE_FLAG = 1)
					AND (CLIENT.ACTIVE_FLAG = 1)

		ORDER BY CLIENT.CL_CODE, DIVISION.DIV_CODE, PRODUCT.PRD_CODE
	End
	
ELSE
	If @OfficeCount = 0
	Begin
		SELECT     CLIENT.CL_CODE + ':' + DIVISION.DIV_CODE + ':' + PRODUCT.PRD_CODE AS Code, 
							  CLIENT.CL_CODE + ' | ' + DIVISION.DIV_CODE + ' | ' + PRODUCT.PRD_CODE + ' - ' + ISNULL(PRODUCT.PRD_DESCRIPTION, '') AS Description
		FROM         CLIENT INNER JOIN
							  DIVISION ON CLIENT.CL_CODE = DIVISION.CL_CODE INNER JOIN
							  PRODUCT ON DIVISION.CL_CODE = PRODUCT.CL_CODE AND DIVISION.DIV_CODE = PRODUCT.DIV_CODE
		WHERE     (PRODUCT.ACTIVE_FLAG = 1)
						AND (DIVISION.ACTIVE_FLAG = 1)
					AND (CLIENT.ACTIVE_FLAG = 1)

		ORDER BY CLIENT.CL_CODE, DIVISION.DIV_CODE, PRODUCT.PRD_CODE
	End
	Else
	Begin
		SELECT     CLIENT.CL_CODE + ':' + DIVISION.DIV_CODE + ':' + PRODUCT.PRD_CODE AS Code, 
							  CLIENT.CL_CODE + ' | ' + DIVISION.DIV_CODE + ' | ' + PRODUCT.PRD_CODE + ' - ' + ISNULL(PRODUCT.PRD_DESCRIPTION, '') AS Description
		FROM         CLIENT INNER JOIN
							  DIVISION ON CLIENT.CL_CODE = DIVISION.CL_CODE INNER JOIN
							  PRODUCT ON DIVISION.CL_CODE = PRODUCT.CL_CODE AND DIVISION.DIV_CODE = PRODUCT.DIV_CODE INNER JOIN 
							   EMP_OFFICE ON PRODUCT.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = @EMP_CODE
		WHERE     (PRODUCT.ACTIVE_FLAG = 1)
						AND (DIVISION.ACTIVE_FLAG = 1)
					AND (CLIENT.ACTIVE_FLAG = 1)

		ORDER BY CLIENT.CL_CODE, DIVISION.DIV_CODE, PRODUCT.PRD_CODE
	End
	

















