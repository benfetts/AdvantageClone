IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[usp_wv_dd_GetDivisions]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
    DROP PROCEDURE [dbo].[usp_wv_dd_GetDivisions]
GO
/*
	exec usp_wv_dd_GetDivisions 'ama','','','',0,'ab'
*/
CREATE PROCEDURE [dbo].[usp_wv_dd_GetDivisions] 
			@UserID VarChar(100) , 
			@ClientCode VarChar(6),
			@FromApp VarChar(6),
			@OfficeCode  VarChar(6) = null,
			@SprintID int = 0,
			@Text VARCHAR(100) = ''
AS
/*=========== QUERY ===========*/

	DECLARE @Restrictions INT
	
	SET NOCOUNT ON

	DECLARE @EMP_CODE AS VARCHAR(6)
	DECLARE @OfficeCount AS INTEGER

	SELECT @EMP_CODE = EMP_CODE FROM SEC_USER WHERE UPPER(USER_CODE) = UPPER(@UserID)

	SELECT @OfficeCount = COUNT(*) FROM EMP_OFFICE WHERE EMP_CODE = @EMP_CODE
	
	SELECT @Restrictions = COUNT(1)
	FROM   SEC_CLIENT WITH(NOLOCK)
	WHERE  UPPER(USER_ID) = UPPER(@UserID);
	
	SET @ClientCode = ISNULL(RTRIM(LTRIM(@ClientCode)), '');

	IF @ClientCode = ''
		SET @ClientCode = null

	IF @OfficeCode = ''
		SET @OfficeCode = null
	
	IF @FromApp = 'ts'
	BEGIN
		IF @OfficeCount = 0
		BEGIN
			IF @Restrictions > 0
			BEGIN
				SELECT DISTINCT DIVISION.DIV_CODE AS Code,
						DIVISION.DIV_CODE + ' - ' + ISNULL(DIVISION.DIV_NAME, '') + ' | ' + ISNULL(CLIENT.CL_CODE,'') AS 
						DESCRIPTION,
						CLIENT.CL_CODE
						,DIVISION.DIV_NAME Name
				FROM   CLIENT
						INNER JOIN DIVISION
							ON  CLIENT.CL_CODE = DIVISION.CL_CODE
						INNER JOIN SEC_CLIENT
							ON  DIVISION.CL_CODE = SEC_CLIENT.CL_CODE
							AND DIVISION.DIV_CODE = SEC_CLIENT.DIV_CODE
				WHERE  (DIVISION.ACTIVE_FLAG = 1)
						AND (CLIENT.CL_CODE = ISNULL(@ClientCode,CLIENT.CL_CODE))
						AND (UPPER(SEC_CLIENT.USER_ID) = UPPER(@UserID))
						AND (CLIENT.ACTIVE_FLAG = 1)
						AND LOWER(DIVISION.DIV_NAME + ' (' + DIVISION.DIV_CODE + ')') LIKE '%' + LOWER(@Text) + '%'
				ORDER BY DIVISION.DIV_NAME
			END
			ELSE
			BEGIN
				SELECT DISTINCT DIVISION.DIV_CODE AS Code,
						DIVISION.DIV_CODE + ' - ' + ISNULL(DIVISION.DIV_NAME, '') + ' | ' + ISNULL(CLIENT.CL_CODE,'') AS 
						DESCRIPTION,
						CLIENT.CL_CODE
						,DIVISION.DIV_NAME Name
				FROM   CLIENT
						INNER JOIN DIVISION
							ON  CLIENT.CL_CODE = DIVISION.CL_CODE
				WHERE  (DIVISION.ACTIVE_FLAG = 1)
						AND (CLIENT.ACTIVE_FLAG = 1)
						AND (CLIENT.CL_CODE = ISNULL(@ClientCode,CLIENT.CL_CODE))
						AND LOWER(DIVISION.DIV_NAME + ' (' + DIVISION.DIV_CODE + ')') LIKE '%' + LOWER(@Text) + '%'
				ORDER BY DIVISION.DIV_NAME
			END
		END
		ELSE
		BEGIN
			IF @Restrictions > 0
			BEGIN
				SELECT DISTINCT DIVISION.DIV_CODE AS Code,
						DIVISION.DIV_CODE + ' - ' + ISNULL(DIVISION.DIV_NAME, '') + ' | ' + ISNULL(CLIENT.CL_CODE,'') AS 
						DESCRIPTION,
						CLIENT.CL_CODE
						,DIVISION.DIV_NAME Name
				FROM   CLIENT
						INNER JOIN DIVISION
							ON  CLIENT.CL_CODE = DIVISION.CL_CODE
						INNER JOIN SEC_CLIENT
							ON  DIVISION.CL_CODE = SEC_CLIENT.CL_CODE
							AND DIVISION.DIV_CODE = SEC_CLIENT.DIV_CODE
						INNER JOIN
								PRODUCT ON DIVISION.CL_CODE = PRODUCT.CL_CODE AND DIVISION.DIV_CODE = PRODUCT.DIV_CODE 
						INNER JOIN 
								EMP_OFFICE ON PRODUCT.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = @EMP_CODE
				WHERE  (DIVISION.ACTIVE_FLAG = 1)
						AND (CLIENT.CL_CODE = ISNULL(@ClientCode,CLIENT.CL_CODE))
						AND (UPPER(SEC_CLIENT.USER_ID) = UPPER(@UserID))
						AND (CLIENT.ACTIVE_FLAG = 1)
						AND LOWER(DIVISION.DIV_NAME + ' (' + DIVISION.DIV_CODE + ')') LIKE '%' + LOWER(@Text) + '%'
				ORDER BY DIVISION.DIV_NAME
			END
			ELSE
			BEGIN
				SELECT DISTINCT DIVISION.DIV_CODE AS Code,
						DIVISION.DIV_CODE + ' - ' + ISNULL(DIVISION.DIV_NAME, '') + ' | ' + ISNULL(CLIENT.CL_CODE,'') AS 
						DESCRIPTION,
						CLIENT.CL_CODE
						,DIVISION.DIV_NAME Name
				FROM   CLIENT
						INNER JOIN DIVISION
							ON  CLIENT.CL_CODE = DIVISION.CL_CODE
							INNER JOIN
									PRODUCT ON DIVISION.CL_CODE = PRODUCT.CL_CODE AND DIVISION.DIV_CODE = PRODUCT.DIV_CODE 
						INNER JOIN 
								EMP_OFFICE ON PRODUCT.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = @EMP_CODE
				WHERE  (DIVISION.ACTIVE_FLAG = 1)
						AND (CLIENT.ACTIVE_FLAG = 1)
						AND (CLIENT.CL_CODE = ISNULL(@ClientCode,CLIENT.CL_CODE))
						AND LOWER(DIVISION.DIV_NAME + ' (' + DIVISION.DIV_CODE + ')') LIKE '%' + LOWER(@Text) + '%'
				ORDER BY DIVISION.DIV_NAME
			END
		END

	END	
	Else if @FromApp = 'util'
	Begin
		IF @SprintID = 0
		BEGIN
			IF @Restrictions > 0
			BEGIN
				If @OfficeCount = 0
				Begin
					SELECT DISTINCT TOP 100 DIVISION.DIV_CODE AS Code,
						   DIVISION.DIV_CODE + ' - ' + ISNULL(DIVISION.DIV_NAME, '') + ' | ' + ISNULL(CLIENT.CL_CODE,'') AS 
						   DESCRIPTION,
						   CLIENT.CL_CODE
					   ,DIVISION.DIV_NAME Name
					FROM   CLIENT
						   INNER JOIN DIVISION
								ON  CLIENT.CL_CODE = DIVISION.CL_CODE
						   INNER JOIN SEC_CLIENT
								ON  DIVISION.CL_CODE = SEC_CLIENT.CL_CODE
								AND DIVISION.DIV_CODE = SEC_CLIENT.DIV_CODE
						   INNER JOIN
								   PRODUCT ON DIVISION.CL_CODE = PRODUCT.CL_CODE AND DIVISION.DIV_CODE = PRODUCT.DIV_CODE 
					WHERE  (DIVISION.ACTIVE_FLAG = 1)
						   AND (CLIENT.CL_CODE = ISNULL(@ClientCode,CLIENT.CL_CODE))
						   AND (UPPER(SEC_CLIENT.USER_ID) = UPPER(@UserID)) AND (SEC_CLIENT.TIME_ENTRY = 0 OR SEC_CLIENT.TIME_ENTRY IS NULL)
						   AND PRODUCT.OFFICE_CODE = ISNULL(@OfficeCode,PRODUCT.OFFICE_CODE)
						   AND (CLIENT.ACTIVE_FLAG = 1)
						   AND LOWER(DIVISION.DIV_NAME + ' (' + DIVISION.DIV_CODE + ')') LIKE '%' + LOWER(@Text) + '%'
					ORDER BY DIVISION.DIV_NAME
				End
				Else
				Begin
					SELECT DISTINCT TOP 100 DIVISION.DIV_CODE AS Code,
						   DIVISION.DIV_CODE + ' - ' + ISNULL(DIVISION.DIV_NAME, '') + ' | ' + ISNULL(CLIENT.CL_CODE,'') AS 
						   DESCRIPTION,
						   CLIENT.CL_CODE
					   ,DIVISION.DIV_NAME Name
					FROM   CLIENT
						   INNER JOIN DIVISION
								ON  CLIENT.CL_CODE = DIVISION.CL_CODE
						   INNER JOIN
								   PRODUCT ON DIVISION.CL_CODE = PRODUCT.CL_CODE AND DIVISION.DIV_CODE = PRODUCT.DIV_CODE 
						   INNER JOIN 
								   EMP_OFFICE ON PRODUCT.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = @EMP_CODE
						   INNER JOIN SEC_CLIENT
								ON  DIVISION.CL_CODE = SEC_CLIENT.CL_CODE
								AND DIVISION.DIV_CODE = SEC_CLIENT.DIV_CODE
					WHERE  (DIVISION.ACTIVE_FLAG = 1)
						   AND (CLIENT.CL_CODE = ISNULL(@ClientCode,CLIENT.CL_CODE))
						   AND (UPPER(SEC_CLIENT.USER_ID) = UPPER(@UserID)) AND (SEC_CLIENT.TIME_ENTRY = 0 OR SEC_CLIENT.TIME_ENTRY IS NULL)
						   AND PRODUCT.OFFICE_CODE = ISNULL(@OfficeCode,PRODUCT.OFFICE_CODE)
						   AND (CLIENT.ACTIVE_FLAG = 1)
						   AND LOWER(DIVISION.DIV_NAME + ' (' + DIVISION.DIV_CODE + ')') LIKE '%' + LOWER(@Text) + '%'
					ORDER BY DIVISION.DIV_NAME
				End
			END
			ELSE
			BEGIN
				If @OfficeCount = 0
				Begin
					SELECT DISTINCT TOP 100 DIVISION.DIV_CODE AS Code,
					   DIVISION.DIV_CODE + ' - ' + ISNULL(DIVISION.DIV_NAME, '') + ' | ' + ISNULL(CLIENT.CL_CODE,'') AS 
					   DESCRIPTION,
					   CLIENT.CL_CODE
					   ,DIVISION.DIV_NAME Name
					FROM   CLIENT
						   INNER JOIN DIVISION
								ON  CLIENT.CL_CODE = DIVISION.CL_CODE
							INNER JOIN
									PRODUCT ON DIVISION.CL_CODE = PRODUCT.CL_CODE AND DIVISION.DIV_CODE = PRODUCT.DIV_CODE 
					WHERE  (DIVISION.ACTIVE_FLAG = 1)
						   AND (CLIENT.ACTIVE_FLAG = 1)
						   AND PRODUCT.OFFICE_CODE = ISNULL(@OfficeCode,PRODUCT.OFFICE_CODE)
						   AND (CLIENT.CL_CODE = ISNULL(@ClientCode,CLIENT.CL_CODE))
						   AND LOWER(DIVISION.DIV_NAME + ' (' + DIVISION.DIV_CODE + ')') LIKE '%' + LOWER(@Text) + '%'
					ORDER BY DIVISION.DIV_NAME
				End
				Else
				Begin
					SELECT DISTINCT TOP 100 DIVISION.DIV_CODE AS Code,
						   DIVISION.DIV_CODE + ' - ' + ISNULL(DIVISION.DIV_NAME, '') + ' | ' + ISNULL(CLIENT.CL_CODE,'') AS 
						   DESCRIPTION,
						   CLIENT.CL_CODE
					   ,DIVISION.DIV_NAME Name
					FROM   CLIENT
						   INNER JOIN DIVISION
								ON  CLIENT.CL_CODE = DIVISION.CL_CODE
						   INNER JOIN
								   PRODUCT ON DIVISION.CL_CODE = PRODUCT.CL_CODE AND DIVISION.DIV_CODE = PRODUCT.DIV_CODE 
						   INNER JOIN 
								   EMP_OFFICE ON PRODUCT.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = @EMP_CODE
					WHERE  (DIVISION.ACTIVE_FLAG = 1)
						   AND (CLIENT.ACTIVE_FLAG = 1)
						   AND PRODUCT.OFFICE_CODE = ISNULL(@OfficeCode,PRODUCT.OFFICE_CODE)
						   AND (CLIENT.CL_CODE = ISNULL(@ClientCode,CLIENT.CL_CODE))
						   AND LOWER(DIVISION.DIV_NAME + ' (' + DIVISION.DIV_CODE + ')') LIKE '%' + LOWER(@Text) + '%'
					ORDER BY DIVISION.DIV_NAME
				End
			END
		end
		ELSE
		BEGIN
			IF @Restrictions > 0
			BEGIN
				If @OfficeCount = 0
				Begin
					SELECT DISTINCT TOP 100 DIVISION.DIV_CODE AS Code,
						   DIVISION.DIV_CODE + ' - ' + ISNULL(DIVISION.DIV_NAME, '') + ' | ' + ISNULL(CLIENT.CL_CODE,'') AS 
						   DESCRIPTION,
						   CLIENT.CL_CODE
					   ,DIVISION.DIV_NAME Name
					FROM   SPRINT_HDR
							inner JOIN BOARD on BOARD.ID = SPRINT_HDR.BOARD_ID
							inner join BOARD_JOB on BOARD.ID = BOARD_JOB.BOARD_ID
							inner join JOB_LOG on JOB_LOG.JOB_NUMBER = BOARD_JOB.JOB_NUMBER
							inner join CLIENT ON JOB_LOG.CL_CODE = CLIENT.CL_CODE
							INNER JOIN DIVISION	ON  CLIENT.CL_CODE = DIVISION.CL_CODE
							INNER JOIN SEC_CLIENT ON  DIVISION.CL_CODE = SEC_CLIENT.CL_CODE	AND DIVISION.DIV_CODE = SEC_CLIENT.DIV_CODE
							INNER JOIN PRODUCT ON DIVISION.CL_CODE = PRODUCT.CL_CODE AND DIVISION.DIV_CODE = PRODUCT.DIV_CODE 
					WHERE  (DIVISION.ACTIVE_FLAG = 1)
						   AND (CLIENT.CL_CODE = ISNULL(@ClientCode,CLIENT.CL_CODE))
						   AND (UPPER(SEC_CLIENT.USER_ID) = UPPER(@UserID)) AND (SEC_CLIENT.TIME_ENTRY = 0 OR SEC_CLIENT.TIME_ENTRY IS NULL)
						   AND PRODUCT.OFFICE_CODE = ISNULL(@OfficeCode,PRODUCT.OFFICE_CODE)
						   AND (CLIENT.ACTIVE_FLAG = 1)
						   AND SPRINT_HDR.ID = @SprintID
						   AND LOWER(DIVISION.DIV_NAME + ' (' + DIVISION.DIV_CODE + ')') LIKE '%' + LOWER(@Text) + '%'
					ORDER BY DIVISION.DIV_NAME
				End
				Else
				Begin
					SELECT DISTINCT TOP 100 DIVISION.DIV_CODE AS Code,
						   DIVISION.DIV_CODE + ' - ' + ISNULL(DIVISION.DIV_NAME, '') + ' | ' + ISNULL(CLIENT.CL_CODE,'') AS 
						   DESCRIPTION,
						   CLIENT.CL_CODE
					   ,DIVISION.DIV_NAME Name
					FROM   SPRINT_HDR
							inner JOIN BOARD on BOARD.ID = SPRINT_HDR.BOARD_ID
							inner join BOARD_JOB on BOARD.ID = BOARD_JOB.BOARD_ID
							inner join JOB_LOG on JOB_LOG.JOB_NUMBER = BOARD_JOB.JOB_NUMBER
							inner join CLIENT ON JOB_LOG.CL_CODE = CLIENT.CL_CODE
							INNER JOIN DIVISION ON  CLIENT.CL_CODE = DIVISION.CL_CODE
							INNER JOIN PRODUCT ON DIVISION.CL_CODE = PRODUCT.CL_CODE AND DIVISION.DIV_CODE = PRODUCT.DIV_CODE 
							INNER JOIN  EMP_OFFICE ON PRODUCT.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = @EMP_CODE
							INNER JOIN SEC_CLIENT ON  DIVISION.CL_CODE = SEC_CLIENT.CL_CODE	AND DIVISION.DIV_CODE = SEC_CLIENT.DIV_CODE
					WHERE  (DIVISION.ACTIVE_FLAG = 1)
						   AND (CLIENT.CL_CODE = ISNULL(@ClientCode,CLIENT.CL_CODE))
						   AND (UPPER(SEC_CLIENT.USER_ID) = UPPER(@UserID)) AND (SEC_CLIENT.TIME_ENTRY = 0 OR SEC_CLIENT.TIME_ENTRY IS NULL)
						   AND PRODUCT.OFFICE_CODE = ISNULL(@OfficeCode,PRODUCT.OFFICE_CODE)
						   AND (CLIENT.ACTIVE_FLAG = 1)
						   AND SPRINT_HDR.ID = @SprintID
						   AND LOWER(DIVISION.DIV_NAME + ' (' + DIVISION.DIV_CODE + ')') LIKE '%' + LOWER(@Text) + '%'
					ORDER BY DIVISION.DIV_NAME
				End
			END
			ELSE
			BEGIN
				If @OfficeCount = 0
				Begin
					SELECT DISTINCT TOP 100 DIVISION.DIV_CODE AS Code,
					   DIVISION.DIV_CODE + ' - ' + ISNULL(DIVISION.DIV_NAME, '') + ' | ' + ISNULL(CLIENT.CL_CODE,'') AS 
					   DESCRIPTION,
					   CLIENT.CL_CODE
					   ,DIVISION.DIV_NAME Name
					FROM  SPRINT_HDR
							inner JOIN BOARD on BOARD.ID = SPRINT_HDR.BOARD_ID
							inner join BOARD_JOB on BOARD.ID = BOARD_JOB.BOARD_ID
							inner join JOB_LOG on JOB_LOG.JOB_NUMBER = BOARD_JOB.JOB_NUMBER
							inner join CLIENT ON JOB_LOG.CL_CODE = CLIENT.CL_CODE
							INNER JOIN DIVISION ON  CLIENT.CL_CODE = DIVISION.CL_CODE
							INNER JOIN PRODUCT ON DIVISION.CL_CODE = PRODUCT.CL_CODE AND DIVISION.DIV_CODE = PRODUCT.DIV_CODE 
					WHERE  (DIVISION.ACTIVE_FLAG = 1)
						   AND (CLIENT.ACTIVE_FLAG = 1)
						   AND PRODUCT.OFFICE_CODE = ISNULL(@OfficeCode,PRODUCT.OFFICE_CODE)
						   AND (CLIENT.CL_CODE = ISNULL(@ClientCode,CLIENT.CL_CODE))
						   AND SPRINT_HDR.ID = @SprintID
						   AND LOWER(DIVISION.DIV_NAME + ' (' + DIVISION.DIV_CODE + ')') LIKE '%' + LOWER(@Text) + '%'
					ORDER BY DIVISION.DIV_NAME
				End
				Else
				Begin
					SELECT DISTINCT TOP 100 DIVISION.DIV_CODE AS Code,
						   DIVISION.DIV_CODE + ' - ' + ISNULL(DIVISION.DIV_NAME, '') + ' | ' + ISNULL(CLIENT.CL_CODE,'') AS 
						   DESCRIPTION,
						   CLIENT.CL_CODE
					   ,DIVISION.DIV_NAME Name
					FROM   SPRINT_HDR
							inner JOIN BOARD on BOARD.ID = SPRINT_HDR.BOARD_ID
							inner join BOARD_JOB on BOARD.ID = BOARD_JOB.BOARD_ID
							inner join JOB_LOG on JOB_LOG.JOB_NUMBER = BOARD_JOB.JOB_NUMBER
							inner join CLIENT ON JOB_LOG.CL_CODE = CLIENT.CL_CODE
							INNER JOIN DIVISION ON CLIENT.CL_CODE = DIVISION.CL_CODE
							INNER JOIN PRODUCT ON DIVISION.CL_CODE = PRODUCT.CL_CODE AND DIVISION.DIV_CODE = PRODUCT.DIV_CODE 
							INNER JOIN EMP_OFFICE ON PRODUCT.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = @EMP_CODE
					WHERE  (DIVISION.ACTIVE_FLAG = 1)
							AND (CLIENT.ACTIVE_FLAG = 1)
							AND PRODUCT.OFFICE_CODE = ISNULL(@OfficeCode,PRODUCT.OFFICE_CODE)
							AND (CLIENT.CL_CODE = ISNULL(@ClientCode,CLIENT.CL_CODE))
							AND SPRINT_HDR.ID = @SprintID
						    AND LOWER(DIVISION.DIV_NAME + ' (' + DIVISION.DIV_CODE + ')') LIKE '%' + LOWER(@Text) + '%'
					ORDER BY DIVISION.DIV_NAME
				End
			END
		END
	End
	Else
	Begin
		IF @SprintID = 0
		BEGIN
			IF @Restrictions > 0
			BEGIN
				If @OfficeCount = 0
				Begin
					SELECT DISTINCT DIVISION.DIV_CODE AS Code,
						   DIVISION.DIV_CODE + ' - ' + ISNULL(DIVISION.DIV_NAME, '') + ' | ' + ISNULL(CLIENT.CL_CODE,'') AS 
						   DESCRIPTION,
						   CLIENT.CL_CODE
					   ,DIVISION.DIV_NAME Name
					FROM   CLIENT
						   INNER JOIN DIVISION
								ON  CLIENT.CL_CODE = DIVISION.CL_CODE
						   INNER JOIN SEC_CLIENT
								ON  DIVISION.CL_CODE = SEC_CLIENT.CL_CODE
								AND DIVISION.DIV_CODE = SEC_CLIENT.DIV_CODE
						   INNER JOIN
								   PRODUCT ON DIVISION.CL_CODE = PRODUCT.CL_CODE AND DIVISION.DIV_CODE = PRODUCT.DIV_CODE 
					WHERE  (DIVISION.ACTIVE_FLAG = 1)
						   AND (CLIENT.CL_CODE = ISNULL(@ClientCode,CLIENT.CL_CODE))
						   AND (UPPER(SEC_CLIENT.USER_ID) = UPPER(@UserID)) AND (SEC_CLIENT.TIME_ENTRY = 0 OR SEC_CLIENT.TIME_ENTRY IS NULL)
						   AND PRODUCT.OFFICE_CODE = ISNULL(@OfficeCode,PRODUCT.OFFICE_CODE)
						   AND (CLIENT.ACTIVE_FLAG = 1)
						   AND LOWER(DIVISION.DIV_NAME + ' (' + DIVISION.DIV_CODE + ')') LIKE '%' + LOWER(@Text) + '%'
					ORDER BY DIVISION.DIV_NAME
				End
				Else
				Begin
					SELECT DISTINCT DIVISION.DIV_CODE AS Code,
						   DIVISION.DIV_CODE + ' - ' + ISNULL(DIVISION.DIV_NAME, '') + ' | ' + ISNULL(CLIENT.CL_CODE,'') AS 
						   DESCRIPTION,
						   CLIENT.CL_CODE
					   ,DIVISION.DIV_NAME Name
					FROM   CLIENT
						   INNER JOIN DIVISION
								ON  CLIENT.CL_CODE = DIVISION.CL_CODE
						   INNER JOIN
								   PRODUCT ON DIVISION.CL_CODE = PRODUCT.CL_CODE AND DIVISION.DIV_CODE = PRODUCT.DIV_CODE 
						   INNER JOIN 
								   EMP_OFFICE ON PRODUCT.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = @EMP_CODE
						   INNER JOIN SEC_CLIENT
								ON  DIVISION.CL_CODE = SEC_CLIENT.CL_CODE
								AND DIVISION.DIV_CODE = SEC_CLIENT.DIV_CODE
					WHERE  (DIVISION.ACTIVE_FLAG = 1)
						   AND (CLIENT.CL_CODE = ISNULL(@ClientCode,CLIENT.CL_CODE))
						   AND (UPPER(SEC_CLIENT.USER_ID) = UPPER(@UserID)) AND (SEC_CLIENT.TIME_ENTRY = 0 OR SEC_CLIENT.TIME_ENTRY IS NULL)
						   AND PRODUCT.OFFICE_CODE = ISNULL(@OfficeCode,PRODUCT.OFFICE_CODE)
						   AND (CLIENT.ACTIVE_FLAG = 1)
						   AND LOWER(DIVISION.DIV_NAME + ' (' + DIVISION.DIV_CODE + ')') LIKE '%' + LOWER(@Text) + '%'
					ORDER BY DIVISION.DIV_NAME
				End
			END
			ELSE
			BEGIN
				If @OfficeCount = 0
				Begin
					SELECT DISTINCT DIVISION.DIV_CODE AS Code,
					   DIVISION.DIV_CODE + ' - ' + ISNULL(DIVISION.DIV_NAME, '') + ' | ' + ISNULL(CLIENT.CL_CODE,'') AS 
					   DESCRIPTION,
					   CLIENT.CL_CODE
					   ,DIVISION.DIV_NAME Name
					FROM   CLIENT
						   INNER JOIN DIVISION
								ON  CLIENT.CL_CODE = DIVISION.CL_CODE
							INNER JOIN
									PRODUCT ON DIVISION.CL_CODE = PRODUCT.CL_CODE AND DIVISION.DIV_CODE = PRODUCT.DIV_CODE 
					WHERE  (DIVISION.ACTIVE_FLAG = 1)
						   AND (CLIENT.ACTIVE_FLAG = 1)
						   AND PRODUCT.OFFICE_CODE = ISNULL(@OfficeCode,PRODUCT.OFFICE_CODE)
						   AND (CLIENT.CL_CODE = ISNULL(@ClientCode,CLIENT.CL_CODE))
						   AND LOWER(DIVISION.DIV_NAME + ' (' + DIVISION.DIV_CODE + ')') LIKE '%' + LOWER(@Text) + '%'
					ORDER BY DIVISION.DIV_NAME
				End
				Else
				Begin
					SELECT DISTINCT DIVISION.DIV_CODE AS Code,
						   DIVISION.DIV_CODE + ' - ' + ISNULL(DIVISION.DIV_NAME, '') + ' | ' + ISNULL(CLIENT.CL_CODE,'') AS 
						   DESCRIPTION,
						   CLIENT.CL_CODE
					   ,DIVISION.DIV_NAME Name
					FROM   CLIENT
						   INNER JOIN DIVISION
								ON  CLIENT.CL_CODE = DIVISION.CL_CODE
						   INNER JOIN
								   PRODUCT ON DIVISION.CL_CODE = PRODUCT.CL_CODE AND DIVISION.DIV_CODE = PRODUCT.DIV_CODE 
						   INNER JOIN 
								   EMP_OFFICE ON PRODUCT.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = @EMP_CODE
					WHERE  (DIVISION.ACTIVE_FLAG = 1)
						   AND (CLIENT.ACTIVE_FLAG = 1)
						   AND PRODUCT.OFFICE_CODE = ISNULL(@OfficeCode,PRODUCT.OFFICE_CODE)
						   AND (CLIENT.CL_CODE = ISNULL(@ClientCode,CLIENT.CL_CODE))
						   AND LOWER(DIVISION.DIV_NAME + ' (' + DIVISION.DIV_CODE + ')') LIKE '%' + LOWER(@Text) + '%'
					ORDER BY DIVISION.DIV_NAME
				End
			END
		end
		ELSE
		BEGIN
			IF @Restrictions > 0
			BEGIN
				If @OfficeCount = 0
				Begin
					SELECT DISTINCT DIVISION.DIV_CODE AS Code,
						   DIVISION.DIV_CODE + ' - ' + ISNULL(DIVISION.DIV_NAME, '') + ' | ' + ISNULL(CLIENT.CL_CODE,'') AS 
						   DESCRIPTION,
						   CLIENT.CL_CODE
					   ,DIVISION.DIV_NAME Name
					FROM   SPRINT_HDR
							inner JOIN BOARD on BOARD.ID = SPRINT_HDR.BOARD_ID
							inner join BOARD_JOB on BOARD.ID = BOARD_JOB.BOARD_ID
							inner join JOB_LOG on JOB_LOG.JOB_NUMBER = BOARD_JOB.JOB_NUMBER
							inner join CLIENT ON JOB_LOG.CL_CODE = CLIENT.CL_CODE
							INNER JOIN DIVISION	ON  CLIENT.CL_CODE = DIVISION.CL_CODE
							INNER JOIN SEC_CLIENT ON  DIVISION.CL_CODE = SEC_CLIENT.CL_CODE	AND DIVISION.DIV_CODE = SEC_CLIENT.DIV_CODE
							INNER JOIN PRODUCT ON DIVISION.CL_CODE = PRODUCT.CL_CODE AND DIVISION.DIV_CODE = PRODUCT.DIV_CODE 
					WHERE  (DIVISION.ACTIVE_FLAG = 1)
						   AND (CLIENT.CL_CODE = ISNULL(@ClientCode,CLIENT.CL_CODE))
						   AND (UPPER(SEC_CLIENT.USER_ID) = UPPER(@UserID)) AND (SEC_CLIENT.TIME_ENTRY = 0 OR SEC_CLIENT.TIME_ENTRY IS NULL)
						   AND PRODUCT.OFFICE_CODE = ISNULL(@OfficeCode,PRODUCT.OFFICE_CODE)
						   AND (CLIENT.ACTIVE_FLAG = 1)
						   AND SPRINT_HDR.ID = @SprintID
						   AND LOWER(DIVISION.DIV_NAME + ' (' + DIVISION.DIV_CODE + ')') LIKE '%' + LOWER(@Text) + '%'
					ORDER BY DIVISION.DIV_NAME
				End
				Else
				Begin
					SELECT DISTINCT DIVISION.DIV_CODE AS Code,
						   DIVISION.DIV_CODE + ' - ' + ISNULL(DIVISION.DIV_NAME, '') + ' | ' + ISNULL(CLIENT.CL_CODE,'') AS 
						   DESCRIPTION,
						   CLIENT.CL_CODE
					   ,DIVISION.DIV_NAME Name
					FROM   SPRINT_HDR
							inner JOIN BOARD on BOARD.ID = SPRINT_HDR.BOARD_ID
							inner join BOARD_JOB on BOARD.ID = BOARD_JOB.BOARD_ID
							inner join JOB_LOG on JOB_LOG.JOB_NUMBER = BOARD_JOB.JOB_NUMBER
							inner join CLIENT ON JOB_LOG.CL_CODE = CLIENT.CL_CODE
							INNER JOIN DIVISION ON  CLIENT.CL_CODE = DIVISION.CL_CODE
							INNER JOIN PRODUCT ON DIVISION.CL_CODE = PRODUCT.CL_CODE AND DIVISION.DIV_CODE = PRODUCT.DIV_CODE 
							INNER JOIN  EMP_OFFICE ON PRODUCT.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = @EMP_CODE
							INNER JOIN SEC_CLIENT ON  DIVISION.CL_CODE = SEC_CLIENT.CL_CODE	AND DIVISION.DIV_CODE = SEC_CLIENT.DIV_CODE
					WHERE  (DIVISION.ACTIVE_FLAG = 1)
						   AND (CLIENT.CL_CODE = ISNULL(@ClientCode,CLIENT.CL_CODE))
						   AND (UPPER(SEC_CLIENT.USER_ID) = UPPER(@UserID)) AND (SEC_CLIENT.TIME_ENTRY = 0 OR SEC_CLIENT.TIME_ENTRY IS NULL)
						   AND PRODUCT.OFFICE_CODE = ISNULL(@OfficeCode,PRODUCT.OFFICE_CODE)
						   AND (CLIENT.ACTIVE_FLAG = 1)
						   AND SPRINT_HDR.ID = @SprintID
						   AND LOWER(DIVISION.DIV_NAME + ' (' + DIVISION.DIV_CODE + ')') LIKE '%' + LOWER(@Text) + '%'
					ORDER BY DIVISION.DIV_NAME
				End
			END
			ELSE
			BEGIN
				If @OfficeCount = 0
				Begin
					SELECT DISTINCT DIVISION.DIV_CODE AS Code,
					   DIVISION.DIV_CODE + ' - ' + ISNULL(DIVISION.DIV_NAME, '') + ' | ' + ISNULL(CLIENT.CL_CODE,'') AS 
					   DESCRIPTION,
					   CLIENT.CL_CODE
					   ,DIVISION.DIV_NAME Name
					FROM  SPRINT_HDR
							inner JOIN BOARD on BOARD.ID = SPRINT_HDR.BOARD_ID
							inner join BOARD_JOB on BOARD.ID = BOARD_JOB.BOARD_ID
							inner join JOB_LOG on JOB_LOG.JOB_NUMBER = BOARD_JOB.JOB_NUMBER
							inner join CLIENT ON JOB_LOG.CL_CODE = CLIENT.CL_CODE
							INNER JOIN DIVISION ON  CLIENT.CL_CODE = DIVISION.CL_CODE
							INNER JOIN PRODUCT ON DIVISION.CL_CODE = PRODUCT.CL_CODE AND DIVISION.DIV_CODE = PRODUCT.DIV_CODE 
					WHERE  (DIVISION.ACTIVE_FLAG = 1)
						   AND (CLIENT.ACTIVE_FLAG = 1)
						   AND PRODUCT.OFFICE_CODE = ISNULL(@OfficeCode,PRODUCT.OFFICE_CODE)
						   AND (CLIENT.CL_CODE = ISNULL(@ClientCode,CLIENT.CL_CODE))
						   AND SPRINT_HDR.ID = @SprintID
						   AND LOWER(DIVISION.DIV_NAME + ' (' + DIVISION.DIV_CODE + ')') LIKE '%' + LOWER(@Text) + '%'
					ORDER BY DIVISION.DIV_NAME
				End
				Else
				Begin
					SELECT DISTINCT DIVISION.DIV_CODE AS Code,
						   DIVISION.DIV_CODE + ' - ' + ISNULL(DIVISION.DIV_NAME, '') + ' | ' + ISNULL(CLIENT.CL_CODE,'') AS 
						   DESCRIPTION,
						   CLIENT.CL_CODE
					   ,DIVISION.DIV_NAME Name
					FROM   SPRINT_HDR
							inner JOIN BOARD on BOARD.ID = SPRINT_HDR.BOARD_ID
							inner join BOARD_JOB on BOARD.ID = BOARD_JOB.BOARD_ID
							inner join JOB_LOG on JOB_LOG.JOB_NUMBER = BOARD_JOB.JOB_NUMBER
							inner join CLIENT ON JOB_LOG.CL_CODE = CLIENT.CL_CODE
							INNER JOIN DIVISION ON CLIENT.CL_CODE = DIVISION.CL_CODE
							INNER JOIN PRODUCT ON DIVISION.CL_CODE = PRODUCT.CL_CODE AND DIVISION.DIV_CODE = PRODUCT.DIV_CODE 
							INNER JOIN EMP_OFFICE ON PRODUCT.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = @EMP_CODE
					WHERE  (DIVISION.ACTIVE_FLAG = 1)
							AND (CLIENT.ACTIVE_FLAG = 1)
							AND PRODUCT.OFFICE_CODE = ISNULL(@OfficeCode,PRODUCT.OFFICE_CODE)
							AND (CLIENT.CL_CODE = ISNULL(@ClientCode,CLIENT.CL_CODE))
							AND SPRINT_HDR.ID = @SprintID
						    AND LOWER(DIVISION.DIV_NAME + ' (' + DIVISION.DIV_CODE + ')') LIKE '%' + LOWER(@Text) + '%'
					ORDER BY DIVISION.DIV_NAME
				End
			END
		END
	End



GO


