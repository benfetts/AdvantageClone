SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS OFF 
GO
IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[usp_wv_dd_cdp_product_contact]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[usp_wv_dd_cdp_product_contact]
GO
CREATE PROCEDURE [dbo].[usp_wv_dd_cdp_product_contact] /*WITH ENCRYPTION*/
@Client VARCHAR(6), 
@Division VARCHAR(6),
@Product VARCHAR(6),
@FromForm VARCHAR(15)  --Just in case need to differentiate
AS
/*=========== QUERY ===========*/
DECLARE
@DetailCount INT

IF @Division = ''
BEGIN
	SET @Division = NULL
END
IF @Product = ''
BEGIN
	SET @Product = NULL
END
	
IF (NOT (@Client IS NULL)) AND @Division IS NULL AND @Product IS NULL
    BEGIN
        SELECT 
			DISTINCT CDP_CONTACT_HDR.CDP_CONTACT_ID AS CDP_CONTACT_ID, 
			CAST(CDP_CONTACT_HDR.CDP_CONTACT_ID AS VARCHAR) + '|' + CDP_CONTACT_HDR.CONT_CODE AS SplitPK, 
			CDP_CONTACT_HDR.CONT_CODE AS code, 
			CDP_CONTACT_HDR.CONT_CODE AS code2, 
			CDP_CONTACT_HDR.CONT_CODE + ' - ' + CDP_CONTACT_HDR.CONT_FML AS description, CDP_CONTACT_HDR.CONT_TELEPHONE, CDP_CONTACT_HDR.CELL_PHONE,
			CDP_CONTACT_HDR.CONT_FAX, CDP_CONTACT_HDR.EMAIL_ADDRESS, CDP_CONTACT_HDR.CONT_EXTENTION, CDP_CONTACT_HDR.CONT_FAX_EXTENTION, CONT_TITLE
		FROM         
			CDP_CONTACT_HDR
		WHERE   
			CDP_CONTACT_HDR.CL_CODE = @Client
			AND ((CDP_CONTACT_HDR.INACTIVE_FLAG = 0) OR (CDP_CONTACT_HDR.INACTIVE_FLAG IS NULL))
	    ORDER BY 
	        CDP_CONTACT_HDR.CONT_CODE
    END
ELSE IF @FromForm = 'jj'
    BEGIN
        SELECT 
			DISTINCT CDP_CONTACT_HDR.CDP_CONTACT_ID AS CDP_CONTACT_ID, 
			CAST(CDP_CONTACT_HDR.CDP_CONTACT_ID AS VARCHAR) + '|' + CDP_CONTACT_HDR.CONT_CODE AS SplitPK, 
			CDP_CONTACT_HDR.CONT_CODE AS code, 
			CDP_CONTACT_HDR.CONT_CODE AS code2, 
			CDP_CONTACT_HDR.CONT_CODE + ' - ' + CDP_CONTACT_HDR.CONT_FML AS description, CDP_CONTACT_HDR.CONT_TELEPHONE, CDP_CONTACT_HDR.CELL_PHONE,
			CDP_CONTACT_HDR.CONT_FAX, CDP_CONTACT_HDR.EMAIL_ADDRESS, CDP_CONTACT_HDR.CONT_EXTENTION, CDP_CONTACT_HDR.CONT_FAX_EXTENTION, CDP_CONTACT_HDR.CONT_FML, CONT_TITLE
		FROM         
			CDP_CONTACT_HDR
		WHERE   
			CDP_CONTACT_HDR.CL_CODE = @Client
			AND ((CDP_CONTACT_HDR.INACTIVE_FLAG = 0) OR (CDP_CONTACT_HDR.INACTIVE_FLAG IS NULL))
	    ORDER BY 
	        CDP_CONTACT_HDR.CONT_FML
    END    
ELSE
    BEGIN
        SELECT     
                DISTINCT A.CDP_CONTACT_ID, 
                A.SplitPK AS code, 
                A.code AS code2, 
                A.description,
                A.CL_CODE,
                --A.DIV_CODE, 
                --A.PRD_CODE 
			A.CONT_TELEPHONE, A.CELL_PHONE,
			A.CONT_FAX, A.EMAIL_ADDRESS, A.CONT_EXTENTION, A.CONT_FAX_EXTENTION
        FROM         
            (SELECT 
                DISTINCT CDP_CONTACT_HDR.CDP_CONTACT_ID AS CDP_CONTACT_ID, 
                CAST(CDP_CONTACT_HDR.CDP_CONTACT_ID AS VARCHAR)+ '|' + CDP_CONTACT_HDR.CONT_CODE AS SplitPK, 
                CDP_CONTACT_HDR.CONT_CODE AS code, 
                CDP_CONTACT_HDR.CONT_CODE + ' - ' + CDP_CONTACT_HDR.CONT_FML AS description, 
                CDP_CONTACT_HDR.CL_CODE, 
                CDP_CONTACT_DTL.DIV_CODE, 
                CDP_CONTACT_DTL.PRD_CODE, 
                CDP_CONTACT_HDR.INACTIVE_FLAG, CDP_CONTACT_HDR.CONT_TELEPHONE, CDP_CONTACT_HDR.CELL_PHONE,
			CDP_CONTACT_HDR.CONT_FAX, CDP_CONTACT_HDR.EMAIL_ADDRESS, CDP_CONTACT_HDR.CONT_EXTENTION, CDP_CONTACT_HDR.CONT_FAX_EXTENTION, CONT_TITLE
            FROM          
                CDP_CONTACT_HDR LEFT OUTER JOIN
                 CDP_CONTACT_DTL ON CDP_CONTACT_HDR.CDP_CONTACT_ID = CDP_CONTACT_DTL.CDP_CONTACT_ID
            WHERE      ((CDP_CONTACT_HDR.CL_CODE = @Client) AND (CDP_CONTACT_DTL.DIV_CODE = @Division) AND 
									  (CDP_CONTACT_DTL.PRD_CODE = @Product)) OR
									  ((CDP_CONTACT_HDR.CL_CODE = @Client) AND (CDP_CONTACT_DTL.DIV_CODE = @Division) AND (CDP_CONTACT_DTL.PRD_CODE IS NULL)) OR	
									  ((CDP_CONTACT_HDR.CL_CODE = @Client) AND (CDP_CONTACT_DTL.DIV_CODE IS NULL) AND (CDP_CONTACT_DTL.PRD_CODE IS NULL))
             ) AS A
        WHERE     
            --(A.CL_CODE = @Client)
            --AND 
            ((A.INACTIVE_FLAG = 0) OR (A.INACTIVE_FLAG IS NULL))
        ORDER BY 
            A.code
    END	
/*=========== QUERY ===========*/
GO
SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO