SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS OFF 
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_WV_WORKSPACE_TMPLT_INSERT]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_WV_WORKSPACE_TMPLT_INSERT]
GO

CREATE PROCEDURE [dbo].[usp_WV_WORKSPACE_TMPLT_INSERT] /*WITH ENCRYPTION*/
@SEC_USER_ID INT,
@TEMPLATE_NAME VARCHAR(50),
@TEMPLATE_DESC VARCHAR(100)
AS
/*=========== QUERY ===========*/
DECLARE
	@NEW_TEMPLATE_ID INT,
	@USER_CODE VARCHAR(100),
	@SAME_NAME_EXISTS TINYINT

	SELECT @SAME_NAME_EXISTS = TEMPLATE_ID FROM WV_WORKSPACE_TMPLT_HDR WITH(NOLOCK) WHERE CREATED_BY_ID = @SEC_USER_ID AND NAME = @TEMPLATE_NAME;
	
	SET @SAME_NAME_EXISTS = ISNULL(@SAME_NAME_EXISTS,0);
		
	IF @SAME_NAME_EXISTS = 0
	BEGIN
			SELECT @USER_CODE = USER_CODE FROM SEC_USER WITH(NOLOCK) WHERE SEC_USER_ID = @SEC_USER_ID;
			
			INSERT INTO WV_WORKSPACE_TMPLT_HDR WITH(ROWLOCK)
			(
				CREATED_BY_ID,
				NAME,
				[DESCRIPTION],
				CREATE_DATE
			)
			VALUES
			(
				@SEC_USER_ID,
				@TEMPLATE_NAME,
				@TEMPLATE_DESC,
				GETDATE()
			);
			
			SELECT @NEW_TEMPLATE_ID = SCOPE_IDENTITY();	
			SELECT @NEW_TEMPLATE_ID = ISNULL(@NEW_TEMPLATE_ID,0);
			
			IF @NEW_TEMPLATE_ID > 0 
			BEGIN
				DECLARE 
				@WORKSPACE_ID AS INT,
				@WORKSPACE_NAME AS VARCHAR(50),
				@WORKSPACE_DESC AS VARCHAR(100),
				@WORKSPACE_SORT_ORDER INT
				 
				DECLARE MY_ROWS                           CURSOR  
				FOR
					SELECT WORKSPACE_ID
					FROM   WV_USER_WORKSPACE WITH(NOLOCK)
					WHERE UPPER(USER_CODE) = UPPER(@USER_CODE);

					OPEN MY_ROWS;
						FETCH NEXT FROM MY_ROWS INTO @WORKSPACE_ID;
				WHILE @@FETCH_STATUS = 0
				BEGIN
	    			--SET STUFF
	    			SELECT @WORKSPACE_NAME = NAME, @WORKSPACE_DESC = [DESCRIPTION], @WORKSPACE_SORT_ORDER = SORT_ORDER 
	    			FROM WV_USER_WORKSPACE WITH(NOLOCK) 
	    			WHERE WORKSPACE_ID = @WORKSPACE_ID;
					--DO STUFF
					INSERT INTO WV_WORKSPACE_TMPLT_DTL WITH(ROWLOCK)
					(
						TEMPLATE_ID,
						NAME,
						[DESCRIPTION],
						SORT_ORDER
					)
					VALUES
					(
						@NEW_TEMPLATE_ID,
						@WORKSPACE_NAME,
						@WORKSPACE_DESC,
						@WORKSPACE_SORT_ORDER
					);
					DECLARE @DTL_WORKSPACE_ID INT
					SELECT @DTL_WORKSPACE_ID = SCOPE_IDENTITY();
					SELECT @DTL_WORKSPACE_ID = ISNULL(@DTL_WORKSPACE_ID,0)
					IF @DTL_WORKSPACE_ID > 0 
					BEGIN
						INSERT INTO WV_WORKSPACE_TMPLT_ITEM (WORKSPACE_ID,DESKTOP_OBJECT_ID,ZONE_ID,HEIGHT,WIDTH,TOP_COORD,LEFT_COORD,SORT_ORDER)
						SELECT @DTL_WORKSPACE_ID, DESKTOP_OBJECT_ID, ZONE_ID,HEIGHT,WIDTH,TOP_COORD,LEFT_COORD,SORT_ORDER
						FROM WV_WORKSPACE_OBJECT WITH(NOLOCK) WHERE WORKSPACE_ID = @WORKSPACE_ID;
					END
					--MOVE TO NEXT
					FETCH NEXT FROM MY_ROWS INTO @WORKSPACE_ID;
				END
					CLOSE MY_ROWS;
					DEALLOCATE MY_ROWS;
			END
	END
	SELECT @SAME_NAME_EXISTS;	
/*=========== QUERY ===========*/
GO
SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO