
CREATE PROCEDURE [dbo].[usp_wv_DesktopObject_GetAllProjectsSort]
@EmpCode as VARCHAR(6),
@SortVal AS VARCHAR(15),
@Search as Varchar(500),
@UserID as varchar(100)
AS

Set NoCount ON

DECLARE @OfficeRestrictions INT, @Restrictions AS INT
--DECLARE @EMP_CODE AS VARCHAR(6)

SELECT @OfficeRestrictions = COUNT(*) FROM EMP_OFFICE WHERE EMP_CODE = @EmpCode
Select @Restrictions = Count(*) FROM SEC_CLIENT WHERE UPPER(USER_ID) = UPPER(@UserID);

CREATE TABLE #myprojects( 	
	ClientCode VARCHAR(6) NULL,
	DivCode VARCHAR(6) NULL,
	ProductCode VARCHAR(6) NULL,
	CDP VARCHAR(24) NULL,
	Job VARCHAR(100) NULL,
	JobComp VARCHAR(100) NULL,
	JobAndComp VARCHAR(500) NULL,
	StartDate DATETIME NULL,
	DueDate DATETIME NULL,
	Status VARCHAR(50) NULL,
	AE VARCHAR(100) NULL,
	AECode VARCHAR(6) NULL,
	JobNo INT NULL, 
	JobCompNo INT NULL, 
	TrafficCount INT NULL
)

IF @OfficeRestrictions > 0
	Begin				
		If @Restrictions > 0
		Begin
			INSERT INTO #myprojects
			SELECT 
				JOB_LOG.CL_CODE AS ClientCode, 
				JOB_LOG.DIV_CODE AS DivCode, 
				JOB_LOG.PRD_CODE AS ProductCode, 
				JOB_LOG.CL_CODE+'/'+JOB_LOG.DIV_CODE+'/'+JOB_LOG.PRD_CODE AS CDP, 
				LTRIM(STR(JOB_LOG.JOB_NUMBER)) + ' - ' + JOB_LOG.JOB_DESC AS Job, 
				LTRIM(STR(JOB_COMPONENT.JOB_COMPONENT_NBR)) + ' - ' + JOB_COMPONENT.JOB_COMP_DESC AS JobComp, 
				RIGHT(REPLICATE('0', 6) + CONVERT(VARCHAR(20),ISNULL(JOB_LOG.JOB_NUMBER,0)), 6) + '-' + RIGHT(REPLICATE('0', 3) + CONVERT(VARCHAR(20), ISNULL(JOB_COMPONENT.JOB_COMPONENT_NBR,0)), 3)+ '  ' + ISNULL(JOB_COMPONENT.JOB_COMP_DESC, '') AS JobAndComp, 
				JOB_COMPONENT.START_DATE AS StartDate, 
				JOB_COMPONENT.JOB_FIRST_USE_DATE AS DueDate, 
				TRAFFIC.TRF_DESCRIPTION AS Status, 
				dbo.udf_get_empl_name(JOB_COMPONENT.EMP_CODE, 'FML')  AS AE, 
				JOB_COMPONENT.EMP_CODE AS AECode,
				JOB_LOG.JOB_NUMBER AS JobNo, 
				JOB_COMPONENT.JOB_COMPONENT_NBR AS JobCompNo, 0
			FROM   
				JOB_TRAFFIC_DET INNER JOIN
				JOB_TRAFFIC ON JOB_TRAFFIC_DET.JOB_NUMBER = JOB_TRAFFIC.JOB_NUMBER AND 
				JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = JOB_TRAFFIC.JOB_COMPONENT_NBR INNER JOIN
				JOB_LOG ON JOB_TRAFFIC.JOB_NUMBER = JOB_LOG.JOB_NUMBER INNER JOIN
				JOB_COMPONENT ON JOB_TRAFFIC.JOB_NUMBER = JOB_COMPONENT.JOB_NUMBER AND 
				JOB_TRAFFIC.JOB_COMPONENT_NBR = JOB_COMPONENT.JOB_COMPONENT_NBR INNER JOIN
				TRAFFIC ON JOB_TRAFFIC.TRF_CODE = TRAFFIC.TRF_CODE INNER JOIN
				EMPLOYEE ON JOB_COMPONENT.EMP_CODE = EMPLOYEE.EMP_CODE
				INNER JOIN EMP_OFFICE ON EMP_OFFICE.OFFICE_CODE = JOB_LOG.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = @EmpCode
				INNER JOIN SEC_CLIENT ON JOB_LOG.CL_CODE = SEC_CLIENT.CL_CODE AND JOB_LOG.DIV_CODE = SEC_CLIENT.DIV_CODE AND JOB_LOG.PRD_CODE = SEC_CLIENT.PRD_CODE
			WHERE  
				((NOT (JOB_COMPONENT.JOB_PROCESS_CONTRL IN (6, 12))) AND 
				(JOB_TRAFFIC.COMPLETED_DATE IS NULL)) AND (UPPER(SEC_CLIENT.USER_ID) = UPPER(@UserID)) AND (SEC_CLIENT.TIME_ENTRY = 0 OR SEC_CLIENT.TIME_ENTRY IS NULL)
			GROUP BY 
				JOB_LOG.CL_CODE, JOB_LOG.DIV_CODE, JOB_LOG.PRD_CODE, LTRIM(STR(JOB_LOG.JOB_NUMBER)) + ' - ' + JOB_LOG.JOB_DESC,  JOB_LOG.JOB_NUMBER,
				LTRIM(STR(JOB_COMPONENT.JOB_COMPONENT_NBR)) + ' - ' + JOB_COMPONENT.JOB_COMP_DESC, JOB_COMPONENT.START_DATE, 
				JOB_COMPONENT.JOB_FIRST_USE_DATE, TRAFFIC.TRF_DESCRIPTION, dbo.udf_get_empl_name(JOB_COMPONENT.EMP_CODE, 'FML'),
				JOB_COMPONENT.EMP_CODE, JOB_LOG.JOB_NUMBER, JOB_COMPONENT.JOB_COMPONENT_NBR,
				JOB_LOG.JOB_DESC, JOB_COMPONENT.JOB_COMP_DESC
		End	
		Else
		Begin
			INSERT INTO #myprojects
			SELECT 
				JOB_LOG.CL_CODE AS ClientCode, 
				JOB_LOG.DIV_CODE AS DivCode, 
				JOB_LOG.PRD_CODE AS ProductCode, 
				JOB_LOG.CL_CODE+'/'+JOB_LOG.DIV_CODE+'/'+JOB_LOG.PRD_CODE AS CDP, 
				LTRIM(STR(JOB_LOG.JOB_NUMBER)) + ' - ' + JOB_LOG.JOB_DESC AS Job, 
				LTRIM(STR(JOB_COMPONENT.JOB_COMPONENT_NBR)) + ' - ' + JOB_COMPONENT.JOB_COMP_DESC AS JobComp, 
				RIGHT(REPLICATE('0', 6) + CONVERT(VARCHAR(20),ISNULL(JOB_LOG.JOB_NUMBER,0)), 6) + '-' + RIGHT(REPLICATE('0', 3) + CONVERT(VARCHAR(20), ISNULL(JOB_COMPONENT.JOB_COMPONENT_NBR,0)), 3)+ '  ' + ISNULL(JOB_COMPONENT.JOB_COMP_DESC, '') AS JobAndComp, 
				JOB_COMPONENT.START_DATE AS StartDate, 
				JOB_COMPONENT.JOB_FIRST_USE_DATE AS DueDate, 
				TRAFFIC.TRF_DESCRIPTION AS Status, 
				dbo.udf_get_empl_name(JOB_COMPONENT.EMP_CODE, 'FML')  AS AE, 
				JOB_COMPONENT.EMP_CODE AS AECode,
				JOB_LOG.JOB_NUMBER AS JobNo, 
				JOB_COMPONENT.JOB_COMPONENT_NBR AS JobCompNo, 0
			FROM   
				JOB_TRAFFIC_DET INNER JOIN
				JOB_TRAFFIC ON JOB_TRAFFIC_DET.JOB_NUMBER = JOB_TRAFFIC.JOB_NUMBER AND 
				JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = JOB_TRAFFIC.JOB_COMPONENT_NBR INNER JOIN
				JOB_LOG ON JOB_TRAFFIC.JOB_NUMBER = JOB_LOG.JOB_NUMBER INNER JOIN
				JOB_COMPONENT ON JOB_TRAFFIC.JOB_NUMBER = JOB_COMPONENT.JOB_NUMBER AND 
				JOB_TRAFFIC.JOB_COMPONENT_NBR = JOB_COMPONENT.JOB_COMPONENT_NBR INNER JOIN
				TRAFFIC ON JOB_TRAFFIC.TRF_CODE = TRAFFIC.TRF_CODE INNER JOIN
				EMPLOYEE ON JOB_COMPONENT.EMP_CODE = EMPLOYEE.EMP_CODE
				INNER JOIN EMP_OFFICE ON EMP_OFFICE.OFFICE_CODE = JOB_LOG.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = @EmpCode
			WHERE  
				((NOT (JOB_COMPONENT.JOB_PROCESS_CONTRL IN (6, 12))) AND 
				(JOB_TRAFFIC.COMPLETED_DATE IS NULL))
			GROUP BY 
				JOB_LOG.CL_CODE, JOB_LOG.DIV_CODE, JOB_LOG.PRD_CODE, LTRIM(STR(JOB_LOG.JOB_NUMBER)) + ' - ' + JOB_LOG.JOB_DESC,  JOB_LOG.JOB_NUMBER,
				LTRIM(STR(JOB_COMPONENT.JOB_COMPONENT_NBR)) + ' - ' + JOB_COMPONENT.JOB_COMP_DESC, JOB_COMPONENT.START_DATE, 
				JOB_COMPONENT.JOB_FIRST_USE_DATE, TRAFFIC.TRF_DESCRIPTION, dbo.udf_get_empl_name(JOB_COMPONENT.EMP_CODE, 'FML'),
				JOB_COMPONENT.EMP_CODE, JOB_LOG.JOB_NUMBER, JOB_COMPONENT.JOB_COMPONENT_NBR,
				JOB_LOG.JOB_DESC, JOB_COMPONENT.JOB_COMP_DESC
		End
	
	END

ELSE
	BEGIN				
		If @Restrictions > 0
		Begin
			INSERT INTO #myprojects
			SELECT 
				JOB_LOG.CL_CODE AS ClientCode, 
				JOB_LOG.DIV_CODE AS DivCode, 
				JOB_LOG.PRD_CODE AS ProductCode, 
				JOB_LOG.CL_CODE+'/'+JOB_LOG.DIV_CODE+'/'+JOB_LOG.PRD_CODE AS CDP, 
				LTRIM(STR(JOB_LOG.JOB_NUMBER)) + ' - ' + JOB_LOG.JOB_DESC AS Job, 
				LTRIM(STR(JOB_COMPONENT.JOB_COMPONENT_NBR)) + ' - ' + JOB_COMPONENT.JOB_COMP_DESC AS JobComp, 
				RIGHT(REPLICATE('0', 6) + CONVERT(VARCHAR(20),ISNULL(JOB_LOG.JOB_NUMBER,0)), 6) + '-' + RIGHT(REPLICATE('0', 3) + CONVERT(VARCHAR(20), ISNULL(JOB_COMPONENT.JOB_COMPONENT_NBR,0)), 3)+ '  ' + ISNULL(JOB_COMPONENT.JOB_COMP_DESC, '') AS JobAndComp, 
				JOB_COMPONENT.START_DATE AS StartDate, 
				JOB_COMPONENT.JOB_FIRST_USE_DATE AS DueDate, 
				TRAFFIC.TRF_DESCRIPTION AS Status, 
				dbo.udf_get_empl_name(JOB_COMPONENT.EMP_CODE, 'FML')  AS AE, 
				JOB_COMPONENT.EMP_CODE AS AECode,
				JOB_LOG.JOB_NUMBER AS JobNo, 
				JOB_COMPONENT.JOB_COMPONENT_NBR AS JobCompNo, 0
			FROM   
				JOB_TRAFFIC_DET INNER JOIN
				JOB_TRAFFIC ON JOB_TRAFFIC_DET.JOB_NUMBER = JOB_TRAFFIC.JOB_NUMBER AND 
				JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = JOB_TRAFFIC.JOB_COMPONENT_NBR INNER JOIN
				JOB_LOG ON JOB_TRAFFIC.JOB_NUMBER = JOB_LOG.JOB_NUMBER INNER JOIN
				JOB_COMPONENT ON JOB_TRAFFIC.JOB_NUMBER = JOB_COMPONENT.JOB_NUMBER AND 
				JOB_TRAFFIC.JOB_COMPONENT_NBR = JOB_COMPONENT.JOB_COMPONENT_NBR INNER JOIN
				TRAFFIC ON JOB_TRAFFIC.TRF_CODE = TRAFFIC.TRF_CODE INNER JOIN
				EMPLOYEE ON JOB_COMPONENT.EMP_CODE = EMPLOYEE.EMP_CODE				
				INNER JOIN SEC_CLIENT ON JOB_LOG.CL_CODE = SEC_CLIENT.CL_CODE AND JOB_LOG.DIV_CODE = SEC_CLIENT.DIV_CODE AND JOB_LOG.PRD_CODE = SEC_CLIENT.PRD_CODE
			WHERE  
				((NOT (JOB_COMPONENT.JOB_PROCESS_CONTRL IN (6, 12))) AND 
				(JOB_TRAFFIC.COMPLETED_DATE IS NULL)) AND (UPPER(SEC_CLIENT.USER_ID) = UPPER(@UserID)) AND (SEC_CLIENT.TIME_ENTRY = 0 OR SEC_CLIENT.TIME_ENTRY IS NULL)
			GROUP BY 
				JOB_LOG.CL_CODE, JOB_LOG.DIV_CODE, JOB_LOG.PRD_CODE, LTRIM(STR(JOB_LOG.JOB_NUMBER)) + ' - ' + JOB_LOG.JOB_DESC,  JOB_LOG.JOB_NUMBER,
				LTRIM(STR(JOB_COMPONENT.JOB_COMPONENT_NBR)) + ' - ' + JOB_COMPONENT.JOB_COMP_DESC, JOB_COMPONENT.START_DATE, 
				JOB_COMPONENT.JOB_FIRST_USE_DATE, TRAFFIC.TRF_DESCRIPTION, dbo.udf_get_empl_name(JOB_COMPONENT.EMP_CODE, 'FML'),
				JOB_COMPONENT.EMP_CODE, JOB_LOG.JOB_NUMBER, JOB_COMPONENT.JOB_COMPONENT_NBR,
				JOB_LOG.JOB_DESC, JOB_COMPONENT.JOB_COMP_DESC
		End	
		Else
		Begin
			INSERT INTO #myprojects
			SELECT 
				JOB_LOG.CL_CODE AS ClientCode, 
				JOB_LOG.DIV_CODE AS DivCode, 
				JOB_LOG.PRD_CODE AS ProductCode, 
				JOB_LOG.CL_CODE+'/'+JOB_LOG.DIV_CODE+'/'+JOB_LOG.PRD_CODE AS CDP, 
				LTRIM(STR(JOB_LOG.JOB_NUMBER)) + ' - ' + JOB_LOG.JOB_DESC AS Job, 
				LTRIM(STR(JOB_COMPONENT.JOB_COMPONENT_NBR)) + ' - ' + JOB_COMPONENT.JOB_COMP_DESC AS JobComp, 
				RIGHT(REPLICATE('0', 6) + CONVERT(VARCHAR(20),ISNULL(JOB_LOG.JOB_NUMBER,0)), 6) + '-' + RIGHT(REPLICATE('0', 3) + CONVERT(VARCHAR(20), ISNULL(JOB_COMPONENT.JOB_COMPONENT_NBR,0)), 3)+ '  ' + ISNULL(JOB_COMPONENT.JOB_COMP_DESC, '') AS JobAndComp, 
				JOB_COMPONENT.START_DATE AS StartDate, 
				JOB_COMPONENT.JOB_FIRST_USE_DATE AS DueDate, 
				TRAFFIC.TRF_DESCRIPTION AS Status, 
				dbo.udf_get_empl_name(JOB_COMPONENT.EMP_CODE, 'FML')  AS AE, 
				JOB_COMPONENT.EMP_CODE AS AECode,
				JOB_LOG.JOB_NUMBER AS JobNo, 
				JOB_COMPONENT.JOB_COMPONENT_NBR AS JobCompNo, 0
			FROM   
				JOB_TRAFFIC_DET INNER JOIN
				JOB_TRAFFIC ON JOB_TRAFFIC_DET.JOB_NUMBER = JOB_TRAFFIC.JOB_NUMBER AND 
				JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = JOB_TRAFFIC.JOB_COMPONENT_NBR INNER JOIN
				JOB_LOG ON JOB_TRAFFIC.JOB_NUMBER = JOB_LOG.JOB_NUMBER INNER JOIN
				JOB_COMPONENT ON JOB_TRAFFIC.JOB_NUMBER = JOB_COMPONENT.JOB_NUMBER AND 
				JOB_TRAFFIC.JOB_COMPONENT_NBR = JOB_COMPONENT.JOB_COMPONENT_NBR INNER JOIN
				TRAFFIC ON JOB_TRAFFIC.TRF_CODE = TRAFFIC.TRF_CODE INNER JOIN
				EMPLOYEE ON JOB_COMPONENT.EMP_CODE = EMPLOYEE.EMP_CODE
			WHERE  
				((NOT (JOB_COMPONENT.JOB_PROCESS_CONTRL IN (6, 12))) AND 
				(JOB_TRAFFIC.COMPLETED_DATE IS NULL))
			GROUP BY 
				JOB_LOG.CL_CODE, JOB_LOG.DIV_CODE, JOB_LOG.PRD_CODE, LTRIM(STR(JOB_LOG.JOB_NUMBER)) + ' - ' + JOB_LOG.JOB_DESC,  JOB_LOG.JOB_NUMBER,
				LTRIM(STR(JOB_COMPONENT.JOB_COMPONENT_NBR)) + ' - ' + JOB_COMPONENT.JOB_COMP_DESC, JOB_COMPONENT.START_DATE, 
				JOB_COMPONENT.JOB_FIRST_USE_DATE, TRAFFIC.TRF_DESCRIPTION, dbo.udf_get_empl_name(JOB_COMPONENT.EMP_CODE, 'FML'),
				JOB_COMPONENT.EMP_CODE, JOB_LOG.JOB_NUMBER, JOB_COMPONENT.JOB_COMPONENT_NBR,
				JOB_LOG.JOB_DESC, JOB_COMPONENT.JOB_COMP_DESC
		End	
	
	END

UPDATE #myprojects
SET TrafficCount = 	(SELECT COUNT(*)
			FROM JOB_TRAFFIC_DET
			WHERE JOB_TRAFFIC_DET.JOB_NUMBER = #myprojects.JobNo
			AND JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = #myprojects.JobCompNo
			AND JOB_TRAFFIC_DET.JOB_COMPLETED_DATE IS NULL)


IF @SortVal = 'default'
SELECT *
FROM #myprojects
WHERE LOWER(CDP) LIKE '%' + LOWER(@Search) + '%' OR LOWER(JobAndComp) LIKE '%' + LOWER(@Search) + '%' OR LOWER(Status) LIKE '%' + LOWER(@Search) + '%' OR LOWER(AE) LIKE '%' + LOWER(@Search) + '%' OR LOWER(AECode) LIKE '%' + LOWER(@Search) + '%'
       
ORDER BY DueDate

IF @SortVal = 'CDP'
SELECT *
FROM #myprojects
WHERE LOWER(CDP) LIKE '%' + LOWER(@Search) + '%' OR LOWER(JobAndComp) LIKE '%' + LOWER(@Search) + '%' OR LOWER(Status) LIKE '%' + LOWER(@Search) + '%' OR LOWER(AE) LIKE '%' + LOWER(@Search) + '%' OR LOWER(AECode) LIKE '%' + LOWER(@Search) + '%'
ORDER BY ClientCode,DivCode,ProductCode,DueDate

IF @SortVal = 'jobcomp'
SELECT *
FROM #myprojects
WHERE LOWER(CDP) LIKE '%' + LOWER(@Search) + '%' OR LOWER(JobAndComp) LIKE '%' + LOWER(@Search) + '%' OR LOWER(Status) LIKE '%' + LOWER(@Search) + '%' OR LOWER(AE) LIKE '%' + LOWER(@Search) + '%' OR LOWER(AECode) LIKE '%' + LOWER(@Search) + '%'
ORDER BY JobNo,JobCompNo,DueDate

IF @SortVal = 'startdate' --AND @EmpCode = 'SYSADM'
SELECT *
FROM #myprojects
WHERE LOWER(CDP) LIKE '%' + LOWER(@Search) + '%' OR LOWER(JobAndComp) LIKE '%' + LOWER(@Search) + '%' OR LOWER(Status) LIKE '%' + LOWER(@Search) + '%' OR LOWER(AE) LIKE '%' + LOWER(@Search) + '%' OR LOWER(AECode) LIKE '%' + LOWER(@Search) + '%'
ORDER BY StartDate,DueDate

IF @SortVal = 'duedate'
SELECT *
FROM #myprojects
WHERE LOWER(CDP) LIKE '%' + LOWER(@Search) + '%' OR LOWER(JobAndComp) LIKE '%' + LOWER(@Search) + '%' OR LOWER(Status) LIKE '%' + LOWER(@Search) + '%' OR LOWER(AE) LIKE '%' + LOWER(@Search) + '%' OR LOWER(AECode) LIKE '%' + LOWER(@Search) + '%'
ORDER BY DueDate

IF @SortVal = 'status'
SELECT *
FROM #myprojects
WHERE LOWER(CDP) LIKE '%' + LOWER(@Search) + '%' OR LOWER(JobAndComp) LIKE '%' + LOWER(@Search) + '%' OR LOWER(Status) LIKE '%' + LOWER(@Search) + '%' OR LOWER(AE) LIKE '%' + LOWER(@Search) + '%' OR LOWER(AECode) LIKE '%' + LOWER(@Search) + '%'
ORDER BY Status,DueDate

IF @SortVal = 'ae'
SELECT *
FROM #myprojects
WHERE LOWER(CDP) LIKE '%' + LOWER(@Search) + '%' OR LOWER(JobAndComp) LIKE '%' + LOWER(@Search) + '%' OR LOWER(Status) LIKE '%' + LOWER(@Search) + '%' OR LOWER(AE) LIKE '%' + LOWER(@Search) + '%' OR LOWER(AECode) LIKE '%' + LOWER(@Search) + '%'
ORDER BY AECode,DueDate

IF @SortVal = 'taskcount'
SELECT *
FROM #myprojects
WHERE LOWER(CDP) LIKE '%' + LOWER(@Search) + '%' OR LOWER(JobAndComp) LIKE '%' + LOWER(@Search) + '%' OR LOWER(Status) LIKE '%' + LOWER(@Search) + '%' OR LOWER(AE) LIKE '%' + LOWER(@Search) + '%' OR LOWER(AECode) LIKE '%' + LOWER(@Search) + '%'
ORDER BY TrafficCount,DueDate



DROP TABLE #myprojects


