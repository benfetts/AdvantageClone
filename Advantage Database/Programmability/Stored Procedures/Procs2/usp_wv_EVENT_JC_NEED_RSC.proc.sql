
CREATE PROCEDURE [dbo].[usp_wv_EVENT_JC_NEED_RSC] /*WITH ENCRYPTION*/
	@JOB_NUMBER INT,
	@JOB_COMPONENT_NBR SMALLINT,
	@CUT_OFF_DATE VARCHAR(10),
	@EVENT_GEN_ID INT
AS
/*=========== QUERY ===========*/
    DECLARE @SQL VARCHAR(4000)

    SET @SQL = '
        SELECT MIN(EVENT_DATE) AS MIN_EVENT_DATE,
               MAX(EVENT_DATE) AS MAX_EVENT_DATE
        FROM   EVENT WITH(NOLOCK)
        WHERE  JOB_NUMBER = ' + CAST(@JOB_NUMBER AS VARCHAR) + '
               AND JOB_COMPONENT_NBR = ' + CAST(@JOB_COMPONENT_NBR AS VARCHAR) + '
               AND RESOURCE_CODE IS NULL'
    IF NOT @CUT_OFF_DATE IS NULL
    BEGIN
	    SET @SQL = @SQL + ' AND (EVENT_DATE <= CONVERT(DATETIME, ''' + @CUT_OFF_DATE + ' 23:59:00'', 102))'
    END           
    IF @EVENT_GEN_ID > 0 
    BEGIN
		    SET @SQL = @SQL + ' AND EVENT_GEN_ID = ' + @EVENT_GEN_ID
    END
    SET @SQL = @SQL + ';'
    --PRINT @SQL
    EXEC(@SQL);

    SET @SQL = '
        SELECT EVENT_ID
        FROM   EVENT WITH(NOLOCK)
        WHERE  JOB_NUMBER = ' + CAST(@JOB_NUMBER AS VARCHAR) + '
               AND JOB_COMPONENT_NBR = ' + CAST(@JOB_COMPONENT_NBR AS VARCHAR) + '
               AND RESOURCE_CODE IS NULL'
    IF NOT @CUT_OFF_DATE IS NULL
    BEGIN
	    SET @SQL = @SQL + ' AND (EVENT_DATE <= CONVERT(DATETIME, ''' + @CUT_OFF_DATE + ' 23:59:00'', 102))'
    END           
    IF @EVENT_GEN_ID > 0 
    BEGIN
		    SET @SQL = @SQL + ' AND EVENT_GEN_ID = ' + CAST(@EVENT_GEN_ID AS VARCHAR)
    END
    SET @SQL = @SQL + ' ORDER BY EVENT_ID;'
    --PRINT @SQL
    EXEC(@SQL);
/*=========== QUERY ===========*/
