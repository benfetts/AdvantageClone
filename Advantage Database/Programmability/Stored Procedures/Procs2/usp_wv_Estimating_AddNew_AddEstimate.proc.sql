IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[usp_wv_Estimating_AddNew_AddEstimate]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[usp_wv_Estimating_AddNew_AddEstimate]
GO

CREATE PROCEDURE [dbo].[usp_wv_Estimating_AddNew_AddEstimate]
(
	@CLIENT VARCHAR(6),
	@DIVISION VARCHAR(6),
	@PRODUCT VARCHAR(6),
	@SALES_CLASS VARCHAR(6),
	@MARKUP_PCT DECIMAL(7,3),
	@USER_ID VARCHAR(100),
	@EST_CREATE_DATE SMALLDATETIME,
	@EST_DESC VARCHAR(60),
	@EST_COMP_DESC VARCHAR(60),
	@JOB_NUMBER INT,
	@JOB_COMPONENT_NBR INT,
	@CDP_CONTACT_ID INT,
	@CMP_IDENTIFIER INT,
	@EST_NUM INT OUTPUT
)
AS
BEGIN
	SET NOCOUNT OFF
	
	DECLARE 
	@ERR INT,
	@NEXT_EST_NBR INT,
	@CMP_CODE VARCHAR(6)

	if @CMP_IDENTIFIER IS NOT NULL
	Begin
		SELECT @CMP_CODE = CMP_CODE FROM CAMPAIGN WHERE CMP_IDENTIFIER = @CMP_IDENTIFIER
	End
	
    --SELECT @NEXT_EST_NBR = ISNULL(MAX(ESTIMATE_NUMBER),-1) + 1 FROM ESTIMATE_LOG 
    SELECT    @NEXT_EST_NBR = LAST_NBR + 1
    FROM         ASSIGN_NBR
    WHERE     (COLUMNNAME = 'EST_NUMBER')
    
    INSERT INTO [ESTIMATE_LOG]
		(
			[ESTIMATE_NUMBER],
			[CL_CODE],
			[DIV_CODE],
			[PRD_CODE],
			[CMP_CODE],
			[SC_CODE],
			[EST_MARKUP_PCT],
			[USER_ID],
			[EST_CREATE_DATE],
			[EST_LOG_COMMENT],
			[EST_LOG_DESC],
			[CMP_IDENTIFIER],
			[CMP_LINE_NBR],
			[LOCKED_USER],
			[EST_FTR_COMMENT],
			[EST_LOG_COMMENT_HTML],
			[EST_FTR_COMMENT_HTML]
		)
		VALUES
		(
			@NEXT_EST_NBR,
			@CLIENT,
			@DIVISION,
			@PRODUCT,
			@CMP_CODE,
			@SALES_CLASS,
			@MARKUP_PCT,
			@USER_ID,
			@EST_CREATE_DATE,
			NULL,
			@EST_DESC,
			@CMP_IDENTIFIER,
			NULL,
			NULL,
			NULL,
			NULL,
			NULL
		)

	INSERT INTO [ESTIMATE_COMPONENT]
		(
			[ESTIMATE_NUMBER],
			[EST_COMPONENT_NBR],
			[EST_COMP_DESC],
			[EST_COMP_COMMENT],
			[PRESET_CODE],
			[FNC_SORT_ORDER],
			[MODIFIED_BY],
			[MODIFIED_DATE],
			[CDP_CONTACT_ID],
			[DISPLAY_EMP_TITLE],
			[EST_COMP_COMMENT_HTML]
		)
		VALUES
		(
			@NEXT_EST_NBR,
			1,
			@EST_COMP_DESC,
			NULL,
			NULL,
			NULL,
			NULL,
			NULL,
			@CDP_CONTACT_ID,
			NULL,
			NULL
		)	

	SET @ERR = @@Error

	--RETURN @ERR
END

IF DATALENGTH(@JOB_NUMBER) > 0 AND DATALENGTH(@JOB_COMPONENT_NBR) > 0
    BEGIN
        EXECUTE usp_wv_Estimating_Update_JobEstimate @JOB_NUMBER,@JOB_COMPONENT_NBR,@NEXT_EST_NBR,1
    END
    
If @NEXT_EST_NBR > 0
    BEGIN
        Update ASSIGN_NBR
        Set LAST_NBR = @NEXT_EST_NBR
        WHERE     (COLUMNNAME = 'EST_NUMBER')
    END


SELECT @EST_NUM = @NEXT_EST_NBR


