if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_wv_Estimating_AddNew_AddFunction]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_wv_Estimating_AddNew_AddFunction]
GO

CREATE PROCEDURE [dbo].[usp_wv_Estimating_AddNew_AddFunction]
(
	@ESTIMATE_NUMBER INT,
	@EST_COMPONENT_NBR INT,
	@EST_QUOTE_NBR INT,
    @EST_REV_NBR INT,
	@SEQ_NBR INT,
	@FNC_CODE VARCHAR(6),
	@EST_REV_COMM_PCT DECIMAL(9,3),
	@EST_REV_CONT_PCT DECIMAL(7,3),
	@EST_REV_QUANTITY DECIMAL(15,2),
	@EST_REV_RATE DECIMAL(15,4),
	@EST_REV_SUP_BY_CDE VARCHAR(6),
	@EST_REV_SUP_BY_NTE TEXT,
	@EST_REV_EXT_AMT DECIMAL(15,2),
	@TAX_CODE VARCHAR(4),
	@EST_FNC_COMMENT TEXT,
    @EXT_MARKUP_AMT DECIMAL(14,2),
	@EXT_CONTINGENCY DECIMAL(14,2),
	@LINE_TOTAL DECIMAL(14,2),
    @INCL_CPU INT,
	@USER_ID VARCHAR(100),
	@EST_FNC_TYPE VARCHAR(1),
    @EST_CPM_FLAG SMALLINT,
	@TAX_STATE_PCT DECIMAL(7,4),
	@TAX_COUNTY_PCT DECIMAL(7,4),
	@TAX_CITY_PCT DECIMAL(7,4),
    @TAX_COMM SMALLINT,
	@TAX_COMM_ONLY SMALLINT,
	@TAX_RESALE SMALLINT,
	@EST_COMM_FLAG SMALLINT,
	@EST_TAX_FLAG SMALLINT,
	@EST_NONBILL_FLAG SMALLINT,
	@EXT_NONRESALE_TAX DECIMAL(14,2),
	@EXT_STATE_RESALE DECIMAL(14,2),
	@EXT_COUNTY_RESALE DECIMAL(14,2),
	@EXT_CITY_RESALE DECIMAL(14,2),
	@EXT_MU_CONT DECIMAL(14,2),
	@EXT_STATE_CONT DECIMAL(14,2),
	@EXT_COUNTY_CONT DECIMAL(14,2),
	@EXT_CITY_CONT DECIMAL(14,2),
	@EXT_NR_CONT DECIMAL(14,2),
	@LINE_TOTAL_CONT DECIMAL(14,2),
	@FEE_TIME SMALLINT,
	@EMPLOYEE_TITLE_ID INTEGER
)
AS
BEGIN
	SET NOCOUNT OFF
	DECLARE 
	@ERR INT,
	@NEXT_SEQ_NBR INT

	if @FNC_CODE IS NOT NULL AND @FNC_CODE <> ''
	BEGIN
		SELECT @NEXT_SEQ_NBR = ISNULL(MAX(SEQ_NBR),-1) + 1 FROM ESTIMATE_REV_DET
		WHERE ESTIMATE_NUMBER = @ESTIMATE_NUMBER AND EST_COMPONENT_NBR = @EST_COMPONENT_NBR AND EST_QUOTE_NBR = @EST_QUOTE_NBR
				AND EST_REV_NBR = @EST_REV_NBR
    
		if @NEXT_SEQ_NBR = 0
		Begin
			SET @NEXT_SEQ_NBR = 1
		End 
		--if @SEQ_NBR <> 0
		--Begin
		--	SET @NEXT_SEQ_NBR = @SEQ_NBR
		--End

		if @EST_FNC_TYPE IS NULL OR @EST_FNC_TYPE = ''
		Begin
			SELECT @EST_FNC_TYPE = (SELECT FNC_TYPE FROM FUNCTIONS WHERE FNC_CODE = @FNC_CODE)
		End

    INSERT INTO [ESTIMATE_REV_DET]
		(
			[ESTIMATE_NUMBER],
			[EST_COMPONENT_NBR],
			[EST_QUOTE_NBR],
			[EST_REV_NBR],
			[SEQ_NBR],
			[FNC_CODE],
			[EST_REV_COMM_PCT],
			[EST_REV_CONT_PCT],
			[EST_REV_QUANTITY],
			[EST_REV_RATE],
			[EST_REV_SUP_BY_CDE],
			[EST_REV_SUP_BY_NTE],
			[EST_REV_EXT_AMT],
			[TAX_CODE],
			[EST_FNC_COMMENT],
			[EXT_MARKUP_AMT],
			[EXT_CONTINGENCY],
			[LINE_TOTAL],
			[INCL_CPU],
			[EST_FNC_TYPE],
			[EST_CPM_FLAG],
			[TAX_STATE_PCT],
			[TAX_COUNTY_PCT],
			[TAX_CITY_PCT],
			[TAX_COMM],
			[TAX_COMM_ONLY],
			[TAX_RESALE],
			[EST_COMM_FLAG],
			[EST_TAX_FLAG],
			[EST_NONBILL_FLAG],
			[EXT_NONRESALE_TAX],
			[EXT_STATE_RESALE],
			[EXT_COUNTY_RESALE],
			[EXT_CITY_RESALE],
			[EXT_MU_CONT],
			[EXT_STATE_CONT],
			[EXT_COUNTY_CONT],
			[EXT_CITY_CONT],
			[EXT_NR_CONT],
			[LINE_TOTAL_CONT],
			[FEE_TIME],
			[EST_FNC_COMMENT_HTML],
			[EMPLOYEE_TITLE_ID]
		)
		VALUES
		(
			@ESTIMATE_NUMBER,
			@EST_COMPONENT_NBR,
			@EST_QUOTE_NBR,
			@EST_REV_NBR,
			@NEXT_SEQ_NBR,
			@FNC_CODE,
			@EST_REV_COMM_PCT,
			@EST_REV_CONT_PCT,
			@EST_REV_QUANTITY,
			@EST_REV_RATE,
			@EST_REV_SUP_BY_CDE,
			@EST_REV_SUP_BY_NTE,
			@EST_REV_EXT_AMT,
			@TAX_CODE,
			@EST_FNC_COMMENT,
			@EXT_MARKUP_AMT,
			@EXT_CONTINGENCY,
			@LINE_TOTAL,
			@INCL_CPU,
			@EST_FNC_TYPE,
			@EST_CPM_FLAG,
			@TAX_STATE_PCT,
			@TAX_COUNTY_PCT,
			@TAX_CITY_PCT,
			@TAX_COMM,
			@TAX_COMM_ONLY,
			@TAX_RESALE,
			@EST_COMM_FLAG,
			@EST_TAX_FLAG,
			@EST_NONBILL_FLAG,
			@EXT_NONRESALE_TAX,
			@EXT_STATE_RESALE,
			@EXT_COUNTY_RESALE,
			@EXT_CITY_RESALE,
			@EXT_MU_CONT,
			@EXT_STATE_CONT,
			@EXT_COUNTY_CONT,
			@EXT_CITY_CONT,
			@EXT_NR_CONT,
			@LINE_TOTAL_CONT,
			@FEE_TIME,
			@EST_FNC_COMMENT,
			@EMPLOYEE_TITLE_ID
		)	

		SET @ERR = @@Error

		--RETURN @ERR
	END
		 
    
END

--SELECT @QTE_NUM = @NEXT_EST_NBR


