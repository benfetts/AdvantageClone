if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_wv_Estimating_Data]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_wv_Estimating_Data]
GO



CREATE PROCEDURE [dbo].[usp_wv_Estimating_Data] 
@EstNo Int,
@EstCompNo Int,
@JobNo Int,
@JobCompNo Int,
@UserID varchar(100)
AS
Declare @Restrictions Int,
		@sql nvarchar(4000),
		@paramlist nvarchar(4000)

Select @Restrictions = Count(*) 
FROM SEC_CLIENT
WHERE UPPER(USER_ID) = UPPER(@UserID)

SELECT @sql = 'SELECT ESTIMATE_LOG.ESTIMATE_NUMBER, ESTIMATE_LOG.EST_LOG_DESC, ESTIMATE_COMPONENT.EST_COMPONENT_NBR, 
                      ESTIMATE_COMPONENT.EST_COMP_DESC, ESTIMATE_LOG.CL_CODE, CLIENT.CL_NAME, ESTIMATE_LOG.DIV_CODE, 
                      DIVISION.DIV_NAME, ESTIMATE_LOG.PRD_CODE, PRODUCT.PRD_DESCRIPTION, JOB_LOG.JOB_NUMBER, 
                      JOB_LOG.JOB_DESC, JOB_COMPONENT.JOB_COMPONENT_NBR, JOB_COMPONENT.JOB_COMP_DESC, ESTIMATE_LOG.EST_LOG_COMMENT,
					  ESTIMATE_COMPONENT.EST_COMP_COMMENT, ESTIMATE_LOG.SC_CODE, SALES_CLASS.SC_DESCRIPTION, JOB_LOG.CMP_IDENTIFIER,
					  CAMPAIGN.CMP_CODE, CAMPAIGN.CMP_NAME, ESTIMATE_COMPONENT.CDP_CONTACT_ID, ESTIMATE_COMPONENT.EST_PRD_CONT_CODE, 
					  CDP_CONTACT_HDR.CONT_FML, JOB_LOG.JOB_CLI_REF, ISNULL(ESTIMATE_LOG.EST_MARKUP_PCT,0.000) AS EST_MARKUP_PCT, ESTIMATE_LOG.EST_CREATE_DATE,
					  ESTIMATE_LOG.EST_FTR_COMMENT, dbo.udf_get_empl_name(JOB_COMPONENT.EMP_CODE, ''FML'') AS AE, ESTIMATE_LOG.EST_LOG_COMMENT_HTML,
					  ESTIMATE_COMPONENT.EST_COMP_COMMENT_HTML, ESTIMATE_LOG.EST_FTR_COMMENT_HTML, ESTIMATE_LOG.CMP_IDENTIFIER AS EST_CMP_ID,EC.CMP_CODE AS EST_CMP_CODE, EC.CMP_NAME AS EST_CMP_NAME 
			   FROM   JOB_LOG INNER JOIN
                      JOB_COMPONENT ON JOB_LOG.JOB_NUMBER = JOB_COMPONENT.JOB_NUMBER RIGHT OUTER JOIN
                      ESTIMATE_COMPONENT INNER JOIN
                      ESTIMATE_LOG ON ESTIMATE_COMPONENT.ESTIMATE_NUMBER = ESTIMATE_LOG.ESTIMATE_NUMBER INNER JOIN
                      PRODUCT ON ESTIMATE_LOG.CL_CODE = PRODUCT.CL_CODE AND ESTIMATE_LOG.DIV_CODE = PRODUCT.DIV_CODE AND 
                      ESTIMATE_LOG.PRD_CODE = PRODUCT.PRD_CODE INNER JOIN
                      DIVISION ON PRODUCT.CL_CODE = DIVISION.CL_CODE AND PRODUCT.DIV_CODE = DIVISION.DIV_CODE INNER JOIN
                      CLIENT ON DIVISION.CL_CODE = CLIENT.CL_CODE ON 
                      JOB_COMPONENT.ESTIMATE_NUMBER = ESTIMATE_COMPONENT.ESTIMATE_NUMBER AND 
                      JOB_COMPONENT.EST_COMPONENT_NBR = ESTIMATE_COMPONENT.EST_COMPONENT_NBR LEFT OUTER JOIN
                      CAMPAIGN ON JOB_LOG.CMP_IDENTIFIER = CAMPAIGN.CMP_IDENTIFIER INNER JOIN
					  SALES_CLASS ON ESTIMATE_LOG.SC_CODE = SALES_CLASS.SC_CODE LEFT OUTER JOIN
                      CDP_CONTACT_HDR ON ESTIMATE_COMPONENT.CDP_CONTACT_ID = CDP_CONTACT_HDR.CDP_CONTACT_ID LEFT OUTER JOIN
                      CAMPAIGN EC ON ESTIMATE_LOG.CMP_IDENTIFIER = EC.CMP_IDENTIFIER
					  WHERE 1=1'
			if @EstNo <> 0 and @EstCompNo <> 0
				Begin
					SELECT @sql = @sql + ' AND ESTIMATE_LOG.ESTIMATE_NUMBER = @EstNo AND ESTIMATE_COMPONENT.EST_COMPONENT_NBR = @EstCompNo'
				End
			if @JobNo <> 0 and @JobCompNo <> 0
				Begin
					SELECT @sql = @sql + ' AND JOB_LOG.JOB_NUMBER = @JobNo AND JOB_COMPONENT.JOB_COMPONENT_NBR = @JobCompNo'
				End
			
SELECT @paramlist = '@EstNo Int, @EstCompNo Int, @JobNo Int, @JobCompNo Int, @UserID Varchar(100)'

EXEC sp_executesql @sql, @paramlist, @EstNo, @EstCompNo, @JobNo, @JobCompNo, @UserID























