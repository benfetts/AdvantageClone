IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[usp_wv_Estimating_GetComments_FH]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[usp_wv_Estimating_GetComments_FH]
GO

CREATE PROCEDURE [dbo].[usp_wv_Estimating_GetComments_FH]
(
	@EST_NBR INT,
	@EST_COMPONENT_NBR INT,
	@EST_QUOTE_NBR INT,
	@EST_REV_NBR INT,
	@FNC_HEADING_ID INT
)
AS
DECLARE @sql nvarchar(4000),
	@paramlist nvarchar(4000)

BEGIN
	SELECT @sql = 'SELECT EQ.ESTIMATE_NUMBER, EQ.EST_COMPONENT_NBR, EQ.EST_QUOTE_NBR, ESTIMATE_REV.EST_REV_NBR,
			ISNULL(EL.EST_LOG_COMMENT,'''') AS EST_LOG_COMMENT, ISNULL(EL.EST_LOG_COMMENT_HTML,'''') AS EST_LOG_COMMENT_HTML,
			ISNULL(E.EST_FNC_COMMENT,'''') AS EST_FNC_COMMENT, ISNULL(E.EST_FNC_COMMENT_HTML,'''') AS EST_FNC_COMMENT_HTML,
			ISNULL(EC.EST_COMP_COMMENT,'''') AS EST_COMP_COMMENT, ISNULL(EC.EST_COMP_COMMENT_HTML,'''') AS EST_COMP_COMMENT_HTML,
			ISNULL(EQ.EST_QTE_COMMENT,'''') AS EST_QTE_COMMENT, ISNULL(EQ.EST_QTE_COMMENT_HTML,'''') AS EST_QTE_COMMENT_HTML,
			ISNULL(ESTIMATE_REV.EST_REV_COMMENT,'''') AS EST_REV_COMMENT, ISNULL(ESTIMATE_REV.EST_REV_COMMENT_HTML,'''') AS EST_REV_COMMENT_HTML, ISNULL(FNC_HEADING.FNC_HEADING_ID,0)
	FROM         ESTIMATE_QUOTE EQ INNER JOIN
						  ESTIMATE_REV ON EQ.ESTIMATE_NUMBER = ESTIMATE_REV.ESTIMATE_NUMBER AND 
						  EQ.EST_COMPONENT_NBR = ESTIMATE_REV.EST_COMPONENT_NBR AND 
						  EQ.EST_QUOTE_NBR = ESTIMATE_REV.EST_QUOTE_NBR INNER JOIN
						  ESTIMATE_COMPONENT EC ON EQ.ESTIMATE_NUMBER = EC.ESTIMATE_NUMBER AND 
						  EQ.EST_COMPONENT_NBR = EC.EST_COMPONENT_NBR INNER JOIN
						  ESTIMATE_LOG EL ON EC.ESTIMATE_NUMBER = EL.ESTIMATE_NUMBER INNER JOIN
						  ESTIMATE_REV_DET E ON ESTIMATE_REV.ESTIMATE_NUMBER = E.ESTIMATE_NUMBER AND 
						  ESTIMATE_REV.EST_COMPONENT_NBR = E.EST_COMPONENT_NBR AND 
						  ESTIMATE_REV.EST_QUOTE_NBR = E.EST_QUOTE_NBR AND 
						  ESTIMATE_REV.EST_REV_NBR = E.EST_REV_NBR INNER JOIN
						  FUNCTIONS ON E.FNC_CODE = FUNCTIONS.FNC_CODE LEFT OUTER JOIN
						  JOB_COMPONENT ON EC.ESTIMATE_NUMBER = JOB_COMPONENT.ESTIMATE_NUMBER AND 
						  EC.EST_COMPONENT_NBR = JOB_COMPONENT.EST_COMPONENT_NBR LEFT OUTER JOIN 
						  JOB_LOG ON JOB_LOG.JOB_NUMBER = JOB_COMPONENT.JOB_NUMBER LEFT OUTER JOIN
                          FNC_HEADING ON FUNCTIONS.FNC_HEADING_ID = FNC_HEADING.FNC_HEADING_ID
	WHERE     (EQ.ESTIMATE_NUMBER = @EST_NBR) AND (EQ.EST_COMPONENT_NBR = @EST_COMPONENT_NBR) AND 
						  (EQ.EST_QUOTE_NBR = @EST_QUOTE_NBR) AND (ESTIMATE_REV.EST_REV_NBR = @EST_REV_NBR) AND (ISNULL(FNC_HEADING.FNC_HEADING_ID,0) = @FNC_HEADING_ID)
	ORDER BY FNC_HEADING.FNC_HEADING_ID'

	
SELECT @paramlist = '@EST_NBR INT, @EST_COMPONENT_NBR INT, @EST_QUOTE_NBR INT, @EST_REV_NBR INT, @FNC_HEADING_ID INT'
print @sql
EXEC sp_executesql @sql, @paramlist, @EST_NBR, @EST_COMPONENT_NBR, @EST_QUOTE_NBR, @EST_REV_NBR, @FNC_HEADING_ID



END





