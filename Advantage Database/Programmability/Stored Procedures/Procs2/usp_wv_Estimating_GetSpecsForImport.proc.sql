





CREATE PROCEDURE [dbo].[usp_wv_Estimating_GetSpecsForImport]
@EstNumber int,
@EstCompNumber int
AS
DECLARE @NumberRecords int, @RowCount int,
	@SpecVer int,
	@SpecRev int,
	@SpecDesc varchar(60),
	@JobNumber int,
    @JobCompNumber int
	
CREATE TABLE #MY_DATA --MASTER TABLE TO RETURN
    (
        [RowID]          int IDENTITY(1, 1),
	    [SPEC_VER]       int,
	    [SPEC_REV]       int,
	    [SPEC_TYPE_CODE] VARCHAR(6),
	    [SPEC_VER_DESC]  VARCHAR(60)
    )	
INSERT INTO #MY_DATA    
SELECT DISTINCT JOB_SPECS.SPEC_VER, MAX(JOB_SPECS.SPEC_REV) AS SPEC_REV, JOB_SPECS.SPEC_TYPE_CODE, ''
FROM   ESTIMATE_LOG INNER JOIN
                      ESTIMATE_COMPONENT ON ESTIMATE_COMPONENT.ESTIMATE_NUMBER = ESTIMATE_LOG.ESTIMATE_NUMBER INNER JOIN
                      JOB_COMPONENT ON ESTIMATE_COMPONENT.ESTIMATE_NUMBER = JOB_COMPONENT.ESTIMATE_NUMBER AND 
                      ESTIMATE_COMPONENT.EST_COMPONENT_NBR = JOB_COMPONENT.EST_COMPONENT_NBR INNER JOIN
                      JOB_SPECS ON JOB_COMPONENT.JOB_NUMBER = JOB_SPECS.JOB_NUMBER AND 
                      JOB_COMPONENT.JOB_COMPONENT_NBR = JOB_SPECS.JOB_COMPONENT_NBR LEFT OUTER JOIN
                      JOB_SPEC_APPR ON JOB_SPECS.JOB_NUMBER = JOB_SPEC_APPR.JOB_NUMBER AND 
                      JOB_SPECS.JOB_COMPONENT_NBR = JOB_SPEC_APPR.JOB_COMPONENT_NBR AND 
                      JOB_SPECS.SPEC_VER = JOB_SPEC_APPR.APPR_SPEC_VER
WHERE     (ESTIMATE_COMPONENT.ESTIMATE_NUMBER = @EstNumber) AND (ESTIMATE_COMPONENT.EST_COMPONENT_NBR = @EstCompNumber)
GROUP BY JOB_SPECS.SPEC_VER, JOB_SPECS.SPEC_TYPE_CODE


SET @JobNumber = 0
SET @JobCompNumber = 0
SELECT @JobNumber = ISNULL(JOB_NUMBER,0), @JobCompNumber = ISNULL(JOB_COMPONENT_NBR,0)
FROM JOB_COMPONENT
WHERE JOB_COMPONENT.ESTIMATE_NUMBER = @EstNumber AND JOB_COMPONENT.EST_COMPONENT_NBR = @EstCompNumber                                                

SELECT @NumberRecords = COUNT(*) FROM #MY_DATA
SET @RowCount = 0

WHILE @RowCount <= @NumberRecords
BEGIN
 SELECT @SpecVer = SPEC_VER, @SpecRev = SPEC_REV
 FROM #MY_DATA
 WHERE RowID = @RowCount
 
 SELECT @SpecDesc = SPEC_VER_DESC 
 FROM JOB_SPECS
 WHERE JOB_NUMBER = @JobNumber AND JOB_COMPONENT_NBR = @JobCompNumber AND SPEC_VER = @SpecVer AND SPEC_REV = @SpecRev
 
 UPDATE #MY_DATA 
SET SPEC_VER_DESC = @SpecDesc
WHERE SPEC_VER = @SpecVer AND SPEC_REV = @SpecRev
 
 SET @RowCount = @RowCount + 1
END

SELECT SPEC_VER, SPEC_REV, SPEC_TYPE_CODE, SPEC_VER_DESC
FROM #MY_DATA

DROP TABLE #MY_DATA;

