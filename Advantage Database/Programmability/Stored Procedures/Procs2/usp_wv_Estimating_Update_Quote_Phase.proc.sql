

CREATE PROCEDURE [dbo].[usp_wv_Estimating_Update_Quote_Phase]
(
	@ESTIMATE_NUMBER INT,
	@EST_COMPONENT_NBR INT,
	@EST_QUOTE_NBR INT,
	@EST_REV_NBR INT,
	@SEQ_NBR VARCHAR(500),
	@EST_PHASE_ID SMALLINT,
	@EST_PHASE_DESC VARCHAR(60)
)
AS
BEGIN
	SET NOCOUNT OFF
	DECLARE 
	@ERR INT,
	@NEXT_PHASE_NBR INT,
	@Restrictions Int,
	@sql nvarchar(4000),
	@paramlist nvarchar(4000)
	
	if @EST_PHASE_ID = 0
		Begin
			SELECT @NEXT_PHASE_NBR = ISNULL(MAX(EST_PHASE_ID),0) + 1 FROM ESTIMATE_REV_DET 
			WHERE [ESTIMATE_NUMBER] = @ESTIMATE_NUMBER AND
				[EST_COMPONENT_NBR] = @EST_COMPONENT_NBR
		End
    else
		Begin
			SET @NEXT_PHASE_NBR = @EST_PHASE_ID
		End

	if @EST_PHASE_ID = -1
		Begin
			SELECT @sql = 'UPDATE [ESTIMATE_REV_DET]
			SET	[EST_PHASE_ID] = NULL,
				[EST_PHASE_DESC] = NULL
			WHERE [ESTIMATE_NUMBER] = @ESTIMATE_NUMBER AND
				  [EST_COMPONENT_NBR] = @EST_COMPONENT_NBR AND
				  [EST_QUOTE_NBR] = @EST_QUOTE_NBR AND
				  [EST_REV_NBR] = @EST_REV_NBR
				  AND SEQ_NBR IN ('+@SEQ_NBR+')'
		End
	else
		Begin
			SELECT @sql = 'UPDATE [ESTIMATE_REV_DET]
			SET	[EST_PHASE_ID] = @NEXT_PHASE_NBR,
				[EST_PHASE_DESC] = @EST_PHASE_DESC
			WHERE [ESTIMATE_NUMBER] = @ESTIMATE_NUMBER AND
				  [EST_COMPONENT_NBR] = @EST_COMPONENT_NBR AND
				  [EST_QUOTE_NBR] = @EST_QUOTE_NBR AND
				  [EST_REV_NBR] = @EST_REV_NBR
				  AND SEQ_NBR IN ('+@SEQ_NBR+')'
		End
    	
SELECT @paramlist = '@ESTIMATE_NUMBER int, @EST_COMPONENT_NBR int, @EST_QUOTE_NBR int, @EST_REV_NBR int, @NEXT_PHASE_NBR int, @EST_PHASE_DESC Varchar(60)'
print @sql
EXEC sp_executesql @sql, @paramlist, @ESTIMATE_NUMBER, @EST_COMPONENT_NBR, @EST_QUOTE_NBR, @EST_REV_NBR, @NEXT_PHASE_NBR, @EST_PHASE_DESC	
			
			
			

	SET @ERR = @@Error

	--RETURN @ERR
END

--SELECT @QTE_NUM = @NEXT_EST_NBR


