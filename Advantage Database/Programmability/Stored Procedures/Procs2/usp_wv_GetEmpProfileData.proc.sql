SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS OFF 
GO
if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_wv_GetEmpProfileData]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_wv_GetEmpProfileData]
GO
CREATE PROCEDURE [dbo].[usp_wv_GetEmpProfileData] 
@EmpCode as VarChar(6),
@UserCode as VarChar(100)
AS

	DECLARE @OfficeRestrictions AS INTEGER	
	DECLARE @EMP_CDE AS VARCHAR(6)
	SELECT @EMP_CDE = EMP_CODE FROM [dbo].[SEC_USER] WHERE UPPER([USER_CODE]) = UPPER(@UserCode)
	SELECT @OfficeRestrictions = COUNT(1) FROM EMP_OFFICE WHERE EMP_CODE = @EMP_CDE
	SET @EmpCode = ISNULL(@EmpCode, '');

IF @EmpCode <> ''
BEGIN
	IF @OfficeRestrictions > 0
	BEGIN
		SELECT     
			EMPLOYEE_PICTURE.EMP_PICTURE_ID, 
			EMPLOYEE.EMP_CODE, 
			EMPLOYEE_PICTURE.EMP_IMAGE, 
			COALESCE (RTRIM(EMPLOYEE.EMP_FNAME) + ' ', '') + COALESCE (EMPLOYEE.EMP_MI + '. ', '') + COALESCE (EMPLOYEE.EMP_LNAME, '') AS EMP_NAME, 
			EMPLOYEE.EMP_FNAME, 
			EMPLOYEE.EMP_MI, 
			EMPLOYEE.EMP_LNAME,
			EMPLOYEE_PICTURE.EMP_NICKNAME, 
			EMPLOYEE_PICTURE.EMP_WALLPAPER
		FROM         
			EMPLOYEE 
			LEFT OUTER JOIN EMPLOYEE_PICTURE ON EMPLOYEE.EMP_CODE = EMPLOYEE_PICTURE.EMP_CODE 
			INNER JOIN EMP_OFFICE ON EMPLOYEE.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = @EMP_CDE
		WHERE     
			(EMPLOYEE.EMP_CODE = @EmpCode)
		ORDER BY
			EMPLOYEE.EMP_FNAME
	END
	ELSE
	BEGIN
		SELECT     
			EMPLOYEE_PICTURE.EMP_PICTURE_ID, 
			EMPLOYEE.EMP_CODE, 
			EMPLOYEE_PICTURE.EMP_IMAGE, 
			COALESCE (RTRIM(EMPLOYEE.EMP_FNAME) + ' ', '') + COALESCE (EMPLOYEE.EMP_MI + '. ', '') + COALESCE (EMPLOYEE.EMP_LNAME, '') AS EMP_NAME, 
			EMPLOYEE.EMP_FNAME, 
			EMPLOYEE.EMP_MI, 
			EMPLOYEE.EMP_LNAME,
			EMPLOYEE_PICTURE.EMP_NICKNAME, 
			EMPLOYEE_PICTURE.EMP_WALLPAPER
		FROM         
			EMPLOYEE 
			LEFT OUTER JOIN EMPLOYEE_PICTURE ON EMPLOYEE.EMP_CODE = EMPLOYEE_PICTURE.EMP_CODE
		WHERE     
			(EMPLOYEE.EMP_CODE = @EmpCode)
		ORDER BY
			EMPLOYEE.EMP_FNAME
	END
END
ELSE
BEGIN
	IF @OfficeRestrictions > 0
	BEGIN
		SELECT     
			EMPLOYEE_PICTURE.EMP_PICTURE_ID, 
			EMPLOYEE.EMP_CODE, 
			EMPLOYEE_PICTURE.EMP_IMAGE, 
			COALESCE (RTRIM(EMPLOYEE.EMP_FNAME) + ' ', '') + COALESCE (EMPLOYEE.EMP_MI + '. ', '') + COALESCE (EMPLOYEE.EMP_LNAME, '') AS EMP_NAME, 
			EMPLOYEE.EMP_FNAME, 
			EMPLOYEE.EMP_MI, 
			EMPLOYEE.EMP_LNAME,
			EMPLOYEE_PICTURE.EMP_NICKNAME, 
			EMPLOYEE_PICTURE.EMP_WALLPAPER
		FROM         
			EMPLOYEE 
			LEFT OUTER JOIN EMPLOYEE_PICTURE ON EMPLOYEE.EMP_CODE = EMPLOYEE_PICTURE.EMP_CODE 
			INNER JOIN EMP_OFFICE ON EMPLOYEE.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = @EMP_CDE
		WHERE		
			EMP_TERM_DATE IS NULL
		ORDER BY
			EMPLOYEE.EMP_FNAME
	END
	ELSE
	BEGIN
		SELECT     
			EMPLOYEE_PICTURE.EMP_PICTURE_ID, 
			EMPLOYEE.EMP_CODE, 
			EMPLOYEE_PICTURE.EMP_IMAGE, 
			COALESCE (RTRIM(EMPLOYEE.EMP_FNAME) + ' ', '') + COALESCE (EMPLOYEE.EMP_MI + '. ', '') + COALESCE (EMPLOYEE.EMP_LNAME, '') AS EMP_NAME, 
			EMPLOYEE.EMP_FNAME, 
			EMPLOYEE.EMP_MI, 
			EMPLOYEE.EMP_LNAME,
			EMPLOYEE_PICTURE.EMP_NICKNAME, 
			EMPLOYEE_PICTURE.EMP_WALLPAPER
		FROM         
			EMPLOYEE 
			LEFT OUTER JOIN EMPLOYEE_PICTURE ON EMPLOYEE.EMP_CODE = EMPLOYEE_PICTURE.EMP_CODE
		WHERE		
			EMP_TERM_DATE IS NULL
		ORDER BY
			EMPLOYEE.EMP_FNAME
	END
END

GO
SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO