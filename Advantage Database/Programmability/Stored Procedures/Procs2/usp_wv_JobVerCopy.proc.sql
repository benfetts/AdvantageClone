


/*****************************************************************
Copies a template record and attaches it to a component
******************************************************************/
CREATE PROCEDURE [dbo].[usp_wv_JobVerCopy] 
@JOB 		INTEGER,
@COMP 		SMALLINT,
@TMPLT_CODE 	VARCHAR(6),
@JOB_VER_HDR_ID_COPY INT,
@USER_ID 	VARCHAR(100),
@CPID	INT
 
AS
DECLARE @SEQ_NBR AS SMALLINT
DECLARE @JOB_VER_HDR_ID AS INTEGER, @CPID_JV AS INTEGER

Set NoCount on

SELECT @SEQ_NBR = MAX(JOB_VER_SEQ_NBR) + 1 FROM JOB_VER_HDR
WHERE JOB_NUMBER = @JOB AND JOB_COMPONENT_NBR = @COMP

IF @SEQ_NBR IS NULL 
	SET @SEQ_NBR = 1

INSERT INTO JOB_VER_HDR ( JOB_NUMBER, JOB_COMPONENT_NBR, JOB_VER_SEQ_NBR, JV_TMPLT_CODE, JOB_VER_DESC, CREATE_DATE, CREATED_BY, CREATED_BY_CP)
SELECT @JOB, @COMP, @SEQ_NBR, JV_TMPLT_CODE, JOB_VER_DESC, getdate(), @USER_ID, @CPID 
FROM JOB_VER_HDR 
WHERE JOB_VER_HDR_ID = @JOB_VER_HDR_ID_COPY
--VALUES (@JOB, @COMP, @SEQ_NBR, @TMPLT_CODE, getdate(), @USER_ID)


SELECT @JOB_VER_HDR_ID = JOB_VER_HDR_ID, @CPID_JV = ISNULL(CREATED_BY_CP,0) FROM JOB_VER_HDR WHERE JOB_VER_SEQ_NBR = @SEQ_NBR

INSERT INTO JOB_VER_DTL
SELECT @JOB_VER_HDR_ID, JV_TMPLT_DTL_ID, JOB_VER_VALUE FROM JOB_VER_DTL WHERE JOB_VER_HDR_ID = @JOB_VER_HDR_ID_COPY

SELECT @JOB_VER_HDR_ID, @CPID_JV

