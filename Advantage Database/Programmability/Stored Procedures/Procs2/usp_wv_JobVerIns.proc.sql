IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[usp_wv_JobVerIns]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[usp_wv_JobVerIns]
GO
CREATE PROCEDURE [dbo].[usp_wv_JobVerIns] 
@JOB 		INTEGER,
@COMP 		SMALLINT,
@TMPLT_CODE 	VARCHAR(6),
@USER_ID 	VARCHAR(100),
@CPID	INT,
@CREATE_DATE SMALLDATETIME
AS
BEGIN
	DECLARE 
		@SEQ_NBR AS SMALLINT, 
		@ID AS INTEGER, 
		@JOB_VER_HDR_ID AS INTEGER, 
		@CPID_JV AS INTEGER

	SELECT 
		@SEQ_NBR = MAX(JOB_VER_SEQ_NBR) + 1 
	FROM 
		JOB_VER_HDR
	WHERE 
		JOB_NUMBER = @JOB AND JOB_COMPONENT_NBR = @COMP;

	IF @SEQ_NBR IS NULL 
	BEGIN
		SET @SEQ_NBR = 1;
	END

	IF @JOB = 0
	BEGIN
		INSERT INTO JOB_VER_HDR ( JOB_NUMBER, JOB_COMPONENT_NBR, JOB_VER_SEQ_NBR, JV_TMPLT_CODE, CREATE_DATE, CREATED_BY, CREATED_BY_CP)
		VALUES (@JOB, @COMP, @SEQ_NBR, @TMPLT_CODE, @CREATE_DATE, @USER_ID, @CPID);
	END
	ELSE
	BEGIN
		INSERT INTO JOB_VER_HDR ( JOB_NUMBER, JOB_COMPONENT_NBR, JOB_VER_SEQ_NBR, JV_TMPLT_CODE, CREATE_DATE, CREATED_BY, CREATED_BY_CP)
		VALUES (@JOB, @COMP, @SEQ_NBR, @TMPLT_CODE, @CREATE_DATE, @USER_ID, @CPID);
	END

	SELECT @JOB_VER_HDR_ID = SCOPE_IDENTITY();

	SELECT @CPID_JV = ISNULL(CREATED_BY_CP, 0) FROM JOB_VER_HDR WHERE JOB_VER_HDR_ID = @JOB_VER_HDR_ID AND JOB_VER_SEQ_NBR = @SEQ_NBR;

	INSERT INTO JOB_VER_DTL
	SELECT @JOB_VER_HDR_ID, JV_TMPLT_DTL_ID, NULL FROM JOB_VER_TMPLT_DTL WHERE JV_TMPLT_CODE = @TMPLT_CODE;

	SELECT @JOB_VER_HDR_ID, @CPID_JV;

END
