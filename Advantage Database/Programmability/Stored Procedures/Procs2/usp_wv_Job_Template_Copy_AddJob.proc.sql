IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[usp_wv_Job_Template_Copy_AddJob]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[usp_wv_Job_Template_Copy_AddJob]
GO
CREATE PROCEDURE [dbo].[usp_wv_Job_Template_Copy_AddJob]
(
	@JobNo INT,
	@JOB_DESC VARCHAR(60),
	@CLIENT VARCHAR(6),
	@DIVISION VARCHAR(6),
	@PRODUCT VARCHAR(6),
	@SALES_CLASS VARCHAR(6),
	@USER_ID VARCHAR(100),
	@CAMPAIGN_ID INT,
	@CAMPAIGN_CODE VARCHAR(6),
	@JOB_NUM INT OUTPUT,
	@CREATE_DATE SMALLDATETIME

)
AS
BEGIN
	SET NOCOUNT OFF
	
	IF @CAMPAIGN_ID IS NOT NULL AND @CAMPAIGN_ID = 0 BEGIN

		SET @CAMPAIGN_ID = NULL

	END
		
	IF @CAMPAIGN_CODE IS NOT NULL AND RTRIM(LTRIM(@CAMPAIGN_CODE)) = '' BEGIN

		SET @CAMPAIGN_CODE = NULL

	END

	DECLARE 
	@ERR INT,
	@NEXT_JOB_NBR INT,
	@OfficeCode VarChar(4),
	@Editable bit,	
	@UDV_CODE varchar(100)
    --@ProdMarkup Decimal(11,3)
	
    SELECT    @NEXT_JOB_NBR = LAST_NBR + 1
	FROM         ASSIGN_NBR
	WHERE     (COLUMNNAME = 'JOB_NUMBER')

--	Select @ProdMarkup = PRD_PROD_MARKUP
--	From PRODUCT
--	Where 
--		PRD_CODE = @PRODUCT
--		AND CL_CODE = @CLIENT
--		AND DIV_CODE = @DIVISION


	--Get Office Code
	SELECT @OfficeCode = OFFICE_CODE
	FROM PRODUCT
	WHERE 
		PRD_CODE = @PRODUCT
		AND CL_CODE = @CLIENT
		AND DIV_CODE = @DIVISION
    
    INSERT INTO [JOB_LOG]
		(
			[JOB_NUMBER],
			[OFFICE_CODE],
			[CL_CODE],
			[DIV_CODE],
			[PRD_CODE],
			[CMP_CODE],
			[SC_CODE],
			[USER_ID],
			[CREATE_DATE],
			[JOB_DESC],
			[JOB_DATE_OPENED],
			[JOB_RUSH_CHARGES],
			[JOB_ESTIMATE_REQ],
			[JOB_COMMENTS],			
			[JOB_CLI_REF],
			[BILL_COOP_CODE],
			[FORMAT_SC_CODE],
			[FORMAT_CODE],
			[COMPLEX_CODE],
			[PROMO_CODE],
			[CMP_IDENTIFIER],
			[CMP_LINE_NBR],
			[JOB_BILL_COMMENT],
			[FEE_JOB],
			[UDV1_CODE],
			[UDV2_CODE],
			[UDV3_CODE],
			[UDV4_CODE],
			[UDV5_CODE],
			[JOB_COMMENTS_HTML],
			[MODIFY_DATE],
			[MODIFIED_BY]
		)
		SELECT  @NEXT_JOB_NBR, @OfficeCode, @CLIENT, @DIVISION, @PRODUCT, @CAMPAIGN_CODE, @SALES_CLASS, @USER_ID, @CREATE_DATE, @JOB_DESC, CONVERT(VARCHAR(10), @CREATE_DATE, 101), JOB_RUSH_CHARGES, JOB_ESTIMATE_REQ,
                      JOB_COMMENTS, NULL, BILL_COOP_CODE, FORMAT_SC_CODE, FORMAT_CODE, COMPLEX_CODE, PROMO_CODE, @CAMPAIGN_ID, NULL, JOB_BILL_COMMENT, FEE_JOB, UDV1_CODE, UDV2_CODE,
					  UDV3_CODE, UDV4_CODE, UDV5_CODE, JOB_COMMENTS_HTML, @CREATE_DATE, @USER_ID
		FROM    JOB_LOG
		WHERE  (JOB_NUMBER = @JobNo)

		SELECT @Editable = ISNULL(EDITABLE,0) FROM UDV_LABEL WHERE UDV_TABLE_NAME = 'JOB_LOG_UDV1'
		SELECT @UDV_CODE = (SELECT UDV1_CODE FROM JOB_LOG WHERE (JOB_NUMBER = @JobNo))
		IF EXISTS(SELECT UDV1_CODE FROM JOB_LOG WHERE (JOB_NUMBER = @JobNo)) AND @UDV_CODE IS NOT NULL AND @Editable = 1
		BEGIN
			INSERT INTO JOB_LOG_UDV1
			SELECT RIGHT(REPLICATE('0', 6) + CONVERT(VARCHAR(20), @NEXT_JOB_NBR), 6), UDV_DESC, INACTIVE_FLAG
			FROM JOB_LOG_UDV1 
			WHERE (UDV_CODE = RIGHT(REPLICATE('0', 6) + CONVERT(VARCHAR(20), @JobNo), 6))

			UPDATE JOB_LOG
			SET UDV1_CODE = RIGHT(REPLICATE('0', 6) + CONVERT(VARCHAR(20), @NEXT_JOB_NBR), 6)
			WHERE (JOB_NUMBER = @NEXT_JOB_NBR)
		END

		SELECT @Editable = ISNULL(EDITABLE,0) FROM UDV_LABEL WHERE UDV_TABLE_NAME = 'JOB_LOG_UDV2'
		SELECT @UDV_CODE = (SELECT UDV2_CODE FROM JOB_LOG WHERE (JOB_NUMBER = @JobNo))
		IF EXISTS(SELECT UDV2_CODE FROM JOB_LOG WHERE (JOB_NUMBER = @JobNo)) AND @UDV_CODE IS NOT NULL AND @Editable = 1
		BEGIN

			INSERT INTO JOB_LOG_UDV2
			SELECT RIGHT(REPLICATE('0', 6) + CONVERT(VARCHAR(20), @NEXT_JOB_NBR), 6), UDV_DESC, INACTIVE_FLAG
			FROM JOB_LOG_UDV2 
			WHERE (UDV_CODE = RIGHT(REPLICATE('0', 6) + CONVERT(VARCHAR(20), @JobNo), 6))

			UPDATE JOB_LOG
			SET UDV2_CODE = RIGHT(REPLICATE('0', 6) + CONVERT(VARCHAR(20), @NEXT_JOB_NBR), 6)
			WHERE (JOB_NUMBER = @NEXT_JOB_NBR)
		END

		SELECT @Editable = ISNULL(EDITABLE,0) FROM UDV_LABEL WHERE UDV_TABLE_NAME = 'JOB_LOG_UDV3'
		SELECT @UDV_CODE = (SELECT UDV3_CODE FROM JOB_LOG WHERE (JOB_NUMBER = @JobNo))
		IF EXISTS(SELECT UDV3_CODE FROM JOB_LOG WHERE (JOB_NUMBER = @JobNo)) AND @UDV_CODE IS NOT NULL AND @Editable = 1
		BEGIN
			INSERT INTO JOB_LOG_UDV3
			SELECT RIGHT(REPLICATE('0', 6) + CONVERT(VARCHAR(20), @NEXT_JOB_NBR), 6), UDV_DESC, INACTIVE_FLAG
			FROM JOB_LOG_UDV3 
			WHERE (UDV_CODE = RIGHT(REPLICATE('0', 6) + CONVERT(VARCHAR(20), @JobNo), 6))

			UPDATE JOB_LOG
			SET UDV3_CODE = RIGHT(REPLICATE('0', 6) + CONVERT(VARCHAR(20), @NEXT_JOB_NBR), 6)
			WHERE (JOB_NUMBER = @NEXT_JOB_NBR)
		END

		SELECT @Editable = ISNULL(EDITABLE,0) FROM UDV_LABEL WHERE UDV_TABLE_NAME = 'JOB_LOG_UDV4'
		SELECT @UDV_CODE = (SELECT UDV4_CODE FROM JOB_LOG WHERE (JOB_NUMBER = @JobNo))
		IF EXISTS(SELECT UDV4_CODE FROM JOB_LOG WHERE (JOB_NUMBER = @JobNo)) AND @UDV_CODE IS NOT NULL AND @Editable = 1
		BEGIN
			INSERT INTO JOB_LOG_UDV4
			SELECT RIGHT(REPLICATE('0', 6) + CONVERT(VARCHAR(20), @NEXT_JOB_NBR), 6), UDV_DESC, INACTIVE_FLAG
			FROM JOB_LOG_UDV4 
			WHERE (UDV_CODE = RIGHT(REPLICATE('0', 6) + CONVERT(VARCHAR(20), @JobNo), 6))

			UPDATE JOB_LOG
			SET UDV4_CODE = RIGHT(REPLICATE('0', 6) + CONVERT(VARCHAR(20), @NEXT_JOB_NBR), 6)
			WHERE (JOB_NUMBER = @NEXT_JOB_NBR)
		END

		SELECT @Editable = ISNULL(EDITABLE,0) FROM UDV_LABEL WHERE UDV_TABLE_NAME = 'JOB_LOG_UDV5'
		SELECT @UDV_CODE = (SELECT UDV5_CODE FROM JOB_LOG WHERE (JOB_NUMBER = @JobNo))
		IF EXISTS(SELECT UDV5_CODE FROM JOB_LOG WHERE (JOB_NUMBER = @JobNo)) AND @UDV_CODE IS NOT NULL AND @Editable = 1
		BEGIN
			INSERT INTO JOB_LOG_UDV5
			SELECT RIGHT(REPLICATE('0', 6) + CONVERT(VARCHAR(20), @NEXT_JOB_NBR), 6), UDV_DESC, INACTIVE_FLAG
			FROM JOB_LOG_UDV5 
			WHERE (UDV_CODE = RIGHT(REPLICATE('0', 6) + CONVERT(VARCHAR(20), @JobNo), 6))

			UPDATE JOB_LOG
			SET UDV5_CODE = RIGHT(REPLICATE('0', 6) + CONVERT(VARCHAR(20), @NEXT_JOB_NBR), 6)
			WHERE (JOB_NUMBER = @NEXT_JOB_NBR)
		END

	
	SET @ERR = @@Error

	--RETURN @ERR
END


    
If @NEXT_JOB_NBR > 0
    BEGIN
        Update ASSIGN_NBR
        Set LAST_NBR = @NEXT_JOB_NBR
        WHERE     (COLUMNNAME = 'JOB_NUMBER')
    END


SELECT @JOB_NUM = @NEXT_JOB_NBR
GO