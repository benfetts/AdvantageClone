

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[usp_wv_Job_Template_Copy_Info]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[usp_wv_Job_Template_Copy_Info]
GO




CREATE PROCEDURE [dbo].[usp_wv_Job_Template_Copy_Info] 
@JobNo Integer,
@Closed Smallint,
@UserID varchar(100)
AS
DECLARE @Restricted INT

	SELECT @Restricted = Count(*) FROM SEC_CLIENT WHERE UPPER(USER_ID) = UPPER(@UserID)

if @Closed = 1
    Begin
        IF @Restricted > 0
            Begin
                SELECT     JOB_LOG.JOB_NUMBER, JOB_LOG.JOB_DESC, JOB_COMPONENT.JOB_COMPONENT_NBR, JOB_COMPONENT.JOB_COMP_DESC, 
                      JOB_LOG.SC_CODE, SALES_CLASS.SC_DESCRIPTION, JOB_LOG.CL_CODE, CLIENT.CL_NAME, JOB_LOG.DIV_CODE, 
                      DIVISION.DIV_NAME, JOB_LOG.PRD_CODE, PRODUCT.PRD_DESCRIPTION, JOB_COMPONENT.EMP_CODE, CMP_CODE, CMP_IDENTIFIER, JOB_COMPONENT.JT_CODE, JT_DESC, ISNULL(JOB_COMP_BUDGET_AM,0) AS JOB_COMP_BUDGET_AM, 0 AS SELECTED
                FROM         JOB_LOG INNER JOIN
                                      JOB_COMPONENT ON JOB_LOG.JOB_NUMBER = JOB_COMPONENT.JOB_NUMBER INNER JOIN
                                      SALES_CLASS ON JOB_LOG.SC_CODE = SALES_CLASS.SC_CODE INNER JOIN
                                      PRODUCT ON JOB_LOG.CL_CODE = PRODUCT.CL_CODE AND JOB_LOG.DIV_CODE = PRODUCT.DIV_CODE AND 
                                      JOB_LOG.PRD_CODE = PRODUCT.PRD_CODE INNER JOIN
                                      DIVISION ON PRODUCT.CL_CODE = DIVISION.CL_CODE AND PRODUCT.DIV_CODE = DIVISION.DIV_CODE INNER JOIN
                                      CLIENT ON DIVISION.CL_CODE = CLIENT.CL_CODE INNER JOIN
			                          SEC_CLIENT ON JOB_LOG.CL_CODE = SEC_CLIENT.CL_CODE AND JOB_LOG.DIV_CODE = SEC_CLIENT.DIV_CODE AND JOB_LOG.PRD_CODE = SEC_CLIENT.PRD_CODE LEFT OUTER JOIN
									  JOB_TYPE ON JOB_TYPE.JT_CODE = JOB_COMPONENT.JT_CODE
                WHERE JOB_LOG.JOB_NUMBER = @JobNo AND UPPER(SEC_CLIENT.USER_ID) = UPPER(@UserID) AND (SEC_CLIENT.TIME_ENTRY = 0 OR SEC_CLIENT.TIME_ENTRY IS NULL)              
            End
        Else 
            Begin
                SELECT     JOB_LOG.JOB_NUMBER, JOB_LOG.JOB_DESC, JOB_COMPONENT.JOB_COMPONENT_NBR, JOB_COMPONENT.JOB_COMP_DESC, 
                      JOB_LOG.SC_CODE, SALES_CLASS.SC_DESCRIPTION, JOB_LOG.CL_CODE, CLIENT.CL_NAME, JOB_LOG.DIV_CODE, 
                      DIVISION.DIV_NAME, JOB_LOG.PRD_CODE, PRODUCT.PRD_DESCRIPTION, JOB_COMPONENT.EMP_CODE, CMP_CODE, CMP_IDENTIFIER, JOB_COMPONENT.JT_CODE, JT_DESC, ISNULL(JOB_COMP_BUDGET_AM,0) AS JOB_COMP_BUDGET_AM, 0 AS SELECTED
                FROM         JOB_LOG INNER JOIN
                                      JOB_COMPONENT ON JOB_LOG.JOB_NUMBER = JOB_COMPONENT.JOB_NUMBER INNER JOIN
                                      SALES_CLASS ON JOB_LOG.SC_CODE = SALES_CLASS.SC_CODE INNER JOIN
                                      PRODUCT ON JOB_LOG.CL_CODE = PRODUCT.CL_CODE AND JOB_LOG.DIV_CODE = PRODUCT.DIV_CODE AND 
                                      JOB_LOG.PRD_CODE = PRODUCT.PRD_CODE INNER JOIN
                                      DIVISION ON PRODUCT.CL_CODE = DIVISION.CL_CODE AND PRODUCT.DIV_CODE = DIVISION.DIV_CODE INNER JOIN
                                      CLIENT ON DIVISION.CL_CODE = CLIENT.CL_CODE LEFT OUTER JOIN
									  JOB_TYPE ON JOB_TYPE.JT_CODE = JOB_COMPONENT.JT_CODE
                WHERE JOB_LOG.JOB_NUMBER = @JobNo 
            End        
    End
Else
    Begin
        IF @Restricted > 0
            Begin
                SELECT     JOB_LOG.JOB_NUMBER, JOB_LOG.JOB_DESC, JOB_COMPONENT.JOB_COMPONENT_NBR, JOB_COMPONENT.JOB_COMP_DESC, 
                      JOB_LOG.SC_CODE, SALES_CLASS.SC_DESCRIPTION, JOB_LOG.CL_CODE, CLIENT.CL_NAME, JOB_LOG.DIV_CODE, 
                      DIVISION.DIV_NAME, JOB_LOG.PRD_CODE, PRODUCT.PRD_DESCRIPTION, JOB_COMPONENT.EMP_CODE, CMP_CODE, CMP_IDENTIFIER, JOB_COMPONENT.JT_CODE, JT_DESC, ISNULL(JOB_COMP_BUDGET_AM,0) AS JOB_COMP_BUDGET_AM, 0 AS SELECTED
                FROM         JOB_LOG INNER JOIN
                                      JOB_COMPONENT ON JOB_LOG.JOB_NUMBER = JOB_COMPONENT.JOB_NUMBER INNER JOIN
                                      SALES_CLASS ON JOB_LOG.SC_CODE = SALES_CLASS.SC_CODE INNER JOIN
                                      PRODUCT ON JOB_LOG.CL_CODE = PRODUCT.CL_CODE AND JOB_LOG.DIV_CODE = PRODUCT.DIV_CODE AND 
                                      JOB_LOG.PRD_CODE = PRODUCT.PRD_CODE INNER JOIN
                                      DIVISION ON PRODUCT.CL_CODE = DIVISION.CL_CODE AND PRODUCT.DIV_CODE = DIVISION.DIV_CODE INNER JOIN
                                      CLIENT ON DIVISION.CL_CODE = CLIENT.CL_CODE INNER JOIN
			                          SEC_CLIENT ON JOB_LOG.CL_CODE = SEC_CLIENT.CL_CODE AND JOB_LOG.DIV_CODE = SEC_CLIENT.DIV_CODE AND JOB_LOG.PRD_CODE = SEC_CLIENT.PRD_CODE LEFT OUTER JOIN
									  JOB_TYPE ON JOB_TYPE.JT_CODE = JOB_COMPONENT.JT_CODE
                WHERE JOB_LOG.JOB_NUMBER = @JobNo AND (JOB_COMPONENT.JOB_PROCESS_CONTRL NOT IN (6,12)) AND UPPER(SEC_CLIENT.USER_ID) = UPPER(@UserID) AND (SEC_CLIENT.TIME_ENTRY = 0 OR SEC_CLIENT.TIME_ENTRY IS NULL)            
            End
        Else 
            Begin
                SELECT     JOB_LOG.JOB_NUMBER, JOB_LOG.JOB_DESC, JOB_COMPONENT.JOB_COMPONENT_NBR, JOB_COMPONENT.JOB_COMP_DESC, 
                      JOB_LOG.SC_CODE, SALES_CLASS.SC_DESCRIPTION, JOB_LOG.CL_CODE, CLIENT.CL_NAME, JOB_LOG.DIV_CODE, 
                      DIVISION.DIV_NAME, JOB_LOG.PRD_CODE, PRODUCT.PRD_DESCRIPTION, JOB_COMPONENT.EMP_CODE, CMP_CODE, CMP_IDENTIFIER, JOB_COMPONENT.JT_CODE, JT_DESC, ISNULL(JOB_COMP_BUDGET_AM,0) AS JOB_COMP_BUDGET_AM, 0 AS SELECTED
                FROM         JOB_LOG INNER JOIN
                                      JOB_COMPONENT ON JOB_LOG.JOB_NUMBER = JOB_COMPONENT.JOB_NUMBER INNER JOIN
                                      SALES_CLASS ON JOB_LOG.SC_CODE = SALES_CLASS.SC_CODE INNER JOIN
                                      PRODUCT ON JOB_LOG.CL_CODE = PRODUCT.CL_CODE AND JOB_LOG.DIV_CODE = PRODUCT.DIV_CODE AND 
                                      JOB_LOG.PRD_CODE = PRODUCT.PRD_CODE INNER JOIN
                                      DIVISION ON PRODUCT.CL_CODE = DIVISION.CL_CODE AND PRODUCT.DIV_CODE = DIVISION.DIV_CODE INNER JOIN
                                      CLIENT ON DIVISION.CL_CODE = CLIENT.CL_CODE LEFT OUTER JOIN
									  JOB_TYPE ON JOB_TYPE.JT_CODE = JOB_COMPONENT.JT_CODE
                WHERE JOB_LOG.JOB_NUMBER = @JobNo AND (JOB_COMPONENT.JOB_PROCESS_CONTRL NOT IN (6,12))
            End

    End























