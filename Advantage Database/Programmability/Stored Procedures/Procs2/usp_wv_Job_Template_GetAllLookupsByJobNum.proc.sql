SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS OFF 
GO
IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[usp_wv_Job_Template_GetAllLookupsByJobNum]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[usp_wv_Job_Template_GetAllLookupsByJobNum]
GO
CREATE PROCEDURE [dbo].[usp_wv_Job_Template_GetAllLookupsByJobNum] /*WITH ENCRYPTION*/
@JOB_NUMBER INT,
@JOB_COMPONENT_NBR INT
AS
/*=========== QUERY ===========*/
DECLARE 
	@CL_CODE VARCHAR(6),
	@DIV_CODE VARCHAR(6),
	@PRD_CODE VARCHAR(6),
	@SC_CODE VARCHAR(6),
	@Label varchar(50),
	@Label2 varchar(50),
	@Label3 varchar(50),
	@Label4 varchar(50),
	@Label5 varchar(50),
	@Label6 varchar(50),
	@Label7 varchar(50),
	@Label8 varchar(50),
	@Label9 varchar(50),
	@Label10 varchar(50)

/* Get variables needed for lookups */
	SELECT
		@CL_CODE = CL_CODE,
		@DIV_CODE = DIV_CODE,
		@PRD_CODE = PRD_CODE,
		@SC_CODE = ISNULL(SC_CODE,'')
	FROM
		JOB_LOG
	WHERE 
		JOB_NUMBER = @JOB_NUMBER

/* Get label of UDV */
SELECT @Label=USER_LABEL
FROM UDV_LABEL
WHERE UDV_TABLE_NAME = 'JOB_LOG_UDV1' AND EDITABLE = 0

SELECT @Label2=USER_LABEL
FROM UDV_LABEL
WHERE UDV_TABLE_NAME = 'JOB_LOG_UDV2' AND EDITABLE = 0

SELECT @Label3=USER_LABEL
FROM UDV_LABEL
WHERE UDV_TABLE_NAME = 'JOB_LOG_UDV3' AND EDITABLE = 0

SELECT @Label4=USER_LABEL
FROM UDV_LABEL
WHERE UDV_TABLE_NAME = 'JOB_LOG_UDV4' AND EDITABLE = 0

SELECT @Label5=USER_LABEL
FROM UDV_LABEL
WHERE UDV_TABLE_NAME = 'JOB_LOG_UDV5' AND EDITABLE = 0

SELECT @Label6=USER_LABEL
FROM UDV_LABEL
WHERE UDV_TABLE_NAME = 'JOB_CMP_UDV1' AND EDITABLE = 0

SELECT @Label7=USER_LABEL
FROM UDV_LABEL
WHERE UDV_TABLE_NAME = 'JOB_CMP_UDV2' AND EDITABLE = 0

SELECT @Label8=USER_LABEL
FROM UDV_LABEL
WHERE UDV_TABLE_NAME = 'JOB_CMP_UDV3' AND EDITABLE = 0

SELECT @Label9=USER_LABEL
FROM UDV_LABEL
WHERE UDV_TABLE_NAME = 'JOB_CMP_UDV4' AND EDITABLE = 0

SELECT @Label10=USER_LABEL
FROM UDV_LABEL
WHERE UDV_TABLE_NAME = 'JOB_CMP_UDV5' AND EDITABLE = 0


/* Unioned all lookups relating to job */

	SELECT 
		DISTINCT REPLACE(ACCT_NBR,'''', '') AS code,
		ISNULL(ACCT_NBR_DESC, '') AS [description],
		'JOB_COMPONENT.ACCT_NBR' AS ItemCode,
		'Account Number' AS SHORT_DESC
	FROM
		ACCT_NUMBER
	WHERE
		ACTIVE = 1 OR ACTIVE IS NULL
--UNION
--	SELECT
--		ISNULL(CMP_NAME, '') AS [description],
--		'JOB_LOG.CMP_CODE' AS ItemCode,
--		'Campaign' AS SHORT_DESC
--	FROM
--		CAMPAIGN
--	WHERE
--		(CAMPAIGN.PRD_CODE LIKE @CL_CODE + '%') AND (ACTIVE_FLAG IS NULL OR ACTIVE_FLAG = 1)
UNION
	SELECT 
		DISTINCT REPLACE(BILL_COOP_CODE,'''', '') AS code,
		ISNULL(BILL_COOP_DESC, '') AS [description],
		'JOB_LOG.BILL_COOP_CODE' AS ItemCode,
		'Coop Billing' AS SHORT_DESC
	FROM
		BILLING_COOP
	WHERE
		(INACTIVE_FLAG = 0 OR INACTIVE_FLAG IS NULL)
UNION
	SELECT 
		DISTINCT REPLACE(PROMO_CODE,'''', '') AS code,
		ISNULL(PROMO_DESC, '') AS [description],
		'JOB_LOG.PROMO_CODE' AS ItemCode,
		'Promotion' AS SHORT_DESC
	FROM
		PROMO_TYPE
	WHERE
		(ACTIVE = 1 OR ACTIVE IS NULL)
UNION
	SELECT 
		DISTINCT REPLACE(FORMAT_CODE,'''', '') AS code,
		ISNULL(FORMAT_DESC, '') AS [description],
		'JOB_COMPONENT.FORMAT_CODE' AS ItemCode,
		'Sales Class Format' AS SHORT_DESC
	FROM
		SC_FORMAT
	WHERE
		SC_CODE LIKE @SC_CODE +'%' 
		AND (ACTIVE = 1 OR ACTIVE IS NULL)
UNION
	SELECT
		DISTINCT REPLACE(ACCOUNT_EXECUTIVE.EMP_CODE,'''', '') AS code, 
		ISNULL(V_ACTIVE_EMPLOYEE.EMP_FML, '') AS description,
		'JOB_COMPONENT.EMP_CODE' AS ItemCode,
		'Account Executive' AS SHORT_DESC
	FROM
		ACCOUNT_EXECUTIVE 
	INNER JOIN
		V_ACTIVE_EMPLOYEE ON ACCOUNT_EXECUTIVE.EMP_CODE = V_ACTIVE_EMPLOYEE.EMP_CODE
	WHERE 
		(ACCOUNT_EXECUTIVE.CL_CODE = @CL_CODE) 
		AND (ACCOUNT_EXECUTIVE.DIV_CODE = @DIV_CODE) 
		AND (ACCOUNT_EXECUTIVE.PRD_CODE = @PRD_CODE)                      
		AND 
		(INACTIVE_FLAG <> 1 OR INACTIVE_FLAG IS NULL OR INACTIVE_FLAG = 0)
UNION
	SELECT 
		DISTINCT REPLACE(TAX_CODE,'''', '') AS code,
		ISNULL(TAX_DESCRIPTION, '') AS [description],
		'JOB_COMPONENT.TAX_CODE' AS ItemCode,
		'Tax Code' AS SHORT_DESC
	FROM
		SALES_TAX
	WHERE
		(INACTIVE_FLAG IS NULL OR INACTIVE_FLAG = 0)
UNION
	SELECT 
		DISTINCT REPLACE(MARKET_CODE,'''', '') AS code,
		ISNULL(MARKET_DESC, '') AS [description],
		'JOB_COMPONENT.MARKET_CODE' AS ItemCode,
		'Market Code' AS SHORT_DESC
	FROM
		MARKET
	WHERE
		(INACTIVE_FLAG IS NULL OR INACTIVE_FLAG = 0)
UNION
	SELECT 
		DISTINCT REPLACE(DP_TM_CODE,'''', '') AS code,
		ISNULL(DP_TM_DESC, '') AS [description],
		'JOB_COMPONENT.DP_TM_CODE' AS ItemCode,
		'Dept/Team' AS SHORT_DESC
	FROM
		DEPT_TEAM
	WHERE
		(INACTIVE_FLAG IS NULL OR INACTIVE_FLAG = 0)
UNION


	SELECT 
		DISTINCT REPLACE(JT_CODE,'''', '') AS code,
		ISNULL(JT_DESC, '') AS [description],
		'JOB_COMPONENT.JT_CODE' AS ItemCode,
		'Job Type' AS SHORT_DESC
	FROM
		JOB_TYPE
	WHERE
		(INACTIVE_FLAG IS NULL OR INACTIVE_FLAG = 0) --AND (SC_CODE IS NULL OR SC_CODE = @SC_CODE)	
		
		
		
UNION
	SELECT
		DISTINCT REPLACE(OFFICE_CODE,'''', '') AS code, 
		ISNULL(OFFICE_NAME,'') as [description],
		'JOB_LOG.OFFICE_CODE' AS LOOKUP_OBJECT,
		'Office' AS SHORT_DESC
	FROM OFFICE
	WHERE
		(INACTIVE_FLAG IS NULL OR INACTIVE_FLAG = 0)
UNION
	SELECT
		DISTINCT REPLACE(COMPLEX_CODE,'''', '') as code,
		ISNULL(COMPLEX_DESC,'') as [description],
		'JOB_LOG.COMPLEX_CODE' as LOOKUP_OBJECT,
		'Complexity' as SHORT_DESC
	FROM COMPLEXITY
	WHERE
		(ACTIVE = 1 OR ACTIVE IS NULL)
UNION
	SELECT
		DISTINCT REPLACE(AD_NBR,'''', '') as code,
		ISNULL(AD_NBR_DESC,'') as [description],
		'JOB_COMPONENT.AD_NBR' as LOOKUP_OBJECT,
		'Ad Number' as SHORT_DESC
	FROM AD_NUMBER
	WHERE
		(ACTIVE = 1 OR ACTIVE IS NULL)
UNION
	SELECT
		DISTINCT REPLACE(CONT_CODE,'''', '') as code,
		CONT_FML as [description],
		'JOB_COMPONENT.PRD_CONT_CODE' as LOOKUP_OBJECT,
		'Contact' as SHORT_DESC
	FROM CDP_CONTACT_HDR
	WHERE
		(CDP_CONTACT_HDR.CL_CODE = @CL_CODE) 
		
UNION
	SELECT
		DISTINCT REPLACE(UDV_CODE,'''', '') as code,
		ISNULL(UDV_DESC,'') as [description],
		'JOB_LOG.UDV1_CODE' as LOOKUP_OBJECT,
		ISNULL(@Label,'') as SHORT_DESC
	FROM JOB_LOG_UDV1
	WHERE
		(INACTIVE_FLAG IS NULL OR INACTIVE_FLAG = 0) AND @Label IS NOT NULL
UNION
	SELECT
		DISTINCT REPLACE(UDV_CODE,'''', '') as code,
		ISNULL(UDV_DESC,'') as [description],
		'JOB_LOG.UDV2_CODE' as LOOKUP_OBJECT,
		ISNULL(@Label2,'') as SHORT_DESC
	FROM JOB_LOG_UDV2
	WHERE
		(INACTIVE_FLAG IS NULL OR INACTIVE_FLAG = 0) AND @Label2 IS NOT NULL
UNION
	SELECT
		DISTINCT REPLACE(UDV_CODE,'''', '') as code,
		ISNULL(UDV_DESC,'') as [description],
		'JOB_LOG.UDV3_CODE' as LOOKUP_OBJECT,
		ISNULL(@Label3,'') as SHORT_DESC
	FROM JOB_LOG_UDV3
	WHERE
		(INACTIVE_FLAG IS NULL OR INACTIVE_FLAG = 0) AND @Label3 IS NOT NULL
UNION
	SELECT
		DISTINCT REPLACE(UDV_CODE,'''', '') as code,
		ISNULL(UDV_DESC,'') as [description],
		'JOB_LOG.UDV4_CODE' as LOOKUP_OBJECT,
		ISNULL(@Label4,'') as SHORT_DESC
	FROM JOB_LOG_UDV4
	WHERE
		(INACTIVE_FLAG IS NULL OR INACTIVE_FLAG = 0) AND @Label4 IS NOT NULL	
UNION
	SELECT
		DISTINCT REPLACE(UDV_CODE,'''', '') as code,
		ISNULL(UDV_DESC,'') as [description],
		'JOB_LOG.UDV5_CODE' as LOOKUP_OBJECT,
		ISNULL(@Label5,'') as SHORT_DESC
	FROM JOB_LOG_UDV5
	WHERE
		(INACTIVE_FLAG IS NULL OR INACTIVE_FLAG = 0) AND @Label5 IS NOT NULL
UNION
	SELECT
		DISTINCT REPLACE(UDV_CODE,'''', '') as code,
		ISNULL(UDV_DESC,'') as [description],
		'JOB_COMPONENT.UDV1_CODE' as LOOKUP_OBJECT,
		ISNULL(@Label6,'') as SHORT_DESC
	FROM JOB_CMP_UDV1
	WHERE
		(INACTIVE_FLAG IS NULL OR INACTIVE_FLAG = 0) AND @Label6 IS NOT NULL
UNION
	SELECT
		DISTINCT REPLACE(UDV_CODE,'''', '') as code,
		ISNULL(UDV_DESC,'') as [description],
		'JOB_COMPONENT.UDV2_CODE' as LOOKUP_OBJECT,
		ISNULL(@Label7,'') as SHORT_DESC
	FROM JOB_CMP_UDV2
	WHERE
		(INACTIVE_FLAG IS NULL OR INACTIVE_FLAG = 0) AND @Label7 IS NOT NULL
UNION
	SELECT
		DISTINCT REPLACE(UDV_CODE,'''', '') as code,
		ISNULL(UDV_DESC,'') as [description],
		'JOB_COMPONENT.UDV3_CODE' as LOOKUP_OBJECT,
		ISNULL(@Label8,'') as SHORT_DESC
	FROM JOB_CMP_UDV3
	WHERE
		(INACTIVE_FLAG IS NULL OR INACTIVE_FLAG = 0) AND @Label8 IS NOT NULL
UNION
	SELECT
		DISTINCT REPLACE(UDV_CODE,'''', '') as code,
		ISNULL(UDV_DESC,'') as [description],
		'JOB_COMPONENT.UDV4_CODE' as LOOKUP_OBJECT,
		ISNULL(@Label9,'') as SHORT_DESC
	FROM JOB_CMP_UDV4
	WHERE
		(INACTIVE_FLAG IS NULL OR INACTIVE_FLAG = 0) AND @Label9 IS NOT NULL	
UNION
	SELECT
		DISTINCT REPLACE(UDV_CODE,'''', '') as code,
		ISNULL(UDV_DESC,'') as [description],
		'JOB_COMPONENT.UDV5_CODE' as LOOKUP_OBJECT,
		ISNULL(@Label10,'') as SHORT_DESC
	FROM JOB_CMP_UDV5
	WHERE
		(INACTIVE_FLAG IS NULL OR INACTIVE_FLAG = 0) AND @Label10 IS NOT NULL
	
/*=========== QUERY ===========*/
GO
SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO