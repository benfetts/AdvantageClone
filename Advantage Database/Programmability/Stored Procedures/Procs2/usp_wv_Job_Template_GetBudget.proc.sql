

CREATE PROCEDURE [dbo].[usp_wv_Job_Template_GetBudget] 
	@JOB_NUMBER INT,
	@JOB_COMPONENT_NBR INT
AS
--Client Approval
SELECT COUNT(*) AS Client
FROM         dbo.ESTIMATE_APPROVAL
WHERE     (dbo.ESTIMATE_APPROVAL.JOB_NUMBER = @JOB_NUMBER) AND (dbo.ESTIMATE_APPROVAL.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR)

SELECT     ISNULL(SUM(dbo.ESTIMATE_REV_DET.LINE_TOTAL),0) + ISNULL(SUM(dbo.ESTIMATE_REV_DET.LINE_TOTAL_CONT),0) AS EstAmt
FROM         dbo.ESTIMATE_REV_DET INNER JOIN
                      dbo.ESTIMATE_APPROVAL ON dbo.ESTIMATE_REV_DET.ESTIMATE_NUMBER = dbo.ESTIMATE_APPROVAL.ESTIMATE_NUMBER AND 
                      dbo.ESTIMATE_REV_DET.EST_COMPONENT_NBR = dbo.ESTIMATE_APPROVAL.EST_COMPONENT_NBR AND 
                      dbo.ESTIMATE_REV_DET.EST_QUOTE_NBR = dbo.ESTIMATE_APPROVAL.EST_QUOTE_NBR AND 
                      dbo.ESTIMATE_REV_DET.EST_REV_NBR = dbo.ESTIMATE_APPROVAL.EST_REVISION_NBR
WHERE     (dbo.ESTIMATE_APPROVAL.JOB_NUMBER = @JOB_NUMBER) AND (dbo.ESTIMATE_APPROVAL.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR)

SELECT     ISNULL(SUM(dbo.ESTIMATE_REV_DET.LINE_TOTAL),0) + ISNULL(SUM(dbo.ESTIMATE_REV_DET.LINE_TOTAL_CONT),0) AS TimeIOAmount
FROM         dbo.ESTIMATE_REV_DET INNER JOIN
                      dbo.ESTIMATE_APPROVAL ON dbo.ESTIMATE_REV_DET.ESTIMATE_NUMBER = dbo.ESTIMATE_APPROVAL.ESTIMATE_NUMBER AND 
                      dbo.ESTIMATE_REV_DET.EST_COMPONENT_NBR = dbo.ESTIMATE_APPROVAL.EST_COMPONENT_NBR AND 
                      dbo.ESTIMATE_REV_DET.EST_QUOTE_NBR = dbo.ESTIMATE_APPROVAL.EST_QUOTE_NBR AND 
                      dbo.ESTIMATE_REV_DET.EST_REV_NBR = dbo.ESTIMATE_APPROVAL.EST_REVISION_NBR
WHERE     (dbo.ESTIMATE_APPROVAL.JOB_NUMBER = @JOB_NUMBER) AND (dbo.ESTIMATE_APPROVAL.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR) AND (EST_FNC_TYPE = 'E' OR EST_FNC_TYPE = 'I')

SELECT     ISNULL(SUM(dbo.ESTIMATE_REV_DET.LINE_TOTAL),0) + ISNULL(SUM(dbo.ESTIMATE_REV_DET.LINE_TOTAL_CONT),0) AS VendorAmt
FROM         dbo.ESTIMATE_REV_DET INNER JOIN
                      dbo.ESTIMATE_APPROVAL ON dbo.ESTIMATE_REV_DET.ESTIMATE_NUMBER = dbo.ESTIMATE_APPROVAL.ESTIMATE_NUMBER AND 
                      dbo.ESTIMATE_REV_DET.EST_COMPONENT_NBR = dbo.ESTIMATE_APPROVAL.EST_COMPONENT_NBR AND 
                      dbo.ESTIMATE_REV_DET.EST_QUOTE_NBR = dbo.ESTIMATE_APPROVAL.EST_QUOTE_NBR AND 
                      dbo.ESTIMATE_REV_DET.EST_REV_NBR = dbo.ESTIMATE_APPROVAL.EST_REVISION_NBR
WHERE     (dbo.ESTIMATE_APPROVAL.JOB_NUMBER = @JOB_NUMBER) AND (dbo.ESTIMATE_APPROVAL.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR) AND (EST_FNC_TYPE = 'V')
--Internal Approval	
SELECT COUNT(*) AS Internal
FROM         dbo.ESTIMATE_INT_APPR
WHERE     (dbo.ESTIMATE_INT_APPR.JOB_NUMBER = @JOB_NUMBER) AND (dbo.ESTIMATE_INT_APPR.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR)

SELECT     ISNULL(SUM(dbo.ESTIMATE_REV_DET.LINE_TOTAL),0) + ISNULL(SUM(dbo.ESTIMATE_REV_DET.LINE_TOTAL_CONT),0) AS EstAmtInternal
FROM         dbo.ESTIMATE_REV_DET INNER JOIN
                      dbo.ESTIMATE_INT_APPR ON dbo.ESTIMATE_REV_DET.ESTIMATE_NUMBER = dbo.ESTIMATE_INT_APPR.ESTIMATE_NUMBER AND 
                      dbo.ESTIMATE_REV_DET.EST_COMPONENT_NBR = dbo.ESTIMATE_INT_APPR.EST_COMPONENT_NBR AND 
                      dbo.ESTIMATE_REV_DET.EST_QUOTE_NBR = dbo.ESTIMATE_INT_APPR.EST_QUOTE_NBR AND 
                      dbo.ESTIMATE_REV_DET.EST_REV_NBR = dbo.ESTIMATE_INT_APPR.EST_REVISION_NBR
WHERE     (dbo.ESTIMATE_INT_APPR.JOB_NUMBER = @JOB_NUMBER) AND (dbo.ESTIMATE_INT_APPR.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR)

SELECT     ISNULL(SUM(dbo.ESTIMATE_REV_DET.LINE_TOTAL),0) + ISNULL(SUM(dbo.ESTIMATE_REV_DET.LINE_TOTAL_CONT),0) AS TimeIOAmountInternal
FROM         dbo.ESTIMATE_REV_DET INNER JOIN
                      dbo.ESTIMATE_INT_APPR ON dbo.ESTIMATE_REV_DET.ESTIMATE_NUMBER = dbo.ESTIMATE_INT_APPR.ESTIMATE_NUMBER AND 
                      dbo.ESTIMATE_REV_DET.EST_COMPONENT_NBR = dbo.ESTIMATE_INT_APPR.EST_COMPONENT_NBR AND 
                      dbo.ESTIMATE_REV_DET.EST_QUOTE_NBR = dbo.ESTIMATE_INT_APPR.EST_QUOTE_NBR AND 
                      dbo.ESTIMATE_REV_DET.EST_REV_NBR = dbo.ESTIMATE_INT_APPR.EST_REVISION_NBR
WHERE     (dbo.ESTIMATE_INT_APPR.JOB_NUMBER = @JOB_NUMBER) AND (dbo.ESTIMATE_INT_APPR.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR) AND (EST_FNC_TYPE = 'E' OR EST_FNC_TYPE = 'I')

SELECT     ISNULL(SUM(dbo.ESTIMATE_REV_DET.LINE_TOTAL),0) + ISNULL(SUM(dbo.ESTIMATE_REV_DET.LINE_TOTAL_CONT),0) AS VendorAmtInternal
FROM         dbo.ESTIMATE_REV_DET INNER JOIN
                      dbo.ESTIMATE_INT_APPR ON dbo.ESTIMATE_REV_DET.ESTIMATE_NUMBER = dbo.ESTIMATE_INT_APPR.ESTIMATE_NUMBER AND 
                      dbo.ESTIMATE_REV_DET.EST_COMPONENT_NBR = dbo.ESTIMATE_INT_APPR.EST_COMPONENT_NBR AND 
                      dbo.ESTIMATE_REV_DET.EST_QUOTE_NBR = dbo.ESTIMATE_INT_APPR.EST_QUOTE_NBR AND 
                      dbo.ESTIMATE_REV_DET.EST_REV_NBR = dbo.ESTIMATE_INT_APPR.EST_REVISION_NBR
WHERE     (dbo.ESTIMATE_INT_APPR.JOB_NUMBER = @JOB_NUMBER) AND (dbo.ESTIMATE_INT_APPR.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR) AND (EST_FNC_TYPE = 'V')
	

