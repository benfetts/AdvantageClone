if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_wv_RESOURCES_EMP_AVAILABILITY_TASK_ROLE]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_wv_RESOURCES_EMP_AVAILABILITY_TASK_ROLE]
GO

CREATE PROCEDURE [dbo].[usp_wv_RESOURCES_EMP_AVAILABILITY_TASK_ROLE] 
	@TRF_FNC_CODE AS VARCHAR(10),
	@START_TIME AS SMALLDATETIME,
	@END_TIME AS SMALLDATETIME,
	@UserCode AS Varchar(100)

AS


        DECLARE
	    @DISTINCT_ROLE_CODES AS VARCHAR(4000)
    	
	    SET @DISTINCT_ROLE_CODES = NULL;
	
        SELECT @DISTINCT_ROLE_CODES = COALESCE(@DISTINCT_ROLE_CODES + ''',', '') + A.TRF_ROLE_CODE
        FROM   (
					SELECT     
						DISTINCT  '''' + TRAFFIC_ROLE.ROLE_CODE AS TRF_ROLE_CODE
					FROM         
						TASK_TRAFFIC_ROLE WITH(NOLOCK) INNER JOIN
						TRAFFIC_ROLE WITH(NOLOCK) ON TASK_TRAFFIC_ROLE.ROLE_CODE = TRAFFIC_ROLE.ROLE_CODE
					WHERE     
						(TASK_TRAFFIC_ROLE.TRF_CODE IN (@TRF_FNC_CODE))
               ) AS A;
        SET @DISTINCT_ROLE_CODES = @DISTINCT_ROLE_CODES + ''''
	
	
        --SELECT     @DISTINCT_ROLE_CODES	

        --GET EMPLOYEES:
        --NEED TO BIND TO DATATABLE 1
        EXEC usp_wv_RESOURCES_EMP_AVAILABILITY '',@DISTINCT_ROLE_CODES,
             @START_TIME,
             @END_TIME,
             1,
             NULL,NULL,@UserCode,NULL,NULL,NULL,NULL,NULL,NULL,NULL,'N',NULL,NULL,NULL,NULL,NULL,0;



