
CREATE PROCEDURE [dbo].[usp_wv_Restricted_GetDivisions]
@UserID VARCHAR(100), @CL_CODE VARCHAR(6)
AS
DECLARE @Restricted INT

SELECT @Restricted = Count(*) FROM SEC_CLIENT WHERE UPPER(USER_ID) = UPPER(@UserID)
IF @Restricted > 0
    BEGIN
		SELECT     
			DISTINCT DIVISION.DIV_CODE+' - '+ISNULL(DIVISION.DIV_NAME,'') AS Text,
			CLIENT.CL_CODE+','+DIVISION.DIV_CODE AS Value,
			'DI' AS Level,
			'Division:  '+DIVISION.DIV_CODE+' - '+ISNULL(DIVISION.DIV_NAME,'') AS Crumb,
			DIVISION.DIV_CODE AS FK,
			DIVISION.DIV_CODE+' - '+ISNULL(DIVISION.DIV_NAME,'') AS ToolTip,
			'Images/division.png' AS ImageURL,
			'Images/division.png' AS ImageExpandedUrl
		FROM         
			OFFICE INNER JOIN
			PRODUCT ON OFFICE.OFFICE_CODE = PRODUCT.OFFICE_CODE INNER JOIN
			DIVISION ON PRODUCT.CL_CODE = DIVISION.CL_CODE AND PRODUCT.DIV_CODE = DIVISION.DIV_CODE INNER JOIN
			CLIENT ON DIVISION.CL_CODE = CLIENT.CL_CODE INNER JOIN
			SEC_CLIENT ON PRODUCT.CL_CODE = SEC_CLIENT.CL_CODE AND PRODUCT.DIV_CODE = SEC_CLIENT.DIV_CODE AND 
			PRODUCT.PRD_CODE = SEC_CLIENT.PRD_CODE
		WHERE     
			(UPPER(SEC_CLIENT.USER_ID) = UPPER(@UserID)) AND (SEC_CLIENT.TIME_ENTRY = 0 OR SEC_CLIENT.TIME_ENTRY IS NULL)
			AND (SEC_CLIENT.CL_CODE = @CL_CODE)
    END
ELSE
    BEGIN
		SELECT     
			DISTINCT DIVISION.DIV_CODE+' - '+ISNULL(DIVISION.DIV_NAME,'') AS Text,
			CLIENT.CL_CODE+','+DIVISION.DIV_CODE AS Value,
			'DI' AS Level,
			'Division:  '+DIVISION.DIV_CODE+' - '+ISNULL(DIVISION.DIV_NAME,'') AS Crumb,
			DIVISION.DIV_CODE AS FK,
			DIVISION.DIV_CODE+' - '+ISNULL(DIVISION.DIV_NAME,'') AS ToolTip,
			'Images/division.png' AS ImageURL,
			'Images/division.png' AS ImageExpandedUrl
		FROM         
			OFFICE INNER JOIN
			PRODUCT ON OFFICE.OFFICE_CODE = PRODUCT.OFFICE_CODE INNER JOIN
			DIVISION ON PRODUCT.CL_CODE = DIVISION.CL_CODE AND PRODUCT.DIV_CODE = DIVISION.DIV_CODE INNER JOIN
			CLIENT ON DIVISION.CL_CODE = CLIENT.CL_CODE
		WHERE
			CLIENT.CL_CODE = @CL_CODE
		END

