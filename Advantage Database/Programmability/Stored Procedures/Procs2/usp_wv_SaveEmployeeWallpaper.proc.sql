SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS OFF 
GO
IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[usp_wv_SaveEmployeeWallpaper]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[usp_wv_SaveEmployeeWallpaper]
GO
CREATE PROCEDURE [dbo].[usp_wv_SaveEmployeeWallpaper] /*WITH ENCRYPTION*/
@EMP_CODE VARCHAR(6),
@USER_CODE VARCHAR(100),
@IMAGE IMAGE,
@FILENAME VARCHAR(MAX)
AS
/*=========== QUERY ===========*/
	IF EXISTS(SELECT EMP_PICTURE_ID FROM EMPLOYEE_PICTURE WITH(NOLOCK) WHERE EMPLOYEE_PICTURE.EMP_CODE = @EMP_CODE)
	BEGIN

		UPDATE EMPLOYEE_PICTURE WITH(ROWLOCK) SET EMP_WALLPAPER = @IMAGE WHERE EMPLOYEE_PICTURE.EMP_CODE = @EMP_CODE;

	END
	ELSE
	BEGIN

		INSERT INTO EMPLOYEE_PICTURE WITH(ROWLOCK) (EMP_CODE, EMP_WALLPAPER) VALUES (@EMP_CODE, @IMAGE); 
		
	END

	UPDATE APP_VARS WITH(ROWLOCK) SET VARIABLE_VALUE = @FILENAME WHERE VARIABLE_NAME = 'MY_WALLPAPER' AND [APPLICATION] = 'MY_SETTINGS' AND UPPER(USERID) = UPPER(@USER_CODE);
	UPDATE APP_VARS WITH(ROWLOCK) SET VARIABLE_VALUE = @FILENAME WHERE VARIABLE_NAME = 'WALLPAPER' AND [APPLICATION] = 'MY_SETTINGS' AND UPPER(USERID) = UPPER(@USER_CODE);
	UPDATE APP_VARS WITH(ROWLOCK) SET VARIABLE_VALUE = '3' WHERE VARIABLE_NAME = 'BG_TYPE' AND [APPLICATION] = 'MY_SETTINGS' AND UPPER(USERID) = UPPER(@USER_CODE);

/*=========== QUERY ===========*/
GO
SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO