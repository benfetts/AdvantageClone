SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS OFF 
GO
IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[usp_wv_Traffic_Schedule_AddQuickHeader]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[usp_wv_Traffic_Schedule_AddQuickHeader]
GO
CREATE PROCEDURE [dbo].[usp_wv_Traffic_Schedule_AddQuickHeader] /*WITH ENCRYPTION*/

@JOB_NUM INT,
@JOB_COMPONENT_NBR SMALLINT,
@TRF_CODE VARCHAR(10),
@TRAFFIC_MGR_CODE VARCHAR(6),
@USER_CODE VARCHAR(100)

AS
/*=========== QUERY ===========*/
	IF @TRAFFIC_MGR_CODE = ''
	BEGIN
		SET @TRAFFIC_MGR_CODE = NULL;
	END
	
	DECLARE
	@HAS_HEADER INT,
	@SCHEDULE_CALC INT

	--MAKE SURE IT DOESN'T ALREADY HAVE A HEADER RECORD
	SELECT @HAS_HEADER = ISNULL(COUNT(1),0) FROM JOB_TRAFFIC WHERE (JOB_NUMBER = @JOB_NUM) AND (JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR);

	IF @HAS_HEADER = 0 AND @JOB_NUM > 0 AND @JOB_COMPONENT_NBR > 0
	BEGIN
		
		IF EXISTS(SELECT * FROM dbo.APP_VARS WHERE [APPLICATION] = 'PROJECT_SCHEDULE' AND VARIABLE_NAME = 'SCHEDULE_CALC' AND UPPER(@USER_CODE) = UPPER(@USER_CODE))
		BEGIN
			SELECT
				@SCHEDULE_CALC = CONVERT(INT, VARIABLE_VALUE)
			FROM
				dbo.APP_VARS
			WHERE
				[APPLICATION] = 'PROJECT_SCHEDULE' AND
				VARIABLE_NAME = 'SCHEDULE_CALC' AND
				UPPER(USERID) = UPPER(@USER_CODE)
		END
		ELSE
		BEGIN
			SET @SCHEDULE_CALC = 1 -- default to predecessor
		END

		INSERT INTO JOB_TRAFFIC(JOB_NUMBER,JOB_COMPONENT_NBR,TRF_CODE, SCHEDULE_CALC)
		VALUES(@JOB_NUM,@JOB_COMPONENT_NBR,@TRF_CODE, @SCHEDULE_CALC);
		
		EXEC usp_wv_Traffic_Schedule_UpdateManager @JOB_NUM, @JOB_COMPONENT_NBR, @TRAFFIC_MGR_CODE;
		
		SET @HAS_HEADER = 1;

	END
/*=========== QUERY ===========*/
GO
SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO