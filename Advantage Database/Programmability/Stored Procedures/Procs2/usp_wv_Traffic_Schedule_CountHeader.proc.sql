

CREATE PROCEDURE [dbo].[usp_wv_Traffic_Schedule_CountHeader]
@JobNum AS INT,
@JobCompNum AS INT
AS

	


SELECT 
	COUNT(1)
FROM    
	JOB_COMPONENT WITH(NOLOCK)
	INNER JOIN JOB_TRAFFIC 
	ON JOB_COMPONENT.JOB_NUMBER = JOB_TRAFFIC.JOB_NUMBER 
	AND JOB_COMPONENT.JOB_COMPONENT_NBR = JOB_TRAFFIC.JOB_COMPONENT_NBR 
	LEFT OUTER JOIN JOB_TRAFFIC_DET 
	ON JOB_TRAFFIC_DET.JOB_NUMBER = JOB_TRAFFIC.JOB_NUMBER 
	AND JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = JOB_TRAFFIC.JOB_COMPONENT_NBR 
	INNER JOIN JOB_LOG 
	ON  JOB_TRAFFIC.JOB_NUMBER = JOB_LOG.JOB_NUMBER
	INNER JOIN CLIENT 
	ON CLIENT.CL_CODE = JOB_LOG.CL_CODE 
	INNER JOIN PRODUCT 
	ON JOB_LOG.CL_CODE = PRODUCT.CL_CODE 
	AND JOB_LOG.DIV_CODE = PRODUCT.DIV_CODE 
	AND JOB_LOG.PRD_CODE = PRODUCT.PRD_CODE 
	INNER JOIN DIVISION 
	ON JOB_LOG.DIV_CODE = DIVISION.DIV_CODE 
	AND JOB_LOG.CL_CODE = DIVISION.CL_CODE
	LEFT OUTER JOIN TASK_TRAFFIC_ROLE
	ON JOB_TRAFFIC_DET.FNC_CODE = TASK_TRAFFIC_ROLE.TRF_CODE 
	LEFT OUTER JOIN EMP_TRAFFIC_ROLE
	ON JOB_TRAFFIC_DET.EMP_CODE = EMP_TRAFFIC_ROLE.EMP_CODE
WHERE  
	(NOT (JOB_COMPONENT.JOB_PROCESS_CONTRL IN (6, 12)))
	AND JOB_TRAFFIC.COMPLETED_DATE IS NULL
	AND JOB_LOG.JOB_NUMBER = @JobNum
	AND JOB_TRAFFIC.JOB_COMPONENT_NBR = @JobCompNum



