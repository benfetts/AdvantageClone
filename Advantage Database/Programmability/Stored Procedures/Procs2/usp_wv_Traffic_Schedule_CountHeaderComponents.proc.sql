
CREATE PROCEDURE [dbo].[usp_wv_Traffic_Schedule_CountHeaderComponents] 
	@JOB_NUMBER INT,
    @COUNT_FROM_JC_TABLE SMALLINT,
    @LOAD_CLOSED_COMPONENTS SMALLINT = 0
AS

	DECLARE @THE_COUNT SMALLINT
	
	IF @COUNT_FROM_JC_TABLE = 0  BEGIN

		IF @LOAD_CLOSED_COMPONENTS = 1 BEGIN
		
			SELECT 
				@THE_COUNT = ISNULL( COUNT(1),0) 
			FROM 
				JOB_TRAFFIC WITH(NOLOCK) INNER JOIN 
				JOB_COMPONENT ON JOB_COMPONENT.JOB_NUMBER = JOB_TRAFFIC.JOB_NUMBER AND 
								 JOB_COMPONENT.JOB_COMPONENT_NBR = JOB_TRAFFIC.JOB_COMPONENT_NBR
			WHERE  
				JOB_TRAFFIC.JOB_NUMBER = @JOB_NUMBER
				
		END ELSE BEGIN
		
			SELECT 
				@THE_COUNT = ISNULL( COUNT(1),0) 
			FROM 
				JOB_TRAFFIC WITH(NOLOCK) INNER JOIN 
				JOB_COMPONENT ON JOB_COMPONENT.JOB_NUMBER = JOB_TRAFFIC.JOB_NUMBER AND 
								 JOB_COMPONENT.JOB_COMPONENT_NBR = JOB_TRAFFIC.JOB_COMPONENT_NBR
			WHERE  
				JOB_TRAFFIC.JOB_NUMBER = @JOB_NUMBER AND 
				(NOT(JOB_COMPONENT.JOB_PROCESS_CONTRL IN (6, 12)))
				
		END
	    
		IF @THE_COUNT = 1 BEGIN
	    
			IF @LOAD_CLOSED_COMPONENTS = 1 BEGIN
				
				SELECT 
					JOB_TRAFFIC.JOB_COMPONENT_NBR 
				FROM 
					JOB_TRAFFIC WITH(NOLOCK) INNER JOIN 
					JOB_COMPONENT ON JOB_COMPONENT.JOB_NUMBER = JOB_TRAFFIC.JOB_NUMBER AND 
									 JOB_COMPONENT.JOB_COMPONENT_NBR = JOB_TRAFFIC.JOB_COMPONENT_NBR
				WHERE 
					JOB_TRAFFIC.JOB_NUMBER = @JOB_NUMBER 	
				
			END ELSE BEGIN
		
				SELECT 
					JOB_TRAFFIC.JOB_COMPONENT_NBR 
				FROM 
					JOB_TRAFFIC WITH(NOLOCK) INNER JOIN 
					JOB_COMPONENT ON JOB_COMPONENT.JOB_NUMBER = JOB_TRAFFIC.JOB_NUMBER AND 
									 JOB_COMPONENT.JOB_COMPONENT_NBR = JOB_TRAFFIC.JOB_COMPONENT_NBR
				WHERE 
					JOB_TRAFFIC.JOB_NUMBER = @JOB_NUMBER AND 
					(NOT (JOB_COMPONENT.JOB_PROCESS_CONTRL IN (6, 12))) 	
				
			END
	
		END
	    
		IF @THE_COUNT = 0 BEGIN
	    
			SELECT 0 AS JOB_COMPONENT_NBR
	            
		END
	    
		IF @THE_COUNT > 1 BEGIN
	    
			SELECT -1 AS JOB_COMPONENT_NBR
	            
		END

	END ELSE  BEGIN

		IF @LOAD_CLOSED_COMPONENTS = 1 BEGIN
		
			SELECT 
				@THE_COUNT = ISNULL( COUNT(1),0) 
			FROM 
				JOB_COMPONENT WITH(NOLOCK) 
			WHERE  
				JOB_COMPONENT.JOB_NUMBER = @JOB_NUMBER
		
		END ELSE BEGIN
		
			SELECT 
				@THE_COUNT = ISNULL( COUNT(1),0) 
			FROM 
				JOB_COMPONENT WITH(NOLOCK) 
			WHERE  
				JOB_COMPONENT.JOB_NUMBER = @JOB_NUMBER  AND  
				(NOT (JOB_COMPONENT.JOB_PROCESS_CONTRL IN (6, 12)))
			
		END
		
			
		IF @THE_COUNT = 1 BEGIN
		
			IF @LOAD_CLOSED_COMPONENTS = 1 BEGIN
				
				SELECT 
					JOB_COMPONENT_NBR 
				FROM 
					JOB_COMPONENT WITH(NOLOCK)
				WHERE 
					JOB_NUMBER = @JOB_NUMBER 	
				
			END ELSE BEGIN
		
				SELECT 
					JOB_COMPONENT_NBR 
				FROM 
					JOB_COMPONENT WITH(NOLOCK)
				WHERE 
					JOB_NUMBER = @JOB_NUMBER AND 
					(NOT (JOB_PROCESS_CONTRL IN (6, 12)))	
				
			END
			
		END
		
		IF @THE_COUNT = 0 BEGIN
		
			SELECT 0 AS JOB_COMPONENT_NBR
			
		END
		
		IF @THE_COUNT > 1 BEGIN
		
			SELECT -1 AS JOB_COMPONENT_NBR
		
		END
		
    END    

