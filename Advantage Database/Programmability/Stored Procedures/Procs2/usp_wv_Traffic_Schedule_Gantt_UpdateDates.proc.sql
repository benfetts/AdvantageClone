
CREATE PROCEDURE [dbo].[usp_wv_Traffic_Schedule_Gantt_UpdateDates]
@JOB_NUMBER INT,
@JOB_COMPONENT_NBR SMALLINT,
@SEQ_NBR SMALLINT,
@NEW_START_DATE SMALLDATETIME,
@NEW_DUE_DATE SMALLDATETIME,
@RETURN_ID SMALLINT OUTPUT,
@SET_DAYS SMALLINT = 0

AS
DECLARE
	@CURR_START_DATE SMALLDATETIME,
	@CURR_DUE_DATE SMALLDATETIME,
	@CURR_JOB_REVISED_DATE SMALLDATETIME,
	@CURR_DUE_DATE_LOCK SMALLINT

--SET DEFAULT:
SELECT @RETURN_ID = 0

--GET CURRENT DATA:
SELECT
	@CURR_START_DATE = TASK_START_DATE,
	@CURR_DUE_DATE = JOB_DUE_DATE,
	@CURR_JOB_REVISED_DATE = JOB_REVISED_DATE,
	@CURR_DUE_DATE_LOCK = DUE_DATE_LOCK
FROM 
	JOB_TRAFFIC_DET WITH(NOLOCK)
WHERE 
	JOB_NUMBER = @JOB_NUMBER 
	AND JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR
	AND SEQ_NBR = @SEQ_NBR

----Is there a change?
--IF (@CURR_START_DATE = @NEW_START_DATE) AND (@CURR_DUE_DATE = @NEW_DUE_DATE)
--BEGIN
--	SET @RETURN_ID = -1
--	SET @RETURN_MESSAGE = 'No change in dates detected.'
--END

--Is the row locked?
IF @CURR_DUE_DATE_LOCK = 1
BEGIN
	SELECT @RETURN_ID = -2
	SET @NEW_DUE_DATE = COALESCE(@CURR_JOB_REVISED_DATE,@CURR_DUE_DATE)
END

IF (@CURR_DUE_DATE IS NULL)
	BEGIN
		UPDATE 
			JOB_TRAFFIC_DET WITH(ROWLOCK)
		SET 
			TASK_START_DATE = @NEW_START_DATE,
			JOB_DUE_DATE = @NEW_DUE_DATE,
			JOB_REVISED_DATE = @NEW_DUE_DATE
		WHERE
			JOB_NUMBER = @JOB_NUMBER 
			AND JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR
			AND SEQ_NBR = @SEQ_NBR;				
	END
ELSE
	BEGIN
		UPDATE 
			JOB_TRAFFIC_DET WITH(ROWLOCK)
		SET 
			TASK_START_DATE = @NEW_START_DATE,
			JOB_REVISED_DATE = @NEW_DUE_DATE
		WHERE
			JOB_NUMBER = @JOB_NUMBER 
			AND JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR
			AND SEQ_NBR = @SEQ_NBR		
	END
	
IF (NOT @NEW_START_DATE IS NULL) AND (NOT @NEW_DUE_DATE IS NULL) AND @SET_DAYS = 1 
BEGIN
		UPDATE 
			JOB_TRAFFIC_DET WITH(ROWLOCK)
		SET 
			JOB_DAYS = DATEDIFF(day,@NEW_START_DATE, @NEW_DUE_DATE)
		WHERE
			JOB_NUMBER = @JOB_NUMBER 
			AND JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR
			AND SEQ_NBR = @SEQ_NBR		
END

	
--IF 	@RETURN_ID = -2
--	BEGIN
--		SET @RETURN_MESSAGE = 'Task Due Date is locked and was not changed.'
--	END
--ELSE
--	BEGIN
--		SET @RETURN_MESSAGE = 'Task updated: '
--	END


