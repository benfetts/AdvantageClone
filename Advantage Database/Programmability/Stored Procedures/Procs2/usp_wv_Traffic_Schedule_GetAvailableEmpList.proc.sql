

CREATE PROCEDURE [dbo].[usp_wv_Traffic_Schedule_GetAvailableEmpList]
@JOB_NUMBER INT,
@JOB_COMPONENT_NBR INT,
@SEQ SMALLINT,
@TRF_CODE VARCHAR(10),
@UserCode VARCHAR(100)
AS

DECLARE @OfficeRestrictions AS INTEGER	
DECLARE @EMP_CODE AS varchar(6),@EmpRestrictions SMALLINT

SELECT @EmpRestrictions = ISNULL(COUNT(1),0) FROM SEC_EMP WHERE UPPER(USER_ID) = UPPER(@UserCode)

SELECT @EMP_CODE = EMP_CODE FROM [dbo].[SEC_USER] WHERE UPPER([USER_CODE]) = UPPER(@UserCode)
SELECT @OfficeRestrictions = COUNT(*) FROM EMP_OFFICE WHERE EMP_CODE = @EMP_CODE

IF (@TRF_CODE IS NULL) OR DATALENGTH(RTRIM(LTRIM(@TRF_CODE))) = 0
BEGIN
    SET @TRF_CODE = ''
END

IF @JOB_NUMBER > 0 AND @JOB_COMPONENT_NBR > 0 AND @SEQ > -1  --If has job/comp/seq, then restrict to only show emps not already assigned to task
	BEGIN
		IF @TRF_CODE <> '' --Restrict if has task code checkbox checked (and task code)
			BEGIN
				if @OfficeRestrictions > 0
				Begin
					if @EmpRestrictions > 0
					Begin
						SELECT DISTINCT 
							EMP_TRAFFIC_ROLE.EMP_CODE AS EMPCODE, 
							EMPLOYEE.EMP_FNAME + ISNULL(' ' + EMPLOYEE.EMP_MI + '.', '') + ISNULL(' ' + EMPLOYEE.EMP_LNAME, '') AS EMP_NAME
						FROM         
							TASK_TRAFFIC_ROLE WITH(NOLOCK) INNER JOIN
							TRAFFIC_ROLE WITH(NOLOCK) ON TASK_TRAFFIC_ROLE.ROLE_CODE = TRAFFIC_ROLE.ROLE_CODE INNER JOIN
							EMP_TRAFFIC_ROLE WITH(NOLOCK) ON TRAFFIC_ROLE.ROLE_CODE = EMP_TRAFFIC_ROLE.ROLE_CODE INNER JOIN
							EMPLOYEE WITH(NOLOCK) ON EMP_TRAFFIC_ROLE.EMP_CODE = EMPLOYEE.EMP_CODE INNER JOIN
							EMP_OFFICE ON EMPLOYEE.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = @EMP_CODE INNER JOIN
							[dbo].[advtf_sec_emp] (@UserCode) AS   SEC_EMP ON EMPLOYEE.EMP_CODE = SEC_EMP.EMP_CODE
						WHERE     
							(TASK_TRAFFIC_ROLE.TRF_CODE = @TRF_CODE) 
							AND (EMPLOYEE.EMP_TERM_DATE IS NULL)
							AND EMPLOYEE.EMP_CODE NOT IN (
											SELECT     
												JOB_TRAFFIC_DET_EMPS.EMP_CODE
											FROM         
												JOB_TRAFFIC_DET_EMPS 
											WHERE     
												 ((JOB_TRAFFIC_DET_EMPS.JOB_NUMBER = @JOB_NUMBER) 
												AND (JOB_TRAFFIC_DET_EMPS.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR) 
												AND (JOB_TRAFFIC_DET_EMPS.SEQ_NBR = @SEQ))                    
											)
						ORDER BY
							EMPLOYEE.EMP_FNAME + ISNULL(' ' + EMPLOYEE.EMP_MI + '.', '') + ISNULL(' ' + EMPLOYEE.EMP_LNAME, '')
					End
					Else
					Begin
						SELECT DISTINCT 
							EMP_TRAFFIC_ROLE.EMP_CODE AS EMPCODE, 
							EMPLOYEE.EMP_FNAME + ISNULL(' ' + EMPLOYEE.EMP_MI + '.', '') + ISNULL(' ' + EMPLOYEE.EMP_LNAME, '') AS EMP_NAME
						FROM         
							TASK_TRAFFIC_ROLE WITH(NOLOCK) INNER JOIN
							TRAFFIC_ROLE WITH(NOLOCK) ON TASK_TRAFFIC_ROLE.ROLE_CODE = TRAFFIC_ROLE.ROLE_CODE INNER JOIN
							EMP_TRAFFIC_ROLE WITH(NOLOCK) ON TRAFFIC_ROLE.ROLE_CODE = EMP_TRAFFIC_ROLE.ROLE_CODE INNER JOIN
							EMPLOYEE WITH(NOLOCK) ON EMP_TRAFFIC_ROLE.EMP_CODE = EMPLOYEE.EMP_CODE INNER JOIN
							EMP_OFFICE ON EMPLOYEE.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = @EMP_CODE
						WHERE     
							(TASK_TRAFFIC_ROLE.TRF_CODE = @TRF_CODE) 
							AND (EMPLOYEE.EMP_TERM_DATE IS NULL)
							AND EMPLOYEE.EMP_CODE NOT IN (
											SELECT     
												JOB_TRAFFIC_DET_EMPS.EMP_CODE
											FROM         
												JOB_TRAFFIC_DET_EMPS 
											WHERE     
												 ((JOB_TRAFFIC_DET_EMPS.JOB_NUMBER = @JOB_NUMBER) 
												AND (JOB_TRAFFIC_DET_EMPS.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR) 
												AND (JOB_TRAFFIC_DET_EMPS.SEQ_NBR = @SEQ))                    
											)
						ORDER BY
							EMPLOYEE.EMP_FNAME + ISNULL(' ' + EMPLOYEE.EMP_MI + '.', '') + ISNULL(' ' + EMPLOYEE.EMP_LNAME, '')
					End
					
				End
				Else
				Begin
					if @EmpRestrictions > 0
					Begin
						SELECT DISTINCT 
							EMP_TRAFFIC_ROLE.EMP_CODE AS EMPCODE, 
							EMPLOYEE.EMP_FNAME + ISNULL(' ' + EMPLOYEE.EMP_MI + '.', '') + ISNULL(' ' + EMPLOYEE.EMP_LNAME, '') AS EMP_NAME
						FROM         
							TASK_TRAFFIC_ROLE WITH(NOLOCK) INNER JOIN
							TRAFFIC_ROLE WITH(NOLOCK) ON TASK_TRAFFIC_ROLE.ROLE_CODE = TRAFFIC_ROLE.ROLE_CODE INNER JOIN
							EMP_TRAFFIC_ROLE WITH(NOLOCK) ON TRAFFIC_ROLE.ROLE_CODE = EMP_TRAFFIC_ROLE.ROLE_CODE INNER JOIN
							EMPLOYEE WITH(NOLOCK) ON EMP_TRAFFIC_ROLE.EMP_CODE = EMPLOYEE.EMP_CODE INNER JOIN
							[dbo].[advtf_sec_emp] (@UserCode) AS SEC_EMP ON EMPLOYEE.EMP_CODE = SEC_EMP.EMP_CODE
						WHERE     
							(TASK_TRAFFIC_ROLE.TRF_CODE = @TRF_CODE) 
							AND (EMPLOYEE.EMP_TERM_DATE IS NULL)
							AND EMPLOYEE.EMP_CODE NOT IN (
											SELECT     
												JOB_TRAFFIC_DET_EMPS.EMP_CODE
											FROM         
												JOB_TRAFFIC_DET_EMPS 
											WHERE     
												 ((JOB_TRAFFIC_DET_EMPS.JOB_NUMBER = @JOB_NUMBER) 
												AND (JOB_TRAFFIC_DET_EMPS.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR) 
												AND (JOB_TRAFFIC_DET_EMPS.SEQ_NBR = @SEQ))                    
											)
						ORDER BY
							EMPLOYEE.EMP_FNAME + ISNULL(' ' + EMPLOYEE.EMP_MI + '.', '') + ISNULL(' ' + EMPLOYEE.EMP_LNAME, '')
					End
					Else
					Begin
						SELECT DISTINCT 
							EMP_TRAFFIC_ROLE.EMP_CODE AS EMPCODE, 
							EMPLOYEE.EMP_FNAME + ISNULL(' ' + EMPLOYEE.EMP_MI + '.', '') + ISNULL(' ' + EMPLOYEE.EMP_LNAME, '') AS EMP_NAME
						FROM         
							TASK_TRAFFIC_ROLE WITH(NOLOCK) INNER JOIN
							TRAFFIC_ROLE WITH(NOLOCK) ON TASK_TRAFFIC_ROLE.ROLE_CODE = TRAFFIC_ROLE.ROLE_CODE INNER JOIN
							EMP_TRAFFIC_ROLE WITH(NOLOCK) ON TRAFFIC_ROLE.ROLE_CODE = EMP_TRAFFIC_ROLE.ROLE_CODE INNER JOIN
							EMPLOYEE WITH(NOLOCK) ON EMP_TRAFFIC_ROLE.EMP_CODE = EMPLOYEE.EMP_CODE
						WHERE     
							(TASK_TRAFFIC_ROLE.TRF_CODE = @TRF_CODE) 
							AND (EMPLOYEE.EMP_TERM_DATE IS NULL)
							AND EMPLOYEE.EMP_CODE NOT IN (
											SELECT     
												JOB_TRAFFIC_DET_EMPS.EMP_CODE
											FROM         
												JOB_TRAFFIC_DET_EMPS 
											WHERE     
												 ((JOB_TRAFFIC_DET_EMPS.JOB_NUMBER = @JOB_NUMBER) 
												AND (JOB_TRAFFIC_DET_EMPS.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR) 
												AND (JOB_TRAFFIC_DET_EMPS.SEQ_NBR = @SEQ))                    
											)
						ORDER BY
							EMPLOYEE.EMP_FNAME + ISNULL(' ' + EMPLOYEE.EMP_MI + '.', '') + ISNULL(' ' + EMPLOYEE.EMP_LNAME, '')
					End
					
				End
				 
			END
		ELSE --No Task Code
			BEGIN
				if @OfficeRestrictions > 0
				Begin
					if @EmpRestrictions > 0
					Begin
						SELECT DISTINCT 
							EMPLOYEE.EMP_CODE AS EMPCODE,
							EMPLOYEE.EMP_FNAME + ISNULL(' ' + EMPLOYEE.EMP_MI + '.', '') + ISNULL(' ' + EMPLOYEE.EMP_LNAME, '') AS EMP_NAME
						FROM
							EMPLOYEE WITH(NOLOCK) INNER JOIN
							EMP_OFFICE ON EMPLOYEE.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = @EMP_CODE INNER JOIN
							[dbo].[advtf_sec_emp] (@UserCode) AS SEC_EMP ON EMPLOYEE.EMP_CODE = SEC_EMP.EMP_CODE
						WHERE
							(EMPLOYEE.EMP_TERM_DATE IS NULL)	
							AND EMPLOYEE.EMP_CODE NOT IN (
											SELECT     
												JOB_TRAFFIC_DET_EMPS.EMP_CODE
											FROM         
												JOB_TRAFFIC_DET_EMPS 
											WHERE     
												 ((JOB_TRAFFIC_DET_EMPS.JOB_NUMBER = @JOB_NUMBER) 
												AND (JOB_TRAFFIC_DET_EMPS.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR) 
												AND (JOB_TRAFFIC_DET_EMPS.SEQ_NBR = @SEQ))                    
											)
						ORDER BY
							EMPLOYEE.EMP_FNAME + ISNULL(' ' + EMPLOYEE.EMP_MI + '.', '') + ISNULL(' ' + EMPLOYEE.EMP_LNAME, '')
					End
					Else
					Begin
						SELECT DISTINCT 
							EMPLOYEE.EMP_CODE AS EMPCODE,
							EMPLOYEE.EMP_FNAME + ISNULL(' ' + EMPLOYEE.EMP_MI + '.', '') + ISNULL(' ' + EMPLOYEE.EMP_LNAME, '') AS EMP_NAME
						FROM
							EMPLOYEE WITH(NOLOCK) INNER JOIN
							EMP_OFFICE ON EMPLOYEE.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = @EMP_CODE
						WHERE
							(EMPLOYEE.EMP_TERM_DATE IS NULL)	
							AND EMPLOYEE.EMP_CODE NOT IN (
											SELECT     
												JOB_TRAFFIC_DET_EMPS.EMP_CODE
											FROM         
												JOB_TRAFFIC_DET_EMPS 
											WHERE     
												 ((JOB_TRAFFIC_DET_EMPS.JOB_NUMBER = @JOB_NUMBER) 
												AND (JOB_TRAFFIC_DET_EMPS.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR) 
												AND (JOB_TRAFFIC_DET_EMPS.SEQ_NBR = @SEQ))                    
											)
						ORDER BY
							EMPLOYEE.EMP_FNAME + ISNULL(' ' + EMPLOYEE.EMP_MI + '.', '') + ISNULL(' ' + EMPLOYEE.EMP_LNAME, '')
					End
					
				End
				Else
				Begin
					if @EmpRestrictions > 0
					Begin
						SELECT DISTINCT 
							EMPLOYEE.EMP_CODE AS EMPCODE,
							EMPLOYEE.EMP_FNAME + ISNULL(' ' + EMPLOYEE.EMP_MI + '.', '') + ISNULL(' ' + EMPLOYEE.EMP_LNAME, '') AS EMP_NAME
						FROM
							EMPLOYEE WITH(NOLOCK) INNER JOIN
							[dbo].[advtf_sec_emp] (@UserCode) AS SEC_EMP ON EMPLOYEE.EMP_CODE = SEC_EMP.EMP_CODE
						WHERE
							(EMPLOYEE.EMP_TERM_DATE IS NULL)		
							AND EMPLOYEE.EMP_CODE NOT IN (
											SELECT     
												JOB_TRAFFIC_DET_EMPS.EMP_CODE
											FROM         
												JOB_TRAFFIC_DET_EMPS 
											WHERE     
												 ((JOB_TRAFFIC_DET_EMPS.JOB_NUMBER = @JOB_NUMBER) 
												AND (JOB_TRAFFIC_DET_EMPS.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR) 
												AND (JOB_TRAFFIC_DET_EMPS.SEQ_NBR = @SEQ))                    
											)
						ORDER BY
							EMPLOYEE.EMP_FNAME + ISNULL(' ' + EMPLOYEE.EMP_MI + '.', '') + ISNULL(' ' + EMPLOYEE.EMP_LNAME, '')
					End
					Else
					Begin
						SELECT DISTINCT 
							EMPLOYEE.EMP_CODE AS EMPCODE,
							EMPLOYEE.EMP_FNAME + ISNULL(' ' + EMPLOYEE.EMP_MI + '.', '') + ISNULL(' ' + EMPLOYEE.EMP_LNAME, '') AS EMP_NAME
						FROM
							EMPLOYEE WITH(NOLOCK)
						WHERE
							(EMPLOYEE.EMP_TERM_DATE IS NULL)	
							AND EMPLOYEE.EMP_CODE NOT IN (
											SELECT     
												JOB_TRAFFIC_DET_EMPS.EMP_CODE
											FROM         
												JOB_TRAFFIC_DET_EMPS 
											WHERE     
												 ((JOB_TRAFFIC_DET_EMPS.JOB_NUMBER = @JOB_NUMBER) 
												AND (JOB_TRAFFIC_DET_EMPS.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR) 
												AND (JOB_TRAFFIC_DET_EMPS.SEQ_NBR = @SEQ))                    
											)
						ORDER BY
							EMPLOYEE.EMP_FNAME + ISNULL(' ' + EMPLOYEE.EMP_MI + '.', '') + ISNULL(' ' + EMPLOYEE.EMP_LNAME, '')
					End
					
				End
				
			END
	END
ELSE --no job/comp/seq = no emps for this task, show all emps; no need to remove emps already assigned
	BEGIN
		IF @TRF_CODE <> '' --Restrict if has task code checkbox checked (and task code)
			BEGIN
				if @OfficeRestrictions > 0
				Begin
					if @EmpRestrictions > 0
					Begin
						SELECT DISTINCT 
							EMP_TRAFFIC_ROLE.EMP_CODE AS EMPCODE, 
							EMPLOYEE.EMP_FNAME + ISNULL(' ' + EMPLOYEE.EMP_MI + '.', '') + ISNULL(' ' + EMPLOYEE.EMP_LNAME, '') AS EMP_NAME
						FROM         
							TASK_TRAFFIC_ROLE WITH(NOLOCK) INNER JOIN
							TRAFFIC_ROLE WITH(NOLOCK) ON TASK_TRAFFIC_ROLE.ROLE_CODE = TRAFFIC_ROLE.ROLE_CODE INNER JOIN
							EMP_TRAFFIC_ROLE WITH(NOLOCK) ON TRAFFIC_ROLE.ROLE_CODE = EMP_TRAFFIC_ROLE.ROLE_CODE INNER JOIN
							EMPLOYEE WITH(NOLOCK) ON EMP_TRAFFIC_ROLE.EMP_CODE = EMPLOYEE.EMP_CODE INNER JOIN
							EMP_OFFICE ON EMPLOYEE.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = @EMP_CODE INNER JOIN
							[dbo].[advtf_sec_emp] (@UserCode) AS SEC_EMP ON EMPLOYEE.EMP_CODE = SEC_EMP.EMP_CODE
						WHERE     
							(TASK_TRAFFIC_ROLE.TRF_CODE = @TRF_CODE) 
							AND (EMPLOYEE.EMP_TERM_DATE IS NULL)
						ORDER BY
							EMPLOYEE.EMP_FNAME + ISNULL(' ' + EMPLOYEE.EMP_MI + '.', '') + ISNULL(' ' + EMPLOYEE.EMP_LNAME, '') 
					End
					Else
					Begin
						SELECT DISTINCT 
							EMP_TRAFFIC_ROLE.EMP_CODE AS EMPCODE, 
							EMPLOYEE.EMP_FNAME + ISNULL(' ' + EMPLOYEE.EMP_MI + '.', '') + ISNULL(' ' + EMPLOYEE.EMP_LNAME, '') AS EMP_NAME
						FROM         
							TASK_TRAFFIC_ROLE WITH(NOLOCK) INNER JOIN
							TRAFFIC_ROLE WITH(NOLOCK) ON TASK_TRAFFIC_ROLE.ROLE_CODE = TRAFFIC_ROLE.ROLE_CODE INNER JOIN
							EMP_TRAFFIC_ROLE WITH(NOLOCK) ON TRAFFIC_ROLE.ROLE_CODE = EMP_TRAFFIC_ROLE.ROLE_CODE INNER JOIN
							EMPLOYEE WITH(NOLOCK) ON EMP_TRAFFIC_ROLE.EMP_CODE = EMPLOYEE.EMP_CODE INNER JOIN
							EMP_OFFICE ON EMPLOYEE.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = @EMP_CODE
						WHERE     
							(TASK_TRAFFIC_ROLE.TRF_CODE = @TRF_CODE) 
							AND (EMPLOYEE.EMP_TERM_DATE IS NULL)
						ORDER BY
							EMPLOYEE.EMP_FNAME + ISNULL(' ' + EMPLOYEE.EMP_MI + '.', '') + ISNULL(' ' + EMPLOYEE.EMP_LNAME, '') 
					End
					
				End
				Else
				Begin
					if @EmpRestrictions > 0
					Begin
						SELECT DISTINCT 
							EMP_TRAFFIC_ROLE.EMP_CODE AS EMPCODE, 
							EMPLOYEE.EMP_FNAME + ISNULL(' ' + EMPLOYEE.EMP_MI + '.', '') + ISNULL(' ' + EMPLOYEE.EMP_LNAME, '') AS EMP_NAME
						FROM         
							TASK_TRAFFIC_ROLE WITH(NOLOCK) INNER JOIN
							TRAFFIC_ROLE WITH(NOLOCK) ON TASK_TRAFFIC_ROLE.ROLE_CODE = TRAFFIC_ROLE.ROLE_CODE INNER JOIN
							EMP_TRAFFIC_ROLE WITH(NOLOCK) ON TRAFFIC_ROLE.ROLE_CODE = EMP_TRAFFIC_ROLE.ROLE_CODE INNER JOIN
							EMPLOYEE WITH(NOLOCK) ON EMP_TRAFFIC_ROLE.EMP_CODE = EMPLOYEE.EMP_CODE INNER JOIN
							[dbo].[advtf_sec_emp] (@UserCode) AS SEC_EMP ON EMPLOYEE.EMP_CODE = SEC_EMP.EMP_CODE
						WHERE     
							(TASK_TRAFFIC_ROLE.TRF_CODE = @TRF_CODE) 
							AND (EMPLOYEE.EMP_TERM_DATE IS NULL)
						ORDER BY
							EMPLOYEE.EMP_FNAME + ISNULL(' ' + EMPLOYEE.EMP_MI + '.', '') + ISNULL(' ' + EMPLOYEE.EMP_LNAME, '') 
					End
					Else
					Begin
						SELECT DISTINCT 
							EMP_TRAFFIC_ROLE.EMP_CODE AS EMPCODE, 
							EMPLOYEE.EMP_FNAME + ISNULL(' ' + EMPLOYEE.EMP_MI + '.', '') + ISNULL(' ' + EMPLOYEE.EMP_LNAME, '') AS EMP_NAME
						FROM         
							TASK_TRAFFIC_ROLE WITH(NOLOCK) INNER JOIN
							TRAFFIC_ROLE WITH(NOLOCK) ON TASK_TRAFFIC_ROLE.ROLE_CODE = TRAFFIC_ROLE.ROLE_CODE INNER JOIN
							EMP_TRAFFIC_ROLE WITH(NOLOCK) ON TRAFFIC_ROLE.ROLE_CODE = EMP_TRAFFIC_ROLE.ROLE_CODE INNER JOIN
							EMPLOYEE WITH(NOLOCK) ON EMP_TRAFFIC_ROLE.EMP_CODE = EMPLOYEE.EMP_CODE
						WHERE     
							(TASK_TRAFFIC_ROLE.TRF_CODE = @TRF_CODE) 
							AND (EMPLOYEE.EMP_TERM_DATE IS NULL)
						ORDER BY
							EMPLOYEE.EMP_FNAME + ISNULL(' ' + EMPLOYEE.EMP_MI + '.', '') + ISNULL(' ' + EMPLOYEE.EMP_LNAME, '') 
					End
					
				End		
				
			END
		ELSE --No Task Code
			BEGIN
				if @OfficeRestrictions > 0
				Begin
					if @EmpRestrictions > 0
					Begin
						SELECT DISTINCT 
							EMPLOYEE.EMP_CODE AS EMPCODE,
							EMPLOYEE.EMP_FNAME + ISNULL(' ' + EMPLOYEE.EMP_MI + '.', '') + ISNULL(' ' + EMPLOYEE.EMP_LNAME, '') AS EMP_NAME
						FROM
							EMPLOYEE WITH(NOLOCK) INNER JOIN
							EMP_OFFICE ON EMPLOYEE.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = @EMP_CODE INNER JOIN
							[dbo].[advtf_sec_emp] (@UserCode) AS SEC_EMP ON EMPLOYEE.EMP_CODE = SEC_EMP.EMP_CODE
						WHERE
							(EMPLOYEE.EMP_TERM_DATE IS NULL)
						ORDER BY
							EMPLOYEE.EMP_FNAME + ISNULL(' ' + EMPLOYEE.EMP_MI + '.', '') + ISNULL(' ' + EMPLOYEE.EMP_LNAME, '')
					End
					Else
					Begin
						SELECT DISTINCT 
							EMPLOYEE.EMP_CODE AS EMPCODE,
							EMPLOYEE.EMP_FNAME + ISNULL(' ' + EMPLOYEE.EMP_MI + '.', '') + ISNULL(' ' + EMPLOYEE.EMP_LNAME, '') AS EMP_NAME
						FROM
							EMPLOYEE WITH(NOLOCK) INNER JOIN
							EMP_OFFICE ON EMPLOYEE.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = @EMP_CODE
						WHERE
							(EMPLOYEE.EMP_TERM_DATE IS NULL)	
						ORDER BY
							EMPLOYEE.EMP_FNAME + ISNULL(' ' + EMPLOYEE.EMP_MI + '.', '') + ISNULL(' ' + EMPLOYEE.EMP_LNAME, '')
					End
					
				End
				Else
				Begin
					if @EmpRestrictions > 0
					Begin
						SELECT DISTINCT 
							EMPLOYEE.EMP_CODE AS EMPCODE,
							EMPLOYEE.EMP_FNAME + ISNULL(' ' + EMPLOYEE.EMP_MI + '.', '') + ISNULL(' ' + EMPLOYEE.EMP_LNAME, '') AS EMP_NAME
						FROM
							EMPLOYEE WITH(NOLOCK) INNER JOIN
							[dbo].[advtf_sec_emp] (@UserCode) AS SEC_EMP ON EMPLOYEE.EMP_CODE = SEC_EMP.EMP_CODE
						WHERE
							(EMPLOYEE.EMP_TERM_DATE IS NULL)	
						ORDER BY
							EMPLOYEE.EMP_FNAME + ISNULL(' ' + EMPLOYEE.EMP_MI + '.', '') + ISNULL(' ' + EMPLOYEE.EMP_LNAME, '')
					End
					Else
					Begin
						SELECT DISTINCT 
							EMPLOYEE.EMP_CODE AS EMPCODE,
							EMPLOYEE.EMP_FNAME + ISNULL(' ' + EMPLOYEE.EMP_MI + '.', '') + ISNULL(' ' + EMPLOYEE.EMP_LNAME, '') AS EMP_NAME
						FROM
							EMPLOYEE WITH(NOLOCK)
						WHERE
							(EMPLOYEE.EMP_TERM_DATE IS NULL)	
						ORDER BY
							EMPLOYEE.EMP_FNAME + ISNULL(' ' + EMPLOYEE.EMP_MI + '.', '') + ISNULL(' ' + EMPLOYEE.EMP_LNAME, '')
					End
					
				End
				
			END
	END


