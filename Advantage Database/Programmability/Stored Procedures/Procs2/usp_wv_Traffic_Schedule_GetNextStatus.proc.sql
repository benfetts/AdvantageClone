CREATE PROCEDURE [dbo].[usp_wv_Traffic_Schedule_GetNextStatus] 
@JOB_NUMBER AS INT,
@JOB_COMPONENT_NBR AS SMALLINT
AS

DECLARE
@OPEN_TASKS AS SMALLINT,
@MAX_SEQ AS SMALLINT

SELECT 
	@OPEN_TASKS = COUNT(1) 
FROM 
	JOB_TRAFFIC_DET
WHERE     
	(JOB_TRAFFIC_DET.JOB_NUMBER = @JOB_NUMBER) 
	AND (JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR) 
	AND (JOB_TRAFFIC_DET.JOB_COMPLETED_DATE IS NULL)

IF @OPEN_TASKS > 0
	BEGIN
		SELECT     
			TOP 1 JOB_TRAFFIC_DET.SEQ_NBR AS NEXT_SEQ_NBR, 
			JOB_TRAFFIC_DET.FNC_CODE AS NEXT_FNC_CODE, 
			ISNULL(TRAFFIC.TRF_CODE,'') AS NEXT_STATUS_CODE,
			ISNULL(TRAFFIC.TRF_DESCRIPTION,'') AS NEXT_STATUS_DESCRIPTION,
			ISNULL(TRAFFIC.TRF_CODE,'NONE')+ISNULL(' - '+TRAFFIC.TRF_DESCRIPTION,'') AS NEXT_STATUS_CODE_DESCRIPTION
		FROM         
			TRAFFIC RIGHT OUTER JOIN
			TRAFFIC_FNC ON TRAFFIC.TRF_CODE = TRAFFIC_FNC.DEF_STATUS LEFT OUTER JOIN
			JOB_TRAFFIC_DET ON TRAFFIC_FNC.TRF_CODE = JOB_TRAFFIC_DET.FNC_CODE LEFT OUTER JOIN
			dbo.advtf_traffic_schedule_GetHierarchyDates(@JOB_NUMBER, @JOB_COMPONENT_NBR) HT ON JOB_TRAFFIC_DET.JOB_NUMBER = HT.JOB_NUMBER AND
																								JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = HT.JOB_COMPONENT_NBR AND
																								JOB_TRAFFIC_DET.SEQ_NBR = HT.SEQ_NBR
		WHERE     
			(JOB_TRAFFIC_DET.JOB_NUMBER = @JOB_NUMBER) 
			AND (JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR) 
			AND (JOB_TRAFFIC_DET.JOB_COMPLETED_DATE IS NULL)
			AND ISNULL(HT.HAS_CHILDREN, 0) = 0
		ORDER BY 
			JOB_TRAFFIC_DET.JOB_ORDER ASC, 
			JOB_TRAFFIC_DET.JOB_REVISED_DATE ASC,
			JOB_TRAFFIC_DET.SEQ_NBR ASC
	END
ELSE -- NO OPEN TASKS, JUST SET TO HIGHEST TASK
	BEGIN

		SELECT @MAX_SEQ = A.SEQ_NBR
		FROM
		(
				SELECT TOP 1
					JOB_TRAFFIC_DET.SEQ_NBR,JOB_TRAFFIC_DET.JOB_ORDER
				FROM         
					JOB_TRAFFIC_DET  LEFT OUTER JOIN
					dbo.advtf_traffic_schedule_GetHierarchyDates(@JOB_NUMBER, @JOB_COMPONENT_NBR) HT ON JOB_TRAFFIC_DET.JOB_NUMBER = HT.JOB_NUMBER AND
																										JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = HT.JOB_COMPONENT_NBR AND
																										JOB_TRAFFIC_DET.SEQ_NBR = HT.SEQ_NBR
				WHERE     
					(JOB_TRAFFIC_DET.JOB_NUMBER = @JOB_NUMBER) 
					AND (JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR)
					AND ISNULL(HT.HAS_CHILDREN, 0) = 0
				ORDER BY 
					JOB_TRAFFIC_DET.JOB_ORDER DESC, 
					JOB_TRAFFIC_DET.JOB_REVISED_DATE DESC,
					JOB_TRAFFIC_DET.SEQ_NBR DESC
		) AS A

	SELECT     
		TOP 1 JOB_TRAFFIC_DET.SEQ_NBR AS NEXT_SEQ_NBR, 
		JOB_TRAFFIC_DET.FNC_CODE AS NEXT_FNC_CODE, 
		ISNULL(TRAFFIC.TRF_CODE,'') AS NEXT_STATUS_CODE,
		ISNULL(TRAFFIC.TRF_DESCRIPTION,'') AS NEXT_STATUS_DESCRIPTION,
		ISNULL(TRAFFIC.TRF_CODE,'NONE')+ISNULL(' - '+TRAFFIC.TRF_DESCRIPTION,'') AS NEXT_STATUS_CODE_DESCRIPTION
	FROM         
		TRAFFIC RIGHT OUTER JOIN
		TRAFFIC_FNC ON TRAFFIC.TRF_CODE = TRAFFIC_FNC.DEF_STATUS LEFT OUTER JOIN
		JOB_TRAFFIC_DET ON TRAFFIC_FNC.TRF_CODE = JOB_TRAFFIC_DET.FNC_CODE
	WHERE     
		(JOB_TRAFFIC_DET.JOB_NUMBER = @JOB_NUMBER) 
		AND (JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR) 
		AND (JOB_TRAFFIC_DET.SEQ_NBR = @MAX_SEQ)
	ORDER BY 
		JOB_TRAFFIC_DET.JOB_ORDER ASC, 
		JOB_TRAFFIC_DET.JOB_REVISED_DATE ASC,
		JOB_TRAFFIC_DET.SEQ_NBR ASC

END