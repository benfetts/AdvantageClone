CREATE PROCEDURE [dbo].[usp_wv_Traffic_Schedule_GetScheduleUserColumns] 
@HDR_CODE VARCHAR(6),
-- -1 = SHOW ALL TRUE
@SHOW_ALL INT,
@IS_SETUP INT,
@IS_ADDNEW INT
AS
DECLARE
@HAS_CUSTOM INT,
@DISPLAY_TYPE VARCHAR(4)

--TEMP:
--SELECT @HDR_CODE = 'ALLITM'

SELECT @HAS_CUSTOM = ISNULL(COUNT(1),0) FROM JOB_TRAFFIC_SETUP_DTL WHERE HDR_CODE = @HDR_CODE

----IF @IS_SETUP = 1 
----BEGIN
----    SELECT @HAS_CUSTOM = 1
----END

IF @IS_ADDNEW = 1
    BEGIN
        SET @DISPLAY_TYPE = 'A'
    END
ELSE
    BEGIN
        SET @DISPLAY_TYPE = 'G'
    END

--OR DO WE CREATE A USER TEMPLATE BASED ON THE DEFAULT HERE
IF @HAS_CUSTOM = 0 AND @HDR_CODE <> 'DFLT'
BEGIN
--CLEAR OUT COLUMNS, DON'T REALLY NEED THIS, JUST IN TESTING:
--DELETE FROM JOB_TRAFFIC_SETUP_DTL WHERE  HDR_CODE = @HDR_CODE
INSERT INTO JOB_TRAFFIC_SETUP_DTL WITH(ROWLOCK) (HDR_CODE,COLUMN_ID,SHOW_LONG_DESC,SEQ,DISPLAY_TYPE)
SELECT @HDR_CODE, COLUMN_ID,SHOW_LONG_DESC, SEQ,DISPLAY_TYPE FROM JOB_TRAFFIC_SETUP_DTL WHERE (HDR_CODE = 'DFLT')

END

SELECT @HAS_CUSTOM = ISNULL(COUNT(1),0) FROM JOB_TRAFFIC_SETUP_DTL WHERE HDR_CODE = @HDR_CODE

IF @HAS_CUSTOM = 0 
    BEGIN
 -- START DEFAULT
       SELECT 
			[ID] = A.ID,  
			[ColumnName] = A.COLUMN_NAME, 
			[ColumnLongDescription] = ISNULL(A.COLUMN_LONG_DESC,''),
			[ColumnShortDescription] = ISNULL(A.COLUMN_SHORT_DESC,''),
			[AgencyRequired] = ISNULL(A.AGENCY_REQ,0),
			[ClientRequired] = ISNULL(A.CLIENT_REQ,0),
			[Active] = ISNULL(A.ACTIVE,0),
			[DefaultShowLongDescription] = ISNULL(A.DEFAULT_SHOW_LONG_DESC,0),
			[ShowLongDescription] = ISNULL(A.SHOW_LONG_DESC,0),
			[SequenceNumber] = ISNULL(A.SEQ,-1),
			[HeaderCode] = ISNULL(A.HDR_CODE,''),
			[ShowOnGrid] = CASE A.DISPLAY_TYPE
 				                WHEN 'G' THEN 'True'
 				                WHEN 'GA' THEN 'True'
 				                WHEN NULL THEN 'False'
 				                ELSE 'False'
				        END,
			[ShowOnAddNew] = CASE A.DISPLAY_TYPE
 				                WHEN 'A' THEN 'True'
 				                WHEN 'GA' THEN 'True'
 				                WHEN NULL THEN 'False'
 				                ELSE 'False'
				        END,
			[ShowFull] = CASE A.SHOW_LONG_DESC
				            WHEN 1 THEN 'True'
				            ELSE 'False'
				        END,
			[HeaderText] = CASE A.SHOW_LONG_DESC
				            WHEN 1 THEN ISNULL(A.COLUMN_LONG_DESC,'')
				            ELSE ISNULL(A.COLUMN_SHORT_DESC,'')
				        END,
			[DisplayType] = A.DISPLAY_TYPE,
			[ColumnOrder] = A.COLUMN_ORDER
        FROM
	        (
			        SELECT  
				        JOB_TRAFFIC_SETUP_ITEMS.ID,   
				        JOB_TRAFFIC_SETUP_ITEMS.COLUMN_NAME, 
				        JOB_TRAFFIC_SETUP_ITEMS.COLUMN_LONG_DESC, 
				        JOB_TRAFFIC_SETUP_ITEMS.COLUMN_SHORT_DESC, 
				        JOB_TRAFFIC_SETUP_ITEMS.AGENCY_REQ, 
				        JOB_TRAFFIC_SETUP_ITEMS.CLIENT_REQ, 
				        JOB_TRAFFIC_SETUP_ITEMS.ACTIVE, 
				        JOB_TRAFFIC_SETUP_ITEMS.DEFAULT_SHOW_LONG_DESC, 
				        JOB_TRAFFIC_SETUP_DTL.SHOW_LONG_DESC, 
				        JOB_TRAFFIC_SETUP_DTL.SEQ,
				        JOB_TRAFFIC_SETUP_DTL.HDR_CODE,
				        JOB_TRAFFIC_SETUP_DTL.DISPLAY_TYPE, 
				        [COLUMN_ORDER] = ISNULL(JOB_TRAFFIC_SETUP_DTL.COLUMN_ORDER, JOB_TRAFFIC_SETUP_ITEMS.COLUMN_ORDER)
			        FROM         
				        JOB_TRAFFIC_SETUP_ITEMS WITH(NOLOCK) LEFT OUTER JOIN
				        JOB_TRAFFIC_SETUP_DTL WITH(NOLOCK) ON JOB_TRAFFIC_SETUP_ITEMS.ID = JOB_TRAFFIC_SETUP_DTL.COLUMN_ID
			        WHERE     
				        (JOB_TRAFFIC_SETUP_DTL.HDR_CODE = 'DFLT') --AND (JOB_TRAFFIC_SETUP_DTL.DISPLAY_TYPE = @DISPLAY_TYPE)
		        UNION
			        SELECT     
				        JOB_TRAFFIC_SETUP_ITEMS.ID,
				        JOB_TRAFFIC_SETUP_ITEMS.COLUMN_NAME, 
				        JOB_TRAFFIC_SETUP_ITEMS.COLUMN_LONG_DESC, 
				        JOB_TRAFFIC_SETUP_ITEMS.COLUMN_SHORT_DESC, 
				        JOB_TRAFFIC_SETUP_ITEMS.AGENCY_REQ, 
				        JOB_TRAFFIC_SETUP_ITEMS.CLIENT_REQ, 
				        JOB_TRAFFIC_SETUP_ITEMS.ACTIVE, 
				        JOB_TRAFFIC_SETUP_ITEMS.DEFAULT_SHOW_LONG_DESC, 
				        0 AS SHOW_LONG_DESC, 
				        -1 AS SEQ,
				        NULL AS HDR_CODE,
				        NULL AS DISPLAY_TYPE, 
				        JOB_TRAFFIC_SETUP_ITEMS.COLUMN_ORDER
			        FROM         
				        JOB_TRAFFIC_SETUP_ITEMS WITH(NOLOCK) 
			        WHERE     
				        (JOB_TRAFFIC_SETUP_ITEMS.ID NOT IN
				        (SELECT JOB_TRAFFIC_SETUP_DTL.COLUMN_ID FROM JOB_TRAFFIC_SETUP_DTL WITH(NOLOCK) WHERE JOB_TRAFFIC_SETUP_DTL.HDR_CODE = 'DFLT'))
	        ) AS A
        WHERE
            (NOT (A.COLUMN_NAME IS NULL)) AND
	        (A.SEQ > 0 OR A.SEQ = @SHOW_ALL	) AND
	        (A.ACTIVE = 1 OR A.ACTIVE = 3)
        ORDER BY 
	        A.COLUMN_ORDER
-- END DEFAULT
    END
ELSE
    BEGIN
--  START USER    
        SELECT
			[ID] = A.ID,  
			[ColumnName] = A.COLUMN_NAME, 
			[ColumnLongDescription] = ISNULL(A.COLUMN_LONG_DESC,''),
			[ColumnShortDescription] = ISNULL(A.COLUMN_SHORT_DESC,''),
			[AgencyRequired] = ISNULL(A.AGENCY_REQ,0),
			[ClientRequired] = ISNULL(A.CLIENT_REQ,0),
			[Active] = ISNULL(A.ACTIVE,0),
			[DefaultShowLongDescription] = ISNULL(A.DEFAULT_SHOW_LONG_DESC,0),
			[ShowLongDescription] = ISNULL(A.SHOW_LONG_DESC,0),
			[SequenceNumber] = ISNULL(A.SEQ,-1),
			[HeaderCode] = ISNULL(A.HDR_CODE,''),
			[ShowOnGrid] = CASE A.DISPLAY_TYPE
 								WHEN 'G' THEN 'True'
 								WHEN 'GA' THEN 'True'
 								WHEN NULL THEN 'False'
 								ELSE 'False'
						END,
			[ShowOnAddNew] = CASE A.DISPLAY_TYPE
 								WHEN 'A' THEN 'True'
 								WHEN 'GA' THEN 'True'
 								WHEN NULL THEN 'False'
 								ELSE 'False'
						END,
			[ShowFull] = CASE A.SHOW_LONG_DESC
							WHEN 1 THEN 'True'
							ELSE 'False'
						END,
			[HeaderText] = CASE A.SHOW_LONG_DESC
							WHEN 1 THEN ISNULL(A.COLUMN_LONG_DESC,'')
							ELSE ISNULL(A.COLUMN_SHORT_DESC,'')
						END,
			[DisplayType] = A.DISPLAY_TYPE,
			[ColumnOrder] = A.COLUMN_ORDER
       FROM
	        (
			        SELECT  
				        JOB_TRAFFIC_SETUP_ITEMS.ID,   
				        JOB_TRAFFIC_SETUP_ITEMS.COLUMN_NAME, 
				        JOB_TRAFFIC_SETUP_ITEMS.COLUMN_LONG_DESC, 
				        JOB_TRAFFIC_SETUP_ITEMS.COLUMN_SHORT_DESC, 
				        JOB_TRAFFIC_SETUP_ITEMS.AGENCY_REQ, 
				        JOB_TRAFFIC_SETUP_ITEMS.CLIENT_REQ, 
				        JOB_TRAFFIC_SETUP_ITEMS.ACTIVE, 
				        JOB_TRAFFIC_SETUP_ITEMS.DEFAULT_SHOW_LONG_DESC, 
				        JOB_TRAFFIC_SETUP_DTL.SHOW_LONG_DESC, 
				        JOB_TRAFFIC_SETUP_DTL.SEQ,
				        JOB_TRAFFIC_SETUP_DTL.HDR_CODE,
				        JOB_TRAFFIC_SETUP_DTL.DISPLAY_TYPE, 
				        [COLUMN_ORDER] = ISNULL(JOB_TRAFFIC_SETUP_DTL.COLUMN_ORDER, JOB_TRAFFIC_SETUP_ITEMS.COLUMN_ORDER)
			        FROM         
				        JOB_TRAFFIC_SETUP_ITEMS WITH(NOLOCK) LEFT OUTER JOIN
				        JOB_TRAFFIC_SETUP_DTL WITH(NOLOCK) ON JOB_TRAFFIC_SETUP_ITEMS.ID = JOB_TRAFFIC_SETUP_DTL.COLUMN_ID
			        WHERE     
				        (JOB_TRAFFIC_SETUP_DTL.HDR_CODE = @HDR_CODE) --AND (JOB_TRAFFIC_SETUP_DTL.DISPLAY_TYPE = @DISPLAY_TYPE)
		        UNION
			        SELECT     
				        JOB_TRAFFIC_SETUP_ITEMS.ID,
				        JOB_TRAFFIC_SETUP_ITEMS.COLUMN_NAME, 
				        JOB_TRAFFIC_SETUP_ITEMS.COLUMN_LONG_DESC, 
				        JOB_TRAFFIC_SETUP_ITEMS.COLUMN_SHORT_DESC, 
				        JOB_TRAFFIC_SETUP_ITEMS.AGENCY_REQ, 
				        JOB_TRAFFIC_SETUP_ITEMS.CLIENT_REQ, 
				        JOB_TRAFFIC_SETUP_ITEMS.ACTIVE, 
				        JOB_TRAFFIC_SETUP_ITEMS.DEFAULT_SHOW_LONG_DESC, 
				        0 AS SHOW_LONG_DESC, 
				        -1 AS SEQ,
				        NULL AS HDR_CODE,
				        NULL AS DISPLAY_TYPE, 
				        JOB_TRAFFIC_SETUP_ITEMS.COLUMN_ORDER
			        FROM         
				        JOB_TRAFFIC_SETUP_ITEMS WITH(NOLOCK) 
			        WHERE     
				        (JOB_TRAFFIC_SETUP_ITEMS.ID NOT IN
				        (SELECT JOB_TRAFFIC_SETUP_DTL.COLUMN_ID FROM JOB_TRAFFIC_SETUP_DTL WITH(NOLOCK) WHERE JOB_TRAFFIC_SETUP_DTL.HDR_CODE = @HDR_CODE))
	        ) AS A
        	
        WHERE
            (NOT (A.COLUMN_NAME IS NULL)) AND
	        (A.SEQ > 0 OR A.SEQ = @SHOW_ALL	) AND
	        (A.ACTIVE = 1 OR A.ACTIVE = 3)
        ORDER BY 
	        A.COLUMN_ORDER
--  END USER    
    END
	
