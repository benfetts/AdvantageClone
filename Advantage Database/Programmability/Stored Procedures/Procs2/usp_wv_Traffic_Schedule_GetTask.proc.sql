

CREATE PROCEDURE [dbo].[usp_wv_Traffic_Schedule_GetTask]
@JOB_NUMBER INT,
@JOB_COMPONENT_NBR INT,
@SEQ SMALLINT
AS


SELECT     
	JOB_TRAFFIC_DET.ROWID, 
	JOB_TRAFFIC_DET.JOB_NUMBER, 
	JOB_TRAFFIC_DET.JOB_COMPONENT_NBR, 
	JOB_TRAFFIC_DET.FNC_CODE AS TASK_CODE, 
	JOB_TRAFFIC_DET.TASK_DESCRIPTION,
	JOB_TRAFFIC_DET.TASK_STATUS, 
	JOB_TRAFFIC_DET.EMP_CODE, 
	JOB_TRAFFIC_DET.TASK_START_DATE, 
	JOB_TRAFFIC_DET.JOB_REVISED_DATE, 
	JOB_TRAFFIC_DET.JOB_COMPLETED_DATE, 
	JOB_TRAFFIC_DET.JOB_DUE_DATE,
	JOB_TRAFFIC_DET.REVISED_DUE_TIME AS REVISED_DUE_TIME, 
	JOB_TRAFFIC_DET.TEMP_COMP_DATE AS Temp_Completed, 
	ISNULL(JOB_TRAFFIC_DET.TRAFFIC_PHASE_ID, 0) AS TRAFFIC_PHASE_ID, 
	TRAFFIC_PHASE.PHASE_ORDER, 
	TRAFFIC_PHASE.PHASE_DESC, 
	JOB_TRAFFIC_DET.JOB_ORDER, 
	JOB_TRAFFIC_DET.JOB_DAYS, 
	JOB_TRAFFIC_DET.JOB_HRS, 
	JOB_TRAFFIC_DET.DUE_TIME, 
	JOB_TRAFFIC_DET.MILESTONE, 
	'1' AS PREDECESSOR,
	CAST(JOB_TRAFFIC_DET.FNC_COMMENTS AS VARCHAR(4000)) 	AS FNC_COMMENTS, 
	CAST(JOB_TRAFFIC_DET.DUE_DATE_COMMENTS AS VARCHAR(4000)) AS DUE_DATE_COMMENTS, 
	CAST(JOB_TRAFFIC_DET.REV_DATE_COMMENTS AS VARCHAR(4000)) AS REV_DATE_COMMENTS
FROM         
	JOB_COMPONENT INNER JOIN
	JOB_TRAFFIC ON JOB_COMPONENT.JOB_NUMBER = JOB_TRAFFIC.JOB_NUMBER AND 
	JOB_COMPONENT.JOB_COMPONENT_NBR = JOB_TRAFFIC.JOB_COMPONENT_NBR INNER JOIN
	JOB_TRAFFIC_DET ON JOB_TRAFFIC_DET.JOB_NUMBER = JOB_TRAFFIC.JOB_NUMBER AND 
	JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = JOB_TRAFFIC.JOB_COMPONENT_NBR INNER JOIN
	JOB_LOG ON JOB_TRAFFIC.JOB_NUMBER = JOB_LOG.JOB_NUMBER LEFT OUTER JOIN
	TRAFFIC_PHASE ON JOB_TRAFFIC_DET.TRAFFIC_PHASE_ID = TRAFFIC_PHASE.TRAFFIC_PHASE_ID LEFT OUTER JOIN
	TASK_TRAFFIC_ROLE ON JOB_TRAFFIC_DET.FNC_CODE = TASK_TRAFFIC_ROLE.TRF_CODE LEFT OUTER JOIN
	EMP_TRAFFIC_ROLE ON JOB_TRAFFIC_DET.EMP_CODE = EMP_TRAFFIC_ROLE.EMP_CODE
WHERE  
	 (JOB_TRAFFIC_DET.JOB_NUMBER = @JOB_NUMBER) AND (JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR) AND (JOB_TRAFFIC_DET.SEQ_NBR = @SEQ)
GROUP BY 
	JOB_TRAFFIC_DET.ROWID,
	JOB_TRAFFIC_DET.JOB_NUMBER,
	JOB_TRAFFIC_DET.JOB_COMPONENT_NBR,
	JOB_TRAFFIC_DET.FNC_CODE, 
	JOB_TRAFFIC_DET.TASK_DESCRIPTION , 
	JOB_TRAFFIC_DET.TASK_STATUS, 
	JOB_TRAFFIC_DET.EMP_CODE, 
	JOB_TRAFFIC_DET.TASK_START_DATE, 
	JOB_TRAFFIC_DET.JOB_REVISED_DATE,   
	JOB_TRAFFIC_DET.REVISED_DUE_TIME,
	JOB_TRAFFIC_DET.JOB_COMPLETED_DATE,  
	JOB_TRAFFIC_DET.TEMP_COMP_DATE,
	CAST(JOB_TRAFFIC_DET.FNC_COMMENTS AS VARCHAR(4000)),
	JOB_TRAFFIC_DET.TRAFFIC_PHASE_ID,
	TRAFFIC_PHASE.PHASE_ORDER,TRAFFIC_PHASE.PHASE_DESC,JOB_TRAFFIC_DET.JOB_ORDER,
	JOB_TRAFFIC_DET.JOB_DAYS,
	CAST(JOB_TRAFFIC_DET.DUE_DATE_COMMENTS AS VARCHAR(4000)),
	CAST(JOB_TRAFFIC_DET.REV_DATE_COMMENTS AS VARCHAR(4000)),
	JOB_TRAFFIC_DET.JOB_HRS,
	JOB_TRAFFIC_DET.DUE_TIME,JOB_TRAFFIC_DET.MILESTONE,
	JOB_TRAFFIC_DET.JOB_DUE_DATE
ORDER BY
	TRAFFIC_PHASE.PHASE_ORDER,
	JOB_TRAFFIC_DET.TRAFFIC_PHASE_ID ASC,
	JOB_TRAFFIC_DET.TASK_START_DATE,
	JOB_TRAFFIC_DET.JOB_REVISED_DATE




