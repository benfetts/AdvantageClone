
CREATE PROCEDURE [dbo].[usp_wv_Traffic_Schedule_MoveTask_UpDown] 
@JOB_NUMBER INT,
@JOB_COMPONENT_NBR SMALLINT,
@SEQ_NBR SMALLINT,
@MOVE_UP SMALLINT

AS
DECLARE
@BASE_TABLE TABLE
(
[ID] INT IDENTITY (1, 1) NOT NULL ,
[JOB_ORDER] SMALLINT,
[SEQ_NBR] SMALLINT
)
DECLARE
@DISTINCT_ORDERS TABLE
(
[ID] INT IDENTITY (1, 1) NOT NULL ,
[JOB_ORDER] SMALLINT
)


DECLARE
@CURR_ORDER SMALLINT,
@DISTINCT_CURR_ORDER SMALLINT,
@MAX_ID SMALLINT,
@NEW_ORDER SMALLINT,
@NEW_ID INT,
@CURR_ID INT

--BASE DATA TO WORK WITH
INSERT INTO @BASE_TABLE(JOB_ORDER,SEQ_NBR)
SELECT JOB_TRAFFIC_DET.JOB_ORDER, JOB_TRAFFIC_DET.SEQ_NBR
FROM JOB_TRAFFIC_DET
WHERE
(JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR) AND 
                      (JOB_TRAFFIC_DET.JOB_NUMBER = @JOB_NUMBER)
ORDER BY JOB_TRAFFIC_DET.JOB_ORDER, JOB_TRAFFIC_DET.SEQ_NBR

--DISTINCT JOB ORDERS TO WORK WITH
INSERT INTO @DISTINCT_ORDERS(JOB_ORDER)
SELECT DISTINCT JOB_ORDER 
FROM JOB_TRAFFIC_DET
WHERE
(JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR) AND 
                      (JOB_TRAFFIC_DET.JOB_NUMBER = @JOB_NUMBER)
ORDER BY JOB_TRAFFIC_DET.JOB_ORDER

--INITIALIZE
SELECT @CURR_ID = ID, @CURR_ORDER = JOB_ORDER
FROM @BASE_TABLE WHERE SEQ_NBR = @SEQ_NBR

--GET NEXT/PREVIOUS ORDER
----MOVE UP ONE:
IF @MOVE_UP = 1
BEGIN
	SELECT @NEW_ID = ID - 1 FROM @DISTINCT_ORDERS
	WHERE JOB_ORDER = @CURR_ORDER
END

----MOVE DOWN ONE:
IF @MOVE_UP = 0
BEGIN
	SELECT @NEW_ID = ID + 1 FROM @DISTINCT_ORDERS
	WHERE JOB_ORDER = @CURR_ORDER
END

--HANDLE IF ID IS LESS THAN ONE (GET THE FIRST RECORD AND LOWEST ID/ORDER)
IF @NEW_ID <= 0
	BEGIN
		SET @NEW_ID = 1
	END
--HANDLE IF ID IS GREATER THAN THE HIGHEST ONE FOR THIS TASK (GET LAST RECORD AND THE HIGHEST ID/ORDER)
SELECT @MAX_ID = MAX(ID) FROM @DISTINCT_ORDERS
IF @NEW_ID > @MAX_ID
	BEGIN
		SET @NEW_ID = @MAX_ID
	END

--GET THE NEW ORDER
SELECT @NEW_ORDER = JOB_ORDER FROM @DISTINCT_ORDERS
WHERE ID = @NEW_ID


--TEST::
--SELECT * FROM @BASE_TABLE
--SELECT * FROM @DISTINCT_ORDERS
--SELECT @CURR_ID, @CURR_ORDER
--SELECT @NEW_ID
--SELECT @NEW_ORDER

--SELECT @NEW_ORDER = JOB_ORDER
--FROM @DISTINCT_ORDERS

UPDATE JOB_TRAFFIC_DET SET JOB_ORDER = @NEW_ORDER
WHERE JOB_NUMBER = @JOB_NUMBER
AND JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR
AND SEQ_NBR = @SEQ_NBR

