if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_wv_Traffic_Schedule_SaveTaskDaysByDate]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_wv_Traffic_Schedule_SaveTaskDaysByDate]
GO

CREATE PROCEDURE [dbo].[usp_wv_Traffic_Schedule_SaveTaskDaysByDate] 
@JOB_NUMBER INT,
@JOB_COMPONENT_NBR SMALLINT,
@SEQ_NBR SMALLINT

AS


DECLARE
@OK_UPDATE SMALLINT,
@NUM_DAYS SMALLINT, @START_DATE smalldatetime, @END_DATE smalldatetime, @S_DATE smalldatetime, @DAYS smallint

SET @OK_UPDATE = 0
SET @NUM_DAYS = 0
SET @DAYS = 0

SELECT     
	@OK_UPDATE = ISNULL(COUNT(1),0)
FROM         
	JOB_TRAFFIC_DET WITH(NOLOCK)
WHERE     
	(JOB_NUMBER = @JOB_NUMBER) 
	AND (JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR) 
	AND (SEQ_NBR = @SEQ_NBR) 
	AND (NOT (TASK_START_DATE IS NULL)) 
	AND  (NOT (JOB_REVISED_DATE IS NULL))
	
SELECT     
	@NUM_DAYS = DATEDIFF(day,TASK_START_DATE, JOB_REVISED_DATE),
	@START_DATE = TASK_START_DATE,
	@END_DATE = JOB_REVISED_DATE
FROM         
	JOB_TRAFFIC_DET WITH(NOLOCK)
WHERE     
	(JOB_NUMBER = @JOB_NUMBER) 
	AND (JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR) 
	AND (SEQ_NBR = @SEQ_NBR) 
	AND (NOT (TASK_START_DATE IS NULL)) 
	AND  (NOT (JOB_REVISED_DATE IS NULL))
	
IF @NUM_DAYS < 0
BEGIN
	SET @NUM_DAYS = 0
END		

--SELECT @OK_UPDATE, @NUM_DAYS


IF @OK_UPDATE > 0
BEGIN
	
	If @START_DATE IS NOT NULL AND @END_DATE IS NOT NULL
	SET @S_DATE = @START_DATE
	BEGIN
		WHILE @S_DATE <= @END_DATE
		BEGIN
			--SELECT @S_DATE,DATEPART(weekday, @S_DATE)
			IF DATEPART(weekday, @S_DATE) <> 1 AND DATEPART(weekday, @S_DATE) <> 7
			BEGIN
				SET @DAYS = @DAYS + 1
			END			
			SELECT @S_DATE = DATEADD(day, 1, @S_DATE)
		END
	END

	--SELECT @DAYS

		UPDATE 
			JOB_TRAFFIC_DET WITH(ROWLOCK)
		SET 
			JOB_DAYS = @DAYS	
		WHERE
			JOB_NUMBER = @JOB_NUMBER 
			AND JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR
			AND SEQ_NBR = @SEQ_NBR		
END



