

CREATE PROCEDURE [dbo].[usp_wv_Traffic_Schedule_SaveTask_Lock]
@JOB_NUMBER INT,
@JOB_COMPONENT_NBR INT,
@SEQ SMALLINT
AS
DECLARE
@TaskDueDateLock SMALLINT

SELECT     @TaskDueDateLock =  ISNULL(DUE_DATE_LOCK,0)
FROM         JOB_TRAFFIC_DET
WHERE     ((DUE_DATE_LOCK = 0 OR
                      DUE_DATE_LOCK IS NULL)) 
                      AND 	 ((JOB_TRAFFIC_DET.JOB_NUMBER = @JOB_NUMBER) AND (JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR) AND (JOB_TRAFFIC_DET.SEQ_NBR = @SEQ))

                      
IF    @TaskDueDateLock = 0
    BEGIN                   
        UPDATE 
            JOB_TRAFFIC_DET WITH(ROWLOCK)
        SET
            JOB_TRAFFIC_DET.DUE_DATE_LOCK = 1
        WHERE 
            (JOB_TRAFFIC_DET.JOB_NUMBER = @JOB_NUMBER) AND (JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR) AND (JOB_TRAFFIC_DET.SEQ_NBR = @SEQ)
    END
ELSE
    BEGIN
        UPDATE 
            JOB_TRAFFIC_DET WITH(ROWLOCK)
        SET
            JOB_TRAFFIC_DET.DUE_DATE_LOCK = 0
        WHERE 
            (JOB_TRAFFIC_DET.JOB_NUMBER = @JOB_NUMBER) AND (JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR) AND (JOB_TRAFFIC_DET.SEQ_NBR = @SEQ)
END


