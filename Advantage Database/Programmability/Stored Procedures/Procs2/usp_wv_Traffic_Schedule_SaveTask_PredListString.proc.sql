
CREATE PROCEDURE [dbo].[usp_wv_Traffic_Schedule_SaveTask_PredListString] 
@PRED_LIST VARCHAR(2000),
@JOB_NUMBER INT,
@JOB_COMPONENT_NBR INT,
@SEQ_NBR SMALLINT
AS

	IF DATALENGTH(@PRED_LIST) = 0
		BEGIN
			DELETE FROM JOB_TRAFFIC_DET_PREDS WITH(ROWLOCK) WHERE (JOB_NUMBER = @JOB_NUMBER) AND (JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR) AND (SEQ_NBR = @SEQ_NBR);
		END
	ELSE
		BEGIN
			DECLARE
			@USER_ENTERED TABLE
			(
			PREDECESSOR_SEQ_NBR INT
			);
			DECLARE
			@TABLE_LIST TABLE
			(
			PREDECESSOR_SEQ_NBR INT
			);
			DECLARE
			@RETURN_MESSAGES TABLE
			(
			MESSAGE VARCHAR(200)
			);

			DECLARE 
			@PREDECESSOR_SEQ_NBR INT,
			@POS INT,
			@IS_IN_TABLE INT,
			@IS_VALID_EMP_CODE INT

			--TEST DATA:
			--SET @PRED_LIST = '1,2,4,5,11'
			--SET @JOB_NUMBER = 15
			--SET @JOB_COMPONENT_NBR = 1
			--SET @SEQ_NBR = 1

			--GET WHAT'S ALREADY IN REAL TABLE INTO:
			INSERT INTO @TABLE_LIST(PREDECESSOR_SEQ_NBR)
			SELECT PREDECESSOR_SEQ_NBR FROM JOB_TRAFFIC_DET_PREDS WITH(NOLOCK) WHERE (JOB_NUMBER = @JOB_NUMBER) AND (JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR) AND (SEQ_NBR = @SEQ_NBR)


			--LOOP THROUGH LIST AND INSERT INTO 
			SET @PRED_LIST = LTRIM(RTRIM(@PRED_LIST)) + ','
			SET @POS = CHARINDEX(',',@PRED_LIST,1)

			IF REPLACE(@PRED_LIST,',','') <> ''
			BEGIN
				WHILE @POS > 0
					BEGIN
						SET @PREDECESSOR_SEQ_NBR = LTRIM(RTRIM(LEFT(@PRED_LIST, @POS - 1)))
						IF @PREDECESSOR_SEQ_NBR >= 0
						BEGIN
							INSERT INTO @USER_ENTERED(PREDECESSOR_SEQ_NBR) VALUES(@PREDECESSOR_SEQ_NBR)
						END
					SET @PRED_LIST = RIGHT(@PRED_LIST,LEN(@PRED_LIST) - @POS)
					SET @POS = CHARINDEX(',',@PRED_LIST,1)
					END
			END

			--SELECT * FROM @TABLE_LIST ORDER BY PREDECESSOR_SEQ_NBR
			--SELECT * FROM @USER_ENTERED ORDER BY PREDECESSOR_SEQ_NBR

			--RECS TO DELETE:
			-----SELECT PREDECESSOR_SEQ_NBR FROM @TABLE_LIST WHERE PREDECESSOR_SEQ_NBR NOT IN (SELECT * FROM @USER_ENTERED)
			--RECS FOR INSERT:
			----SELECT PREDECESSOR_SEQ_NBR FROM @USER_ENTERED WHERE PREDECESSOR_SEQ_NBR NOT IN (SELECT * FROM @TABLE_LIST)

			/* */
			DELETE FROM JOB_TRAFFIC_DET_PREDS WITH(ROWLOCK) WHERE ((JOB_NUMBER = @JOB_NUMBER) AND (JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR) AND (SEQ_NBR = @SEQ_NBR))
			AND JOB_TRAFFIC_DET_PREDS.PREDECESSOR_SEQ_NBR IN (SELECT PREDECESSOR_SEQ_NBR FROM @TABLE_LIST WHERE PREDECESSOR_SEQ_NBR NOT IN (SELECT * FROM @USER_ENTERED))

			INSERT INTO JOB_TRAFFIC_DET_PREDS WITH(ROWLOCK)(JOB_NUMBER, JOB_COMPONENT_NBR, SEQ_NBR, PREDECESSOR_SEQ_NBR)
			SELECT @JOB_NUMBER, @JOB_COMPONENT_NBR, @SEQ_NBR,PREDECESSOR_SEQ_NBR FROM @USER_ENTERED WHERE PREDECESSOR_SEQ_NBR NOT IN (SELECT * FROM @TABLE_LIST)
		END

		IF (SELECT COUNT(1) FROM @RETURN_MESSAGES) = 0
		BEGIN
			INSERT INTO @RETURN_MESSAGES(MESSAGE) VALUES('SUCCESS');
		END

		SELECT * FROM @RETURN_MESSAGES;





