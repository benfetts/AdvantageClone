SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS OFF 
GO
IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[usp_wv_Traffic_Schedule_UpdateTaskAlertsDueDate]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[usp_wv_Traffic_Schedule_UpdateTaskAlertsDueDate]
GO
CREATE PROCEDURE [dbo].[usp_wv_Traffic_Schedule_UpdateTaskAlertsDueDate] /*WITH ENCRYPTION*/
@JOB_NUMBER INT,
@JOB_COMPONENT_NBR SMALLINT,
@SEQ_NBR SMALLINT
AS
/*=========== QUERY ===========*/
DECLARE
	@UPDATE_ALERTS BIT

SELECT @UPDATE_ALERTS = CONVERT(BIT, ISNULL(AGY_SETTINGS_VALUE, AGY_SETTINGS_DEF)) 
FROM AGY_SETTINGS WHERE AGY_SETTINGS_CODE = 'TRF_UPDATE_ALERT_DUE';

SET @UPDATE_ALERTS = ISNULL(@UPDATE_ALERTS, 0);

IF @UPDATE_ALERTS = 1
BEGIN

	IF @SEQ_NBR IS NULL
	BEGIN

		UPDATE ALERT WITH(ROWLOCK) 
		SET 
			ALERT.DUE_DATE = JOB_TRAFFIC_DET.JOB_REVISED_DATE
		FROM 
			ALERT INNER JOIN JOB_TRAFFIC_DET ON 
			ALERT.JOB_NUMBER = JOB_TRAFFIC_DET.JOB_NUMBER 
			AND ALERT.JOB_COMPONENT_NBR = JOB_TRAFFIC_DET.JOB_COMPONENT_NBR
			AND ALERT.TASK_SEQ_NBR = JOB_TRAFFIC_DET.SEQ_NBR
		WHERE 
			ALERT.JOB_NUMBER = @JOB_NUMBER
			AND ALERT.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR
			--AND ALERT.TASK_SEQ_NBR = @SEQ_NBR
			AND ALERT.ALERT_LEVEL = 'PST'
			--AND ALERT.DUE_DATE <>  ISNULL(JOB_TRAFFIC_DET.JOB_REVISED_DATE, JOB_TRAFFIC_DET.JOB_DUE_DATE)
		;
	END
	ELSE
	BEGIN
		UPDATE ALERT WITH(ROWLOCK) 
		SET 
			ALERT.DUE_DATE = JOB_TRAFFIC_DET.JOB_REVISED_DATE
		FROM 
			ALERT INNER JOIN JOB_TRAFFIC_DET ON 
			ALERT.JOB_NUMBER = JOB_TRAFFIC_DET.JOB_NUMBER 
			AND ALERT.JOB_COMPONENT_NBR = JOB_TRAFFIC_DET.JOB_COMPONENT_NBR
			AND ALERT.TASK_SEQ_NBR = JOB_TRAFFIC_DET.SEQ_NBR
		WHERE 
			ALERT.JOB_NUMBER = @JOB_NUMBER
			AND ALERT.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR
			AND ALERT.TASK_SEQ_NBR = @SEQ_NBR
			AND ALERT.ALERT_LEVEL = 'PST'
			--AND ALERT.DUE_DATE <>  ISNULL(JOB_TRAFFIC_DET.JOB_REVISED_DATE, JOB_TRAFFIC_DET.JOB_DUE_DATE)
		;
	END

END
/*=========== QUERY ===========*/
GO
SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO