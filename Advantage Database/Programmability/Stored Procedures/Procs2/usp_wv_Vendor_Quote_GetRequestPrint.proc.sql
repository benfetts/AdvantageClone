

CREATE PROCEDURE [dbo].[usp_wv_Vendor_Quote_GetRequestPrint]
(
	@EstNo Int,
	@EstCompNo Int,
	@VendorQteNo Int,
	@UserID varchar(100),
	@VendorCode varchar(6),
	@Vendors varchar(4000)
)
AS
Declare @Restrictions Int,
		@sql nvarchar(4000),
		@paramlist nvarchar(4000)

Select @Restrictions = Count(*) 
FROM SEC_CLIENT
WHERE UPPER(USER_ID) = UPPER(@UserID)


SELECT @sql = 'SELECT VENDOR_QTE_HDR.ESTIMATE_NUMBER, VENDOR_QTE_HDR.EST_COMPONENT_NBR, 
                      VENDOR_QTE_HDR.VENDOR_QTE_NBR, VENDOR_QTE_DTL.EST_QUOTE_NBR, VENDOR_QTE_DTL.EST_REV_NBR, 
                      ESTIMATE_QUOTE.EST_QUOTE_DESC, VENDOR_QTE_DTL.EST_FNC_CODE, FUNCTIONS.FNC_DESCRIPTION, 
                      VENDOR_QTE_DTL.QTY, VENDOR_QTE_DTL.VN_CODE, VENDOR.VN_NAME, VENDOR_QTE_HDR.VN_QTE_MEMO, 
                      VENDOR_QTE_VEN.VN_NOTES, VENDOR_QTE_VEN.DISPATCH_DATE, VENDOR_QTE_VEN.DUE_DATE, 
                      VENDOR_QTE_FNC.FNC_NOTES, VENDOR_QTE_SPECS.VN_QTE_SPECS, VENDOR_QTE_VEN.VN_CONT_CODE, 
                      VEN_CONT.VC_FNAME, VEN_CONT.VC_LNAME, VEN_CONT.VC_MI, VEN_CONT.VC_ADDRESS1, VEN_CONT.VC_ADDRESS2, 
                      VEN_CONT.VC_CITY, VEN_CONT.VC_STATE, VEN_CONT.VC_ZIP, (VENDOR_QTE_DTL.VN_CODE + ''/'' + Cast(VENDOR_QTE_DTL.EST_QUOTE_NBR AS VARCHAR(3))) AS VNQTE,
					  VENDOR.VN_ADDRESS1, VENDOR.VN_ADDRESS2, VENDOR.VN_CITY, VENDOR.VN_STATE, VENDOR.VN_ZIP
FROM         VENDOR_QTE_HDR INNER JOIN
                      VENDOR_QTE_DTL ON VENDOR_QTE_HDR.ESTIMATE_NUMBER = VENDOR_QTE_DTL.ESTIMATE_NUMBER AND 
                      VENDOR_QTE_HDR.EST_COMPONENT_NBR = VENDOR_QTE_DTL.EST_COMPONENT_NBR AND 
                      VENDOR_QTE_HDR.VENDOR_QTE_NBR = VENDOR_QTE_DTL.VENDOR_QTE_NBR INNER JOIN
                      VENDOR_QTE_VEN ON VENDOR_QTE_DTL.ESTIMATE_NUMBER = VENDOR_QTE_VEN.ESTIMATE_NUMBER AND 
                      VENDOR_QTE_DTL.EST_COMPONENT_NBR = VENDOR_QTE_VEN.EST_COMPONENT_NBR AND 
                      VENDOR_QTE_DTL.VENDOR_QTE_NBR = VENDOR_QTE_VEN.VENDOR_QTE_NBR AND 
                      VENDOR_QTE_DTL.VN_CODE = VENDOR_QTE_VEN.VN_CODE INNER JOIN
                      VENDOR_QTE_FNC ON VENDOR_QTE_DTL.ESTIMATE_NUMBER = VENDOR_QTE_FNC.ESTIMATE_NUMBER AND 
                      VENDOR_QTE_DTL.EST_COMPONENT_NBR = VENDOR_QTE_FNC.EST_COMPONENT_NBR AND 
                      VENDOR_QTE_DTL.VENDOR_QTE_NBR = VENDOR_QTE_FNC.VENDOR_QTE_NBR AND 
                      VENDOR_QTE_DTL.EST_FNC_CODE = VENDOR_QTE_FNC.EST_FNC_CODE INNER JOIN
                      VENDOR_QTE_SPECS ON VENDOR_QTE_DTL.ESTIMATE_NUMBER = VENDOR_QTE_SPECS.ESTIMATE_NUMBER AND 
                      VENDOR_QTE_DTL.EST_COMPONENT_NBR = VENDOR_QTE_SPECS.EST_COMPONENT_NBR AND 
                      VENDOR_QTE_DTL.VENDOR_QTE_NBR = VENDOR_QTE_SPECS.VENDOR_QTE_NBR AND 
                      VENDOR_QTE_DTL.EST_QUOTE_NBR = VENDOR_QTE_SPECS.EST_QUOTE_NBR AND 
                      VENDOR_QTE_DTL.EST_REV_NBR = VENDOR_QTE_SPECS.EST_REV_NBR LEFT OUTER JOIN
                      VEN_CONT ON VENDOR_QTE_VEN.VN_CODE = VEN_CONT.VN_CODE AND 
                      VENDOR_QTE_VEN.VN_CONT_CODE = VEN_CONT.VC_CODE LEFT OUTER JOIN
                      VENDOR ON VENDOR_QTE_DTL.VN_CODE = VENDOR.VN_CODE LEFT OUTER JOIN
                      FUNCTIONS ON VENDOR_QTE_DTL.EST_FNC_CODE = FUNCTIONS.FNC_CODE LEFT OUTER JOIN
                      ESTIMATE_QUOTE ON VENDOR_QTE_DTL.ESTIMATE_NUMBER = ESTIMATE_QUOTE.ESTIMATE_NUMBER AND 
                      VENDOR_QTE_DTL.EST_COMPONENT_NBR = ESTIMATE_QUOTE.EST_COMPONENT_NBR AND 
                      VENDOR_QTE_DTL.EST_QUOTE_NBR = ESTIMATE_QUOTE.EST_QUOTE_NBR
WHERE     (VENDOR_QTE_HDR.ESTIMATE_NUMBER = @EstNo) AND (VENDOR_QTE_HDR.EST_COMPONENT_NBR = @EstCompNo) AND (VENDOR_QTE_HDR.VENDOR_QTE_NBR = @VendorQteNo)'
        if @VendorCode <> ''
			Begin
				SELECT @sql = @sql + ' AND VENDOR_QTE_DTL.VN_CODE = @VendorCode'
			End	
		if @Vendors <> ''
			Begin
				SELECT @sql = @sql + ' AND EXISTS (SELECT * FROM [dbo].[charlist_to_table] (@Vendors,'','') WHERE VENDOR_QTE_DTL.VN_CODE COLLATE DATABASE_DEFAULT = vstr COLLATE DATABASE_DEFAULT)'
			End	
SELECT @sql = @sql + ' ORDER BY VENDOR_QTE_DTL.VN_CODE, VENDOR_QTE_DTL.EST_QUOTE_NBR, VENDOR_QTE_DTL.EST_FNC_CODE'

SELECT @paramlist = '@EstNo Int, @EstCompNo Int, @VendorQteNo Int, @UserID varchar(100), @VendorCode varchar(6), @Vendors varchar(4000)'

EXEC sp_executesql @sql, @paramlist, @EstNo, @EstCompNo, @VendorQteNo, @UserID, @VendorCode, @Vendors


