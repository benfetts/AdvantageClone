

CREATE PROCEDURE [dbo].[usp_wv_Vendor_Quote_GetRequestQuotes]
(
	@EstNo Int,
	@EstCompNo Int,
	@VendorQteNo Int,
	@QuoteNo Int,
	@UserID varchar(100)
)
AS
Declare @Restrictions Int,
		@sql nvarchar(4000),
		@paramlist nvarchar(4000)

Select @Restrictions = Count(*) 
FROM SEC_CLIENT
WHERE UPPER(USER_ID) = UPPER(@UserID)

DECLARE @FncCode as varchar(6), @EstQuote int, @EstRev int, @NumberRecords int, @RowCount int

CREATE TABLE #rfq(
	RowID int IDENTITY(1, 1), 
	ESTIMATE_NUMBER int,
	EST_COMPONENT_NBR smallint,
	VENDOR_QTE_NBR int,
	EST_QUOTE_NBR int,
	EST_REV_NBR int,
	EST_FNC_CODE varchar(6),
	FNC_DESCRIPTION varchar(30))

CREATE TABLE #rfq2(
	RowID int IDENTITY(1, 1), 
	ESTIMATE_NUMBER int,
	EST_COMPONENT_NBR smallint,
	VENDOR_QTE_NBR int,
	EST_QUOTE_NBR int,
	EST_REV_NBR int,
	EST_QUOTE_DESC varchar(60))

CREATE TABLE #rfq3(
	RowID int IDENTITY(1, 1), 
	ESTIMATE_NUMBER int,
	EST_COMPONENT_NBR smallint,
	VENDOR_QTE_NBR int,
	EST_FNC_CODE varchar(6),
	FNC_NOTES text)

CREATE TABLE #rfq4(
	RowID int IDENTITY(1, 1), 
	ESTIMATE_NUMBER int,
	EST_COMPONENT_NBR smallint,
	VENDOR_QTE_NBR int,
	EST_QUOTE_NBR int,
	EST_REV_NBR int,
	VN_QTE_SPECS text)

SELECT @sql = 'INSERT INTO #rfq
SELECT DISTINCT VENDOR_QTE_HDR.ESTIMATE_NUMBER, VENDOR_QTE_HDR.EST_COMPONENT_NBR, VENDOR_QTE_HDR.VENDOR_QTE_NBR, 
                      VENDOR_QTE_SPECS.EST_QUOTE_NBR, VENDOR_QTE_SPECS.EST_REV_NBR, VENDOR_QTE_FNC.EST_FNC_CODE, 
                      FUNCTIONS.FNC_DESCRIPTION 
FROM         VENDOR_QTE_FNC INNER JOIN
                      VENDOR_QTE_HDR ON VENDOR_QTE_FNC.ESTIMATE_NUMBER = VENDOR_QTE_HDR.ESTIMATE_NUMBER AND 
                      VENDOR_QTE_FNC.EST_COMPONENT_NBR = VENDOR_QTE_HDR.EST_COMPONENT_NBR AND 
                      VENDOR_QTE_FNC.VENDOR_QTE_NBR = VENDOR_QTE_HDR.VENDOR_QTE_NBR INNER JOIN
                      VENDOR_QTE_SPECS ON VENDOR_QTE_HDR.ESTIMATE_NUMBER = VENDOR_QTE_SPECS.ESTIMATE_NUMBER AND 
                      VENDOR_QTE_HDR.EST_COMPONENT_NBR = VENDOR_QTE_SPECS.EST_COMPONENT_NBR AND 
                      VENDOR_QTE_HDR.VENDOR_QTE_NBR = VENDOR_QTE_SPECS.VENDOR_QTE_NBR LEFT OUTER JOIN
                      FUNCTIONS ON VENDOR_QTE_FNC.EST_FNC_CODE = FUNCTIONS.FNC_CODE
WHERE     (VENDOR_QTE_HDR.ESTIMATE_NUMBER = @EstNo) AND (VENDOR_QTE_HDR.EST_COMPONENT_NBR = @EstCompNo) AND 
                      (VENDOR_QTE_HDR.VENDOR_QTE_NBR = @VendorQteNo)'
			if @QuoteNo <> 0
				Begin
				   SELECT @sql = @sql + ' AND (VENDOR_QTE_SPECS.EST_QUOTE_NBR = @QuoteNo)'
				End

SELECT @paramlist = '@EstNo Int, @EstCompNo Int, @VendorQteNo Int, @QuoteNo Int, @UserID varchar(100)'
print @sql
EXEC sp_executesql @sql, @paramlist, @EstNo, @EstCompNo, @VendorQteNo, @QuoteNo, @UserID
SET @sql = ''

SELECT @sql = 'INSERT INTO #rfq2
SELECT DISTINCT VENDOR_QTE_HDR.ESTIMATE_NUMBER, VENDOR_QTE_HDR.EST_COMPONENT_NBR, VENDOR_QTE_HDR.VENDOR_QTE_NBR, 
                      VENDOR_QTE_SPECS.EST_QUOTE_NBR, VENDOR_QTE_SPECS.EST_REV_NBR, ESTIMATE_QUOTE.EST_QUOTE_DESC
FROM         VENDOR_QTE_HDR INNER JOIN
                      VENDOR_QTE_SPECS ON VENDOR_QTE_HDR.ESTIMATE_NUMBER = VENDOR_QTE_SPECS.ESTIMATE_NUMBER AND 
                      VENDOR_QTE_HDR.EST_COMPONENT_NBR = VENDOR_QTE_SPECS.EST_COMPONENT_NBR AND 
                      VENDOR_QTE_HDR.VENDOR_QTE_NBR = VENDOR_QTE_SPECS.VENDOR_QTE_NBR INNER JOIN
                      ESTIMATE_QUOTE ON VENDOR_QTE_SPECS.ESTIMATE_NUMBER = ESTIMATE_QUOTE.ESTIMATE_NUMBER AND 
                      VENDOR_QTE_SPECS.EST_COMPONENT_NBR = ESTIMATE_QUOTE.EST_COMPONENT_NBR AND 
                      VENDOR_QTE_SPECS.EST_QUOTE_NBR = ESTIMATE_QUOTE.EST_QUOTE_NBR
WHERE     (VENDOR_QTE_HDR.ESTIMATE_NUMBER = @EstNo) AND (VENDOR_QTE_HDR.EST_COMPONENT_NBR = @EstCompNo) AND 
                      (VENDOR_QTE_HDR.VENDOR_QTE_NBR = @VendorQteNo)'

SELECT @paramlist = '@EstNo Int, @EstCompNo Int, @VendorQteNo Int, @UserID varchar(100)'
print @sql
EXEC sp_executesql @sql, @paramlist, @EstNo, @EstCompNo, @VendorQteNo, @UserID

SELECT @NumberRecords = COUNT(*) FROM #rfq
SET @RowCount = 1

WHILE @RowCount <= @NumberRecords
BEGIN
 SELECT @EstQuote = EST_QUOTE_NBR, @EstRev = EST_REV_NBR, @FncCode = EST_FNC_CODE
 FROM #rfq
 WHERE RowID = @RowCount

INSERT INTO #rfq3
SELECT ESTIMATE_NUMBER, EST_COMPONENT_NBR, VENDOR_QTE_NBR, EST_FNC_CODE, FNC_NOTES 
FROM VENDOR_QTE_FNC WHERE (ESTIMATE_NUMBER = @EstNo) AND (EST_COMPONENT_NBR = @EstCompNo) AND (VENDOR_QTE_NBR = @VendorQteNo) AND (EST_FNC_CODE = @FncCode)

--UPDATE #rfq 
--SET QTY = (SELECT DISTINCT QTY FROM VENDOR_QTE_DTL WHERE (ESTIMATE_NUMBER = @EstNo) AND (EST_COMPONENT_NBR = @EstCompNo) AND (VENDOR_QTE_NBR = @VendorQteNo) AND (EST_QUOTE_NBR = @EstQuote) AND (EST_REV_NBR = @EstRev) AND (EST_FNC_CODE = @FncCode))
--WHERE (ESTIMATE_NUMBER = @EstNo) AND (EST_COMPONENT_NBR = @EstCompNo) AND (VENDOR_QTE_NBR = @VendorQteNo) AND (EST_QUOTE_NBR = @EstQuote) AND (EST_REV_NBR = @EstRev) AND (EST_FNC_CODE = @FncCode)

SET @RowCount = @RowCount + 1
END

SELECT @NumberRecords = COUNT(*) FROM #rfq2
SET @RowCount = 1

WHILE @RowCount <= @NumberRecords
BEGIN
 SELECT @EstQuote = EST_QUOTE_NBR, @EstRev = EST_REV_NBR
 FROM #rfq2
 WHERE RowID = @RowCount

INSERT INTO #rfq4
SELECT ESTIMATE_NUMBER, EST_COMPONENT_NBR, VENDOR_QTE_NBR, EST_QUOTE_NBR, EST_REV_NBR, VN_QTE_SPECS 
FROM VENDOR_QTE_SPECS WHERE (ESTIMATE_NUMBER = @EstNo) AND (EST_COMPONENT_NBR = @EstCompNo) AND (VENDOR_QTE_NBR = @VendorQteNo) AND (EST_QUOTE_NBR = @EstQuote) AND (EST_REV_NBR = @EstRev)

SET @RowCount = @RowCount + 1
END

SELECT #rfq2.ESTIMATE_NUMBER, #rfq2.EST_COMPONENT_NBR, #rfq2.VENDOR_QTE_NBR, #rfq2.EST_QUOTE_NBR, #rfq2.EST_REV_NBR, #rfq2.EST_QUOTE_DESC, #rfq4.VN_QTE_SPECS
FROM #rfq2 INNER JOIN #rfq4 ON #rfq2.ESTIMATE_NUMBER = #rfq4.ESTIMATE_NUMBER AND #rfq2.EST_COMPONENT_NBR = #rfq4.EST_COMPONENT_NBR AND #rfq2.VENDOR_QTE_NBR = #rfq4.VENDOR_QTE_NBR AND 
							   #rfq2.EST_QUOTE_NBR = #rfq4.EST_QUOTE_NBR AND #rfq2.EST_REV_NBR = #rfq4.EST_REV_NBR

SELECT  #rfq.ESTIMATE_NUMBER, #rfq.EST_COMPONENT_NBR, #rfq.VENDOR_QTE_NBR, #rfq.EST_QUOTE_NBR, #rfq.EST_REV_NBR, #rfq.EST_FNC_CODE, #rfq.FNC_DESCRIPTION, #rfq3.FNC_NOTES
FROM #rfq INNER JOIN #rfq3 ON #rfq.ESTIMATE_NUMBER = #rfq3.ESTIMATE_NUMBER AND #rfq.EST_COMPONENT_NBR = #rfq3.EST_COMPONENT_NBR AND #rfq.VENDOR_QTE_NBR = #rfq3.VENDOR_QTE_NBR AND 
							   #rfq.EST_FNC_CODE = #rfq3.EST_FNC_CODE


