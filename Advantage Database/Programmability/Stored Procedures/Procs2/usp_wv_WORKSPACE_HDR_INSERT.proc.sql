CREATE PROCEDURE [dbo].[usp_wv_WORKSPACE_HDR_INSERT]
	@USER_CODE VARCHAR(100)
AS
	DECLARE
		@NEXT_WORKSPACE_NBR AS INT,
		@NEW_WORKSPACE_HDR_ID AS INT
	
		SELECT @NEXT_WORKSPACE_NBR = MAX(WORKSPACE_NUMBER) + 1 FROM WV_WORKSPACE_HDR WITH(NOLOCK) WHERE UPPER(USER_CODE) = UPPER(@USER_CODE);
	
		IF @NEXT_WORKSPACE_NBR IS NULL
		BEGIN
			SET @NEXT_WORKSPACE_NBR = 1
		END
	
		INSERT INTO WV_WORKSPACE_HDR WITH(ROWLOCK)
		(
			USER_CODE,
			WORKSPACE_NUMBER,
			WORKSPACE_TITLE,
			WORKSPACE_DESC,
			IS_LOADED
		)
		VALUES
		(
			@USER_CODE,
			@NEXT_WORKSPACE_NBR,
			'Workspace ' + CONVERT(VARCHAR,@NEXT_WORKSPACE_NBR),
			'Workspace ' + CONVERT(VARCHAR,@NEXT_WORKSPACE_NBR),
			1
		)
		
		SET @NEW_WORKSPACE_HDR_ID = SCOPE_IDENTITY();
	
		IF NOT @NEW_WORKSPACE_HDR_ID IS NULL
		BEGIN
			UPDATE WV_WORKSPACE_HDR WITH(ROWLOCK) SET IS_LOADED = NULL WHERE UPPER(USER_CODE) = UPPER(@USER_CODE) AND WORKSPACE_HDR_ID <> @NEW_WORKSPACE_HDR_ID;
			UPDATE WV_WORKSPACE_HDR WITH(ROWLOCK) SET IS_LOADED = 1 WHERE UPPER(USER_CODE) = UPPER(@USER_CODE) AND WORKSPACE_HDR_ID = @NEW_WORKSPACE_HDR_ID;
		END
	
		SELECT ISNULL(@NEW_WORKSPACE_HDR_ID,0);


/****** Object:  StoredProcedure [dbo].[usp_wv_TIMESHEET_GET]    Script Date: 05/12/2010 09:55:08 ******/
SET ANSI_NULLS ON
