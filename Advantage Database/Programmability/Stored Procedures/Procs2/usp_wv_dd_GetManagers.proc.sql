CREATE PROCEDURE [dbo].[usp_wv_dd_GetManagers] 
@USER_ID VARCHAR(100)
AS
DECLARE 
@MGR_COL VARCHAR(20),
@COLUMN_INDEX VARCHAR(1),
@ASSIGN_COL VARCHAR(20),
@SQL_DISTINCT_MGR VARCHAR(max),
@RESTRICTED SMALLINT

SELECT @RESTRICTED = ISNULL(COUNT(1),0) FROM SEC_EMP WHERE UPPER(USER_ID) = UPPER(@USER_ID)
--SET @RESTRICTED = 1

DECLARE @EMP_CODE AS VARCHAR(6)
DECLARE @OfficeCount AS INTEGER

SELECT @EMP_CODE = EMP_CODE FROM SEC_USER WHERE UPPER(USER_CODE) = UPPER(@USER_ID)

SELECT @OfficeCount = COUNT(*) FROM EMP_OFFICE WHERE EMP_CODE = @EMP_CODE

SELECT @MGR_COL = CAST( AGY_SETTINGS_VALUE AS varchar(20) )
FROM AGY_SETTINGS WHERE AGY_SETTINGS_CODE = 'TRAFFIC_MGR_COL' 

SELECT @COLUMN_INDEX = SUBSTRING(@MGR_COL,9,1)

IF ISNUMERIC(@COLUMN_INDEX) <> 1
    BEGIN
    	--Return no rows:
	    SELECT TOP 0 '' AS code,'' AS description,'' AS  EMP_LNAME, '' AS EMP_FNAME FROM EMPLOYEE WHERE EMP_CODE = 'IMNOBODY'
    END	
ELSE
	BEGIN
        SET @ASSIGN_COL = 'ASSIGN_' + @COLUMN_INDEX
        --SELECT @ASSIGN_COL

        SET @SQL_DISTINCT_MGR = 
        '
        SELECT DISTINCT JOB_TRAFFIC.'+@ASSIGN_COL+', EMPLOYEE.EMP_CODE AS code,
		 EMPLOYEE.EMP_CODE+'' - ''+EMPLOYEE.EMP_LNAME+'', ''+EMPLOYEE.EMP_FNAME AS description,
		 EMPLOYEE.EMP_LNAME,
		 EMPLOYEE.EMP_FNAME,
		 EMPLOYEE.EMP_MI
        FROM         JOB_TRAFFIC INNER JOIN
                      EMPLOYEE ON JOB_TRAFFIC.'+@ASSIGN_COL+' = EMPLOYEE.EMP_CODE'

        IF @RESTRICTED > 0                      
        BEGIN
        SET @SQL_DISTINCT_MGR = @SQL_DISTINCT_MGR +
        ' 
        INNER JOIN
                      [dbo].[advtf_sec_emp] ('''+@USER_ID+''') AS SEC_EMP ON EMPLOYEE.EMP_CODE = SEC_EMP.EMP_CODE
        '
        END
		IF @OfficeCount > 0
		BEGIN
        SET @SQL_DISTINCT_MGR = @SQL_DISTINCT_MGR +
		' 
        INNER JOIN
                      EMP_OFFICE ON EMPLOYEE.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = ''' + @EMP_CODE + '''
        '
		END
        SET @SQL_DISTINCT_MGR = @SQL_DISTINCT_MGR +
        '                      
        WHERE     (NOT (JOB_TRAFFIC.'+@ASSIGN_COL+' IS NULL)) AND (JOB_TRAFFIC.COMPLETED_DATE IS NULL) AND (EMP_TERM_DATE IS NULL OR EMP_TERM_DATE > GETDATE())
        '
        SET @SQL_DISTINCT_MGR = @SQL_DISTINCT_MGR+
        '
        ORDER BY EMPLOYEE.EMP_FNAME, EMPLOYEE.EMP_LNAME
        '
        --PRINT @SQL_DISTINCT_MGR
        EXEC (@SQL_DISTINCT_MGR)
	
	END