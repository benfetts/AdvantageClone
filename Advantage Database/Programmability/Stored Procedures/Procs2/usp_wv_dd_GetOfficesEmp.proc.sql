/****** Object:  StoredProcedure [dbo].[usp_wv_dd_GetOfficesEmp]    Script Date: 4/22/2019 10:21:03 AM ******/
SET ANSI_NULLS OFF
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[usp_wv_dd_GetOfficesEmp] 
				@USER_ID VARCHAR(100),
				@SpringID int = 0
AS

	DECLARE @EMP_CODE AS VARCHAR(6)
	DECLARE @COUNT AS INTEGER

	SELECT @EMP_CODE = EMP_CODE FROM SEC_USER WHERE UPPER(USER_CODE) = UPPER(@USER_ID)

	SELECT @COUNT = COUNT(*) FROM EMP_OFFICE WHERE EMP_CODE = @EMP_CODE

	IF @SpringID = 0
	BEGIN
		IF @COUNT = 0 
			SELECT     OFFICE_CODE AS Code, ISNULL(OFFICE_CODE, '') + ' - ' + ISNULL(OFFICE_NAME, '') AS Description
						,OFFICE_NAME Name
			FROM         OFFICE
			WHERE     (INACTIVE_FLAG IS NULL) OR (INACTIVE_FLAG = 0)
			ORDER BY OFFICE_CODE

		ELSE
			SELECT     OFFICE.OFFICE_CODE AS Code, ISNULL(OFFICE.OFFICE_CODE, '') + ' - ' + ISNULL(OFFICE_NAME, '') AS Description
						,OFFICE_NAME Name
			FROM         OFFICE
			  INNER JOIN EMP_OFFICE ON OFFICE.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE
				AND EMP_OFFICE.EMP_CODE = @EMP_CODE
			WHERE     (INACTIVE_FLAG IS NULL) OR (INACTIVE_FLAG = 0)
			ORDER BY OFFICE.OFFICE_CODE
	END
	ELSE
	BEGIN
		IF @COUNT = 0 
			SELECT DISTINCT OFFICE.OFFICE_CODE AS Code, ISNULL(OFFICE.OFFICE_CODE, '') + ' - ' + ISNULL(OFFICE_NAME, '') AS Description
						,OFFICE_NAME Name
			FROM SPRINT_HDR        
				inner JOIN BOARD on BOARD.ID = SPRINT_HDR.BOARD_ID
				inner join BOARD_JOB on BOARD.ID = BOARD_JOB.BOARD_ID
				inner join JOB_LOG on JOB_LOG.JOB_NUMBER = BOARD_JOB.JOB_NUMBER
				INNER JOIN OFFICE on JOB_LOG.OFFICE_CODE = OFFICE.OFFICE_CODE
				 where ((INACTIVE_FLAG IS NULL) OR (INACTIVE_FLAG = 0)) and SPRINT_HDR.ID = @SpringID
			ORDER BY OFFICE.OFFICE_CODE
		ELSE
			SELECT DISTINCT OFFICE.OFFICE_CODE AS Code, ISNULL(OFFICE.OFFICE_CODE, '') + ' - ' + ISNULL(OFFICE_NAME, '') AS Description
						,OFFICE_NAME Name
			FROM SPRINT_HDR        
				inner JOIN BOARD on BOARD.ID = SPRINT_HDR.BOARD_ID
				inner join BOARD_JOB on BOARD.ID = BOARD_JOB.BOARD_ID
				inner join JOB_LOG on JOB_LOG.JOB_NUMBER = BOARD_JOB.JOB_NUMBER
				INNER JOIN OFFICE on JOB_LOG.OFFICE_CODE = OFFICE.OFFICE_CODE
			    INNER JOIN EMP_OFFICE ON OFFICE.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = @EMP_CODE
				 where ((INACTIVE_FLAG IS NULL) OR (INACTIVE_FLAG = 0)) and SPRINT_HDR.ID = @SpringID
			ORDER BY OFFICE.OFFICE_CODE
	END


GO


