if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_wv_dto_inoutboard]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_wv_dto_inoutboard]
GO

CREATE PROCEDURE [dbo].[usp_wv_dto_inoutboard] 
@EMP_CODE VARCHAR(6),
@USER_ID VARCHAR(100),
@OFFSET [DECIMAL](9,3)
AS
	
	DECLARE @EmployeeCode VARCHAR(6)

	SELECT @EmployeeCode = EMP_CODE FROM dbo.SEC_USER WHERE UPPER(USER_CODE) = UPPER(@USER_ID)	

	DECLARE @RestrictionsOffice AS INTEGER
	SELECT @RestrictionsOffice = COUNT(*) FROM EMP_OFFICE WHERE EMP_CODE = @EmployeeCode

	If @RestrictionsOffice > 0
	Begin
		SELECT 
			E.INOUT_STAT, 
			EMP_LNAME + ', ' + EMP_FNAME + ISNULL(' '+EMP_MI+'.','') + ' (' + E.EMP_CODE + ')' AS EMP_CODE, 
			[dbo].[advfn_local_date](@OFFSET, E.INOUT_TIME) AS INOUT_TIME,
			ISNULL(E.COMMENT,'') AS COMMENT,
			ISNULL(D.DP_TM_DESC,'Other') AS DEPT, 
			E.EMP_CODE AS EMP, 
			[dbo].[advfn_local_date](@OFFSET, E.INOUT_TIME) AS TIME_INOUT, 
			E.EXP_RETURN_TIME, 
			ISNULL(O.OFFICE_NAME, 'Other') AS OFFICE, E.INOUT_REF
		FROM 
			EMP_INOUTBOARD E, EMPLOYEE EMP LEFT OUTER JOIN DEPT_TEAM D ON EMP.DP_TM_CODE = D.DP_TM_CODE 
			LEFT OUTER JOIN OFFICE O ON EMP.OFFICE_CODE = O.OFFICE_CODE INNER JOIN 
			EMP_OFFICE ON EMP.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = @EmployeeCode
		WHERE 
			E.EMP_CODE = EMP.EMP_CODE AND EMP.EMP_TERM_DATE IS NULL
			AND E.INOUT_REF = (SELECT MAX(INOUT_REF) FROM EMP_INOUTBOARD E2 WHERE E.EMP_CODE = E2.EMP_CODE )

		UNION 

		SELECT 
			0 AS INOUT_STAT, 
			EMP_LNAME + ', ' + EMP_FNAME + ISNULL(' '+EMP_MI+'.','') + ' (' + E.EMP_CODE + ')' AS EMP_CODE, 
			NULL AS INOUT_TIME, 
			'' AS COMMENT, 
			ISNULL(D.DP_TM_DESC,'Other') AS DEPT, 
			E.EMP_CODE AS EMP, 
			NULL AS TIME_INOUT, 
			NULL AS EXP_RETURN_TIME, 
			ISNULL(O.OFFICE_NAME, 'Other') AS OFFICE, -1 AS INOUT_REF
		FROM 
			EMPLOYEE E LEFT OUTER JOIN DEPT_TEAM D ON E.DP_TM_CODE = D.DP_TM_CODE 
			LEFT OUTER JOIN OFFICE O ON E.OFFICE_CODE = O.OFFICE_CODE INNER JOIN 
			EMP_OFFICE ON E.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = @EmployeeCode
		WHERE 
			E.EMP_CODE NOT IN (SELECT EMP_CODE FROM EMP_INOUTBOARD) 
			AND E.EMP_TERM_DATE IS NULL  
		ORDER BY 
			E.INOUT_STAT DESC  
	End
	Else
	Begin
		SELECT 
			E.INOUT_STAT, 
			EMP_LNAME + ', ' + EMP_FNAME + ISNULL(' '+EMP_MI+'.','') + ' (' + E.EMP_CODE + ')' AS EMP_CODE, 
			[dbo].[advfn_local_date](@OFFSET, E.INOUT_TIME) AS INOUT_TIME,
			ISNULL(E.COMMENT,'') AS COMMENT,
			ISNULL(D.DP_TM_DESC,'Other') AS DEPT, 
			E.EMP_CODE AS EMP, 
			[dbo].[advfn_local_date](@OFFSET, E.INOUT_TIME) AS TIME_INOUT, 
			E.EXP_RETURN_TIME, 
			ISNULL(O.OFFICE_NAME, 'Other') AS OFFICE, E.INOUT_REF
		FROM 
			EMP_INOUTBOARD E, EMPLOYEE EMP LEFT OUTER JOIN DEPT_TEAM D ON EMP.DP_TM_CODE = D.DP_TM_CODE 
			LEFT OUTER JOIN OFFICE O ON EMP.OFFICE_CODE = O.OFFICE_CODE 
		WHERE 
			E.EMP_CODE = EMP.EMP_CODE AND EMP.EMP_TERM_DATE IS NULL
			AND E.INOUT_REF = (SELECT MAX(INOUT_REF) FROM EMP_INOUTBOARD E2 WHERE E.EMP_CODE = E2.EMP_CODE )

		UNION 

		SELECT 
			0 AS INOUT_STAT, 
			EMP_LNAME + ', ' + EMP_FNAME + ISNULL(' '+EMP_MI+'.','') + ' (' + E.EMP_CODE + ')' AS EMP_CODE, 
			NULL AS INOUT_TIME, 
			'' AS COMMENT, 
			ISNULL(D.DP_TM_DESC,'Other') AS DEPT, 
			E.EMP_CODE AS EMP, 
			NULL AS TIME_INOUT, 
			NULL AS EXP_RETURN_TIME, 
			ISNULL(O.OFFICE_NAME, 'Other') AS OFFICE, -1 AS INOUT_REF
		FROM 
			EMPLOYEE E LEFT OUTER JOIN DEPT_TEAM D ON E.DP_TM_CODE = D.DP_TM_CODE 
			LEFT OUTER JOIN OFFICE O ON E.OFFICE_CODE = O.OFFICE_CODE 
		WHERE 
			E.EMP_CODE NOT IN (SELECT EMP_CODE FROM EMP_INOUTBOARD) 
			AND E.EMP_TERM_DATE IS NULL  
		ORDER BY 
			E.INOUT_STAT DESC  
	End	