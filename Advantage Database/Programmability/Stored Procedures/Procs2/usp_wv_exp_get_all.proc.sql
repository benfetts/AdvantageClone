

















CREATE PROCEDURE [dbo].[usp_wv_exp_get_all] 
@EmpCode Varchar(6),
@StartingDate datetime,
@EndingDate datetime
AS

--------------------------------------------------------------------------
-- CTB: Made sure that if the STATUS field is NULL it gets returned as a 0
--------------------------------------------------------------------------
Select  EXPENSE_HEADER.[INV_NBR],
	EXPENSE_HEADER.[EMP_CODE],
	EXPENSE_HEADER.[VN_CODE],
	EXPENSE_HEADER.[INV_DATE],
	EXPENSE_HEADER.[EXP_DESC],
	EXPENSE_HEADER.[DTL_DESC],
	EXPENSE_HEADER.[DATE_FROM],
	EXPENSE_HEADER.[DATE_TO],
	EXPENSE_HEADER.[INV_AMOUNT],
	EXPENSE_HEADER.[APPROVED_BY],
	EXPENSE_HEADER.[APPROVED_DATE],
	ISNULL(EXPENSE_HEADER.[STATUS],0) as STATUS,
	EXPENSE_DETAIL.[EXPDETAILID],
	EXPENSE_DETAIL.[INV_NBR],
	EXPENSE_DETAIL.[LINE_NBR],
	EXPENSE_DETAIL.[ITEM_DATE],
	EXPENSE_DETAIL.[ITEM_DESC],
	EXPENSE_DETAIL.[CC_FLAG],
	EXPENSE_DETAIL.[CL_CODE],
	EXPENSE_DETAIL.[DIV_CODE],
	EXPENSE_DETAIL.[PRD_CODE],
	EXPENSE_DETAIL.[JOB_NBR],
	EXPENSE_DETAIL.[JOB_COMP_NBR],
	EXPENSE_DETAIL.[FNC_CODE],
	EXPENSE_DETAIL.[QTY],
	EXPENSE_DETAIL.[RATE],
	EXPENSE_DETAIL.[CC_AMT],
	EXPENSE_DETAIL.[AMOUNT],
	EXPENSE_DETAIL.[AP_COMMENT],
	EXPENSE_DETAIL.[CREATE_USER_ID],
	EXPENSE_DETAIL.[MOD_USER_ID],
	EXPENSE_DETAIL.[MOD_DATE], 
	EMPLOYEE.EMP_FNAME + ' ' + EMPLOYEE.EMP_LNAME as EMPNAME,
	ISNULL(EXPENSE_HEADER.[SUBMITTED_FLAG],0) as SUBMITTED_FLAG,
	ISNULL(EXPENSE_HEADER.[APPROVED_FLAG],0) as APPROVED_FLAG,
	dbo.udf_get_expense_totals(EXPENSE_HEADER.[INV_NBR], 'TOTAL') AS TOTAL_EXPENSES,
	dbo.udf_get_expense_totals(EXPENSE_HEADER.[INV_NBR], 'DUE') AS TOTAL_DUE
from EXPENSE_HEADER
	Left Outer Join EXPENSE_DETAIL On EXPENSE_HEADER.INV_NBR = EXPENSE_DETAIL.INV_NBR
		And (EXPENSE_DETAIL.LINE_NBR > 0 Or EXPENSE_DETAIL.LINE_NBR is NULL)
	Inner Join EMPLOYEE On EXPENSE_HEADER.EMP_CODE = EMPLOYEE.EMP_CODE
where EXPENSE_HEADER.EMP_CODE = @EmpCode
and INV_DATE >= @StartingDate
and INV_DATE <= @EndingDate

Order by EXPENSE_HEADER.INV_NBR, EXPENSE_DETAIL.LINE_NBR



















