SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS OFF 
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_wv_get_agency_goals]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_wv_get_agency_goals]
GO


CREATE PROCEDURE [dbo].[usp_wv_get_agency_goals] 
@startPP	varchar(6),
@endPP	varchar(6),
@Office varchar(4),
@USER_ID VARCHAR(100)
AS

Set NoCount On

DECLARE @sql varchar(4000)
DECLARE @sql_where as varchar(2000)
DECLARE @BILLING FLOAT
DECLARE @COS FLOAT
DECLARE @GI FLOAT
DECLARE @OP_EXP FLOAT
DECLARE @PAYROLL FLOAT
DECLARE @OVERHEAD FLOAT
DECLARE @OVERHEAD_CREDIT FLOAT
DECLARE @NET_PROFIT FLOAT
DECLARE @PCT VARCHAR(6)
DECLARE @PER DECIMAL(6,3)
DECLARE @TOTAL FLOAT
DECLARE @ACTUAL_PCT FLOAT
DECLARE @EMP_CODE AS VARCHAR(6)
DECLARE @COUNT AS INTEGER

SELECT @EMP_CODE = EMP_CODE FROM SEC_USER WHERE UPPER(USER_CODE) = UPPER(@USER_ID)
SELECT @COUNT = COUNT(*) FROM EMP_OFFICE WHERE EMP_CODE = @EMP_CODE

CREATE TABLE #AGENCY_GOALS (
DESCR VARCHAR(20),
AMT FLOAT,
GOAL_PCT DECIMAL(20,3),
TOTAL_AMT FLOAT,
ACTUAL_PCT DECIMAL(20,3)
)

CREATE TABLE #TMP (VALUE FLOAT)

	
set @sql =  'INSERT INTO #TMP
SELECT  Sum(Case When GLABALTYPE=0 Then (GLSCREDIT + GLSDEBIT) * -1 Else (GLSCREDIT + GLSDEBIT) End) AS ASSETS
FROM GLSUMMARY 
  INNER JOIN GLACCOUNT ON GLSUMMARY.GLSCODE = GLACCOUNT.GLACODE 
  LEFT OUTER JOIN GLOXREF ON GLACCOUNT.GLAOFFICE = GLOXREF.GLOXGLOFFICE 
  LEFT OUTER JOIN OFFICE ON GLOXREF.GLOXOFFICE = OFFICE.OFFICE_CODE
  LEFT OUTER JOIN POSTPERIOD ON POSTPERIOD.PPPERIOD = GLSUMMARY.GLSPP '

set @sql_where = ' WHERE GLSUMMARY.GLSPP Between  ''' + @startPP + ''' AND ''' + @endPP + '''
  AND GLACCOUNT.GLATYPE = ''8'' AND POSTPERIOD.PPGLMONTH <> 99 '
  
If @Office <> ''
	set @sql_where = @sql_where + ' AND OFFICE.OFFICE_CODE = ''' + @Office + ''''
	
Else
	IF @COUNT > 0 
		set @sql = @sql + ' INNER JOIN EMP_OFFICE ON OFFICE.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE
						AND EMP_OFFICE.EMP_CODE = ''' + @EMP_CODE + ''''

set @sql = @sql + @sql_where

EXEC ( @sql )

SELECT @BILLING = ISNULL(VALUE,0) FROM #TMP


DELETE #TMP
set @sql =  'INSERT INTO #TMP
SELECT  Sum((GLSCREDIT + GLSDEBIT))
FROM GLSUMMARY 
  INNER JOIN GLACCOUNT ON GLSUMMARY.GLSCODE = GLACCOUNT.GLACODE 
  LEFT OUTER JOIN GLOXREF ON GLACCOUNT.GLAOFFICE = GLOXREF.GLOXGLOFFICE 
  LEFT OUTER JOIN OFFICE ON GLOXREF.GLOXOFFICE = OFFICE.OFFICE_CODE
  LEFT OUTER JOIN POSTPERIOD ON POSTPERIOD.PPPERIOD = GLSUMMARY.GLSPP '
  
set @sql_where = ' WHERE GLSUMMARY.GLSPP Between  ''' + @startPP + ''' AND ''' + @endPP + '''
  AND GLACCOUNT.GLATYPE = ''13'' AND POSTPERIOD.PPGLMONTH <> 99 '
  
If @Office <> ''
	set @sql_where = @sql_where + ' AND OFFICE.OFFICE_CODE = ''' + @Office + ''''
	
Else
	IF @COUNT > 0 
		set @sql = @sql + ' INNER JOIN EMP_OFFICE ON OFFICE.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE
						AND EMP_OFFICE.EMP_CODE = ''' + @EMP_CODE + ''''
						
set @sql = @sql + @sql_where

EXEC ( @sql )

SELECT @COS = ISNULL(VALUE,0) FROM #TMP

DELETE #TMP

SET @GI = @BILLING - @COS

set @sql =  'INSERT INTO #TMP
SELECT  Sum((GLSCREDIT + GLSDEBIT))
FROM GLSUMMARY 
  INNER JOIN GLACCOUNT ON GLSUMMARY.GLSCODE = GLACCOUNT.GLACODE 
  LEFT OUTER JOIN GLOXREF ON GLACCOUNT.GLAOFFICE = GLOXREF.GLOXGLOFFICE 
  LEFT OUTER JOIN OFFICE ON GLOXREF.GLOXOFFICE = OFFICE.OFFICE_CODE
  LEFT OUTER JOIN POSTPERIOD ON POSTPERIOD.PPPERIOD = GLSUMMARY.GLSPP '

set @sql_where = ' WHERE GLSUMMARY.GLSPP Between  ''' + @startPP + ''' AND ''' + @endPP + '''
  AND GLACCOUNT.GLATYPE IN (''14'',''9'',''15'') AND POSTPERIOD.PPGLMONTH <> 99 '
  
If @Office <> ''
	set @sql_where = @sql_where + ' AND OFFICE.OFFICE_CODE = ''' + @Office + ''''

Else
	IF @COUNT > 0 
		set @sql = @sql + ' INNER JOIN EMP_OFFICE ON OFFICE.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE
						AND EMP_OFFICE.EMP_CODE = ''' + @EMP_CODE + ''''
						
set @sql = @sql + @sql_where

EXEC ( @sql )

SELECT @OP_EXP = ISNULL(VALUE,0) FROM #TMP

DELETE #TMP


set @sql =  'INSERT INTO #TMP
SELECT  Sum((GLSCREDIT + GLSDEBIT))
FROM GLSUMMARY 
  INNER JOIN GLACCOUNT ON GLSUMMARY.GLSCODE = GLACCOUNT.GLACODE 
  LEFT OUTER JOIN GLOXREF ON GLACCOUNT.GLAOFFICE = GLOXREF.GLOXGLOFFICE 
  LEFT OUTER JOIN OFFICE ON GLOXREF.GLOXOFFICE = OFFICE.OFFICE_CODE
  LEFT OUTER JOIN POSTPERIOD ON POSTPERIOD.PPPERIOD = GLSUMMARY.GLSPP '

set @sql_where = ' WHERE GLSUMMARY.GLSPP Between  ''' + @startPP + ''' AND ''' + @endPP + '''
  AND GLACCOUNT.GLATYPE = ''14''
  AND GLACCOUNT.GLAPAYROLL = 1 AND POSTPERIOD.PPGLMONTH <> 99 '
  
If @Office <> ''
	set @sql_where = @sql_where + ' AND OFFICE.OFFICE_CODE = ''' + @Office + ''''

Else
	IF @COUNT > 0 
		set @sql = @sql + ' INNER JOIN EMP_OFFICE ON OFFICE.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE
						AND EMP_OFFICE.EMP_CODE = ''' + @EMP_CODE + ''''
						
set @sql = @sql + @sql_where

EXEC ( @sql )

SELECT @PAYROLL = ISNULL(VALUE,0) FROM #TMP

DELETE #TMP



--set @sql =  'INSERT INTO #TMP
--SELECT  Sum((GLSCREDIT + GLSDEBIT))
--FROM GLSUMMARY 
--  INNER JOIN GLACCOUNT ON GLSUMMARY.GLSCODE = GLACCOUNT.GLACODE 
--  LEFT OUTER JOIN GLOXREF ON GLACCOUNT.GLAOFFICE = GLOXREF.GLOXGLOFFICE 
--  LEFT OUTER JOIN OFFICE ON GLOXREF.GLOXOFFICE = OFFICE.OFFICE_CODE '
  
--set @sql_where = ' WHERE GLSUMMARY.GLSPP Between  ''' + @startPP + ''' AND ''' + @endPP + '''
--  AND GLACCOUNT.GLATYPE IN (''14'')
--  AND ( GLACCOUNT.GLAPAYROLL = 0 OR GLACCOUNT.GLAPAYROLL IS NULL ) '
  
--If @Office <> ''
--	set @sql_where = @sql_where + ' AND OFFICE.OFFICE_CODE = ''' + @Office + ''''

--Else
--	IF @COUNT > 0 
--		set @sql = @sql + ' INNER JOIN EMP_OFFICE ON OFFICE.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE
--						AND EMP_OFFICE.EMP_CODE = ''' + @EMP_CODE + ''''
						
--set @sql = @sql + @sql_where

--EXEC ( @sql )
--SELECT @OP_EXP,@PAYROLL
SELECT @OVERHEAD =  ISNULL(@OP_EXP,0) - ISNULL(@PAYROLL,0)
--SELECT @OVERHEAD

--DELETE #TMP

set @sql =  'INSERT INTO #TMP
SELECT  Sum((GLSCREDIT + GLSDEBIT))
FROM GLSUMMARY 
  INNER JOIN GLACCOUNT ON GLSUMMARY.GLSCODE = GLACCOUNT.GLACODE 
  LEFT OUTER JOIN GLOXREF ON GLACCOUNT.GLAOFFICE = GLOXREF.GLOXGLOFFICE 
  LEFT OUTER JOIN OFFICE ON GLOXREF.GLOXOFFICE = OFFICE.OFFICE_CODE
  LEFT OUTER JOIN POSTPERIOD ON POSTPERIOD.PPPERIOD = GLSUMMARY.GLSPP '
  
set @sql_where = ' WHERE GLSUMMARY.GLSPP Between  ''' + @startPP + ''' AND ''' + @endPP + '''
  AND GLACCOUNT.GLATYPE IN (''9'',''15'')
  AND ( GLACCOUNT.GLAPAYROLL = 0 OR GLACCOUNT.GLAPAYROLL IS NULL ) AND POSTPERIOD.PPGLMONTH <> 99 '
  
If @Office <> ''
	set @sql_where = @sql_where + ' AND OFFICE.OFFICE_CODE = ''' + @Office + ''''

Else
	IF @COUNT > 0 
		set @sql = @sql + ' INNER JOIN EMP_OFFICE ON OFFICE.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE
						AND EMP_OFFICE.EMP_CODE = ''' + @EMP_CODE + ''''
						
set @sql = @sql + @sql_where
PRINT ( @sql )
EXEC ( @sql )

SELECT @OVERHEAD_CREDIT = ISNULL(VALUE,0) FROM #TMP

DELETE #TMP
--SELECT @OVERHEAD_CREDIT

SET @NET_PROFIT = @GI - @OP_EXP


--*************************************************

SET @TOTAL = @BILLING
INSERT INTO #AGENCY_GOALS VALUES('Billing', @BILLING, 100, @TOTAL, 100)


SELECT @PCT =  CONVERT(VARCHAR(6), ISNULL(AGY_SETTINGS_VALUE,0)) FROM AGY_SETTINGS 
WHERE AGY_SETTINGS_CODE = 'GROSS_INC_PCT_BILL'

SET @PER = CAST(@PCT AS DECIMAL(6,3))

SET @TOTAL = @BILLING * (@PER * .01)

IF @BILLING = 0
	SET @ACTUAL_PCT = 0
ELSE	
	SET @ACTUAL_PCT = (@GI / @BILLING) * 100

INSERT INTO #AGENCY_GOALS VALUES('Gross Income', @GI, @PER, @TOTAL, @ACTUAL_PCT)



SELECT @PCT =  CONVERT(VARCHAR(6), ISNULL(AGY_SETTINGS_VALUE,0)) FROM AGY_SETTINGS 
WHERE AGY_SETTINGS_CODE = 'OPER_EXP_PCT_INC'

SET @PER = CAST(@PCT AS DECIMAL(6,3))

SET @TOTAL = @GI * (@PER * .01)

IF @GI = 0
	SET @ACTUAL_PCT = 0
ELSE
	SET @ACTUAL_PCT = (@OP_EXP / @GI) * 100

INSERT INTO #AGENCY_GOALS VALUES('Operating Expense', @OP_EXP, @PER, @TOTAL, @ACTUAL_PCT)



SELECT @PCT =  CONVERT(VARCHAR(6), ISNULL(AGY_SETTINGS_VALUE,0)) FROM AGY_SETTINGS 
WHERE AGY_SETTINGS_CODE = 'PAYROLL_PCT_INC'

SET @PER = CAST(@PCT AS DECIMAL(6,3))

SET @TOTAL = @GI * (@PER * .01)

IF @GI = 0
	SET @ACTUAL_PCT = 0
ELSE
	SET @ACTUAL_PCT = (@PAYROLL / @GI)  * 100

INSERT INTO #AGENCY_GOALS VALUES('Payroll', @PAYROLL, @PER, @TOTAL, @ACTUAL_PCT)



SELECT @PCT =  CONVERT(VARCHAR(6), ISNULL(AGY_SETTINGS_VALUE,0)) FROM AGY_SETTINGS 
WHERE AGY_SETTINGS_CODE = 'OVERHEAD_PCT_INC'

SET @PER = CAST(@PCT AS DECIMAL(6,3))

SET @TOTAL = @GI  * (@PER * .01)

IF @GI = 0
	SET @ACTUAL_PCT = 0
ELSE
	SET @ACTUAL_PCT = ((@OVERHEAD) / @GI)  * 100

INSERT INTO #AGENCY_GOALS VALUES('Overhead', (@OVERHEAD), @PER, @TOTAL, @ACTUAL_PCT)



SELECT @PCT =  CONVERT(VARCHAR(6), ISNULL(AGY_SETTINGS_VALUE,0)) FROM AGY_SETTINGS 
WHERE AGY_SETTINGS_CODE = 'NET_PROFIT_PCT_GP'

SET @PER = CAST(@PCT AS DECIMAL(6,3))

SET @TOTAL = @GI * (@PER * .01)

IF @GI = 0
	SET @ACTUAL_PCT = 0
ELSE
	SET @ACTUAL_PCT = (@NET_PROFIT / @GI)  * 100

INSERT INTO #AGENCY_GOALS VALUES('Net Profit', @NET_PROFIT, @PER, @TOTAL, @ACTUAL_PCT)


select * from #AGENCY_GOALS

GO
SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



