SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS OFF 
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[usp_wv_get_denied_time_employee]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[usp_wv_get_denied_time_employee]
GO

CREATE PROCEDURE [dbo].[usp_wv_get_denied_time_employee] 
@UserID			VARCHAR(100)

AS

--DECLARE @WK_TIME AS INT
DECLARE @EMP_CODE AS VARCHAR(6)

SELECT @EMP_CODE = EMP_CODE FROM SEC_USER WHERE UPPER(USER_CODE) = UPPER(@UserID)

--SELECT @WK_TIME = ISNULL(WEEKLY_TIME,2) FROM EMPLOYEE WHERE EMP_CODE = @EMP_CODE

SELECT     EMP_TIME.ET_ID, DATENAME(WEEKDAY,EMP_TIME.EMP_DATE) AS [DAYOFWEEK], EMP_TIME.EMP_DATE, EMP_TIME.EMP_DTL_HRS, 
                     DATEADD(wk, DATEDIFF(wk, 6, EMP_TIME.EMP_DATE), 6) AS WEEKOFDATE, '' AS SPACER
FROM         EMP_TIME
WHERE EMP_CODE = @EMP_CODE AND APPR_PENDING = 2
  AND EXISTS ( SELECT * FROM AGENCY WHERE TIME_APPR_ACTIVE = 1 )

SELECT     COUNT(*) AS DENIED
FROM         EMP_TIME
WHERE EMP_CODE = @EMP_CODE AND APPR_PENDING = 2
  AND EXISTS ( SELECT * FROM AGENCY WHERE TIME_APPR_ACTIVE = 1 )

--IF @WK_TIME = 2
--	SELECT @WK_TIME = ISNULL(WEEKLY_TIME,0) FROM AGENCY

--IF @WK_TIME = 0	--Daily
--	SELECT WORKDATE, DAYOFWEEK, WEEKOFDATE, STANDARD_HRS, HOURS_WORKED, VARIANCE, '' AS SPACER
--	FROM MISSING_TIME_DTL
--	WHERE EMP_CODE = @EMP_CODE 
--	AND STANDARD_HRS > HOURS_WORKED
--	ORDER BY WORKDATE

--IF @WK_TIME = 1	--Weekly 
--  BEGIN 

--	SELECT WEEKOFDATE, SUM(STANDARD_HRS) AS STANDARD_HRS, SUM(HOURS_WORKED) AS HOURS_WORKED
--	INTO #TMP2
--	FROM MISSING_TIME_DTL
--	WHERE EMP_CODE = @EMP_CODE
--	GROUP BY  WEEKOFDATE
--	HAVING SUM(STANDARD_HRS) > SUM(HOURS_WORKED)

--	SELECT MTD.WORKDATE, MTD.DAYOFWEEK, MTD.WEEKOFDATE, MTD.STANDARD_HRS, MTD.HOURS_WORKED, MTD.VARIANCE, '' AS SPACER
--	FROM MISSING_TIME_DTL MTD
--	   INNER JOIN #TMP2 ON #TMP2.WEEKOFDATE = MTD.WEEKOFDATE
--	WHERE MTD.EMP_CODE = @EMP_CODE 
--	ORDER BY MTD.WORKDATE
--  END




GO
SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO