CREATE PROCEDURE [dbo].[usp_wv_get_emp_np_time] 
	@user_id	varchar(100),
	@emp_code 	varchar(6),
	@start_date	smalldatetime,
	@end_date	smalldatetime
AS

SET NOCOUNT ON
DECLARE @VFROMDT AS SMALLDATETIME
DECLARE @VTODT AS SMALLDATETIME
DECLARE @SFROMDT AS SMALLDATETIME
DECLARE @STODT AS SMALLDATETIME
DECLARE @PFROMDT AS SMALLDATETIME
DECLARE @PTODT AS SMALLDATETIME
DECLARE @HOURS_AVAILABLE DECIMAL(9,2)
DECLARE @HOURS_USED DECIMAL(8,2)
DECLARE @TYPE_DESC varchar(15)

/*
 Vacation Time
*/

SELECT @VFROMDT = VAC_FROM_DATE FROM EMPLOYEE WHERE EMP_CODE = @emp_code
SELECT @VTODT = VAC_TO_DATE FROM EMPLOYEE WHERE EMP_CODE = @emp_code

SELECT 
	@HOURS_USED = ISNULL(SUM(ETN.EMP_HOURS),0)
FROM 
	EMP_TIME ET, EMP_TIME_NP ETN, TIME_CATEGORY TC
WHERE  
	ET.ET_ID = ETN.ET_ID AND 
	ETN.CATEGORY = TC.CATEGORY AND 
	TC.VAC_SICK_FLAG = 1 AND 
	ET.EMP_CODE = @emp_code AND 
	ET.EMP_DATE BETWEEN @VFROMDT AND @VTODT

SELECT
	@HOURS_AVAILABLE = VAC_HRS
FROM
	dbo.EMPLOYEE
WHERE 
	EMP_CODE = @emp_code

IF ISNULL(@HOURS_USED, 0) <> 0 OR ISNULL(@HOURS_AVAILABLE, 0) <> 0 
BEGIN

	SELECT
		@TYPE_DESC = TYPE_DESC
	FROM
		dbo.TIME_CATEGORY_TYPE
	WHERE 
		[TYPE_ID] = 1

	INSERT INTO ##EMP_STUFF 
	SELECT EMP_CODE, dbo.udf_get_empl_name(EMP_CODE, 'FML'), 1, @TYPE_DESC, CONVERT(VARCHAR(15), VAC_FROM_DATE, 1) + ' - ' + CONVERT(VARCHAR(15), VAC_TO_DATE, 1), VAC_HRS, @HOURS_USED, 0, ''
	FROM EMPLOYEE WHERE EMP_CODE = @emp_code

END


/*
 Sick Time
*/

SELECT @SFROMDT = SICK_FROM_DATE FROM EMPLOYEE WHERE EMP_CODE = @emp_code
SELECT @STODT = SICK_TO_DATE FROM EMPLOYEE WHERE EMP_CODE = @emp_code

SELECT 
	@HOURS_USED = ISNULL(SUM(ETN.EMP_HOURS),0)
FROM 
	EMP_TIME ET, EMP_TIME_NP ETN, TIME_CATEGORY TC
WHERE  
	ET.ET_ID = ETN.ET_ID AND 
	ETN.CATEGORY = TC.CATEGORY AND 
	TC.VAC_SICK_FLAG = 2 AND
	ET.EMP_CODE = @emp_code AND 
	ET.EMP_DATE BETWEEN @SFROMDT AND @STODT

SELECT
	@HOURS_AVAILABLE = SICK_HRS
FROM
	dbo.EMPLOYEE
WHERE 
	EMP_CODE = @emp_code

IF ISNULL(@HOURS_USED, 0) <> 0 OR ISNULL(@HOURS_AVAILABLE, 0) <> 0 
BEGIN
	
	SELECT
		@TYPE_DESC = TYPE_DESC
	FROM
		dbo.TIME_CATEGORY_TYPE
	WHERE 
		[TYPE_ID] = 2

	INSERT INTO ##EMP_STUFF 
	SELECT EMP_CODE, dbo.udf_get_empl_name(EMP_CODE, 'FML'), 2, @TYPE_DESC, CONVERT(VARCHAR(15), SICK_FROM_DATE, 1) + ' - ' + CONVERT(VARCHAR(15), SICK_TO_DATE, 1), SICK_HRS, @HOURS_USED, 0, ''
	FROM EMPLOYEE WHERE EMP_CODE = @emp_code

END
 
/*
 Personal Time
*/

SELECT @PFROMDT = PERS_FROM_DATE FROM EMPLOYEE WHERE EMP_CODE = @emp_code
SELECT @PTODT = PERS_TO_DATE FROM EMPLOYEE WHERE EMP_CODE = @emp_code

SELECT 
	@HOURS_USED = ISNULL(SUM(ETN.EMP_HOURS),0)
FROM 
	EMP_TIME ET, EMP_TIME_NP ETN, TIME_CATEGORY TC
WHERE  
	ET.ET_ID = ETN.ET_ID AND 
	ETN.CATEGORY = TC.CATEGORY AND 
	TC.VAC_SICK_FLAG = 3 AND 
	ET.EMP_CODE = @emp_code AND 
	ET.EMP_DATE BETWEEN @PFROMDT AND @PTODT

SELECT
	@HOURS_AVAILABLE = PERS_HRS
FROM
	dbo.EMPLOYEE
WHERE 
	EMP_CODE = @emp_code

IF ISNULL(@HOURS_USED, 0) <> 0 OR ISNULL(@HOURS_AVAILABLE, 0) <> 0 
BEGIN

	SELECT
		@TYPE_DESC = TYPE_DESC
	FROM
		dbo.TIME_CATEGORY_TYPE
	WHERE 
		[TYPE_ID] = 3

	INSERT INTO ##EMP_STUFF 
	SELECT EMP_CODE, dbo.udf_get_empl_name(EMP_CODE, 'FML'), 3, @TYPE_DESC, CONVERT(VARCHAR(15), PERS_FROM_DATE, 1) + ' - ' + CONVERT(VARCHAR(15), PERS_TO_DATE, 1), PERS_HRS, @HOURS_USED, 0, ''
	FROM EMPLOYEE WHERE EMP_CODE = @emp_code

END


/*
 All other time
*/

INSERT INTO ##EMP_STUFF 
SELECT ET.EMP_CODE, dbo.udf_get_empl_name(ET.EMP_CODE, 'FML'), TCT.TYPE_ID, TCT.TYPE_DESC, '' AS DATES, NULL AS HOURS_AVAIL, SUM(ETN.EMP_HOURS) AS HOURS_USED, NULL AS VARIANCE, TCT.TYPE_DESC
FROM 
	EMP_TIME ET
JOIN
	EMP_TIME_NP ETN ON ET.ET_ID = ETN.ET_ID
JOIN
	TIME_CATEGORY TC ON ETN.CATEGORY = TC.CATEGORY
JOIN
	TIME_CATEGORY_TYPE TCT ON TC.VAC_SICK_FLAG = TCT.[TYPE_ID]
WHERE  ET.ET_ID = ETN.ET_ID 
AND ETN.CATEGORY = TC.CATEGORY
AND TC.VAC_SICK_FLAG NOT IN(1,2,3) 
AND TC.VAC_SICK_FLAG IS NOT NULL
AND ET.EMP_DATE BETWEEN  @start_date  AND  @end_date
AND ET.EMP_CODE =  @emp_code 
GROUP BY  EMP_CODE, TCT.TYPE_DESC, TCT.TYPE_ID

INSERT INTO ##EMP_STUFF 
SELECT ET.EMP_CODE, dbo.udf_get_empl_name(ET.EMP_CODE, 'FML'), NULL,  TC.DESCRIPTION, '' AS DATES, NULL AS HOURS_AVAIL, SUM(ETN.EMP_HOURS) AS HOURS_USED, NULL AS VARIANCE, TC.CATEGORY
FROM EMP_TIME ET, EMP_TIME_NP ETN, TIME_CATEGORY TC 
WHERE  ET.ET_ID = ETN.ET_ID 
AND ETN.CATEGORY = TC.CATEGORY
AND TC.VAC_SICK_FLAG IS NULL
AND ET.EMP_DATE BETWEEN  @start_date  AND  @end_date 
AND ET.EMP_CODE =  @emp_code 
GROUP BY  EMP_CODE, TC.DESCRIPTION, TC.CATEGORY

SET QUOTED_IDENTIFIER ON
