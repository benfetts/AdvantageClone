IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[usp_wv_get_super_appr_dtl]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[usp_wv_get_super_appr_dtl]
GO
CREATE Procedure [dbo].[usp_wv_get_super_appr_dtl]
@ET_ID INTEGER
AS
/*=========== QUERY ===========*/
BEGIN

	SELECT DISTINCT 
		ETD.ET_DTL_ID,
		JL.CL_CODE + '/' + JL.DIV_CODE + '/' + JL.PRD_CODE AS CDP,
		STR(JL.JOB_NUMBER) + ' - ' + JL.JOB_DESC + '<br />' + STR(JC.JOB_COMPONENT_NBR) + ' - ' + JC.JOB_COMP_DESC AS JOBCOMPDESC,
		FUNCTIONS.FNC_DESCRIPTION,
		CAST(ISNULL(CMT.EMP_COMMENT, '') AS VARCHAR(MAX)) AS COMMENT,
		[dbo].[udf_get_emp_time_dlt_hours_sum_dtl] (ETD.ET_ID, ETD.ET_DTL_ID) AS EMP_HOURS,
		JL.JOB_NUMBER,
		JC.JOB_COMPONENT_NBR
	FROM   
		EMP_TIME_DTL AS ETD WITH(NOLOCK)
		INNER JOIN JOB_LOG AS JL WITH(NOLOCK) ON  JL.JOB_NUMBER = ETD.JOB_NUMBER
		INNER JOIN JOB_COMPONENT AS JC WITH(NOLOCK) ON  JC.JOB_NUMBER = ETD.JOB_NUMBER AND JC.JOB_COMPONENT_NBR = ETD.JOB_COMPONENT_NBR
		LEFT OUTER JOIN FUNCTIONS WITH(NOLOCK) ON  ETD.FNC_CODE = FUNCTIONS.FNC_CODE
		LEFT OUTER JOIN EMP_TIME_DTL_CMTS AS CMT WITH(NOLOCK) ON  CMT.ET_ID = ETD.ET_ID AND CMT.ET_DTL_ID = ETD.ET_DTL_ID AND CMT.ET_SOURCE = 'D'
	WHERE  
		ETD.ET_ID = @ET_ID 
		AND ETD.EMP_HOURS <> 0.00
		AND (ETD.EDIT_FLAG <> 1 OR ETD.EDIT_FLAG IS NULL)
	UNION		
	SELECT 
		ETD.ET_DTL_ID,
		'' AS CDP,
		'' AS JOBCOMPDESC,
		TIME_CATEGORY.[DESCRIPTION] AS FNC_DESCRIPTION,
		CAST(ISNULL(CMT.EMP_COMMENT, '') AS VARCHAR(MAX)) AS COMMENT,
		ETD.EMP_HOURS,
		0 AS JOB_NUMBER,
		0 AS JOB_COMPONENT_NBR
	FROM   
		EMP_TIME_NP AS ETD WITH(NOLOCK)
		INNER JOIN TIME_CATEGORY WITH(NOLOCK) ON  TIME_CATEGORY.CATEGORY = ETD.CATEGORY
		LEFT OUTER JOIN EMP_TIME_DTL_CMTS CMT ON  CMT.ET_ID = ETD.ET_ID AND CMT.ET_DTL_ID = ETD.ET_DTL_ID AND CMT.ET_SOURCE = 'N'
	WHERE  
		ETD.ET_ID = @ET_ID 
		AND ETD.EMP_HOURS <> 0.00
		AND (ETD.EDIT_FLAG <> 1 OR ETD.EDIT_FLAG IS NULL)

END
/*=========== QUERY ===========*/