SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS OFF 
GO
IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[usp_wv_get_super_appr_hdr]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[usp_wv_get_super_appr_hdr]
GO
CREATE PROCEDURE [dbo].[usp_wv_get_super_appr_hdr] /*WITH ENCRYPTION*/
@user_id	varchar(100),
@superCode  varchar(6),
@emp_code 	varchar(6),
@start_date	SMALLDATETIME,
@end_date	SMALLDATETIME,
@APPR_FLAG	INTEGER,
@APPR_PENDING INTEGER,
@APPR_DENIED INTEGER
AS
/*=========== QUERY ===========*/
DECLARE @sql varchar(MAX), @SHOW_UNSUBMITTED BIT

SET @APPR_FLAG = ISNULL(@APPR_FLAG, 0);
SET @APPR_PENDING = ISNULL(@APPR_PENDING, 0);
SET @APPR_DENIED = ISNULL(@APPR_DENIED, 0);
SET @SHOW_UNSUBMITTED = ISNULL(@SHOW_UNSUBMITTED, 0);

IF (@APPR_FLAG = 0 AND @APPR_PENDING = 0 AND @APPR_DENIED = 0)
BEGIN
	SET @SHOW_UNSUBMITTED = 1;
END

SET @SHOW_UNSUBMITTED = ISNULL(@SHOW_UNSUBMITTED, 0);

DECLARE 
@TIME_APPR_ACTIVE SMALLINT
	
SELECT @TIME_APPR_ACTIVE = ISNULL(TIME_APPR_ACTIVE,0) 
FROM AGENCY WITH(NOLOCK);
	
SET @TIME_APPR_ACTIVE = ISNULL(@TIME_APPR_ACTIVE,0);


SET @sql = 'SELECT dbo.udf_get_empl_name(EMPLOYEE.EMP_CODE, ''FML'') AS EMPLOYEE, ET.EMP_DATE, 
				CASE DATEPART(weekday, ET.EMP_DATE)
					WHEN 1 THEN ''SUN''
					WHEN 2 THEN ''MON''
					WHEN 3 THEN ''TUE''
					WHEN 4 THEN ''WED''
					WHEN 5 THEN ''THU''
					WHEN 6 THEN ''FRI''
					WHEN 7 THEN ''SAT''
					ELSE ''''
				END AS DAYOFWEEK,
				CASE
					WHEN ET.APPR_FLAG = 1 THEN ''1''
					WHEN ET.APPR_PENDING = 1 THEN ''2''
					WHEN ET.APPR_PENDING = 2 THEN ''3''
					ELSE ''0''
				END AS STATUS,	
				
				CASE DATEPART(weekday, ET.EMP_DATE)
					WHEN 1 THEN CAST(CAST(SUN_HRS AS DECIMAL(9,2)) AS VARCHAR(10))
					WHEN 2 THEN CAST(CAST(MON_HRS AS DECIMAL(9,2)) AS VARCHAR(10))
					WHEN 3 THEN CAST(CAST(TUE_HRS AS DECIMAL(9,2)) AS VARCHAR(10))
					WHEN 4 THEN CAST(CAST(WED_HRS AS DECIMAL(9,2)) AS VARCHAR(10)) 
					WHEN 5 THEN CAST(CAST(THU_HRS AS DECIMAL(9,2)) AS VARCHAR(10)) 
					WHEN 6 THEN CAST(CAST(FRI_HRS AS DECIMAL(9,2)) AS VARCHAR(10)) 
					WHEN 7 THEN CAST(CAST(SAT_HRS AS DECIMAL(9,2)) AS VARCHAR(10)) 
					ELSE ''''
				END AS STDHOURS,
				ISNULL(ET.EMP_TOT_HRS, 0.0) AS HOURS,
				ET.APPR_NOTES, ET.ET_ID, EMPLOYEE.EMP_CODE,
				[dbo].[fn_ts_day_is_missing_comments](ET.ET_ID, ''' + @user_id + ''') AS MISSING_COMMENTS
			FROM EMPLOYEE WITH(NOLOCK)
			INNER JOIN EMP_TIME ET WITH(NOLOCK) ON ET.EMP_CODE = EMPLOYEE.EMP_CODE 

		WHERE ET.EMP_TOT_HRS <> 0 AND SUPERVISOR_CODE = ''' + @superCode + '''
		  AND ET.EMP_DATE BETWEEN ''' + CAST(@start_date AS VARCHAR) + ''' AND ''' + CAST(@end_date AS VARCHAR) + ''''

IF @emp_code <> ''
BEGIN
	SET @sql = @sql + ' AND EMPLOYEE.EMP_CODE = ''' + @emp_code + ''''
END

IF @TIME_APPR_ACTIVE = 1 AND @SHOW_UNSUBMITTED = 1
BEGIN
	SET @sql = @sql + ' AND (EMPLOYEE.TS_APPR_FLAG = 0 OR EMPLOYEE.TS_APPR_FLAG IS NULL) '
END

IF (@SHOW_UNSUBMITTED = 0)
BEGIN
	IF @APPR_FLAG = 0 AND @APPR_PENDING = 0 AND @APPR_DENIED = 0
		SET @sql = @sql + ' AND ( ET.APPR_FLAG = 0 OR ET.APPR_PENDING = 0 ) '
	
	IF @APPR_FLAG = 0 AND @APPR_PENDING = 0 AND @APPR_DENIED = 1
		SET @sql = @sql + ' AND ET.APPR_PENDING = 2 '

	IF @APPR_FLAG = 0 AND @APPR_PENDING = 1 AND @APPR_DENIED = 0
		SET @sql = @sql + ' AND ET.APPR_PENDING = 1 '

	IF @APPR_FLAG = 0 AND @APPR_PENDING = 1 AND @APPR_DENIED = 1
		SET @sql = @sql + ' AND ( ET.APPR_PENDING = 1 OR ET.APPR_PENDING = 2 ) '

	IF @APPR_FLAG = 1 AND @APPR_PENDING = 0 AND @APPR_DENIED = 0
		SET @sql = @sql + ' AND ET.APPR_FLAG = 1 '

	IF @APPR_FLAG = 1 AND @APPR_PENDING = 0 AND @APPR_DENIED = 1
		SET @sql = @sql + ' AND ( ET.APPR_FLAG = 1 OR ET.APPR_PENDING = 2 ) '

	IF @APPR_FLAG = 1 AND @APPR_PENDING = 1 AND @APPR_DENIED = 0
		SET @sql = @sql + ' AND ( ET.APPR_FLAG = 1 OR ET.APPR_PENDING = 1 ) '

	IF @APPR_FLAG = 1 AND @APPR_PENDING = 1 AND @APPR_DENIED = 1
		SET @sql = @sql + ' AND ( ET.APPR_FLAG = 1 OR ET.APPR_PENDING = 1 OR ET.APPR_PENDING = 2 ) '
END
ELSE
BEGIN
	SET @sql = @sql + ' AND ( ISNULL(ET.APPR_FLAG, 0) = 0 AND ISNULL(ET.APPR_PENDING, 0) = 0 ) '
END

SET @sql = @sql + ' ORDER BY EMPLOYEE.EMP_CODE, ET.EMP_DATE; '


EXEC (@sql)
--PRINT (@sql)

/*=========== QUERY ===========*/
GO
SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO