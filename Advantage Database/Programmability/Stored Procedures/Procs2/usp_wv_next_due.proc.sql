CREATE PROCEDURE [dbo].[usp_wv_next_due]
AS
BEGIN

	SELECT
		JOB_LOG.JOB_NUMBER, 
		JOB_COMPONENT.JOB_COMPONENT_NBR,
		JOB_TRAFFIC_DET.FNC_CODE,
		CONVERT(CHAR(10), JOB_TRAFFIC_DET.JOB_REVISED_DATE, 101) AS JOB_REVISED_DATE,
		JOB_TRAFFIC_DET.FNC_COMMENTS, 
		JOB_TRAFFIC_DET.TASK_DESCRIPTION
	FROM         
		dbo.JOB_LOG 
	INNER JOIN
		dbo.JOB_COMPONENT ON JOB_LOG.JOB_NUMBER = JOB_COMPONENT.JOB_NUMBER 
	INNER JOIN
		dbo.EMPLOYEE ON JOB_COMPONENT.EMP_CODE = EMPLOYEE.EMP_CODE 
	LEFT OUTER JOIN
		dbo.JOB_TYPE ON JOB_COMPONENT.JT_CODE= JOB_TYPE.JT_CODE 
	INNER JOIN
		dbo.CLIENT ON JOB_LOG.CL_CODE = CLIENT.CL_CODE 
	INNER JOIN
		dbo.PRODUCT ON JOB_LOG.CL_CODE = PRODUCT.CL_CODE AND 
					   JOB_LOG.DIV_CODE = PRODUCT.DIV_CODE AND 
					   JOB_LOG.PRD_CODE = PRODUCT.PRD_CODE 
	INNER JOIN
		dbo.DIVISION ON JOB_LOG.CL_CODE = DIVISION.CL_CODE AND 
						JOB_LOG.DIV_CODE = DIVISION.DIV_CODE 
	INNER JOIN
		dbo.SALES_CLASS ON JOB_LOG.SC_CODE = SALES_CLASS.SC_CODE 
	LEFT OUTER JOIN
		dbo.JOB_TRAFFIC ON JOB_LOG.JOB_NUMBER = JOB_TRAFFIC.JOB_NUMBER AND
						   JOB_COMPONENT.JOB_COMPONENT_NBR = JOB_TRAFFIC.JOB_COMPONENT_NBR
	INNER JOIN 
		dbo.JOB_TRAFFIC_DET ON JOB_TRAFFIC.JOB_NUMBER = JOB_TRAFFIC_DET.JOB_NUMBER AND 
							   JOB_TRAFFIC.JOB_COMPONENT_NBR= JOB_TRAFFIC_DET.JOB_COMPONENT_NBR
	LEFT OUTER JOIN 
		dbo.TRAFFIC ON JOB_TRAFFIC.TRF_CODE = TRAFFIC.TRF_CODE
	LEFT OUTER JOIN 
		dbo.ESTIMATE_APPROVAL ON JOB_COMPONENT.JOB_NUMBER = ESTIMATE_APPROVAL.JOB_NUMBER AND 
								 JOB_COMPONENT.JOB_COMPONENT_NBR = ESTIMATE_APPROVAL.JOB_COMPONENT_NBR
	WHERE
		JOB_COMPONENT.JOB_PROCESS_CONTRL <> 6 and 
		JOB_COMPONENT.JOB_PROCESS_CONTRL <>12 AND 
		JOB_TRAFFIC.COMPLETED_DATE IS NULL AND 
		((JOB_TRAFFIC_DET.FNC_CODE in ( SELECT TOP 1 
											FNC_CODE 
										FROM 
											dbo.JOB_TRAFFIC_DET TEMP_TRF_DET
										WHERE 
											JOB_TRAFFIC_DET.JOB_NUMBER = TEMP_TRF_DET.JOB_NUMBER AND 
											JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = TEMP_TRF_DET.JOB_COMPONENT_NBR AND 
											JOB_TRAFFIC_DET.SEQ_NBR = TEMP_TRF_DET.SEQ_NBR AND 
											TEMP_TRF_DET.JOB_COMPLETED_DATE IS NULL
										ORDER BY 
											TEMP_TRF_DET.JOB_ORDER, 
											TEMP_TRF_DET.JOB_REVISED_DATE, 
											TEMP_TRF_DET.SEQ_NBR)) OR 
		(JOB_TRAFFIC_DET.FNC_CODE IS NULL AND 
		 JOB_TRAFFIC_DET.JOB_COMPLETED_DATE IS NULL))
	ORDER BY 
		JOB_LOG.JOB_NUMBER,
		JOB_COMPONENT.JOB_COMPONENT_NBR,
		CASE WHEN JOB_TRAFFIC.SCHEDULE_CALC = 1 THEN JOB_TRAFFIC_DET.JOB_REVISED_DATE ELSE JOB_TRAFFIC_DET.JOB_ORDER END,
		JOB_TRAFFIC_DET.JOB_REVISED_DATE,
		JOB_TRAFFIC_DET.SEQ_NBR

END