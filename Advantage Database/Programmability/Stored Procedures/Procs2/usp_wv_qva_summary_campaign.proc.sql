SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS OFF 
GO
IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[usp_wv_qva_summary_campaign]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[usp_wv_qva_summary_campaign]
GO
CREATE PROCEDURE [dbo].[usp_wv_qva_summary_campaign] /*WITH ENCRYPTION*/ 
@UserID VarChar(100),
@CampaignID int,
@grouptype varchar(20),
@Display Varchar(20),
@DesktopObject varchar(10)
AS
/*=========== QUERY ===========*/

	Declare @Rescrictions Int,
			@RescrictionsEmp Int, @MaxBAID int, @ArInvNbr int, @ProdConsFunc smallint, @EstMaxRev int, @Records INT, 
			@COUNT INT, 
			@jnum INT, 
			@cnum INT, @countqte int, @countact int 

	Select @Rescrictions = Count(*) 
	FROM SEC_CLIENT
	WHERE UPPER(USER_ID) = UPPER(@UserID)

	Select @RescrictionsEmp = Count(*) 
	FROM SEC_EMP
	WHERE UPPER(USER_ID) = UPPER(@UserID)

	DECLARE
		@BREAKOUT_ALL_NB BIT,
		@BREAKOUT_NB_FOR_FT BIT,
		@FILTER_INCLUDE_NB BIT,
		@FILTER_EMPLOYEE_TIME BIT,
		@FILTER_INCOME_ONLY BIT,
		@FILTER_VENDOR BIT,
		@INCLUDE_SALES_TAX BIT,
		@InclClosedJobs VARCHAR(6),
		@APP_VARS_APPLICATION VARCHAR(20),
		@IncludeClosedJobs smallint

	SET @BREAKOUT_ALL_NB = 0;
	SET @BREAKOUT_NB_FOR_FT = 0;
	SET @FILTER_INCLUDE_NB = 0;
	SET @FILTER_EMPLOYEE_TIME = 0;
	SET @FILTER_INCOME_ONLY = 0;
	SET @FILTER_VENDOR = 0;
	SET @INCLUDE_SALES_TAX = 0
	
	IF EXISTS (SELECT USERID FROM APP_VARS WITH(NOLOCK) WHERE [APPLICATION] = 'QVA' AND VARIABLE_NAME = 'QvaFilterBreakoutAllNB' AND UPPER(USERID) = UPPER(@UserID) AND RTRIM(LTRIM(LOWER(VARIABLE_VALUE))) = 'true')
	BEGIN
		SET @BREAKOUT_ALL_NB = 1;
	END
	IF EXISTS (SELECT USERID FROM APP_VARS WITH(NOLOCK) WHERE [APPLICATION] = 'QVA' AND VARIABLE_NAME = 'QvaFilterBreakoutNBForFT' AND UPPER(USERID) = UPPER(@UserID) AND RTRIM(LTRIM(LOWER(VARIABLE_VALUE))) = 'true')
	BEGIN
		SET @BREAKOUT_NB_FOR_FT = 1;
	END
	IF EXISTS (SELECT USERID FROM APP_VARS WITH(NOLOCK) WHERE [APPLICATION] = 'QVA' AND VARIABLE_NAME = 'QvaFilterIncludeNB' AND UPPER(USERID) = UPPER(@UserID) AND VARIABLE_VALUE LIKE 'True')
	BEGIN
		SET @FILTER_INCLUDE_NB = 1;
	END
	IF EXISTS (SELECT USERID FROM APP_VARS WITH(NOLOCK) WHERE [APPLICATION] = 'QVA' AND VARIABLE_NAME = 'QvaFilterEmployeeTime' AND UPPER(USERID) = UPPER(@UserID) AND RTRIM(LTRIM(LOWER(VARIABLE_VALUE))) = 'true')
	BEGIN
		SET @FILTER_EMPLOYEE_TIME = 1;
	END
	IF EXISTS (SELECT USERID FROM APP_VARS WITH(NOLOCK) WHERE [APPLICATION] = 'QVA' AND VARIABLE_NAME = 'QvaFilterIncomeOnly' AND UPPER(USERID) = UPPER(@UserID) AND RTRIM(LTRIM(LOWER(VARIABLE_VALUE))) = 'true')
	BEGIN
		SET @FILTER_INCOME_ONLY = 1;
	END
	IF EXISTS (SELECT USERID FROM APP_VARS WITH(NOLOCK) WHERE [APPLICATION] = 'QVA' AND VARIABLE_NAME = 'QvaFilterVendor' AND UPPER(USERID) = UPPER(@UserID) AND RTRIM(LTRIM(LOWER(VARIABLE_VALUE))) = 'true')
	BEGIN
		SET @FILTER_VENDOR = 1;
	END
	IF EXISTS (SELECT USERID FROM APP_VARS WITH(NOLOCK) WHERE [APPLICATION] = 'QVA' AND VARIABLE_NAME = 'QvaFilterSalesTax' AND UPPER(USERID) = UPPER(@UserID) AND RTRIM(LTRIM(LOWER(VARIABLE_VALUE))) = 'true')
	BEGIN
		SET @INCLUDE_SALES_TAX = 1;
	END

	--IF @DesktopObject = 'All'
	--BEGIN
	
	--	SET @APP_VARS_APPLICATION = 'AllQvA'
	
	--END
	--ELSE
	--BEGIN
	
	--	SET @APP_VARS_APPLICATION = 'MyQvA'
	
	--END

	--SELECT @InclClosedJobs = VARIABLE_VALUE FROM APP_VARS WITH(NOLOCK) WHERE VARIABLE_NAME = 'InclClosedJobs' AND UPPER(USERID) = UPPER(@UserID) AND [APPLICATION] = @APP_VARS_APPLICATION;
	
	--IF @InclClosedJobs IS NULL OR @InclClosedJobs = ''
	--BEGIN
		IF @DesktopObject = 'All'
		BEGIN
	
			SET @APP_VARS_APPLICATION = 'ALL_QVA_DTO'
	
		END
		ELSE
		BEGIN
	
			SET @APP_VARS_APPLICATION = 'MY_QVA_DTO'
	
		END

		SELECT @InclClosedJobs = VARIABLE_VALUE FROM APP_VARS WITH(NOLOCK) WHERE VARIABLE_NAME = 'InclClosedJobs' AND UPPER(USERID) = UPPER(@UserID) AND [APPLICATION] = @APP_VARS_APPLICATION;
		
	--END

	IF @InclClosedJobs IS NULL OR @InclClosedJobs = ''
	BEGIN
		SET @InclClosedJobs = 'False'
	END
	
	IF @InclClosedJobs = 'False' 
	BEGIN
		SET @IncludeClosedJobs = 0
	END
	ELSE
	BEGIN
		SET @IncludeClosedJobs = 1
	END

	--SELECT @EstMaxRev = MAX(dbo.ESTIMATE_REV.EST_REV_NBR)
	--FROM  ESTIMATE_REV INNER JOIN
 --         JOB_COMPONENT ON dbo.ESTIMATE_REV.ESTIMATE_NUMBER = dbo.JOB_COMPONENT.ESTIMATE_NUMBER AND 
 --         ESTIMATE_REV.EST_COMPONENT_NBR = dbo.JOB_COMPONENT.EST_COMPONENT_NBR
	--WHERE (JOB_COMPONENT.JOB_NUMBER = @JobNum) AND (JOB_COMPONENT.JOB_COMPONENT_NBR = @JobComp)

	CREATE TABLE #qva_rows( 	
		FNC_CODE				varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		FNC_DESCRIPTION			varchar(30) NULL,
		FNC_TYPE      			varchar(1) NULL,
		FNC_HEADING_ID			int NULL,
		FNC_HEADING_DESC		varchar(60) NULL,
		FNC_HEADING_SEQ			int NULL,
		FNC_CONSOL_CODE			varchar(6),
		Quoted_QtyHrs			decimal(15,2) NULL,
		Quoted_Amount  			decimal(15,2) NULL,
		Quoted_Markup			decimal(15,2) NULL,
		Quoted_Tax				decimal(15,2) NULL,	
		Quoted_Total			decimal(15,2) NULL,
		Actual_Hours			decimal(15,2) NULL,
		Actual_Amount			decimal(15,2) NULL,
		Actual_Markup			decimal(15,2) NULL,
		Actual_Tax				decimal(15,2) NULL,
		Actual_Total			decimal(15,2) NULL,
		Open_PO_Net_Amt			decimal(15,2) NULL,
		Billed_to_Date			decimal(15,2) NULL,
		Quote_vs_Actual_PO		decimal(15,2) NULL,
		Actual_PO_vs_Billed		decimal(15,2) NULL,
		Qva						decimal(15,2) NULL,
		Avb						decimal(15,2) NULL,
		Qva_PO					decimal(15,2) NULL,
		Avb_PO					decimal(15,2) NULL,
		NB_Actual_Hours         decimal(15,2) NULL,
		NB_Actual_Total         decimal(15,2) NULL,
		Adv_Billed				decimal(15,2) NULL,
		PO_Total				decimal(15,2) NULL,
		PO_Applied				decimal(15,2) NULL,
		NB_Tax					decimal(15,2) NULL,
		NB_Markup				decimal(15,2) NULL,
		NB_Amount				decimal(15,2) NULL,
		APPROVED_AMT			decimal(15,2) NULL,
		NB_Hours                decimal(15,2) NULL,
		QUOTE_PERC				DECIMAL(15,2) NULL,
		NB_Total				DECIMAL(15,2) NULL,
		Billed_to_Date_Total	DECIMAL(15,2) NULL,
		QUOTE_PERC_AMT			DECIMAL(15,2) NULL
				)
				
	CREATE TABLE #qva_rows_sum( 	
		FNC_CODE				varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		FNC_DESCRIPTION			varchar(30) NULL,
		FNC_TYPE      			varchar(1) NULL,
		FNC_HEADING_ID			int NULL,
		FNC_HEADING_DESC		varchar(60) NULL,
		FNC_HEADING_SEQ			int NULL,
		FNC_CONSOL_CODE			varchar(6),
		Quoted_QtyHrs			decimal(15,2) NULL,
		Quoted_Amount  			decimal(15,2) NULL,
		Quoted_Markup			decimal(15,2) NULL,
		Quoted_Tax				decimal(15,2) NULL,	
		Quoted_Total			decimal(15,2) NULL,
		Actual_Hours			decimal(15,2) NULL,
		Actual_Amount			decimal(15,2) NULL,
		Actual_Markup			decimal(15,2) NULL,
		Actual_Tax				decimal(15,2) NULL,
		Actual_Total			decimal(15,2) NULL,
		Open_PO_Net_Amt			decimal(15,2) NULL,
		Billed_to_Date			decimal(15,2) NULL,
		Quote_vs_Actual_PO		decimal(15,2) NULL,
		Actual_PO_vs_Billed		decimal(15,2) NULL,
		Qva						decimal(15,2) NULL,
		Avb						decimal(15,2) NULL,
		Qva_PO					decimal(15,2) NULL,
		Avb_PO					decimal(15,2) NULL,
		NB_Actual_Hours         decimal(15,2) NULL,
		NB_Actual_Total         decimal(15,2) NULL,
		Adv_Billed				decimal(15,2) NULL,
		PO_Total				decimal(15,2) NULL,
		PO_Applied				decimal(15,2) NULL,
		NB_Tax					decimal(15,2) NULL,
		NB_Markup				decimal(15,2) NULL,
		NB_Amount				decimal(15,2) NULL,
		APPROVED_AMT			decimal(15,2) NULL,
		NB_Hours                decimal(15,2) NULL,
		QUOTE_PERC				DECIMAL(15,2) NULL,
		NB_Total				DECIMAL(15,2) NULL,
		Billed_to_Date_Total	DECIMAL(15,2) NULL,
		QUOTE_PERC_AMT			DECIMAL(15,2) NULL
				)

	CREATE TABLE #qva_qva( 	
		FNC_CODE				varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		FNC_DESCRIPTION			varchar(30) NULL,
		FNC_TYPE      			varchar(1) NULL,
		FNC_HEADING_ID			int NULL,
		FNC_HEADING_DESC		varchar(60) NULL,
		FNC_HEADING_SEQ			int NULL,
		FNC_CONSOL_CODE			varchar(6),
		Quoted_QtyHrs			decimal(15,2) NULL,
		Quoted_Amount  			decimal(15,2) NULL,
		Quoted_Markup			decimal(15,2) NULL,
		Quoted_Tax				decimal(15,2) NULL,	
		Quoted_Total			decimal(15,2) NULL,
		Actual_Hours			decimal(15,2) NULL,
		Actual_Amount			decimal(15,2) NULL,
		Actual_Markup			decimal(15,2) NULL,
		Actual_Tax				decimal(15,2) NULL,
		Actual_Total			decimal(15,2) NULL,
		Open_PO_Net_Amt			decimal(15,2) NULL,
		Billed_to_Date			decimal(15,2) NULL,
		Quote_vs_Actual_PO		decimal(15,2) NULL,
		Actual_PO_vs_Billed		decimal(15,2) NULL,
		Qva						decimal(15,2) NULL,
		Avb						decimal(15,2) NULL,
		Qva_PO					decimal(15,2) NULL,
		Avb_PO					decimal(15,2) NULL,
		NB_Actual_Hours         decimal(15,2) NULL,
		NB_Actual_Total         decimal(15,2) NULL,
		Adv_Billed				decimal(15,2) NULL,
		PO_Total				decimal(15,2) NULL,
		PO_Applied				decimal(15,2) NULL,
		NB_Tax					decimal(15,2) NULL,
		NB_Markup				decimal(15,2) NULL,
		NB_Amount				decimal(15,2) NULL,
		APPROVED_AMT			decimal(15,2) NULL,
		NB_Hours                decimal(15,2) NULL,
		QUOTE_PERC				DECIMAL(15,2) NULL,
		NB_Total				DECIMAL(15,2) NULL,
		Billed_to_Date_Total	DECIMAL(15,2) NULL,
		QUOTE_PERC_AMT			DECIMAL(15,2) NULL
				)

	CREATE TABLE #job(
	RowID int IDENTITY(1, 1), 
	JobNo int,
	JobCompNo int)

	DECLARE @qva_quoted TABLE( 
			FNC_CODE				varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
			FNC_DESCRIPTION			varchar(30) NULL,
			FNC_TYPE      			varchar(1) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
			FNC_HEADING_ID			int NULL,
			FNC_HEADING_DESC		varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
			FNC_HEADING_SEQ			int NULL,
			FNC_CONSOL_CODE			varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
			Quoted_QtyHrs			decimal(15,2) NULL,
			Quoted_Amount  			decimal(15,2) NULL,
			Quoted_Markup			decimal(15,2) NULL,
			Quoted_Tax				decimal(15,2) NULL,	
			Quoted_Total			decimal(15,2) NULL)
	
	DECLARE @qva_actual TABLE( 
			FNC_CODE				varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
			FNC_DESCRIPTION			varchar(30) NULL,
			FNC_TYPE      			varchar(1) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
			FNC_HEADING_ID			int NULL,
			FNC_HEADING_DESC		varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
			FNC_HEADING_SEQ			int NULL,
			FNC_CONSOL_CODE			varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
			Actual_Hours			decimal(15,2) NULL,
			Actual_Amount			decimal(15,2) NULL,
			Actual_Markup			decimal(15,2) NULL,
			Actual_Tax				decimal(15,2) NULL,
			Actual_Total			decimal(15,2) NULL)

	DECLARE @qva_Billed TABLE( 
			FNC_CODE				varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
			FNC_DESCRIPTION			varchar(30) NULL,
			FNC_TYPE      			varchar(1) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
			FNC_HEADING_ID			int NULL,
			FNC_HEADING_DESC		varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
			FNC_HEADING_SEQ			int NULL,
			FNC_CONSOL_CODE			varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
			Open_PO_Net_Amt			decimal(15,2) NULL,
			Billed_to_Date			decimal(15,2) NULL)

	DECLARE @qva_AdvBilled TABLE( 
			FNC_CODE				varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
			FNC_DESCRIPTION			varchar(30) NULL,
			FNC_TYPE      			varchar(1) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
			FNC_HEADING_ID			int NULL,
			FNC_HEADING_DESC		varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
			FNC_HEADING_SEQ			int NULL,
			FNC_CONSOL_CODE			varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
			Quote_vs_Actual_PO		decimal(15,2) NULL,
			Actual_PO_vs_Billed		decimal(15,2) NULL,
			Adv_Billed				decimal(15,2) NULL,		
			Qva						decimal(15,2) NULL,
			Avb						decimal(15,2) NULL,
			Qva_PO					decimal(15,2) NULL,
			Avb_PO					decimal(15,2) NULL,
			NB_Actual_Hours			decimal(15,2) NULL,
			NB_Actual_Total			decimal(15,2) NULL)

	DECLARE @qva_POtotal TABLE( 
			FNC_CODE				varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
			FNC_DESCRIPTION			varchar(30) NULL,
			FNC_TYPE      			varchar(1) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
			FNC_HEADING_ID			int NULL,
			FNC_HEADING_DESC		varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
			FNC_HEADING_SEQ			int NULL,
			FNC_CONSOL_CODE			varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
			PO_Total			    decimal(15,2) NULL)

	DECLARE @qva_POapplied TABLE( 
			FNC_CODE				varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
			FNC_DESCRIPTION			varchar(30) NULL,
			FNC_TYPE      			varchar(1) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
			FNC_HEADING_ID			int NULL,
			FNC_HEADING_DESC		varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
			FNC_HEADING_SEQ			int NULL,
			FNC_CONSOL_CODE			varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
			PO_Applied		    	decimal(15,2) NULL)

	DECLARE @qva_NB TABLE( 
			FNC_CODE				varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
			FNC_DESCRIPTION			varchar(30) NULL,
			FNC_TYPE      			varchar(1) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
			FNC_HEADING_ID			int NULL,
			FNC_HEADING_DESC		varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
			FNC_HEADING_SEQ			int NULL,
			FNC_CONSOL_CODE			varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
			NB_Tax					decimal(15,2) NULL,
			NB_Markup				decimal(15,2) NULL,
			NB_Amount				decimal(15,2) NULL,
			NB_Hours                decimal(15,2) NULL)

	DECLARE @APPROVED_AMT TABLE (
			FNC_CODE				varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
			APPROVED_AMT			decimal(15,2) NULL)


	if @IncludeClosedJobs = 1
	Begin
		INSERT INTO #job 
		SELECT JC.JOB_NUMBER, JC.JOB_COMPONENT_NBR 
		FROM JOB_LOG JL INNER JOIN JOB_COMPONENT JC ON JL.JOB_NUMBER = JC.JOB_NUMBER
		WHERE JL.CMP_IDENTIFIER = @CampaignID
	End
	Else
	Begin
		INSERT INTO #job 
		SELECT JC.JOB_NUMBER, JC.JOB_COMPONENT_NBR 
		FROM JOB_LOG JL INNER JOIN JOB_COMPONENT JC ON JL.JOB_NUMBER = JC.JOB_NUMBER
		WHERE JL.CMP_IDENTIFIER = @CampaignID AND (NOT (JC.JOB_PROCESS_CONTRL IN (6, 12)) )
	End
		
	--SELECT * FROM #job
	
	if @grouptype = 'job'
	Begin
		if @IncludeClosedJobs = 1
		Begin
			INSERT INTO @qva_quoted
			SELECT     ESTIMATE_REV_DET.FNC_CODE, ISNULL(FUNCTIONS.FNC_DESCRIPTION,'') FNC_DESCRIPTION, FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN ESTIMATE_REV_DET.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END,
							  ISNULL(SUM(ESTIMATE_REV_DET.EST_REV_QUANTITY), 0.00)  AS Quoted_QtyHrs, 
							  ISNULL(SUM(ESTIMATE_REV_DET.EST_REV_EXT_AMT), 0.00) + ISNULL(SUM(ESTIMATE_REV_DET.EXT_NONRESALE_TAX), 0.00) AS Quoted_Amount, 
							  ISNULL(SUM(ESTIMATE_REV_DET.EXT_MARKUP_AMT), 0.00) AS Quoted_Markup, 
							  ISNULL(SUM(ESTIMATE_REV_DET.EXT_CITY_RESALE), 0.00) + ISNULL(SUM(ESTIMATE_REV_DET.EXT_STATE_RESALE), 0.00) 
							  + ISNULL(SUM(ESTIMATE_REV_DET.EXT_COUNTY_RESALE), 0.00) 
								  AS Quoted_Tax, 0.00 AS Quoted_Total	
			FROM        V_ESTIMATEAPPR INNER JOIN
							ESTIMATE_REV_DET ON V_ESTIMATEAPPR.ESTIMATE_NUMBER = ESTIMATE_REV_DET.ESTIMATE_NUMBER AND 
							V_ESTIMATEAPPR.EST_COMPONENT_NBR = ESTIMATE_REV_DET.EST_COMPONENT_NBR AND 
							V_ESTIMATEAPPR.EST_QUOTE_NBR = ESTIMATE_REV_DET.EST_QUOTE_NBR AND 
							V_ESTIMATEAPPR.EST_REVISION_NBR = ESTIMATE_REV_DET.EST_REV_NBR INNER JOIN
						  dbo.JOB_COMPONENT ON dbo.V_ESTIMATEAPPR.JOB_NUMBER = dbo.JOB_COMPONENT.JOB_NUMBER AND 
						  dbo.V_ESTIMATEAPPR.JOB_COMPONENT_NBR = dbo.JOB_COMPONENT.JOB_COMPONENT_NBR INNER JOIN
						  dbo.JOB_LOG ON dbo.JOB_COMPONENT.JOB_NUMBER = dbo.JOB_LOG.JOB_NUMBER INNER JOIN
						  dbo.FUNCTIONS ON dbo.ESTIMATE_REV_DET.FNC_CODE = dbo.FUNCTIONS.FNC_CODE LEFT OUTER JOIN
						  dbo.FNC_HEADING ON dbo.FUNCTIONS.FNC_HEADING_ID = dbo.FNC_HEADING.FNC_HEADING_ID
			WHERE     (dbo.JOB_LOG.CMP_IDENTIFIER = @CampaignID)
			GROUP BY ESTIMATE_REV_DET.FNC_CODE, FUNCTIONS.FNC_DESCRIPTION, FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
							  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN ESTIMATE_REV_DET.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END
			ORDER BY FUNCTIONS.FNC_DESCRIPTION
		End
		Else
		Begin
			INSERT INTO @qva_quoted
			SELECT     ESTIMATE_REV_DET.FNC_CODE, ISNULL(FUNCTIONS.FNC_DESCRIPTION,'') FNC_DESCRIPTION, FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN ESTIMATE_REV_DET.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END,
							  ISNULL(SUM(ESTIMATE_REV_DET.EST_REV_QUANTITY), 0.00)  AS Quoted_QtyHrs, 
							  ISNULL(SUM(ESTIMATE_REV_DET.EST_REV_EXT_AMT), 0.00) + ISNULL(SUM(ESTIMATE_REV_DET.EXT_NONRESALE_TAX), 0.00) AS Quoted_Amount, 
							  ISNULL(SUM(ESTIMATE_REV_DET.EXT_MARKUP_AMT), 0.00) AS Quoted_Markup, 
							  ISNULL(SUM(ESTIMATE_REV_DET.EXT_CITY_RESALE), 0.00) + ISNULL(SUM(ESTIMATE_REV_DET.EXT_STATE_RESALE), 0.00) 
							  + ISNULL(SUM(ESTIMATE_REV_DET.EXT_COUNTY_RESALE), 0.00) 
								  AS Quoted_Tax, 0.00 AS Quoted_Total	
			FROM        V_ESTIMATEAPPR INNER JOIN
							ESTIMATE_REV_DET ON V_ESTIMATEAPPR.ESTIMATE_NUMBER = ESTIMATE_REV_DET.ESTIMATE_NUMBER AND 
							V_ESTIMATEAPPR.EST_COMPONENT_NBR = ESTIMATE_REV_DET.EST_COMPONENT_NBR AND 
							V_ESTIMATEAPPR.EST_QUOTE_NBR = ESTIMATE_REV_DET.EST_QUOTE_NBR AND 
							V_ESTIMATEAPPR.EST_REVISION_NBR = ESTIMATE_REV_DET.EST_REV_NBR INNER JOIN
						  dbo.JOB_COMPONENT ON dbo.V_ESTIMATEAPPR.JOB_NUMBER = dbo.JOB_COMPONENT.JOB_NUMBER AND 
						  dbo.V_ESTIMATEAPPR.JOB_COMPONENT_NBR = dbo.JOB_COMPONENT.JOB_COMPONENT_NBR INNER JOIN
						  dbo.JOB_LOG ON dbo.JOB_COMPONENT.JOB_NUMBER = dbo.JOB_LOG.JOB_NUMBER INNER JOIN
						  dbo.FUNCTIONS ON dbo.ESTIMATE_REV_DET.FNC_CODE = dbo.FUNCTIONS.FNC_CODE LEFT OUTER JOIN
						  dbo.FNC_HEADING ON dbo.FUNCTIONS.FNC_HEADING_ID = dbo.FNC_HEADING.FNC_HEADING_ID
			WHERE     (dbo.JOB_LOG.CMP_IDENTIFIER = @CampaignID)  AND (NOT (JOB_COMPONENT.JOB_PROCESS_CONTRL IN (6, 12)) ) 
			GROUP BY ESTIMATE_REV_DET.FNC_CODE, FUNCTIONS.FNC_DESCRIPTION, FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
							  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN ESTIMATE_REV_DET.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END
			ORDER BY FUNCTIONS.FNC_DESCRIPTION
		End
		
	End
	if @grouptype = 'campaign'
	Begin
		DECLARE @HAS_EST_APPR   AS INTEGER,
			@HAS_EST_INT_APPR  AS INTEGER
		IF EXISTS(SELECT CMP_IDENTIFIER FROM EST_CAMP_APPROVAL WHERE CMP_IDENTIFIER = @CampaignID AND APPR_TYPE = 'C')
		BEGIN
			SET @HAS_EST_APPR = 1
		END
		ELSE
		BEGIN
			SET @HAS_EST_APPR = 0
		END
		IF EXISTS(SELECT CMP_IDENTIFIER FROM EST_CAMP_APPROVAL WHERE CMP_IDENTIFIER = @CampaignID AND APPR_TYPE = 'I')
		BEGIN
			SET @HAS_EST_INT_APPR = 1
		END
		ELSE
		BEGIN
			SET @HAS_EST_INT_APPR = 0
		END

		IF @HAS_EST_APPR = 1
		BEGIN
			INSERT INTO @qva_quoted
			SELECT   ESTIMATE_REV_DET.FNC_CODE, ISNULL(FUNCTIONS.FNC_DESCRIPTION,'') FNC_DESCRIPTION, FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN ESTIMATE_REV_DET.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END,
							  ISNULL(SUM(ESTIMATE_REV_DET.EST_REV_QUANTITY), 0.00)  AS Quoted_QtyHrs, 
							  ISNULL(SUM(ESTIMATE_REV_DET.EST_REV_EXT_AMT), 0.00) + ISNULL(SUM(ESTIMATE_REV_DET.EXT_NONRESALE_TAX), 0.00) AS Quoted_Amount, 
							  ISNULL(SUM(ESTIMATE_REV_DET.EXT_MARKUP_AMT), 0.00) AS Quoted_Markup, 
							  ISNULL(SUM(ESTIMATE_REV_DET.EXT_CITY_RESALE), 0.00) + ISNULL(SUM(ESTIMATE_REV_DET.EXT_STATE_RESALE), 0.00) 
							  + ISNULL(SUM(ESTIMATE_REV_DET.EXT_COUNTY_RESALE), 0.00) 
							  AS Quoted_Tax, 0.00 AS Quoted_Total	
			FROM      ESTIMATE_REV_DET INNER JOIN
                      EST_CAMP_APPROVAL ON ESTIMATE_REV_DET.ESTIMATE_NUMBER = EST_CAMP_APPROVAL.ESTIMATE_NUMBER AND 
					  EST_CAMP_APPROVAL.EST_COMPONENT_NBR = ESTIMATE_REV_DET.EST_COMPONENT_NBR AND 
					  EST_CAMP_APPROVAL.EST_QUOTE_NBR = ESTIMATE_REV_DET.EST_QUOTE_NBR AND 
					  EST_CAMP_APPROVAL.EST_REVISION_NBR = ESTIMATE_REV_DET.EST_REV_NBR INNER JOIN
                      FUNCTIONS ON ESTIMATE_REV_DET.FNC_CODE = FUNCTIONS.FNC_CODE INNER JOIN 
					  ESTIMATE_LOG ON ESTIMATE_REV_DET.ESTIMATE_NUMBER = ESTIMATE_LOG.ESTIMATE_NUMBER LEFT OUTER JOIN
                      FNC_HEADING ON FUNCTIONS.FNC_HEADING_ID = FNC_HEADING.FNC_HEADING_ID		
			WHERE     (ESTIMATE_LOG.CMP_IDENTIFIER = @CampaignID) AND EST_CAMP_APPROVAL.APPR_TYPE = 'C'
			GROUP BY ESTIMATE_REV_DET.FNC_CODE, FUNCTIONS.FNC_DESCRIPTION, FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN ESTIMATE_REV_DET.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END
			ORDER BY FUNCTIONS.FNC_DESCRIPTION   
		END

		IF @HAS_EST_INT_APPR = 1 AND @HAS_EST_APPR = 0
		BEGIN
			INSERT INTO @qva_quoted
			SELECT   ESTIMATE_REV_DET.FNC_CODE, ISNULL(FUNCTIONS.FNC_DESCRIPTION,'') FNC_DESCRIPTION, FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN ESTIMATE_REV_DET.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END,
							  ISNULL(SUM(ESTIMATE_REV_DET.EST_REV_QUANTITY), 0.00)  AS Quoted_QtyHrs, 
							  ISNULL(SUM(ESTIMATE_REV_DET.EST_REV_EXT_AMT), 0.00) + ISNULL(SUM(ESTIMATE_REV_DET.EXT_NONRESALE_TAX), 0.00) AS Quoted_Amount, 
							  ISNULL(SUM(ESTIMATE_REV_DET.EXT_MARKUP_AMT), 0.00) AS Quoted_Markup, 
							  ISNULL(SUM(ESTIMATE_REV_DET.EXT_CITY_RESALE), 0.00) + ISNULL(SUM(ESTIMATE_REV_DET.EXT_STATE_RESALE), 0.00) 
							  + ISNULL(SUM(ESTIMATE_REV_DET.EXT_COUNTY_RESALE), 0.00) 
							  AS Quoted_Tax, 0.00 AS Quoted_Total	
			FROM      ESTIMATE_REV_DET INNER JOIN
                      EST_CAMP_APPROVAL ON ESTIMATE_REV_DET.ESTIMATE_NUMBER = EST_CAMP_APPROVAL.ESTIMATE_NUMBER AND 
					  EST_CAMP_APPROVAL.EST_COMPONENT_NBR = ESTIMATE_REV_DET.EST_COMPONENT_NBR AND 
					  EST_CAMP_APPROVAL.EST_QUOTE_NBR = ESTIMATE_REV_DET.EST_QUOTE_NBR AND 
					  EST_CAMP_APPROVAL.EST_REVISION_NBR = ESTIMATE_REV_DET.EST_REV_NBR INNER JOIN
                      FUNCTIONS ON ESTIMATE_REV_DET.FNC_CODE = FUNCTIONS.FNC_CODE INNER JOIN 
					  ESTIMATE_LOG ON ESTIMATE_REV_DET.ESTIMATE_NUMBER = ESTIMATE_LOG.ESTIMATE_NUMBER LEFT OUTER JOIN
                      FNC_HEADING ON FUNCTIONS.FNC_HEADING_ID = FNC_HEADING.FNC_HEADING_ID		
			WHERE     (ESTIMATE_LOG.CMP_IDENTIFIER = @CampaignID) AND EST_CAMP_APPROVAL.APPR_TYPE = 'I'
			GROUP BY ESTIMATE_REV_DET.FNC_CODE, FUNCTIONS.FNC_DESCRIPTION, FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN ESTIMATE_REV_DET.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END
			ORDER BY FUNCTIONS.FNC_DESCRIPTION   
		END
		
	End
	if @grouptype = 'campaignmaster'
	Begin

		DECLARE @jobmaster int, @jobcompmaster int

		SELECT @jobmaster = JOB_NUMBER, @jobcompmaster = JOB_COMPONENT_NBR
		FROM CAMPAIGN
		WHERe CMP_IDENTIFIER = @CampaignID		
		
		if @IncludeClosedJobs = 1
		Begin
			INSERT INTO @qva_quoted
			SELECT     ESTIMATE_REV_DET.FNC_CODE, ISNULL(FUNCTIONS.FNC_DESCRIPTION,'') FNC_DESCRIPTION, FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN ESTIMATE_REV_DET.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END,
							  ISNULL(SUM(ESTIMATE_REV_DET.EST_REV_QUANTITY), 0.00)  AS Quoted_QtyHrs, 
							  ISNULL(SUM(ESTIMATE_REV_DET.EST_REV_EXT_AMT), 0.00) + ISNULL(SUM(ESTIMATE_REV_DET.EXT_NONRESALE_TAX), 0.00) AS Quoted_Amount, 
							  ISNULL(SUM(ESTIMATE_REV_DET.EXT_MARKUP_AMT), 0.00) AS Quoted_Markup, 
							  ISNULL(SUM(ESTIMATE_REV_DET.EXT_CITY_RESALE), 0.00) + ISNULL(SUM(ESTIMATE_REV_DET.EXT_STATE_RESALE), 0.00) 
							  + ISNULL(SUM(ESTIMATE_REV_DET.EXT_COUNTY_RESALE), 0.00) 
								  AS Quoted_Tax, 0.00 AS Quoted_Total	
			FROM        V_ESTIMATEAPPR INNER JOIN
							ESTIMATE_REV_DET ON V_ESTIMATEAPPR.ESTIMATE_NUMBER = ESTIMATE_REV_DET.ESTIMATE_NUMBER AND 
							V_ESTIMATEAPPR.EST_COMPONENT_NBR = ESTIMATE_REV_DET.EST_COMPONENT_NBR AND 
							V_ESTIMATEAPPR.EST_QUOTE_NBR = ESTIMATE_REV_DET.EST_QUOTE_NBR AND 
							V_ESTIMATEAPPR.EST_REVISION_NBR = ESTIMATE_REV_DET.EST_REV_NBR INNER JOIN
						  dbo.JOB_COMPONENT ON dbo.V_ESTIMATEAPPR.JOB_NUMBER = dbo.JOB_COMPONENT.JOB_NUMBER AND 
						  dbo.V_ESTIMATEAPPR.JOB_COMPONENT_NBR = dbo.JOB_COMPONENT.JOB_COMPONENT_NBR INNER JOIN
						  dbo.JOB_LOG ON dbo.JOB_COMPONENT.JOB_NUMBER = dbo.JOB_LOG.JOB_NUMBER INNER JOIN
						  dbo.FUNCTIONS ON dbo.ESTIMATE_REV_DET.FNC_CODE = dbo.FUNCTIONS.FNC_CODE LEFT OUTER JOIN
						  dbo.FNC_HEADING ON dbo.FUNCTIONS.FNC_HEADING_ID = dbo.FNC_HEADING.FNC_HEADING_ID
			WHERE     (dbo.V_ESTIMATEAPPR.JOB_NUMBER = @jobmaster AND V_ESTIMATEAPPR.JOB_COMPONENT_NBR = @jobcompmaster)
			GROUP BY ESTIMATE_REV_DET.FNC_CODE, FUNCTIONS.FNC_DESCRIPTION, FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
							  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN ESTIMATE_REV_DET.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END
			ORDER BY FUNCTIONS.FNC_DESCRIPTION
		End
		Else
		Begin
			INSERT INTO @qva_quoted
			SELECT     ESTIMATE_REV_DET.FNC_CODE, ISNULL(FUNCTIONS.FNC_DESCRIPTION,'') FNC_DESCRIPTION, FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN ESTIMATE_REV_DET.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END,
							  ISNULL(SUM(ESTIMATE_REV_DET.EST_REV_QUANTITY), 0.00)  AS Quoted_QtyHrs, 
							  ISNULL(SUM(ESTIMATE_REV_DET.EST_REV_EXT_AMT), 0.00) + ISNULL(SUM(ESTIMATE_REV_DET.EXT_NONRESALE_TAX), 0.00) AS Quoted_Amount, 
							  ISNULL(SUM(ESTIMATE_REV_DET.EXT_MARKUP_AMT), 0.00) AS Quoted_Markup, 
							  ISNULL(SUM(ESTIMATE_REV_DET.EXT_CITY_RESALE), 0.00) + ISNULL(SUM(ESTIMATE_REV_DET.EXT_STATE_RESALE), 0.00) 
							  + ISNULL(SUM(ESTIMATE_REV_DET.EXT_COUNTY_RESALE), 0.00) 
								  AS Quoted_Tax, 0.00 AS Quoted_Total	
			FROM        V_ESTIMATEAPPR INNER JOIN
							ESTIMATE_REV_DET ON V_ESTIMATEAPPR.ESTIMATE_NUMBER = ESTIMATE_REV_DET.ESTIMATE_NUMBER AND 
							V_ESTIMATEAPPR.EST_COMPONENT_NBR = ESTIMATE_REV_DET.EST_COMPONENT_NBR AND 
							V_ESTIMATEAPPR.EST_QUOTE_NBR = ESTIMATE_REV_DET.EST_QUOTE_NBR AND 
							V_ESTIMATEAPPR.EST_REVISION_NBR = ESTIMATE_REV_DET.EST_REV_NBR INNER JOIN
						  dbo.JOB_COMPONENT ON dbo.V_ESTIMATEAPPR.JOB_NUMBER = dbo.JOB_COMPONENT.JOB_NUMBER AND 
						  dbo.V_ESTIMATEAPPR.JOB_COMPONENT_NBR = dbo.JOB_COMPONENT.JOB_COMPONENT_NBR INNER JOIN
						  dbo.JOB_LOG ON dbo.JOB_COMPONENT.JOB_NUMBER = dbo.JOB_LOG.JOB_NUMBER INNER JOIN
						  dbo.FUNCTIONS ON dbo.ESTIMATE_REV_DET.FNC_CODE = dbo.FUNCTIONS.FNC_CODE LEFT OUTER JOIN
						  dbo.FNC_HEADING ON dbo.FUNCTIONS.FNC_HEADING_ID = dbo.FNC_HEADING.FNC_HEADING_ID
			WHERE     (dbo.V_ESTIMATEAPPR.JOB_NUMBER = @jobmaster AND V_ESTIMATEAPPR.JOB_COMPONENT_NBR = @jobcompmaster)  AND (NOT (JOB_COMPONENT.JOB_PROCESS_CONTRL IN (6, 12)) ) 
			GROUP BY ESTIMATE_REV_DET.FNC_CODE, FUNCTIONS.FNC_DESCRIPTION, FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
							  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN ESTIMATE_REV_DET.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END
			ORDER BY FUNCTIONS.FNC_DESCRIPTION
		End
		
	End

	if @IncludeClosedJobs = 1
	Begin
		INSERT INTO @qva_actual
		SELECT      EMP_TIME_DTL.FNC_CODE, FUNCTIONS.FNC_DESCRIPTION, FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN EMP_TIME_DTL.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END, 
							  ISNULL(SUM(EMP_TIME_DTL.EMP_HOURS), 0.00) AS Actual_hours,
							  ISNULL(SUM(EMP_TIME_DTL.TOTAL_BILL), 0.00) AS Actual_Amount,
							  ISNULL(SUM(EMP_TIME_DTL.EXT_MARKUP_AMT), 0.00) AS Actual_Markup,
							  ISNULL(SUM(EMP_TIME_DTL.EXT_CITY_RESALE), 0.00) + ISNULL(SUM(EMP_TIME_DTL.EXT_STATE_RESALE), 0.00) + ISNULL(SUM(EMP_TIME_DTL.EXT_COUNTY_RESALE), 0.00) AS Actual_Tax, 0.00 AS Actual_Total
		FROM          dbo.EMP_TIME_DTL INNER JOIN
						  dbo.JOB_COMPONENT ON dbo.EMP_TIME_DTL.JOB_NUMBER = dbo.JOB_COMPONENT.JOB_NUMBER AND 
						  dbo.EMP_TIME_DTL.JOB_COMPONENT_NBR = dbo.JOB_COMPONENT.JOB_COMPONENT_NBR INNER JOIN
						  dbo.JOB_LOG ON dbo.JOB_COMPONENT.JOB_NUMBER = dbo.JOB_LOG.JOB_NUMBER INNER JOIN
						  dbo.FUNCTIONS ON dbo.EMP_TIME_DTL.FNC_CODE = dbo.FUNCTIONS.FNC_CODE LEFT OUTER JOIN
						  dbo.FNC_HEADING ON dbo.FUNCTIONS.FNC_HEADING_ID = dbo.FNC_HEADING.FNC_HEADING_ID	
		WHERE     (dbo.JOB_LOG.CMP_IDENTIFIER = @CampaignID) AND (EMP_TIME_DTL.EDIT_FLAG <> 1 OR EMP_TIME_DTL.EDIT_FLAG IS NULL) 
		GROUP BY dbo.EMP_TIME_DTL.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN EMP_TIME_DTL.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END
		ORDER BY dbo.FUNCTIONS.FNC_DESCRIPTION

		INSERT INTO @qva_actual
			SELECT      INCOME_ONLY.FNC_CODE, FUNCTIONS.FNC_DESCRIPTION, FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN INCOME_ONLY.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END, 
							  ISNULL(SUM(INCOME_ONLY.IO_QTY), 0.00) AS Actual_hours,
							  ISNULL(SUM(INCOME_ONLY.IO_AMOUNT), 0.00) AS Actual_Amount,
							  ISNULL(SUM(INCOME_ONLY.EXT_MARKUP_AMT), 0.00) AS Actual_Markup,
							  ISNULL(SUM(INCOME_ONLY.EXT_CITY_RESALE), 0.00) + ISNULL(SUM(INCOME_ONLY.EXT_STATE_RESALE), 0.00) + ISNULL(SUM(INCOME_ONLY.EXT_COUNTY_RESALE), 0.00) AS Actual_Tax, 0.00 AS Actual_Total
		FROM         dbo.INCOME_ONLY INNER JOIN
						  dbo.JOB_COMPONENT ON dbo.INCOME_ONLY.JOB_NUMBER = dbo.JOB_COMPONENT.JOB_NUMBER AND 
						  dbo.INCOME_ONLY.JOB_COMPONENT_NBR = dbo.JOB_COMPONENT.JOB_COMPONENT_NBR INNER JOIN
						  dbo.JOB_LOG ON dbo.JOB_COMPONENT.JOB_NUMBER = dbo.JOB_LOG.JOB_NUMBER INNER JOIN
						  dbo.FUNCTIONS ON dbo.INCOME_ONLY.FNC_CODE = dbo.FUNCTIONS.FNC_CODE LEFT OUTER JOIN
						  dbo.FNC_HEADING ON dbo.FUNCTIONS.FNC_HEADING_ID = dbo.FNC_HEADING.FNC_HEADING_ID	
		WHERE     (dbo.JOB_LOG.CMP_IDENTIFIER = @CampaignID)
		GROUP BY dbo.INCOME_ONLY.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN INCOME_ONLY.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END
		ORDER BY dbo.FUNCTIONS.FNC_DESCRIPTION	

		INSERT INTO @qva_actual
			SELECT      AP_PRODUCTION.FNC_CODE, FUNCTIONS.FNC_DESCRIPTION, FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN AP_PRODUCTION.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END, 
							  ISNULL(SUM(AP_PRODUCTION.AP_PROD_QUANTITY), 0.00) AS Actual_hours,
							  ISNULL(SUM(AP_PRODUCTION.AP_PROD_EXT_AMT), 0.00) + ISNULL(SUM(AP_PRODUCTION.EXT_NONRESALE_TAX), 0.00) AS Actual_Amount,
							  ISNULL(SUM(AP_PRODUCTION.EXT_MARKUP_AMT), 0.00) AS Actual_Markup,
							  ISNULL(SUM(AP_PRODUCTION.EXT_CITY_RESALE), 0.00) + ISNULL(SUM(AP_PRODUCTION.EXT_STATE_RESALE), 0.00) + ISNULL(SUM(AP_PRODUCTION.EXT_COUNTY_RESALE), 0.00) AS Actual_Tax, 0.00 AS Actual_Total
		FROM         dbo.AP_PRODUCTION INNER JOIN
						  dbo.JOB_COMPONENT ON dbo.AP_PRODUCTION.JOB_NUMBER = dbo.JOB_COMPONENT.JOB_NUMBER AND 
						  dbo.AP_PRODUCTION.JOB_COMPONENT_NBR = dbo.JOB_COMPONENT.JOB_COMPONENT_NBR INNER JOIN
						  dbo.JOB_LOG ON dbo.JOB_COMPONENT.JOB_NUMBER = dbo.JOB_LOG.JOB_NUMBER INNER JOIN
						  dbo.FUNCTIONS ON dbo.AP_PRODUCTION.FNC_CODE = dbo.FUNCTIONS.FNC_CODE LEFT OUTER JOIN
						  dbo.FNC_HEADING ON dbo.FUNCTIONS.FNC_HEADING_ID = dbo.FNC_HEADING.FNC_HEADING_ID	
		WHERE     (dbo.JOB_LOG.CMP_IDENTIFIER = @CampaignID) 
		GROUP BY dbo.AP_PRODUCTION.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN AP_PRODUCTION.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END
		ORDER BY dbo.FUNCTIONS.FNC_DESCRIPTION

		INSERT INTO @qva_actual
			SELECT      CLIENT_OOP.FNC_CODE, FUNCTIONS.FNC_DESCRIPTION, FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN CLIENT_OOP.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END, 
							  0.00 AS Actual_hours,
							  ISNULL(SUM(CLIENT_OOP.AMOUNT), 0.00) AS Actual_Amount,
							  0.00 AS Actual_Markup,
							  0.00 AS Actual_Tax, 0.00 AS Actual_Total
		FROM         dbo.CLIENT_OOP INNER JOIN
						  dbo.JOB_COMPONENT ON dbo.CLIENT_OOP.JOB_NUMBER = dbo.JOB_COMPONENT.JOB_NUMBER AND 
						  dbo.CLIENT_OOP.JOB_COMPONENT_NBR = dbo.JOB_COMPONENT.JOB_COMPONENT_NBR INNER JOIN
						  dbo.JOB_LOG ON dbo.JOB_COMPONENT.JOB_NUMBER = dbo.JOB_LOG.JOB_NUMBER INNER JOIN
						  dbo.FUNCTIONS ON dbo.CLIENT_OOP.FNC_CODE = dbo.FUNCTIONS.FNC_CODE LEFT OUTER JOIN
						  dbo.FNC_HEADING ON dbo.FUNCTIONS.FNC_HEADING_ID = dbo.FNC_HEADING.FNC_HEADING_ID	
		WHERE     (dbo.JOB_LOG.CMP_IDENTIFIER = @CampaignID) 
		GROUP BY dbo.CLIENT_OOP.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN CLIENT_OOP.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END
		ORDER BY dbo.FUNCTIONS.FNC_DESCRIPTION

		--INSERT INTO @qva_Billed
		--	SELECT     dbo.V_QUOTE_VS_ACTUAL.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
		--				  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN V_QUOTE_VS_ACTUAL.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END, 0.00,
		--					  CASE WHEN FUNCTIONS.FNC_TYPE = 'E' THEN ISNULL(SUM(EMP_TIME_DTL.LINE_TOTAL), 0.00) 
		--						   WHEN FUNCTIONS.FNC_TYPE = 'I' THEN ISNULL(SUM(INCOME_ONLY.LINE_TOTAL), 0.00) 
		--						   WHEN FUNCTIONS.FNC_TYPE = 'V' THEN ISNULL(SUM(AP_PRODUCTION.LINE_TOTAL), 0.00) 
		--					       WHEN FUNCTIONS.FNC_TYPE = 'C' THEN 0.00 END AS Billed_to_Date
		--	FROM         dbo.FUNCTIONS INNER JOIN
		--						  dbo.V_QUOTE_VS_ACTUAL ON dbo.FUNCTIONS.FNC_CODE = dbo.V_QUOTE_VS_ACTUAL.FNC_CODE INNER JOIN
		--						  dbo.JOB_COMPONENT ON dbo.V_QUOTE_VS_ACTUAL.JOB_NUMBER = dbo.JOB_COMPONENT.JOB_NUMBER AND 
		--						  dbo.V_QUOTE_VS_ACTUAL.JOB_COMPONENT_NBR = dbo.JOB_COMPONENT.JOB_COMPONENT_NBR LEFT OUTER JOIN
		--						  dbo.EMP_TIME_DTL ON dbo.V_QUOTE_VS_ACTUAL.FNC_CODE = dbo.EMP_TIME_DTL.FNC_CODE AND 
		--						  dbo.JOB_COMPONENT.JOB_NUMBER = dbo.EMP_TIME_DTL.JOB_NUMBER AND 
		--						  dbo.JOB_COMPONENT.JOB_COMPONENT_NBR = dbo.EMP_TIME_DTL.JOB_COMPONENT_NBR LEFT OUTER JOIN
		--						  dbo.INCOME_ONLY ON dbo.V_QUOTE_VS_ACTUAL.FNC_CODE = dbo.INCOME_ONLY.FNC_CODE AND 
		--						  dbo.JOB_COMPONENT.JOB_NUMBER = dbo.INCOME_ONLY.JOB_NUMBER AND 
		--						  dbo.JOB_COMPONENT.JOB_COMPONENT_NBR = dbo.INCOME_ONLY.JOB_COMPONENT_NBR LEFT OUTER JOIN
		--						  dbo.AP_PRODUCTION ON dbo.V_QUOTE_VS_ACTUAL.FNC_CODE = dbo.AP_PRODUCTION.FNC_CODE AND 
		--						  dbo.JOB_COMPONENT.JOB_NUMBER = dbo.AP_PRODUCTION.JOB_NUMBER AND 
		--						  dbo.JOB_COMPONENT.JOB_COMPONENT_NBR = dbo.AP_PRODUCTION.JOB_COMPONENT_NBR LEFT OUTER JOIN
		--					      FNC_HEADING ON FUNCTIONS.FNC_HEADING_ID = FNC_HEADING.FNC_HEADING_ID INNER JOIN
		--						  JOB_LOG ON JOB_LOG.JOB_NUMBER = JOB_COMPONENT.JOB_NUMBER
		--						  --#job ON V_QUOTE_VS_ACTUAL.JOB_NUMBER = #job.JobNo AND V_QUOTE_VS_ACTUAL.JOB_COMPONENT_NBR = #job.JobCompNo
		--	WHERE     (dbo.JOB_LOG.CMP_IDENTIFIER = 1960) AND 
		--				((dbo.EMP_TIME_DTL.AR_INV_NBR IS NOT NULL OR dbo.EMP_TIME_DTL.AB_FLAG = 3) OR (dbo.INCOME_ONLY.AR_INV_NBR IS NOT NULL OR dbo.INCOME_ONLY.AB_FLAG = 3) OR (dbo.AP_PRODUCTION.AR_INV_NBR IS NOT NULL OR dbo.AP_PRODUCTION.AB_FLAG = 3))
		--	GROUP BY dbo.V_QUOTE_VS_ACTUAL.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
		--				  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN V_QUOTE_VS_ACTUAL.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END                     
		--	ORDER BY dbo.FUNCTIONS.FNC_DESCRIPTION

		INSERT INTO @qva_Billed
			SELECT     dbo.EMP_TIME_DTL.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN EMP_TIME_DTL.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END, 0.00,
							  CASE WHEN FUNCTIONS.FNC_TYPE = 'E' THEN ISNULL(SUM(EMP_TIME_DTL.LINE_TOTAL), 0.00) 
							  WHEN FUNCTIONS.FNC_TYPE = 'C' THEN 0.00 END AS Billed_to_Date
			FROM         dbo.EMP_TIME_DTL INNER JOIN
						  dbo.JOB_COMPONENT ON dbo.EMP_TIME_DTL.JOB_NUMBER = dbo.JOB_COMPONENT.JOB_NUMBER AND 
						  dbo.EMP_TIME_DTL.JOB_COMPONENT_NBR = dbo.JOB_COMPONENT.JOB_COMPONENT_NBR INNER JOIN
						  dbo.JOB_LOG ON dbo.JOB_COMPONENT.JOB_NUMBER = dbo.JOB_LOG.JOB_NUMBER INNER JOIN
						  dbo.FUNCTIONS ON dbo.EMP_TIME_DTL.FNC_CODE = dbo.FUNCTIONS.FNC_CODE LEFT OUTER JOIN
						  dbo.FNC_HEADING ON dbo.FUNCTIONS.FNC_HEADING_ID = dbo.FNC_HEADING.FNC_HEADING_ID	
			WHERE     (dbo.JOB_LOG.CMP_IDENTIFIER = @CampaignID) AND (dbo.EMP_TIME_DTL.AR_INV_NBR IS NOT NULL OR dbo.EMP_TIME_DTL.AB_FLAG = 3) AND (EMP_TIME_DTL.EDIT_FLAG <> 1 OR EMP_TIME_DTL.EDIT_FLAG IS NULL)
			GROUP BY dbo.EMP_TIME_DTL.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN EMP_TIME_DTL.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END                     
			ORDER BY dbo.FUNCTIONS.FNC_DESCRIPTION

		INSERT INTO @qva_Billed
			SELECT     dbo.INCOME_ONLY.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN INCOME_ONLY.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END, 0.00,
								  CASE WHEN FUNCTIONS.FNC_TYPE = 'I' THEN ISNULL(SUM(INCOME_ONLY.LINE_TOTAL), 0.00) 
								  WHEN FUNCTIONS.FNC_TYPE = 'C' THEN 0.00 END AS Billed_to_Date
			FROM         dbo.INCOME_ONLY INNER JOIN
						  dbo.JOB_COMPONENT ON dbo.INCOME_ONLY.JOB_NUMBER = dbo.JOB_COMPONENT.JOB_NUMBER AND 
						  dbo.INCOME_ONLY.JOB_COMPONENT_NBR = dbo.JOB_COMPONENT.JOB_COMPONENT_NBR INNER JOIN
						  dbo.JOB_LOG ON dbo.JOB_COMPONENT.JOB_NUMBER = dbo.JOB_LOG.JOB_NUMBER INNER JOIN
						  dbo.FUNCTIONS ON dbo.INCOME_ONLY.FNC_CODE = dbo.FUNCTIONS.FNC_CODE LEFT OUTER JOIN
						  dbo.FNC_HEADING ON dbo.FUNCTIONS.FNC_HEADING_ID = dbo.FNC_HEADING.FNC_HEADING_ID	
			WHERE     (dbo.JOB_LOG.CMP_IDENTIFIER = @CampaignID) AND (dbo.INCOME_ONLY.AR_INV_NBR IS NOT NULL OR dbo.INCOME_ONLY.AB_FLAG = 3)
			GROUP BY dbo.INCOME_ONLY.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN INCOME_ONLY.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END                    
			ORDER BY dbo.FUNCTIONS.FNC_DESCRIPTION

		INSERT INTO @qva_Billed
			SELECT     dbo.AP_PRODUCTION.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN AP_PRODUCTION.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END, 0.00,
								  CASE WHEN FUNCTIONS.FNC_TYPE = 'V' THEN ISNULL(SUM(AP_PRODUCTION.LINE_TOTAL), 0.00) 
								  WHEN FUNCTIONS.FNC_TYPE = 'C' THEN 0.00 END AS Billed_to_Date
			FROM         dbo.AP_PRODUCTION INNER JOIN
						  dbo.JOB_COMPONENT ON dbo.AP_PRODUCTION.JOB_NUMBER = dbo.JOB_COMPONENT.JOB_NUMBER AND 
						  dbo.AP_PRODUCTION.JOB_COMPONENT_NBR = dbo.JOB_COMPONENT.JOB_COMPONENT_NBR INNER JOIN
						  dbo.JOB_LOG ON dbo.JOB_COMPONENT.JOB_NUMBER = dbo.JOB_LOG.JOB_NUMBER INNER JOIN
						  dbo.FUNCTIONS ON dbo.AP_PRODUCTION.FNC_CODE = dbo.FUNCTIONS.FNC_CODE LEFT OUTER JOIN
						  dbo.FNC_HEADING ON dbo.FUNCTIONS.FNC_HEADING_ID = dbo.FNC_HEADING.FNC_HEADING_ID	
			WHERE      (dbo.JOB_LOG.CMP_IDENTIFIER = @CampaignID) AND (dbo.AP_PRODUCTION.AR_INV_NBR IS NOT NULL OR dbo.AP_PRODUCTION.AB_FLAG = 3)
			GROUP BY dbo.AP_PRODUCTION.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN AP_PRODUCTION.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END                     
			ORDER BY dbo.FUNCTIONS.FNC_DESCRIPTION

		INSERT INTO @qva_AdvBilled
			SELECT     dbo.ADVANCE_BILLING.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN ADVANCE_BILLING.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END,0.00,0.00,
							  ISNULL(SUM(ADVANCE_BILLING.LINE_TOTAL), 0.00) AS Adv_Billed, 0.00,0.00,0.00,0.00,0.00,0.00
			FROM         dbo.ADVANCE_BILLING INNER JOIN
						  dbo.JOB_COMPONENT ON dbo.ADVANCE_BILLING.JOB_NUMBER = dbo.JOB_COMPONENT.JOB_NUMBER AND 
						  dbo.ADVANCE_BILLING.JOB_COMPONENT_NBR = dbo.JOB_COMPONENT.JOB_COMPONENT_NBR INNER JOIN
						  dbo.JOB_LOG ON dbo.JOB_COMPONENT.JOB_NUMBER = dbo.JOB_LOG.JOB_NUMBER INNER JOIN
						  dbo.FUNCTIONS ON dbo.ADVANCE_BILLING.FNC_CODE = dbo.FUNCTIONS.FNC_CODE LEFT OUTER JOIN
						  dbo.FNC_HEADING ON dbo.FUNCTIONS.FNC_HEADING_ID = dbo.FNC_HEADING.FNC_HEADING_ID		  
			WHERE     (dbo.JOB_LOG.CMP_IDENTIFIER = @CampaignID) AND (dbo.ADVANCE_BILLING.AR_INV_NBR IS NOT NULL OR dbo.ADVANCE_BILLING.AB_FLAG = 3)
			GROUP BY dbo.ADVANCE_BILLING.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN ADVANCE_BILLING.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END                     
			ORDER BY dbo.FUNCTIONS.FNC_DESCRIPTION

		INSERT INTO @qva_POtotal
			SELECT     dbo.PURCHASE_ORDER_DET.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN PURCHASE_ORDER_DET.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END, 
							  CASE WHEN FUNCTIONS.FNC_TYPE = 'V' THEN ISNULL(SUM(dbo.PURCHASE_ORDER_DET.PO_EXT_AMOUNT), 0.00)
								ELSE 0.00 END AS PO_Total
			FROM       dbo.PURCHASE_ORDER_DET INNER JOIN
						  dbo.JOB_COMPONENT ON dbo.PURCHASE_ORDER_DET.JOB_NUMBER = dbo.JOB_COMPONENT.JOB_NUMBER AND 
						  dbo.PURCHASE_ORDER_DET.JOB_COMPONENT_NBR = dbo.JOB_COMPONENT.JOB_COMPONENT_NBR INNER JOIN
						  dbo.JOB_LOG ON dbo.JOB_COMPONENT.JOB_NUMBER = dbo.JOB_LOG.JOB_NUMBER INNER JOIN
						  dbo.FUNCTIONS ON dbo.PURCHASE_ORDER_DET.FNC_CODE = dbo.FUNCTIONS.FNC_CODE LEFT OUTER JOIN
						  dbo.FNC_HEADING ON dbo.FUNCTIONS.FNC_HEADING_ID = dbo.FNC_HEADING.FNC_HEADING_ID INNER JOIN
						  dbo.PURCHASE_ORDER ON dbo.PURCHASE_ORDER_DET.PO_NUMBER = dbo.PURCHASE_ORDER.PO_NUMBER	
			WHERE     (dbo.JOB_LOG.CMP_IDENTIFIER = @CampaignID) AND (PURCHASE_ORDER_DET.PO_COMPLETE IS NULL OR PURCHASE_ORDER_DET.PO_COMPLETE = 0) AND (PURCHASE_ORDER.VOID_FLAG IS NULL OR PURCHASE_ORDER.VOID_FLAG = 0)
			GROUP BY dbo.PURCHASE_ORDER_DET.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN PURCHASE_ORDER_DET.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END                      
			ORDER BY dbo.FUNCTIONS.FNC_DESCRIPTION

		INSERT INTO @qva_POapplied
			SELECT     dbo.PURCHASE_ORDER_DET.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN PURCHASE_ORDER_DET.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END, 
							  CASE WHEN FUNCTIONS.FNC_TYPE = 'V' THEN ISNULL(SUM(dbo.AP_PRODUCTION.AP_PROD_EXT_AMT), 0.00)
								ELSE 0.00 END AS PO_Applied
			FROM       dbo.PURCHASE_ORDER_DET INNER JOIN
						  dbo.JOB_COMPONENT ON dbo.PURCHASE_ORDER_DET.JOB_NUMBER = dbo.JOB_COMPONENT.JOB_NUMBER AND 
						  dbo.PURCHASE_ORDER_DET.JOB_COMPONENT_NBR = dbo.JOB_COMPONENT.JOB_COMPONENT_NBR INNER JOIN
						  dbo.JOB_LOG ON dbo.JOB_COMPONENT.JOB_NUMBER = dbo.JOB_LOG.JOB_NUMBER INNER JOIN
						  dbo.FUNCTIONS ON dbo.PURCHASE_ORDER_DET.FNC_CODE = dbo.FUNCTIONS.FNC_CODE INNER JOIN
						  dbo.AP_PRODUCTION ON dbo.PURCHASE_ORDER_DET.PO_NUMBER = dbo.AP_PRODUCTION.PO_NUMBER AND 
						  dbo.PURCHASE_ORDER_DET.LINE_NUMBER = dbo.AP_PRODUCTION.PO_LINE_NUMBER LEFT OUTER JOIN
						  dbo.FNC_HEADING ON dbo.FUNCTIONS.FNC_HEADING_ID = dbo.FNC_HEADING.FNC_HEADING_ID
			WHERE     (dbo.JOB_LOG.CMP_IDENTIFIER = @CampaignID) AND (PURCHASE_ORDER_DET.PO_COMPLETE = 0 OR PURCHASE_ORDER_DET.PO_COMPLETE IS NULL) AND
						(AP_PRODUCTION.DELETE_FLAG IS NULL OR AP_PRODUCTION.DELETE_FLAG = 0) 
			GROUP BY dbo.PURCHASE_ORDER_DET.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN PURCHASE_ORDER_DET.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END
			ORDER BY dbo.FUNCTIONS.FNC_DESCRIPTION

		--INSERT INTO @qva_NB
		--	SELECT     dbo.V_QUOTE_VS_ACTUAL.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
		--				  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN V_QUOTE_VS_ACTUAL.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END, 
		--					  CASE WHEN FUNCTIONS.FNC_TYPE = 'E' THEN ISNULL(SUM(EMP_TIME_DTL.EXT_CITY_RESALE), 0.00) + ISNULL(SUM(EMP_TIME_DTL.EXT_STATE_RESALE), 0.00) + ISNULL(SUM(EMP_TIME_DTL.EXT_COUNTY_RESALE), 0.00)
		--					       WHEN FUNCTIONS.FNC_TYPE = 'I' THEN ISNULL(SUM(INCOME_ONLY.EXT_CITY_RESALE), 0.00) + ISNULL(SUM(INCOME_ONLY.EXT_STATE_RESALE), 0.00) + ISNULL(SUM(INCOME_ONLY.EXT_COUNTY_RESALE), 0.00)
		--					       WHEN FUNCTIONS.FNC_TYPE = 'V' THEN ISNULL(SUM(AP_PRODUCTION.EXT_CITY_RESALE), 0.00) + ISNULL(SUM(AP_PRODUCTION.EXT_STATE_RESALE), 0.00) + ISNULL(SUM(AP_PRODUCTION.EXT_COUNTY_RESALE), 0.00)
		--					       WHEN FUNCTIONS.FNC_TYPE = 'C' THEN 0.00 END AS NB_Tax,
		--					  CASE WHEN FUNCTIONS.FNC_TYPE = 'E' THEN ISNULL(SUM(EMP_TIME_DTL.EXT_MARKUP_AMT), 0.00)
		--						   WHEN FUNCTIONS.FNC_TYPE = 'I' THEN ISNULL(SUM(INCOME_ONLY.EXT_MARKUP_AMT), 0.00)
		--						   WHEN FUNCTIONS.FNC_TYPE = 'V' THEN ISNULL(SUM(AP_PRODUCTION.EXT_MARKUP_AMT), 0.00)
		--					       WHEN FUNCTIONS.FNC_TYPE = 'C' THEN 0.00 END AS NB_Markup,	
		--					  CASE WHEN FUNCTIONS.FNC_TYPE = 'E' THEN ISNULL(SUM(EMP_TIME_DTL.TOTAL_BILL), 0.00)
		--					       WHEN FUNCTIONS.FNC_TYPE = 'I' THEN ISNULL(SUM(INCOME_ONLY.IO_AMOUNT), 0.00)
		--					       WHEN FUNCTIONS.FNC_TYPE = 'V' THEN ISNULL(SUM(AP_PRODUCTION.AP_PROD_EXT_AMT), 0.00)
		--					       WHEN FUNCTIONS.FNC_TYPE = 'C' THEN 0.00 END AS NB_Amount,
		--					  CASE WHEN FUNCTIONS.FNC_TYPE = 'E' THEN ISNULL(SUM(EMP_TIME_DTL.EMP_HOURS), 0.00)
		--					       WHEN FUNCTIONS.FNC_TYPE = 'I' THEN ISNULL(SUM(INCOME_ONLY.IO_QTY), 0.00)
		--					       WHEN FUNCTIONS.FNC_TYPE = 'V' THEN ISNULL(SUM(AP_PRODUCTION.AP_PROD_QUANTITY), 0.00)
		--					       WHEN FUNCTIONS.FNC_TYPE = 'C' THEN 0.00 END AS NB_Hours	
		--	FROM         dbo.FUNCTIONS INNER JOIN
		--						  dbo.V_QUOTE_VS_ACTUAL ON dbo.FUNCTIONS.FNC_CODE = dbo.V_QUOTE_VS_ACTUAL.FNC_CODE INNER JOIN
		--						  dbo.JOB_COMPONENT ON dbo.V_QUOTE_VS_ACTUAL.JOB_NUMBER = dbo.JOB_COMPONENT.JOB_NUMBER AND 
		--						  dbo.V_QUOTE_VS_ACTUAL.JOB_COMPONENT_NBR = dbo.JOB_COMPONENT.JOB_COMPONENT_NBR LEFT OUTER JOIN
		--						  dbo.EMP_TIME_DTL ON dbo.V_QUOTE_VS_ACTUAL.FNC_CODE = dbo.EMP_TIME_DTL.FNC_CODE AND 
		--						  dbo.JOB_COMPONENT.JOB_NUMBER = dbo.EMP_TIME_DTL.JOB_NUMBER AND 
		--						  dbo.JOB_COMPONENT.JOB_COMPONENT_NBR = dbo.EMP_TIME_DTL.JOB_COMPONENT_NBR LEFT OUTER JOIN
		--						  dbo.INCOME_ONLY ON dbo.V_QUOTE_VS_ACTUAL.FNC_CODE = dbo.INCOME_ONLY.FNC_CODE AND 
		--						  dbo.JOB_COMPONENT.JOB_NUMBER = dbo.INCOME_ONLY.JOB_NUMBER AND 
		--						  dbo.JOB_COMPONENT.JOB_COMPONENT_NBR = dbo.INCOME_ONLY.JOB_COMPONENT_NBR LEFT OUTER JOIN
		--						  dbo.AP_PRODUCTION ON dbo.V_QUOTE_VS_ACTUAL.FNC_CODE = dbo.AP_PRODUCTION.FNC_CODE AND 
		--						  dbo.JOB_COMPONENT.JOB_NUMBER = dbo.AP_PRODUCTION.JOB_NUMBER AND 
		--						  dbo.JOB_COMPONENT.JOB_COMPONENT_NBR = dbo.AP_PRODUCTION.JOB_COMPONENT_NBR LEFT OUTER JOIN
		--					      FNC_HEADING ON FUNCTIONS.FNC_HEADING_ID = FNC_HEADING.FNC_HEADING_ID INNER JOIN
		--						  JOB_LOG ON JOB_LOG.JOB_NUMBER = JOB_COMPONENT.JOB_NUMBER
		--						  --#job ON V_QUOTE_VS_ACTUAL.JOB_NUMBER = #job.JobNo AND V_QUOTE_VS_ACTUAL.JOB_COMPONENT_NBR = #job.JobCompNo 
		--	WHERE     (dbo.JOB_LOG.CMP_IDENTIFIER = 1960) AND ((dbo.EMP_TIME_DTL.EMP_NON_BILL_FLAG = 1) OR (dbo.INCOME_ONLY.NON_BILL_FLAG = 1) OR (dbo.AP_PRODUCTION.AP_PROD_NOBILL_FLG = 1))
		--	GROUP BY dbo.V_QUOTE_VS_ACTUAL.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
		--				  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN V_QUOTE_VS_ACTUAL.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END                     
		--	ORDER BY dbo.FUNCTIONS.FNC_DESCRIPTION

		INSERT INTO @qva_NB
			SELECT     dbo.EMP_TIME_DTL.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN EMP_TIME_DTL.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END, 
							  CASE WHEN FUNCTIONS.FNC_TYPE = 'E' THEN ISNULL(SUM(EMP_TIME_DTL.EXT_CITY_RESALE), 0.00) + ISNULL(SUM(EMP_TIME_DTL.EXT_STATE_RESALE), 0.00) + ISNULL(SUM(EMP_TIME_DTL.EXT_COUNTY_RESALE), 0.00)
							  WHEN FUNCTIONS.FNC_TYPE = 'C' THEN 0.00 END AS NB_Tax,
							  CASE WHEN FUNCTIONS.FNC_TYPE = 'E' THEN ISNULL(SUM(EMP_TIME_DTL.EXT_MARKUP_AMT), 0.00)
							  WHEN FUNCTIONS.FNC_TYPE = 'C' THEN 0.00 END AS NB_Markup,	
							  CASE WHEN FUNCTIONS.FNC_TYPE = 'E' THEN ISNULL(SUM(EMP_TIME_DTL.TOTAL_BILL), 0.00)
							  WHEN FUNCTIONS.FNC_TYPE = 'C' THEN 0.00 END AS NB_Amount,
							  CASE WHEN FUNCTIONS.FNC_TYPE = 'E' THEN ISNULL(SUM(EMP_TIME_DTL.EMP_HOURS), 0.00)
							  WHEN FUNCTIONS.FNC_TYPE = 'C' THEN 0.00 END AS NB_Hours	
			FROM        dbo.EMP_TIME_DTL INNER JOIN
						  dbo.JOB_COMPONENT ON dbo.EMP_TIME_DTL.JOB_NUMBER = dbo.JOB_COMPONENT.JOB_NUMBER AND 
						  dbo.EMP_TIME_DTL.JOB_COMPONENT_NBR = dbo.JOB_COMPONENT.JOB_COMPONENT_NBR INNER JOIN
						  dbo.JOB_LOG ON dbo.JOB_COMPONENT.JOB_NUMBER = dbo.JOB_LOG.JOB_NUMBER INNER JOIN
						  dbo.FUNCTIONS ON dbo.EMP_TIME_DTL.FNC_CODE = dbo.FUNCTIONS.FNC_CODE LEFT OUTER JOIN
						  dbo.FNC_HEADING ON dbo.FUNCTIONS.FNC_HEADING_ID = dbo.FNC_HEADING.FNC_HEADING_ID	
			WHERE     (dbo.JOB_LOG.CMP_IDENTIFIER = @CampaignID) AND (dbo.EMP_TIME_DTL.EMP_NON_BILL_FLAG = 1) 
			GROUP BY dbo.EMP_TIME_DTL.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN EMP_TIME_DTL.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END                     
			ORDER BY dbo.FUNCTIONS.FNC_DESCRIPTION
		INSERT INTO @qva_NB
			SELECT     dbo.INCOME_ONLY.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN INCOME_ONLY.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END, 
								  CASE WHEN FUNCTIONS.FNC_TYPE = 'I' THEN ISNULL(SUM(INCOME_ONLY.EXT_CITY_RESALE), 0.00) + ISNULL(SUM(INCOME_ONLY.EXT_STATE_RESALE), 0.00) + ISNULL(SUM(INCOME_ONLY.EXT_COUNTY_RESALE), 0.00) 
								  WHEN FUNCTIONS.FNC_TYPE = 'C' THEN 0.00 END AS NB_Tax,
								  CASE WHEN FUNCTIONS.FNC_TYPE = 'I' THEN ISNULL(SUM(INCOME_ONLY.EXT_MARKUP_AMT), 0.00)
								  WHEN FUNCTIONS.FNC_TYPE = 'C' THEN 0.00 END AS NB_Markup,	
								  CASE WHEN FUNCTIONS.FNC_TYPE = 'I' THEN ISNULL(SUM(INCOME_ONLY.IO_AMOUNT), 0.00)
								  WHEN FUNCTIONS.FNC_TYPE = 'C' THEN 0.00 END AS NB_Amount,
								  CASE WHEN FUNCTIONS.FNC_TYPE = 'I' THEN ISNULL(SUM(INCOME_ONLY.IO_QTY), 0.00)
								  WHEN FUNCTIONS.FNC_TYPE = 'C' THEN 0.00 END AS NB_Hours
			FROM         dbo.INCOME_ONLY INNER JOIN
						  dbo.JOB_COMPONENT ON dbo.INCOME_ONLY.JOB_NUMBER = dbo.JOB_COMPONENT.JOB_NUMBER AND 
						  dbo.INCOME_ONLY.JOB_COMPONENT_NBR = dbo.JOB_COMPONENT.JOB_COMPONENT_NBR INNER JOIN
						  dbo.JOB_LOG ON dbo.JOB_COMPONENT.JOB_NUMBER = dbo.JOB_LOG.JOB_NUMBER INNER JOIN
						  dbo.FUNCTIONS ON dbo.INCOME_ONLY.FNC_CODE = dbo.FUNCTIONS.FNC_CODE LEFT OUTER JOIN
						  dbo.FNC_HEADING ON dbo.FUNCTIONS.FNC_HEADING_ID = dbo.FNC_HEADING.FNC_HEADING_ID	
			WHERE     (dbo.JOB_LOG.CMP_IDENTIFIER = @CampaignID) AND (dbo.INCOME_ONLY.NON_BILL_FLAG = 1)  
			GROUP BY dbo.INCOME_ONLY.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN INCOME_ONLY.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END                     
			ORDER BY dbo.FUNCTIONS.FNC_DESCRIPTION
		INSERT INTO @qva_NB
			SELECT     dbo.AP_PRODUCTION.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN AP_PRODUCTION.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END, 
								  CASE WHEN FUNCTIONS.FNC_TYPE = 'V' THEN ISNULL(SUM(AP_PRODUCTION.EXT_CITY_RESALE), 0.00) + ISNULL(SUM(AP_PRODUCTION.EXT_STATE_RESALE), 0.00) + ISNULL(SUM(AP_PRODUCTION.EXT_COUNTY_RESALE), 0.00)
								  WHEN FUNCTIONS.FNC_TYPE = 'C' THEN 0.00 END AS NB_Tax,
								  CASE WHEN FUNCTIONS.FNC_TYPE = 'V' THEN ISNULL(SUM(AP_PRODUCTION.EXT_MARKUP_AMT), 0.00)
								  WHEN FUNCTIONS.FNC_TYPE = 'C' THEN 0.00 END AS NB_Markup,
								  CASE WHEN FUNCTIONS.FNC_TYPE = 'V' THEN ISNULL(SUM(AP_PRODUCTION.AP_PROD_EXT_AMT), 0.00)
								  WHEN FUNCTIONS.FNC_TYPE = 'C' THEN 0.00 END AS NB_Amount,
								  CASE WHEN FUNCTIONS.FNC_TYPE = 'V' THEN ISNULL(SUM(AP_PRODUCTION.AP_PROD_QUANTITY), 0.00)
								  WHEN FUNCTIONS.FNC_TYPE = 'C' THEN 0.00 END AS NB_Hours
			FROM         dbo.AP_PRODUCTION INNER JOIN
						  dbo.JOB_COMPONENT ON dbo.AP_PRODUCTION.JOB_NUMBER = dbo.JOB_COMPONENT.JOB_NUMBER AND 
						  dbo.AP_PRODUCTION.JOB_COMPONENT_NBR = dbo.JOB_COMPONENT.JOB_COMPONENT_NBR INNER JOIN
						  dbo.JOB_LOG ON dbo.JOB_COMPONENT.JOB_NUMBER = dbo.JOB_LOG.JOB_NUMBER INNER JOIN
						  dbo.FUNCTIONS ON dbo.AP_PRODUCTION.FNC_CODE = dbo.FUNCTIONS.FNC_CODE LEFT OUTER JOIN
						  dbo.FNC_HEADING ON dbo.FUNCTIONS.FNC_HEADING_ID = dbo.FNC_HEADING.FNC_HEADING_ID	
			WHERE     (dbo.JOB_LOG.CMP_IDENTIFIER = @CampaignID) AND (dbo.AP_PRODUCTION.AP_PROD_NOBILL_FLG = 1)
			GROUP BY dbo.AP_PRODUCTION.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN AP_PRODUCTION.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END                     
			ORDER BY dbo.FUNCTIONS.FNC_DESCRIPTION
	End
	Else
	Begin
		INSERT INTO @qva_actual
		SELECT      EMP_TIME_DTL.FNC_CODE, FUNCTIONS.FNC_DESCRIPTION, FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN EMP_TIME_DTL.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END, 
							  ISNULL(SUM(EMP_TIME_DTL.EMP_HOURS), 0.00) AS Actual_hours,
							  ISNULL(SUM(EMP_TIME_DTL.TOTAL_BILL), 0.00) AS Actual_Amount,
							  ISNULL(SUM(EMP_TIME_DTL.EXT_MARKUP_AMT), 0.00) AS Actual_Markup,
							  ISNULL(SUM(EMP_TIME_DTL.EXT_CITY_RESALE), 0.00) + ISNULL(SUM(EMP_TIME_DTL.EXT_STATE_RESALE), 0.00) + ISNULL(SUM(EMP_TIME_DTL.EXT_COUNTY_RESALE), 0.00) AS Actual_Tax, 0.00 AS Actual_Total
		FROM          dbo.EMP_TIME_DTL INNER JOIN
						  dbo.JOB_COMPONENT ON dbo.EMP_TIME_DTL.JOB_NUMBER = dbo.JOB_COMPONENT.JOB_NUMBER AND 
						  dbo.EMP_TIME_DTL.JOB_COMPONENT_NBR = dbo.JOB_COMPONENT.JOB_COMPONENT_NBR INNER JOIN
						  dbo.JOB_LOG ON dbo.JOB_COMPONENT.JOB_NUMBER = dbo.JOB_LOG.JOB_NUMBER INNER JOIN
						  dbo.FUNCTIONS ON dbo.EMP_TIME_DTL.FNC_CODE = dbo.FUNCTIONS.FNC_CODE LEFT OUTER JOIN
						  dbo.FNC_HEADING ON dbo.FUNCTIONS.FNC_HEADING_ID = dbo.FNC_HEADING.FNC_HEADING_ID	
		WHERE     (dbo.JOB_LOG.CMP_IDENTIFIER = @CampaignID) AND (NOT (JOB_COMPONENT.JOB_PROCESS_CONTRL IN (6, 12))) AND (EMP_TIME_DTL.EDIT_FLAG <> 1 OR EMP_TIME_DTL.EDIT_FLAG IS NULL)
		GROUP BY dbo.EMP_TIME_DTL.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN EMP_TIME_DTL.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END
		ORDER BY dbo.FUNCTIONS.FNC_DESCRIPTION

		INSERT INTO @qva_actual
			SELECT      INCOME_ONLY.FNC_CODE, FUNCTIONS.FNC_DESCRIPTION, FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN INCOME_ONLY.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END, 
							  ISNULL(SUM(INCOME_ONLY.IO_QTY), 0.00) AS Actual_hours,
							  ISNULL(SUM(INCOME_ONLY.IO_AMOUNT), 0.00) AS Actual_Amount,
							  ISNULL(SUM(INCOME_ONLY.EXT_MARKUP_AMT), 0.00) AS Actual_Markup,
							  ISNULL(SUM(INCOME_ONLY.EXT_CITY_RESALE), 0.00) + ISNULL(SUM(INCOME_ONLY.EXT_STATE_RESALE), 0.00) + ISNULL(SUM(INCOME_ONLY.EXT_COUNTY_RESALE), 0.00) AS Actual_Tax, 0.00 AS Actual_Total
		FROM         dbo.INCOME_ONLY INNER JOIN
						  dbo.JOB_COMPONENT ON dbo.INCOME_ONLY.JOB_NUMBER = dbo.JOB_COMPONENT.JOB_NUMBER AND 
						  dbo.INCOME_ONLY.JOB_COMPONENT_NBR = dbo.JOB_COMPONENT.JOB_COMPONENT_NBR INNER JOIN
						  dbo.JOB_LOG ON dbo.JOB_COMPONENT.JOB_NUMBER = dbo.JOB_LOG.JOB_NUMBER INNER JOIN
						  dbo.FUNCTIONS ON dbo.INCOME_ONLY.FNC_CODE = dbo.FUNCTIONS.FNC_CODE LEFT OUTER JOIN
						  dbo.FNC_HEADING ON dbo.FUNCTIONS.FNC_HEADING_ID = dbo.FNC_HEADING.FNC_HEADING_ID	
		WHERE     (dbo.JOB_LOG.CMP_IDENTIFIER = @CampaignID) AND (NOT (JOB_COMPONENT.JOB_PROCESS_CONTRL IN (6, 12)) )
		GROUP BY dbo.INCOME_ONLY.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN INCOME_ONLY.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END
		ORDER BY dbo.FUNCTIONS.FNC_DESCRIPTION	

		INSERT INTO @qva_actual
			SELECT      AP_PRODUCTION.FNC_CODE, FUNCTIONS.FNC_DESCRIPTION, FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN AP_PRODUCTION.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END, 
							  ISNULL(SUM(AP_PRODUCTION.AP_PROD_QUANTITY), 0.00) AS Actual_hours,
							  ISNULL(SUM(AP_PRODUCTION.AP_PROD_EXT_AMT), 0.00) + ISNULL(SUM(AP_PRODUCTION.EXT_NONRESALE_TAX), 0.00) AS Actual_Amount,
							  ISNULL(SUM(AP_PRODUCTION.EXT_MARKUP_AMT), 0.00) AS Actual_Markup,
							  ISNULL(SUM(AP_PRODUCTION.EXT_CITY_RESALE), 0.00) + ISNULL(SUM(AP_PRODUCTION.EXT_STATE_RESALE), 0.00) + ISNULL(SUM(AP_PRODUCTION.EXT_COUNTY_RESALE), 0.00) AS Actual_Tax, 0.00 AS Actual_Total
		FROM         dbo.AP_PRODUCTION INNER JOIN
						  dbo.JOB_COMPONENT ON dbo.AP_PRODUCTION.JOB_NUMBER = dbo.JOB_COMPONENT.JOB_NUMBER AND 
						  dbo.AP_PRODUCTION.JOB_COMPONENT_NBR = dbo.JOB_COMPONENT.JOB_COMPONENT_NBR INNER JOIN
						  dbo.JOB_LOG ON dbo.JOB_COMPONENT.JOB_NUMBER = dbo.JOB_LOG.JOB_NUMBER INNER JOIN
						  dbo.FUNCTIONS ON dbo.AP_PRODUCTION.FNC_CODE = dbo.FUNCTIONS.FNC_CODE LEFT OUTER JOIN
						  dbo.FNC_HEADING ON dbo.FUNCTIONS.FNC_HEADING_ID = dbo.FNC_HEADING.FNC_HEADING_ID	
		WHERE     (dbo.JOB_LOG.CMP_IDENTIFIER = @CampaignID) AND (NOT (JOB_COMPONENT.JOB_PROCESS_CONTRL IN (6, 12)) ) 
		GROUP BY dbo.AP_PRODUCTION.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN AP_PRODUCTION.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END
		ORDER BY dbo.FUNCTIONS.FNC_DESCRIPTION

		INSERT INTO @qva_actual
			SELECT      CLIENT_OOP.FNC_CODE, FUNCTIONS.FNC_DESCRIPTION, FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN CLIENT_OOP.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END, 
							  0.00 AS Actual_hours,
							  ISNULL(SUM(CLIENT_OOP.AMOUNT), 0.00) AS Actual_Amount,
							  0.00 AS Actual_Markup,
							  0.00 AS Actual_Tax, 0.00 AS Actual_Total
		FROM         dbo.CLIENT_OOP INNER JOIN
						  dbo.JOB_COMPONENT ON dbo.CLIENT_OOP.JOB_NUMBER = dbo.JOB_COMPONENT.JOB_NUMBER AND 
						  dbo.CLIENT_OOP.JOB_COMPONENT_NBR = dbo.JOB_COMPONENT.JOB_COMPONENT_NBR INNER JOIN
						  dbo.JOB_LOG ON dbo.JOB_COMPONENT.JOB_NUMBER = dbo.JOB_LOG.JOB_NUMBER INNER JOIN
						  dbo.FUNCTIONS ON dbo.CLIENT_OOP.FNC_CODE = dbo.FUNCTIONS.FNC_CODE LEFT OUTER JOIN
						  dbo.FNC_HEADING ON dbo.FUNCTIONS.FNC_HEADING_ID = dbo.FNC_HEADING.FNC_HEADING_ID	
		WHERE     (dbo.JOB_LOG.CMP_IDENTIFIER = @CampaignID) AND (NOT (JOB_COMPONENT.JOB_PROCESS_CONTRL IN (6, 12)) ) 
		GROUP BY dbo.CLIENT_OOP.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN CLIENT_OOP.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END
		ORDER BY dbo.FUNCTIONS.FNC_DESCRIPTION

		--INSERT INTO @qva_Billed
		--	SELECT     dbo.V_QUOTE_VS_ACTUAL.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
		--				  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN V_QUOTE_VS_ACTUAL.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END, 0.00,
		--					  CASE WHEN FUNCTIONS.FNC_TYPE = 'E' THEN ISNULL(SUM(EMP_TIME_DTL.LINE_TOTAL), 0.00) 
		--						   WHEN FUNCTIONS.FNC_TYPE = 'I' THEN ISNULL(SUM(INCOME_ONLY.LINE_TOTAL), 0.00) 
		--						   WHEN FUNCTIONS.FNC_TYPE = 'V' THEN ISNULL(SUM(AP_PRODUCTION.LINE_TOTAL), 0.00) 
		--					       WHEN FUNCTIONS.FNC_TYPE = 'C' THEN 0.00 END AS Billed_to_Date
		--	FROM         dbo.FUNCTIONS INNER JOIN
		--						  dbo.V_QUOTE_VS_ACTUAL ON dbo.FUNCTIONS.FNC_CODE = dbo.V_QUOTE_VS_ACTUAL.FNC_CODE INNER JOIN
		--						  dbo.JOB_COMPONENT ON dbo.V_QUOTE_VS_ACTUAL.JOB_NUMBER = dbo.JOB_COMPONENT.JOB_NUMBER AND 
		--						  dbo.V_QUOTE_VS_ACTUAL.JOB_COMPONENT_NBR = dbo.JOB_COMPONENT.JOB_COMPONENT_NBR LEFT OUTER JOIN
		--						  dbo.EMP_TIME_DTL ON dbo.V_QUOTE_VS_ACTUAL.FNC_CODE = dbo.EMP_TIME_DTL.FNC_CODE AND 
		--						  dbo.JOB_COMPONENT.JOB_NUMBER = dbo.EMP_TIME_DTL.JOB_NUMBER AND 
		--						  dbo.JOB_COMPONENT.JOB_COMPONENT_NBR = dbo.EMP_TIME_DTL.JOB_COMPONENT_NBR LEFT OUTER JOIN
		--						  dbo.INCOME_ONLY ON dbo.V_QUOTE_VS_ACTUAL.FNC_CODE = dbo.INCOME_ONLY.FNC_CODE AND 
		--						  dbo.JOB_COMPONENT.JOB_NUMBER = dbo.INCOME_ONLY.JOB_NUMBER AND 
		--						  dbo.JOB_COMPONENT.JOB_COMPONENT_NBR = dbo.INCOME_ONLY.JOB_COMPONENT_NBR LEFT OUTER JOIN
		--						  dbo.AP_PRODUCTION ON dbo.V_QUOTE_VS_ACTUAL.FNC_CODE = dbo.AP_PRODUCTION.FNC_CODE AND 
		--						  dbo.JOB_COMPONENT.JOB_NUMBER = dbo.AP_PRODUCTION.JOB_NUMBER AND 
		--						  dbo.JOB_COMPONENT.JOB_COMPONENT_NBR = dbo.AP_PRODUCTION.JOB_COMPONENT_NBR LEFT OUTER JOIN
		--					      FNC_HEADING ON FUNCTIONS.FNC_HEADING_ID = FNC_HEADING.FNC_HEADING_ID INNER JOIN
		--						  JOB_LOG ON JOB_LOG.JOB_NUMBER = JOB_COMPONENT.JOB_NUMBER
		--						  --#job ON V_QUOTE_VS_ACTUAL.JOB_NUMBER = #job.JobNo AND V_QUOTE_VS_ACTUAL.JOB_COMPONENT_NBR = #job.JobCompNo
		--	WHERE     (dbo.JOB_LOG.CMP_IDENTIFIER = 1960) AND 
		--				((dbo.EMP_TIME_DTL.AR_INV_NBR IS NOT NULL OR dbo.EMP_TIME_DTL.AB_FLAG = 3) OR (dbo.INCOME_ONLY.AR_INV_NBR IS NOT NULL OR dbo.INCOME_ONLY.AB_FLAG = 3) OR (dbo.AP_PRODUCTION.AR_INV_NBR IS NOT NULL OR dbo.AP_PRODUCTION.AB_FLAG = 3))
		--	GROUP BY dbo.V_QUOTE_VS_ACTUAL.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
		--				  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN V_QUOTE_VS_ACTUAL.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END                     
		--	ORDER BY dbo.FUNCTIONS.FNC_DESCRIPTION

		INSERT INTO @qva_Billed
			SELECT     dbo.EMP_TIME_DTL.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN EMP_TIME_DTL.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END, 0.00,
							  CASE WHEN FUNCTIONS.FNC_TYPE = 'E' THEN ISNULL(SUM(EMP_TIME_DTL.LINE_TOTAL), 0.00) 
							  WHEN FUNCTIONS.FNC_TYPE = 'C' THEN 0.00 END AS Billed_to_Date
			FROM         dbo.EMP_TIME_DTL INNER JOIN
						  dbo.JOB_COMPONENT ON dbo.EMP_TIME_DTL.JOB_NUMBER = dbo.JOB_COMPONENT.JOB_NUMBER AND 
						  dbo.EMP_TIME_DTL.JOB_COMPONENT_NBR = dbo.JOB_COMPONENT.JOB_COMPONENT_NBR INNER JOIN
						  dbo.JOB_LOG ON dbo.JOB_COMPONENT.JOB_NUMBER = dbo.JOB_LOG.JOB_NUMBER INNER JOIN
						  dbo.FUNCTIONS ON dbo.EMP_TIME_DTL.FNC_CODE = dbo.FUNCTIONS.FNC_CODE LEFT OUTER JOIN
						  dbo.FNC_HEADING ON dbo.FUNCTIONS.FNC_HEADING_ID = dbo.FNC_HEADING.FNC_HEADING_ID	
			WHERE     (dbo.JOB_LOG.CMP_IDENTIFIER = @CampaignID) AND (dbo.EMP_TIME_DTL.AR_INV_NBR IS NOT NULL OR dbo.EMP_TIME_DTL.AB_FLAG = 3) AND (NOT (JOB_COMPONENT.JOB_PROCESS_CONTRL IN (6, 12))) AND (EMP_TIME_DTL.EDIT_FLAG <> 1 OR EMP_TIME_DTL.EDIT_FLAG IS NULL)
			GROUP BY dbo.EMP_TIME_DTL.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN EMP_TIME_DTL.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END                     
			ORDER BY dbo.FUNCTIONS.FNC_DESCRIPTION

		INSERT INTO @qva_Billed
			SELECT     dbo.INCOME_ONLY.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN INCOME_ONLY.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END, 0.00,
								  CASE WHEN FUNCTIONS.FNC_TYPE = 'I' THEN ISNULL(SUM(INCOME_ONLY.LINE_TOTAL), 0.00) 
								  WHEN FUNCTIONS.FNC_TYPE = 'C' THEN 0.00 END AS Billed_to_Date
			FROM         dbo.INCOME_ONLY INNER JOIN
						  dbo.JOB_COMPONENT ON dbo.INCOME_ONLY.JOB_NUMBER = dbo.JOB_COMPONENT.JOB_NUMBER AND 
						  dbo.INCOME_ONLY.JOB_COMPONENT_NBR = dbo.JOB_COMPONENT.JOB_COMPONENT_NBR INNER JOIN
						  dbo.JOB_LOG ON dbo.JOB_COMPONENT.JOB_NUMBER = dbo.JOB_LOG.JOB_NUMBER INNER JOIN
						  dbo.FUNCTIONS ON dbo.INCOME_ONLY.FNC_CODE = dbo.FUNCTIONS.FNC_CODE LEFT OUTER JOIN
						  dbo.FNC_HEADING ON dbo.FUNCTIONS.FNC_HEADING_ID = dbo.FNC_HEADING.FNC_HEADING_ID	
			WHERE     (dbo.JOB_LOG.CMP_IDENTIFIER = @CampaignID) AND (dbo.INCOME_ONLY.AR_INV_NBR IS NOT NULL OR dbo.INCOME_ONLY.AB_FLAG = 3) AND (NOT (JOB_COMPONENT.JOB_PROCESS_CONTRL IN (6, 12)) )
			GROUP BY dbo.INCOME_ONLY.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN INCOME_ONLY.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END                    
			ORDER BY dbo.FUNCTIONS.FNC_DESCRIPTION

		INSERT INTO @qva_Billed
			SELECT     dbo.AP_PRODUCTION.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN AP_PRODUCTION.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END, 0.00,
								  CASE WHEN FUNCTIONS.FNC_TYPE = 'V' THEN ISNULL(SUM(AP_PRODUCTION.LINE_TOTAL), 0.00) 
								  WHEN FUNCTIONS.FNC_TYPE = 'C' THEN 0.00 END AS Billed_to_Date
			FROM         dbo.AP_PRODUCTION INNER JOIN
						  dbo.JOB_COMPONENT ON dbo.AP_PRODUCTION.JOB_NUMBER = dbo.JOB_COMPONENT.JOB_NUMBER AND 
						  dbo.AP_PRODUCTION.JOB_COMPONENT_NBR = dbo.JOB_COMPONENT.JOB_COMPONENT_NBR INNER JOIN
						  dbo.JOB_LOG ON dbo.JOB_COMPONENT.JOB_NUMBER = dbo.JOB_LOG.JOB_NUMBER INNER JOIN
						  dbo.FUNCTIONS ON dbo.AP_PRODUCTION.FNC_CODE = dbo.FUNCTIONS.FNC_CODE LEFT OUTER JOIN
						  dbo.FNC_HEADING ON dbo.FUNCTIONS.FNC_HEADING_ID = dbo.FNC_HEADING.FNC_HEADING_ID	
			WHERE      (dbo.JOB_LOG.CMP_IDENTIFIER = @CampaignID) AND (dbo.AP_PRODUCTION.AR_INV_NBR IS NOT NULL OR dbo.AP_PRODUCTION.AB_FLAG = 3) AND (NOT (JOB_COMPONENT.JOB_PROCESS_CONTRL IN (6, 12)) )
			GROUP BY dbo.AP_PRODUCTION.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN AP_PRODUCTION.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END                     
			ORDER BY dbo.FUNCTIONS.FNC_DESCRIPTION

		INSERT INTO @qva_AdvBilled
			SELECT     dbo.ADVANCE_BILLING.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN ADVANCE_BILLING.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END,0.00,0.00,
							  ISNULL(SUM(ADVANCE_BILLING.LINE_TOTAL), 0.00) AS Adv_Billed, 0.00,0.00,0.00,0.00,0.00,0.00
			FROM         dbo.ADVANCE_BILLING INNER JOIN
						  dbo.JOB_COMPONENT ON dbo.ADVANCE_BILLING.JOB_NUMBER = dbo.JOB_COMPONENT.JOB_NUMBER AND 
						  dbo.ADVANCE_BILLING.JOB_COMPONENT_NBR = dbo.JOB_COMPONENT.JOB_COMPONENT_NBR INNER JOIN
						  dbo.JOB_LOG ON dbo.JOB_COMPONENT.JOB_NUMBER = dbo.JOB_LOG.JOB_NUMBER INNER JOIN
						  dbo.FUNCTIONS ON dbo.ADVANCE_BILLING.FNC_CODE = dbo.FUNCTIONS.FNC_CODE LEFT OUTER JOIN
						  dbo.FNC_HEADING ON dbo.FUNCTIONS.FNC_HEADING_ID = dbo.FNC_HEADING.FNC_HEADING_ID		  
			WHERE     (dbo.JOB_LOG.CMP_IDENTIFIER = @CampaignID) AND (dbo.ADVANCE_BILLING.AR_INV_NBR IS NOT NULL OR dbo.ADVANCE_BILLING.AB_FLAG = 3) AND (NOT (JOB_COMPONENT.JOB_PROCESS_CONTRL IN (6, 12)) )
			GROUP BY dbo.ADVANCE_BILLING.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN ADVANCE_BILLING.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END                     
			ORDER BY dbo.FUNCTIONS.FNC_DESCRIPTION

		INSERT INTO @qva_POtotal
			SELECT     dbo.PURCHASE_ORDER_DET.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN PURCHASE_ORDER_DET.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END, 
							  CASE WHEN FUNCTIONS.FNC_TYPE = 'V' THEN ISNULL(SUM(dbo.PURCHASE_ORDER_DET.PO_EXT_AMOUNT), 0.00)
								ELSE 0.00 END AS PO_Total
			FROM       dbo.PURCHASE_ORDER_DET INNER JOIN
						  dbo.JOB_COMPONENT ON dbo.PURCHASE_ORDER_DET.JOB_NUMBER = dbo.JOB_COMPONENT.JOB_NUMBER AND 
						  dbo.PURCHASE_ORDER_DET.JOB_COMPONENT_NBR = dbo.JOB_COMPONENT.JOB_COMPONENT_NBR INNER JOIN
						  dbo.JOB_LOG ON dbo.JOB_COMPONENT.JOB_NUMBER = dbo.JOB_LOG.JOB_NUMBER INNER JOIN
						  dbo.FUNCTIONS ON dbo.PURCHASE_ORDER_DET.FNC_CODE = dbo.FUNCTIONS.FNC_CODE LEFT OUTER JOIN
						  dbo.FNC_HEADING ON dbo.FUNCTIONS.FNC_HEADING_ID = dbo.FNC_HEADING.FNC_HEADING_ID INNER JOIN
						  dbo.PURCHASE_ORDER ON dbo.PURCHASE_ORDER_DET.PO_NUMBER = dbo.PURCHASE_ORDER.PO_NUMBER	
			WHERE     (dbo.JOB_LOG.CMP_IDENTIFIER = @CampaignID) AND (PURCHASE_ORDER_DET.PO_COMPLETE IS NULL OR PURCHASE_ORDER_DET.PO_COMPLETE = 0) AND (PURCHASE_ORDER.VOID_FLAG IS NULL OR PURCHASE_ORDER.VOID_FLAG = 0) AND (NOT (JOB_COMPONENT.JOB_PROCESS_CONTRL IN (6, 12)) )
			GROUP BY dbo.PURCHASE_ORDER_DET.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN PURCHASE_ORDER_DET.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END                      
			ORDER BY dbo.FUNCTIONS.FNC_DESCRIPTION

		INSERT INTO @qva_POapplied
			SELECT     dbo.PURCHASE_ORDER_DET.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN PURCHASE_ORDER_DET.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END, 
							  CASE WHEN FUNCTIONS.FNC_TYPE = 'V' THEN ISNULL(SUM(dbo.AP_PRODUCTION.AP_PROD_EXT_AMT), 0.00)
								ELSE 0.00 END AS PO_Applied
			FROM       dbo.PURCHASE_ORDER_DET INNER JOIN
						  dbo.JOB_COMPONENT ON dbo.PURCHASE_ORDER_DET.JOB_NUMBER = dbo.JOB_COMPONENT.JOB_NUMBER AND 
						  dbo.PURCHASE_ORDER_DET.JOB_COMPONENT_NBR = dbo.JOB_COMPONENT.JOB_COMPONENT_NBR INNER JOIN
						  dbo.JOB_LOG ON dbo.JOB_COMPONENT.JOB_NUMBER = dbo.JOB_LOG.JOB_NUMBER INNER JOIN
						  dbo.FUNCTIONS ON dbo.PURCHASE_ORDER_DET.FNC_CODE = dbo.FUNCTIONS.FNC_CODE INNER JOIN
						  dbo.AP_PRODUCTION ON dbo.PURCHASE_ORDER_DET.PO_NUMBER = dbo.AP_PRODUCTION.PO_NUMBER AND 
						  dbo.PURCHASE_ORDER_DET.LINE_NUMBER = dbo.AP_PRODUCTION.PO_LINE_NUMBER LEFT OUTER JOIN
						  dbo.FNC_HEADING ON dbo.FUNCTIONS.FNC_HEADING_ID = dbo.FNC_HEADING.FNC_HEADING_ID
			WHERE     (dbo.JOB_LOG.CMP_IDENTIFIER = @CampaignID) AND (PURCHASE_ORDER_DET.PO_COMPLETE = 0 OR PURCHASE_ORDER_DET.PO_COMPLETE IS NULL) AND
						(AP_PRODUCTION.DELETE_FLAG IS NULL OR AP_PRODUCTION.DELETE_FLAG = 0) AND (NOT (JOB_COMPONENT.JOB_PROCESS_CONTRL IN (6, 12)) )
			GROUP BY dbo.PURCHASE_ORDER_DET.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN PURCHASE_ORDER_DET.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END
			ORDER BY dbo.FUNCTIONS.FNC_DESCRIPTION

		--INSERT INTO @qva_NB
		--	SELECT     dbo.V_QUOTE_VS_ACTUAL.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
		--				  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN V_QUOTE_VS_ACTUAL.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END, 
		--					  CASE WHEN FUNCTIONS.FNC_TYPE = 'E' THEN ISNULL(SUM(EMP_TIME_DTL.EXT_CITY_RESALE), 0.00) + ISNULL(SUM(EMP_TIME_DTL.EXT_STATE_RESALE), 0.00) + ISNULL(SUM(EMP_TIME_DTL.EXT_COUNTY_RESALE), 0.00)
		--					       WHEN FUNCTIONS.FNC_TYPE = 'I' THEN ISNULL(SUM(INCOME_ONLY.EXT_CITY_RESALE), 0.00) + ISNULL(SUM(INCOME_ONLY.EXT_STATE_RESALE), 0.00) + ISNULL(SUM(INCOME_ONLY.EXT_COUNTY_RESALE), 0.00)
		--					       WHEN FUNCTIONS.FNC_TYPE = 'V' THEN ISNULL(SUM(AP_PRODUCTION.EXT_CITY_RESALE), 0.00) + ISNULL(SUM(AP_PRODUCTION.EXT_STATE_RESALE), 0.00) + ISNULL(SUM(AP_PRODUCTION.EXT_COUNTY_RESALE), 0.00)
		--					       WHEN FUNCTIONS.FNC_TYPE = 'C' THEN 0.00 END AS NB_Tax,
		--					  CASE WHEN FUNCTIONS.FNC_TYPE = 'E' THEN ISNULL(SUM(EMP_TIME_DTL.EXT_MARKUP_AMT), 0.00)
		--						   WHEN FUNCTIONS.FNC_TYPE = 'I' THEN ISNULL(SUM(INCOME_ONLY.EXT_MARKUP_AMT), 0.00)
		--						   WHEN FUNCTIONS.FNC_TYPE = 'V' THEN ISNULL(SUM(AP_PRODUCTION.EXT_MARKUP_AMT), 0.00)
		--					       WHEN FUNCTIONS.FNC_TYPE = 'C' THEN 0.00 END AS NB_Markup,	
		--					  CASE WHEN FUNCTIONS.FNC_TYPE = 'E' THEN ISNULL(SUM(EMP_TIME_DTL.TOTAL_BILL), 0.00)
		--					       WHEN FUNCTIONS.FNC_TYPE = 'I' THEN ISNULL(SUM(INCOME_ONLY.IO_AMOUNT), 0.00)
		--					       WHEN FUNCTIONS.FNC_TYPE = 'V' THEN ISNULL(SUM(AP_PRODUCTION.AP_PROD_EXT_AMT), 0.00)
		--					       WHEN FUNCTIONS.FNC_TYPE = 'C' THEN 0.00 END AS NB_Amount,
		--					  CASE WHEN FUNCTIONS.FNC_TYPE = 'E' THEN ISNULL(SUM(EMP_TIME_DTL.EMP_HOURS), 0.00)
		--					       WHEN FUNCTIONS.FNC_TYPE = 'I' THEN ISNULL(SUM(INCOME_ONLY.IO_QTY), 0.00)
		--					       WHEN FUNCTIONS.FNC_TYPE = 'V' THEN ISNULL(SUM(AP_PRODUCTION.AP_PROD_QUANTITY), 0.00)
		--					       WHEN FUNCTIONS.FNC_TYPE = 'C' THEN 0.00 END AS NB_Hours	
		--	FROM         dbo.FUNCTIONS INNER JOIN
		--						  dbo.V_QUOTE_VS_ACTUAL ON dbo.FUNCTIONS.FNC_CODE = dbo.V_QUOTE_VS_ACTUAL.FNC_CODE INNER JOIN
		--						  dbo.JOB_COMPONENT ON dbo.V_QUOTE_VS_ACTUAL.JOB_NUMBER = dbo.JOB_COMPONENT.JOB_NUMBER AND 
		--						  dbo.V_QUOTE_VS_ACTUAL.JOB_COMPONENT_NBR = dbo.JOB_COMPONENT.JOB_COMPONENT_NBR LEFT OUTER JOIN
		--						  dbo.EMP_TIME_DTL ON dbo.V_QUOTE_VS_ACTUAL.FNC_CODE = dbo.EMP_TIME_DTL.FNC_CODE AND 
		--						  dbo.JOB_COMPONENT.JOB_NUMBER = dbo.EMP_TIME_DTL.JOB_NUMBER AND 
		--						  dbo.JOB_COMPONENT.JOB_COMPONENT_NBR = dbo.EMP_TIME_DTL.JOB_COMPONENT_NBR LEFT OUTER JOIN
		--						  dbo.INCOME_ONLY ON dbo.V_QUOTE_VS_ACTUAL.FNC_CODE = dbo.INCOME_ONLY.FNC_CODE AND 
		--						  dbo.JOB_COMPONENT.JOB_NUMBER = dbo.INCOME_ONLY.JOB_NUMBER AND 
		--						  dbo.JOB_COMPONENT.JOB_COMPONENT_NBR = dbo.INCOME_ONLY.JOB_COMPONENT_NBR LEFT OUTER JOIN
		--						  dbo.AP_PRODUCTION ON dbo.V_QUOTE_VS_ACTUAL.FNC_CODE = dbo.AP_PRODUCTION.FNC_CODE AND 
		--						  dbo.JOB_COMPONENT.JOB_NUMBER = dbo.AP_PRODUCTION.JOB_NUMBER AND 
		--						  dbo.JOB_COMPONENT.JOB_COMPONENT_NBR = dbo.AP_PRODUCTION.JOB_COMPONENT_NBR LEFT OUTER JOIN
		--					      FNC_HEADING ON FUNCTIONS.FNC_HEADING_ID = FNC_HEADING.FNC_HEADING_ID INNER JOIN
		--						  JOB_LOG ON JOB_LOG.JOB_NUMBER = JOB_COMPONENT.JOB_NUMBER
		--						  --#job ON V_QUOTE_VS_ACTUAL.JOB_NUMBER = #job.JobNo AND V_QUOTE_VS_ACTUAL.JOB_COMPONENT_NBR = #job.JobCompNo 
		--	WHERE     (dbo.JOB_LOG.CMP_IDENTIFIER = 1960) AND ((dbo.EMP_TIME_DTL.EMP_NON_BILL_FLAG = 1) OR (dbo.INCOME_ONLY.NON_BILL_FLAG = 1) OR (dbo.AP_PRODUCTION.AP_PROD_NOBILL_FLG = 1))
		--	GROUP BY dbo.V_QUOTE_VS_ACTUAL.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
		--				  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN V_QUOTE_VS_ACTUAL.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END                     
		--	ORDER BY dbo.FUNCTIONS.FNC_DESCRIPTION

		INSERT INTO @qva_NB
			SELECT     dbo.EMP_TIME_DTL.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN EMP_TIME_DTL.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END, 
							  CASE WHEN FUNCTIONS.FNC_TYPE = 'E' THEN ISNULL(SUM(EMP_TIME_DTL.EXT_CITY_RESALE), 0.00) + ISNULL(SUM(EMP_TIME_DTL.EXT_STATE_RESALE), 0.00) + ISNULL(SUM(EMP_TIME_DTL.EXT_COUNTY_RESALE), 0.00)
							  WHEN FUNCTIONS.FNC_TYPE = 'C' THEN 0.00 END AS NB_Tax,
							  CASE WHEN FUNCTIONS.FNC_TYPE = 'E' THEN ISNULL(SUM(EMP_TIME_DTL.EXT_MARKUP_AMT), 0.00)
							  WHEN FUNCTIONS.FNC_TYPE = 'C' THEN 0.00 END AS NB_Markup,	
							  CASE WHEN FUNCTIONS.FNC_TYPE = 'E' THEN ISNULL(SUM(EMP_TIME_DTL.TOTAL_BILL), 0.00)
							  WHEN FUNCTIONS.FNC_TYPE = 'C' THEN 0.00 END AS NB_Amount,
							  CASE WHEN FUNCTIONS.FNC_TYPE = 'E' THEN ISNULL(SUM(EMP_TIME_DTL.EMP_HOURS), 0.00)
							  WHEN FUNCTIONS.FNC_TYPE = 'C' THEN 0.00 END AS NB_Hours	
			FROM        dbo.EMP_TIME_DTL INNER JOIN
						  dbo.JOB_COMPONENT ON dbo.EMP_TIME_DTL.JOB_NUMBER = dbo.JOB_COMPONENT.JOB_NUMBER AND 
						  dbo.EMP_TIME_DTL.JOB_COMPONENT_NBR = dbo.JOB_COMPONENT.JOB_COMPONENT_NBR INNER JOIN
						  dbo.JOB_LOG ON dbo.JOB_COMPONENT.JOB_NUMBER = dbo.JOB_LOG.JOB_NUMBER INNER JOIN
						  dbo.FUNCTIONS ON dbo.EMP_TIME_DTL.FNC_CODE = dbo.FUNCTIONS.FNC_CODE LEFT OUTER JOIN
						  dbo.FNC_HEADING ON dbo.FUNCTIONS.FNC_HEADING_ID = dbo.FNC_HEADING.FNC_HEADING_ID	
			WHERE     (dbo.JOB_LOG.CMP_IDENTIFIER = @CampaignID) AND (dbo.EMP_TIME_DTL.EMP_NON_BILL_FLAG = 1) AND (NOT (JOB_COMPONENT.JOB_PROCESS_CONTRL IN (6, 12)) ) 
			GROUP BY dbo.EMP_TIME_DTL.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN EMP_TIME_DTL.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END                     
			ORDER BY dbo.FUNCTIONS.FNC_DESCRIPTION
		INSERT INTO @qva_NB
			SELECT     dbo.INCOME_ONLY.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN INCOME_ONLY.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END, 
								  CASE WHEN FUNCTIONS.FNC_TYPE = 'I' THEN ISNULL(SUM(INCOME_ONLY.EXT_CITY_RESALE), 0.00) + ISNULL(SUM(INCOME_ONLY.EXT_STATE_RESALE), 0.00) + ISNULL(SUM(INCOME_ONLY.EXT_COUNTY_RESALE), 0.00) 
								  WHEN FUNCTIONS.FNC_TYPE = 'C' THEN 0.00 END AS NB_Tax,
								  CASE WHEN FUNCTIONS.FNC_TYPE = 'I' THEN ISNULL(SUM(INCOME_ONLY.EXT_MARKUP_AMT), 0.00)
								  WHEN FUNCTIONS.FNC_TYPE = 'C' THEN 0.00 END AS NB_Markup,	
								  CASE WHEN FUNCTIONS.FNC_TYPE = 'I' THEN ISNULL(SUM(INCOME_ONLY.IO_AMOUNT), 0.00)
								  WHEN FUNCTIONS.FNC_TYPE = 'C' THEN 0.00 END AS NB_Amount,
								  CASE WHEN FUNCTIONS.FNC_TYPE = 'I' THEN ISNULL(SUM(INCOME_ONLY.IO_QTY), 0.00)
								  WHEN FUNCTIONS.FNC_TYPE = 'C' THEN 0.00 END AS NB_Hours
			FROM         dbo.INCOME_ONLY INNER JOIN
						  dbo.JOB_COMPONENT ON dbo.INCOME_ONLY.JOB_NUMBER = dbo.JOB_COMPONENT.JOB_NUMBER AND 
						  dbo.INCOME_ONLY.JOB_COMPONENT_NBR = dbo.JOB_COMPONENT.JOB_COMPONENT_NBR INNER JOIN
						  dbo.JOB_LOG ON dbo.JOB_COMPONENT.JOB_NUMBER = dbo.JOB_LOG.JOB_NUMBER INNER JOIN
						  dbo.FUNCTIONS ON dbo.INCOME_ONLY.FNC_CODE = dbo.FUNCTIONS.FNC_CODE LEFT OUTER JOIN
						  dbo.FNC_HEADING ON dbo.FUNCTIONS.FNC_HEADING_ID = dbo.FNC_HEADING.FNC_HEADING_ID	
			WHERE     (dbo.JOB_LOG.CMP_IDENTIFIER = @CampaignID) AND (dbo.INCOME_ONLY.NON_BILL_FLAG = 1) AND (NOT (JOB_COMPONENT.JOB_PROCESS_CONTRL IN (6, 12)) )  
			GROUP BY dbo.INCOME_ONLY.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN INCOME_ONLY.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END                     
			ORDER BY dbo.FUNCTIONS.FNC_DESCRIPTION
		INSERT INTO @qva_NB
			SELECT     dbo.AP_PRODUCTION.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN AP_PRODUCTION.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END, 
								  CASE WHEN FUNCTIONS.FNC_TYPE = 'V' THEN ISNULL(SUM(AP_PRODUCTION.EXT_CITY_RESALE), 0.00) + ISNULL(SUM(AP_PRODUCTION.EXT_STATE_RESALE), 0.00) + ISNULL(SUM(AP_PRODUCTION.EXT_COUNTY_RESALE), 0.00)
								  WHEN FUNCTIONS.FNC_TYPE = 'C' THEN 0.00 END AS NB_Tax,
								  CASE WHEN FUNCTIONS.FNC_TYPE = 'V' THEN ISNULL(SUM(AP_PRODUCTION.EXT_MARKUP_AMT), 0.00)
								  WHEN FUNCTIONS.FNC_TYPE = 'C' THEN 0.00 END AS NB_Markup,
								  CASE WHEN FUNCTIONS.FNC_TYPE = 'V' THEN ISNULL(SUM(AP_PRODUCTION.AP_PROD_EXT_AMT), 0.00)
								  WHEN FUNCTIONS.FNC_TYPE = 'C' THEN 0.00 END AS NB_Amount,
								  CASE WHEN FUNCTIONS.FNC_TYPE = 'V' THEN ISNULL(SUM(AP_PRODUCTION.AP_PROD_QUANTITY), 0.00)
								  WHEN FUNCTIONS.FNC_TYPE = 'C' THEN 0.00 END AS NB_Hours
			FROM         dbo.AP_PRODUCTION INNER JOIN
						  dbo.JOB_COMPONENT ON dbo.AP_PRODUCTION.JOB_NUMBER = dbo.JOB_COMPONENT.JOB_NUMBER AND 
						  dbo.AP_PRODUCTION.JOB_COMPONENT_NBR = dbo.JOB_COMPONENT.JOB_COMPONENT_NBR INNER JOIN
						  dbo.JOB_LOG ON dbo.JOB_COMPONENT.JOB_NUMBER = dbo.JOB_LOG.JOB_NUMBER INNER JOIN
						  dbo.FUNCTIONS ON dbo.AP_PRODUCTION.FNC_CODE = dbo.FUNCTIONS.FNC_CODE LEFT OUTER JOIN
						  dbo.FNC_HEADING ON dbo.FUNCTIONS.FNC_HEADING_ID = dbo.FNC_HEADING.FNC_HEADING_ID	
			WHERE     (dbo.JOB_LOG.CMP_IDENTIFIER = @CampaignID) AND (dbo.AP_PRODUCTION.AP_PROD_NOBILL_FLG = 1) AND (NOT (JOB_COMPONENT.JOB_PROCESS_CONTRL IN (6, 12)) )
			GROUP BY dbo.AP_PRODUCTION.FNC_CODE, dbo.FUNCTIONS.FNC_DESCRIPTION, dbo.FUNCTIONS.FNC_TYPE, FNC_HEADING.FNC_HEADING_ID,
						  FNC_HEADING.FNC_HEADING_DESC, FNC_HEADING.FNC_HEADING_SEQ, CASE WHEN FUNCTIONS.FNC_CONSOLIDATION IS NULL THEN AP_PRODUCTION.FNC_CODE ELSE FUNCTIONS.FNC_CONSOLIDATION END                     
			ORDER BY dbo.FUNCTIONS.FNC_DESCRIPTION
	End

	--SELECT * FROM @qva_Billed
	--SELECT * FROM @qva_AdvBilled

    --Insert Quoted
	INSERT INTO #qva_qva
		SELECT qq.FNC_CODE, qq.FNC_DESCRIPTION, qq.FNC_TYPE, qq.FNC_HEADING_ID,
					  qq.FNC_HEADING_DESC, qq.FNC_HEADING_SEQ, qq.FNC_CONSOL_CODE, ISNULL(qq.Quoted_QtyHrs,0.00), ISNULL(qq.Quoted_Amount,0.00),
			   ISNULL(qq.Quoted_Markup,0.00), ISNULL(qq.Quoted_Tax,0.00), 0.00 AS Quoted_Total,
			   0.00, 0.00, 0.00, 0.00, 0.00 AS Actual_Total,
			   0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00  ,0,0.00, NULL, 0.00, 0.00,NULL
		FROM @qva_quoted qq 

	--Insert Actuals	
	INSERT INTO #qva_qva
		SELECT qa.FNC_CODE, qa.FNC_DESCRIPTION, qa.FNC_TYPE, qa.FNC_HEADING_ID,
					  qa.FNC_HEADING_DESC, qa.FNC_HEADING_SEQ, qa.FNC_CONSOL_CODE, 0.00, 0.00,
			   0.00, 0.00, 0.00 AS Quoted_Total,
			   ISNULL(qa.Actual_Hours,0.00), ISNULL(qa.Actual_Amount,0.00), ISNULL(qa.Actual_Markup,0.00), ISNULL(qa.Actual_Tax,0.00), 0.00 AS Actual_Total,
			   0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00  ,0,0.00, NULL, 0.00, 0.00,NULL
		FROM @qva_actual qa
		
	--Insert Billed	
	INSERT INTO #qva_qva
		SELECT qa.FNC_CODE, qa.FNC_DESCRIPTION, qa.FNC_TYPE, qa.FNC_HEADING_ID,
					  qa.FNC_HEADING_DESC, qa.FNC_HEADING_SEQ, qa.FNC_CONSOL_CODE, 0.00, 0.00,
			   0.00, 0.00, 0.00 AS Quoted_Total,
			   0.00, 0.00, 0.00, 0.00, 0.00 AS Actual_Total,
			   ISNULL(qa.Open_PO_Net_Amt,0.00),ISNULL(qa.Billed_to_Date,0.00),0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00  ,0,0.00, NULL, 0.00, 0.00,NULL
		FROM @qva_Billed qa

	--Insert Advance Billing	
	INSERT INTO #qva_qva
		SELECT qa.FNC_CODE, qa.FNC_DESCRIPTION, qa.FNC_TYPE, qa.FNC_HEADING_ID,
					  qa.FNC_HEADING_DESC, qa.FNC_HEADING_SEQ, qa.FNC_CONSOL_CODE, 0.00, 0.00,
			   0.00, 0.00, 0.00 AS Quoted_Total,
			   0.00, 0.00, 0.00, 0.00, 0.00 AS Actual_Total,
			   0.00,0.00,ISNULL(qa.Quote_vs_Actual_PO,0.00),ISNULL(qa.Actual_PO_vs_Billed,0.00),ISNULL(qa.Qva,0.00),ISNULL(qa.Avb,0.00),ISNULL(qa.Qva_PO,0.00),ISNULL(qa.Avb_PO,0.00),ISNULL(qa.NB_Actual_Hours,0.00),ISNULL(qa.NB_Actual_Total,0.00),ISNULL(qa.Adv_Billed,0.00),
			   0.00,0.00,0.00,0.00,0.00  ,0,0.00, NULL, 0.00, 0.00,NULL
		FROM @qva_AdvBilled qa
		
	--Combine Quoted/Actuals
	INSERT INTO #qva_rows
		SELECT qva.FNC_CODE, qva.FNC_DESCRIPTION, qva.FNC_TYPE, qva.FNC_HEADING_ID,
					  qva.FNC_HEADING_DESC, qva.FNC_HEADING_SEQ, qva.FNC_CONSOL_CODE, SUM(ISNULL(qva.Quoted_QtyHrs,0.00)), SUM(ISNULL(qva.Quoted_Amount,0.00)),
			   SUM(ISNULL(qva.Quoted_Markup,0.00)), SUM(ISNULL(qva.Quoted_Tax,0.00)), 0.00 AS Quoted_Total,
			   SUM(ISNULL(qva.Actual_Hours,0.00)), SUM(ISNULL(qva.Actual_Amount,0.00)), SUM(ISNULL(qva.Actual_Markup,0.00)), SUM(ISNULL(qva.Actual_Tax,0.00)), 0.00 AS Actual_Total,
			   0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00  ,0,0.00, NULL, 0.00, 0.00,NULL
		FROM #qva_qva qva
		GROUP BY qva.FNC_CODE, qva.FNC_DESCRIPTION, qva.FNC_TYPE, qva.FNC_HEADING_ID,qva.FNC_HEADING_DESC, qva.FNC_HEADING_SEQ, qva.FNC_CONSOL_CODE

	--SELECT * FROM @qva_quoted
	--SELECT * FROM @qva_actual
	--SELECT * FROM #qva_rows
	--INSERT INTO #job
	--SELECT JOB_NUMBER,JOB_COMPONENT_NBR
	--FROM JOB_COMPONENT
	--WHERE JOB_NUMBER = @JobNum

	UPDATE #qva_rows
	SET Open_PO_Net_Amt = ISNULL(qb.Open_PO_Net_Amt,0.00),
		Billed_to_Date = ISNULL(qb.Billed_to_Date,0.00)
	FROM #qva_rows qv, @qva_Billed qb
	WHERE qv.FNC_CODE = qb.FNC_CODE

	UPDATE #qva_rows
	SET Quote_vs_Actual_PO = ISNULL(qab.Quote_vs_Actual_PO,0.00),
		Actual_PO_vs_Billed = ISNULL(qab.Actual_PO_vs_Billed,0.00),
		Qva = ISNULL(qab.Qva,0.00),
		Avb = ISNULL(qab.Avb,0.00),
		Qva_PO = ISNULL(qab.Qva_PO,0.00),
		Avb_PO = ISNULL(qab.Avb_PO,0.00),
		NB_Actual_Hours = ISNULL(qab.NB_Actual_Hours,0.00),
		NB_Actual_Total = ISNULL(qab.NB_Actual_Total,0.00),
		Adv_Billed = ISNULL(qab.Adv_Billed,0.00)
	FROM #qva_rows qv, @qva_AdvBilled qab
	WHERE qv.FNC_CODE = qab.FNC_CODE

	UPDATE #qva_rows
	SET PO_Total = ISNULL(qpt.PO_Total,0.00)
	FROM #qva_rows qv, @qva_POtotal qpt
	WHERE qv.FNC_CODE = qpt.FNC_CODE
	
	UPDATE #qva_rows
	SET PO_Applied = ISNULL(qpa.PO_Applied,0.00)
	FROM #qva_rows qv, @qva_POapplied qpa
	WHERE qv.FNC_CODE = qpa.FNC_CODE

	UPDATE #qva_rows
	SET NB_Tax = ISNULL(qn.NB_Tax,0.00),  
		NB_Markup = ISNULL(qn.NB_Markup,0.00),
		NB_Amount = ISNULL(qn.NB_Amount,0.00),
		NB_Hours = ISNULL(qn.NB_Hours,0.00)
	FROM #qva_rows qv, @qva_NB qn
	WHERE qv.FNC_CODE = qn.FNC_CODE

	DECLARE jc_cursor CURSOR FOR 
		 SELECT JobNo,JobCompNo
		 FROM #job
	 
	OPEN jc_cursor

	FETCH NEXT FROM jc_cursor INTO @jnum, @cnum

	WHILE ( @@FETCH_STATUS <> -1 )
	BEGIN
			SELECT @MaxBAID= MAX(BH.BA_ID)
			FROM BILL_APPR_DTL BD, BILL_APPR_HDR BH
			WHERE BH.JOB_NUMBER = @jnum AND BH.JOB_COMPONENT_NBR = @cnum
			AND BH.JOB_NUMBER = BD.JOB_NUMBER
			AND BH.JOB_COMPONENT_NBR = BD.JOB_COMPONENT_NBR
			AND BH.BA_ID = BD.BA_ID

			SELECT @ArInvNbr = AR_INV_NBR FROM BILL_APPR_HDR BH
			WHERE BH.BA_ID = @MaxBAID AND BH.JOB_NUMBER = @jnum AND BH.JOB_COMPONENT_NBR = @cnum

			if @ArInvNbr IS NULL
			Begin
				INSERT INTO @APPROVED_AMT
				SELECT BD.FNC_CODE, ISNULL(SUM(BD.APPROVED_AMT), 0)
				FROM BILL_APPR_DTL BD
				WHERE BD.BA_ID = @MaxBAID AND BD.JOB_NUMBER = @jnum AND BD.JOB_COMPONENT_NBR = @cnum
				GROUP BY BD.FNC_CODE
			End			
		FETCH NEXT FROM jc_cursor INTO @jnum, @cnum
	END

	CLOSE jc_cursor
	DEALLOCATE jc_cursor

	UPDATE #qva_rows
	SET APPROVED_AMT = (SELECT SUM(AA.APPROVED_AMT)
	FROM @APPROVED_AMT AA
	WHERE AA.FNC_CODE = #qva_rows.FNC_CODE
	GROUP BY AA.FNC_CODE);
	--SELECT @BREAKOUT_ALL_NB
	IF @BREAKOUT_ALL_NB = 1
	BEGIN

		UPDATE #qva_rows 
		SET 
			QUOTE_PERC = ((ISNULL(#qva_rows.Actual_Hours, 0.00) - ISNULL(#qva_rows.NB_Hours, 0.00)) / ISNULL(#qva_rows.Quoted_QtyHrs, 0.00)) * 100
		WHERE #qva_rows.Quoted_QtyHrs > 0;

		UPDATE #qva_rows 
		SET
			QUOTE_PERC_AMT = ((ISNULL(#qva_rows.Actual_Amount, 0.00) - ISNULL(#qva_rows.NB_Amount, 0.00)) / ISNULL(#qva_rows.Quoted_Amount, 0.00)) * 100
		WHERE #qva_rows.Quoted_Amount > 0;

		UPDATE #qva_rows 
		SET 
			Actual_Hours = (ISNULL(#qva_rows.Actual_Hours, 0.00) - ISNULL(#qva_rows.NB_Hours, 0.00)),
			Actual_Amount = (ISNULL(#qva_rows.Actual_Amount, 0.00) - ISNULL(#qva_rows.NB_Amount, 0.00)) ,
			Actual_Tax = (ISNULL(#qva_rows.Actual_Tax, 0.00) - ISNULL(#qva_rows.NB_Tax, 0.00)) ,
			Actual_Markup = (ISNULL(#qva_rows.Actual_Markup, 0.00) - ISNULL(#qva_rows.NB_Markup, 0.00))
		;

	END	
	
	IF @BREAKOUT_NB_FOR_FT = 1 AND @BREAKOUT_ALL_NB = 0
	BEGIN

		IF @FILTER_EMPLOYEE_TIME = 1
		BEGIN

			UPDATE #qva_rows 
			SET 
				QUOTE_PERC = ((ISNULL(#qva_rows.Actual_Hours, 0.00) - ISNULL(#qva_rows.NB_Hours, 0.00)) / ISNULL(#qva_rows.Quoted_QtyHrs, 0.00)) * 100
			WHERE #qva_rows.Quoted_QtyHrs > 0 AND FNC_TYPE = 'E';

			UPDATE #qva_rows 
			SET 
				QUOTE_PERC_AMT = ((ISNULL(#qva_rows.Actual_Amount, 0.00) - ISNULL(#qva_rows.NB_Amount, 0.00)) / ISNULL(#qva_rows.Quoted_Amount, 0.00)) * 100
			WHERE #qva_rows.Quoted_Amount > 0 AND FNC_TYPE = 'E';

			UPDATE #qva_rows 
			SET
				Actual_Hours = (ISNULL(#qva_rows.Actual_Hours, 0.00) - ISNULL(#qva_rows.NB_Hours, 0.00)),
				Actual_Amount = (ISNULL(#qva_rows.Actual_Amount, 0.00) - ISNULL(#qva_rows.NB_Amount, 0.00)) ,
				Actual_Tax = (ISNULL(#qva_rows.Actual_Tax, 0.00) - ISNULL(#qva_rows.NB_Tax, 0.00)) ,
				Actual_Markup = (ISNULL(#qva_rows.Actual_Markup, 0.00) - ISNULL(#qva_rows.NB_Markup, 0.00))
			WHERE FNC_TYPE = 'E';

		END
		IF @FILTER_INCOME_ONLY = 1
		BEGIN

			UPDATE #qva_rows 
			SET 
				QUOTE_PERC = ((ISNULL(#qva_rows.Actual_Hours, 0.00) - ISNULL(#qva_rows.NB_Hours, 0.00)) / ISNULL(#qva_rows.Quoted_QtyHrs, 0.00)) * 100
			WHERE #qva_rows.Quoted_QtyHrs > 0 AND FNC_TYPE = 'I';

			UPDATE #qva_rows 
			SET 
				QUOTE_PERC_AMT = ((ISNULL(#qva_rows.Actual_Amount, 0.00) - ISNULL(#qva_rows.NB_Amount, 0.00)) / ISNULL(#qva_rows.Quoted_Amount, 0.00)) * 100
			WHERE #qva_rows.Quoted_Amount > 0 AND FNC_TYPE = 'I';

			UPDATE #qva_rows 
			SET 
				Actual_Hours = (ISNULL(#qva_rows.Actual_Hours, 0.00) - ISNULL(#qva_rows.NB_Hours, 0.00)),
				Actual_Amount = (ISNULL(#qva_rows.Actual_Amount, 0.00) - ISNULL(#qva_rows.NB_Amount, 0.00)) ,
				Actual_Tax = (ISNULL(#qva_rows.Actual_Tax, 0.00) - ISNULL(#qva_rows.NB_Tax, 0.00)) ,
				Actual_Markup = (ISNULL(#qva_rows.Actual_Markup, 0.00) - ISNULL(#qva_rows.NB_Markup, 0.00))
			WHERE FNC_TYPE = 'I';

		END
		IF @FILTER_VENDOR = 1
		BEGIN

			UPDATE #qva_rows 
			SET 
				QUOTE_PERC = ((ISNULL(#qva_rows.Actual_Hours, 0.00) - ISNULL(#qva_rows.NB_Hours, 0.00)) / ISNULL(#qva_rows.Quoted_QtyHrs, 0.00)) * 100
			WHERE #qva_rows.Quoted_QtyHrs > 0 AND FNC_TYPE = 'V';

			UPDATE #qva_rows 
			SET 
				QUOTE_PERC_AMT = ((ISNULL(#qva_rows.Actual_Amount, 0.00) - ISNULL(#qva_rows.NB_Amount, 0.00)) / ISNULL(#qva_rows.Quoted_Amount, 0.00)) * 100
			WHERE #qva_rows.Quoted_Amount > 0 AND FNC_TYPE = 'V';

			UPDATE #qva_rows 
			SET 
				Actual_Hours = (ISNULL(#qva_rows.Actual_Hours, 0.00) - ISNULL(#qva_rows.NB_Hours, 0.00)),
				Actual_Amount = (ISNULL(#qva_rows.Actual_Amount, 0.00) - ISNULL(#qva_rows.NB_Amount, 0.00)) ,
				Actual_Tax = (ISNULL(#qva_rows.Actual_Tax, 0.00) - ISNULL(#qva_rows.NB_Tax, 0.00)) ,
				Actual_Markup = (ISNULL(#qva_rows.Actual_Markup, 0.00) - ISNULL(#qva_rows.NB_Markup, 0.00))
			WHERE FNC_TYPE = 'V';

		END
		

	END
	
	UPDATE #qva_rows SET QUOTE_PERC = (ISNULL(#qva_rows.Actual_Hours, 0.00) / ISNULL(#qva_rows.Quoted_QtyHrs, 0.00)) * 100
	WHERE #qva_rows.Quoted_QtyHrs > 0 AND QUOTE_PERC IS NULL;

	UPDATE #qva_rows SET QUOTE_PERC_AMT = (ISNULL(#qva_rows.Actual_Amount, 0.00) / ISNULL(#qva_rows.Quoted_Amount, 0.00)) * 100
	WHERE #qva_rows.Quoted_Amount > 0 AND QUOTE_PERC_AMT IS NULL;
	--SELECT * FROM #qva_rows

	if @INCLUDE_SALES_TAX = 1
	BEGIN
		UPDATE #qva_rows 
		SET 
			Actual_Total = ISNULL(#qva_rows.Actual_Amount, 0.00) + ISNULL(#qva_rows.Actual_Tax, 0.00) + ISNULL(#qva_rows.Actual_Markup, 0.00),
			NB_Total = ISNULL(#qva_rows.NB_Amount, 0.00) + ISNULL(#qva_rows.NB_Tax, 0.00) + ISNULL(#qva_rows.NB_Markup, 0.00),
			Quoted_Total = ISNULL(#qva_rows.Quoted_Amount, 0.00) + ISNULL(#qva_rows.Quoted_Tax, 0.00) + ISNULL(#qva_rows.Quoted_Markup, 0.00),
			Open_PO_Net_Amt = ISNULL(#qva_rows.PO_Total, 0.00) - ISNULL(#qva_rows.PO_Applied, 0.00),
			Billed_to_Date = ISNULL(#qva_rows.Billed_to_Date, 0.00) + ISNULL(#qva_rows.Adv_Billed, 0.00)--,
			--Actual_Hours = ISNULL(Actual_Hours, 0.00) - ISNULL(NB_Hours, 0.00),
			--Actual_Amount =  ISNULL(Actual_Amount, 0.00) - ISNULL(NB_Amount, 0.00)
	END
	ELSE
	BEGIN
		UPDATE #qva_rows 
		SET 
			Actual_Total = ISNULL(#qva_rows.Actual_Amount, 0.00) + ISNULL(#qva_rows.Actual_Markup, 0.00),
			NB_Total = ISNULL(#qva_rows.NB_Amount, 0.00) + ISNULL(#qva_rows.NB_Markup, 0.00),
			Quoted_Total = ISNULL(#qva_rows.Quoted_Amount, 0.00) + ISNULL(#qva_rows.Quoted_Markup, 0.00),
			Open_PO_Net_Amt = ISNULL(#qva_rows.PO_Total, 0.00) - ISNULL(#qva_rows.PO_Applied, 0.00),
			Billed_to_Date = ISNULL(#qva_rows.Billed_to_Date, 0.00) + ISNULL(#qva_rows.Adv_Billed, 0.00)--,
			--Actual_Hours = ISNULL(Actual_Hours, 0.00) - ISNULL(NB_Hours, 0.00),
			--Actual_Amount =  ISNULL(Actual_Amount, 0.00) - ISNULL(NB_Amount, 0.00)
	END
	
	
	     
	UPDATE #qva_rows 
	SET 
		Quote_vs_Actual_PO = ISNULL(#qva_rows.Quoted_Total, 0.00) - (ISNULL(#qva_rows.Actual_Total, 0.00) + ISNULL(#qva_rows.Open_PO_Net_Amt, 0.00)),
		Actual_PO_vs_Billed = (ISNULL(#qva_rows.Actual_Total, 0.00) + ISNULL(#qva_rows.Open_PO_Net_Amt, 0.00)) - ISNULL(Billed_to_Date, 0.00)--,
		--Actual_Total = Actual_Total - NB_Total
	
if @Display = 'Type'
Begin
	SELECT 
		FNC_CODE,
		FNC_DESCRIPTION,
		FNC_TYPE,
		CASE 
			WHEN FNC_TYPE = 'E' THEN 'Employee'
			WHEN FNC_TYPE = 'V' THEN 'Vendor'
			WHEN FNC_TYPE = 'I' THEN 'Income Only'
			WHEN FNC_TYPE = 'C' THEN 'Client Out of Pocket'
		END AS FNC_TYPE_DESC,

		ISNULL(Quoted_QtyHrs, 0.00) AS QuotedQtyHrs,
		ISNULL(Quoted_Amount, 0.00) AS QuotedAmount,
		ISNULL(Quoted_Markup, 0.00) AS QuotedMarkup,
		ISNULL(Quoted_Tax, 0.00) AS QuotedTax,	

		ISNULL(Quoted_Total, 0.00) AS QuotedTotal,

		ISNULL(Actual_Hours, 0.00) AS ActualHours,
		ISNULL(Actual_Amount, 0.00) AS ActualAmount,
		ISNULL(Actual_Markup, 0.00) AS ActualMarkup,
		ISNULL(Actual_Tax, 0.00) AS ActualTax,

		ISNULL(Actual_Total, 0.00) AS ActualTotal,

		ISNULL(Open_PO_Net_Amt, 0.00) AS OpenPONetAmt,
		ISNULL(Billed_to_Date, 0.00) AS BilledToDate,
		ISNULL(Quote_vs_Actual_PO, 0.00) AS QuotedvsActualPO,
		ISNULL(Actual_PO_vs_Billed, 0.00) AS ActualPOvsBilled,

		ISNULL(Qva, 0.00) AS Qva,
		ISNULL(Avb, 0.00) AS Avb,
		ISNULL(Qva_PO, 0.00) AS QvaPO,
		ISNULL(Avb_PO, 0.00) AS AvbPO,

		ISNULL(NB_Actual_Hours, 0.00) AS NBActualHours,
		ISNULL(NB_Actual_Total, 0.00) AS NBActualTotal,
		ISNULL(Adv_Billed, 0.00) AS AdvBilled,

		ISNULL(PO_Total, 0.00) AS POTotal,
		ISNULL(PO_Applied, 0.00) AS POApplied,
		ISNULL(NB_Tax, 0.00) AS NBTax,
		ISNULL(NB_Markup, 0.00) AS NBMarkup,
		ISNULL(NB_Amount, 0.00) AS NBAmount,
		ISNULL(APPROVED_AMT, 0.00) AS APPROVED_AMT,
		ISNULL(NB_Hours, 0.00) AS NBHours,

		ISNULL((Actual_Hours/NULLIF(Quoted_QtyHrs,0.00))*100.00,0.00) AS PERCENT_QUOTE,
		ISNULL(QUOTE_PERC, 0.00) AS PercentQuote,

		ISNULL(NB_Total, 0.00) AS NBTotal,
		ISNULL(QUOTE_PERC_AMT,0.00) AS PercentQuoteAmt

	FROM 
		#qva_rows 
	ORDER BY 
		FNC_TYPE, FNC_DESCRIPTION;

	--SUMMARY DATA
	INSERT INTO #qva_rows_sum
	SELECT 		
		NULL,
		CASE 
			WHEN FNC_TYPE = 'E' THEN 'Employee'
			WHEN FNC_TYPE = 'V' THEN 'Vendor'
			WHEN FNC_TYPE = 'I' THEN 'Income Only'
			WHEN FNC_TYPE = 'C' THEN 'Client Out of Pocket'
		END AS FNC_TYPE_DESC,
		FNC_TYPE,
		NULL,
		NULL,
		NULL,
		NULL,

		SUM(ISNULL(Quoted_QtyHrs, 0.00)) AS QuotedQtyHrs,
		SUM(ISNULL(Quoted_Amount, 0.00)) AS QuotedAmount,
		SUM(ISNULL(Quoted_Markup, 0.00)) AS QuotedMarkup,
		SUM(ISNULL(Quoted_Tax, 0.00)) AS QuotedTax,	

		SUM(ISNULL(Quoted_Total, 0.00)) AS QuotedTotal,

		SUM(ISNULL(Actual_Hours, 0.00)) AS ActualHours,
		SUM(ISNULL(Actual_Amount, 0.00)) AS ActualAmount,
		SUM(ISNULL(Actual_Markup, 0.00)) AS ActualMarkup,
		SUM(ISNULL(Actual_Tax, 0.00)) AS ActualTax,

		SUM(ISNULL(Actual_Total, 0.00)) AS ActualTotal,

		SUM(ISNULL(Open_PO_Net_Amt, 0.00)) AS OpenPONetAmt,
		SUM(ISNULL(Billed_to_Date, 0.00)) AS BilledToDate,
		SUM(ISNULL(Quote_vs_Actual_PO, 0.00)) AS QuotedvsActualPO,
		SUM(ISNULL(Actual_PO_vs_Billed, 0.00)) AS ActualPOvsBilled,

		SUM(ISNULL(Qva, 0.00)) AS Qva,
		SUM(ISNULL(Avb, 0.00)) AS Avb,
		SUM(ISNULL(Qva_PO, 0.00)) AS QvaPO,
		SUM(ISNULL(Avb_PO, 0.00)) AS AvbPO,

		SUM(ISNULL(NB_Actual_Hours, 0.00)) AS NBActualHours,
		SUM(ISNULL(NB_Actual_Total, 0.00)) AS NBActualTotal,
		SUM(ISNULL(Adv_Billed, 0.00)) AS AdvBilled,

		SUM(ISNULL(PO_Total, 0.00)) AS POTotal,
		SUM(ISNULL(PO_Applied, 0.00)) AS POApplied,
		SUM(ISNULL(NB_Tax, 0.00)) AS NBTax,
		SUM(ISNULL(NB_Markup, 0.00)) AS NBMarkup,
		SUM(ISNULL(NB_Amount, 0.00)) AS NBAmount,
		SUM(ISNULL(APPROVED_AMT, 0.00)) AS APPROVED_AMT,
		SUM(ISNULL(NB_Hours, 0.00)) AS NBHours,
			
		ISNULL(SUM(QUOTE_PERC), 0.00) AS PercentQuote,
		SUM(ISNULL(NB_Total, 0.00)) AS NBTotal,
		SUM(ISNULL(Billed_to_Date_Total,0.00)) AS Billed_to_Date_Total,
		ISNULL(SUM(QUOTE_PERC_AMT), 0.00) AS PercentQuoteAmt

	FROM 
		#qva_rows 
	GROUP BY
		FNC_TYPE			
	ORDER BY 
		FNC_TYPE;	

	IF @BREAKOUT_ALL_NB = 1
	BEGIN

		UPDATE #qva_rows_sum 
		SET 
			QUOTE_PERC = ((ISNULL(#qva_rows_sum.Actual_Hours, 0.00) - ISNULL(#qva_rows_sum.NB_Hours, 0.00)) / ISNULL(#qva_rows_sum.Quoted_QtyHrs, 0.00)) * 100
		WHERE #qva_rows_sum.Quoted_QtyHrs > 0;

		UPDATE #qva_rows_sum 
		SET 		
			QUOTE_PERC_AMT = ((ISNULL(#qva_rows_sum.Actual_Amount, 0.00) - ISNULL(#qva_rows_sum.NB_Amount, 0.00)) / ISNULL(#qva_rows_sum.Quoted_Amount, 0.00)) * 100
		WHERE #qva_rows_sum.Quoted_Amount > 0;

	END
	
	IF @BREAKOUT_NB_FOR_FT = 1 AND @BREAKOUT_ALL_NB = 0
	BEGIN

		IF @FILTER_EMPLOYEE_TIME = 1
		BEGIN

			UPDATE #qva_rows_sum 
			SET 
				QUOTE_PERC = ((ISNULL(#qva_rows_sum.Actual_Hours, 0.00) - ISNULL(#qva_rows_sum.NB_Hours, 0.00)) / ISNULL(#qva_rows_sum.Quoted_QtyHrs, 0.00)) * 100
			WHERE #qva_rows_sum.Quoted_QtyHrs > 0 AND FNC_TYPE = 'E';
			UPDATE #qva_rows_sum 
			SET 
				QUOTE_PERC_AMT = ((ISNULL(#qva_rows_sum.Actual_Amount, 0.00) - ISNULL(#qva_rows_sum.NB_Amount, 0.00)) / ISNULL(#qva_rows_sum.Quoted_Amount, 0.00)) * 100
			WHERE #qva_rows_sum.Quoted_Amount > 0 AND FNC_TYPE = 'E';

		END
		IF @FILTER_INCOME_ONLY = 1
		BEGIN

			UPDATE #qva_rows_sum 
			SET 
				QUOTE_PERC = ((ISNULL(#qva_rows_sum.Actual_Hours, 0.00) - ISNULL(#qva_rows_sum.NB_Hours, 0.00)) / ISNULL(#qva_rows_sum.Quoted_QtyHrs, 0.00)) * 100
			WHERE #qva_rows_sum.Quoted_QtyHrs > 0 AND FNC_TYPE = 'I';
			UPDATE #qva_rows_sum 
			SET 
				QUOTE_PERC_AMT = ((ISNULL(#qva_rows_sum.Actual_Amount, 0.00) - ISNULL(#qva_rows_sum.NB_Amount, 0.00)) / ISNULL(#qva_rows_sum.Quoted_Amount, 0.00)) * 100
			WHERE #qva_rows_sum.Quoted_Amount > 0 AND FNC_TYPE = 'I';

		END
		IF @FILTER_VENDOR = 1
		BEGIN

			UPDATE #qva_rows_sum 
			SET 
				QUOTE_PERC = ((ISNULL(#qva_rows_sum.Actual_Hours, 0.00) - ISNULL(#qva_rows_sum.NB_Hours, 0.00)) / ISNULL(#qva_rows_sum.Quoted_QtyHrs, 0.00)) * 100
			WHERE #qva_rows_sum.Quoted_QtyHrs > 0 AND FNC_TYPE = 'V';
			UPDATE #qva_rows_sum 
			SET
				QUOTE_PERC_AMT = ((ISNULL(#qva_rows_sum.Actual_Amount, 0.00) - ISNULL(#qva_rows_sum.NB_Amount, 0.00)) / ISNULL(#qva_rows_sum.Quoted_Amount, 0.00)) * 100
			WHERE #qva_rows_sum.Quoted_Amount > 0 AND FNC_TYPE = 'V';

		END		

	END
	
	UPDATE #qva_rows_sum SET QUOTE_PERC = (ISNULL(#qva_rows_sum.Actual_Hours, 0.00) / ISNULL(#qva_rows_sum.Quoted_QtyHrs, 0.00)) * 100
	WHERE #qva_rows_sum.Quoted_QtyHrs > 0;

	UPDATE #qva_rows_sum SET QUOTE_PERC_AMT = (ISNULL(#qva_rows_sum.Actual_Amount, 0.00) / ISNULL(#qva_rows_sum.Quoted_Amount, 0.00)) * 100
	WHERE #qva_rows_sum.Quoted_Amount > 0 ;

	SELECT
		FNC_TYPE,
		FNC_DESCRIPTION,

		ISNULL(Quoted_QtyHrs, 0.00) AS QuotedQtyHrs,
		ISNULL(Quoted_Amount, 0.00) AS QuotedAmount,
		ISNULL(Quoted_Markup, 0.00) AS QuotedMarkup,
		ISNULL(Quoted_Tax, 0.00) AS QuotedTax,	

		ISNULL(Quoted_Total, 0.00) AS QuotedTotal,

		ISNULL(Actual_Hours, 0.00) AS ActualHours,
		ISNULL(Actual_Amount, 0.00) AS ActualAmount,
		ISNULL(Actual_Markup, 0.00) AS ActualMarkup,
		ISNULL(Actual_Tax, 0.00) AS ActualTax,

		ISNULL(Actual_Total, 0.00) AS ActualTotal,

		ISNULL(Open_PO_Net_Amt, 0.00) AS OpenPONetAmt,
		ISNULL(Billed_to_Date, 0.00) AS BilledToDate,
		ISNULL(Quote_vs_Actual_PO, 0.00) AS QuotedvsActualPO,
		ISNULL(Actual_PO_vs_Billed, 0.00) AS ActualPOvsBilled,

		ISNULL(Qva, 0.00) AS Qva,
		ISNULL(Avb, 0.00) AS Avb,
		ISNULL(Qva_PO, 0.00) AS QvaPO,
		ISNULL(Avb_PO, 0.00) AS AvbPO,

		ISNULL(NB_Actual_Hours, 0.00) AS NBActualHours,
		ISNULL(NB_Actual_Total, 0.00) AS NBActualTotal,
		ISNULL(Adv_Billed, 0.00) AS AdvBilled,

		ISNULL(PO_Total, 0.00) AS POTotal,
		ISNULL(PO_Applied, 0.00) AS POApplied,
		ISNULL(NB_Tax, 0.00) AS NBTax,
		ISNULL(NB_Markup, 0.00) AS NBMarkup,
		ISNULL(NB_Amount, 0.00) AS NBAmount,
		ISNULL(APPROVED_AMT, 0.00) AS APPROVED_AMT,
		ISNULL(NB_Hours, 0.00) AS NBHours,

		ISNULL((Actual_Hours/NULLIF(Quoted_QtyHrs,0.00))*100.00,0.00) AS PERCENT_QUOTE,
		ISNULL(QUOTE_PERC, 0.00) AS PercentQuote,

		ISNULL(NB_Total, 0.00) AS NBTotal,
		ISNULL(QUOTE_PERC_AMT, 0.00) AS PercentQuoteAmt

	FROM 
		#qva_rows_sum 
	ORDER BY 
		FNC_TYPE; 
End

if @Display = 'Heading'
Begin
	SELECT 
		FNC_CODE,
		FNC_DESCRIPTION,
		FNC_TYPE,
		CASE 
			WHEN FNC_TYPE = 'E' THEN 'Employee'
			WHEN FNC_TYPE = 'V' THEN 'Vendor'
			WHEN FNC_TYPE = 'I' THEN 'Income Only'			
			WHEN FNC_TYPE = 'C' THEN 'Client Out of Pocket'
		END AS FNC_TYPE_DESC,
		ISNULL(FNC_HEADING_ID,'') AS FNC_HEADING_ID,
		ISNULL(FNC_HEADING_DESC,'') AS FNC_HEADING_DESC,
		ISNULL(FNC_HEADING_SEQ,'') AS FNC_HEADING_SEQ,

		ISNULL(Quoted_QtyHrs, 0.00) AS QuotedQtyHrs,
		ISNULL(Quoted_Amount, 0.00) AS QuotedAmount,
		ISNULL(Quoted_Markup, 0.00) AS QuotedMarkup,
		ISNULL(Quoted_Tax, 0.00) AS QuotedTax,	

		ISNULL(Quoted_Total, 0.00) AS QuotedTotal,

		ISNULL(Actual_Hours, 0.00) AS ActualHours,
		ISNULL(Actual_Amount, 0.00) AS ActualAmount,
		ISNULL(Actual_Markup, 0.00) AS ActualMarkup,
		ISNULL(Actual_Tax, 0.00) AS ActualTax,

		ISNULL(Actual_Total, 0.00) AS ActualTotal,

		ISNULL(Open_PO_Net_Amt, 0.00) AS OpenPONetAmt,
		ISNULL(Billed_to_Date, 0.00) AS BilledToDate,
		ISNULL(Quote_vs_Actual_PO, 0.00) AS QuotedvsActualPO,
		ISNULL(Actual_PO_vs_Billed, 0.00) AS ActualPOvsBilled,

		ISNULL(Qva, 0.00) AS Qva,
		ISNULL(Avb, 0.00) AS Avb,
		ISNULL(Qva_PO, 0.00) AS QvaPO,
		ISNULL(Avb_PO, 0.00) AS AvbPO,

		ISNULL(NB_Actual_Hours, 0.00) AS NBActualHours,
		ISNULL(NB_Actual_Total, 0.00) AS NBActualTotal,
		ISNULL(Adv_Billed, 0.00) AS AdvBilled,

		ISNULL(PO_Total, 0.00) AS POTotal,
		ISNULL(PO_Applied, 0.00) AS POApplied,
		ISNULL(NB_Tax, 0.00) AS NBTax,
		ISNULL(NB_Markup, 0.00) AS NBMarkup,
		ISNULL(NB_Amount, 0.00) AS NBAmount,
		ISNULL(APPROVED_AMT, 0.00) AS APPROVED_AMT,
		ISNULL(NB_Hours, 0.00) AS NBHours,

		ISNULL((Actual_Hours/NULLIF(Quoted_QtyHrs,0.00))*100.00,0.00) AS PERCENT_QUOTE,
		ISNULL(QUOTE_PERC, 0.00) AS PercentQuote,

		ISNULL(NB_Total, 0.00) AS NBTotal,
		ISNULL(QUOTE_PERC_AMT, 0.00) AS PercentQuoteAmt

	FROM 
		#qva_rows 
	ORDER BY 
		FNC_HEADING_SEQ;

	--SUMMARY DATA
	INSERT INTO #qva_rows_sum
	SELECT 		
		NULL,NULL,NULL,
		FNC_HEADING_ID,
		FNC_HEADING_DESC,
		FNC_HEADING_SEQ,
		NULL,

		SUM(ISNULL(Quoted_QtyHrs, 0.00)) AS QuotedQtyHrs,
		SUM(ISNULL(Quoted_Amount, 0.00)) AS QuotedAmount,
		SUM(ISNULL(Quoted_Markup, 0.00)) AS QuotedMarkup,
		SUM(ISNULL(Quoted_Tax, 0.00)) AS QuotedTax,	

		SUM(ISNULL(Quoted_Total, 0.00)) AS QuotedTotal,

		SUM(ISNULL(Actual_Hours, 0.00)) AS ActualHours,
		SUM(ISNULL(Actual_Amount, 0.00)) AS ActualAmount,
		SUM(ISNULL(Actual_Markup, 0.00)) AS ActualMarkup,
		SUM(ISNULL(Actual_Tax, 0.00)) AS ActualTax,

		SUM(ISNULL(Actual_Total, 0.00)) AS ActualTotal,

		SUM(ISNULL(Open_PO_Net_Amt, 0.00)) AS OpenPONetAmt,
		SUM(ISNULL(Billed_to_Date, 0.00)) AS BilledToDate,
		SUM(ISNULL(Quote_vs_Actual_PO, 0.00)) AS QuotedvsActualPO,
		SUM(ISNULL(Actual_PO_vs_Billed, 0.00)) AS ActualPOvsBilled,

		SUM(ISNULL(Qva, 0.00)) AS Qva,
		SUM(ISNULL(Avb, 0.00)) AS Avb,
		SUM(ISNULL(Qva_PO, 0.00)) AS QvaPO,
		SUM(ISNULL(Avb_PO, 0.00)) AS AvbPO,

		SUM(ISNULL(NB_Actual_Hours, 0.00)) AS NBActualHours,
		SUM(ISNULL(NB_Actual_Total, 0.00)) AS NBActualTotal,
		SUM(ISNULL(Adv_Billed, 0.00)) AS AdvBilled,

		SUM(ISNULL(PO_Total, 0.00)) AS POTotal,
		SUM(ISNULL(PO_Applied, 0.00)) AS POApplied,
		SUM(ISNULL(NB_Tax, 0.00)) AS NBTax,
		SUM(ISNULL(NB_Markup, 0.00)) AS NBMarkup,
		SUM(ISNULL(NB_Amount, 0.00)) AS NBAmount,
		SUM(ISNULL(APPROVED_AMT, 0.00)) AS APPROVED_AMT,
		SUM(ISNULL(NB_Hours, 0.00)) AS NBHours,
			
		ISNULL(SUM(QUOTE_PERC), 0.00) AS PercentQuote,
		SUM(ISNULL(NB_Total, 0.00)) AS NBTotal,
		SUM(ISNULL(Billed_to_Date_Total,0.00)) AS Billed_to_Date_Total,			
		ISNULL(SUM(QUOTE_PERC_AMT), 0.00) AS PercentQuoteAmt

	FROM 
		#qva_rows 
	GROUP BY
		FNC_HEADING_SEQ, FNC_HEADING_DESC, FNC_HEADING_ID				
	ORDER BY 
		FNC_HEADING_SEQ;	

	IF @BREAKOUT_ALL_NB = 1
	BEGIN

		UPDATE #qva_rows_sum 
		SET 
			QUOTE_PERC = ((ISNULL(#qva_rows_sum.Actual_Hours, 0.00) - ISNULL(#qva_rows_sum.NB_Hours, 0.00)) / ISNULL(#qva_rows_sum.Quoted_QtyHrs, 0.00)) * 100
		WHERE #qva_rows_sum.Quoted_QtyHrs > 0;

		UPDATE #qva_rows_sum 
		SET 		
			QUOTE_PERC_AMT = ((ISNULL(#qva_rows_sum.Actual_Amount, 0.00) - ISNULL(#qva_rows_sum.NB_Amount, 0.00)) / ISNULL(#qva_rows_sum.Quoted_Amount, 0.00)) * 100
		WHERE #qva_rows_sum.Quoted_Amount > 0;

	END
	
	IF @BREAKOUT_NB_FOR_FT = 1 AND @BREAKOUT_ALL_NB = 0
	BEGIN

		IF @FILTER_EMPLOYEE_TIME = 1
		BEGIN

			UPDATE #qva_rows_sum 
			SET 
				QUOTE_PERC = ((ISNULL(#qva_rows_sum.Actual_Hours, 0.00) - ISNULL(#qva_rows_sum.NB_Hours, 0.00)) / ISNULL(#qva_rows_sum.Quoted_QtyHrs, 0.00)) * 100
			WHERE #qva_rows_sum.Quoted_QtyHrs > 0 AND FNC_TYPE = 'E';
			UPDATE #qva_rows_sum 
			SET 
				QUOTE_PERC_AMT = ((ISNULL(#qva_rows_sum.Actual_Amount, 0.00) - ISNULL(#qva_rows_sum.NB_Amount, 0.00)) / ISNULL(#qva_rows_sum.Quoted_Amount, 0.00)) * 100
			WHERE #qva_rows_sum.Quoted_Amount > 0 AND FNC_TYPE = 'E';

		END
		IF @FILTER_INCOME_ONLY = 1
		BEGIN

			UPDATE #qva_rows_sum 
			SET 
				QUOTE_PERC = ((ISNULL(#qva_rows_sum.Actual_Hours, 0.00) - ISNULL(#qva_rows_sum.NB_Hours, 0.00)) / ISNULL(#qva_rows_sum.Quoted_QtyHrs, 0.00)) * 100
			WHERE #qva_rows_sum.Quoted_QtyHrs > 0 AND FNC_TYPE = 'I';
			UPDATE #qva_rows_sum 
			SET 
				QUOTE_PERC_AMT = ((ISNULL(#qva_rows_sum.Actual_Amount, 0.00) - ISNULL(#qva_rows_sum.NB_Amount, 0.00)) / ISNULL(#qva_rows_sum.Quoted_Amount, 0.00)) * 100
			WHERE #qva_rows_sum.Quoted_Amount > 0 AND FNC_TYPE = 'I';

		END
		IF @FILTER_VENDOR = 1
		BEGIN

			UPDATE #qva_rows_sum 
			SET 
				QUOTE_PERC = ((ISNULL(#qva_rows_sum.Actual_Hours, 0.00) - ISNULL(#qva_rows_sum.NB_Hours, 0.00)) / ISNULL(#qva_rows_sum.Quoted_QtyHrs, 0.00)) * 100
			WHERE #qva_rows_sum.Quoted_QtyHrs > 0 AND FNC_TYPE = 'V';
			UPDATE #qva_rows_sum 
			SET
				QUOTE_PERC_AMT = ((ISNULL(#qva_rows_sum.Actual_Amount, 0.00) - ISNULL(#qva_rows_sum.NB_Amount, 0.00)) / ISNULL(#qva_rows_sum.Quoted_Amount, 0.00)) * 100
			WHERE #qva_rows_sum.Quoted_Amount > 0 AND FNC_TYPE = 'V';

		END		

	END

	UPDATE #qva_rows_sum SET QUOTE_PERC = (ISNULL(#qva_rows_sum.Actual_Hours, 0.00) / ISNULL(#qva_rows_sum.Quoted_QtyHrs, 0.00)) * 100
	WHERE #qva_rows_sum.Quoted_QtyHrs > 0;

	UPDATE #qva_rows_sum SET QUOTE_PERC_AMT = (ISNULL(#qva_rows_sum.Actual_Amount, 0.00) / ISNULL(#qva_rows_sum.Quoted_Amount, 0.00)) * 100
	WHERE #qva_rows_sum.Quoted_Amount > 0;

	SELECT
		ISNULL(FNC_HEADING_ID,'') AS FNC_HEADING_ID,
		ISNULL(FNC_HEADING_DESC,'') AS FNC_DESCRIPTION,
		ISNULL(FNC_HEADING_SEQ,'') AS FNC_HEADING_SEQ,

		ISNULL(Quoted_QtyHrs, 0.00) AS QuotedQtyHrs,
		ISNULL(Quoted_Amount, 0.00) AS QuotedAmount,
		ISNULL(Quoted_Markup, 0.00) AS QuotedMarkup,
		ISNULL(Quoted_Tax, 0.00) AS QuotedTax,	

		ISNULL(Quoted_Total, 0.00) AS QuotedTotal,

		ISNULL(Actual_Hours, 0.00) AS ActualHours,
		ISNULL(Actual_Amount, 0.00) AS ActualAmount,
		ISNULL(Actual_Markup, 0.00) AS ActualMarkup,
		ISNULL(Actual_Tax, 0.00) AS ActualTax,

		ISNULL(Actual_Total, 0.00) AS ActualTotal,

		ISNULL(Open_PO_Net_Amt, 0.00) AS OpenPONetAmt,
		ISNULL(Billed_to_Date, 0.00) AS BilledToDate,
		ISNULL(Quote_vs_Actual_PO, 0.00) AS QuotedvsActualPO,
		ISNULL(Actual_PO_vs_Billed, 0.00) AS ActualPOvsBilled,

		ISNULL(Qva, 0.00) AS Qva,
		ISNULL(Avb, 0.00) AS Avb,
		ISNULL(Qva_PO, 0.00) AS QvaPO,
		ISNULL(Avb_PO, 0.00) AS AvbPO,

		ISNULL(NB_Actual_Hours, 0.00) AS NBActualHours,
		ISNULL(NB_Actual_Total, 0.00) AS NBActualTotal,
		ISNULL(Adv_Billed, 0.00) AS AdvBilled,

		ISNULL(PO_Total, 0.00) AS POTotal,
		ISNULL(PO_Applied, 0.00) AS POApplied,
		ISNULL(NB_Tax, 0.00) AS NBTax,
		ISNULL(NB_Markup, 0.00) AS NBMarkup,
		ISNULL(NB_Amount, 0.00) AS NBAmount,
		ISNULL(APPROVED_AMT, 0.00) AS APPROVED_AMT,
		ISNULL(NB_Hours, 0.00) AS NBHours,

		ISNULL((Actual_Hours/NULLIF(Quoted_QtyHrs,0.00))*100.00,0.00) AS PERCENT_QUOTE,
		ISNULL(QUOTE_PERC, 0.00) AS PercentQuote,

		ISNULL(NB_Total, 0.00) AS NBTotal,
		ISNULL(QUOTE_PERC_AMT, 0.00) AS PercentQuoteAmt

	FROM 
		#qva_rows_sum 
	ORDER BY 
		FNC_HEADING_SEQ; 
	
End

if @Display = 'Consolidation'
Begin
	SELECT 
		FNC_CONSOL_CODE,
		(SELECT FNC_DESCRIPTION FROM FUNCTIONS WHERE FNC_CODE COLLATE SQL_Latin1_General_CP1_CS_AS = #qva_rows.FNC_CONSOL_CODE) AS FNC_CONSOL_DESC,
		FNC_CODE,
		FNC_DESCRIPTION,

		ISNULL(Quoted_QtyHrs, 0.00) AS QuotedQtyHrs,
		ISNULL(Quoted_Amount, 0.00) AS QuotedAmount,
		ISNULL(Quoted_Markup, 0.00) AS QuotedMarkup,
		ISNULL(Quoted_Tax, 0.00) AS QuotedTax,	

		ISNULL(Quoted_Total, 0.00) AS QuotedTotal,

		ISNULL(Actual_Hours, 0.00) AS ActualHours,
		ISNULL(Actual_Amount, 0.00) AS ActualAmount,
		ISNULL(Actual_Markup, 0.00) AS ActualMarkup,
		ISNULL(Actual_Tax, 0.00) AS ActualTax,

		ISNULL(Actual_Total, 0.00) AS ActualTotal,

		ISNULL(Open_PO_Net_Amt, 0.00) AS OpenPONetAmt,
		ISNULL(Billed_to_Date, 0.00) AS BilledToDate,
		ISNULL(Quote_vs_Actual_PO, 0.00) AS QuotedvsActualPO,
		ISNULL(Actual_PO_vs_Billed, 0.00) AS ActualPOvsBilled,

		ISNULL(Qva, 0.00) AS Qva,
		ISNULL(Avb, 0.00) AS Avb,
		ISNULL(Qva_PO, 0.00) AS QvaPO,
		ISNULL(Avb_PO, 0.00) AS AvbPO,

		ISNULL(NB_Actual_Hours, 0.00) AS NBActualHours,
		ISNULL(NB_Actual_Total, 0.00) AS NBActualTotal,
		ISNULL(Adv_Billed, 0.00) AS AdvBilled,

		ISNULL(PO_Total, 0.00) AS POTotal,
		ISNULL(PO_Applied, 0.00) AS POApplied,
		ISNULL(NB_Tax, 0.00) AS NBTax,
		ISNULL(NB_Markup, 0.00) AS NBMarkup,
		ISNULL(NB_Amount, 0.00) AS NBAmount,
		ISNULL(APPROVED_AMT, 0.00) AS APPROVED_AMT,
		ISNULL(NB_Hours, 0.00) AS NBHours,

		ISNULL((Actual_Hours/NULLIF(Quoted_QtyHrs,0.00))*100.00,0.00) AS PERCENT_QUOTE,
		ISNULL(QUOTE_PERC, 0.00) AS PercentQuote,

		ISNULL(NB_Total, 0.00) AS NBTotal,
		ISNULL(QUOTE_PERC_AMT, 0.00) AS PercentQuoteAmt

	FROM 
		#qva_rows 
	ORDER BY 
		FNC_CONSOL_CODE;

	--SUMMARY DATA
	INSERT INTO #qva_rows_sum
	SELECT 		
		NULL,(SELECT FNC_DESCRIPTION FROM FUNCTIONS WHERE FNC_CODE COLLATE SQL_Latin1_General_CP1_CS_AS = #qva_rows.FNC_CONSOL_CODE) AS FNC_CONSOL_DESC,NULL,
		NULL,
		NULL,
		NULL,
		FNC_CONSOL_CODE,		

		SUM(ISNULL(Quoted_QtyHrs, 0.00)) AS QuotedQtyHrs,
		SUM(ISNULL(Quoted_Amount, 0.00)) AS QuotedAmount,
		SUM(ISNULL(Quoted_Markup, 0.00)) AS QuotedMarkup,
		SUM(ISNULL(Quoted_Tax, 0.00)) AS QuotedTax,	

		SUM(ISNULL(Quoted_Total, 0.00)) AS QuotedTotal,

		SUM(ISNULL(Actual_Hours, 0.00)) AS ActualHours,
		SUM(ISNULL(Actual_Amount, 0.00)) AS ActualAmount,
		SUM(ISNULL(Actual_Markup, 0.00)) AS ActualMarkup,
		SUM(ISNULL(Actual_Tax, 0.00)) AS ActualTax,

		SUM(ISNULL(Actual_Total, 0.00)) AS ActualTotal,

		SUM(ISNULL(Open_PO_Net_Amt, 0.00)) AS OpenPONetAmt,
		SUM(ISNULL(Billed_to_Date, 0.00)) AS BilledToDate,
		SUM(ISNULL(Quote_vs_Actual_PO, 0.00)) AS QuotedvsActualPO,
		SUM(ISNULL(Actual_PO_vs_Billed, 0.00)) AS ActualPOvsBilled,

		SUM(ISNULL(Qva, 0.00)) AS Qva,
		SUM(ISNULL(Avb, 0.00)) AS Avb,
		SUM(ISNULL(Qva_PO, 0.00)) AS QvaPO,
		SUM(ISNULL(Avb_PO, 0.00)) AS AvbPO,

		SUM(ISNULL(NB_Actual_Hours, 0.00)) AS NBActualHours,
		SUM(ISNULL(NB_Actual_Total, 0.00)) AS NBActualTotal,
		SUM(ISNULL(Adv_Billed, 0.00)) AS AdvBilled,

		SUM(ISNULL(PO_Total, 0.00)) AS POTotal,
		SUM(ISNULL(PO_Applied, 0.00)) AS POApplied,
		SUM(ISNULL(NB_Tax, 0.00)) AS NBTax,
		SUM(ISNULL(NB_Markup, 0.00)) AS NBMarkup,
		SUM(ISNULL(NB_Amount, 0.00)) AS NBAmount,
		SUM(ISNULL(APPROVED_AMT, 0.00)) AS APPROVED_AMT,
		SUM(ISNULL(NB_Hours, 0.00)) AS NBHours,
			
		ISNULL(SUM(QUOTE_PERC), 0.00) AS PercentQuote,
		SUM(ISNULL(NB_Total, 0.00)) AS NBTotal,
		SUM(ISNULL(Billed_to_Date_Total,0.00)) AS Billed_to_Date_Total,
		ISNULL(SUM(QUOTE_PERC_AMT), 0.00) AS PercentQuoteAmt

	FROM 
		#qva_rows 
	GROUP BY
		FNC_CONSOL_CODE	
	ORDER BY 
		FNC_CONSOL_CODE;	

	IF @BREAKOUT_ALL_NB = 1
	BEGIN

		UPDATE #qva_rows_sum 
		SET 
			QUOTE_PERC = ((ISNULL(#qva_rows_sum.Actual_Hours, 0.00) - ISNULL(#qva_rows_sum.NB_Hours, 0.00)) / ISNULL(#qva_rows_sum.Quoted_QtyHrs, 0.00)) * 100
		WHERE #qva_rows_sum.Quoted_QtyHrs > 0;

		UPDATE #qva_rows_sum 
		SET 		
			QUOTE_PERC_AMT = ((ISNULL(#qva_rows_sum.Actual_Amount, 0.00) - ISNULL(#qva_rows_sum.NB_Amount, 0.00)) / ISNULL(#qva_rows_sum.Quoted_Amount, 0.00)) * 100
		WHERE #qva_rows_sum.Quoted_Amount > 0;

	END
	
	IF @BREAKOUT_NB_FOR_FT = 1 AND @BREAKOUT_ALL_NB = 0
	BEGIN

		IF @FILTER_EMPLOYEE_TIME = 1
		BEGIN

			UPDATE #qva_rows_sum 
			SET 
				QUOTE_PERC = ((ISNULL(#qva_rows_sum.Actual_Hours, 0.00) - ISNULL(#qva_rows_sum.NB_Hours, 0.00)) / ISNULL(#qva_rows_sum.Quoted_QtyHrs, 0.00)) * 100
			WHERE #qva_rows_sum.Quoted_QtyHrs > 0 AND FNC_TYPE = 'E';
			UPDATE #qva_rows_sum 
			SET 
				QUOTE_PERC_AMT = ((ISNULL(#qva_rows_sum.Actual_Amount, 0.00) - ISNULL(#qva_rows_sum.NB_Amount, 0.00)) / ISNULL(#qva_rows_sum.Quoted_Amount, 0.00)) * 100
			WHERE #qva_rows_sum.Quoted_Amount > 0 AND FNC_TYPE = 'E';

		END
		IF @FILTER_INCOME_ONLY = 1
		BEGIN

			UPDATE #qva_rows_sum 
			SET 
				QUOTE_PERC = ((ISNULL(#qva_rows_sum.Actual_Hours, 0.00) - ISNULL(#qva_rows_sum.NB_Hours, 0.00)) / ISNULL(#qva_rows_sum.Quoted_QtyHrs, 0.00)) * 100
			WHERE #qva_rows_sum.Quoted_QtyHrs > 0 AND FNC_TYPE = 'I';
			UPDATE #qva_rows_sum 
			SET 
				QUOTE_PERC_AMT = ((ISNULL(#qva_rows_sum.Actual_Amount, 0.00) - ISNULL(#qva_rows_sum.NB_Amount, 0.00)) / ISNULL(#qva_rows_sum.Quoted_Amount, 0.00)) * 100
			WHERE #qva_rows_sum.Quoted_Amount > 0 AND FNC_TYPE = 'I';

		END
		IF @FILTER_VENDOR = 1
		BEGIN

			UPDATE #qva_rows_sum 
			SET 
				QUOTE_PERC = ((ISNULL(#qva_rows_sum.Actual_Hours, 0.00) - ISNULL(#qva_rows_sum.NB_Hours, 0.00)) / ISNULL(#qva_rows_sum.Quoted_QtyHrs, 0.00)) * 100
			WHERE #qva_rows_sum.Quoted_QtyHrs > 0 AND FNC_TYPE = 'V';
			UPDATE #qva_rows_sum 
			SET
				QUOTE_PERC_AMT = ((ISNULL(#qva_rows_sum.Actual_Amount, 0.00) - ISNULL(#qva_rows_sum.NB_Amount, 0.00)) / ISNULL(#qva_rows_sum.Quoted_Amount, 0.00)) * 100
			WHERE #qva_rows_sum.Quoted_Amount > 0 AND FNC_TYPE = 'V';

		END		

	END

	UPDATE #qva_rows_sum SET QUOTE_PERC = (ISNULL(#qva_rows_sum.Actual_Hours, 0.00) / ISNULL(#qva_rows_sum.Quoted_QtyHrs, 0.00)) * 100
	WHERE #qva_rows_sum.Quoted_QtyHrs > 0;

	UPDATE #qva_rows_sum SET QUOTE_PERC_AMT = (ISNULL(#qva_rows_sum.Actual_Amount, 0.00) / ISNULL(#qva_rows_sum.Quoted_Amount, 0.00)) * 100
	WHERE #qva_rows_sum.Quoted_Amount > 0;

	SELECT
		FNC_CONSOL_CODE,
		FNC_DESCRIPTION,

		ISNULL(Quoted_QtyHrs, 0.00) AS QuotedQtyHrs,
		ISNULL(Quoted_Amount, 0.00) AS QuotedAmount,
		ISNULL(Quoted_Markup, 0.00) AS QuotedMarkup,
		ISNULL(Quoted_Tax, 0.00) AS QuotedTax,	

		ISNULL(Quoted_Total, 0.00) AS QuotedTotal,

		ISNULL(Actual_Hours, 0.00) AS ActualHours,
		ISNULL(Actual_Amount, 0.00) AS ActualAmount,
		ISNULL(Actual_Markup, 0.00) AS ActualMarkup,
		ISNULL(Actual_Tax, 0.00) AS ActualTax,

		ISNULL(Actual_Total, 0.00) AS ActualTotal,

		ISNULL(Open_PO_Net_Amt, 0.00) AS OpenPONetAmt,
		ISNULL(Billed_to_Date, 0.00) AS BilledToDate,
		ISNULL(Quote_vs_Actual_PO, 0.00) AS QuotedvsActualPO,
		ISNULL(Actual_PO_vs_Billed, 0.00) AS ActualPOvsBilled,

		ISNULL(Qva, 0.00) AS Qva,
		ISNULL(Avb, 0.00) AS Avb,
		ISNULL(Qva_PO, 0.00) AS QvaPO,
		ISNULL(Avb_PO, 0.00) AS AvbPO,

		ISNULL(NB_Actual_Hours, 0.00) AS NBActualHours,
		ISNULL(NB_Actual_Total, 0.00) AS NBActualTotal,
		ISNULL(Adv_Billed, 0.00) AS AdvBilled,

		ISNULL(PO_Total, 0.00) AS POTotal,
		ISNULL(PO_Applied, 0.00) AS POApplied,
		ISNULL(NB_Tax, 0.00) AS NBTax,
		ISNULL(NB_Markup, 0.00) AS NBMarkup,
		ISNULL(NB_Amount, 0.00) AS NBAmount,
		ISNULL(APPROVED_AMT, 0.00) AS APPROVED_AMT,
		ISNULL(NB_Hours, 0.00) AS NBHours,

		ISNULL((Actual_Hours/NULLIF(Quoted_QtyHrs,0.00))*100.00,0.00) AS PERCENT_QUOTE,
		ISNULL(QUOTE_PERC, 0.00) AS PercentQuote,

		ISNULL(NB_Total, 0.00) AS NBTotal,
		ISNULL(QUOTE_PERC_AMT, 0.00) AS PercentQuoteAmt

	FROM 
		#qva_rows_sum 
	ORDER BY 
		FNC_CONSOL_CODE; 

End

if @Display = 'Function'
Begin
	SELECT 
		FNC_CODE,
		FNC_DESCRIPTION,
		FNC_TYPE,
		CASE 
			WHEN FNC_TYPE = 'E' THEN 'Employee'
			WHEN FNC_TYPE = 'V' THEN 'Vendor'
			WHEN FNC_TYPE = 'I' THEN 'Income Only'
			WHEN FNC_TYPE = 'C' THEN 'Client Out of Pocket'
		END AS FNC_TYPE_DESC,

		ISNULL(Quoted_QtyHrs, 0.00) AS QuotedQtyHrs,
		ISNULL(Quoted_Amount, 0.00) AS QuotedAmount,
		ISNULL(Quoted_Markup, 0.00) AS QuotedMarkup,
		ISNULL(Quoted_Tax, 0.00) AS QuotedTax,	

		ISNULL(Quoted_Total, 0.00) AS QuotedTotal,

		ISNULL(Actual_Hours, 0.00) AS ActualHours,
		ISNULL(Actual_Amount, 0.00) AS ActualAmount,
		ISNULL(Actual_Markup, 0.00) AS ActualMarkup,
		ISNULL(Actual_Tax, 0.00) AS ActualTax,

		ISNULL(Actual_Total, 0.00) AS ActualTotal,

		ISNULL(Open_PO_Net_Amt, 0.00) AS OpenPONetAmt,
		ISNULL(Billed_to_Date, 0.00) AS BilledToDate,
		ISNULL(Quote_vs_Actual_PO, 0.00) AS QuotedvsActualPO,
		ISNULL(Actual_PO_vs_Billed, 0.00) AS ActualPOvsBilled,

		ISNULL(Qva, 0.00) AS Qva,
		ISNULL(Avb, 0.00) AS Avb,
		ISNULL(Qva_PO, 0.00) AS QvaPO,
		ISNULL(Avb_PO, 0.00) AS AvbPO,

		ISNULL(NB_Actual_Hours, 0.00) AS NBActualHours,
		ISNULL(NB_Actual_Total, 0.00) AS NBActualTotal,
		ISNULL(Adv_Billed, 0.00) AS AdvBilled,

		ISNULL(PO_Total, 0.00) AS POTotal,
		ISNULL(PO_Applied, 0.00) AS POApplied,
		ISNULL(NB_Tax, 0.00) AS NBTax,
		ISNULL(NB_Markup, 0.00) AS NBMarkup,
		ISNULL(NB_Amount, 0.00) AS NBAmount,
		ISNULL(APPROVED_AMT, 0.00) AS APPROVED_AMT,
		ISNULL(NB_Hours, 0.00) AS NBHours,

		ISNULL((Actual_Hours/NULLIF(Quoted_QtyHrs,0.00))*100.00,0.00) AS PERCENT_QUOTE,
		ISNULL(QUOTE_PERC, 0.00) AS PercentQuote,

		ISNULL(NB_Total, 0.00) AS NBTotal,
		ISNULL(QUOTE_PERC_AMT,0.00) AS PercentQuoteAmt

	FROM 
		#qva_rows 
	ORDER BY 
		FNC_TYPE, FNC_DESCRIPTION;

End

	DROP TABLE #qva_rows;
	DROP TABLE #qva_rows_sum;
	DROP TABLE #qva_qva;

/*=========== QUERY ===========*/
GO
SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO