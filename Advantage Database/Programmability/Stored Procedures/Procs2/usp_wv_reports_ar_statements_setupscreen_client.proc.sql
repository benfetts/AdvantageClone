IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[usp_wv_reports_ar_statements_setupscreen_client]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[usp_wv_reports_ar_statements_setupscreen_client]
GO

CREATE PROCEDURE [dbo].[usp_wv_reports_ar_statements_setupscreen_client] 
	@OFFICE_CODES VARCHAR(8000),
	@UserID Varchar(100),
	@AE_CODES VARCHAR(8000)
AS

IF @OFFICE_CODES = '%' OR @OFFICE_CODES IS NULL 
BEGIN
	SET @OFFICE_CODES = ''
END	

IF @AE_CODES = '%' OR @AE_CODES IS NULL 
BEGIN
	SET @AE_CODES = ''
END	

DECLARE @SQL VARCHAR(8000), @SQL_WHERE VARCHAR(8000)
Declare @Restrictions Int

Select @Restrictions = Count(*) 
FROM SEC_CLIENT
WHERE UPPER(USER_ID) = UPPER(@UserID)

DECLARE @EMP_CODE AS VARCHAR(6)
DECLARE @OfficeCount AS INTEGER

SELECT @EMP_CODE = EMP_CODE FROM SEC_USER WHERE UPPER(USER_CODE) = UPPER(@UserID)
SELECT @OfficeCount = COUNT(*) FROM EMP_OFFICE WHERE EMP_CODE = @EMP_CODE


SET @SQL_WHERE = ''

SET @SQL = '
SELECT DISTINCT CLIENT_AR_STMT.CL_CODE,
       ISNULL(CLIENT_AR_STMT.CL_CODE, '''') + ''|'' + ISNULL(CLIENT_AR_STMT.CONT_CODE, '''') 
       + ''|'' + ISNULL(CDP_CONTACT_HDR.EMAIL_ADDRESS, '''') AS GridDataKey,
       CLIENT.CL_NAME + '' ('' + CLIENT_AR_STMT.CL_CODE + '')'' AS GridDisplay,
       CLIENT_AR_STMT.CL_CODE AS ClientCode,
       CLIENT.CL_NAME AS ClientName,
       CLIENT_AR_STMT.CONT_CODE AS ContactCode,
       ISNULL(CDP_CONTACT_HDR.CONT_FML, '''') AS ContactName,
       ISNULL(CDP_CONTACT_HDR.CONT_FML, '''') + '' ('' + CDP_CONTACT_HDR.EMAIL_ADDRESS 
       + '')'' AS ContactDisplay,
       CDP_CONTACT_HDR.EMAIL_ADDRESS AS ContactEmail,
       CLIENT_AR_STMT.DIST_VIA_EMAIL AS EmailIt,
       CLIENT_AR_STMT.DIST_VIA_PRINT AS PrintIt,
       ISNULL(CLIENT_AR_STMT.USE_ADDRESS,2) AS ADDRESS,
       CLIENT_AR_STMT.INCL_ON_ACCT AS IncludeOnAccount,
       CLIENT_AR_STMT.REPORT_FORMAT AS ReportFormat,
       CLIENT_AR_STMT.LAST_PRINTED,
       CLIENT_AR_STMT.LAST_EMAILED
FROM   CLIENT_AR_STMT
       INNER JOIN CLIENT
            ON  CLIENT.CL_CODE = CLIENT_AR_STMT.CL_CODE
       INNER JOIN CDP_CONTACT_HDR
            ON  CLIENT_AR_STMT.CDP_CONTACT_ID = CDP_CONTACT_HDR.CDP_CONTACT_ID
                AND CLIENT.CL_CODE = CDP_CONTACT_HDR.CL_CODE
                AND CLIENT_AR_STMT.CONT_CODE = CDP_CONTACT_HDR.CONT_CODE
                AND CLIENT_AR_STMT.CL_CODE = CDP_CONTACT_HDR.CL_CODE '

SET @SQL_WHERE = ' WHERE 1=1'

IF @OFFICE_CODES <> '' OR @AE_CODES <> ''
BEGIN
	SET @SQL = @SQL + '
       INNER JOIN ACCT_REC
            ON  CLIENT_AR_STMT.CL_CODE = ACCT_REC.CL_CODE 
	'
END  
IF @OFFICE_CODES <> ''
BEGIN	
	SET @SQL_WHERE = @SQL_WHERE + ' AND (ACCT_REC.OFFICE_CODE IN (' + @OFFICE_CODES + ')) '
END          
IF @AE_CODES <> ''
BEGIN
	SET @SQL = @SQL + '
       INNER JOIN ACCOUNT_EXECUTIVE
            ON ACCOUNT_EXECUTIVE.CL_CODE = ACCT_REC.CL_CODE AND ACCOUNT_EXECUTIVE.DIV_CODE = ACCT_REC.DIV_CODE AND ACCOUNT_EXECUTIVE.PRD_CODE = ACCT_REC.PRD_CODE AND DEFAULT_AE = 1
	'
	SET @SQL_WHERE = @SQL_WHERE + ' AND (ACCOUNT_EXECUTIVE.EMP_CODE IN (' + @AE_CODES + ')) '
END             
if @Restrictions > 0	
	Begin
	  SELECT @SQL = @SQL + ' INNER JOIN SEC_CLIENT ON CLIENT_AR_STMT.CL_CODE = SEC_CLIENT.CL_CODE '

	  SELECT @SQL_WHERE = @SQL_WHERE + ' AND UPPER(SEC_CLIENT.USER_ID) = UPPER(''' + @UserID + ''') AND (SEC_CLIENT.TIME_ENTRY = 0 OR SEC_CLIENT.TIME_ENTRY IS NULL) '
	End   
If @OfficeCount > 0
	Begin
		SELECT @SQL = @SQL + ' INNER JOIN DIVISION ON CLIENT.CL_CODE = DIVISION.CL_CODE INNER JOIN
                           PRODUCT ON DIVISION.CL_CODE = PRODUCT.CL_CODE AND DIVISION.DIV_CODE = PRODUCT.DIV_CODE INNER JOIN 
						   EMP_OFFICE ON PRODUCT.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = ''' + @EMP_CODE + ''' '		
	End
SET @SQL = @SQL + @SQL_WHERE
SET @SQL = @SQL + ' 
ORDER BY
       ClientCode;    
'    
PRINT (@SQL)
EXEC (@SQL)       
       	




