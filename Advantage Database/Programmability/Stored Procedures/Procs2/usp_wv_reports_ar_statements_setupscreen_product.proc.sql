IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[usp_wv_reports_ar_statements_setupscreen_product]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[usp_wv_reports_ar_statements_setupscreen_product]
GO

CREATE PROCEDURE [dbo].[usp_wv_reports_ar_statements_setupscreen_product] 
	@OFFICE_CODES VARCHAR(8000),
	@UserID Varchar(100),
	@AE_CODES VARCHAR(8000)
AS



IF @OFFICE_CODES = '%' OR @OFFICE_CODES IS NULL 
BEGIN
	SET @OFFICE_CODES = ''
END	
DECLARE 
	@SQL VARCHAR(8000), @SQL_WHERE VARCHAR(8000)
Declare @Restrictions Int	
	
Select @Restrictions = Count(*) 
FROM SEC_CLIENT
WHERE UPPER(USER_ID) = UPPER(@UserID)

DECLARE @EMP_CODE AS VARCHAR(6)
DECLARE @OfficeCount AS INTEGER

SELECT @EMP_CODE = EMP_CODE FROM SEC_USER WHERE UPPER(USER_CODE) = UPPER(@UserID)

SELECT @OfficeCount = COUNT(*) FROM EMP_OFFICE WHERE EMP_CODE = @EMP_CODE

SET @SQL_WHERE = ''

SET @SQL ='SELECT '
IF @OFFICE_CODES <> '' OR @AE_CODES <> ''
BEGIN
	SET @SQL = @SQL + ' DISTINCT'
END
SET @SQL = @SQL + '		 
       ISNULL(PRODUCT_AR_STMT.CL_CODE, '''') + ''|'' + ISNULL(PRODUCT_AR_STMT.DIV_CODE, '''') 
       + ''|'' + ISNULL(PRODUCT_AR_STMT.PRD_CODE, '''') 
       + ''|'' + ISNULL(PRODUCT_AR_STMT.CONT_CODE, '''') + ''|'' + ISNULL(CDP_CONTACT_HDR.EMAIL_ADDRESS, '''') '
SET @SQL = @SQL + '		       
       AS 
       GridDataKey, '
SET @SQL = @SQL + '
       
       PRODUCT.PRD_DESCRIPTION + '' ('' + PRODUCT_AR_STMT.CL_CODE + ''/'' + 
       PRODUCT_AR_STMT.DIV_CODE + ''/'' + PRODUCT_AR_STMT.PRD_CODE + '')'' AS 
       GridDisplay,
       PRODUCT_AR_STMT.CL_CODE AS ClientCode,
       PRODUCT_AR_STMT.DIV_CODE AS DivisionCode,
       PRODUCT_AR_STMT.PRD_CODE AS ProductCode,
       PRODUCT.PRD_DESCRIPTION AS ProductDesc,
       PRODUCT_AR_STMT.CONT_CODE AS ContactCode,
       ISNULL(CDP_CONTACT_HDR.CONT_FML, '''') AS ContactName,
       CDP_CONTACT_HDR.EMAIL_ADDRESS AS ContactEmail,
       ISNULL(CDP_CONTACT_HDR.CONT_FML, '''') + '' ('' + ISNULL(CDP_CONTACT_HDR.EMAIL_ADDRESS, '''') 
       + '')'' AS ContactDisplay,
       PRODUCT_AR_STMT.DIST_VIA_EMAIL AS EmailIt,
       PRODUCT_AR_STMT.DIST_VIA_PRINT AS PrintIt,
       ISNULL(PRODUCT_AR_STMT.USE_ADDRESS,2) AS ADDRESS,
       PRODUCT_AR_STMT.INCL_ON_ACCT AS IncludeOnAccount,
       PRODUCT_AR_STMT.REPORT_FORMAT AS ReportFormat,
       PRODUCT_AR_STMT.LAST_PRINTED,
       PRODUCT_AR_STMT.LAST_EMAILED
FROM   PRODUCT_AR_STMT WITH(NOLOCK)
       INNER JOIN PRODUCT
            ON  PRODUCT.CL_CODE = PRODUCT_AR_STMT.CL_CODE
                AND PRODUCT.DIV_CODE = PRODUCT_AR_STMT.DIV_CODE
                AND PRODUCT.PRD_CODE = PRODUCT_AR_STMT.PRD_CODE
       INNER JOIN CDP_CONTACT_HDR WITH(NOLOCK)
            ON  PRODUCT_AR_STMT.CDP_CONTACT_ID = CDP_CONTACT_HDR.CDP_CONTACT_ID '

SET @SQL_WHERE = ' WHERE 1=1'
IF @OFFICE_CODES <> '' OR @AE_CODES <> ''
BEGIN
	SET @SQL = @SQL + '
       INNER JOIN ACCT_REC WITH(NOLOCK)
            ON  PRODUCT.CL_CODE = ACCT_REC.CL_CODE
                AND PRODUCT.DIV_CODE = ACCT_REC.DIV_CODE
                AND PRODUCT.PRD_CODE = ACCT_REC.PRD_CODE
	'
END  
IF @OFFICE_CODES <> ''
BEGIN
	
	SET @SQL_WHERE = @SQL_WHERE + ' AND (ACCT_REC.OFFICE_CODE IN (' + @OFFICE_CODES + ')) '
END           
IF @AE_CODES <> ''
BEGIN
	SET @SQL = @SQL + '
       INNER JOIN ACCOUNT_EXECUTIVE
            ON ACCOUNT_EXECUTIVE.CL_CODE = ACCT_REC.CL_CODE AND ACCOUNT_EXECUTIVE.DIV_CODE = ACCT_REC.DIV_CODE AND ACCOUNT_EXECUTIVE.PRD_CODE = ACCT_REC.PRD_CODE AND DEFAULT_AE = 1
	'
	SET @SQL_WHERE = @SQL_WHERE + ' AND (ACCOUNT_EXECUTIVE.EMP_CODE IN (' + @AE_CODES + ')) '
END              
if @Restrictions > 0	
	Begin
	  SELECT @SQL = @SQL + ' INNER JOIN SEC_CLIENT ON PRODUCT_AR_STMT.CL_CODE = SEC_CLIENT.CL_CODE
			AND PRODUCT_AR_STMT.DIV_CODE = SEC_CLIENT.DIV_CODE 
	  		AND PRODUCT_AR_STMT.PRD_CODE = SEC_CLIENT.PRD_CODE  '

	  SELECT @SQL_WHERE = @SQL_WHERE + ' AND UPPER(SEC_CLIENT.USER_ID) = UPPER(''' + @UserID + ''') AND (SEC_CLIENT.TIME_ENTRY = 0 OR SEC_CLIENT.TIME_ENTRY IS NULL) '
	End  
If @OfficeCount > 0
	Begin
		SELECT @SQL = @SQL + ' INNER JOIN EMP_OFFICE ON PRODUCT.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = ''' + @EMP_CODE + ''' '		
	End     
    SET @SQL = @SQL + @SQL_WHERE        
    SET @SQL = @SQL + '	ORDER BY ClientCode, DivisionCode, ProductCode;'

PRINT (@SQL)
EXEC(@SQL)       
   


