
CREATE PROCEDURE [dbo].[usp_wv_reports_campaign001] 
@CmpCode as integer,
@StartPeriod as varchar(6),
@EndPeriod as varchar(6),
@StartDate as varchar(10),
@EndDate as varchar(10)

AS

-- Add user_id to integrate SEC_CLIENT SECURITY

-- ESTIMATE AMOUNT
-- Gather distinct Client/Job/Component Combinations that have Approved Estimate assigned to them
--(Necessary because Div & Prd are not required in Campaigns
SELECT DISTINCT JL.CL_CODE, JC.JOB_NUMBER, JC.JOB_COMPONENT_NBR
INTO #DISTCLJC
FROM CAMPAIGN C
  INNER JOIN JOB_LOG JL ON JL.CMP_CODE = C.CMP_CODE AND JL.CL_CODE = C.CL_CODE
			AND (JL.DIV_CODE = C.DIV_CODE OR C.DIV_CODE IS NULL)
			AND (JL.PRD_CODE = C.PRD_CODE OR C.PRD_CODE IS NULL)
  INNER JOIN JOB_COMPONENT JC ON JC.JOB_NUMBER = JL.JOB_NUMBER 
			AND JC.ESTIMATE_NUMBER IS NOT NULL
			AND NOT JC.JOB_PROCESS_CONTRL IN (6, 12)
  INNER JOIN ESTIMATE_APPROVAL EA ON EA.JOB_NUMBER = JC.JOB_NUMBER
				AND EA.JOB_COMPONENT_NBR = JC.JOB_COMPONENT_NBR
				AND EA.ESTIMATE_NUMBER = JC.ESTIMATE_NUMBER	
				AND EA.EST_COMPONENT_NBR = JC.EST_COMPONENT_NBR
WHERE C.CMP_IDENTIFIER = @CmpCode


-- MAX est_rev_nbr (Only one approval, might not be max???)

SELECT E.CL_CODE, EA.JOB_NUMBER, EA.JOB_COMPONENT_NBR, SUM(ERD.LINE_TOTAL) AS TOTAL, ISNULL(SUM(ERD.EST_REV_QUANTITY), 0.00) AS HOURS_BILLABLE
INTO #ESTSUMS
FROM ESTIMATE_APPROVAL EA 
INNER JOIN ESTIMATE_REV ER ON ER.ESTIMATE_NUMBER = EA.ESTIMATE_NUMBER
			AND ER.EST_COMPONENT_NBR = EA.EST_COMPONENT_NBR
			AND ER.EST_QUOTE_NBR = EA.EST_QUOTE_NBR
			AND ER.EST_REV_NBR = EA.EST_REVISION_NBR
INNER JOIN ESTIMATE_REV_DET ERD ON ER.ESTIMATE_NUMBER = ERD.ESTIMATE_NUMBER
			AND ER.EST_COMPONENT_NBR = ERD.EST_COMPONENT_NBR
			AND ER.EST_QUOTE_NBR = ERD.EST_QUOTE_NBR
			AND ER.EST_REV_NBR = ERD.EST_REV_NBR
INNER JOIN #DISTCLJC E ON  E.JOB_NUMBER = EA.JOB_NUMBER
			AND E.JOB_COMPONENT_NBR = EA.JOB_COMPONENT_NBR
GROUP BY E.CL_CODE, EA.JOB_NUMBER, EA.JOB_COMPONENT_NBR


-- Total Amount 
SELECT DI.JOB_NUMBER, DI.JOB_COMPONENT_NBR, ISNULL(SUM(ETD.TOTAL_BILL),0) + ISNULL(SUM(IOA.IO_AMOUNT),0) + ISNULL(SUM(AP.AP_PROD_EXT_AMT), 0.00) + ISNULL(SUM(OOP.AMOUNT), 0.00) AS HOURS_TOTAL_AMT
INTO #HRS_TOT_AMT
FROM #DISTCLJC DI
  LEFT OUTER JOIN EMP_TIME_DTL ETD  ON DI.JOB_NUMBER = ETD.JOB_NUMBER
								AND DI.JOB_COMPONENT_NBR = ETD.JOB_COMPONENT_NBR
  LEFT OUTER JOIN INCOME_ONLY IOA  ON DI.JOB_NUMBER = IOA.JOB_NUMBER
								AND DI.JOB_COMPONENT_NBR = IOA.JOB_COMPONENT_NBR
  LEFT OUTER JOIN AP_PRODUCTION AP  ON DI.JOB_NUMBER = AP.JOB_NUMBER
								AND DI.JOB_COMPONENT_NBR = AP.JOB_COMPONENT_NBR
  LEFT OUTER JOIN dbo.CLIENT_OOP OOP  ON DI.JOB_NUMBER = OOP.JOB_NUMBER
								AND DI.JOB_COMPONENT_NBR = OOP.JOB_COMPONENT_NBR
GROUP BY DI.JOB_NUMBER, DI.JOB_COMPONENT_NBR

-- Non-Billable Amount
SELECT DI.JOB_NUMBER, DI.JOB_COMPONENT_NBR, ISNULL(SUM(ETD.TOTAL_BILL),0) + ISNULL(SUM(IOA.IO_AMOUNT),0) + ISNULL(SUM(AP.AP_PROD_EXT_AMT), 0.00) AS HOURS_NONBILL_AMT
INTO #NB_AMOUNT
FROM #DISTCLJC DI
  LEFT OUTER JOIN EMP_TIME_DTL ETD  ON DI.JOB_NUMBER = ETD.JOB_NUMBER
	AND DI.JOB_COMPONENT_NBR = ETD.JOB_COMPONENT_NBR
	AND ETD.EMP_NON_BILL_FLAG = 1
  LEFT OUTER JOIN INCOME_ONLY IOA  ON DI.JOB_NUMBER = IOA.JOB_NUMBER
	AND DI.JOB_COMPONENT_NBR = IOA.JOB_COMPONENT_NBR
	AND IOA.NON_BILL_FLAG = 1
  LEFT OUTER JOIN AP_PRODUCTION AP  ON DI.JOB_NUMBER = AP.JOB_NUMBER
	AND DI.JOB_COMPONENT_NBR = AP.JOB_COMPONENT_NBR
	AND AP.AP_PROD_NOBILL_FLG = 1  
GROUP BY DI.JOB_NUMBER, DI.JOB_COMPONENT_NBR

-- Billable Amount
SELECT DI.JOB_NUMBER, DI.JOB_COMPONENT_NBR, ISNULL(SUM(ETD.TOTAL_BILL),0) + ISNULL(SUM(IOA.IO_AMOUNT),0) + ISNULL(SUM(AP.AP_PROD_EXT_AMT), 0.00) AS HOURS_BILL_AMT
INTO #BILLABLE_AMOUNT
FROM #DISTCLJC DI
  LEFT OUTER JOIN EMP_TIME_DTL ETD  ON DI.JOB_NUMBER = ETD.JOB_NUMBER
	AND DI.JOB_COMPONENT_NBR = ETD.JOB_COMPONENT_NBR
	AND ETD.EMP_NON_BILL_FLAG = 0
  LEFT OUTER JOIN INCOME_ONLY IOA  ON DI.JOB_NUMBER = IOA.JOB_NUMBER
	AND DI.JOB_COMPONENT_NBR = IOA.JOB_COMPONENT_NBR
	AND IOA.NON_BILL_FLAG = 0
  LEFT OUTER JOIN AP_PRODUCTION AP  ON DI.JOB_NUMBER = AP.JOB_NUMBER
	AND DI.JOB_COMPONENT_NBR = AP.JOB_COMPONENT_NBR
	AND AP.AP_PROD_NOBILL_FLG = 0  
GROUP BY DI.JOB_NUMBER, DI.JOB_COMPONENT_NBR

--Billed Amount
SELECT #DISTCLJC.JOB_NUMBER, #DISTCLJC.JOB_COMPONENT_NBR, ISNULL(SUM(EMP_TIME_DTL.LINE_TOTAL), 0.00) AS BILLED_AMT
INTO #AMTBILLED
FROM FUNCTIONS 
INNER JOIN V_QUOTE_VS_ACTUAL ON dbo.FUNCTIONS.FNC_CODE = V_QUOTE_VS_ACTUAL.FNC_CODE 
  INNER JOIN EMP_TIME_DTL ON V_QUOTE_VS_ACTUAL.FNC_CODE = EMP_TIME_DTL.FNC_CODE 
			AND V_QUOTE_VS_ACTUAL.JOB_NUMBER = EMP_TIME_DTL.JOB_NUMBER 
			AND V_QUOTE_VS_ACTUAL.JOB_COMPONENT_NBR = EMP_TIME_DTL.JOB_COMPONENT_NBR 
			AND (dbo.EMP_TIME_DTL.AR_INV_NBR IS NOT NULL OR EMP_TIME_DTL.AB_FLAG = 3)
  INNER JOIN  #DISTCLJC ON #DISTCLJC.JOB_NUMBER = EMP_TIME_DTL.JOB_NUMBER 
		AND #DISTCLJC.JOB_COMPONENT_NBR = EMP_TIME_DTL.JOB_COMPONENT_NBR
WHERE FUNCTIONS.FNC_TYPE = 'E'
GROUP BY #DISTCLJC.JOB_NUMBER, #DISTCLJC.JOB_COMPONENT_NBR  
UNION
SELECT #DISTCLJC.JOB_NUMBER, #DISTCLJC.JOB_COMPONENT_NBR, ISNULL(SUM(INCOME_ONLY.LINE_TOTAL), 0.00)  AS BILLED_AMT
FROM FUNCTIONS 
INNER JOIN V_QUOTE_VS_ACTUAL ON dbo.FUNCTIONS.FNC_CODE = V_QUOTE_VS_ACTUAL.FNC_CODE 
  INNER JOIN INCOME_ONLY ON V_QUOTE_VS_ACTUAL.FNC_CODE = INCOME_ONLY.FNC_CODE 
			AND V_QUOTE_VS_ACTUAL.JOB_NUMBER = INCOME_ONLY.JOB_NUMBER 
			AND V_QUOTE_VS_ACTUAL.JOB_COMPONENT_NBR = INCOME_ONLY.JOB_COMPONENT_NBR 
			AND (dbo.INCOME_ONLY.AR_INV_NBR IS NOT NULL OR INCOME_ONLY.AB_FLAG = 3)
  INNER JOIN  #DISTCLJC ON #DISTCLJC.JOB_NUMBER = INCOME_ONLY.JOB_NUMBER 
		AND #DISTCLJC.JOB_COMPONENT_NBR = INCOME_ONLY.JOB_COMPONENT_NBR
WHERE FUNCTIONS.FNC_TYPE = 'I'
GROUP BY #DISTCLJC.JOB_NUMBER, #DISTCLJC.JOB_COMPONENT_NBR 
UNION
SELECT #DISTCLJC.JOB_NUMBER, #DISTCLJC.JOB_COMPONENT_NBR, ISNULL(SUM(AP_PRODUCTION.LINE_TOTAL), 0.00)  AS BILLED_AMT
FROM FUNCTIONS 
INNER JOIN V_QUOTE_VS_ACTUAL ON dbo.FUNCTIONS.FNC_CODE = V_QUOTE_VS_ACTUAL.FNC_CODE 
  INNER JOIN AP_PRODUCTION ON V_QUOTE_VS_ACTUAL.FNC_CODE = AP_PRODUCTION.FNC_CODE 
			AND V_QUOTE_VS_ACTUAL.JOB_NUMBER = AP_PRODUCTION.JOB_NUMBER 
			AND V_QUOTE_VS_ACTUAL.JOB_COMPONENT_NBR = AP_PRODUCTION.JOB_COMPONENT_NBR 
			AND (dbo.AP_PRODUCTION.AR_INV_NBR IS NOT NULL OR AP_PRODUCTION.AB_FLAG = 3)
  INNER JOIN  #DISTCLJC ON #DISTCLJC.JOB_NUMBER = AP_PRODUCTION.JOB_NUMBER 
		AND #DISTCLJC.JOB_COMPONENT_NBR = AP_PRODUCTION.JOB_COMPONENT_NBR
WHERE FUNCTIONS.FNC_TYPE = 'V'
GROUP BY #DISTCLJC.JOB_NUMBER, #DISTCLJC.JOB_COMPONENT_NBR 
UNION
SELECT #DISTCLJC.JOB_NUMBER, #DISTCLJC.JOB_COMPONENT_NBR, ISNULL(SUM(ADVANCE_BILLING.LINE_TOTAL), 0.00)  AS BILLED_AMT
FROM FUNCTIONS 
INNER JOIN V_QUOTE_VS_ACTUAL ON dbo.FUNCTIONS.FNC_CODE = V_QUOTE_VS_ACTUAL.FNC_CODE 
  INNER JOIN ADVANCE_BILLING ON V_QUOTE_VS_ACTUAL.FNC_CODE = ADVANCE_BILLING.FNC_CODE 
			AND V_QUOTE_VS_ACTUAL.JOB_NUMBER = ADVANCE_BILLING.JOB_NUMBER 
			AND V_QUOTE_VS_ACTUAL.JOB_COMPONENT_NBR = ADVANCE_BILLING.JOB_COMPONENT_NBR 
			AND (dbo.ADVANCE_BILLING.AR_INV_NBR IS NOT NULL OR ADVANCE_BILLING.AB_FLAG = 3)
  INNER JOIN  #DISTCLJC ON #DISTCLJC.JOB_NUMBER = ADVANCE_BILLING.JOB_NUMBER 
		AND #DISTCLJC.JOB_COMPONENT_NBR = ADVANCE_BILLING.JOB_COMPONENT_NBR
GROUP BY #DISTCLJC.JOB_NUMBER, #DISTCLJC.JOB_COMPONENT_NBR 

SELECT JOB_NUMBER, JOB_COMPONENT_NBR, SUM(BILLED_AMT) AS BILLED_AMT
INTO #AMTBILLEDSUM
FROM #AMTBILLED
GROUP BY JOB_NUMBER, JOB_COMPONENT_NBR

-- Income Only Billed Amount
SELECT #DISTCLJC.JOB_NUMBER, #DISTCLJC.JOB_COMPONENT_NBR, ISNULL(SUM(INCOME_ONLY.LINE_TOTAL), 0.00)  AS BILLED_AMT
INTO #IOBILLED
FROM FUNCTIONS 
INNER JOIN V_QUOTE_VS_ACTUAL ON dbo.FUNCTIONS.FNC_CODE = V_QUOTE_VS_ACTUAL.FNC_CODE 
  INNER JOIN INCOME_ONLY ON V_QUOTE_VS_ACTUAL.FNC_CODE = INCOME_ONLY.FNC_CODE 
			AND V_QUOTE_VS_ACTUAL.JOB_NUMBER = INCOME_ONLY.JOB_NUMBER 
			AND V_QUOTE_VS_ACTUAL.JOB_COMPONENT_NBR = INCOME_ONLY.JOB_COMPONENT_NBR 
			AND (dbo.INCOME_ONLY.AR_INV_NBR IS NOT NULL OR INCOME_ONLY.AB_FLAG = 3)
  INNER JOIN  #DISTCLJC ON #DISTCLJC.JOB_NUMBER = INCOME_ONLY.JOB_NUMBER 
		AND #DISTCLJC.JOB_COMPONENT_NBR = INCOME_ONLY.JOB_COMPONENT_NBR
WHERE FUNCTIONS.FNC_TYPE = 'I'
GROUP BY #DISTCLJC.JOB_NUMBER, #DISTCLJC.JOB_COMPONENT_NBR 

-- Vendor Charges Billed Amount
SELECT #DISTCLJC.JOB_NUMBER, #DISTCLJC.JOB_COMPONENT_NBR, ISNULL(SUM(AP_PRODUCTION.LINE_TOTAL), 0.00)  AS BILLED_AMT
INTO #VENDORBILLED
FROM FUNCTIONS 
INNER JOIN V_QUOTE_VS_ACTUAL ON dbo.FUNCTIONS.FNC_CODE = V_QUOTE_VS_ACTUAL.FNC_CODE 
  INNER JOIN AP_PRODUCTION ON V_QUOTE_VS_ACTUAL.FNC_CODE = AP_PRODUCTION.FNC_CODE 
			AND V_QUOTE_VS_ACTUAL.JOB_NUMBER = AP_PRODUCTION.JOB_NUMBER 
			AND V_QUOTE_VS_ACTUAL.JOB_COMPONENT_NBR = AP_PRODUCTION.JOB_COMPONENT_NBR 
			AND (dbo.AP_PRODUCTION.AR_INV_NBR IS NOT NULL OR AP_PRODUCTION.AB_FLAG = 3)
  INNER JOIN  #DISTCLJC ON #DISTCLJC.JOB_NUMBER = AP_PRODUCTION.JOB_NUMBER 
		AND #DISTCLJC.JOB_COMPONENT_NBR = AP_PRODUCTION.JOB_COMPONENT_NBR
WHERE FUNCTIONS.FNC_TYPE = 'V'
GROUP BY #DISTCLJC.JOB_NUMBER, #DISTCLJC.JOB_COMPONENT_NBR 


-- MAIN QUERY
SELECT C.CL_CODE + ' - ' + C.CL_NAME AS CLIENT, 
	CMP.CMP_CODE, CMP.CMP_NAME, CMP.CMP_BILL_BUDGET, 
	CMP.CMP_BEG_DATE, CMP.CMP_END_DATE, 
	SUBSTRING('000000', 1, 6 - LEN(JC.JOB_NUMBER)) + CAST(JC.JOB_NUMBER AS VARCHAR(6)) AS JOB_NUMBER, JL.JOB_DESC,
	SUBSTRING('000000', 1, 6 - LEN(JC.JOB_NUMBER)) + CAST(JC.JOB_NUMBER AS VARCHAR(6)) + '-' + SUBSTRING('00', 1, 2 - LEN(JC.JOB_COMPONENT_NBR)) + CAST(JC.JOB_COMPONENT_NBR AS VARCHAR(2)) AS JOBCOMP,
	JC.JOB_COMP_DESC,
	ISNULL(#ESTSUMS.TOTAL,0) AS ESTIMATE,
	ISNULL(#ESTSUMS.HOURS_BILLABLE,0) AS HOURS_BILLABLE,
 	ISNULL(#HRS_TOT_AMT.HOURS_TOTAL_AMT,0) AS SERVICES_FULL,
	ISNULL(#NB_AMOUNT.HOURS_NONBILL_AMT,0) AS SERVICES_DISCOUNT,
	ISNULL(#BILLABLE_AMOUNT.HOURS_BILL_AMT,0) AS SERVICES_POTENTIAL,
	ISNULL(#AMTBILLEDSUM.BILLED_AMT,0) AS SERVICES_BILLED,
	ISNULL(#IOBILLED.BILLED_AMT,0) AS INSIDE_EXPENSES,
	ISNULL(#VENDORBILLED.BILLED_AMT,0) AS OUTSIDE_EXPENSES,
	ISNULL(#AMTBILLEDSUM.BILLED_AMT,0) + ISNULL(#IOBILLED.BILLED_AMT,0) + ISNULL(#VENDORBILLED.BILLED_AMT,0) AS TOTAL_BILLED_YTD,
	ISNULL(#ESTSUMS.TOTAL,0) - ( ISNULL(#AMTBILLEDSUM.BILLED_AMT,0) + ISNULL(#IOBILLED.BILLED_AMT,0) + ISNULL(#VENDORBILLED.BILLED_AMT,0) ) AS UNDER_OVER_BUDGET,
	ISNULL(#HRS_TOT_AMT.HOURS_TOTAL_AMT,0) - ISNULL(#AMTBILLEDSUM.BILLED_AMT,0) AS UNBILLED

FROM CAMPAIGN CMP
  INNER JOIN CLIENT C ON C.CL_CODE = CMP.CL_CODE
  LEFT OUTER JOIN JOB_LOG JL ON JL.CMP_CODE = CMP.CMP_CODE
  LEFT OUTER JOIN JOB_COMPONENT JC ON JL.JOB_NUMBER = JC.JOB_NUMBER
  LEFT OUTER JOIN #ESTSUMS ON #ESTSUMS.CL_CODE = C.CL_CODE 
					AND #ESTSUMS.JOB_NUMBER = JC.JOB_NUMBER
					AND #ESTSUMS.JOB_COMPONENT_NBR = JC.JOB_COMPONENT_NBR
  LEFT OUTER JOIN #HRS_TOT_AMT ON #HRS_TOT_AMT.JOB_NUMBER = JC.JOB_NUMBER
					AND #HRS_TOT_AMT.JOB_COMPONENT_NBR = JC.JOB_COMPONENT_NBR
  LEFT OUTER JOIN #NB_AMOUNT ON #NB_AMOUNT.JOB_NUMBER = JC.JOB_NUMBER
					AND #NB_AMOUNT.JOB_COMPONENT_NBR = JC.JOB_COMPONENT_NBR
  LEFT OUTER JOIN #BILLABLE_AMOUNT ON #BILLABLE_AMOUNT.JOB_NUMBER = JC.JOB_NUMBER
					AND #BILLABLE_AMOUNT.JOB_COMPONENT_NBR = JC.JOB_COMPONENT_NBR
  LEFT OUTER JOIN #AMTBILLEDSUM ON #AMTBILLEDSUM.JOB_NUMBER = JC.JOB_NUMBER
					AND #AMTBILLEDSUM.JOB_COMPONENT_NBR = JC.JOB_COMPONENT_NBR
  LEFT OUTER JOIN #IOBILLED ON #IOBILLED.JOB_NUMBER = JC.JOB_NUMBER
					AND #IOBILLED.JOB_COMPONENT_NBR = JC.JOB_COMPONENT_NBR
  LEFT OUTER JOIN #VENDORBILLED ON #VENDORBILLED.JOB_NUMBER = JC.JOB_NUMBER
					AND #VENDORBILLED.JOB_COMPONENT_NBR = JC.JOB_COMPONENT_NBR

WHERE CMP.CMP_IDENTIFIER = @CmpCode

ORDER BY C.CL_CODE




