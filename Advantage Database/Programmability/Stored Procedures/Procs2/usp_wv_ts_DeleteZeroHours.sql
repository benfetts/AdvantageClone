SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS OFF 
GO
IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[usp_wv_ts_DeleteZeroHours]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[usp_wv_ts_DeleteZeroHours]
GO
CREATE PROCEDURE [dbo].[usp_wv_ts_DeleteZeroHours] /*WITH ENCRYPTION*/
@EMP_CODE VARCHAR(6),
@DATE SMALLDATETIME
AS
/*=========== QUERY ===========*/

	CREATE TABLE #ZERO_HOURS( et_id integer, 
	etd_id integer, 
	time_type char(1), 
	)

	DECLARE
		@STOPWATCH_ET_ID INT,
		@STOPWATCH_ET_DTL_ID SMALLINT

    SELECT @STOPWATCH_ET_ID =  ET_ID, @STOPWATCH_ET_DTL_ID = STOP_WATCH_ET_DTL_ID FROM EMP_TIME WITH(NOLOCK) WHERE EMP_CODE = @EMP_CODE AND EMP_DATE = @DATE;
    
    SET @STOPWATCH_ET_ID = ISNULL(@STOPWATCH_ET_ID, 0);
    SET @STOPWATCH_ET_DTL_ID = ISNULL(@STOPWATCH_ET_DTL_ID, 0);
   
	INSERT INTO #ZERO_HOURS
	SELECT     EMP_TIME_DTL.ET_ID, EMP_TIME_DTL.ET_DTL_ID, 'D'
	FROM         EMP_TIME INNER JOIN
						  EMP_TIME_DTL ON EMP_TIME.ET_ID = EMP_TIME_DTL.ET_ID
	WHERE     (EMP_TIME.EMP_CODE = @EMP_CODE) AND (EMP_TIME.EMP_DATE = @DATE) AND (EMP_TIME_DTL.EMP_HOURS = 0)

	INSERT INTO #ZERO_HOURS
	SELECT     EMP_TIME_NP.ET_ID, EMP_TIME_NP.ET_DTL_ID, 'N'
	FROM         EMP_TIME INNER JOIN
						  EMP_TIME_NP ON EMP_TIME.ET_ID = EMP_TIME_NP.ET_ID
	WHERE     (EMP_TIME.EMP_CODE = @EMP_CODE) AND (EMP_TIME.EMP_DATE = @DATE) AND (EMP_TIME_NP.EMP_HOURS = 0)

	DECLARE @CURR_ET_ID INT, @CURR_ETD_ID SMALLINT, @CURR_TYPE CHAR(1), @OUT VARCHAR(256)
	
	--SELECT * FROM #ZERO_HOURS
	DECLARE @TEST INT

	DECLARE MY_ROWS CURSOR FOR
	SELECT et_id,etd_id,time_type FROM #ZERO_HOURS
	OPEN MY_ROWS

		FETCH NEXT FROM MY_ROWS INTO @CURR_ET_ID, @CURR_ETD_ID, @CURR_TYPE;
		WHILE @@FETCH_STATUS = 0
		BEGIN

			
			IF (@STOPWATCH_ET_ID > 0 AND @STOPWATCH_ET_DTL_ID > 0) AND @CURR_ET_ID = @STOPWATCH_ET_ID AND @CURR_ETD_ID = @STOPWATCH_ET_DTL_ID
			BEGIN
				SELECT @TEST = 0;
			END
			ELSE
			BEGIN
				EXEC usp_wv_ts_delete @CURR_ET_ID,@CURR_ETD_ID, @CURR_TYPE, @OUT;
			END
			
			FETCH NEXT FROM MY_ROWS INTO @CURR_ET_ID, @CURR_ETD_ID, @CURR_TYPE;

		END

	CLOSE MY_ROWS;
	DEALLOCATE MY_ROWS;

	DROP TABLE #ZERO_HOURS;

/*=========== QUERY ===========*/
GO
SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO