SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS OFF 
GO
IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[usp_wv_ts_GetTimesheetFromDetailId]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[usp_wv_ts_GetTimesheetFromDetailId]
GO
CREATE PROCEDURE [dbo].[usp_wv_ts_GetTimesheetFromDetailId] /*WITH ENCRYPTION*/
@ET_ID INT,
@ET_DTL_ID SMALLINT,
@USER_CODE VARCHAR(100)
AS
/*=========== QUERY ===========*/
	DECLARE
		@EMP_CODE VARCHAR(6),
		@EMP_DATE SMALLDATETIME
		
	SELECT @EMP_CODE = EMP_TIME.EMP_CODE, @EMP_DATE = EMP_TIME.EMP_DATE
	FROM EMP_TIME WITH(NOLOCK) INNER JOIN
         EMP_TIME_DTL WITH(NOLOCK) ON EMP_TIME.ET_ID = EMP_TIME_DTL.ET_ID
    WHERE EMP_TIME_DTL.ET_ID = @ET_ID AND EMP_TIME_DTL.ET_DTL_ID = @ET_DTL_ID;  
    
    IF @EMP_CODE IS NULL OR @EMP_DATE IS NULL
    BEGIN
		-- MUST BE NP TIME
		SELECT     @EMP_CODE = EMP_TIME.EMP_CODE, @EMP_DATE = EMP_TIME.EMP_DATE
		FROM         EMP_TIME INNER JOIN
							  EMP_TIME_NP ON EMP_TIME.ET_ID = EMP_TIME_NP.ET_ID
		WHERE     (EMP_TIME_NP.ET_DTL_ID = @ET_DTL_ID) AND (EMP_TIME_NP.ET_ID = @ET_ID)		
    END            
	
	--SELECT @EMP_CODE AS EMP_CODE, @EMP_DATE AS EMP_DATE;
	EXEC usp_wv_ts_GetTimeSheet @EMP_CODE, @EMP_DATE, @EMP_DATE, 'CL_CODE', @USER_CODE;
/*=========== QUERY ===========*/
GO
SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO