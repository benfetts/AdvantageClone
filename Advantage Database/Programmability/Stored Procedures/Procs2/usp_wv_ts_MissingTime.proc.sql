--DROP PROCEDURE [dbo].[usp_wv_ts_MissingTime]
CREATE PROCEDURE [dbo].[usp_wv_ts_MissingTime] 
@EMP_CODE VarChar(6)
AS
	DECLARE
		@EMAIL_SUPERVISOR SMALLINT,
		@EMAIL_IT_CONTACT SMALLINT,
		@IT_CONTACT_EMAIL VARCHAR(50)

	SELECT 
		@EMAIL_SUPERVISOR = ISNULL(EMAIL_SUPERVISOR, 0), 
		@EMAIL_IT_CONTACT = ISNULL(EMAIL_IT_CONTACT, 0), 
		@IT_CONTACT_EMAIL = IT_CONTACT_EMAIL 
	FROM 
		AGENCY WITH(NOLOCK);

	SELECT     
		EMPLOYEE.EMP_CODE, 
		ISNULL(EMPLOYEE.EMP_FNAME + ' ', '') + ISNULL(EMPLOYEE.EMP_MI + '. ', ' ') + ISNULL(EMPLOYEE.EMP_LNAME, '')+ ' (' + EMPLOYEE.EMP_CODE + ')' AS EMP_FULLNAME, 
		ISNULL(EMPLOYEE.MISSING_TIME,0) AS MISSING_TIME,
		CASE 
			WHEN SUPERVISOR.ALERT_EMAIL IS NULL THEN 0
			WHEN SUPERVISOR.ALERT_EMAIL <> 3 THEN 0
			ELSE @EMAIL_SUPERVISOR 
		END 
		AS EMAIL_SUPERVISOR, 
		SUPERVISOR.EMP_EMAIL AS SUPERVISOR_EMAIL,
		@EMAIL_IT_CONTACT AS EMAIL_IT_CONTACT,
		@IT_CONTACT_EMAIL AS IT_CONTACT_EMAIL
	FROM 
		EMPLOYEE WITH (NOLOCK) LEFT OUTER JOIN
   		EMPLOYEE AS SUPERVISOR WITH (NOLOCK) ON EMPLOYEE.SUPERVISOR_CODE = SUPERVISOR.EMP_CODE
	WHERE
		(EMPLOYEE.EMP_CODE=@EMP_CODE);