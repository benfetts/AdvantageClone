SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS OFF 
GO
IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[usp_wv_ts_StopwatchGetDescription]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[usp_wv_ts_StopwatchGetDescription]
GO
CREATE PROCEDURE [dbo].[usp_wv_ts_StopwatchGetDescription] /*WITH ENCRYPTION*/
@ET_ID INT,
@ET_DTL_ID SMALLINT
AS
/*=========== QUERY ===========*/
	DECLARE
		@DESCRIPTION VARCHAR(60),
		@JOB_NUMBER INT,
		@JOB_COMPONENT_NBR SMALLINT

	SELECT    
		@JOB_NUMBER = EMP_TIME_DTL.JOB_NUMBER, 
		@JOB_COMPONENT_NBR = EMP_TIME_DTL.JOB_COMPONENT_NBR, 
		@DESCRIPTION = JOB_COMPONENT.JOB_COMP_DESC
	FROM         
		EMP_TIME_DTL WITH(NOLOCK) INNER JOIN
		JOB_COMPONENT WITH(NOLOCK) ON EMP_TIME_DTL.JOB_NUMBER = JOB_COMPONENT.JOB_NUMBER AND 
		EMP_TIME_DTL.JOB_COMPONENT_NBR = JOB_COMPONENT.JOB_COMPONENT_NBR
	WHERE
		(EMP_TIME_DTL.ET_ID = @ET_ID)
		AND (EMP_TIME_DTL.ET_DTL_ID = @ET_DTL_ID);
		
	IF @JOB_NUMBER IS NULL OR @JOB_COMPONENT_NBR IS NULL
	BEGIN
		SELECT @DESCRIPTION = A.[DESCRIPTION]
		FROM (
			SELECT     
				TOP 1 ISNULL(TIME_CATEGORY.[DESCRIPTION], EMP_TIME_NP.CATEGORY) AS [DESCRIPTION]
			FROM         
				EMP_TIME_NP WITH(NOLOCK) LEFT OUTER JOIN
				TIME_CATEGORY WITH(NOLOCK) ON EMP_TIME_NP.CATEGORY = TIME_CATEGORY.CATEGORY
			WHERE     
				(EMP_TIME_NP.ET_ID = @ET_ID) 
				AND (EMP_TIME_NP.ET_DTL_ID = @ET_DTL_ID)
		) AS [A];
	END	                      

	SELECT ISNULL(@DESCRIPTION,'') AS [DESCRIPTION];
/*=========== QUERY ===========*/
GO
SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO