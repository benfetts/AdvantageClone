SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS OFF 
GO
IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[usp_wv_ts_get_settings]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[usp_wv_ts_get_settings]
GO
CREATE PROCEDURE [dbo].[usp_wv_ts_get_settings] /*WITH ENCRYPTION*/
@USER_CODE VARCHAR(100)
AS
/*=========== QUERY ===========*/
	DECLARE
		@AGY_DAYS_TO_DISPLAY INT,
		@AGY_SHOW_COMMENT_USING VARCHAR(10),
		@AGY_START_WEEK_ON SMALLINT,
		@AGY_MAIN_TS_NO_PAGING BIT,
		@AGY_DIVISION VARCHAR(100),
		@AGY_PRODUCT VARCHAR(100),
		@AGY_PROD_CAT VARCHAR(100),
		@AGY_JOB VARCHAR(100),
		@AGY_JOB_COMP VARCHAR(100),
		@AGY_FUNC_CAT VARCHAR(100),
		@AGY_OVERRIDE BIT,
			
		@USER_DAYS_TO_DISPLAY INT,
		@USER_SHOW_COMMENT_USING VARCHAR(10),
		@USER_START_WEEK_ON SMALLINT,
		@USER_MAIN_TS_NO_PAGING BIT,
		@USER_REPEAT_ROWS BIT,
		@USER_ONLY_SHOW_MY_PROGRESS BIT,
		@USER_DIVISION VARCHAR(100),
		@USER_PRODUCT VARCHAR(100),
		@USER_PROD_CAT VARCHAR(100),
		@USER_JOB VARCHAR(100),
		@USER_JOB_COMP VARCHAR(100),
		@USER_FUNC_CAT VARCHAR(100)

		SELECT @AGY_DAYS_TO_DISPLAY = CONVERT(INT, AGENCY.TS_DAYS_PER_WK) FROM AGENCY WITH(NOLOCK);
		SELECT @AGY_SHOW_COMMENT_USING = CONVERT(VARCHAR, AGY_SETTINGS_VALUE) FROM AGY_SETTINGS WITH(NOLOCK) WHERE AGY_SETTINGS_CODE = 'TS_SHOW_CMNT_USING';
		SELECT @AGY_START_WEEK_ON = CONVERT(SMALLINT, AGY_SETTINGS_VALUE) FROM AGY_SETTINGS WITH(NOLOCK) WHERE AGY_SETTINGS_CODE = 'TS_START_WEEK_ON';
		SELECT @AGY_MAIN_TS_NO_PAGING = CONVERT(BIT, AGY_SETTINGS_VALUE) FROM AGY_SETTINGS WITH(NOLOCK) WHERE AGY_SETTINGS_CODE = 'MAIN_TS_NO_PAGING';
		SELECT @AGY_DIVISION = CONVERT(VARCHAR, AGY_SETTINGS_VALUE) FROM AGY_SETTINGS WITH(NOLOCK) WHERE AGY_SETTINGS_CODE = 'TS_DIVISION';
		SELECT @AGY_PRODUCT = CONVERT(VARCHAR, AGY_SETTINGS_VALUE) FROM AGY_SETTINGS WITH(NOLOCK) WHERE AGY_SETTINGS_CODE = 'TS_PRODUCT';
		SELECT @AGY_PROD_CAT = CONVERT(VARCHAR, AGY_SETTINGS_VALUE) FROM AGY_SETTINGS WITH(NOLOCK) WHERE AGY_SETTINGS_CODE = 'TS_PROD_CAT';
		SELECT @AGY_JOB = CONVERT(VARCHAR, AGY_SETTINGS_VALUE) FROM AGY_SETTINGS WITH(NOLOCK) WHERE AGY_SETTINGS_CODE = 'TS_JOB';
		SELECT @AGY_JOB_COMP = CONVERT(VARCHAR, AGY_SETTINGS_VALUE) FROM AGY_SETTINGS WITH(NOLOCK) WHERE AGY_SETTINGS_CODE = 'TS_JOB_COMP';
		SELECT @AGY_FUNC_CAT = CONVERT(VARCHAR, AGY_SETTINGS_VALUE) FROM AGY_SETTINGS WITH(NOLOCK) WHERE AGY_SETTINGS_CODE = 'TS_FUNC_CAT';
		SELECT @AGY_OVERRIDE = CONVERT(VARCHAR, AGY_SETTINGS_VALUE) FROM AGY_SETTINGS WITH(NOLOCK) WHERE AGY_SETTINGS_CODE = 'TS_AGY_OVRRDE';

		IF @AGY_DAYS_TO_DISPLAY IS NULL SET @AGY_DAYS_TO_DISPLAY = 7;
		IF @AGY_SHOW_COMMENT_USING IS NULL SET @AGY_SHOW_COMMENT_USING = 'icon';
		IF @AGY_START_WEEK_ON IS NULL SET @AGY_START_WEEK_ON = 0;
		IF @AGY_DIVISION IS NULL SET @AGY_DIVISION = 'Division';
		IF @AGY_PRODUCT IS NULL SET @AGY_PRODUCT = 'Product';
		IF @AGY_PROD_CAT IS NULL SET @AGY_PROD_CAT = 'Prod Cat';
		IF @AGY_JOB IS NULL SET @AGY_JOB = 'Job';
		IF @AGY_JOB_COMP IS NULL SET @AGY_JOB_COMP = 'Component';
		IF @AGY_FUNC_CAT IS NULL SET @AGY_FUNC_CAT = 'Func/Cat';
		IF @AGY_MAIN_TS_NO_PAGING IS NULL SET @AGY_MAIN_TS_NO_PAGING = 0;
		IF @AGY_OVERRIDE IS NULL SET @AGY_OVERRIDE = 0;

		IF @AGY_DAYS_TO_DISPLAY NOT IN (1, 5, 7) SET @AGY_DAYS_TO_DISPLAY = 7;
		IF RTRIM(LTRIM(@AGY_SHOW_COMMENT_USING)) = '' SET @AGY_SHOW_COMMENT_USING = 'icon';
		IF RTRIM(LTRIM(@AGY_DIVISION)) = '' SET @AGY_DIVISION = 'Division';
		IF RTRIM(LTRIM(@AGY_PRODUCT)) = '' SET @AGY_PRODUCT = 'Product';
		IF RTRIM(LTRIM(@AGY_PROD_CAT)) = '' SET @AGY_PROD_CAT = 'Prod Cat';
		IF RTRIM(LTRIM(@AGY_JOB)) = '' SET @AGY_JOB = 'Job';
		IF RTRIM(LTRIM(@AGY_JOB_COMP)) = '' SET @AGY_JOB_COMP = 'Component';
		IF RTRIM(LTRIM(@AGY_FUNC_CAT)) = '' SET @AGY_FUNC_CAT = 'Func/Cat';

		IF NOT @USER_CODE IS NULL
		BEGIN

			SELECT @USER_DAYS_TO_DISPLAY = CONVERT(INT, VARIABLE_VALUE) FROM APP_VARS WITH(NOLOCK) WHERE UPPER(USERID) = UPPER(@USER_CODE) AND [APPLICATION] = 'TIMESHEET' AND VARIABLE_NAME = 'DAYS_TO_DISPLAY'; 
			SELECT @USER_SHOW_COMMENT_USING = CONVERT(VARCHAR, VARIABLE_VALUE) FROM APP_VARS WITH(NOLOCK) WHERE UPPER(USERID) = UPPER(@USER_CODE) AND [APPLICATION] = 'TIMESHEET' AND VARIABLE_NAME = 'SHOW_CMNT_USING'; 
			SELECT @USER_START_WEEK_ON = CONVERT(SMALLINT, VARIABLE_VALUE) FROM APP_VARS WITH(NOLOCK) WHERE UPPER(USERID) = UPPER(@USER_CODE) AND [APPLICATION] = 'TIMESHEET' AND VARIABLE_NAME = 'START_WEEK_ON'; 
			SELECT @USER_MAIN_TS_NO_PAGING = CONVERT(BIT, VARIABLE_VALUE) FROM APP_VARS WITH(NOLOCK) WHERE UPPER(USERID) = UPPER(@USER_CODE) AND [APPLICATION] = 'TIMESHEET' AND VARIABLE_NAME = 'MAIN_TS_NO_PAGING'; 
			SELECT @USER_REPEAT_ROWS = CONVERT(BIT, VARIABLE_VALUE) FROM APP_VARS WITH(NOLOCK) WHERE UPPER(USERID) = UPPER(@USER_CODE) AND [APPLICATION] = 'TIMESHEET' AND VARIABLE_NAME = 'REPEAT_ROWS'; 
			SELECT @USER_ONLY_SHOW_MY_PROGRESS = CONVERT(BIT, VARIABLE_VALUE) FROM APP_VARS WITH(NOLOCK) WHERE UPPER(USERID) = UPPER(@USER_CODE) AND [APPLICATION] = 'TIMESHEET' AND VARIABLE_NAME = 'ONLY_SHOW_MY_PROGRESS'; 
		
			SELECT @USER_DIVISION = CONVERT(VARCHAR, VARIABLE_VALUE) FROM APP_VARS WITH(NOLOCK) WHERE UPPER(USERID) = UPPER(@USER_CODE) AND [APPLICATION] = 'TIMESHEET' AND VARIABLE_NAME = 'DIVISION'; 
			SELECT @USER_PRODUCT = CONVERT(VARCHAR, VARIABLE_VALUE) FROM APP_VARS WITH(NOLOCK) WHERE UPPER(USERID) = UPPER(@USER_CODE) AND [APPLICATION] = 'TIMESHEET' AND VARIABLE_NAME = 'PRODUCT'; 
			SELECT @USER_PROD_CAT = CONVERT(VARCHAR, VARIABLE_VALUE) FROM APP_VARS WITH(NOLOCK) WHERE UPPER(USERID) = UPPER(@USER_CODE) AND [APPLICATION] = 'TIMESHEET' AND VARIABLE_NAME = 'PROD_CAT'; 
			SELECT @USER_JOB = CONVERT(VARCHAR, VARIABLE_VALUE) FROM APP_VARS WITH(NOLOCK) WHERE UPPER(USERID) = UPPER(@USER_CODE) AND [APPLICATION] = 'TIMESHEET' AND VARIABLE_NAME = 'JOB'; 
			SELECT @USER_JOB_COMP = CONVERT(VARCHAR, VARIABLE_VALUE) FROM APP_VARS WITH(NOLOCK) WHERE UPPER(USERID) = UPPER(@USER_CODE) AND [APPLICATION] = 'TIMESHEET' AND VARIABLE_NAME = 'JOB_COMP'; 
			SELECT @USER_FUNC_CAT = CONVERT(VARCHAR, VARIABLE_VALUE) FROM APP_VARS WITH(NOLOCK) WHERE UPPER(USERID) = UPPER(@USER_CODE) AND [APPLICATION] = 'TIMESHEET' AND VARIABLE_NAME = 'FUNC_CAT'; 
		
		END
		
		IF @USER_DAYS_TO_DISPLAY IS NULL SET @USER_DAYS_TO_DISPLAY = @AGY_DAYS_TO_DISPLAY;
		IF @USER_SHOW_COMMENT_USING IS NULL SET @USER_SHOW_COMMENT_USING = @AGY_SHOW_COMMENT_USING;
		IF @USER_START_WEEK_ON IS NULL SET @USER_START_WEEK_ON = @AGY_START_WEEK_ON;
		IF @USER_DIVISION IS NULL SET @USER_DIVISION = @AGY_DIVISION;
		IF @USER_PRODUCT IS NULL SET @USER_PRODUCT = @AGY_PRODUCT;
		IF @USER_PROD_CAT IS NULL SET @USER_PROD_CAT = @AGY_PROD_CAT;
		IF @USER_JOB IS NULL SET @USER_JOB = @AGY_JOB;
		IF @USER_JOB_COMP IS NULL SET @USER_JOB_COMP = @AGY_JOB_COMP;
		IF @USER_FUNC_CAT IS NULL SET @USER_FUNC_CAT = @AGY_FUNC_CAT;
		IF @USER_MAIN_TS_NO_PAGING IS NULL SET @USER_MAIN_TS_NO_PAGING = @AGY_MAIN_TS_NO_PAGING;

		IF @USER_DAYS_TO_DISPLAY NOT IN (1, 5, 7) SET @USER_DAYS_TO_DISPLAY = @AGY_DAYS_TO_DISPLAY;
		IF RTRIM(LTRIM(@USER_SHOW_COMMENT_USING)) = '' SET @USER_SHOW_COMMENT_USING = @AGY_SHOW_COMMENT_USING;
		IF RTRIM(LTRIM(@USER_DIVISION)) = '' SET @USER_DIVISION = @AGY_DIVISION;
		IF RTRIM(LTRIM(@USER_PRODUCT)) = '' SET @USER_PRODUCT = @AGY_PRODUCT;
		IF RTRIM(LTRIM(@USER_PROD_CAT)) = '' SET @USER_PROD_CAT = @AGY_PROD_CAT;
		IF RTRIM(LTRIM(@USER_JOB)) = '' SET @USER_JOB = @AGY_JOB;
		IF RTRIM(LTRIM(@USER_JOB_COMP)) = '' SET @USER_JOB_COMP = @AGY_JOB_COMP;
		IF RTRIM(LTRIM(@USER_FUNC_CAT)) = '' SET @USER_FUNC_CAT = @AGY_FUNC_CAT;

	IF (SELECT TIME_COMMENTS_REQ FROM AGENCY WITH(NOLOCK)) = 1
	BEGIN
		SET @USER_SHOW_COMMENT_USING = 'textbox';
	END

	SELECT 
		ISNULL(@USER_DAYS_TO_DISPLAY, 7) AS DAYS_TO_DISPLAY,
		ISNULL(@USER_SHOW_COMMENT_USING, 'icon') AS SHOW_COMMENT_USING,
		ISNULL(@USER_START_WEEK_ON, 0) AS START_WEEK_ON,
		ISNULL(@USER_DIVISION, 'Division') AS DIVISION_LABEL,
		ISNULL(@USER_PRODUCT, 'Product') AS PRODUCT_LABEL,
		ISNULL(@USER_PROD_CAT, 'Product Category') AS PROD_CAT_LABEL,
		ISNULL(@USER_JOB, 'Job') AS JOB_LABEL,
		ISNULL(@USER_JOB_COMP, 'Job Component') AS JOB_COMP_LABEL,
		ISNULL(@USER_FUNC_CAT, 'Function/Category') AS FUNC_CAT_LABEL,
		ISNULL(@USER_MAIN_TS_NO_PAGING, 0) AS MAIN_TS_NO_PAGING,
		ISNULL(@USER_REPEAT_ROWS, 0) AS REPEAT_ROWS,
		ISNULL(@USER_ONLY_SHOW_MY_PROGRESS, 0) AS ONLY_SHOW_MY_PROGRESS,
		ISNULL(@AGY_OVERRIDE, 0) AS AGY_OVERRIDE
		 
	;
/*=========== QUERY ===========*/
GO
SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

