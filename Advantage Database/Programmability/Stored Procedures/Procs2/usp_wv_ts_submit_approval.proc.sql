
--DROP PROCEDURE [dbo].[usp_wv_ts_submit_approval] 
CREATE PROCEDURE [dbo].[usp_wv_ts_submit_approval] 
@EmpCode  AS VARCHAR(6),
@EmpDate  AS SMALLDATETIME,
@Approve  AS INT
AS

    DECLARE
	    @TIME_APPR_ACTIVE AS SMALLINT
    	
	SELECT @TIME_APPR_ACTIVE = ISNULL(TIME_APPR_ACTIVE,0) 
	FROM AGENCY WITH(NOLOCK);
	
	SET @TIME_APPR_ACTIVE = ISNULL(@TIME_APPR_ACTIVE,0);
		
	IF @TIME_APPR_ACTIVE = 1 AND (NOT @EmpCode IS NULL)
	BEGIN
		
		SELECT @TIME_APPR_ACTIVE = ISNULL(TS_APPR_FLAG, 0)
		FROM EMPLOYEE WITH(NOLOCK) 
		WHERE EMP_CODE = @EmpCode;

		--THE EMP TABLE FLAG ACTS AS AN EXEMPTION; NOT INCLUSION
		IF @TIME_APPR_ACTIVE = 1
		BEGIN
			SET @TIME_APPR_ACTIVE = 0
		END
		ELSE
		BEGIN
			SET @TIME_APPR_ACTIVE = 1
		END
		
	END

	SET @TIME_APPR_ACTIVE = ISNULL(@TIME_APPR_ACTIVE,0);

    IF @TIME_APPR_ACTIVE = 1
    BEGIN
	    IF @Approve = 1
		    BEGIN
			    UPDATE EMP_TIME WITH(ROWLOCK)
			    SET    APPR_PENDING = 1, APPR_FLAG = 0
			    WHERE  EMP_CODE = @EmpCode
				       AND EMP_DATE = @EmpDate;
		    END
	    ELSE
		    BEGIN
			    UPDATE EMP_TIME WITH(ROWLOCK)
			    SET    APPR_PENDING = NULL, APPR_FLAG = NULL
			    WHERE  EMP_CODE = @EmpCode
				       AND EMP_DATE = @EmpDate;
		    END
    END