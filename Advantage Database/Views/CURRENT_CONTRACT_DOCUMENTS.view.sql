SET QUOTED_IDENTIFIER ON 
GO

SET ANSI_PADDING OFF
GO

SET ANSI_NULLS ON 
GO

IF EXISTS ( SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID( N'[dbo].[CURRENT_CONTRACT_DOCUMENTS]') AND OBJECTPROPERTY( id, N'IsView' ) = 1 )
	DROP VIEW [dbo].[CURRENT_CONTRACT_DOCUMENTS]
GO

CREATE VIEW [dbo].[CURRENT_CONTRACT_DOCUMENTS]
	AS
	SELECT   'Contract' AS LEVEL, dbo.CONTRACT_DOCUMENTS.CONTRACT_ID, dbo.DOCUMENTS.DOCUMENT_ID, dbo.DOCUMENTS.FILENAME, dbo.DOCUMENTS.MIME_TYPE, 
						  dbo.DOCUMENTS.DESCRIPTION, dbo.DOCUMENTS.KEYWORDS, dbo.DOCUMENTS.UPLOADED_DATE, dbo.DOCUMENTS.USER_CODE, 
						  dbo.DOCUMENTS.FILE_SIZE,  dbo.DOCUMENTS.USER_CODE AS [USER_NAME], dbo.DOCUMENTS.REPOSITORY_FILENAME, 
						  dbo.DOCUMENT_TYPE.DOCUMENT_TYPE_DESC, ISNULL(dbo.DOCUMENTS.PRIVATE_FLAG, 0) AS PRIVATE_FLAG
	FROM         dbo.DOCUMENTS INNER JOIN
						  dbo.CONTRACT_DOCUMENTS ON dbo.DOCUMENTS.DOCUMENT_ID = dbo.CONTRACT_DOCUMENTS.DOCUMENT_ID INNER JOIN
						  dbo.DOCUMENT_TYPE ON dbo.DOCUMENTS.DOCUMENT_TYPE_ID = dbo.DOCUMENT_TYPE.DOCUMENT_TYPE_ID
	WHERE     (dbo.DOCUMENTS.DOCUMENT_ID IN
							  (SELECT     MAX(CONTRACT_DOCUMENTS_1.DOCUMENT_ID) AS DOCUMENT_ID
								FROM          dbo.CONTRACT_DOCUMENTS AS CONTRACT_DOCUMENTS_1 INNER JOIN
													   dbo.DOCUMENTS AS DOCUMENTS_1 ON CONTRACT_DOCUMENTS_1.DOCUMENT_ID = DOCUMENTS_1.DOCUMENT_ID
								GROUP BY CONTRACT_DOCUMENTS_1.DOCUMENT_ID, DOCUMENTS_1.FILENAME))
GO

IF ( @@ERROR = 0 )
	GRANT SELECT ON [CURRENT_CONTRACT_DOCUMENTS] TO PUBLIC AS dbo
GO	