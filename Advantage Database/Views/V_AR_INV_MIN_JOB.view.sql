-- V_AR_INV_MIN_JOB
-- #00 08/17/12 - initial version

SET QUOTED_IDENTIFIER ON 
GO

SET ANSI_NULLS ON 
GO

SET ANSI_PADDING OFF
GO

IF EXISTS ( SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID( N'[dbo].[V_AR_INV_MIN_JOB]' ) AND OBJECTPROPERTY( id, N'IsView' ) = 1 )
	DROP VIEW [dbo].[V_AR_INV_MIN_JOB]
GO

CREATE VIEW dbo.V_AR_INV_MIN_JOB
AS

-- Finds the min job/component for each invoice in [dbo].[ARINV_JOB]
SELECT
	mj.AR_INV_NBR,
	mj.JOB_NUMBER,
	MIN(mj.JOB_COMPONENT_NBR) AS JOB_COMPONENT_NBR
FROM dbo.ARINV_JOB AS mj
JOIN dbo.JOB_LOG jl
	ON mj.JOB_NUMBER = jl.JOB_NUMBER
WHERE mj.JOB_NUMBER = (SELECT MIN(mj2.JOB_NUMBER) FROM dbo.ARINV_JOB mj2
	WHERE mj.AR_INV_NBR = mj2.AR_INV_NBR)
GROUP BY mj.AR_INV_NBR, mj.JOB_NUMBER

GO

IF ( @@ERROR = 0 ) 
	GRANT ALL ON [V_AR_INV_MIN_JOB] TO PUBLIC AS dbo
GO	

