
CREATE VIEW [dbo].[V_EMPTIME_OFFICE_CL]
AS

	SELECT
		[ITEM_DATE] = e.[ITEM_DATE],
		[LINE_TOTAL] = SUM(e.[TOTAL_BILL]),
		[HOURS_QTY] = SUM(e.[HOURS_QTY]),
		e.[CL_CODE],
		e.[CL_NAME],
		e.[OFFICE_CODE],
		e.[OFFICE_NAME]
	FROM
		(SELECT
			[JOB_NUMBER] = e.JOB_NUMBER,
			[JOB_COMPONENT_NBR] = e.JOB_COMPONENT_NBR,
			[ITEM_DATE] = et.EMP_DATE,
			[TOTAL_BILL] = ISNULL(e.LINE_TOTAL,0) - ISNULL(e.EXT_STATE_RESALE,0) - ISNULL(e.EXT_COUNTY_RESALE,0) - ISNULL(e.EXT_CITY_RESALE,0),
			[HOURS_QTY] = ISNULL(e.EMP_HOURS,0),
			[CL_CODE] = c.CL_CODE,
			[CL_NAME] = c.CL_NAME,
			[OFFICE_CODE] = o.OFFICE_CODE,
			[OFFICE_NAME] = o.OFFICE_NAME
		 FROM 
			dbo.EMP_TIME_DTL AS e INNER JOIN 
			dbo.EMP_TIME AS et ON e.ET_ID = et.ET_ID INNER JOIN 
			dbo.JOB_LOG AS jl ON jl.JOB_NUMBER = e.JOB_NUMBER INNER JOIN 
			dbo.CLIENT AS c ON c.CL_CODE = jl.CL_CODE INNER JOIN
			dbo.OFFICE AS o ON o.OFFICE_CODE = jl.OFFICE_CODE
		 WHERE
			(e.EMP_NON_BILL_FLAG = 1 AND 
			 e.FEE_TIME = 1) OR
			e.EMP_NON_BILL_FLAG <> 1) AS e
	GROUP BY
		e.[ITEM_DATE],
		e.[OFFICE_CODE],
		e.[OFFICE_NAME],
		e.[CL_CODE],
		e.[CL_NAME]
