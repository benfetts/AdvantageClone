
CREATE VIEW [dbo].[V_ESTIMATEAPPR]
AS

	SELECT
		EST_APPR.JOB_NUMBER, 
		EST_APPR.JOB_COMPONENT_NBR, 
		EST_APPR.ESTIMATE_NUMBER, 
		EST_APPR.EST_COMPONENT_NBR, 
		EST_APPR.EST_QUOTE_NBR, 
		EST_APPR.EST_REVISION_NBR,
		EST_APPR.[TYPE],
		[CL_EST_APPR_BY] = EA.EST_APPR_BY, 
		[CL_EST_APPR_DATE] = EA.EST_APPR_DATE, 
		[CL_EST_APPR_PO_NBR] = EA.EST_APPR_CL_PO_NBR, 
		[CL_EMP_CODE] = EA.EMP_CODE, 
		[CL_APPR_PWD] = EA.APPR_PWD, 
		[CL_APPROVAL_PWD] = EA.APPROVAL_PWD, 
		[CL_CREATE_USER] = EA.CREATE_USER, 
		[CL_CREATE_DATE] = EA.CREATE_DATE, 
		[CL_APPR_NOTES] = EA.APPR_NOTES,
		[IN_EST_APPR_BY] = EIA.EST_APPR_BY, 
		[IN_EST_APPR_DATE] = EIA.EST_APPR_DATE, 
		[IN_EMP_CODE] = EIA.EMP_CODE, 
		[IN_APPR_PWD] = EIA.APPR_PWD, 
		[IN_APPROVAL_PWD] = EIA.APPROVAL_PWD, 
		[IN_CREATE_USER] = EIA.CREATE_USER, 
		[IN_CREATE_DATE] = EIA.CREATE_DATE, 
		[IN_APPR_NOTES] = EIA.APPR_NOTES
	FROM
		(SELECT
			EST_APPR_SUB.JOB_NUMBER, 
			EST_APPR_SUB.JOB_COMPONENT_NBR, 
			EST_APPR_SUB.ESTIMATE_NUMBER, 
			EST_APPR_SUB.EST_COMPONENT_NBR, 
			EST_APPR_SUB.EST_QUOTE_NBR, 
			EST_APPR_SUB.EST_REVISION_NBR,
			[TYPE] = SUM(EST_APPR_SUB.[TYPE])
		 FROM
			 (SELECT
				JOB_NUMBER, 
				JOB_COMPONENT_NBR, 
				ESTIMATE_NUMBER, 
				EST_COMPONENT_NBR, 
				EST_QUOTE_NBR, 
				EST_REVISION_NBR,
				[TYPE] = 2
			 FROM
				[dbo].[ESTIMATE_APPROVAL]
				 
			 UNION ALL
			 
			 SELECT
				JOB_NUMBER, 
				JOB_COMPONENT_NBR, 
				ESTIMATE_NUMBER, 
				EST_COMPONENT_NBR, 
				EST_QUOTE_NBR, 
				EST_REVISION_NBR,
				[TYPE] = 1
			 FROM
				[dbo].[ESTIMATE_INT_APPR]) AS EST_APPR_SUB
		GROUP BY
			EST_APPR_SUB.JOB_NUMBER, 
			EST_APPR_SUB.JOB_COMPONENT_NBR, 
			EST_APPR_SUB.ESTIMATE_NUMBER, 
			EST_APPR_SUB.EST_COMPONENT_NBR, 
			EST_APPR_SUB.EST_QUOTE_NBR, 
			EST_APPR_SUB.EST_REVISION_NBR) AS EST_APPR LEFT OUTER JOIN
	[dbo].[ESTIMATE_APPROVAL] EA ON EST_APPR.JOB_NUMBER = EA.JOB_NUMBER AND
									EST_APPR.JOB_COMPONENT_NBR = EA.JOB_COMPONENT_NBR AND
									EST_APPR.ESTIMATE_NUMBER = EA.ESTIMATE_NUMBER AND
									EST_APPR.EST_COMPONENT_NBR = EA.EST_COMPONENT_NBR AND
									EST_APPR.EST_QUOTE_NBR = EA.EST_QUOTE_NBR AND
									EST_APPR.EST_REVISION_NBR = EA.EST_REVISION_NBR LEFT OUTER JOIN
	[dbo].[ESTIMATE_INT_APPR] EIA ON EST_APPR.JOB_NUMBER = EIA.JOB_NUMBER AND
									 EST_APPR.JOB_COMPONENT_NBR = EIA.JOB_COMPONENT_NBR AND
									 EST_APPR.ESTIMATE_NUMBER = EIA.ESTIMATE_NUMBER AND
									 EST_APPR.EST_COMPONENT_NBR = EIA.EST_COMPONENT_NBR AND
									 EST_APPR.EST_QUOTE_NBR = EIA.EST_QUOTE_NBR AND
									 EST_APPR.EST_REVISION_NBR = EIA.EST_REVISION_NBR

