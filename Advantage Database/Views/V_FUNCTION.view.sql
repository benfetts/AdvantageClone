CREATE VIEW [dbo].[V_FUNCTION]

WITH SCHEMABINDING
AS

	SELECT 
		F.[FNC_CODE],
		F.[FNC_DESCRIPTION],
		F.[FNC_TYPE],
		F.[DP_TM_CODE],
		F.[FNC_CONSOLIDATION],
		F.[FNC_CPM_FLAG],
		F.[FNC_ORDER],
		F.[FNC_INACTIVE],
		F.[FNC_FEE_RECONCILE],
		F.[FNC_HEADING_ID],
		F.[EX_FLAG],
		F.[NONBILL_CLI_GLACCT],
		F.[OVERHEAD_GLACCT],
		F.[FNC_FEE_FLAG],
		BR.[FNC_BILLING_RATE],
		BR.[TAX_COMM],
		BR.[TAX_COMM_ONLY],
		BR.[FNC_NONBILL_FLAG],
		BR.[FNC_TAX_FLAG],
		BR.[FNC_COMM_FLAG],
		F.[VAT_TAX_CODE]
	FROM 
		[dbo].[FUNCTIONS] AS F LEFT OUTER JOIN
		(SELECT
			BR.FNC_CODE,
			[FNC_BILLING_RATE] =  BR.BILLING_RATE,
			[FNC_COMM_FLAG] = CASE WHEN BRP.COMM_INCL = 0 THEN NULL WHEN BR.COMMISSION = 0.000 THEN 0 WHEN BR.COMMISSION IS NULL THEN NULL ELSE 1 END,
			[FNC_TAX_FLAG] = CASE WHEN BRP.TAX_INCL = 0 THEN NULL ELSE BR.TAX_FLAG END,
			[FNC_NONBILL_FLAG] = CASE WHEN BRP.NONBILL_INCL = 0 THEN NULL ELSE BR.NOBILL_FLAG END,
			[TAX_COMM_ONLY] = CASE WHEN BR.TAX_COMM_FLAGS = 2 THEN 1 ELSE 0 END,
			[TAX_COMM] = CASE WHEN BR.TAX_COMM_FLAGS >= 1 THEN 1 ELSE 0 END
		FROM
			[dbo].[BILLING_RATE] AS BR INNER JOIN
			[dbo].[BILL_RATE_PREC] AS BRP ON BRP.BILL_RATE_PREC_ID = BR.BILL_RATE_PREC_ID
		WHERE
			BR.BILL_RATE_PREC_ID = 1) AS BR ON BR.FNC_CODE = F.FNC_CODE
GO
