CREATE VIEW [dbo].[V_INVOICE_JOB_FUNCTION_COMMENT]
WITH SCHEMABINDING
AS

	SELECT 
		[InvoiceNumber] = ARS.AR_INV_NBR,
		[JobNumber] = J.JOB_NUMBER,
		[JobDescription] = J.JOB_DESC,
		[JobComponentNumber] = JC.JOB_COMPONENT_NBR,
		[JobComponentDescription] = JC.JOB_COMP_DESC,
		[FunctionCode] = ARS.FNC_CODE,
		[FunctionDescription] = CASE WHEN BCD.INV_NBR IS NOT NULL THEN BCD.FNC_DESC ELSE ARS.FNC_DESCRIPTION END,
		[FunctionSource] = BCD.FNC_DESC_SOURCE,
		[Comment] = BCD.DTL_COMMENT,
		[CommentSource] = BCD.COMMENT_SOURCE
	FROM 
		(SELECT
			ARS.AR_INV_NBR,
			ARS.JOB_NUMBER,
			ARS.JOB_COMPONENT_NBR,
			ARS.FNC_CODE,
			F.FNC_DESCRIPTION,
			ARS.AR_TYPE
		FROM
			[dbo].[AR_SUMMARY] AS ARS INNER JOIN
			[dbo].[FUNCTIONS] AS F ON F.FNC_CODE = ARS.FNC_CODE
		GROUP BY 
			ARS.AR_INV_NBR,
			ARS.JOB_NUMBER,
			ARS.JOB_COMPONENT_NBR,
			ARS.FNC_CODE,
			F.FNC_DESCRIPTION,
			ARS.AR_TYPE) AS ARS INNER JOIN
		[dbo].[JOB_COMPONENT] AS JC ON JC.JOB_NUMBER = ARS.JOB_NUMBER AND
									   JC.JOB_COMPONENT_NBR = ARS.JOB_COMPONENT_NBR INNER JOIN
		[dbo].[JOB_LOG] AS J ON J.JOB_NUMBER = ARS.JOB_NUMBER LEFT OUTER JOIN
		[dbo].[BILL_COMMENTS_DTL] AS BCD ON BCD.INV_NBR = ARS.AR_INV_NBR AND
											BCD.JOB_NUMBER = ARS.JOB_NUMBER AND
											BCD.JOB_COMPONENT_NBR = ARS.JOB_COMPONENT_NBR AND
											BCD.FNC_CODE = ARS.FNC_CODE
	WHERE
		ARS.JOB_NUMBER IS NOT NULL AND
		ARS.JOB_COMPONENT_NBR IS NOT NULL AND
		ARS.FNC_CODE IS NOT NULL AND
		ARS.AR_TYPE <> 'VO'



GO


