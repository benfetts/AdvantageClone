CREATE VIEW [dbo].[V_JF_JOB_DTL_ACTUALS]
AS

	SELECT
		JFJOBS.JF_ID,
		JFJOBS.JF_REV_ID,
		JFJOBS.JF_JOB_ID,
		JFJOBS.PPPERIOD,
		JF_JOB_DTL.BILLING_AMT,
		JF_JOB_DTL.REVENUE_AMT,
		[ACTUAL_BILLING_AMT] = SUM(ISNULL(ACTUALS.ActualBillableAmount, 0)),
		[ACTUAL_REVENUE_AMT] = SUM(ISNULL(ACTUALS.ActualRevenueAmount, 0))
	FROM
		(SELECT
			JF_JOB.JF_ID,
			JF_JOB.JF_REV_ID,
			JF_JOB.JF_JOB_ID,
			JF_JOB.JOB_NUMBER,
			JF_JOB.JOB_COMPONENT_NBR,
			POSTPERIOD.PPPERIOD,
			POSTPERIOD.PPSRTDATE,
			POSTPERIOD.PPENDDATE
		 FROM
			dbo.JF_HDR INNER JOIN
			dbo.JF_JOB ON JF_HDR.JF_ID = JF_JOB.JF_ID INNER JOIN
			dbo.POSTPERIOD PS ON JF_HDR.PPPERIOD_START = PS.PPPERIOD INNER JOIN
			dbo.POSTPERIOD PE ON JF_HDR.PPPERIOD_END = PE.PPPERIOD INNER JOIN
			dbo.POSTPERIOD ON 1 = 1
		 WHERE
			POSTPERIOD.PPSRTDATE >= PS.PPSRTDATE  AND
			POSTPERIOD.PPENDDATE <= PE.PPENDDATE) JFJOBS LEFT OUTER JOIN
		dbo.JF_JOB_DTL ON JFJOBS.JF_ID = JF_JOB_DTL.JF_ID AND
						  JFJOBS.JF_REV_ID = JF_JOB_DTL.JF_REV_ID AND
						  JFJOBS.JF_JOB_ID = JF_JOB_DTL.JF_JOB_ID AND
						  JFJOBS.PPPERIOD = JF_JOB_DTL.PPPERIOD LEFT OUTER JOIN
		dbo.V_JOB_COMP_ACTUALS ACTUALS ON JFJOBS.JOB_NUMBER = ACTUALS.JobNumber AND
										  JFJOBS.JOB_COMPONENT_NBR = ACTUALS.ComponentNumber AND
										  JFJOBS.PPSRTDATE <= ACTUALS.ItemDate AND
										  JFJOBS.PPENDDATE >= ACTUALS.ItemDate
	GROUP BY
		JFJOBS.JF_ID,
		JFJOBS.JF_REV_ID,
		JFJOBS.JF_JOB_ID,
		JFJOBS.PPPERIOD,
		JF_JOB_DTL.BILLING_AMT,
		JF_JOB_DTL.REVENUE_AMT

GO