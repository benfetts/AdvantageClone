--insert the next (3) statements at the top of the script while debugging
IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[V_MEDIA_ORDER_AMOUNTS_SUM]') and OBJECTPROPERTY(id, N'IsView') = 1)
	DROP VIEW [dbo].[V_MEDIA_ORDER_AMOUNTS_SUM]
GO

CREATE VIEW [dbo].[V_MEDIA_ORDER_AMOUNTS_SUM]

-- V_MEDIA_ORDER_AMOUNTS_SUM
-- #00 04/10/13 - initial version

AS

--For print media (include line number)
SELECT 
	  d.[USER_ID] AS [USER_ID],
	  d.ORDER_TYPE AS ORDER_TYPE,
	  d.ORDER_NBR AS ORDER_NBR,
	  d.LINE_NBR AS LINE_NBR,
	  MONTH(dt.INSERT_DATE) AS [MONTH],
	  YEAR(dt.INSERT_DATE) AS [YEAR],
	  SUM(d.EXT_NET_AMT) AS EXT_NET_AMT, 
	  SUM(d.NETCHARGES) AS NETCHARGES,
	  SUM(d.DISCOUNTS) AS DISCOUNTS,
	  SUM(d.ADDL_CHARGE) AS ADDL_CHARGE, 
	  SUM(d.COMM_AMT) AS COMM_AMT,
	  SUM(d.REBATE_AMT) AS REBATE_AMT,
	  SUM(d.VENDOR_TAX) AS VENDOR_TAX,
	  SUM(d.RESALE_TAX) AS RESALE_TAX,
	  SUM(d.LINE_TOTAL) AS LINE_TOTAL, 
	  SUM(d.NET_TOTAL_AMT) AS NET_TOTAL_AMT,
	  SUM(d.VENDOR_NET_AMT) AS VENDOR_NET_AMT,
	  SUM(d.BILL_AMT) AS BILL_AMT,
	  SUM(d.RECNB_BILL_AMT) AS RECNB_BILL_AMT, 
	  SUM(d.RECNB_NET_AMT) AS RECNB_NET_AMT,
	  SUM(d.SPOTS_QTY) AS SPOTS_QTY,	
	  NULL AS NON_BILL_FLAG,
	  NULL AS LINE_CANCELLED,
	  NULL AS BILL_TYPE_FLAG,
	  SUM(d.BILLED_EXT_NET_AMT) AS BILLED_EXT_NET_AMT, 
	  SUM(d.BILLED_DISC_AMT) AS BILLED_DISC_AMT,
	  SUM(d.BILLED_NC_AMT) AS BILLED_NC_AMT,
	  SUM(d.BILLED_VTAX_AMT) AS BILLED_VTAX_AMT,
	  SUM(d.BILLED_NET_AMT) AS BILLED_NET_AMT,
	  SUM(d.BILLED_ADDL_CHARGE) AS BILLED_ADDL_CHARGE,
	  SUM(d.BILLED_COMM_AMT) AS BILLED_COMM_AMT,
	  SUM(d.BILLED_REBATE_AMT) AS BILLED_REBATE_AMT,
	  SUM(d.BILLED_RTAX_AMT) AS BILLED_RTAX_AMT,
	  SUM(d.BILLED_BILL_AMT) AS BILLED_BILL_AMT,
	  SUM(d.BILLED_SPOTS_QTY) AS BILLED_SPOTS_QTY,		  
	  NULL AS AR_INV_NBR,
	  NULL AS AR_SEQ,
	  NULL AS AR_TYPE,
	  NULL AS GLXACT_BILL,
	  SUM(d.AP_NET_AMT) AS AP_NET_AMT,
	  SUM(d.AP_NETCHARGES_AMT) AS AP_NETCHARGES_AMT, 
	  SUM(d.AP_DISC_AMT_AMT) AS AP_DISC_AMT_AMT,
	  SUM(d.AP_COMM_AMT) AS AP_COMM_AMT,
	  SUM(d.AP_REBATE_AMT) AS AP_REBATE_AMT,
	  SUM(d.AP_VTAX_AMT) AS AP_VTAX_AMT,
	  SUM(d.AP_RTAX_AMT) AS AP_RTAX_AMT,
	  SUM(d.AP_BILL_AMT) AS AP_BILL_AMT,
	  SUM(d.AP_LINE_TOTAL) AS AP_LINE_TOTAL, 
	  SUM(d.AP_SPOTS_QTY) AS AP_SPOTS_QTY,			
	  NULL AS AP_INV_NBR,
	  NULL AS GLXACT_AP 
FROM  dbo.MEDIA_ORDER_AMOUNTS AS d
JOIN dbo.MEDIA_ORDER_DETAIL AS dt
	ON d.[USER_ID] = dt.[USER_ID]
	AND d.ORDER_NBR = dt.ORDER_NBR
	AND d.LINE_NBR = dt.LINE_NBR
WHERE d.ORDER_TYPE NOT IN ('R', 'RN', 'R2', 'T', 'TN', 'T2')	
GROUP BY d.[USER_ID], d.ORDER_TYPE, d.ORDER_NBR, d.LINE_NBR, dt.INSERT_DATE

--For Broadcast media (no line number)
UNION ALL SELECT 
	d.[USER_ID] AS [USER_ID],
	d.ORDER_TYPE AS ORDER_TYPE,
	d.ORDER_NBR AS ORDER_NBR,
	NULL,
	COALESCE(d.[MONTH], dt.[MONTH]) AS [MONTH],
	COALESCE(d.[YEAR], dt.[YEAR]) AS [YEAR],
	  SUM(d.EXT_NET_AMT) AS EXT_NET_AMT, 
	  SUM(d.NETCHARGES) AS NETCHARGES,
	  SUM(d.DISCOUNTS) AS DISCOUNTS,
	  SUM(d.ADDL_CHARGE) AS ADDL_CHARGE, 
	  SUM(d.COMM_AMT) AS COMM_AMT,
	  SUM(d.REBATE_AMT) AS REBATE_AMT,
	  SUM(d.VENDOR_TAX) AS VENDOR_TAX,
	  SUM(d.RESALE_TAX) AS RESALE_TAX,
	  SUM(d.LINE_TOTAL) AS LINE_TOTAL, 
	  SUM(d.NET_TOTAL_AMT) AS NET_TOTAL_AMT,
	  SUM(d.VENDOR_NET_AMT) AS VENDOR_NET_AMT,
	  SUM(d.BILL_AMT) AS BILL_AMT,
	  SUM(d.RECNB_BILL_AMT) AS RECNB_BILL_AMT, 
	  SUM(d.RECNB_NET_AMT) AS RECNB_NET_AMT,
	  SUM(d.SPOTS_QTY) AS SPOTS_QTY,	
	  NULL AS NON_BILL_FLAG,
	  NULL AS LINE_CANCELLED,
	  NULL AS BILL_TYPE_FLAG,
	  SUM(d.BILLED_EXT_NET_AMT) AS BILLED_EXT_NET_AMT, 
	  SUM(d.BILLED_DISC_AMT) AS BILLED_DISC_AMT,
	  SUM(d.BILLED_NC_AMT) AS BILLED_NC_AMT,
	  SUM(d.BILLED_VTAX_AMT) AS BILLED_VTAX_AMT,
	  SUM(d.BILLED_NET_AMT) AS BILLED_NET_AMT,
	  SUM(d.BILLED_ADDL_CHARGE) AS BILLED_ADDL_CHARGE,
	  SUM(d.BILLED_COMM_AMT) AS BILLED_COMM_AMT,
	  SUM(d.BILLED_REBATE_AMT) AS BILLED_REBATE_AMT,
	  SUM(d.BILLED_RTAX_AMT) AS BILLED_RTAX_AMT,
	  SUM(d.BILLED_BILL_AMT) AS BILLED_BILL_AMT,
	  SUM(d.BILLED_SPOTS_QTY) AS BILLED_SPOTS_QTY,		  
	  NULL AS AR_INV_NBR,
	  NULL AS AR_SEQ,
	  NULL AS AR_TYPE,
	  NULL AS GLXACT_BILL,
	  SUM(d.AP_NET_AMT) AS AP_NET_AMT,
	  SUM(d.AP_NETCHARGES_AMT) AS AP_NETCHARGES_AMT, 
	  SUM(d.AP_DISC_AMT_AMT) AS AP_DISC_AMT_AMT,
	  SUM(d.AP_COMM_AMT) AS AP_COMM_AMT,
	  SUM(d.AP_REBATE_AMT) AS AP_REBATE_AMT,
	  SUM(d.AP_VTAX_AMT) AS AP_VTAX_AMT,
	  SUM(d.AP_RTAX_AMT) AS AP_RTAX_AMT,
	  SUM(d.AP_BILL_AMT) AS AP_BILL_AMT,
	  SUM(d.AP_LINE_TOTAL) AS AP_LINE_TOTAL, 
	  SUM(d.AP_SPOTS_QTY) AS AP_SPOTS_QTY,			
	  NULL AS AP_INV_NBR,
	  NULL AS GLXACT_AP 
FROM  dbo.MEDIA_ORDER_AMOUNTS AS d
JOIN dbo.MEDIA_ORDER_DETAIL AS dt
	ON d.[USER_ID] = dt.[USER_ID]
	AND d.ORDER_NBR = dt.ORDER_NBR
	AND d.LINE_NBR = dt.LINE_NBR
WHERE d.ORDER_TYPE IN ('R', 'RN', 'R2', 'T', 'TN', 'T2')	
GROUP BY d.[USER_ID], d.ORDER_TYPE, d.ORDER_NBR, d.[MONTH], d.[YEAR], dt.[MONTH], dt.[YEAR]

GO

IF ( @@ERROR = 0 )
	GRANT SELECT ON [V_MEDIA_ORDER_AMOUNTS_SUM] TO PUBLIC AS dbo
GO	


