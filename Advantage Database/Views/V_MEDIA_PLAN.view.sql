CREATE VIEW [dbo].[V_MEDIA_PLAN]

WITH SCHEMABINDING 
AS

	SELECT 
		[ID] = NEWID(),
		[OfficeCode] = P.OFFICE_CODE,
		[OfficeName] = O.OFFICE_NAME,
		[ClientCode] = MP.CL_CODE,
		[ClientName] = C.CL_NAME,
		[DivisionCode] = MP.DIV_CODE,
		[DivisionName] = D.DIV_NAME,
		[ProductCode] = MP.PRD_CODE,
		[ProductDescription] = P.PRD_DESCRIPTION,
		[PlanID] = MP.MEDIA_PLAN_ID,
		[PlanDescription] = MP.[DESCRIPTION],
		[ClientContact] = COALESCE((RTRIM(CC.CONT_FNAME) + ' '),'') + COALESCE((CC.CONT_MI + '. '),'') + COALESCE(CC.CONT_LNAME,''),
		[PlanStartDate] = MP.[START_DATE],
		[PlanEndDate] = MP.END_DATE,
		[GrossBudget] = MP.GROSS_BUDGET_AMT,
		[CreatedByUserCode] = MP.USER_CREATED,
		[CreatedDate] = MP.CREATED_DATE,
		[ModifiedByUserCode] = MP.USER_MODIFIED,
		[ModifiedDate] = MP.MODIFIED_DATE,
		[EstimateID] = RIGHT(REPLICATE('0', 6) + CONVERT(VARCHAR(20), MPD.MEDIA_PLAN_DTL_ID), 6),
		[EstimateName] = MPD.NAME,
		[EstimateBudget] = ISNULL(MPD.GROSS_BUDGET_AMT,0),
		[MediaType] = MPD.SC_TYPE,
		[SalesClassCode] = MPD.SC_CODE,
		[SalesClassDescription] = SC.SC_DESCRIPTION,
		[CampaignCode] = CASE WHEN CAMP.CMP_CODE IS NULL THEN MPCMP.CampaignCode ELSE CAMP.CMP_CODE END, 
		[CampaignName] = CASE WHEN CAMP.CMP_NAME IS NULL THEN MPCMP.CampaignName ELSE CAMP.CMP_NAME END,
		[StartDate] = MPDLLD.[START_DATE],
		[EndDate] = MPDLLD.[END_DATE],
		[Month] = CASE WHEN MPD.IS_CALENDAR_MONTH = 1 THEN MC.[MONTH] ELSE MC.BROADCAST_MONTH END,
		[MonthName] = CASE WHEN MPD.IS_CALENDAR_MONTH = 1 THEN CASE WHEN MC.[MONTH] = 1 THEN 'January'
																    WHEN MC.[MONTH] = 2 THEN 'February'
																    WHEN MC.[MONTH] = 3 THEN 'March'
																    WHEN MC.[MONTH] = 4 THEN 'April'
																    WHEN MC.[MONTH] = 5 THEN 'May'
																    WHEN MC.[MONTH] = 6 THEN 'June'
																    WHEN MC.[MONTH] = 7 THEN 'July'
																    WHEN MC.[MONTH] = 8 THEN 'August'
																    WHEN MC.[MONTH] = 9 THEN 'September'
																    WHEN MC.[MONTH] = 10 THEN 'October'
																    WHEN MC.[MONTH] = 11 THEN 'November'
																    WHEN MC.[MONTH] = 12 THEN 'December' END ELSE CASE WHEN MC.BROADCAST_MONTH = 1 THEN 'January'
																													   WHEN MC.BROADCAST_MONTH = 2 THEN 'February'
																													   WHEN MC.BROADCAST_MONTH = 3 THEN 'March'
																													   WHEN MC.BROADCAST_MONTH = 4 THEN 'April'
																													   WHEN MC.BROADCAST_MONTH = 5 THEN 'May'
																													   WHEN MC.BROADCAST_MONTH = 6 THEN 'June'
																													   WHEN MC.BROADCAST_MONTH = 7 THEN 'July'
																													   WHEN MC.BROADCAST_MONTH = 8 THEN 'August'
																													   WHEN MC.BROADCAST_MONTH = 9 THEN 'September'
																													   WHEN MC.BROADCAST_MONTH = 10 THEN 'October'
																													   WHEN MC.BROADCAST_MONTH = 11 THEN 'November'
																													   WHEN MC.BROADCAST_MONTH = 12 THEN 'December' END END,
		[Quarter] = CASE WHEN MPD.IS_CALENDAR_MONTH = 1 THEN MC.[QUARTER] ELSE MC.BROADCAST_QUARTER END,
		[Year] = CASE WHEN MPD.IS_CALENDAR_MONTH = 1 THEN MC.[YEAR] ELSE MC.BROADCAST_YEAR END,
		[Demo1] = MPDLLD.DEMO1,
		[Demo2] = MPDLLD.DEMO2,
		[Units] = MPDLLD.UNITS,
		[Impressions] = MPDLLD.IMPRESSIONS,
		[Clicks] = MPDLLD.CLICKS,
		[Rate] = MPDLLD.RATE,
		[Dollars] = MPDLLD.DOLLARS,
		[AgencyFee] = MPDLLD.AGENCY_FEE,
		[BillAmount] = MPDLLD.BILL_AMOUNT,
		[PlanQuantity] = CAST(COALESCE(MPDLLD.UNITS, 0) + COALESCE(MPDLLD.IMPRESSIONS, 0) + COALESCE(MPDLLD.CLICKS, 0) AS DECIMAL(10,2)),
		[PlanNetAmount] = CAST(CASE WHEN MPD.IS_ESTIMATE_GROSS = 1 THEN (MPDLLD.DOLLARS * .85) ELSE MPDLLD.DOLLARS END AS DECIMAL(10,2)),
		[PlanCommission] = CAST(CASE WHEN MPD.IS_ESTIMATE_GROSS = 0 THEN MPDLLD.BILL_AMOUNT - MPDLLD.DOLLARS
								WHEN MPD.IS_ESTIMATE_GROSS = 1 AND MPDS.NUMERIC_VALUE IS NOT NULL AND MPDS.NUMERIC_VALUE <> 0 THEN (MPDLLD.DOLLARS * .15) - (MPDLLD.DOLLARS * MPDS.NUMERIC_VALUE / 100) 
								WHEN MPD.IS_ESTIMATE_GROSS = 1 THEN (MPDLLD.DOLLARS * .15) END AS DECIMAL(10,2)),
		[IsApproved] = MPD.APPROVED,
		[ApprovedBy] = MPD.APPROVED_BY,
		[ApprovedDate] = MPD.APPROVED_DATE,
		[MasterPlanID] = MPMP.MEDIA_PLAN_MASTER_PLAN_ID,
		[MasterPlanName] = MPMP.[DESCRIPTION],
		[OrderNumber] = MPDLLD.ORDER_NBR,
		[LineNumber] = MPDLLD.ORDER_LINE_NBR
	FROM 
		[dbo].[MEDIA_PLAN_DTL_LEVEL_LINE_DATA] AS MPDLLD INNER JOIN
		[dbo].[MEDIA_CALENDAR] AS MC ON MC.[DATE] = MPDLLD.[START_DATE] INNER JOIN
		[dbo].[MEDIA_PLAN] AS MP ON MP.MEDIA_PLAN_ID = MPDLLD.MEDIA_PLAN_ID INNER JOIN 
		[dbo].[MEDIA_PLAN_DTL] AS MPD ON MPD.MEDIA_PLAN_ID = MPDLLD.MEDIA_PLAN_ID AND
										 MPD.MEDIA_PLAN_DTL_ID = MPDLLD.MEDIA_PLAN_DTL_ID INNER JOIN
		[dbo].[CLIENT] AS C ON C.CL_CODE = MP.CL_CODE LEFT OUTER JOIN
		[dbo].[DIVISION] AS D ON D.CL_CODE = MP.CL_CODE AND
								 D.DIV_CODE = MP.DIV_CODE LEFT OUTER JOIN
		[dbo].[PRODUCT] AS P ON P.CL_CODE = MP.CL_CODE AND
								P.DIV_CODE = MP.DIV_CODE AND
								P.PRD_CODE = MP.PRD_CODE LEFT OUTER JOIN
		[dbo].[OFFICE] AS O ON O.OFFICE_CODE = P.OFFICE_CODE LEFT OUTER JOIN
		[dbo].[CDP_CONTACT_HDR] AS CC ON CC.CDP_CONTACT_ID = MP.CDP_CONTACT_ID LEFT OUTER JOIN
		[dbo].[SALES_CLASS] AS SC ON SC.SC_CODE = MPD.SC_CODE LEFT OUTER JOIN 
		[dbo].[CAMPAIGN] AS CAMP ON CAMP.CMP_IDENTIFIER = MPD.CMP_IDENTIFIER LEFT OUTER JOIN
		[dbo].[MEDIA_PLAN_DTL_SETTING] MPDS ON MP.MEDIA_PLAN_ID = MPDS.MEDIA_PLAN_ID AND MPD.MEDIA_PLAN_DTL_ID = MPDS.MEDIA_PLAN_DTL_ID AND SETTING = 'ProductRebateAmount' LEFT OUTER JOIN
		[dbo].[MEDIA_PLAN_MASTER_PLAN_DETAIL] MPMPD ON MPMPD.MEDIA_PLAN_ID = MP.MEDIA_PLAN_ID LEFT OUTER JOIN
		[dbo].[MEDIA_PLAN_MASTER_PLAN] MPMP ON MPMP.MEDIA_PLAN_MASTER_PLAN_ID = MPMPD.MEDIA_PLAN_MASTER_PLAN_ID LEFT OUTER JOIN
		(SELECT 
 			[MediaPlanID] = MPDL.MEDIA_PLAN_ID,
 			[EstimateID] = MPDL.MEDIA_PLAN_DTL_ID,
 			[RowIndex] = MPDLL.ROW_INDEX,
			[CampaignCode] = C.CMP_CODE,
			[CampaignName] = C.CMP_NAME
		 FROM
 			dbo.MEDIA_PLAN_DTL_LEVEL MPDL INNER JOIN
 			dbo.MEDIA_PLAN_DTL_LEVEL_LINE MPDLL ON MPDLL.MEDIA_PLAN_DTL_LEVEL_ID = MPDL.MEDIA_PLAN_DTL_LEVEL_ID INNER JOIN
 			dbo.MEDIA_PLAN_DTL_LEVEL_LINE_TAG MPDLLT ON MPDLLT.MEDIA_PLAN_DTL_LEVEL_LINE_ID = MPDLL.MEDIA_PLAN_DTL_LEVEL_LINE_ID LEFT OUTER JOIN
			dbo.CAMPAIGN C ON C.CMP_IDENTIFIER = MPDLLT.CMP_IDENTIFIER
		 WHERE
 			MPDL.TAG_TYPE = 11) MPCMP ON MPDLLD.MEDIA_PLAN_ID = MPCMP.MediaPlanID AND
										MPDLLD.MEDIA_PLAN_DTL_ID = MPCMP.EstimateID AND
										MPDLLD.ROW_INDEX = MPCMP.RowIndex




GO