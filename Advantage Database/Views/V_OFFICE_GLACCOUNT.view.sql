
CREATE VIEW dbo.V_OFFICE_GLACCOUNT ( OFFICE_CODE, SC_CODE, FNC_CODE, PGLACODE_SALES, PGLACODE_COS, SALES_OFFICE, COS_OFFICE )
AS
	  SELECT o.OFFICE_CODE, 
				sc.SC_CODE, 
				f.FNC_CODE,
				COALESCE( osfa.PGLACODE_SALES, osa.PGLACODE_SALES, ofa.PGLACODE_SALES, o.PGLACODE_SALES ),
				COALESCE( osfa.PGLACODE_COS, osa.PGLACODE_COS, ofa.PGLACODE_COS, o.PGLACODE_COS ),
				pglacode_sales = ( SELECT GLOXOFFICE 
											FROM GLACCOUNT 
									INNER JOIN GLOXREF 
											  ON GLACCOUNT.GLAOFFICE = GLOXREF.GLOXGLOFFICE 
										  WHERE GLACCOUNT.GLACODE = COALESCE( osfa.PGLACODE_SALES, osa.PGLACODE_SALES, ofa.PGLACODE_SALES, o.PGLACODE_SALES )),
				pglacode_cos = ( SELECT GLOXOFFICE 
										 FROM GLACCOUNT, GLOXREF
										WHERE GLACCOUNT.GLAOFFICE = GLOXREF.GLOXGLOFFICE
										  AND GLACCOUNT.GLACODE = COALESCE( osfa.PGLACODE_COS, osa.PGLACODE_COS, ofa.PGLACODE_COS, o.PGLACODE_COS ))
		 FROM OFFICE o
 CROSS JOIN SALES_CLASS sc
 CROSS JOIN [FUNCTIONS] f
  LEFT JOIN	OFF_SC_FNC_ACCTS osfa 
			ON osfa.OFFICE_CODE = o.OFFICE_CODE
		  AND osfa.SC_CODE = sc.SC_CODE
		  AND osfa.FNC_CODE = f.FNC_CODE
  LEFT JOIN	OFF_SC_ACCTS osa 
			ON osa.OFFICE_CODE = o.OFFICE_CODE
	     AND osa.SC_CODE = sc.SC_CODE
  LEFT JOIN	OFF_FNC_ACCTS ofa
			ON ofa.OFFICE_CODE = o.OFFICE_CODE
		  AND ofa.FNC_CODE = f.FNC_CODE
