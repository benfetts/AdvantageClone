CREATE VIEW dbo.V_PURCHASE_ORDER
AS

	SELECT [PO_NUMBER] = PURCHASE_ORDER.PO_NUMBER,
		   [PO_DESCRIPTION] = PURCHASE_ORDER.PO_DESCRIPTION,
		   [EMP_CODE] = PURCHASE_ORDER.EMP_CODE,
		   [EMP_NAME] = COALESCE((RTRIM(EMPLOYEE.EMP_FNAME) + ' '),'') + COALESCE((EMPLOYEE.EMP_MI + '. '),'') + COALESCE(EMPLOYEE.EMP_LNAME,''),
		   [VN_CODE] = PURCHASE_ORDER.VN_CODE,
		   [VN_NAME] = VENDOR.VN_NAME,
		   [PO_DATE] = PURCHASE_ORDER.PO_DATE,
		   [PO_DUE_DATE] = PURCHASE_ORDER.PO_DUE_DATE,
		   [VOID_FLAG] = PURCHASE_ORDER.VOID_FLAG,
		   [PO_COMPLETE] = PURCHASE_ORDER.PO_COMPLETE,
		   [USER_MODIFIED] = PURCHASE_ORDER.USER_MODIFIED,
		   [MODIFIED_DATE] = PURCHASE_ORDER.MODIFIED_DATE,
		   [DISPLAY_PO_NUMBER] = CASE
									WHEN PO_APPROVAL.PO_NUMBER IS NOT NULL THEN
																				CASE
																					WHEN PO_APPROVAL.PO_APPROVAL_FLAG = 0 OR PO_APPROVAL.PO_APPROVAL_FLAG IS NULL THEN '(Pending)'
																					WHEN PO_APPROVAL.PO_APPROVAL_FLAG = 1 THEN '(Pending)'
																					WHEN PO_APPROVAL.PO_APPROVAL_FLAG = 2 THEN CONVERT(VARCHAR(12), PURCHASE_ORDER.PO_NUMBER)
																					WHEN PO_APPROVAL.PO_APPROVAL_FLAG = 3 THEN '(Denied)'
																					ELSE CONVERT(VARCHAR(12), PURCHASE_ORDER.PO_NUMBER)
																				END 
									ELSE
										CASE
											WHEN PURCHASE_ORDER_DET.PO_NUMBER IS NOT NULL THEN
																							CASE
																								WHEN PURCHASE_ORDER.PO_APPR_RULE_CODE IS NULL OR PURCHASE_ORDER.PO_APPR_RULE_CODE = '' OR EMPLOYEE.PO_LIMIT IS NULL THEN CONVERT(VARCHAR(12), PURCHASE_ORDER.PO_NUMBER)
																								WHEN PURCHASE_ORDER.EXCEED = 0 AND (PURCHASE_ORDER.PO_PRINTED = 0 OR PURCHASE_ORDER.PO_PRINTED IS NULL) THEN '(Incomplete)'
																								WHEN PURCHASE_ORDER.EXCEED = 0 AND PURCHASE_ORDER.PO_PRINTED = 1 THEN CONVERT(VARCHAR(12), PURCHASE_ORDER.PO_NUMBER)
																								WHEN PURCHASE_ORDER.EXCEED = 1 THEN '(Incomplete)'
																								ELSE CONVERT(VARCHAR(12), PURCHASE_ORDER.PO_NUMBER)
																							END
											ELSE '(Incomplete)'
										END
								  END
		FROM dbo.PURCHASE_ORDER INNER JOIN
			 dbo.EMPLOYEE ON EMPLOYEE.EMP_CODE = PURCHASE_ORDER.EMP_CODE INNER JOIN
			dbo.VENDOR ON PURCHASE_ORDER.VN_CODE = VENDOR.VN_CODE LEFT OUTER JOIN
			(SELECT
				DISTINCT
				PO_NUMBER, [dbo].[advfn_po_appr_status](PO_NUMBER) as PO_APPROVAL_FLAG
			 FROM
				dbo.PO_APPROVAL) PO_APPROVAL ON PURCHASE_ORDER.PO_NUMBER = PO_APPROVAL.PO_NUMBER LEFT OUTER JOIN
			(SELECT
				DISTINCT
				PO_NUMBER
			 FROM
				dbo.PURCHASE_ORDER_DET) PURCHASE_ORDER_DET ON PURCHASE_ORDER.PO_NUMBER = PURCHASE_ORDER_DET.PO_NUMBER