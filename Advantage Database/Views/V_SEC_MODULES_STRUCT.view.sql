CREATE VIEW [dbo].[V_SEC_MODULES_STRUCT]

WITH SCHEMABINDING 
AS

	SELECT 
		[ID] = ISNULL(ROW_NUMBER() OVER(ORDER BY SM.SEC_MODULE_ID), 0),
		
		[ParentModuleID] = CASE WHEN SSPSM.SEC_MODULE_ID IS NOT NULL AND SPSM.SEC_MODULE_ID IS NOT NULL AND PSM.SEC_MODULE_ID IS NOT NULL THEN SSPSM.SEC_MODULE_ID 
								WHEN SSPSM.SEC_MODULE_ID IS NULL AND SPSM.SEC_MODULE_ID IS NOT NULL AND PSM.SEC_MODULE_ID IS NOT NULL THEN SPSM.SEC_MODULE_ID 
								ELSE PSM.SEC_MODULE_ID END,
		[ParentModule] = CASE WHEN SSPSM.SEC_MODULE_ID IS NOT NULL AND SPSM.SEC_MODULE_ID IS NOT NULL AND PSM.SEC_MODULE_ID IS NOT NULL THEN SSPSM.[DESCRIPTION] 
							  WHEN SSPSM.SEC_MODULE_ID IS NULL AND SPSM.SEC_MODULE_ID IS NOT NULL AND PSM.SEC_MODULE_ID IS NOT NULL THEN SPSM.[DESCRIPTION]
							  ELSE PSM.[DESCRIPTION] END,
		[ParentModuleSortOrder] = CASE WHEN SSPSM.SEC_MODULE_ID IS NOT NULL AND SPSM.SEC_MODULE_ID IS NOT NULL AND PSM.SEC_MODULE_ID IS NOT NULL THEN SSPSMI.SORT_ORDER 
									   WHEN SSPSM.SEC_MODULE_ID IS NULL AND SPSM.SEC_MODULE_ID IS NOT NULL AND PSM.SEC_MODULE_ID IS NOT NULL THEN SPSMI.SORT_ORDER 
									   ELSE PSMI.SORT_ORDER END,
		
		[SubParentModuleID] = CASE WHEN SSPSM.SEC_MODULE_ID IS NOT NULL THEN SPSM.SEC_MODULE_ID
								   WHEN SPSM.SEC_MODULE_ID IS NOT NULL AND PSM.SEC_MODULE_ID IS NOT NULL THEN PSM.SEC_MODULE_ID 
								   WHEN SPSM.SEC_MODULE_ID IS NULL AND PSM.SEC_MODULE_ID IS NOT NULL THEN SPSM.SEC_MODULE_ID END,
		[SubParentModule] = CASE WHEN SSPSM.SEC_MODULE_ID IS NOT NULL THEN SPSM.[DESCRIPTION]
								 WHEN SPSM.SEC_MODULE_ID IS NOT NULL AND PSM.SEC_MODULE_ID IS NOT NULL THEN PSM.[DESCRIPTION] 
								 WHEN SPSM.SEC_MODULE_ID IS NULL AND PSM.SEC_MODULE_ID IS NOT NULL THEN SPSM.[DESCRIPTION] END,
		[SubParentModuleSortOrder] = CASE WHEN SSPSM.SEC_MODULE_ID IS NOT NULL THEN SPSMI.SORT_ORDER
										  WHEN SPSM.SEC_MODULE_ID IS NOT NULL AND PSM.SEC_MODULE_ID IS NOT NULL THEN PSMI.SORT_ORDER 
										  WHEN SPSM.SEC_MODULE_ID IS NULL AND PSM.SEC_MODULE_ID IS NOT NULL THEN SPSMI.SORT_ORDER END,
		
		[SubSubParentModuleID] = CASE WHEN SSPSM.SEC_MODULE_ID IS NULL AND PSM.SEC_MODULE_ID IS NOT NULL THEN SSPSM.SEC_MODULE_ID ELSE PSM.SEC_MODULE_ID END,
		[SubSubParentModule] = CASE WHEN SSPSM.SEC_MODULE_ID IS NULL AND PSM.SEC_MODULE_ID IS NOT NULL THEN SSPSM.[DESCRIPTION] ELSE PSM.[DESCRIPTION] END,
		[SubSubParentModuleSortOrder] = CASE WHEN SSPSM.SEC_MODULE_ID IS NULL AND PSM.SEC_MODULE_ID IS NOT NULL THEN SSPSMI.SORT_ORDER ELSE PSMI.SORT_ORDER END,
		
		[ModuleID] = SM.SEC_MODULE_ID,
		[ModuleCode] = SM.SEC_MODULE_CODE,
		[Module] = SM.[DESCRIPTION],
		[ModuleSortOrder] = SMI.SORT_ORDER,
		[ModuleHasCustomPermission] = SMI.CUSTOM_PERMISSION
	FROM
		[dbo].[SEC_MODULE] SM LEFT OUTER JOIN
		[dbo].[SEC_MODULE_INFO] SMI ON SMI.SEC_MODULE_INFO_ID = SM.SEC_MODULE_INFO_ID LEFT OUTER JOIN
		[dbo].[SEC_MODULE_SUB] SMS ON SMS.SEC_MODULE_ID = SM.SEC_MODULE_ID LEFT OUTER JOIN
		[dbo].[SEC_MODULE] PSM ON PSM.SEC_MODULE_ID = SMS.PARENT_MODULE_ID LEFT OUTER JOIN
		[dbo].[SEC_MODULE_INFO] PSMI ON PSMI.SEC_MODULE_INFO_ID = PSM.SEC_MODULE_INFO_ID LEFT OUTER JOIN
		[dbo].[SEC_MODULE_SUB] SSMS ON SSMS.SEC_MODULE_ID = PSM.SEC_MODULE_ID LEFT OUTER JOIN
		[dbo].[SEC_MODULE] SPSM ON SPSM.SEC_MODULE_ID = SSMS.PARENT_MODULE_ID LEFT OUTER JOIN
		[dbo].[SEC_MODULE_INFO] SPSMI ON SPSMI.SEC_MODULE_INFO_ID = SPSM.SEC_MODULE_INFO_ID LEFT OUTER JOIN
		[dbo].[SEC_MODULE_SUB] SSSMS ON SSSMS.SEC_MODULE_ID = SPSM.SEC_MODULE_ID LEFT OUTER JOIN
		[dbo].[SEC_MODULE] SSPSM ON SSPSM.SEC_MODULE_ID = SSSMS.PARENT_MODULE_ID LEFT OUTER JOIN
		[dbo].[SEC_MODULE_INFO] SSPSMI ON SSPSMI.SEC_MODULE_INFO_ID = SSPSM.SEC_MODULE_INFO_ID

GO