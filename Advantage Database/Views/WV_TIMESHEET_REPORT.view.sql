

CREATE VIEW dbo.WV_TIMESHEET_REPORT
AS
SELECT  EMP_TIME.EMP_CODE as [Employee Code], 
	EMPLOYEE.EMP_FNAME + ' ' + EMPLOYEE.EMP_LNAME as [Employee Name], 
	EMP_TIME_DTL.DP_TM_CODE as [Department Code], 
	DEPT_TEAM.DP_TM_DESC as [Department Name], 
	JOB_LOG.CL_CODE as [Client Code], 
	CLIENT.CL_NAME as [Client Name], 
	JOB_LOG.DIV_CODE as [Division Code], 
	DIVISION.DIV_NAME as [Division Name], 
	JOB_LOG.PRD_CODE as [Product Code], 
	PRODUCT.PRD_DESCRIPTION as [Product Description], 
	EMP_TIME_DTL.PROD_CAT_CODE as [Product category Code], 
	PRODUCT_CATEGORY.PROD_CAT_DESC as [Product Category Description], 
	EMP_TIME_DTL.JOB_NUMBER as [Job Number], 
	JOB_LOG.JOB_DESC as [Job Description], 
	JOB_LOG.SC_CODE as [Sales Class], 
	EMP_TIME_DTL.JOB_COMPONENT_NBR as [Job Component Number], 
	JOB_COMPONENT.JOB_COMP_DESC as [Job Component Description], 
	JOB_COMPONENT.EMP_CODE as [Account Executive], 
	JOB_COMPONENT.JT_CODE as [Job Type], 
	EMP_TIME_DTL.FNC_CODE as [Function Code], 
	FUNCTIONS.FNC_DESCRIPTION as [Function Description], 
	EMP_TIME.EMP_DATE as Date, 
	Sum(EMP_TIME_DTL.EMP_HOURS) as Hours,
	Sum(EMP_TIME_DTL.TOTAL_BILL) AS [Amount], 
	Sum(EMP_TIME_DTL.EXT_MARKUP_AMT) as [Mark Up/Down], 
	Sum(EMP_TIME_DTL.EXT_STATE_RESALE) + SUM(EMP_TIME_DTL.EXT_COUNTY_RESALE) + SUM(EMP_TIME_DTL.EXT_CITY_RESALE) AS [Resale Tax], 
	Sum(EMP_TIME_DTL.TOTAL_BILL) + Sum(EMP_TIME_DTL.EXT_MARKUP_AMT) as [Total Amount], 
	Sum(EMP_TIME_DTL.TOTAL_BILL) + Sum(EMP_TIME_DTL.EXT_MARKUP_AMT) + Sum(EMP_TIME_DTL.EXT_STATE_RESALE) + SUM(EMP_TIME_DTL.EXT_COUNTY_RESALE) + SUM(EMP_TIME_DTL.EXT_CITY_RESALE) as [Total Amount w/ Tax],
	EMP_TIME_DTL.EMP_NON_BILL_FLAG as [Non Billable Flag], 
	ISNUMERIC(EMP_TIME_DTL.AR_INV_NBR) as [Billed Flag], 
    FNC_HEADING.FNC_HEADING_DESC AS [Function Heading], 
    --CAST(dbo.EMP_TIME_DTL_CMTS.EMP_COMMENT AS VARCHAR(4000)) AS [Time Comments],
	[Time Comments] = A.EMP_COMMENTS,
	JOB_LOG.CMP_CODE as [Campaign Code], CAMPAIGN.CMP_NAME as [Campaign Name],
	EMPLOYEE.OFFICE_CODE as [Employee Office], JOB_LOG.OFFICE_CODE as [Job Office]
FROM EMP_TIME
	INNER JOIN EMP_TIME_DTL 
		ON EMP_TIME.ET_ID = EMP_TIME_DTL.ET_ID AND (EMP_TIME_DTL.EDIT_FLAG IS NULL OR EMP_TIME_DTL.EDIT_FLAG = 0)
	INNER JOIN JOB_LOG 
		ON EMP_TIME_DTL.JOB_NUMBER = JOB_LOG.JOB_NUMBER
	INNER JOIN EMPLOYEE 
		ON EMP_TIME.EMP_CODE = EMPLOYEE.EMP_CODE
	INNER JOIN CLIENT 
		ON JOB_LOG.CL_CODE = CLIENT.CL_CODE 
	INNER JOIN DIVISION 
		ON JOB_LOG.CL_CODE = DIVISION.CL_CODE 
		AND JOB_LOG.DIV_CODE = DIVISION.DIV_CODE 
	INNER JOIN PRODUCT 
		ON JOB_LOG.CL_CODE = PRODUCT.CL_CODE 
		AND JOB_LOG.DIV_CODE = PRODUCT.DIV_CODE 
		AND JOB_LOG.PRD_CODE = PRODUCT.PRD_CODE 
	INNER JOIN DEPT_TEAM 
		ON EMP_TIME_DTL.DP_TM_CODE = DEPT_TEAM.DP_TM_CODE 
	INNER JOIN JOB_COMPONENT 
		ON EMP_TIME_DTL.JOB_NUMBER = JOB_COMPONENT.JOB_NUMBER 
		AND EMP_TIME_DTL.JOB_COMPONENT_NBR = JOB_COMPONENT.JOB_COMPONENT_NBR 
	INNER JOIN FUNCTIONS 
		ON EMP_TIME_DTL.FNC_CODE = FUNCTIONS.FNC_CODE
	LEFT OUTER JOIN PRODUCT_CATEGORY 
		ON JOB_LOG.CL_CODE = PRODUCT_CATEGORY.CL_CODE 
		AND JOB_LOG.DIV_CODE = PRODUCT_CATEGORY.DIV_CODE 
		AND JOB_LOG.PRD_CODE = PRODUCT_CATEGORY.PRD_CODE 
		AND EMP_TIME_DTL.PROD_CAT_CODE = PRODUCT_CATEGORY.PROD_CAT_CODE 
    LEFT OUTER JOIN FNC_HEADING 
        ON FUNCTIONS.FNC_HEADING_ID = FNC_HEADING.FNC_HEADING_ID
	OUTER APPLY (SELECT TOP 1 CAST(ETDC.EMP_COMMENT AS varchar(4000)) AS EMP_COMMENTS
				 FROM [dbo].[EMP_TIME_DTL_CMTS] AS ETDC WHERE EMP_TIME_DTL.ET_ID = ETDC.ET_ID AND EMP_TIME_DTL.ET_DTL_ID = ETDC.ET_DTL_ID AND ETDC.ET_SOURCE = 'D') AS A
  --  LEFT OUTER JOIN EMP_TIME_DTL_CMTS 
  --      ON EMP_TIME_DTL.ET_ID = EMP_TIME_DTL_CMTS.ET_ID 
  --      AND EMP_TIME_DTL.ET_DTL_ID = EMP_TIME_DTL_CMTS.ET_DTL_ID 
		----AND EMP_TIME_DTL.SEQ_NBR = EMP_TIME_DTL_CMTS.SEQ_NBR 
		--AND EMP_TIME_DTL_CMTS.ET_SOURCE = 'D'
	LEFT OUTER JOIN CAMPAIGN 
		ON JOB_LOG.CMP_IDENTIFIER = CAMPAIGN.CMP_IDENTIFIER
Group By EMP_TIME.EMP_CODE, 
	EMPLOYEE.EMP_FNAME + ' ' + EMPLOYEE.EMP_LNAME, 
	EMP_TIME_DTL.DP_TM_CODE, 
	DEPT_TEAM.DP_TM_DESC, 
	JOB_LOG.CL_CODE, 
	CLIENT.CL_NAME, 
	JOB_LOG.DIV_CODE, 
	DIVISION.DIV_NAME, 
	JOB_LOG.PRD_CODE, 
	PRODUCT.PRD_DESCRIPTION, 
	EMP_TIME_DTL.PROD_CAT_CODE, 
	PRODUCT_CATEGORY.PROD_CAT_DESC, 
	EMP_TIME_DTL.JOB_NUMBER, 
	JOB_LOG.JOB_DESC, 
	JOB_LOG.SC_CODE, 
	EMP_TIME_DTL.JOB_COMPONENT_NBR, 
	JOB_COMPONENT.JOB_COMP_DESC, 
	JOB_COMPONENT.EMP_CODE, 
	JOB_COMPONENT.JT_CODE, 
	EMP_TIME_DTL.FNC_CODE, 
	FUNCTIONS.FNC_DESCRIPTION, 
	EMP_TIME.EMP_DATE,
	EMP_TIME_DTL.EMP_NON_BILL_FLAG,
	ISNUMERIC(EMP_TIME_DTL.AR_INV_NBR), 
    FNC_HEADING.FNC_HEADING_DESC, 
    A.EMP_COMMENTS,
	JOB_LOG.CMP_CODE, CAMPAIGN.CMP_NAME, EMPLOYEE.OFFICE_CODE, JOB_LOG.OFFICE_CODE







