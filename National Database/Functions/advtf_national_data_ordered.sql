CREATE FUNCTION [dbo].[advtf_national_data_ordered](@CLIENT_CODE varchar(6))       
RETURNS @temptable TABLE (NATIONAL_DATA_ID int) WITH SCHEMABINDING       
AS     
BEGIN   

    INSERT INTO @temptable 
    SELECT ND.NATIONAL_DATA_ID--, ND.[START_DATE], CO.START_YEAR, CO.END_YEAR, COD.DATA_TYPE, COD.TIME_TYPE, COD.IS_HISPANIC, 
    FROM dbo.CLIENT C
	    INNER JOIN dbo.CLIENT_ORDER CO ON C.CLIENT_ID = CO.CLIENT_ID 
	    INNER JOIN dbo.CLIENT_ORDER_DETAIL COD ON CO.CLIENT_ORDER_ID = COD.CLIENT_ORDER_ID 
	    INNER JOIN dbo.NATIONAL_DATA ND ON ND.DATA_TYPE = COD.DATA_TYPE AND ND.[YEAR] BETWEEN CO.START_YEAR AND CO.END_YEAR 
    WHERE C.CODE = @CLIENT_CODE
    AND C.IS_INACTIVE = 0
    AND CO.IS_SUSPENDED = 0
    AND (
	    (DATEPART(m,ND.[START_DATE]) = 1 AND COD.JANUARY = 1 AND ND.[YEAR] BETWEEN CO.START_YEAR + 1 AND CO.END_YEAR)
	    OR
	    (DATEPART(m,ND.[START_DATE]) = 2 AND COD.FEBRUARY = 1 AND ND.[YEAR] BETWEEN CO.START_YEAR + 1 AND CO.END_YEAR)
	    OR
	    (DATEPART(m,ND.[START_DATE]) = 3 AND COD.MARCH = 1 AND ND.[YEAR] BETWEEN CO.START_YEAR + 1 AND CO.END_YEAR)
	    OR
	    (DATEPART(m,ND.[START_DATE]) = 4 AND COD.APRIL = 1 AND ND.[YEAR] BETWEEN CO.START_YEAR + 1 AND CO.END_YEAR)
	    OR
	    (DATEPART(m,ND.[START_DATE]) = 5 AND COD.MAY = 1 AND ND.[YEAR] BETWEEN CO.START_YEAR + 1 AND CO.END_YEAR)
	    OR
	    (DATEPART(m,ND.[START_DATE]) = 6 AND COD.JUNE = 1 AND ND.[YEAR] BETWEEN CO.START_YEAR + 1 AND CO.END_YEAR)
	    OR
	    (DATEPART(m,ND.[START_DATE]) = 7 AND COD.JULY = 1 AND ND.[YEAR] BETWEEN CO.START_YEAR + 1 AND CO.END_YEAR)
	    OR
	    (DATEPART(m,ND.[START_DATE]) = 8 AND COD.AUGUST = 1 AND ND.[YEAR] BETWEEN CO.START_YEAR + 1 AND CO.END_YEAR)
	    OR
	    (DATEPART(m,ND.[START_DATE]) = 9 AND COD.SEPTEMBER = 1 AND ND.[YEAR] BETWEEN CO.START_YEAR AND CO.END_YEAR -1)
	    OR
	    (DATEPART(m,ND.[START_DATE]) = 10 AND COD.OCTOBER = 1 AND ND.[YEAR] BETWEEN CO.START_YEAR AND CO.END_YEAR -1)
	    OR
	    (DATEPART(m,ND.[START_DATE]) = 11 AND COD.NOVEMBER = 1 AND ND.[YEAR] BETWEEN CO.START_YEAR AND CO.END_YEAR -1)
	    OR
	    (DATEPART(m,ND.[START_DATE]) = 12 AND COD.DECEMBER = 1 AND ND.[YEAR] BETWEEN CO.START_YEAR AND CO.END_YEAR -1)
	    )
        
	RETURN 
      
END
GO

GRANT SELECT ON [advtf_national_data_ordered] TO PUBLIC
GO