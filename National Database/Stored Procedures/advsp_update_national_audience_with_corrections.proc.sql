CREATE PROCEDURE [dbo].[advsp_update_national_audience_with_corrections]
AS
UPDATE a SET 
	COMMERCIAL_PROGRAM_DURATION  = nac.COMMERCIAL_PROGRAM_DURATION ,
	EVENT_DURATION = nac.EVENT_DURATION,
	PROGRAM_TOTAL_DURATION = nac.PROGRAM_TOTAL_DURATION,
	[PROGRAM_NAME] = nac.[PROGRAM_NAME],
	TRACKAGE_NAME = nac.TRACKAGE_NAME,
	EPISODE_NAME = nac.EPISODE_NAME,
	NIELSEN_DAYPART = nac.NIELSEN_DAYPART,
	PROGRAM_TYPE = nac.PROGRAM_TYPE,
	IS_CORRECTION = 1,
	IS_BREAKOUT = nac.IS_BREAKOUT,
	IS_SPECIAL = nac.IS_SPECIAL,
	IS_REPEAT = nac.IS_REPEAT,
	IS_PREMIERE = nac.IS_PREMIERE,
	IS_DNA = nac.IS_DNA,
	IS_MULTICAST = nac.IS_MULTICAST,
	IS_COMPLEX = nac.IS_COMPLEX,
	IS_SHORT_DURATION = nac.IS_SHORT_DURATION,
	IS_VARIOUS_METADATA = nac.IS_VARIOUS_METADATA,
	IS_VARIOUS_TIMES = nac.IS_VARIOUS_TIMES,
	IS_GAPPED = nac.IS_GAPPED,
	IS_WEEKLY_AVERAGE = nac.IS_WEEKLY_AVERAGE,
	SYNDICATOR_INFO = nac.SYNDICATOR_INFO,
	TELECAST_NUMBER = nac.TELECAST_NUMBER,
	COVERAGE_SAMPLE_IDENTIFICATION = nac.COVERAGE_SAMPLE_IDENTIFICATION,
	TOTAL_PROGRAM_INDICATOR = nac.TOTAL_PROGRAM_INDICATOR,
	DAYS_OF_WEEK_INDICATOR = nac.DAYS_OF_WEEK_INDICATOR,
	STATION_COUNT = nac.STATION_COUNT,
	HEADEND_COUNT = nac.HEADEND_COUNT,
	COVERAGE_PERCENT = nac.COVERAGE_PERCENT,
	PROGRAM_HUT = nac.PROGRAM_HUT,
	HOUSEHOLD_AUD = nac.HOUSEHOLD_AUD,
	FEMALES_2TO5_AUD = nac.FEMALES_2TO5_AUD,
	FEMALES_6TO8_AUD = nac.FEMALES_6TO8_AUD,
	FEMALES_9TO11_AUD = nac.FEMALES_9TO11_AUD,
	FEMALES_12TO14_AUD = nac.FEMALES_12TO14_AUD,
	FEMALES_15TO17_AUD = nac.FEMALES_15TO17_AUD,
	FEMALES_18TO20_AUD = nac.FEMALES_18TO20_AUD,
	FEMALES_21TO24_AUD = nac.FEMALES_21TO24_AUD,
	FEMALES_25TO29_AUD = nac.FEMALES_25TO29_AUD,
	FEMALES_30TO34_AUD = nac.FEMALES_30TO34_AUD,
	FEMALES_35TO39_AUD = nac.FEMALES_35TO39_AUD,
	FEMALES_40TO44_AUD = nac.FEMALES_40TO44_AUD,
	FEMALES_45TO49_AUD = nac.FEMALES_45TO49_AUD,
	FEMALES_50TO54_AUD = nac.FEMALES_50TO54_AUD,
	FEMALES_55TO64_AUD = nac.FEMALES_55TO64_AUD,
	FEMALES_65PLUS_AUD = nac.FEMALES_65PLUS_AUD,
	MALES_2TO5_AUD = nac.MALES_2TO5_AUD,
	MALES_6TO8_AUD = nac.MALES_6TO8_AUD,
	MALES_9TO11_AUD = nac.MALES_9TO11_AUD,
	MALES_12TO14_AUD = nac.MALES_12TO14_AUD,
	MALES_15TO17_AUD = nac.MALES_15TO17_AUD,
	MALES_18TO20_AUD = nac.MALES_18TO20_AUD,
	MALES_21TO24_AUD = nac.MALES_21TO24_AUD,
	MALES_25TO29_AUD = nac.MALES_25TO29_AUD,
	MALES_30TO34_AUD = nac.MALES_30TO34_AUD,
	MALES_35TO39_AUD = nac.MALES_35TO39_AUD,
	MALES_40TO44_AUD = nac.MALES_40TO44_AUD,
	MALES_45TO49_AUD = nac.MALES_45TO49_AUD,
	MALES_50TO54_AUD = nac.MALES_50TO54_AUD,
	MALES_55TO64_AUD = nac.MALES_55TO64_AUD,
	MALES_65PLUS_AUD = nac.MALES_65PLUS_AUD,
	WORKING_WOMEN_18TO20_AUD = nac.WORKING_WOMEN_18TO20_AUD,
	WORKING_WOMEN_21TO24_AUD = nac.WORKING_WOMEN_21TO24_AUD,
	WORKING_WOMEN_25TO34_AUD = nac.WORKING_WOMEN_25TO34_AUD,
	WORKING_WOMEN_35TO44_AUD = nac.WORKING_WOMEN_35TO44_AUD,
	WORKING_WOMEN_45TO49_AUD = nac.WORKING_WOMEN_45TO49_AUD,
	WORKING_WOMEN_50TO54_AUD = nac.WORKING_WOMEN_50TO54_AUD,
	WORKING_WOMEN_55PLUS_AUD = nac.WORKING_WOMEN_55PLUS_AUD,
	FEMALES_2TO5_PUT = nac.FEMALES_2TO5_PUT,
	FEMALES_6TO8_PUT = nac.FEMALES_6TO8_PUT,
	FEMALES_9TO11_PUT = nac.FEMALES_9TO11_PUT,
	FEMALES_12TO14_PUT = nac.FEMALES_12TO14_PUT,
	FEMALES_15TO17_PUT = nac.FEMALES_15TO17_PUT,
	FEMALES_18TO20_PUT = nac.FEMALES_18TO20_PUT,
	FEMALES_21TO24_PUT = nac.FEMALES_21TO24_PUT,
	FEMALES_25TO29_PUT = nac.FEMALES_25TO29_PUT,
	FEMALES_30TO34_PUT = nac.FEMALES_30TO34_PUT,
	FEMALES_35TO39_PUT = nac.FEMALES_35TO39_PUT,
	FEMALES_40TO44_PUT = nac.FEMALES_40TO44_PUT,
	FEMALES_45TO49_PUT = nac.FEMALES_45TO49_PUT,
	FEMALES_50TO54_PUT = nac.FEMALES_50TO54_PUT,
	FEMALES_55TO64_PUT = nac.FEMALES_55TO64_PUT,
	FEMALES_65PLUS_PUT = nac.FEMALES_65PLUS_PUT,
	MALES_2TO5_PUT = nac.MALES_2TO5_PUT,
	MALES_6TO8_PUT = nac.MALES_6TO8_PUT,
	MALES_9TO11_PUT = nac.MALES_9TO11_PUT,
	MALES_12TO14_PUT = nac.MALES_12TO14_PUT,
	MALES_15TO17_PUT = nac.MALES_15TO17_PUT,
	MALES_18TO20_PUT = nac.MALES_18TO20_PUT,
	MALES_21TO24_PUT = nac.MALES_21TO24_PUT,
	MALES_25TO29_PUT = nac.MALES_25TO29_PUT,
	MALES_30TO34_PUT = nac.MALES_30TO34_PUT,
	MALES_35TO39_PUT = nac.MALES_35TO39_PUT,
	MALES_40TO44_PUT = nac.MALES_40TO44_PUT,
	MALES_45TO49_PUT = nac.MALES_45TO49_PUT,
	MALES_50TO54_PUT = nac.MALES_50TO54_PUT,
	MALES_55TO64_PUT = nac.MALES_55TO64_PUT,
	MALES_65PLUS_PUT = nac.MALES_65PLUS_PUT,
	WORKING_WOMEN_18TO20_PUT = nac.WORKING_WOMEN_18TO20_PUT,
	WORKING_WOMEN_21TO24_PUT = nac.WORKING_WOMEN_21TO24_PUT,
	WORKING_WOMEN_25TO34_PUT = nac.WORKING_WOMEN_25TO34_PUT,
	WORKING_WOMEN_35TO44_PUT = nac.WORKING_WOMEN_35TO44_PUT,
	WORKING_WOMEN_45TO49_PUT = nac.WORKING_WOMEN_45TO49_PUT,
	WORKING_WOMEN_50TO54_PUT = nac.WORKING_WOMEN_50TO54_PUT,
	WORKING_WOMEN_55PLUS_PUT = nac.WORKING_WOMEN_55PLUS_PUT
FROM dbo.NATIONAL_AUDIENCE a
	INNER JOIN dbo.NATIONAL_DATA d on a.NATIONAL_DATA_ID = d.NATIONAL_DATA_ID 
	INNER JOIN dbo.NATIONAL_AUDIENCE_CORRECTION nac ON d.MARKET_BREAK_ID = nac.MARKET_BREAK_ID and d.DATA_TYPE = nac.DATA_TYPE AND d.STREAM = nac.STREAM 
									AND a.TIME_TYPE = nac.TIME_TYPE AND a.NETWORK = nac.NETWORK AND a.AUDIENCE_DATETIME = nac.AUDIENCE_DATETIME 
									AND a.PROGRAM_CODE = nac.PROGRAM_CODE AND a.TRACKAGE_CODE = nac.TRACKAGE_CODE 
	INNER JOIN (
				select MAX([START_DATE]) AS [START_DATE],[MARKET_BREAK_ID],
					[DATA_TYPE] ,
					[STREAM] ,
					[TIME_TYPE] ,
					[NETWORK] ,
					[AUDIENCE_DATETIME] ,
					[PROGRAM_CODE] ,
					[TRACKAGE_CODE]
				FROM NATIONAL_AUDIENCE_CORRECTION
				group by [MARKET_BREAK_ID],
					[DATA_TYPE],
					[STREAM],
					[TIME_TYPE],
					[NETWORK],
					[AUDIENCE_DATETIME],
					[PROGRAM_CODE],
					[TRACKAGE_CODE]
				) m ON m.[START_DATE] = nac.[START_DATE]
							AND m.[MARKET_BREAK_ID] = nac.[MARKET_BREAK_ID]
							AND m.[DATA_TYPE] = nac.[DATA_TYPE]
							AND m.[STREAM] = nac.[STREAM]
							AND m.[TIME_TYPE] = nac.[TIME_TYPE]
							AND m.[NETWORK] = nac.[NETWORK]
							AND m.[AUDIENCE_DATETIME] = nac.[AUDIENCE_DATETIME]
							AND m.[PROGRAM_CODE] = nac.[PROGRAM_CODE]
							AND m.[TRACKAGE_CODE] = nac.[TRACKAGE_CODE]


