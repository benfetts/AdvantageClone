CREATE FUNCTION [dbo].[advfn_nielsen_spot_tv_rowcount](
	@NIELSEN_TV_BOOK_ID int
)
RETURNS bigint
WITH SCHEMABINDING
AS
BEGIN

DECLARE @totalrows bigint

SELECT @totalrows = COALESCE(COUNT(1), 0) 
FROM dbo.NIELSEN_TV_AUDIENCE 
WHERE NIELSEN_TV_BOOK_ID = @NIELSEN_TV_BOOK_ID

SELECT @totalrows = @totalrows + COALESCE(COUNT(1), 0)
FROM dbo.NIELSEN_TV_HUTPUT 
WHERE NIELSEN_TV_BOOK_ID = @NIELSEN_TV_BOOK_ID

SELECT @totalrows = @totalrows + COALESCE(COUNT(1), 0) 
FROM dbo.NIELSEN_TV_INTAB
WHERE NIELSEN_TV_BOOK_ID = @NIELSEN_TV_BOOK_ID

SELECT @totalrows = @totalrows + COALESCE(COUNT(1), 0) 
FROM dbo.NIELSEN_TV_UNIVERSE u
	INNER JOIN dbo.NIELSEN_TV_BOOK b ON u.NIELSEN_MARKET_NUM = b.NIELSEN_MARKET_NUM AND b.NIELSEN_TV_BOOK_ID = @NIELSEN_TV_BOOK_ID AND u.REPORTING_SERVICE = b.REPORTING_SERVICE AND u.EXCLUSION = b.EXCLUSION AND u.ETHNICITY = b.ETHNICITY
WHERE u.SURVEY_START_DATE >= b.START_DATETIME
AND u.SURVEY_END_DATE <= b.END_DATETIME 

	RETURN @totalrows
END
GO

GRANT EXEC ON [advfn_nielsen_spot_tv_rowcount] TO PUBLIC
GO
