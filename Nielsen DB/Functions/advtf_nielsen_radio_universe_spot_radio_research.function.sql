CREATE FUNCTION [dbo].[advtf_nielsen_radio_universe_spot_radio_research](
	@NIELSEN_RADIO_SEGMENT_PARENT_IDs varchar(max),
	@NIELSEN_RADIO_QUALITATIVE_ID int
)
RETURNS
@RETURN_TABLE TABLE (
	[NIELSEN_DEMO_CODE] varchar(7) NOT NULL,
	[POPULATION] bigint NOT NULL,
	[NIELSEN_RADIO_SEGMENT_PARENT_ID] int NOT NULL
)
WITH SCHEMABINDING
AS
BEGIN
	DECLARE @tt TABLE (
		[251] int NOT NULL,
		[42] int NOT NULL,
		[1] int NOT NULL,
		[264] int NOT NULL,
		[8] int NOT NULL,
		[254] int NOT NULL,
		[255] int NOT NULL,
		[3] int NOT NULL,
		[4] int NOT NULL,
		[5] int NOT NULL,
		[6] int NOT NULL,
		[82] int NOT NULL,
		[7] int NOT NULL,
		[267] int NOT NULL,
		[268] int NOT NULL,
		[10] int NOT NULL,
		[11] int NOT NULL,
		[12] int NOT NULL,
		[13] int NOT NULL,
		[14] int NOT NULL,
		[15] int NOT NULL,
		NIELSEN_RADIO_SEGMENT_PARENT_ID int NOT NULL
	)

	INSERT INTO @tt
	SELECT
		[251] = a.[MALES_6TO11_UE],
		[42] = FEMALES_12TO17_UE + FEMALES_18TO20_UE + FEMALES_18TO24_UE + FEMALES_21TO24_UE + FEMALES_25TO34_UE + FEMALES_35TO44_UE + FEMALES_35TO49_UE + FEMALES_45TO49_UE + FEMALES_50TO54_UE + FEMALES_55TO64_UE + FEMALES_65PLUS_UE + 
		       MALES_12TO17_UE + MALES_18TO20_UE + MALES_18TO24_UE + MALES_21TO24_UE + MALES_25TO34_UE + MALES_35TO44_UE + MALES_35TO49_UE + MALES_45TO49_UE + MALES_50TO54_UE + MALES_55TO64_UE + MALES_65PLUS_UE,
		[1] = a.[MALES_12TO17_UE],
		[264] = a.[FEMALES_6TO11_UE],
		[8] = a.[FEMALES_12TO17_UE],
		[254] = a.[MALES_18TO20_UE] + CASE WHEN @NIELSEN_RADIO_QUALITATIVE_ID > 1 THEN a.MALES_18TO24_UE ELSE 0 END,
		[255] = a.[MALES_21TO24_UE],
		[3] = a.[MALES_25TO34_UE],
		[4] = a.[MALES_35TO44_UE] + CASE WHEN @NIELSEN_RADIO_QUALITATIVE_ID > 1 THEN a.MALES_35TO49_UE ELSE 0 END,
		[5] = a.[MALES_45TO49_UE],
		[6] = a.[MALES_50TO54_UE],
		[82] = a.[MALES_55TO64_UE],
		[7] = a.[MALES_65PLUS_UE],
		[267] = a.[FEMALES_18TO20_UE] + CASE WHEN @NIELSEN_RADIO_QUALITATIVE_ID > 1 THEN a.FEMALES_18TO24_UE ELSE 0 END,
		[268] = a.[FEMALES_21TO24_UE],
		[10] = a.[FEMALES_25TO34_UE],
		[11] = a.[FEMALES_35TO44_UE] + CASE WHEN @NIELSEN_RADIO_QUALITATIVE_ID > 1 THEN a.FEMALES_35TO49_UE ELSE 0 END,
		[12] = a.[FEMALES_45TO49_UE],
		[13] = a.[FEMALES_50TO54_UE],
		[14] = a.[FEMALES_55TO64_UE],
		[15] = a.[FEMALES_65PLUS_UE],
		NIELSEN_RADIO_SEGMENT_PARENT_ID
	FROM dbo.NIELSEN_RADIO_UNIVERSE a
	WHERE a.NIELSEN_RADIO_SEGMENT_PARENT_ID IN (SELECT items FROM dbo.udf_split_list(@NIELSEN_RADIO_SEGMENT_PARENT_IDs, ','))
	
	INSERT INTO @RETURN_TABLE
	SELECT
		u.nielsen_demo_code, u.ue, u.NIELSEN_RADIO_SEGMENT_PARENT_ID
	FROM @tt
	UNPIVOT
	(
		ue
		for nielsen_demo_code in ([251], [42], [1], [264], [8], [254], [255], [3], [4], 
		[5], [6], [82], [7], [267], [268], [10], [11], [12], [13], [14], [15]) 
	) u

	RETURN
END
GO

GRANT SELECT ON [advtf_nielsen_radio_universe_spot_radio_research] TO PUBLIC
GO