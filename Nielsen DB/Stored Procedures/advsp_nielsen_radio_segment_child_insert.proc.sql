CREATE PROCEDURE [dbo].[advsp_nielsen_radio_segment_child_insert]

AS

CREATE TABLE #child (
	NIELSEN_RADIO_DAYPART_ID int NOT NULL,
	LISTENING_LOCATION char(1) COLLATE SQL_Latin1_General_CP1_CS_AS NOT NULL,
	STATION_COMBO_TYPE smallint NOT NULL,
	STATION_COMBO_ID char(6) COLLATE SQL_Latin1_General_CP1_CS_AS NOT NULL
)

INSERT INTO #child
SELECT DISTINCT d.NIELSEN_RADIO_DAYPART_ID,v.LISTENING_LOCATION,v.STATION_COMBO_TYPE,v.STATION_COMBO_ID 
FROM dbo.NIELSEN_RADIO_V_STAGING v 
	INNER JOIN dbo.NIELSEN_RADIO_DAYPART d ON v.DAYPART = d.NIELSEN_DAYPART_ID

DELETE #child
FROM #child c
	INNER JOIN dbo.NIELSEN_RADIO_SEGMENT_CHILD sc ON c.NIELSEN_RADIO_DAYPART_ID = sc.NIELSEN_RADIO_DAYPART_ID 
												 AND c.LISTENING_LOCATION = sc.LISTENING_LOCATION 
												 AND c.STATION_COMBO_TYPE = sc.STATION_COMBO_TYPE
												 AND c.STATION_COMBO_ID = sc.NIELSEN_RADIO_STATION_COMBO_ID 

INSERT INTO [dbo].[NIELSEN_RADIO_SEGMENT_CHILD] ([NIELSEN_RADIO_DAYPART_ID],[LISTENING_LOCATION],[STATION_COMBO_TYPE],[NIELSEN_RADIO_STATION_COMBO_ID])
SELECT [NIELSEN_RADIO_DAYPART_ID],[LISTENING_LOCATION],[STATION_COMBO_TYPE],[STATION_COMBO_ID]
FROM #child 
ORDER BY 1,2,3,4

UPDATE v SET v.NIELSEN_RADIO_SEGMENT_CHILD_ID = c.NIELSEN_RADIO_SEGMENT_CHILD_ID, v.NIELSEN_RADIO_DAYPART_ID = d.NIELSEN_RADIO_DAYPART_ID 
FROM NIELSEN_RADIO_V_STAGING v
	INNER JOIN dbo.NIELSEN_RADIO_DAYPART d ON v.DAYPART = d.NIELSEN_DAYPART_ID
	INNER JOIN dbo.NIELSEN_RADIO_SEGMENT_CHILD c ON d.NIELSEN_RADIO_DAYPART_ID = c.NIELSEN_RADIO_DAYPART_ID 
												AND v.LISTENING_LOCATION = c.LISTENING_LOCATION 
												AND v.STATION_COMBO_TYPE = c.STATION_COMBO_TYPE
												AND v.STATION_COMBO_ID = c.NIELSEN_RADIO_STATION_COMBO_ID
GO

GRANT EXEC ON [advsp_nielsen_radio_segment_child_insert] TO PUBLIC
GO