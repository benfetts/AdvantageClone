IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[advtf_nielsen_radio_audience_get_aqh]') AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[advtf_nielsen_radio_audience_get_aqh]
GO

CREATE FUNCTION [dbo].[advtf_nielsen_radio_audience_get_aqh](
	@NIELSEN_RADIO_SEGMENT_PARENT_IDs varchar(max),
	@LISTENING_LOCATION char(1),
	@STATION_COMBO_TYPE smallint,
	@SelectedMediaDemographicIDs varchar(max),
	@MEDIA_DEMO_DETAIL_TYPE [dbo].[MEDIA_DEMO_DETAIL_TYPE] READONLY,
	@MEDIA_SPOT_TV_RESEARCH_DAYTIME_TYPE dbo.MEDIA_SPOT_TV_RESEARCH_DAYTIME_TYPE READONLY
)
RETURNS
@RETURN_TABLE TABLE (
	[NIELSEN_DEMO_CODE] varchar(7) NOT NULL,
	[AQH] bigint NOT NULL,
	MEDIA_DEMO_ID int NOT NULL,
	NIELSEN_RADIO_STATION_COMBO_ID int NOT NULL,
	NIELSEN_RADIO_SEGMENT_PARENT_ID int NOT NULL,
	[ID] int NOT NULL
)
WITH SCHEMABINDING
AS
BEGIN

	DECLARE @LOCAL_MEDIA_SPOT_TV_RESEARCH_DAYTIME_TYPE dbo.MEDIA_SPOT_TV_RESEARCH_DAYTIME_TYPE
	
	INSERT INTO @LOCAL_MEDIA_SPOT_TV_RESEARCH_DAYTIME_TYPE (ID, Monday, Tuesday, Wednesday, Thursday, Friday, Saturday, Sunday, StartTime, EndTime, StartHour, EndHour, [Days])
	SELECT ID, Monday, Tuesday, Wednesday, Thursday, Friday, Saturday, Sunday, StartTime, EndTime, StartHour, EndHour, [Days]
	FROM @MEDIA_SPOT_TV_RESEARCH_DAYTIME_TYPE
	
	UPDATE @LOCAL_MEDIA_SPOT_TV_RESEARCH_DAYTIME_TYPE SET EndHour = EndHour + 1
	WHERE StartHour = EndHour

	DECLARE @tt TABLE (
		[251] int NOT NULL,
		[42] int NOT NULL,
		[1] int NOT NULL,
		[264] int NOT NULL,
		[8] int NOT NULL,
		[254] int NOT NULL,
		[255] int NOT NULL,
		[3] int NOT NULL,
		[4] int NOT NULL,
		[5] int NOT NULL,
		[6] int NOT NULL,
		[82] int NOT NULL,
		[7] int NOT NULL,
		[267] int NOT NULL,
		[268] int NOT NULL,
		[10] int NOT NULL,
		[11] int NOT NULL,
		[12] int NOT NULL,
		[13] int NOT NULL,
		[14] int NOT NULL,
		[15] int NOT NULL,
		NIELSEN_RADIO_STATION_COMBO_ID int NOT NULL,
		NIELSEN_RADIO_SEGMENT_PARENT_ID int NOT NULL,
		ID int NOT NULL,
		TOT_DAYS int NOT NULL,
		SEGMENT_MINUTES int NOT NULL
	)
	
	DECLARE @tt2 TABLE (
		[251] int NOT NULL,
		[42] int NOT NULL,
		[1] int NOT NULL,
		[264] int NOT NULL,
		[8] int NOT NULL,
		[254] int NOT NULL,
		[255] int NOT NULL,
		[3] int NOT NULL,
		[4] int NOT NULL,
		[5] int NOT NULL,
		[6] int NOT NULL,
		[82] int NOT NULL,
		[7] int NOT NULL,
		[267] int NOT NULL,
		[268] int NOT NULL,
		[10] int NOT NULL,
		[11] int NOT NULL,
		[12] int NOT NULL,
		[13] int NOT NULL,
		[14] int NOT NULL,
		[15] int NOT NULL,
		NIELSEN_RADIO_STATION_COMBO_ID int NOT NULL,
		NIELSEN_RADIO_SEGMENT_PARENT_ID int NOT NULL,
		ID int NOT NULL,
		TOT_DAYS int NOT NULL,
		SEGMENT_MINUTES int NOT NULL
	)

	INSERT INTO @tt
	SELECT
			[251] = a.[MALES_6TO11_AQH],
			[42] = MALES_12TO17_AQH + MALES_18TO20_AQH + MALES_18TO24_AQH + MALES_21TO24_AQH + MALES_25TO34_AQH + MALES_35TO44_AQH + MALES_35TO49_AQH + MALES_45TO49_AQH + MALES_50TO54_AQH + MALES_55TO64_AQH + MALES_65PLUS_AQH + 
					FEMALES_12TO17_AQH + FEMALES_18TO20_AQH + FEMALES_18TO24_AQH + FEMALES_21TO24_AQH + FEMALES_25TO34_AQH + FEMALES_35TO44_AQH + FEMALES_35TO49_AQH + FEMALES_45TO49_AQH + FEMALES_50TO54_AQH + FEMALES_55TO64_AQH + FEMALES_65PLUS_AQH,
			[1] = a.[MALES_12TO17_AQH],
			[264] = a.[FEMALES_6TO11_AQH],
			[8] = a.[FEMALES_12TO17_AQH],
			[254] = a.[MALES_18TO20_AQH],
			[255] = a.[MALES_21TO24_AQH],
			[3] = a.[MALES_25TO34_AQH],
			[4] = a.[MALES_35TO44_AQH],
			[5] = a.[MALES_45TO49_AQH],
			[6] = a.[MALES_50TO54_AQH],
			[82] = a.[MALES_55TO64_AQH],
			[7] = a.[MALES_65PLUS_AQH],
			[267] = a.[FEMALES_18TO20_AQH],
			[268] = a.[FEMALES_21TO24_AQH],
			[10] = a.[FEMALES_25TO34_AQH],
			[11] = a.[FEMALES_35TO44_AQH],
			[12] = a.[FEMALES_45TO49_AQH],
			[13] = a.[FEMALES_50TO54_AQH],
			[14] = a.[FEMALES_55TO64_AQH],
			[15] = a.[FEMALES_65PLUS_AQH],
			c.NIELSEN_RADIO_STATION_COMBO_ID,
			a.NIELSEN_RADIO_SEGMENT_PARENT_ID,
			MRDT.ID,
			TOT_DAYS = MRDT.RowDays,
			SEGMENT_MINUTES = MRDT.RowDays * (CASE WHEN MRDT.EndMinutes = MRDT.StartMinutes THEN 15 ELSE CASE WHEN MRDT.EndMinutes < dp.END_MINUTE THEN MRDT.EndMinutes ELSE dp.END_MINUTE END - CASE WHEN MRDT.StartMinutes > dp.START_MINUTE THEN MRDT.StartMinutes ELSE dp.START_MINUTE END END)
		FROM dbo.NIELSEN_RADIO_AUDIENCE a
			INNER JOIN dbo.NIELSEN_RADIO_SEGMENT_CHILD c ON a.NIELSEN_RADIO_SEGMENT_CHILD_ID = c.NIELSEN_RADIO_SEGMENT_CHILD_ID
														AND c.LISTENING_LOCATION = @LISTENING_LOCATION
														AND c.STATION_COMBO_TYPE = @STATION_COMBO_TYPE
			INNER JOIN dbo.NIELSEN_RADIO_DAYPART dp ON c.NIELSEN_RADIO_DAYPART_ID = dp.NIELSEN_RADIO_DAYPART_ID AND dp.AQH = 1 AND dp.USE_SEGMENT = 1
			INNER JOIN (SELECT 
							ID,
							StartHour,
							EndHour, 
							Sunday,
							Monday,
							Tuesday, 
							Wednesday,
							Thursday,
							Friday,
							Saturday,
							MonFri = CASE WHEN Monday=1 OR Tuesday=1 OR Wednesday=1 OR Thursday=1 OR Friday=1 THEN 1 ELSE 0 END,
							RowDays = (CAST(Sunday as int) + CAST(Monday as int) + CAST(Tuesday as int) + CAST(Wednesday as int) + CAST(Thursday as int) + CAST(Friday as int) + CAST(Saturday as int)),
							[StartMinutes] = SUBSTRING(RIGHT('0000' + CAST(StartHour as varchar), 4),1,2) * 60 + SUBSTRING(RIGHT('0000' + CAST(StartHour as varchar), 4),3,2),
							[EndMinutes] = SUBSTRING(RIGHT('0000' + CAST(EndHour as varchar), 4),1,2) * 60 + SUBSTRING(RIGHT('0000' + CAST(EndHour as varchar), 4),3,2)
						FROM 
							@LOCAL_MEDIA_SPOT_TV_RESEARCH_DAYTIME_TYPE) MRDT ON MRDT.ID > 0
			INNER JOIN (SELECT NIELSEN_RADIO_DAYPART_ID, dt.ID
								FROM dbo.NIELSEN_RADIO_DAYPART dp
									INNER JOIN @LOCAL_MEDIA_SPOT_TV_RESEARCH_DAYTIME_TYPE dt ON dt.ID > 0
								WHERE dp.MIL_START_TIME < dt.StartHour 
								AND dp.MIL_END_TIME > dt.EndHour 
								AND dp.SUNDAY = dt.Sunday 
								AND dp.MONDAY = dt.Monday
								AND dp.TUESDAY = dt.Tuesday 
								AND dp.WEDNESDAY = dt.Wednesday 
								AND dp.THURSDAY = dt.Thursday 
								AND dp.FRIDAY = dt.Friday 
								AND dp.SATURDAY = dt.Saturday) AS NRD ON NRD.NIELSEN_RADIO_DAYPART_ID = c.NIELSEN_RADIO_DAYPART_ID
																			AND NRD.ID = MRDT.ID
		WHERE NIELSEN_RADIO_SEGMENT_PARENT_ID IN (SELECT items FROM dbo.udf_split_list(@NIELSEN_RADIO_SEGMENT_PARENT_IDs, ','))
		AND c.NIELSEN_RADIO_DAYPART_ID = NRD.NIELSEN_RADIO_DAYPART_ID

		INSERT INTO @tt2
		SELECT 
			[251] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [251] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [251] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [251] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [251] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [251] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[42] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [42] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [42] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [42] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [42] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [42] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[1] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [1] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [1] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [1] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [1] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [1] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[264] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [264] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [264] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [264] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [264] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [264] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[8] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [8] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [8] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [8] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [8] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [8] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[254] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [254] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [254] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [254] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [254] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [254] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[255] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [255] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [255] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [255] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [255] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [255] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[3] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [3] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [3] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [3] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [3] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [3] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[4] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [4] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [4] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [4] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [4] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [4] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[5] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [5] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [5] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [5] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [5] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [5] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[6] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [6] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [6] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [6] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [6] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [6] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[82] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [82] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [82] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [82] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [82] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [82] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[7] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [7] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [7] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [7] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [7] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [7] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[267] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [267] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [267] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [267] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [267] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [267] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[268] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [268] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [268] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [268] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [268] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [268] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[10] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [10] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [10] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [10] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [10] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [10] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[11] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [11] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [11] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [11] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [11] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [11] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[12] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [12] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [12] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [12] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [12] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [12] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[13] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [13] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [13] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [13] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [13] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [13] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[14] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [14] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [14] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [14] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [14] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [14] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[15] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [15] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [15] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [15] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [15] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [15] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			NIELSEN_RADIO_STATION_COMBO_ID,
			NIELSEN_RADIO_SEGMENT_PARENT_ID,
			ID,
			TOT_DAYS,
			SEGMENT_MINUTES
		FROM (
			SELECT
				[251] = a.[MALES_6TO11_AQH],
				[42] = MALES_12TO17_AQH + MALES_18TO20_AQH + MALES_18TO24_AQH + MALES_21TO24_AQH + MALES_25TO34_AQH + MALES_35TO44_AQH + MALES_35TO49_AQH + MALES_45TO49_AQH + MALES_50TO54_AQH + MALES_55TO64_AQH + MALES_65PLUS_AQH + 
						FEMALES_12TO17_AQH + FEMALES_18TO20_AQH + FEMALES_18TO24_AQH + FEMALES_21TO24_AQH + FEMALES_25TO34_AQH + FEMALES_35TO44_AQH + FEMALES_35TO49_AQH + FEMALES_45TO49_AQH + FEMALES_50TO54_AQH + FEMALES_55TO64_AQH + FEMALES_65PLUS_AQH,
				[1] = a.[MALES_12TO17_AQH],
				[264] = a.[FEMALES_6TO11_AQH],
				[8] = a.[FEMALES_12TO17_AQH],
				[254] = a.[MALES_18TO20_AQH],
				[255] = a.[MALES_21TO24_AQH],
				[3] = a.[MALES_25TO34_AQH],
				[4] = a.[MALES_35TO44_AQH],
				[5] = a.[MALES_45TO49_AQH],
				[6] = a.[MALES_50TO54_AQH],
				[82] = a.[MALES_55TO64_AQH],
				[7] = a.[MALES_65PLUS_AQH],
				[267] = a.[FEMALES_18TO20_AQH],
				[268] = a.[FEMALES_21TO24_AQH],
				[10] = a.[FEMALES_25TO34_AQH],
				[11] = a.[FEMALES_35TO44_AQH],
				[12] = a.[FEMALES_45TO49_AQH],
				[13] = a.[FEMALES_50TO54_AQH],
				[14] = a.[FEMALES_55TO64_AQH],
				[15] = a.[FEMALES_65PLUS_AQH],
				c.NIELSEN_RADIO_STATION_COMBO_ID,
				TOT_DAYS = TOT_DAYS,
				SEGMENT_MINUTES = (CASE WHEN MRDT.EndMinutes = MRDT.StartMinutes THEN 15 ELSE CASE WHEN MRDT.EndMinutes < dp.END_MINUTE THEN MRDT.EndMinutes ELSE dp.END_MINUTE END - CASE WHEN MRDT.StartMinutes > dp.START_MINUTE THEN MRDT.StartMinutes ELSE dp.START_MINUTE END END),
				a.NIELSEN_RADIO_SEGMENT_PARENT_ID,
				MRDT.ID,
				MRDT.SMinute,
				MRDT.EMinute,
				dp.NIELSEN_DAYPART_ID 

				--, dp.*
			FROM dbo.NIELSEN_RADIO_AUDIENCE a
				INNER JOIN dbo.NIELSEN_RADIO_SEGMENT_CHILD c ON a.NIELSEN_RADIO_SEGMENT_CHILD_ID = c.NIELSEN_RADIO_SEGMENT_CHILD_ID
															AND c.LISTENING_LOCATION = @LISTENING_LOCATION
															AND c.STATION_COMBO_TYPE = @STATION_COMBO_TYPE
				INNER JOIN dbo.NIELSEN_RADIO_DAYPART dp ON c.NIELSEN_RADIO_DAYPART_ID = dp.NIELSEN_RADIO_DAYPART_ID AND dp.AQH = 1 AND dp.USE_SEGMENT = 1
				INNER JOIN (SELECT 
								ID,
								StartHour,
								EndHour, 
								Sunday,
								Monday,
								Tuesday, 
								Wednesday,
								Thursday,
								Friday,
								Saturday,
								MonFri = CASE WHEN Monday=1 OR Tuesday=1 OR Wednesday=1 OR Thursday=1 OR Friday=1 THEN 1 ELSE 0 END,
								TOT_DAYS = (CAST(Monday as int) + CAST(Tuesday as int) + CAST(Wednesday as int) + CAST(Thursday as int) + CAST(Friday as int)),
								[StartMinutes] = SUBSTRING(RIGHT('0000' + CAST(StartHour as varchar), 4),1,2) * 60 + SUBSTRING(RIGHT('0000' + CAST(StartHour as varchar), 4),3,2),
								[EndMinutes] = SUBSTRING(RIGHT('0000' + CAST(EndHour as varchar), 4),1,2) * 60 + SUBSTRING(RIGHT('0000' + CAST(EndHour as varchar), 4),3,2),
								SMinute = CAST(RIGHT(StartHour, 2) as int),
								EMinute = CAST(RIGHT(EndHour, 2) as int)
							FROM 
								@LOCAL_MEDIA_SPOT_TV_RESEARCH_DAYTIME_TYPE
							WHERE ID NOT IN (SELECT ID FROM @tt)) MRDT ON MRDT.ID > 0
			WHERE NIELSEN_RADIO_SEGMENT_PARENT_ID IN (SELECT items FROM dbo.udf_split_list(@NIELSEN_RADIO_SEGMENT_PARENT_IDs, ','))
			AND
				(
					(
						(dp.MIL_START_TIME BETWEEN MRDT.StartHour AND MRDT.EndHour AND dp.MIL_START_TIME <> MRDT.EndHour)
					OR
						(dp.MIL_END_TIME BETWEEN MRDT.StartHour AND MRDT.EndHour AND dp.MIL_END_TIME <> MRDT.StartHour)
					OR
						(MRDT.StartHour >= dp.MIL_START_TIME AND MRDT.EndHour <= dp.MIL_END_TIME)
					)
				AND MRDT.MonFri = 1 AND dp.MONDAY = 1
				)
			) monfri

		INSERT INTO @tt2
		SELECT 
			[251] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [251] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [251] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [251] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [251] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [251] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[42] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [42] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [42] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [42] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [42] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [42] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[1] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [1] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [1] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [1] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [1] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [1] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[264] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [264] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [264] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [264] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [264] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [264] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[8] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [8] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [8] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [8] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [8] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [8] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[254] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [254] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [254] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [254] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [254] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [254] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[255] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [255] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [255] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [255] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [255] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [255] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[3] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [3] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [3] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [3] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [3] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [3] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[4] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [4] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [4] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [4] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [4] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [4] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[5] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [5] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [5] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [5] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [5] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [5] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[6] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [6] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [6] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [6] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [6] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [6] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[82] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [82] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [82] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [82] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [82] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [82] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[7] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [7] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [7] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [7] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [7] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [7] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[267] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [267] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [267] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [267] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [267] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [267] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[268] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [268] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [268] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [268] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [268] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [268] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[10] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [10] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [10] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [10] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [10] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [10] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[11] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [11] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [11] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [11] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [11] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [11] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[12] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [12] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [12] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [12] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [12] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [12] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[13] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [13] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [13] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [13] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [13] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [13] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[14] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [14] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [14] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [14] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [14] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [14] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[15] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [15] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [15] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [15] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [15] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [15] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			NIELSEN_RADIO_STATION_COMBO_ID,
			NIELSEN_RADIO_SEGMENT_PARENT_ID,
			ID,
			TOT_DAYS,
			SEGMENT_MINUTES 
		FROM (
			SELECT
				[251] = a.[MALES_6TO11_AQH],
				[42] = MALES_12TO17_AQH + MALES_18TO20_AQH + MALES_18TO24_AQH + MALES_21TO24_AQH + MALES_25TO34_AQH + MALES_35TO44_AQH + MALES_35TO49_AQH + MALES_45TO49_AQH + MALES_50TO54_AQH + MALES_55TO64_AQH + MALES_65PLUS_AQH + 
						FEMALES_12TO17_AQH + FEMALES_18TO20_AQH + FEMALES_18TO24_AQH + FEMALES_21TO24_AQH + FEMALES_25TO34_AQH + FEMALES_35TO44_AQH + FEMALES_35TO49_AQH + FEMALES_45TO49_AQH + FEMALES_50TO54_AQH + FEMALES_55TO64_AQH + FEMALES_65PLUS_AQH,
				[1] = a.[MALES_12TO17_AQH],
				[264] = a.[FEMALES_6TO11_AQH],
				[8] = a.[FEMALES_12TO17_AQH],
				[254] = a.[MALES_18TO20_AQH],
				[255] = a.[MALES_21TO24_AQH],
				[3] = a.[MALES_25TO34_AQH],
				[4] = a.[MALES_35TO44_AQH],
				[5] = a.[MALES_45TO49_AQH],
				[6] = a.[MALES_50TO54_AQH],
				[82] = a.[MALES_55TO64_AQH],
				[7] = a.[MALES_65PLUS_AQH],
				[267] = a.[FEMALES_18TO20_AQH],
				[268] = a.[FEMALES_21TO24_AQH],
				[10] = a.[FEMALES_25TO34_AQH],
				[11] = a.[FEMALES_35TO44_AQH],
				[12] = a.[FEMALES_45TO49_AQH],
				[13] = a.[FEMALES_50TO54_AQH],
				[14] = a.[FEMALES_55TO64_AQH],
				[15] = a.[FEMALES_65PLUS_AQH],
				c.NIELSEN_RADIO_STATION_COMBO_ID,
				TOT_DAYS = TOT_DAYS,
				SEGMENT_MINUTES = (CASE WHEN MRDT.EndMinutes = MRDT.StartMinutes THEN 15 ELSE CASE WHEN MRDT.EndMinutes < dp.END_MINUTE THEN MRDT.EndMinutes ELSE dp.END_MINUTE END - CASE WHEN MRDT.StartMinutes > dp.START_MINUTE THEN MRDT.StartMinutes ELSE dp.START_MINUTE END END),
				a.NIELSEN_RADIO_SEGMENT_PARENT_ID,
				MRDT.ID,
				MRDT.SMinute,
				MRDT.EMinute,
				dp.NIELSEN_DAYPART_ID 

				--, dp.*
			FROM dbo.NIELSEN_RADIO_AUDIENCE a
				INNER JOIN dbo.NIELSEN_RADIO_SEGMENT_CHILD c ON a.NIELSEN_RADIO_SEGMENT_CHILD_ID = c.NIELSEN_RADIO_SEGMENT_CHILD_ID
															AND c.LISTENING_LOCATION = @LISTENING_LOCATION
															AND c.STATION_COMBO_TYPE = @STATION_COMBO_TYPE
				INNER JOIN dbo.NIELSEN_RADIO_DAYPART dp ON c.NIELSEN_RADIO_DAYPART_ID = dp.NIELSEN_RADIO_DAYPART_ID AND dp.AQH = 1 AND dp.USE_SEGMENT = 1
				INNER JOIN (SELECT 
								ID,
								StartHour,
								EndHour, 
								Saturday,
								TOT_DAYS = 1,
								[StartMinutes] = SUBSTRING(RIGHT('0000' + CAST(StartHour as varchar), 4),1,2) * 60 + SUBSTRING(RIGHT('0000' + CAST(StartHour as varchar), 4),3,2),
								[EndMinutes] = SUBSTRING(RIGHT('0000' + CAST(EndHour as varchar), 4),1,2) * 60 + SUBSTRING(RIGHT('0000' + CAST(EndHour as varchar), 4),3,2),
								SMinute = CAST(RIGHT(StartHour, 2) as int),
								EMinute = CAST(RIGHT(EndHour, 2) as int)
							FROM 
								@LOCAL_MEDIA_SPOT_TV_RESEARCH_DAYTIME_TYPE
							WHERE Saturday = 1
							AND ID NOT IN (SELECT ID FROM @tt)) MRDT ON MRDT.ID > 0
			WHERE NIELSEN_RADIO_SEGMENT_PARENT_ID IN (SELECT items FROM dbo.udf_split_list(@NIELSEN_RADIO_SEGMENT_PARENT_IDs, ','))
			AND
				(
					(
						(dp.MIL_START_TIME BETWEEN MRDT.StartHour AND MRDT.EndHour AND dp.MIL_START_TIME <> MRDT.EndHour)
					OR
						(dp.MIL_END_TIME BETWEEN MRDT.StartHour AND MRDT.EndHour AND dp.MIL_END_TIME <> MRDT.StartHour)
					OR
						(MRDT.StartHour >= dp.MIL_START_TIME AND MRDT.EndHour <= dp.MIL_END_TIME)
					)
				AND MRDT.Saturday = 1 AND dp.SATURDAY = 1
				AND dp.SUNDAY = 0 AND dp.MONDAY = 0 AND dp.TUESDAY = 0 AND dp.WEDNESDAY = 0 AND dp.THURSDAY = 0 AND dp.FRIDAY = 0
				)
			) sat
	
		INSERT INTO @tt2
		SELECT 
			[251] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [251] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [251] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [251] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [251] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [251] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[42] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [42] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [42] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [42] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [42] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [42] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[1] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [1] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [1] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [1] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [1] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [1] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[264] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [264] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [264] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [264] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [264] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [264] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[8] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [8] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [8] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [8] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [8] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [8] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[254] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [254] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [254] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [254] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [254] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [254] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[255] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [255] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [255] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [255] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [255] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [255] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[3] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [3] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [3] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [3] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [3] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [3] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[4] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [4] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [4] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [4] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [4] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [4] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[5] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [5] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [5] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [5] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [5] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [5] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[6] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [6] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [6] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [6] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [6] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [6] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[82] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [82] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [82] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [82] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [82] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [82] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[7] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [7] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [7] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [7] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [7] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [7] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[267] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [267] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [267] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [267] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [267] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [267] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[268] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [268] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [268] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [268] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [268] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [268] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[10] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [10] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [10] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [10] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [10] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [10] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[11] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [11] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [11] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [11] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [11] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [11] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[12] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [12] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [12] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [12] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [12] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [12] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[13] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [13] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [13] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [13] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [13] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [13] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[14] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [14] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [14] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [14] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [14] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [14] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			[15] = CASE WHEN SEGMENT_MINUTES = 60 OR (SMinute <> 0 AND EMinute <> 0) THEN [15] * SEGMENT_MINUTES * TOT_DAYS
					WHEN SMinute = 0 THEN [15] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [15] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID - 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					ELSE [15] * SEGMENT_MINUTES * TOT_DAYS * .9 +
						(SELECT [15] * SEGMENT_MINUTES * TOT_DAYS * .1 FROM dbo.[advtf_nielsen_radio_audience_aqh_daypart](@LISTENING_LOCATION, @STATION_COMBO_TYPE, NIELSEN_DAYPART_ID + 1, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID))
					END,
			NIELSEN_RADIO_STATION_COMBO_ID,
			NIELSEN_RADIO_SEGMENT_PARENT_ID,
			ID,
			TOT_DAYS,
			SEGMENT_MINUTES 
		FROM (
			SELECT
				[251] = a.[MALES_6TO11_AQH],
				[42] = MALES_12TO17_AQH + MALES_18TO20_AQH + MALES_18TO24_AQH + MALES_21TO24_AQH + MALES_25TO34_AQH + MALES_35TO44_AQH + MALES_35TO49_AQH + MALES_45TO49_AQH + MALES_50TO54_AQH + MALES_55TO64_AQH + MALES_65PLUS_AQH + 
						FEMALES_12TO17_AQH + FEMALES_18TO20_AQH + FEMALES_18TO24_AQH + FEMALES_21TO24_AQH + FEMALES_25TO34_AQH + FEMALES_35TO44_AQH + FEMALES_35TO49_AQH + FEMALES_45TO49_AQH + FEMALES_50TO54_AQH + FEMALES_55TO64_AQH + FEMALES_65PLUS_AQH,
				[1] = a.[MALES_12TO17_AQH],
				[264] = a.[FEMALES_6TO11_AQH],
				[8] = a.[FEMALES_12TO17_AQH],
				[254] = a.[MALES_18TO20_AQH],
				[255] = a.[MALES_21TO24_AQH],
				[3] = a.[MALES_25TO34_AQH],
				[4] = a.[MALES_35TO44_AQH],
				[5] = a.[MALES_45TO49_AQH],
				[6] = a.[MALES_50TO54_AQH],
				[82] = a.[MALES_55TO64_AQH],
				[7] = a.[MALES_65PLUS_AQH],
				[267] = a.[FEMALES_18TO20_AQH],
				[268] = a.[FEMALES_21TO24_AQH],
				[10] = a.[FEMALES_25TO34_AQH],
				[11] = a.[FEMALES_35TO44_AQH],
				[12] = a.[FEMALES_45TO49_AQH],
				[13] = a.[FEMALES_50TO54_AQH],
				[14] = a.[FEMALES_55TO64_AQH],
				[15] = a.[FEMALES_65PLUS_AQH],
				c.NIELSEN_RADIO_STATION_COMBO_ID,
				TOT_DAYS = TOT_DAYS,
				SEGMENT_MINUTES = (CASE WHEN MRDT.EndMinutes = MRDT.StartMinutes THEN 15 ELSE CASE WHEN MRDT.EndMinutes < dp.END_MINUTE THEN MRDT.EndMinutes ELSE dp.END_MINUTE END - CASE WHEN MRDT.StartMinutes > dp.START_MINUTE THEN MRDT.StartMinutes ELSE dp.START_MINUTE END END),
				a.NIELSEN_RADIO_SEGMENT_PARENT_ID,
				MRDT.ID,
				MRDT.SMinute,
				MRDT.EMinute,
				dp.NIELSEN_DAYPART_ID 

				--, dp.*
			FROM dbo.NIELSEN_RADIO_AUDIENCE a
				INNER JOIN dbo.NIELSEN_RADIO_SEGMENT_CHILD c ON a.NIELSEN_RADIO_SEGMENT_CHILD_ID = c.NIELSEN_RADIO_SEGMENT_CHILD_ID
															AND c.LISTENING_LOCATION = @LISTENING_LOCATION
															AND c.STATION_COMBO_TYPE = @STATION_COMBO_TYPE
				INNER JOIN dbo.NIELSEN_RADIO_DAYPART dp ON c.NIELSEN_RADIO_DAYPART_ID = dp.NIELSEN_RADIO_DAYPART_ID AND dp.AQH = 1 AND dp.USE_SEGMENT = 1
				INNER JOIN (SELECT 
								ID,
								StartHour,
								EndHour, 
								Sunday,
								TOT_DAYS = 1,
								[StartMinutes] = SUBSTRING(RIGHT('0000' + CAST(StartHour as varchar), 4),1,2) * 60 + SUBSTRING(RIGHT('0000' + CAST(StartHour as varchar), 4),3,2),
								[EndMinutes] = SUBSTRING(RIGHT('0000' + CAST(EndHour as varchar), 4),1,2) * 60 + SUBSTRING(RIGHT('0000' + CAST(EndHour as varchar), 4),3,2),
								SMinute = CAST(RIGHT(StartHour, 2) as int),
								EMinute = CAST(RIGHT(EndHour, 2) as int)
							FROM 
								@LOCAL_MEDIA_SPOT_TV_RESEARCH_DAYTIME_TYPE
							WHERE Sunday = 1
							AND ID NOT IN (SELECT ID FROM @tt)) MRDT ON MRDT.ID > 0
			WHERE NIELSEN_RADIO_SEGMENT_PARENT_ID IN (SELECT items FROM dbo.udf_split_list(@NIELSEN_RADIO_SEGMENT_PARENT_IDs, ','))
			AND
				(
					(
						(dp.MIL_START_TIME BETWEEN MRDT.StartHour AND MRDT.EndHour AND dp.MIL_START_TIME <> MRDT.EndHour)
					OR
						(dp.MIL_END_TIME BETWEEN MRDT.StartHour AND MRDT.EndHour AND dp.MIL_END_TIME <> MRDT.StartHour)
					OR
						(MRDT.StartHour >= dp.MIL_START_TIME AND MRDT.EndHour <= dp.MIL_END_TIME)
					)
				AND MRDT.Sunday = 1 AND dp.SUNDAY = 1
				AND dp.SATURDAY = 0 AND dp.MONDAY = 0 AND dp.TUESDAY = 0 AND dp.WEDNESDAY = 0 AND dp.THURSDAY = 0 AND dp.FRIDAY = 0
				)
			) sun

	INSERT INTO @RETURN_TABLE
	SELECT
		u.NIELSEN_DEMO_CODE, u.AQH, mdd.MediaDemographicID, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID, [ID]
	FROM (
		SELECT 
			[251] = SUM([251]),
			[42] = SUM([42]),
			[1] = SUM([1]),
			[264] = SUM([264]),
			[8] = SUM([8]),
			[254] = SUM([254]),
			[255] = SUM([255]),
			[3] = SUM([3]),
			[4] = SUM([4]),
			[5] = SUM([5]),
			[6] = SUM([6]),
			[82] = SUM([82]),
			[7] = SUM([7]),
			[267] = SUM([267]),
			[268] = SUM([268]),
			[10] = SUM([10]),
			[11] = SUM([11]),
			[12] = SUM([12]),
			[13] = SUM([13]),
			[14] = SUM([14]),
			[15] = SUM([15]),
			NIELSEN_RADIO_STATION_COMBO_ID,
			NIELSEN_RADIO_SEGMENT_PARENT_ID,
			[ID]
		FROM 
		(
			SELECT 
					[251],
					[42],
					[1],
					[264],
					[8],
					[254],
					[255],
					[3],
					[4],
					[5],
					[6],
					[82],
					[7],
					[267],
					[268],
					[10],
					[11],
					[12],
					[13],
					[14],
					[15],
					NIELSEN_RADIO_STATION_COMBO_ID,
					NIELSEN_RADIO_SEGMENT_PARENT_ID,
					ID
				FROM
					@tt
		) rawdata
		GROUP BY NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID, ID
	) AUDDATA
	UNPIVOT
	(
		AQH
		FOR NIELSEN_DEMO_CODE in ([251], [42], [1], [264], [8], [254], [255], [3], [4], [5], [6], [82], [7], [267], [268], [10], [11], [12], [13], [14], [15]) 
	) u
		INNER JOIN dbo.NIELSEN_DEMO nd ON u.NIELSEN_DEMO_CODE = nd.CODE
		INNER JOIN @MEDIA_DEMO_DETAIL_TYPE mdd ON nd.NIELSEN_DEMO_ID = mdd.NielsenDemographicID  
	WHERE mdd.MediaDemographicID IN (SELECT items FROM dbo.udf_split_list(@SelectedMediaDemographicIDs, ','))

	
	INSERT INTO @RETURN_TABLE
	SELECT
		u.NIELSEN_DEMO_CODE, u.AQH, mdd.MediaDemographicID, NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID, [ID]
	FROM (
		SELECT 
			[251] = SUM([251]) / SUM(SEGMENT_MINUTES * TOT_DAYS),
			[42] = SUM([42]) / SUM(SEGMENT_MINUTES * TOT_DAYS),
			[1] = SUM([1]) / SUM(SEGMENT_MINUTES * TOT_DAYS),
			[264] = SUM([264]) / SUM(SEGMENT_MINUTES * TOT_DAYS),
			[8] = SUM([8]) / SUM(SEGMENT_MINUTES * TOT_DAYS),
			[254] = SUM([254]) / SUM(SEGMENT_MINUTES * TOT_DAYS),
			[255] = SUM([255]) / SUM(SEGMENT_MINUTES * TOT_DAYS),
			[3] = SUM([3]) / SUM(SEGMENT_MINUTES * TOT_DAYS),
			[4] = SUM([4]) / SUM(SEGMENT_MINUTES * TOT_DAYS),
			[5] = SUM([5]) / SUM(SEGMENT_MINUTES * TOT_DAYS),
			[6] = SUM([6]) / SUM(SEGMENT_MINUTES * TOT_DAYS),
			[82] = SUM([82]) / SUM(SEGMENT_MINUTES * TOT_DAYS),
			[7] = SUM([7]) / SUM(SEGMENT_MINUTES * TOT_DAYS),
			[267] = SUM([267]) / SUM(SEGMENT_MINUTES * TOT_DAYS),
			[268] = SUM([268]) / SUM(SEGMENT_MINUTES * TOT_DAYS),
			[10] = SUM([10]) / SUM(SEGMENT_MINUTES * TOT_DAYS),
			[11] = SUM([11]) / SUM(SEGMENT_MINUTES * TOT_DAYS),
			[12] = SUM([12]) / SUM(SEGMENT_MINUTES * TOT_DAYS),
			[13] = SUM([13]) / SUM(SEGMENT_MINUTES * TOT_DAYS),
			[14] = SUM([14]) / SUM(SEGMENT_MINUTES * TOT_DAYS),
			[15] = SUM([15]) / SUM(SEGMENT_MINUTES * TOT_DAYS),
			NIELSEN_RADIO_STATION_COMBO_ID,
			NIELSEN_RADIO_SEGMENT_PARENT_ID,
			[ID]
		FROM 
		(
			SELECT 
					[251],
					[42],
					[1],
					[264],
					[8],
					[254],
					[255],
					[3],
					[4],
					[5],
					[6],
					[82],
					[7],
					[267],
					[268],
					[10],
					[11],
					[12],
					[13],
					[14],
					[15],
					NIELSEN_RADIO_STATION_COMBO_ID,
					TOT_DAYS,
					SEGMENT_MINUTES,
					NIELSEN_RADIO_SEGMENT_PARENT_ID,
					ID
				FROM
					@tt2
		) rawdata
		GROUP BY NIELSEN_RADIO_STATION_COMBO_ID, NIELSEN_RADIO_SEGMENT_PARENT_ID, ID
	) AUDDATA
	UNPIVOT
	(
		AQH
		FOR NIELSEN_DEMO_CODE in ([251], [42], [1], [264], [8], [254], [255], [3], [4], [5], [6], [82], [7], [267], [268], [10], [11], [12], [13], [14], [15]) 
	) u
		INNER JOIN dbo.NIELSEN_DEMO nd ON u.NIELSEN_DEMO_CODE = nd.CODE
		INNER JOIN @MEDIA_DEMO_DETAIL_TYPE mdd ON nd.NIELSEN_DEMO_ID = mdd.NielsenDemographicID  
	WHERE mdd.MediaDemographicID IN (SELECT items FROM dbo.udf_split_list(@SelectedMediaDemographicIDs, ','))

	RETURN
END
GO

GRANT SELECT ON [advtf_nielsen_radio_audience_get_aqh] TO PUBLIC
GO
