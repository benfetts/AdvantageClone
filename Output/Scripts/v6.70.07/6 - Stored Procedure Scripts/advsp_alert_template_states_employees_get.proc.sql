IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[advsp_alert_template_states_employees_get]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[advsp_alert_template_states_employees_get]
GO
CREATE PROCEDURE [dbo].[advsp_alert_template_states_employees_get]
@ALERT_ID INT,
@ALRT_NOTIFY_HDR_ID INT,
@ALERT_STATE_ID INT,
@SHOW_ALL BIT,
@INCLUDE_EMP VARCHAR(6),
@CS_ONLY BIT
AS
BEGIN
	DECLARE @RESULTS TABLE (
		ID INT IDENTITY,
		EMP_CODE VARCHAR(25)  NULL,
		EMP_FML VARCHAR(255) NULL,
		EMP_EMAIL VARCHAR(255) NULL,
		IS_DEFAULT BIT NULL,
		SELECTED BIT NULL,
		COMPLETED BIT NULL
	);
	IF NOT @ALERT_ID IS NULL AND @ALERT_ID > 0
	BEGIN
		SELECT
			@ALRT_NOTIFY_HDR_ID = A.ALRT_NOTIFY_HDR_ID,
			@ALERT_STATE_ID = A.ALERT_STATE_ID
		FROM
			ALERT A WITH(NOLOCK)
		WHERE
			A.ALERT_ID = @ALERT_ID;
	END
	INSERT INTO @RESULTS (EMP_CODE, EMP_FML, EMP_EMAIL, IS_DEFAULT)
	EXEC dbo.[usp_wv_ALERT_NOTIFY_EMPS_BY_STID] @ALERT_STATE_ID, 0, 0, @ALRT_NOTIFY_HDR_ID, '', @SHOW_ALL, 0, 0;
	IF ISNULL(@INCLUDE_EMP, '') <> ''
	BEGIN
		IF NOT EXISTS (SELECT 1 FROM @RESULTS WHERE UPPER(EMP_CODE) = UPPER(@INCLUDE_EMP))
		BEGIN
			INSERT INTO @RESULTS (EMP_CODE, EMP_FML, EMP_EMAIL)
				SELECT 
					EMP_CODE, 
					EMP_FNAME + ISNULL(' ' + EMP_MI + '. ', ' ') + EMP_LNAME, 
					EMP_EMAIL 
				FROM 
					EMPLOYEE
				WHERE 
					UPPER(EMP_CODE) = UPPER(@INCLUDE_EMP);				
		END
	END
	IF NOT @ALERT_ID IS NULL AND @ALERT_ID > 0
	BEGIN
		UPDATE @RESULTS	SET SELECTED = 1
		FROM
			@RESULTS R
			INNER JOIN ALERT_RCPT AR WITH(NOLOCK) ON R.EMP_CODE = AR.EMP_CODE
			INNER JOIN EMPLOYEE E WITH(NOLOCK) ON R.EMP_CODE = R.EMP_CODE
			INNER JOIN ALERT A WITH(NOLOCK) ON A.ALERT_ID = AR.ALERT_ID AND A.ALRT_NOTIFY_HDR_ID = AR.ALRT_NOTIFY_HDR_ID AND A.ALERT_STATE_ID = AR.ALERT_STATE_ID
		WHERE
			AR.ALERT_ID = @ALERT_ID
			AND NOT E.CS_USERID IS NULL
			AND AR.CURRENT_NOTIFY = 1;
		UPDATE @RESULTS	SET COMPLETED = 1
		FROM
			@RESULTS R
			INNER JOIN ALERT_RCPT_DISMISSED AR WITH(NOLOCK) ON R.EMP_CODE = AR.EMP_CODE
			INNER JOIN EMPLOYEE E WITH(NOLOCK) ON R.EMP_CODE = R.EMP_CODE
			INNER JOIN ALERT A WITH(NOLOCK) ON A.ALERT_ID = AR.ALERT_ID AND A.ALRT_NOTIFY_HDR_ID = AR.ALRT_NOTIFY_HDR_ID AND A.ALERT_STATE_ID = AR.ALERT_STATE_ID
		WHERE
			AR.ALERT_ID = @ALERT_ID
			AND NOT E.CS_USERID IS NULL
			AND AR.CURRENT_NOTIFY = 1;
	END
	IF @CS_ONLY IS NULL OR @CS_ONLY = 0
	BEGIN
		SELECT 
			[Code] = R.EMP_CODE,
			[Name] = R.EMP_FML,
			[IsDefault] = CONVERT(BIT, ISNULL(R.IS_DEFAULT, 0)),
			[IsSelected] = CONVERT(BIT, ISNULL(R.SELECTED, 0)),
			[IsCompleted] = CONVERT(BIT, ISNULL(R.COMPLETED, 0))
		FROM 
			@RESULTS R
		ORDER BY
			R.EMP_FML;		
	END
	ELSE
	BEGIN
		SELECT 
			[Code] = R.EMP_CODE,
			[Name] = R.EMP_FML,
			[IsDefault] = CONVERT(BIT, ISNULL(R.IS_DEFAULT, 0)),
			[IsSelected] = CONVERT(BIT, ISNULL(R.SELECTED, 0)),
			[IsCompleted] = CONVERT(BIT, ISNULL(R.COMPLETED, 0))
		FROM 
			@RESULTS R
			INNER JOIN EMPLOYEE E ON R.EMP_CODE = E.EMP_CODE
		WHERE
			NOT E.CS_USERID IS NULL
		ORDER BY
			R.EMP_FML;		
	END
END

GO