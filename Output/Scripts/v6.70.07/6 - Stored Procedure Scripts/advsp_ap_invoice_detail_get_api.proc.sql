IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[advsp_ap_invoice_detail_get_api]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[advsp_ap_invoice_detail_get_api]
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[advsp_ap_invoice_detail_get_api] 
	@ap_id varchar(10),	/* AP_ID */
	@ret_val integer OUTPUT, @ret_val_s varchar(max) OUTPUT

AS

DECLARE @ap_dtl TABLE (
	[AP_ID] [int] NOT NULL,
	[VN_FRL_EMP_CODE] [varchar](6) NOT NULL,
	[VN_NAME] [varchar](40) NULL,
	[AP_INV_VCHR] [varchar](20) NOT NULL,
	[AP_DESC] [varchar](300) NULL,
	[AP_INV_DATE] [smalldatetime] NOT NULL,
	[MEDIA_TYPE] [varchar](1) NOT NULL,
	[DISBURSED_AMT] [decimal](14, 2) NULL,
	[CL_CODE] [varchar](6) NULL,
	[CL_NAME] [varchar](40) NULL,
	[JOB_NUMBER] [int],
	[JOB_COMPONENT_NBR] [smallint],
	[FNC_CODE] [varchar](6),
	[GLACODE] [varchar](30)
)

DECLARE @ErMessage nvarchar(2048), @ErSeverity int, @ErState int
DECLARE @error_msg_w varchar(200)

DECLARE
	@DEBUG int

DECLARE
	@found int = 0,
	@use_dates bit = 1

BEGIN TRY

SET NOCOUNT ON

SET @ret_val = 0
SET @ret_val_s = 'Success...'

IF @error_msg_w > ''
	GOTO ERROR_MSG

SET @found = 0

INSERT INTO @ap_dtl
SELECT A.AP_ID,
		A.VN_FRL_EMP_CODE, 
		V.VN_NAME,
		A.AP_INV_VCHR,
		A.AP_DESC,
		A.AP_INV_DATE,
		'N',
		DISBURSED_AMT,
		H.CL_CODE,
		C.CL_NAME,
		L.JOB_NUMBER,
		L.JOB_COMPONENT_NBR,
		FNC_CODE = NULL,
		D.GLACODE
FROM AP_HEADER A
	JOIN VENDOR V ON A.VN_FRL_EMP_CODE = V.VN_CODE
	JOIN AP_NEWSPAPER D ON A.AP_ID = D.AP_ID
	JOIN NEWSPAPER_HEADER H ON D.ORDER_NBR = H.ORDER_NBR
	JOIN NEWSPAPER_DETAIL L ON D.ORDER_NBR = L.ORDER_NBR AND D.ORDER_LINE_NBR = L.LINE_NBR AND L.ACTIVE_REV = 1
	JOIN CLIENT C ON H.CL_CODE = C.CL_CODE
WHERE (A.AP_ID = @ap_id)

INSERT INTO @ap_dtl
SELECT A.AP_ID,
		A.VN_FRL_EMP_CODE, 
		V.VN_NAME,
		A.AP_INV_VCHR,
		A.AP_DESC,
		A.AP_INV_DATE,
		'M',
		DISBURSED_AMT,
		H.CL_CODE,
		C.CL_NAME,
		L.JOB_NUMBER,
		L.JOB_COMPONENT_NBR,
		FNC_CODE = NULL,
		D.GLACODE
FROM AP_HEADER A
	JOIN VENDOR V ON A.VN_FRL_EMP_CODE = V.VN_CODE
	JOIN AP_MAGAZINE D ON A.AP_ID = D.AP_ID
	JOIN MAGAZINE_HEADER H ON D.ORDER_NBR = H.ORDER_NBR
	JOIN MAGAZINE_DETAIL L ON D.ORDER_NBR = L.ORDER_NBR AND D.ORDER_LINE_NBR = L.LINE_NBR AND L.ACTIVE_REV = 1
	JOIN CLIENT C ON H.CL_CODE = C.CL_CODE
WHERE (A.AP_ID = @ap_id)

INSERT INTO @ap_dtl
SELECT A.AP_ID,
		A.VN_FRL_EMP_CODE, 
		V.VN_NAME,
		A.AP_INV_VCHR,
		A.AP_DESC,
		A.AP_INV_DATE,
		'I',
		(NET_AMT + VENDOR_TAX) DISBURSED_AMT,
		H.CL_CODE,
		C.CL_NAME,
		L.JOB_NUMBER,
		L.JOB_COMPONENT_NBR,
		FNC_CODE = NULL,
		D.GLACODE
FROM AP_HEADER A
	JOIN VENDOR V ON A.VN_FRL_EMP_CODE = V.VN_CODE
	JOIN AP_INTERNET D ON A.AP_ID = D.AP_ID
	JOIN INTERNET_HEADER H ON D.ORDER_NBR = H.ORDER_NBR
	JOIN INTERNET_DETAIL L ON D.ORDER_NBR = L.ORDER_NBR AND D.ORDER_LINE_NBR = L.LINE_NBR AND L.ACTIVE_REV = 1
	JOIN CLIENT C ON H.CL_CODE = C.CL_CODE
WHERE (A.AP_ID = @ap_id)

INSERT INTO @ap_dtl
SELECT A.AP_ID,
		A.VN_FRL_EMP_CODE, 
		V.VN_NAME,
		A.AP_INV_VCHR,
		A.AP_DESC,
		A.AP_INV_DATE,
		'O',
		(NET_AMT + VENDOR_TAX) DISBURSED_AMT,
		H.CL_CODE,
		C.CL_NAME,
		L.JOB_NUMBER,
		L.JOB_COMPONENT_NBR,
		FNC_CODE = NULL,
		D.GLACODE
FROM AP_HEADER A
	JOIN VENDOR V ON A.VN_FRL_EMP_CODE = V.VN_CODE
	JOIN AP_OUTDOOR D ON A.AP_ID = D.AP_ID
	JOIN OUTDOOR_HEADER H ON D.ORDER_NBR = H.ORDER_NBR
	JOIN OUTDOOR_DETAIL L ON D.ORDER_NBR = L.ORDER_NBR AND D.ORDER_LINE_NBR = L.LINE_NBR AND L.ACTIVE_REV = 1
	JOIN CLIENT C ON H.CL_CODE = C.CL_CODE
WHERE (A.AP_ID = @ap_id)

INSERT INTO @ap_dtl
SELECT A.AP_ID,
		A.VN_FRL_EMP_CODE, 
		V.VN_NAME,
		A.AP_INV_VCHR,
		A.AP_DESC,
		A.AP_INV_DATE,
		'R',
		(D.EXT_NET_AMT + D.VENDOR_TAX) DISBURSED_AMT,
		H.CL_CODE,
		C.CL_NAME,
		L.JOB_NUMBER,
		L.JOB_COMPONENT_NBR,
		FNC_CODE = NULL,
		D.GLACODE
FROM AP_HEADER A
	JOIN VENDOR V ON A.VN_FRL_EMP_CODE = V.VN_CODE
	JOIN AP_RADIO D ON A.AP_ID = D.AP_ID
	JOIN RADIO_HDR H ON D.ORDER_NBR = H.ORDER_NBR
	JOIN RADIO_DETAIL L ON D.ORDER_NBR = L.ORDER_NBR AND D.ORDER_LINE_NBR = L.LINE_NBR AND L.ACTIVE_REV = 1
	JOIN CLIENT C ON H.CL_CODE = C.CL_CODE
WHERE (A.AP_ID = @ap_id)

INSERT INTO @ap_dtl
SELECT A.AP_ID,
		A.VN_FRL_EMP_CODE, 
		V.VN_NAME,
		A.AP_INV_VCHR,
		A.AP_DESC,
		A.AP_INV_DATE,
		'T',
		(D.EXT_NET_AMT + D.VENDOR_TAX) DISBURSED_AMT,
		H.CL_CODE,
		C.CL_NAME,
		L.JOB_NUMBER,
		L.JOB_COMPONENT_NBR,
		FNC_CODE = NULL,
		D.GLACODE
FROM AP_HEADER A
	JOIN VENDOR V ON A.VN_FRL_EMP_CODE = V.VN_CODE
	JOIN AP_TV D ON A.AP_ID = D.AP_ID
	JOIN TV_HDR H ON D.ORDER_NBR = H.ORDER_NBR
	JOIN TV_DETAIL L ON D.ORDER_NBR = L.ORDER_NBR AND D.ORDER_LINE_NBR = L.LINE_NBR AND L.ACTIVE_REV = 1
	JOIN CLIENT C ON H.CL_CODE = C.CL_CODE
WHERE (A.AP_ID = @ap_id)

INSERT INTO @ap_dtl
SELECT A.AP_ID,
		A.VN_FRL_EMP_CODE, 
		V.VN_NAME,
		A.AP_INV_VCHR,
		A.AP_DESC,
		A.AP_INV_DATE,
		'P',
		(EXT_NONRESALE_TAX + AP_PROD_EXT_AMT) DISBURSED_AMT,
		H.CL_CODE,
		C.CL_NAME,
		D.JOB_NUMBER,
		D.JOB_COMPONENT_NBR,
		D.FNC_CODE,
		D.GLACODE
FROM AP_HEADER A
	JOIN VENDOR V ON A.VN_FRL_EMP_CODE = V.VN_CODE
	JOIN AP_PRODUCTION D ON A.AP_ID = D.AP_ID
	JOIN JOB_LOG H ON D.JOB_NUMBER = H.JOB_NUMBER
	JOIN CLIENT C ON H.CL_CODE = C.CL_CODE
WHERE (A.AP_ID = @ap_id)

INSERT INTO @ap_dtl
SELECT A.AP_ID,
		A.VN_FRL_EMP_CODE, 
		V.VN_NAME,
		A.AP_INV_VCHR,
		A.AP_DESC,
		A.AP_INV_DATE,
		'G',
		(AP_GL_AMT) DISBURSED_AMT,
		CL_CODE = NULL,
		CL_NAME = NULL,
		JOB_NUMBER = NULL,
		JOB_COMPONENT_NBR = NULL,
		FNC_CODE = NULL,
		D.GLACODE
FROM AP_HEADER A
	JOIN VENDOR V ON A.VN_FRL_EMP_CODE = V.VN_CODE
	JOIN AP_GL_DIST D ON A.AP_ID = D.AP_ID
WHERE (A.AP_ID = @ap_id)

/****/ 

SELECT AP_ID [ID],
		VN_FRL_EMP_CODE VendorCode, 
		VN_NAME VendorName,
		AP_INV_VCHR InvoiceNumber,
		AP_DESC InvoiceDescription,
		AP_INV_DATE InvoiceDate,
		MEDIA_TYPE MediaType,
		SUM(DISBURSED_AMT) DisbursedAmount,
		CL_CODE ClientCode,
		CL_NAME ClientName,
		JOB_NUMBER JobNumber,
		JOB_COMPONENT_NBR JobComponentNumber,
		FNC_CODE FunctionCode,
		GLACODE GLAccountCode
FROM @ap_dtl
GROUP BY MEDIA_TYPE,
		AP_ID,
		VN_FRL_EMP_CODE, 
		VN_NAME,
		AP_INV_VCHR,
		AP_DESC,
		AP_INV_DATE,
		CL_CODE,
		CL_NAME,
		JOB_NUMBER,
		JOB_COMPONENT_NBR,
		FNC_CODE,
		GLACODE

GOTO ENDIT
  
           
/**************************** ERROR PROCESSING ************************************************************************/	
	ERROR_MSG:
		BEGIN
		
			RAISERROR (@error_msg_w,
			 16,
			 1 )    
			
		END

	ENDIT: --Do Nothing
	
END TRY

BEGIN CATCH
	   
	SELECT 	@ErMessage = ERROR_MESSAGE(),
					@ErSeverity = ERROR_SEVERITY(),
					@ErState = ERROR_STATE();

	IF @ErMessage IS NOT NULL BEGIN
		SET @ret_val = 1
		SET @ret_val_s = @ErMessage
	END

	INSERT INTO @ap_dtl
	SELECT 0,
			'', 
			'',
			'',
			@error_msg_w,
			'01-01-1900',
			'',
			0,
			'',
			'',
			'',
			'',
			'',
			''

	SELECT AP_ID ID,
		VN_FRL_EMP_CODE VendorCode, 
		VN_NAME VendorName,
		AP_INV_VCHR InvoiceNumber,
		AP_DESC InvoiceDescription,
		AP_INV_DATE InvoiceDate,
		MEDIA_TYPE MediaType,
		DISBURSED_AMT DisbursedAmount,
		CL_CODE ClientCode,
		CL_NAME ClientName,		
		JOB_NUMBER JobNumber,
		JOB_COMPONENT_NBR JobComponentNumber,
		FNC_CODE FunctionCode,
		GLACODE GLAccountCode 
	FROM @ap_dtl

END CATCH

RETURN

GO

GRANT EXECUTE ON [advsp_ap_invoice_detail_get_api] TO PUBLIC AS dbo
GO