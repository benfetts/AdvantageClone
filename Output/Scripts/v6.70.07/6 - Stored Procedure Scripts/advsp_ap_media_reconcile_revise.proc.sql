IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[advsp_ap_media_reconcile_revise]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[advsp_ap_media_reconcile_revise]
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[advsp_ap_media_reconcile_revise] 
	@media_type varchar(1), 
	@order_nbr int, 
	@line_nbr int,
	--@order_net decimal(14,4),
	--@order_qty decimal(14,4),
	--@ap_net decimal(14,4),
	--@ap_qty decimal(14,4),
	@modified_comments varchar(254),
	@reconcile_by varchar(6), 
	@reconcile_method varchar(6), 
	@year varchar(4), 
	@month varchar(2), 
	@roll_forward_month int, 
	@user_code varchar(100),
	@ret_value varchar(254) OUTPUT

--DECLARE
--	@media_type varchar(1), 
--	@order_nbr int, 
--	@line_nbr int,
--	@modified_comments varchar(254),
--	@reconcile_by varchar(6), 
--	@reconcile_method varchar(6), 
--	@year varchar(4), 
--	@month varchar(2), 
--	@roll_forward_month int, 
--	@user_code varchar(100),
--	@ret_value varchar(254) 

AS

--SELECT @media_type = 'T',
--		@order_nbr = 1252,
--		@line_nbr = 1,
--		@modified_comments = 'PJH',
--		@reconcile_by = 'L',
--		@reconcile_method = '',
--		@year = '2020',
--		@month = '8',
--		@roll_forward_month = NULL,
--		@user_code = 'SYSADM',
--		@ret_value = ''

/*
PJH 09/15/2014 - created SP
PJH 06/08/2015 - changed @dec_AP_NET_AMT to @dec_LINE_TOTAL
PJH 06/08/2015 - removed @dec_COMM_AMT + @dec_REBATE_AMT - not sure how they go there for NET
PJH 03/22/2016 - added "AND D.BILL_TYPE_FLAG <> 1"
PJH 06/12/2020 - ROUND from 14,8 to 14,4
PJH 06/29/2020 - Allow line level reconcile of all media types
PJH 04/23/21 - Chg AD.NET_RATE to AD.NET_AMT & Chg AD.GROSS_RATE to (AD.NET_AMT + AD.COMM_AMT)
*/

DECLARE @invoice_number int, @post_period_code varchar(6), @vo_comment varchar(254)

DECLARE 	@dec_NET_RATE decimal(14,4),
				@dec_GROSS_RATE decimal(14,4),
				@dec_NETCHARGES decimal(14,4),
				@dec_NET_AMT decimal(14,4),
				@dec_COMM_AMT decimal(14,4),
				@dec_VENDOR_TAX decimal(14,4),
				--@dec_VENDOR_TAX decimal(14,4),
				@dec_STATE_TAX decimal(14,4),
				@dec_COUNTY_TAX decimal(14,4),
				@dec_CITY_TAX decimal(14,4),
				@dec_LINE_TOTAL decimal(14,4),
				@dec_REBATE_AMT decimal(14,4),
				@dec_DISCOUNT_AMT decimal(14,4),
				@dec_IMPRESSIONS decimal(14,4)

/*
-PJH 08/27/13 - Added Reverse QUANTITY's for INTERNET, NEWSPAPER, MAGAZINE, OUTDOOR
-PJH 01/28/14 - Changed Max(Seq_Nbr) by AB_ID vs MAX(AB_ID)
*/

DECLARE @order_nbr_prev int,
		@line_nbr_prev smallint,
		@rev_nbr_prev smallint,
		@rev_nbr_max smallint

DECLARE @RADIO_DETAIL_TABLE TABLE (
	[RowID] [int] IDENTITY(1,1), 
	ORDER_NBR int,
	LINE_NBR smallint,
	REV_NBR smallint,
	SEQ_NBR smallint,
	NET_GROSS smallint
)

DECLARE @TV_DETAIL_TABLE TABLE (
	[RowID] [int] IDENTITY(1,1), 
	ORDER_NBR int,
	LINE_NBR smallint,
	REV_NBR smallint,
	SEQ_NBR smallint,
	NET_GROSS smallint
)

DECLARE @INTERNET_DETAIL_TABLE TABLE (
	[RowID] [int] IDENTITY(1,1), 
	ORDER_NBR int,
	LINE_NBR smallint,
	REV_NBR smallint,
	SEQ_NBR smallint,
	NET_GROSS smallint
)

DECLARE @NEWSPAPER_DETAIL_TABLE TABLE (
	[RowID] [int] IDENTITY(1,1), 
	ORDER_NBR int,
	LINE_NBR smallint,
	REV_NBR smallint,
	SEQ_NBR smallint,
	NET_GROSS smallint
)

DECLARE @MAGAZINE_DETAIL_TABLE TABLE (
	[RowID] [int] IDENTITY(1,1), 
	ORDER_NBR int,
	LINE_NBR smallint,
	REV_NBR smallint,
	SEQ_NBR smallint,
	NET_GROSS smallint
)

DECLARE @OUTDOOR_DETAIL_TABLE TABLE (
	[RowID] [int] IDENTITY(1,1), 
	ORDER_NBR int,
	LINE_NBR smallint,
	REV_NBR smallint,
	SEQ_NBR smallint,
	NET_GROSS smallint
)

DECLARE @ROW_COUNT AS integer
DECLARE @ROW_ID AS integer
DECLARE @COST_TYPE varchar(30)
DECLARE @rev_nbr smallint, @seq_nbr smallint --@order_nbr smallint, @line_nbr smallint, 
DECLARE @CURRENT_DATE smalldatetime

	--IF EXISTS (SELECT AR_INV_NBR FROM dbo.ACCT_REC WHERE AR_INV_NBR = @invoice_number AND VOID_FLAG = 1)
	--BEGIN

BEGIN TRY

	BEGIN TRAN
		
		DECLARE @dec_GROSS_AMT decimal(14,4), @dec_NEW_RATE_AMT decimal(14,4), @dec_COST_RATE decimal(14,4)
		DECLARE @dec_NET_BASE_RATE decimal(14,8), @dec_GROSS_BASE_RATE decimal(14,8)
		DECLARE @dec_NEW_NET_RATE decimal(14,8), @dec_NEW_GROSS_RATE decimal(14,8)
		DECLARE @dec_ACTUAL_IMPRESSIONS decimal(14,4), @dec_GUARANTEED_IMPRESSIONS decimal(14,4)
		DECLARE @dec_RECONCILE_RATE decimal(14,8), @dec_TEMP_RATE decimal(18,8), @dec_AP_BILLING_AMT decimal(14,4)
		DECLARE @dec_AP_NET_AMT decimal(14,4), @dec_AP_BILL_AMT decimal(14,4), @dec_ADDL_CHARGE decimal(14,4)
		DECLARE @dec_AP_PRINT_LINES decimal(14,4), @dec_CONTRACT_QTY decimal(14,4)
		DECLARE @dec_AP_PRINT_COLUMNS decimal(14,4), @dec_AP_PRINT_INCHES decimal(14,4)
		DECLARE @dec_DISCOUNT_AMT_ABS decimal(14,4), @dec_temp decimal(14,4), @dec_tmp_ADDL_CHARGE decimal(14,4)
		DECLARE @dec_PROD_CHARGE decimal(14,4)
		DECLARE @dec_COLOR_NET decimal(14,4)
		DECLARE @dec_BLEED_NET decimal(14,4)
		DECLARE @dec_POSITION_NET decimal(14,4)
		DECLARE @dec_PREMIUM_NET decimal(14,4)
		DECLARE @dec_COLOR_GROSS decimal(14,4)
		DECLARE @dec_BLEED_GROSS decimal(14,4)
		DECLARE @dec_POSITION_GROSS decimal(14,4)
		DECLARE @dec_PREMIUM_GROSS decimal(14,4)
		DECLARE @AP_TAX_CODE varchar(4)
		
		/** Order Variables for calcualting difference between Order & AP **/
		DECLARE @dec_O_EXT_NET_AMT decimal(14,4), 
					@dec_O_COMM_AMT decimal(14,4), 
					@dec_O_NET_RATE decimal(14,4), 
					@dec_O_GROSS_RATE decimal(14,4), 
					@dec_O_ADDL_CHARGE decimal(14,4),
					@dec_O_REBATE_AMT decimal(14,4),
					@dec_O_BILLING_AMT decimal(14,4),
					@dec_O_NETCHARGE decimal(14,4),
					@dec_O_NON_RESALE_AMT decimal(14,4),
					@dec_O_DISCOUNT_AMT decimal(14,4), 
					@dec_O_PROD_CHARGE  decimal(14,4), 
					@dec_O_COLOR_CHARGE  decimal(14,4), 
					@dec_ORDER_QTY decimal(14,4), 
					@dt_O_START_DATE smalldatetime, @dt_O_END_DATE smalldatetime, @dt_O_CLOSE_DATE smalldatetime, @dt_O_M_CLOSE_DATE smalldatetime		
					
		DECLARE @DIFFERENCE_LINE smallint
		
		DECLARE @NET_GROSS smallint, @CPM smallint, @MAX_LINE_NBR smallint, @BILL_TYPE smallint, @NON_BILL_FLAG smallint
		
		DECLARE @CL_CODE varchar(6), @DIV_CODE varchar(6), @PRD_CODE varchar(6), @TAX_CODE varchar(4), @VN_CODE varchar(6)
		DECLARE @TAXAPPLYC smallint, @TAXAPPLYLN smallint, @TAXAPPLYLND smallint, @TAXAPPLYNC smallint, @TAXAPPLYR smallint, @TAXAPPLYAI smallint
		
		DECLARE @UNITS varchar(1), @QUANTITY int
		DECLARE @dec_COMM_PCT decimal(18,8), @dec_MARKUP_PCT decimal(18,8), @dec_REBATE_PCT decimal(18,8), @dec_DISCOUNT_PCT decimal(18,8)
		DECLARE @dec_STATE_PCT decimal(18,8), @dec_COUNTY_PCT decimal(18,8), @dec_CITY_PCT decimal(18,8), @TAX_RESALE int
		
		/** temp calc vars **/
		DECLARE @dec_COMM_PCT_tmp decimal(18,8), @dec_MARKUP_PCT_tmp decimal(18,8), @dec_REBATE_PCT_tmp decimal(18,8), @dec_DISCOUNT_PCT_tmp decimal(18,8) 
		DECLARE @dec_STATE_PCT_tmp decimal(18,8), @dec_COUNTY_PCT_tmp decimal(18,8), @dec_CITY_PCT_tmp decimal(18,8)
		DECLARE @dec_STATE_TAX_tmp decimal(18,8), @dec_COUNTY_TAX_tmp decimal(18,8), @dec_CITY_TAX_tmp decimal(18,8), @dec_VENDOR_TAX_tmp  decimal(18,8)
		DECLARE @dec_ADDL_CHARGE_tax decimal(18,8), @dec_RESALE_TAX_tmp decimal(18,8), @dec_SALES_TAX_tmp decimal(18,8)
		
		DECLARE @V_USE_TAX_FLAGS int, @V_DEF_SALES_TAX varchar(4)
		DECLARE @V_TAXAPPLYC int, @V_TAXAPPLYLN int, @V_TAXAPPLYND int, @V_TAXAPPLYNC int, @V_TAXAPPLYR int, @V_TAXAPPLYAI int
		DECLARE @V_MATL_CLOSE int, @V_SPACE_CLOSE int

		DECLARE @P_USE_TAX_FLAGS int, @P_DEF_SALES_TAX varchar(4), @PRD_MISC_BF_AF int, @PRD_MISC_DAYS int
		DECLARE @P_TAXAPPLYC int, @P_TAXAPPLYLN int, @P_TAXAPPLYND int, @P_TAXAPPLYNC int, @P_TAXAPPLYR int, @P_TAXAPPLYAI int

		DECLARE @roll_forward_month_s varchar(2), @roll_forward_year_s varchar(4)
		DECLARE @roll_forward_new_date varchar(10), @new_start_date_d smalldatetime, @new_end_date_d smalldatetime, @new_matl_close_date_d smalldatetime, @new_close_date_d smalldatetime
		DECLARE @roll_forward_year_n int, @new_date_to_bill smalldatetime
		
		SELECT @CURRENT_DATE = GETDATE()
		
		IF @modified_comments IS NULL OR @modified_comments = '' BEGIN
			SET @modified_comments = 'AP Reconcile'
		END
		
		SET @DIFFERENCE_LINE = 0
-------------------------------------------------		

		/* GET ORDER DATA */
		IF @reconcile_by = 'M' BEGIN	 /*** RECONCILE BY MONTH ***/
			IF @media_type = 'I' BEGIN
				SELECT @UNITS = MAX(H.UNITS), @QUANTITY = SUM(COALESCE(D.QUANTITY,0)), @dec_COMM_PCT = MAX(COALESCE(D.COMM_PCT,0)), @dec_MARKUP_PCT = MAX(COALESCE(D.MARKUP_PCT,0)),
								@dec_REBATE_PCT = MAX(COALESCE(D.REBATE_PCT,0)), @dec_DISCOUNT_PCT = MAX(COALESCE(D.DISCOUNT_PCT,0)),
								@BILL_TYPE = MAX(D.BILL_TYPE_FLAG), @COST_TYPE = MAX(D.COST_TYPE), @NET_GROSS = MAX(NET_GROSS), @TAX_CODE = MAX(TAX_CODE),
								@NON_BILL_FLAG = MAX(D.NON_BILL_FLAG), 
								@dec_O_NET_RATE = SUM(COALESCE((D.NET_RATE), 0)) ,  
								@dec_O_GROSS_RATE = SUM(COALESCE((D.GROSS_RATE), 0)) ,  
								@dec_O_ADDL_CHARGE = SUM(COALESCE((D.ADDL_CHARGE), 0)) ,  
								@dec_O_REBATE_AMT = SUM(COALESCE((D.REBATE_AMT), 0)) ,  
								@dec_O_EXT_NET_AMT = SUM(COALESCE(D.EXT_NET_AMT, 0)) ,
								@dec_O_COMM_AMT = SUM(COALESCE(D.COMM_AMT, 0)) ,
								@dec_O_BILLING_AMT = SUM(COALESCE(D.BILLING_AMT, 0)) ,
								@dec_O_NETCHARGE =	SUM(COALESCE(D.NETCHARGE, 0)) ,
								@dec_O_NON_RESALE_AMT = SUM(COALESCE(D.NON_RESALE_AMT, 0)) ,
								@dec_O_DISCOUNT_AMT = SUM(COALESCE(D.DISCOUNT_AMT, 0) ),
								@CL_CODE = MAX(H.CL_CODE), @DIV_CODE = MAX(H.DIV_CODE), @PRD_CODE = MAX(H.PRD_CODE), @VN_CODE = MAX(H.VN_CODE),
								--TAXAPPLYC, TAXAPPLYLN, TAXAPPLYND, TAXAPPLYNC, TAXAPPLYR, TAXAPPLYAI
								@TAX_RESALE = MAX(D.TAX_RESALE), @TAXAPPLYC = MAX(D.TAXAPPLYC), @TAXAPPLYLN = MAX(D.TAXAPPLYLN), @TAXAPPLYLND = MAX(D.TAXAPPLYND),
								@TAXAPPLYNC =MAX(D.TAXAPPLYNC), @TAXAPPLYR = MAX(D.TAXAPPLYR),							
								@TAXAPPLYAI = MAX(D.TAXAPPLYAI), @dec_ORDER_QTY = 
											CASE 
												WHEN (MAX(D.COST_TYPE) = 'NA') THEN 0 
												WHEN SUM(COALESCE(D.ACT_IMPRESSIONS,0)) >0 THEN SUM(COALESCE(D.ACT_IMPRESSIONS,0))
												ELSE SUM(COALESCE(D.GUARANTEED_IMPRESS,0))
											END 
				FROM INTERNET_HEADER H,INTERNET_DETAIL	D
				WHERE H.ORDER_NBR = D.ORDER_NBR AND H.ORDER_NBR = @order_nbr AND
							SUBSTRING(CONVERT(VARCHAR(10), D.START_DATE, 112), 5,2) = @month AND 
							SUBSTRING(CONVERT(VARCHAR(10), D.START_DATE, 112), 1,4) = @year AND D.ACTIVE_REV=1 
							AND D.BILL_TYPE_FLAG <> 1;		
			END	
			ELSE IF @media_type = 'T' BEGIN
				SELECT @UNITS = MAX(H.UNITS), @QUANTITY = SUM(COALESCE(D.QUANTITY,0)), @dec_COMM_PCT = MAX(COALESCE(D.COMM_PCT,0)), @dec_MARKUP_PCT = MAX(COALESCE(D.MARKUP_PCT,0)),
								@dec_REBATE_PCT = MAX(COALESCE(D.REBATE_PCT,0)), @dec_DISCOUNT_PCT = MAX(COALESCE(D.DISCOUNT_PCT,0)),
								@BILL_TYPE = MAX(D.BILL_TYPE_FLAG), @COST_TYPE = MAX(D.COST_TYPE), @NET_GROSS = MAX(H.NET_GROSS), @TAX_CODE = MAX(D.TAX_CODE),
								@NON_BILL_FLAG = MAX(D.NON_BILL_FLAG), 
								@dec_O_NET_RATE = SUM(COALESCE((D.NET_RATE), 0)) ,  
								@dec_O_GROSS_RATE = SUM(COALESCE((D.GROSS_RATE), 0)) ,  
								@dec_O_ADDL_CHARGE = SUM(COALESCE((D.ADDL_CHARGE), 0)) ,  
								@dec_O_REBATE_AMT = SUM(COALESCE((D.REBATE_AMT), 0)) ,  
								@dec_O_EXT_NET_AMT = SUM(COALESCE(D.EXT_NET_AMT, 0)) ,
								@dec_O_COMM_AMT = SUM(COALESCE(D.COMM_AMT, 0)) ,
								@dec_O_BILLING_AMT = SUM(COALESCE(D.BILLING_AMT, 0)) ,
								@dec_O_NETCHARGE =	SUM(COALESCE(D.NETCHARGE, 0)) ,
								@dec_O_NON_RESALE_AMT = SUM(COALESCE(D.NON_RESALE_AMT, 0)) ,
								@dec_O_DISCOUNT_AMT = SUM(COALESCE(D.DISCOUNT_AMT, 0) ),
								@CL_CODE = MAX(H.CL_CODE), @DIV_CODE = MAX(H.DIV_CODE), @PRD_CODE = MAX(H.PRD_CODE), @VN_CODE = MAX(H.VN_CODE),
								@TAX_RESALE = MAX(D.TAX_RESALE), @TAXAPPLYC = MAX(D.TAXAPPLYC), @TAXAPPLYLN = MAX(D.TAXAPPLYLN), @TAXAPPLYLND = MAX(D.TAXAPPLYND),
								@TAXAPPLYNC =MAX(D.TAXAPPLYNC), @TAXAPPLYR = MAX(D.TAXAPPLYR),										
								@TAXAPPLYAI = MAX(D.TAXAPPLYAI), @dec_ORDER_QTY = SUM(COALESCE(D.TOTAL_SPOTS, 0) )
				FROM TV_HDR H, TV_DETAIL	D
				WHERE H.ORDER_NBR = D.ORDER_NBR AND H.ORDER_NBR = @order_nbr AND 
							RIGHT('00' + CONVERT(VARCHAR(2), D.MONTH_NBR), 2) = @month AND 
							RIGHT('0000' + CONVERT(VARCHAR(4), D.YEAR_NBR), 4) = @year AND D.ACTIVE_REV=1
							AND D.BILL_TYPE_FLAG <> 1;		
			END			
			ELSE IF @media_type = 'R' BEGIN 
				SELECT @UNITS = MAX(H.UNITS), @QUANTITY = SUM(COALESCE(D.QUANTITY,0)), @dec_COMM_PCT = MAX(COALESCE(D.COMM_PCT,0)), @dec_MARKUP_PCT = MAX(COALESCE(D.MARKUP_PCT,0)),
								@dec_REBATE_PCT = MAX(COALESCE(D.REBATE_PCT,0)), @dec_DISCOUNT_PCT = MAX(COALESCE(D.DISCOUNT_PCT,0)),
								@BILL_TYPE = MAX(D.BILL_TYPE_FLAG), @COST_TYPE = MAX(D.COST_TYPE), @NET_GROSS = MAX(H.NET_GROSS), @TAX_CODE = MAX(D.TAX_CODE),
								@NON_BILL_FLAG = MAX(D.NON_BILL_FLAG), 
								@dec_O_NET_RATE = SUM(COALESCE((D.NET_RATE), 0)) ,  
								@dec_O_GROSS_RATE = SUM(COALESCE((D.GROSS_RATE), 0)) ,  
								@dec_O_ADDL_CHARGE = SUM(COALESCE((D.ADDL_CHARGE), 0)) ,  
								@dec_O_REBATE_AMT = SUM(COALESCE((D.REBATE_AMT), 0)) ,  
								@dec_O_EXT_NET_AMT = SUM(COALESCE(D.EXT_NET_AMT, 0)) ,
								@dec_O_COMM_AMT = SUM(COALESCE(D.COMM_AMT, 0)) ,
								@dec_O_BILLING_AMT = SUM(COALESCE(D.BILLING_AMT, 0)) ,
								@dec_O_NETCHARGE =	SUM(COALESCE(D.NETCHARGE, 0)) ,
								@dec_O_NON_RESALE_AMT = SUM(COALESCE(D.NON_RESALE_AMT, 0)) ,
								@dec_O_DISCOUNT_AMT = SUM(COALESCE(D.DISCOUNT_AMT, 0) ),
								@CL_CODE = MAX(H.CL_CODE), @DIV_CODE = MAX(H.DIV_CODE), @PRD_CODE = MAX(H.PRD_CODE), @VN_CODE = MAX(H.VN_CODE),
								@TAX_RESALE = MAX(D.TAX_RESALE), @TAXAPPLYC = MAX(D.TAXAPPLYC), @TAXAPPLYLN = MAX(D.TAXAPPLYLN), @TAXAPPLYLND = MAX(D.TAXAPPLYND),
								@TAXAPPLYNC =MAX(D.TAXAPPLYNC), @TAXAPPLYR = MAX(D.TAXAPPLYR),										
								@TAXAPPLYAI = MAX(D.TAXAPPLYAI), @dec_ORDER_QTY = SUM(COALESCE(D.TOTAL_SPOTS, 0) )
				FROM RADIO_HDR H, RADIO_DETAIL	D
				WHERE H.ORDER_NBR = D.ORDER_NBR AND H.ORDER_NBR = @order_nbr AND
							RIGHT('00' + CONVERT(VARCHAR(2), D.MONTH_NBR), 2) = @month AND 
							RIGHT('0000' + CONVERT(VARCHAR(4), D.YEAR_NBR), 4) = @year AND D.ACTIVE_REV=1
							AND D.BILL_TYPE_FLAG <> 1;		
			END						
		END
		ELSE IF @reconcile_by = 'O' BEGIN /*** RECONCILE BY ORDER - INTERNET ONLY ***/
			IF @media_type = 'I' BEGIN
				SELECT @UNITS = MAX(H.UNITS), @QUANTITY = SUM(COALESCE(D.QUANTITY,0)), @dec_COMM_PCT = MAX(COALESCE(D.COMM_PCT,0)), @dec_MARKUP_PCT = MAX(COALESCE(D.MARKUP_PCT,0)),
								@dec_REBATE_PCT = MAX(COALESCE(D.REBATE_PCT,0)), @dec_DISCOUNT_PCT = MAX(COALESCE(D.DISCOUNT_PCT,0)),
								@BILL_TYPE = MAX(D.BILL_TYPE_FLAG), @COST_TYPE = MAX(D.COST_TYPE), @NET_GROSS = MAX(NET_GROSS), @TAX_CODE = MAX(TAX_CODE),
								@new_start_date_d = MIN(D.[START_DATE]), @new_end_date_d = MAX(D.END_DATE), @new_close_date_d = MIN(D.CLOSE_DATE), @new_matl_close_date_d = MIN(D.MATL_CLOSE_DATE),
								@NON_BILL_FLAG = MAX(D.NON_BILL_FLAG), 
								@dec_O_NET_RATE = SUM(COALESCE((D.NET_RATE), 0)) ,  
								@dec_O_GROSS_RATE = SUM(COALESCE((D.GROSS_RATE), 0)) ,  							
								@dec_O_ADDL_CHARGE = SUM(COALESCE((D.ADDL_CHARGE), 0)), 
								@dec_O_REBATE_AMT = SUM(COALESCE((D.REBATE_AMT), 0)) ,  
								@dec_O_EXT_NET_AMT = SUM(COALESCE(D.EXT_NET_AMT, 0)) ,
								@dec_O_COMM_AMT = SUM(COALESCE(D.COMM_AMT, 0)) ,
								@dec_O_BILLING_AMT = SUM(COALESCE(D.BILLING_AMT, 0)) ,
								@dec_O_NETCHARGE =	SUM(COALESCE(D.NETCHARGE, 0)) ,
								@dec_O_NON_RESALE_AMT = SUM(COALESCE(D.NON_RESALE_AMT, 0)) ,
								@dec_O_DISCOUNT_AMT = SUM(COALESCE(D.DISCOUNT_AMT, 0) ),							
								@CL_CODE = MAX(H.CL_CODE), @DIV_CODE = MAX(H.DIV_CODE), @PRD_CODE = MAX(H.PRD_CODE), @VN_CODE = MAX(H.VN_CODE),
								@TAX_RESALE = MAX(D.TAX_RESALE), @TAXAPPLYC = MAX(D.TAXAPPLYC), @TAXAPPLYLN = MAX(D.TAXAPPLYLN), @TAXAPPLYLND = MAX(D.TAXAPPLYND),
								@TAXAPPLYNC =MAX(D.TAXAPPLYNC), @TAXAPPLYR = MAX(D.TAXAPPLYR),										
								@TAXAPPLYAI = MAX(D.TAXAPPLYAI), @dec_ORDER_QTY = 
																		CASE 
																			WHEN (MAX(D.COST_TYPE) = 'NA') THEN 0 
																			WHEN SUM(COALESCE(D.ACT_IMPRESSIONS,0)) >0 THEN SUM(COALESCE(D.ACT_IMPRESSIONS,0))
																			ELSE SUM(COALESCE(D.GUARANTEED_IMPRESS,0))
																		END 
				FROM INTERNET_HEADER H,INTERNET_DETAIL	D
				WHERE H.ORDER_NBR = D.ORDER_NBR AND H.ORDER_NBR = @order_nbr AND D.ACTIVE_REV=1
					AND D.BILL_TYPE_FLAG <> 1;		
			END
		END		
		ELSE IF @reconcile_by = 'L' BEGIN /*** RECONCILE BY LINE - INTERNET - ROLL_FWD ONLY ***/
			/* PJH 06/29/2020 - Allow line level reconcile of all media types */
			IF @media_type = 'I' BEGIN
				SELECT @UNITS = (H.UNITS), @QUANTITY = (COALESCE(D.QUANTITY,0)), @dec_COMM_PCT = (COALESCE(D.COMM_PCT,0)), @dec_MARKUP_PCT = (COALESCE(D.MARKUP_PCT,0)),
								@dec_REBATE_PCT = (COALESCE(D.REBATE_PCT,0)), @dec_DISCOUNT_PCT = (COALESCE(D.DISCOUNT_PCT,0)),
								@BILL_TYPE = (D.BILL_TYPE_FLAG), @COST_TYPE = (D.COST_TYPE), @NET_GROSS = (NET_GROSS), @TAX_CODE = (TAX_CODE),
								@NON_BILL_FLAG = (D.NON_BILL_FLAG), 
								@dec_O_NET_RATE = (COALESCE((D.NET_RATE), 0)) ,  
								@dec_O_GROSS_RATE = (COALESCE((D.GROSS_RATE), 0)) ,  							
								@dec_O_ADDL_CHARGE = (COALESCE((D.ADDL_CHARGE), 0)), 
								@dec_O_REBATE_AMT = (COALESCE((D.REBATE_AMT), 0)) ,  
								@dec_O_EXT_NET_AMT = (COALESCE(D.EXT_NET_AMT, 0)) ,
								@dec_O_COMM_AMT = (COALESCE(D.COMM_AMT, 0)) ,
								@dec_O_BILLING_AMT = (COALESCE(D.BILLING_AMT, 0)) ,
								@dec_O_NETCHARGE =	(COALESCE(D.NETCHARGE, 0)) ,
								@dec_O_NON_RESALE_AMT = (COALESCE(D.NON_RESALE_AMT, 0)) ,
								@dec_O_DISCOUNT_AMT = (COALESCE(D.DISCOUNT_AMT, 0) ),							
								@CL_CODE = (H.CL_CODE), @DIV_CODE = (H.DIV_CODE), @PRD_CODE = (H.PRD_CODE), @VN_CODE = (H.VN_CODE),
								@TAX_RESALE = (D.TAX_RESALE), @TAXAPPLYC = (D.TAXAPPLYC), @TAXAPPLYLN = (D.TAXAPPLYLN), @TAXAPPLYLND = (D.TAXAPPLYND),
								@TAXAPPLYNC =(D.TAXAPPLYNC), @TAXAPPLYR = (D.TAXAPPLYR),									
								@TAXAPPLYAI = (D.TAXAPPLYAI), @dec_ORDER_QTY = CASE 
																				WHEN ((D.COST_TYPE) = 'NA') THEN 0 
																				WHEN (COALESCE(D.ACT_IMPRESSIONS,0)) >0 THEN (COALESCE(D.ACT_IMPRESSIONS,0))
																				ELSE (COALESCE(D.GUARANTEED_IMPRESS,0))
																			END 
				FROM INTERNET_HEADER H,INTERNET_DETAIL	D
				WHERE H.ORDER_NBR = D.ORDER_NBR AND H.ORDER_NBR = @order_nbr AND
							LINE_NBR = @line_nbr AND D.ACTIVE_REV=1
							AND D.BILL_TYPE_FLAG <> 1;	
			END	
			/* PJH 06/29/2020 - Added TV & Radio */					
			ELSE IF @media_type = 'T' BEGIN
				SELECT @UNITS = (H.UNITS), @QUANTITY = (COALESCE(D.QUANTITY,0)), @dec_COMM_PCT = (COALESCE(D.COMM_PCT,0)), @dec_MARKUP_PCT = (COALESCE(D.MARKUP_PCT,0)),
								@dec_REBATE_PCT = (COALESCE(D.REBATE_PCT,0)), @dec_DISCOUNT_PCT = (COALESCE(D.DISCOUNT_PCT,0)),
								@BILL_TYPE = (D.BILL_TYPE_FLAG), @COST_TYPE = (D.COST_TYPE), @NET_GROSS = (H.NET_GROSS), @TAX_CODE = (D.TAX_CODE),
								@NON_BILL_FLAG = (D.NON_BILL_FLAG), 
								@dec_O_NET_RATE = (COALESCE((D.NET_RATE), 0)) ,  
								@dec_O_GROSS_RATE = (COALESCE((D.GROSS_RATE), 0)) ,  
								@dec_O_ADDL_CHARGE = (COALESCE((D.ADDL_CHARGE), 0)) ,  
								@dec_O_REBATE_AMT = (COALESCE((D.REBATE_AMT), 0)) ,  
								@dec_O_EXT_NET_AMT = (COALESCE(D.EXT_NET_AMT, 0)) ,
								@dec_O_COMM_AMT = (COALESCE(D.COMM_AMT, 0)) ,
								@dec_O_BILLING_AMT = (COALESCE(D.BILLING_AMT, 0)) ,
								@dec_O_NETCHARGE = (COALESCE(D.NETCHARGE, 0)) ,
								@dec_O_NON_RESALE_AMT = (COALESCE(D.NON_RESALE_AMT, 0)) ,
								@dec_O_DISCOUNT_AMT = (COALESCE(D.DISCOUNT_AMT, 0) ),
								@CL_CODE = (H.CL_CODE), @DIV_CODE = (H.DIV_CODE), @PRD_CODE = (H.PRD_CODE), @VN_CODE = (H.VN_CODE),
								@TAX_RESALE = (D.TAX_RESALE), @TAXAPPLYC = (D.TAXAPPLYC), @TAXAPPLYLN = (D.TAXAPPLYLN), @TAXAPPLYLND = (D.TAXAPPLYND),
								@TAXAPPLYNC = (D.TAXAPPLYNC), @TAXAPPLYR = (D.TAXAPPLYR),										
								@TAXAPPLYAI = (D.TAXAPPLYAI), @dec_ORDER_QTY = (COALESCE(D.TOTAL_SPOTS, 0) )
				FROM TV_HDR H, TV_DETAIL	D
				WHERE H.ORDER_NBR = D.ORDER_NBR AND H.ORDER_NBR = @order_nbr AND
							LINE_NBR = @line_nbr AND D.ACTIVE_REV=1
							AND D.BILL_TYPE_FLAG <> 1;		
			END			
				ELSE IF @media_type = 'R' BEGIN 
				SELECT @UNITS = (H.UNITS), @QUANTITY = (COALESCE(D.QUANTITY,0)), @dec_COMM_PCT = (COALESCE(D.COMM_PCT,0)), @dec_MARKUP_PCT = (COALESCE(D.MARKUP_PCT,0)),
								@dec_REBATE_PCT = (COALESCE(D.REBATE_PCT,0)), @dec_DISCOUNT_PCT = (COALESCE(D.DISCOUNT_PCT,0)),
								@BILL_TYPE = (D.BILL_TYPE_FLAG), @COST_TYPE = (D.COST_TYPE), @NET_GROSS = (H.NET_GROSS), @TAX_CODE = (D.TAX_CODE),
								@NON_BILL_FLAG = (D.NON_BILL_FLAG), 
								@dec_O_NET_RATE = (COALESCE((D.NET_RATE), 0)) ,  
								@dec_O_GROSS_RATE = (COALESCE((D.GROSS_RATE), 0)) ,  
								@dec_O_ADDL_CHARGE = (COALESCE((D.ADDL_CHARGE), 0)) ,  
								@dec_O_REBATE_AMT = (COALESCE((D.REBATE_AMT), 0)) ,  
								@dec_O_EXT_NET_AMT = (COALESCE(D.EXT_NET_AMT, 0)) ,
								@dec_O_COMM_AMT = (COALESCE(D.COMM_AMT, 0)) ,
								@dec_O_BILLING_AMT = (COALESCE(D.BILLING_AMT, 0)) ,
								@dec_O_NETCHARGE = (COALESCE(D.NETCHARGE, 0)) ,
								@dec_O_NON_RESALE_AMT = (COALESCE(D.NON_RESALE_AMT, 0)) ,
								@dec_O_DISCOUNT_AMT = (COALESCE(D.DISCOUNT_AMT, 0) ),
								@CL_CODE = (H.CL_CODE), @DIV_CODE = (H.DIV_CODE), @PRD_CODE = (H.PRD_CODE), @VN_CODE = (H.VN_CODE),
								@TAX_RESALE = (D.TAX_RESALE), @TAXAPPLYC = (D.TAXAPPLYC), @TAXAPPLYLN = (D.TAXAPPLYLN), @TAXAPPLYLND = (D.TAXAPPLYND),
								@TAXAPPLYNC = (D.TAXAPPLYNC), @TAXAPPLYR = (D.TAXAPPLYR),										
								@TAXAPPLYAI = (D.TAXAPPLYAI), @dec_ORDER_QTY = (COALESCE(D.TOTAL_SPOTS, 0) )
				FROM RADIO_HDR H, RADIO_DETAIL	D
				WHERE H.ORDER_NBR = D.ORDER_NBR AND H.ORDER_NBR = @order_nbr AND
							LINE_NBR = @line_nbr AND D.ACTIVE_REV=1
							AND D.BILL_TYPE_FLAG <> 1;		
			END		
			ELSE IF @media_type = 'N' BEGIN 
				SELECT @UNITS = (H.UNITS), @QUANTITY = (COALESCE(D.QUANTITY,0)), @dec_COMM_PCT = (COALESCE(D.COMM_PCT,0)), @dec_MARKUP_PCT = (COALESCE(D.MARKUP_PCT,0)),
								@dec_REBATE_PCT = (COALESCE(D.REBATE_PCT,0)), @dec_DISCOUNT_PCT = (COALESCE(D.DISCOUNT_PCT,0)),
								@BILL_TYPE = (D.BILL_TYPE_FLAG), @COST_TYPE = (D.COST_TYPE), @NET_GROSS = (H.NET_GROSS), @TAX_CODE = (D.TAX_CODE),
								@NON_BILL_FLAG = (D.NON_BILL_FLAG), 
								@dec_O_NET_RATE = (COALESCE((D.NET_RATE), 0)) ,  
								@dec_O_GROSS_RATE = (COALESCE((D.GROSS_RATE), 0)) ,  
								@dec_O_ADDL_CHARGE = (COALESCE((D.ADDL_CHARGE), 0)) ,  
								@dec_O_REBATE_AMT = (COALESCE((D.REBATE_AMT), 0)) ,  
								@dec_O_EXT_NET_AMT = (COALESCE(D.EXT_NET_AMT, 0)) ,
								@dec_O_COMM_AMT = (COALESCE(D.COMM_AMT, 0)) ,
								@dec_O_BILLING_AMT = (COALESCE(D.BILLING_AMT, 0)) ,
								@dec_O_NETCHARGE = (COALESCE(D.NETCHARGE, 0)) ,
								@dec_O_NON_RESALE_AMT = (COALESCE(D.NON_RESALE_AMT, 0)) ,
								@dec_O_DISCOUNT_AMT = (COALESCE(D.DISCOUNT_AMT, 0) ), 
								@dec_O_PROD_CHARGE = (COALESCE(D.PROD_CHARGE, 0) ), 
								@dec_O_COLOR_CHARGE = (COALESCE(D.COLOR_CHARGE, 0) ),  
								@CL_CODE = (H.CL_CODE), @DIV_CODE = (H.DIV_CODE), @PRD_CODE = (H.PRD_CODE), @VN_CODE = (H.VN_CODE),
								@TAX_RESALE = (D.TAX_RESALE), @TAXAPPLYC = (D.TAXAPPLYC), @TAXAPPLYLN = (D.TAXAPPLYLN), @TAXAPPLYLND = (D.TAXAPPLYND),
								@TAXAPPLYNC = (D.TAXAPPLYNC), @TAXAPPLYR = (D.TAXAPPLYR),										
								@TAXAPPLYAI = (D.TAXAPPLYAI), @dec_ORDER_QTY = (COALESCE(D.QUANTITY, 0)), @dec_CONTRACT_QTY = (COALESCE(D.CONTRACT_QTY, 0))
				FROM NEWSPAPER_HEADER H, NEWSPAPER_DETAIL D
				WHERE H.ORDER_NBR = D.ORDER_NBR AND H.ORDER_NBR = @order_nbr AND
							LINE_NBR = @line_nbr AND D.ACTIVE_REV=1
							AND D.BILL_TYPE_FLAG <> 1;		
			END	
			ELSE IF @media_type = 'M' BEGIN 
				SELECT @UNITS = (H.UNITS), @QUANTITY = (COALESCE(D.QUANTITY,0)), @dec_COMM_PCT = (COALESCE(D.COMM_PCT,0)), @dec_MARKUP_PCT = (COALESCE(D.MARKUP_PCT,0)),
								@dec_REBATE_PCT = (COALESCE(D.REBATE_PCT,0)), @dec_DISCOUNT_PCT = (COALESCE(D.DISCOUNT_PCT,0)),
								@BILL_TYPE = (D.BILL_TYPE_FLAG), @NET_GROSS = (H.NET_GROSS), @TAX_CODE = (D.TAX_CODE),
								@NON_BILL_FLAG = (D.NON_BILL_FLAG), 
								@dec_O_NET_RATE = (COALESCE((D.NET_RATE), 0)) ,  
								@dec_O_GROSS_RATE = (COALESCE((D.GROSS_RATE), 0)) ,  
								@dec_O_ADDL_CHARGE = (COALESCE((D.ADDL_CHARGE), 0)) ,  
								@dec_O_REBATE_AMT = (COALESCE((D.REBATE_AMT), 0)) ,  
								@dec_O_EXT_NET_AMT = (COALESCE(D.EXT_NET_AMT, 0)) ,
								@dec_O_COMM_AMT = (COALESCE(D.COMM_AMT, 0)) ,
								@dec_O_BILLING_AMT = (COALESCE(D.BILLING_AMT, 0)) ,
								@dec_O_NETCHARGE = (COALESCE(D.NETCHARGE, 0)) ,
								@dec_O_NON_RESALE_AMT = (COALESCE(D.NON_RESALE_AMT, 0)) ,
								@dec_O_DISCOUNT_AMT = (COALESCE(D.DISCOUNT_AMT, 0) ),
								@CL_CODE = (H.CL_CODE), @DIV_CODE = (H.DIV_CODE), @PRD_CODE = (H.PRD_CODE), @VN_CODE = (H.VN_CODE),
								@TAX_RESALE = (D.TAX_RESALE), @TAXAPPLYC = (D.TAXAPPLYC), @TAXAPPLYLN = (D.TAXAPPLYLN), @TAXAPPLYLND = (D.TAXAPPLYND),
								@TAXAPPLYNC = (D.TAXAPPLYNC), @TAXAPPLYR = (D.TAXAPPLYR),										
								@TAXAPPLYAI = (D.TAXAPPLYAI), @dec_ORDER_QTY = (COALESCE(D.QUANTITY, 0)), @dec_CONTRACT_QTY = (COALESCE(D.CONTRACT_QTY, 0))
				FROM MAGAZINE_HEADER H, MAGAZINE_DETAIL D
				WHERE H.ORDER_NBR = D.ORDER_NBR AND H.ORDER_NBR = @order_nbr AND
							LINE_NBR = @line_nbr AND D.ACTIVE_REV=1
							AND D.BILL_TYPE_FLAG <> 1;		
			END		
			ELSE IF @media_type = 'O' BEGIN 
				SELECT @UNITS = (H.UNITS), @QUANTITY = (COALESCE(D.QUANTITY,0)), @dec_COMM_PCT = (COALESCE(D.COMM_PCT,0)), @dec_MARKUP_PCT = (COALESCE(D.MARKUP_PCT,0)),
								@dec_REBATE_PCT = (COALESCE(D.REBATE_PCT,0)), @dec_DISCOUNT_PCT = (COALESCE(D.DISCOUNT_PCT,0)),
								@BILL_TYPE = (D.BILL_TYPE_FLAG), @NET_GROSS = (H.NET_GROSS), @TAX_CODE = (D.TAX_CODE),
								@NON_BILL_FLAG = (D.NON_BILL_FLAG), 
								@dec_O_NET_RATE = (COALESCE((D.NET_RATE), 0)) ,  
								@dec_O_GROSS_RATE = (COALESCE((D.GROSS_RATE), 0)) ,  
								@dec_O_ADDL_CHARGE = (COALESCE((D.ADDL_CHARGE), 0)) ,  
								@dec_O_REBATE_AMT = (COALESCE((D.REBATE_AMT), 0)) ,  
								@dec_O_EXT_NET_AMT = (COALESCE(D.EXT_NET_AMT, 0)) ,
								@dec_O_COMM_AMT = (COALESCE(D.COMM_AMT, 0)) ,
								@dec_O_BILLING_AMT = (COALESCE(D.BILLING_AMT, 0)) ,
								@dec_O_NETCHARGE = (COALESCE(D.NETCHARGE, 0)) ,
								@dec_O_NON_RESALE_AMT = (COALESCE(D.NON_RESALE_AMT, 0)) ,
								@dec_O_DISCOUNT_AMT = (COALESCE(D.DISCOUNT_AMT, 0) ),
								@CL_CODE = (H.CL_CODE), @DIV_CODE = (H.DIV_CODE), @PRD_CODE = (H.PRD_CODE), @VN_CODE = (H.VN_CODE),
								@TAX_RESALE = (D.TAX_RESALE), @TAXAPPLYC = (D.TAXAPPLYC), @TAXAPPLYLN = (D.TAXAPPLYLN), @TAXAPPLYLND = (D.TAXAPPLYND),
								@TAXAPPLYNC = (D.TAXAPPLYNC), @TAXAPPLYR = (D.TAXAPPLYR),										
								@TAXAPPLYAI = (D.TAXAPPLYAI), @dec_ORDER_QTY = (COALESCE(D.QUANTITY, 0)), @dec_CONTRACT_QTY = 0
				FROM OUTDOOR_HEADER H, OUTDOOR_DETAIL D
				WHERE H.ORDER_NBR = D.ORDER_NBR AND H.ORDER_NBR = @order_nbr AND
							LINE_NBR = @line_nbr AND D.ACTIVE_REV=1
							AND D.BILL_TYPE_FLAG <> 1;		
			END																
		END		
		
				
		SET @dec_ADDL_CHARGE = 0  /*************** OVERRIDE ***************/
		
		IF @media_type = 'I' BEGIN
			IF @COST_TYPE IS NULL  SET @COST_TYPE = 'NA' 
		END
			
		--CALC_COMM_MU:

		IF  @DIFFERENCE_LINE = 0 BEGIN
			IF @NET_GROSS = 1 BEGIN --AND (@DIFFERENCE_LINE = 0) /** NOT DIFF LINE **/  
				SET @dec_temp = 100 - @dec_COMM_PCT
				SET @dec_MARKUP_PCT = 0
				IF @dec_temp > 0 BEGIN
					SET @dec_MARKUP_PCT = ROUND((@dec_COMM_PCT/@dec_temp) * 100, 3)
				END
			END
			ELSE BEGIN
				SET @dec_temp = 100 + (100 * (@dec_MARKUP_PCT / 100))
				SET @dec_COMM_PCT = 0
				IF @dec_temp > 0 BEGIN
					SET @dec_COMM_PCT = @dec_temp - 100
					SET @dec_COMM_PCT = ROUND((@dec_COMM_PCT/@dec_temp) * 100, 3)
				END
			END
		END

	
		/** LOGIC FROM uf_revise_rows_ap_recon() **/	
		
		/** Get tax flags, etc from ORDER **/
		
		/**** BEGIN GET AP ****/		
		IF @reconcile_by = 'M' BEGIN	  /*** RECONCILE BY MONTH ***/
			IF @media_type = 'I' BEGIN	
				SELECT @dec_NET_RATE = SUM(COALESCE(AD.NET_AMT,0))  /* Chg AD.NET_RATE to AD.NET_AMT */
								,@dec_GROSS_RATE = SUM(COALESCE(AD.NET_AMT,0) + COALESCE(AD.COMM_AMT,0))  /* Chg AD.GROSS_RATE to AD.NET_AMT + AD.COMM_AMT */
								,@dec_NETCHARGES = SUM(COALESCE(AD.NETCHARGES,0))
								,@dec_NET_AMT = SUM(COALESCE(AD.NET_AMT,0))
								,@dec_COMM_AMT = SUM(COALESCE(AD.COMM_AMT,0))
								,@dec_VENDOR_TAX = SUM(COALESCE(AD.VENDOR_TAX,0))
								,@dec_STATE_TAX = SUM(COALESCE(AD.STATE_TAX,0))
								,@dec_COUNTY_TAX = SUM(COALESCE(AD.COUNTY_TAX,0))
								,@dec_CITY_TAX = SUM(COALESCE(AD.CITY_TAX,0))
								,@dec_LINE_TOTAL = SUM(COALESCE(AD.LINE_TOTAL,0))
								,@dec_REBATE_AMT = SUM(COALESCE(AD.REBATE_AMT,0))
								,@dec_DISCOUNT_AMT = SUM(COALESCE(AD.DISCOUNT_AMT,0))
								,@dec_IMPRESSIONS = SUM(COALESCE(AD.IMPRESSIONS,0))
								,@dec_AP_NET_AMT = SUM(COALESCE((AD.NET_AMT), 0) + COALESCE((AD.NETCHARGES), 0) + COALESCE((AD.VENDOR_TAX), 0) + COALESCE((AD.DISCOUNT_AMT), 0))
								--,@TAX_RESALE = MAX(AD.TAX_RESALE), @TAXAPPLYC = MAX(AD.TAXAPPLYC), @TAXAPPLYLN = MAX(AD.TAXAPPLYLN), @TAXAPPLYLND = MAX(AD.TAXAPPLYLND)
								--,@TAXAPPLYNC =MAX(AD.TAXAPPLYNC), @TAXAPPLYR = MAX(AD.TAXAPPLYR)--, @TAXAPPLYAI = MAX(AD.TAXAPPLYAI)
						FROM AP_INTERNET AD, INTERNET_DETAIL D
						WHERE	AD.ORDER_NBR = D.ORDER_NBR AND AD.ORDER_LINE_NBR = D.LINE_NBR AND
										AD.ORDER_NBR = @order_nbr  AND D.ACTIVE_REV = 1 AND D.BILL_TYPE_FLAG <> 1 AND
										SUBSTRING(CONVERT(VARCHAR(10), D.START_DATE, 112), 5,2) = @month AND 
										SUBSTRING(CONVERT(VARCHAR(10), D.START_DATE, 112), 1,4) = @year AND 
										(AD.MODIFY_DELETE IS NULL OR AD.MODIFY_DELETE = 0);	
			END
			ELSE IF @media_type = 'T' BEGIN  
				SELECT @dec_NET_RATE = SUM(COALESCE(AD.EXT_NET_AMT,0))
								,@dec_GROSS_RATE = SUM(COALESCE(AD.EXT_NET_AMT,0) + COALESCE(AD.COMM_AMT,0))
								,@dec_NETCHARGES = SUM(COALESCE(AD.NETCHARGES,0))
								,@dec_NET_AMT = SUM(COALESCE(AD.EXT_NET_AMT,0))
								,@dec_COMM_AMT = SUM(COALESCE(AD.COMM_AMT,0))
								,@dec_VENDOR_TAX = SUM(COALESCE(AD.VENDOR_TAX,0))
								,@dec_STATE_TAX = SUM(COALESCE(AD.STATE_TAX,0))
								,@dec_COUNTY_TAX = SUM(COALESCE(AD.COUNTY_TAX,0))
								,@dec_CITY_TAX = SUM(COALESCE(AD.CITY_TAX,0))
								,@dec_LINE_TOTAL = SUM(COALESCE(AD.LINE_TOTAL,0))
								,@dec_REBATE_AMT = SUM(COALESCE(AD.REBATE_AMT,0))
								,@dec_DISCOUNT_AMT = SUM(COALESCE(AD.DISC_AMT,0))
								,@dec_IMPRESSIONS = SUM(COALESCE(AD.TOTAL_SPOTS,0))
								,@dec_AP_NET_AMT = SUM(COALESCE((AD.EXT_NET_AMT), 0) + COALESCE((AD.NETCHARGES), 0) + COALESCE((AD.VENDOR_TAX), 0) + COALESCE((AD.DISC_AMT), 0))
								--,@TAX_RESALE = MAX(AD.TAX_RESALE), @TAXAPPLYC = MAX(AD.TAXAPPLYC), @TAXAPPLYLN = MAX(AD.TAXAPPLYLN), @TAXAPPLYLND = MAX(AD.TAXAPPLYLND)
								--,@TAXAPPLYNC =MAX(AD.TAXAPPLYNC), @TAXAPPLYR = MAX(AD.TAXAPPLYR)--, @TAXAPPLYAI = MAX(AD.TAXAPPLYAI)
						FROM AP_TV AD, TV_DETAIL D
						WHERE	AD.ORDER_NBR = D.ORDER_NBR AND AD.ORDER_LINE_NBR = D.LINE_NBR AND
										AD.ORDER_NBR = @order_nbr  AND D.ACTIVE_REV = 1 AND D.BILL_TYPE_FLAG <> 1 AND
										RIGHT('00' + CONVERT(VARCHAR(2), D.MONTH_NBR), 2) = @month AND 
										RIGHT('0000' + CONVERT(VARCHAR(4), D.YEAR_NBR), 4) = @year AND									
										(AD.MODIFY_DELETE IS NULL OR AD.MODIFY_DELETE = 0);						
			END
			ELSE IF @media_type = 'R' BEGIN
			
				SELECT RIGHT('00' + CONVERT(VARCHAR(2), D.MONTH_NBR), 2) 'MONTH', @month 'M-IN', RIGHT('0000' + CONVERT(VARCHAR(4), D.YEAR_NBR), 4) 'YEAR', @year 'Y-IN'
				FROM AP_RADIO AD, RADIO_DETAIL D
							WHERE	AD.ORDER_NBR = D.ORDER_NBR AND AD.ORDER_LINE_NBR = D.LINE_NBR AND
											AD.ORDER_NBR = @order_nbr  AND D.ACTIVE_REV = 1 AND D.BILL_TYPE_FLAG <> 1 AND
											--RIGHT('00' + CONVERT(VARCHAR(2), D.MONTH_NBR), 2) = @month AND 
											--RIGHT('0000' + CONVERT(VARCHAR(4), D.YEAR_NBR), 4) = @year AND			
											(AD.MODIFY_DELETE IS NULL OR AD.MODIFY_DELETE = 0);
			
			
				SELECT @dec_NET_RATE = SUM(COALESCE(AD.EXT_NET_AMT,0))
								,@dec_GROSS_RATE = SUM(COALESCE(AD.EXT_NET_AMT,0) + COALESCE(AD.COMM_AMT,0))
								,@dec_NETCHARGES = SUM(COALESCE(AD.NETCHARGES,0))
								,@dec_NET_AMT = SUM(COALESCE(AD.EXT_NET_AMT,0))
								,@dec_COMM_AMT = SUM(COALESCE(AD.COMM_AMT,0))
								,@dec_VENDOR_TAX = SUM(COALESCE(AD.VENDOR_TAX,0))
								,@dec_STATE_TAX = SUM(COALESCE(AD.STATE_TAX,0))
								,@dec_COUNTY_TAX = SUM(COALESCE(AD.COUNTY_TAX,0))
								,@dec_CITY_TAX = SUM(COALESCE(AD.CITY_TAX,0))
								,@dec_LINE_TOTAL = SUM(COALESCE(AD.LINE_TOTAL,0))
								,@dec_REBATE_AMT = SUM(COALESCE(AD.REBATE_AMT,0))
								,@dec_DISCOUNT_AMT = SUM(COALESCE(AD.DISC_AMT,0))
								,@dec_IMPRESSIONS = SUM(COALESCE(AD.TOTAL_SPOTS,0))
								,@dec_AP_NET_AMT = SUM(COALESCE((AD.EXT_NET_AMT), 0) + COALESCE((AD.NETCHARGES), 0) + COALESCE((AD.VENDOR_TAX), 0) + COALESCE((AD.DISC_AMT), 0))
								--,@TAX_RESALE = MAX(AD.TAX_RESALE), @TAXAPPLYC = MAX(AD.TAXAPPLYC), @TAXAPPLYLN = MAX(AD.TAXAPPLYLN), @TAXAPPLYLND = MAX(AD.TAXAPPLYLND)
								--,@TAXAPPLYNC =MAX(AD.TAXAPPLYNC), @TAXAPPLYR = MAX(AD.TAXAPPLYR)--, @TAXAPPLYAI = MAX(AD.TAXAPPLYAI)
						FROM AP_RADIO AD, RADIO_DETAIL D
						WHERE	AD.ORDER_NBR = D.ORDER_NBR AND AD.ORDER_LINE_NBR = D.LINE_NBR AND
										AD.ORDER_NBR = @order_nbr  AND D.ACTIVE_REV = 1 AND D.BILL_TYPE_FLAG <> 1 AND
										RIGHT('00' + CONVERT(VARCHAR(2), D.MONTH_NBR), 2) = @month AND 
										RIGHT('0000' + CONVERT(VARCHAR(4), D.YEAR_NBR), 4) = @year AND			
										(AD.MODIFY_DELETE IS NULL OR AD.MODIFY_DELETE = 0);						
			END
		END
		ELSE IF @reconcile_by = 'O' BEGIN   /*** RECONCILE BY MONTH - INTERNET ONLY ***/
			SELECT @dec_NET_RATE = SUM(COALESCE(AD.NET_AMT,0))  /* Chg AD.NET_RATE to AD.NET_AMT */
							,@dec_GROSS_RATE = SUM(COALESCE(AD.NET_AMT,0) + COALESCE(AD.COMM_AMT,0))  /* Chg AD.GROSS_RATE to AD.NET_AMT + AD.COMM_AMT */
							,@dec_NETCHARGES = SUM(COALESCE(AD.NETCHARGES,0))
							,@dec_NET_AMT = SUM(COALESCE(AD.NET_AMT,0))
							,@dec_COMM_AMT = SUM(COALESCE(AD.COMM_AMT,0))
							,@dec_VENDOR_TAX = SUM(COALESCE(AD.VENDOR_TAX,0))
							,@dec_STATE_TAX = SUM(COALESCE(AD.STATE_TAX,0))
							,@dec_COUNTY_TAX = SUM(COALESCE(AD.COUNTY_TAX,0))
							,@dec_CITY_TAX = SUM(COALESCE(AD.CITY_TAX,0))
							,@dec_LINE_TOTAL = SUM(COALESCE(AD.LINE_TOTAL,0))
							,@dec_REBATE_AMT = SUM(COALESCE(AD.REBATE_AMT,0))
							,@dec_DISCOUNT_AMT = SUM(COALESCE(AD.DISCOUNT_AMT,0))
							,@dec_IMPRESSIONS = SUM(COALESCE(AD.IMPRESSIONS,0))
							,@dec_AP_NET_AMT = SUM(COALESCE((AD.NET_AMT), 0) + COALESCE((AD.NETCHARGES), 0) + COALESCE((AD.VENDOR_TAX), 0) + COALESCE((AD.DISCOUNT_AMT), 0))
							--,@TAX_RESALE = MAX(AD.TAX_RESALE), @TAXAPPLYC = MAX(AD.TAXAPPLYC), @TAXAPPLYLN = MAX(AD.TAXAPPLYLN), @TAXAPPLYLND = MAX(AD.TAXAPPLYLND)
							--,@TAXAPPLYNC =MAX(AD.TAXAPPLYNC), @TAXAPPLYR = MAX(AD.TAXAPPLYR)--, @TAXAPPLYAI = MAX(AD.TAXAPPLYAI)
					FROM AP_INTERNET AD, INTERNET_DETAIL D
					WHERE	AD.ORDER_NBR = D.ORDER_NBR AND AD.ORDER_LINE_NBR = D.LINE_NBR AND
									AD.ORDER_NBR = @order_nbr  AND D.ACTIVE_REV = 1 AND D.BILL_TYPE_FLAG <> 1 AND
									(AD.MODIFY_DELETE IS NULL OR AD.MODIFY_DELETE = 0);			
		END		
		ELSE IF @reconcile_by = 'L' BEGIN	 /*** RECONCILE BY LINE - INTERNET, ROLL FWD ONLY or MEDIA MGR ***/
			IF @media_type = 'I' BEGIN
			SELECT @dec_NET_RATE = SUM(COALESCE(AD.NET_AMT,0))  /* Chg AD.NET_RATE to AD.NET_AMT */
							,@dec_GROSS_RATE = SUM(COALESCE(AD.NET_AMT,0) + COALESCE(AD.COMM_AMT,0))  /* Chg AD.GROSS_RATE to AD.NET_AMT + AD.COMM_AMT */
								,@dec_NETCHARGES = SUM(COALESCE(AD.NETCHARGES,0))
								,@dec_NET_AMT = SUM(COALESCE(AD.NET_AMT,0))
								,@dec_COMM_AMT = SUM(COALESCE(AD.COMM_AMT,0))
								,@dec_VENDOR_TAX = SUM(COALESCE(AD.VENDOR_TAX,0))
								,@dec_STATE_TAX = SUM(COALESCE(AD.STATE_TAX,0))
								,@dec_COUNTY_TAX = SUM(COALESCE(AD.COUNTY_TAX,0))
								,@dec_CITY_TAX = SUM(COALESCE(AD.CITY_TAX,0))
								,@dec_LINE_TOTAL = SUM(COALESCE(AD.LINE_TOTAL,0))
								,@dec_REBATE_AMT = SUM(COALESCE(AD.REBATE_AMT,0))
								,@dec_DISCOUNT_AMT = SUM(COALESCE(AD.DISCOUNT_AMT,0))
								,@dec_IMPRESSIONS = SUM(COALESCE(AD.IMPRESSIONS,0))
								,@dec_AP_NET_AMT = SUM(COALESCE((AD.NET_AMT), 0) + COALESCE((AD.NETCHARGES), 0) + COALESCE((AD.VENDOR_TAX), 0) + COALESCE((AD.DISCOUNT_AMT), 0))
								,@TAX_RESALE = MAX(AD.TAX_RESALE), @TAXAPPLYC = MAX(AD.TAXAPPLYC), @TAXAPPLYLN = MAX(AD.TAXAPPLYLN), @TAXAPPLYLND = MAX(AD.TAXAPPLYLND)
								,@TAXAPPLYNC =MAX(AD.TAXAPPLYNC), @TAXAPPLYR = MAX(AD.TAXAPPLYR)--, @TAXAPPLYAI = MAX(AD.TAXAPPLYAI)
								,@AP_TAX_CODE = MAX(AD.TAX_CODE)
								,@dec_CITY_PCT = MAX(AD.TAX_CITY_PCT), @dec_COUNTY_PCT = MAX(AD.TAX_COUNTY_PCT), @dec_STATE_PCT = MAX(AD.TAX_STATE_PCT)
						FROM AP_INTERNET AD, INTERNET_DETAIL D
						WHERE	AD.ORDER_NBR = D.ORDER_NBR AND AD.ORDER_LINE_NBR = D.LINE_NBR AND
										AD.ORDER_NBR = @order_nbr  AND D.LINE_NBR = @line_nbr AND D.ACTIVE_REV = 1 AND D.BILL_TYPE_FLAG <> 1 AND
									(AD.MODIFY_DELETE IS NULL OR AD.MODIFY_DELETE = 0);	
			END
			ELSE IF @media_type = 'T' BEGIN  
				SELECT @dec_NET_RATE = SUM(COALESCE(AD.EXT_NET_AMT,0))
								,@dec_GROSS_RATE = SUM(COALESCE(AD.EXT_NET_AMT,0) + COALESCE(AD.COMM_AMT,0))
								,@dec_NETCHARGES = SUM(COALESCE(AD.NETCHARGES,0))
								,@dec_NET_AMT = SUM(COALESCE(AD.EXT_NET_AMT,0))
								,@dec_COMM_AMT = SUM(COALESCE(AD.COMM_AMT,0))
								,@dec_VENDOR_TAX = SUM(COALESCE(AD.VENDOR_TAX,0))
								,@dec_STATE_TAX = SUM(COALESCE(AD.STATE_TAX,0))
								,@dec_COUNTY_TAX = SUM(COALESCE(AD.COUNTY_TAX,0))
								,@dec_CITY_TAX = SUM(COALESCE(AD.CITY_TAX,0))
								,@dec_LINE_TOTAL = SUM(COALESCE(AD.LINE_TOTAL,0))
								,@dec_REBATE_AMT = SUM(COALESCE(AD.REBATE_AMT,0))
								,@dec_DISCOUNT_AMT = SUM(COALESCE(AD.DISC_AMT,0))
								,@dec_IMPRESSIONS = SUM(COALESCE(AD.TOTAL_SPOTS,0))
								,@dec_AP_NET_AMT = SUM(COALESCE((AD.EXT_NET_AMT), 0) + COALESCE((AD.NETCHARGES), 0) + COALESCE((AD.VENDOR_TAX), 0) + COALESCE((AD.DISC_AMT), 0))
								,@dec_ORDER_QTY = SUM(COALESCE(AD.TOTAL_SPOTS, 0))
								,@dec_MARKUP_PCT = MAX(COALESCE(D.MARKUP_PCT,0))
								,@TAX_RESALE = MAX(AD.TAX_RESALE), @TAXAPPLYC = MAX(AD.TAXAPPLYC), @TAXAPPLYLN = MAX(AD.TAXAPPLYLN), @TAXAPPLYLND = MAX(AD.TAXAPPLYLND)
								,@TAXAPPLYNC =MAX(AD.TAXAPPLYNC), @TAXAPPLYR = MAX(AD.TAXAPPLYR)--, @TAXAPPLYAI = MAX(AD.TAXAPPLYAI)
								,@AP_TAX_CODE = MAX(AD.TAX_CODE)
								,@dec_CITY_PCT = MAX(AD.TAX_CITY_PCT), @dec_COUNTY_PCT = MAX(AD.TAX_COUNTY_PCT), @dec_STATE_PCT = MAX(AD.TAX_STATE_PCT)
						FROM AP_TV AD, TV_DETAIL D
						WHERE	AD.ORDER_NBR = D.ORDER_NBR AND AD.ORDER_LINE_NBR = D.LINE_NBR AND
										AD.ORDER_NBR = @order_nbr AND AD.ORDER_LINE_NBR = @line_nbr AND D.ACTIVE_REV = 1 AND D.BILL_TYPE_FLAG <> 1 AND								
										(AD.MODIFY_DELETE IS NULL OR AD.MODIFY_DELETE = 0);						
			END
			ELSE IF @media_type = 'R' BEGIN
			
				--SELECT RIGHT('00' + CONVERT(VARCHAR(2), D.MONTH_NBR), 2) 'MONTH', @month 'M-IN', RIGHT('0000' + CONVERT(VARCHAR(4), D.YEAR_NBR), 4) 'YEAR', @year 'Y-IN'
				--FROM AP_RADIO AD, RADIO_DETAIL D
				--			WHERE	AD.ORDER_NBR = D.ORDER_NBR AND AD.ORDER_LINE_NBR = D.LINE_NBR AND
				--							AD.ORDER_NBR = @order_nbr  AND D.ACTIVE_REV = 1 AND D.BILL_TYPE_FLAG <> 1 AND
				--							(AD.MODIFY_DELETE IS NULL OR AD.MODIFY_DELETE = 0);			
			
				SELECT @dec_NET_RATE = SUM(COALESCE(AD.EXT_NET_AMT,0))
								,@dec_GROSS_RATE = SUM(COALESCE(AD.EXT_NET_AMT,0) + COALESCE(AD.COMM_AMT,0))
								,@dec_NETCHARGES = SUM(COALESCE(AD.NETCHARGES,0))
								,@dec_NET_AMT = SUM(COALESCE(AD.EXT_NET_AMT,0))
								,@dec_COMM_AMT = SUM(COALESCE(AD.COMM_AMT,0))
								,@dec_VENDOR_TAX = SUM(COALESCE(AD.VENDOR_TAX,0))
								,@dec_STATE_TAX = SUM(COALESCE(AD.STATE_TAX,0))
								,@dec_COUNTY_TAX = SUM(COALESCE(AD.COUNTY_TAX,0))
								,@dec_CITY_TAX = SUM(COALESCE(AD.CITY_TAX,0))
								,@dec_LINE_TOTAL = SUM(COALESCE(AD.LINE_TOTAL,0))
								,@dec_REBATE_AMT = SUM(COALESCE(AD.REBATE_AMT,0))
								,@dec_DISCOUNT_AMT = SUM(COALESCE(AD.DISC_AMT,0))
								,@dec_IMPRESSIONS = SUM(COALESCE(AD.TOTAL_SPOTS,0))
								,@dec_AP_NET_AMT = SUM(COALESCE((AD.EXT_NET_AMT), 0) + COALESCE((AD.NETCHARGES), 0) + COALESCE((AD.VENDOR_TAX), 0) + COALESCE((AD.DISC_AMT), 0))
								,@dec_ORDER_QTY = SUM(COALESCE(AD.TOTAL_SPOTS, 0))
								,@dec_MARKUP_PCT = MAX(COALESCE(D.MARKUP_PCT,0))
								,@TAX_RESALE = MAX(AD.TAX_RESALE), @TAXAPPLYC = MAX(AD.TAXAPPLYC), @TAXAPPLYLN = MAX(AD.TAXAPPLYLN), @TAXAPPLYLND = MAX(AD.TAXAPPLYLND)
								,@TAXAPPLYNC =MAX(AD.TAXAPPLYNC), @TAXAPPLYR = MAX(AD.TAXAPPLYR)--, @TAXAPPLYAI = MAX(AD.TAXAPPLYAI)
								,@AP_TAX_CODE = MAX(AD.TAX_CODE)
								,@dec_CITY_PCT = MAX(AD.TAX_CITY_PCT), @dec_COUNTY_PCT = MAX(AD.TAX_COUNTY_PCT), @dec_STATE_PCT = MAX(AD.TAX_STATE_PCT)
						FROM AP_RADIO AD, RADIO_DETAIL D
						WHERE	AD.ORDER_NBR = D.ORDER_NBR AND AD.ORDER_LINE_NBR = D.LINE_NBR AND
										AD.ORDER_NBR = @order_nbr AND AD.ORDER_LINE_NBR = @line_nbr AND D.ACTIVE_REV = 1 AND D.BILL_TYPE_FLAG <> 1 AND	
										(AD.MODIFY_DELETE IS NULL OR AD.MODIFY_DELETE = 0);						
			END
			/*
			ldec_NET_AMT = adec_net	
			ldec_NETCHARGES = adec_nc
			ldec_VENDOR_TAX = adec_ven_tax
			ldec_DISCOUNT_AMT = adec_disc

			SELECT NET_GROSS INTO :ll_net_gross
			FROM NEWSPAPER_HEADER
			WHERE  ORDER_NBR = :ll_order_nbr;				
			SELECT TAX_STATE_PCT, TAX_COUNTY_PCT, TAX_CITY_PCT, 
				ADDL_CHARGE, MARKUP_PCT, REBATE_PCT, TAX_RESALE, 
				TAXAPPLYC, TAXAPPLYLN, TAXAPPLYND, 
				TAXAPPLYNC, TAXAPPLYR, TAXAPPLYAI
			INTO   :ldec_state_pct, :ldec_county_pct, :ldec_city_pct, 
				:ldec_addl_charge,:ldec_markup_pct, :ldec_rebate_pct,
				:ll_TAX_RESALE, :ll_TAXAPPLYC, :ll_TAXAPPLYLN, :ll_TAXAPPLYND, 
				:ll_TAXAPPLYNC, :ll_TAXAPPLYR, :ll_TAXAPPLYAI
			FROM   NEWSPAPER_DETAIL
			WHERE  ORDER_NBR = :ll_order_nbr AND
						LINE_NBR = :ll_line_nbr AND ACTIVE_REV = 1;
			*/
			/* Calculate Comm since not accurate in AP due to rate charges & discount
			CHOOSE CASE as_media_type
				CASE "M", "N"		
					ldec_markup_pct = ldec_markup_pct / 100
					ldec_ap_comm_amt = Round(ldec_markup_pct * ldec_NET_AMT, 2)
				//PJH - Per EC the commission is wrong in AP if the order is Net and there is a Discount
				CASE "O", "I"  //Has no rate charges so comm should be ok in AP
					//ldec_ap_comm_amt = hWndApprovalGrid.object.comm_amt[ll_row]
					ldec_markup_pct = ldec_markup_pct / 100
					ldec_ap_comm_amt = Round(ldec_markup_pct * ldec_NET_AMT, 2)				
			END CHOOSE	
			
			If ll_bill_type = 1 OR ll_bill_type = 3 Then
				ldec_ap_rebate_amt = Round(ldec_rebate_pct * (ldec_NET_AMT + ldec_ap_comm_amt) * (-1), 2)
			End If					
			*/

			ELSE IF @media_type = 'N' BEGIN

				SELECT @dec_NET_RATE = SUM(COALESCE(AD.NET_AMT,0))
								,@dec_GROSS_RATE = SUM(COALESCE(AD.GROSS_AMT,0))
								,@dec_NETCHARGES = SUM(COALESCE(AD.NETCHARGES,0))
								,@dec_NET_AMT = SUM(COALESCE(AD.NET_AMT,0))
								,@dec_GROSS_AMT = SUM(COALESCE(AD.GROSS_AMT,0))
								,@dec_COMM_AMT = SUM(COALESCE(AD.COMM_AMT,0))
								,@dec_VENDOR_TAX = SUM(COALESCE(AD.VENDOR_TAX,0))
								,@dec_STATE_TAX = SUM(COALESCE(AD.STATE_TAX,0))
								,@dec_COUNTY_TAX = SUM(COALESCE(AD.COUNTY_TAX,0))
								,@dec_CITY_TAX = SUM(COALESCE(AD.CITY_TAX,0))
								,@dec_LINE_TOTAL = SUM(COALESCE(AD.LINE_TOTAL,0))
								,@dec_REBATE_AMT = SUM(COALESCE(AD.REBATE_AMT,0))
								,@dec_DISCOUNT_AMT = SUM(COALESCE(AD.DISCOUNT_LN,0)) +  SUM(COALESCE(AD.DISCOUNT_NC,0))
								,@dec_AP_PRINT_LINES = SUM(COALESCE(AD.PRINT_LINES,0))
								,@dec_AP_PRINT_COLUMNS = SUM(COALESCE(D.PRINT_COLUMNS,0))
								,@dec_AP_PRINT_INCHES = SUM(COALESCE(D.PRINT_INCHES,0))
								,@dec_AP_NET_AMT = SUM(COALESCE((AD.NET_AMT), 0) + COALESCE((AD.NETCHARGES), 0) + COALESCE((AD.VENDOR_TAX), 0)) + SUM(COALESCE(AD.DISCOUNT_LN,0)) +  SUM(COALESCE(AD.DISCOUNT_NC,0))
								,@dec_PROD_CHARGE = 0 /*N/A*/
								,@dec_COLOR_NET = SUM(COALESCE(AD.COLOR_NET_AMT,0))
								,@dec_COLOR_GROSS = SUM(COALESCE(AD.COLOR_GROSS_AMT,0))
								,@dec_ORDER_QTY = SUM(COALESCE(AD.PRINT_LINES,0))
								,@TAX_RESALE = MAX(AD.TAX_RESALE), @TAXAPPLYC = MAX(AD.TAXAPPLYC), @TAXAPPLYLN = MAX(AD.TAXAPPLYLN), @TAXAPPLYLND = MAX(AD.TAXAPPLYLND)
								,@TAXAPPLYNC =MAX(AD.TAXAPPLYNC), @TAXAPPLYR = MAX(AD.TAXAPPLYR)--, @TAXAPPLYAI = MAX(AD.TAXAPPLYAI)
								,@AP_TAX_CODE = MAX(AD.TAX_CODE)
								,@dec_CITY_PCT = MAX(AD.TAX_CITY_PCT), @dec_COUNTY_PCT = MAX(AD.TAX_COUNTY_PCT), @dec_STATE_PCT = MAX(AD.TAX_STATE_PCT)
						FROM AP_NEWSPAPER AD, NEWSPAPER_DETAIL D
						WHERE	AD.ORDER_NBR = D.ORDER_NBR AND AD.ORDER_LINE_NBR = D.LINE_NBR AND
										AD.ORDER_NBR = @order_nbr  AND D.LINE_NBR = @line_nbr AND D.ACTIVE_REV = 1 AND D.BILL_TYPE_FLAG <> 1 AND
									(AD.MODIFY_DELETE IS NULL OR AD.MODIFY_DELETE = 0);	

				IF @dec_AP_PRINT_LINES = 0
					IF @dec_AP_PRINT_COLUMNS > 0 AND @dec_AP_PRINT_INCHES > 0
						SET @dec_AP_PRINT_LINES = @dec_AP_PRINT_COLUMNS * @dec_AP_PRINT_INCHES

				SET @dec_ORDER_QTY = @dec_AP_PRINT_LINES

				--IF @dec_AP_PRINT_LINES > 0 BEGIN
				--	IF @COST_TYPE = 'CPM' BEGIN
				--		SET @dec_TEMP_RATE = @dec_TEMP_RATE * 1000
				--		/* PJH set all rates here */
				--		SET @dec_NET_BASE_RATE = @dec_NET_BASE_RATE * 1000
				--		SET @dec_NEW_NET_RATE = @dec_NEW_NET_RATE * 1000
				--		SET @dec_GROSS_BASE_RATE = @dec_GROSS_BASE_RATE * 1000
				--		SET @dec_NEW_GROSS_RATE = @dec_NEW_GROSS_RATE * 1000	
				--	END
				--	SET @dec_NET_RATE = @dec_NET_RATE / @dec_AP_PRINT_LINES
				--	SET @dec_GROSS_RATE = @dec_GROSS_RATE / @dec_AP_PRINT_LINES
				--	SET @dec_TEMP_RATE = @dec_NET_RATE / @dec_AP_PRINT_LINES
				--	--NET_RATE	GROSS_RATE	FLAT_NET	FLAT_GROSS
				--END
			END
			ELSE IF @media_type = 'M' BEGIN					
				SELECT @dec_NET_RATE = SUM(COALESCE(AD.NET_PLUS,0))						/**********/
								,@dec_GROSS_RATE = SUM(COALESCE(AD.GROSS_PLUS,0))
								,@dec_NET_RATE = SUM(COALESCE(AD.NET_PLUS,0))
								,@dec_NETCHARGES = SUM(COALESCE(AD.NETCHARGES,0))
								,@dec_NET_AMT = SUM(COALESCE(AD.NET_AMT,0))
								,@dec_GROSS_AMT = SUM(COALESCE(AD.GROSS_AMT,0))
								,@dec_COMM_AMT = SUM(COALESCE(AD.COMM_AMT,0))
								,@dec_VENDOR_TAX = SUM(COALESCE(AD.VENDOR_TAX,0))
								,@dec_STATE_TAX = SUM(COALESCE(AD.STATE_TAX,0))
								,@dec_COUNTY_TAX = SUM(COALESCE(AD.COUNTY_TAX,0))
								,@dec_CITY_TAX = SUM(COALESCE(AD.CITY_TAX,0))
								,@dec_LINE_TOTAL = SUM(COALESCE(AD.LINE_TOTAL,0))
								,@dec_REBATE_AMT = SUM(COALESCE(AD.REBATE_AMT,0))
								,@dec_DISCOUNT_AMT = SUM(COALESCE(AD.DISCOUNT_LN,0)) +  SUM(COALESCE(AD.DISCOUNT_NC,0))
								,@dec_AP_NET_AMT = SUM(COALESCE((AD.NET_AMT), 0) + COALESCE((AD.NETCHARGES), 0) + COALESCE((AD.VENDOR_TAX), 0)) + SUM(COALESCE(AD.DISCOUNT_LN,0)) +  SUM(COALESCE(AD.DISCOUNT_NC,0))
								,@dec_PROD_CHARGE = 0 /*N/A*/
								,@dec_BLEED_NET = SUM(COALESCE(AD.BLEED_NET_AMT,0))
								,@dec_BLEED_GROSS = SUM(COALESCE(AD.BLEED_GROSS_AMT,0))
								,@dec_COLOR_NET = SUM(COALESCE(AD.COLOR_NET_AMT,0))
								,@dec_COLOR_GROSS = SUM(COALESCE(AD.COLOR_GROSS_AMT,0))
								,@dec_PREMIUM_NET = SUM(COALESCE(AD.PREMIUM_NET_AMT,0))
								,@dec_PREMIUM_GROSS = SUM(COALESCE(AD.PREMIUM_GROSS_AMT,0))
								,@dec_POSITION_NET = SUM(COALESCE(AD.POSITION_NET_AMT,0))
								,@dec_POSITION_GROSS = SUM(COALESCE(AD.POSITION_GROSS_AMT,0))
								,@TAX_RESALE = MAX(AD.TAX_RESALE), @TAXAPPLYC = MAX(AD.TAXAPPLYC), @TAXAPPLYLN = MAX(AD.TAXAPPLYLN), @TAXAPPLYLND = MAX(AD.TAXAPPLYLND)
								,@TAXAPPLYNC =MAX(AD.TAXAPPLYNC), @TAXAPPLYR = MAX(AD.TAXAPPLYR)--, @TAXAPPLYAI = MAX(AD.TAXAPPLYAI)
								,@AP_TAX_CODE = MAX(AD.TAX_CODE)
								,@dec_CITY_PCT = MAX(AD.TAX_CITY_PCT), @dec_COUNTY_PCT = MAX(AD.TAX_COUNTY_PCT), @dec_STATE_PCT = MAX(AD.TAX_STATE_PCT)
						FROM AP_MAGAZINE AD, MAGAZINE_DETAIL D
						WHERE	AD.ORDER_NBR = D.ORDER_NBR AND AD.ORDER_LINE_NBR = D.LINE_NBR AND
										AD.ORDER_NBR = @order_nbr  AND D.LINE_NBR = @line_nbr AND D.ACTIVE_REV = 1 AND D.BILL_TYPE_FLAG <> 1 AND
									(AD.MODIFY_DELETE IS NULL OR AD.MODIFY_DELETE = 0);	

				--SELECT @dec_NET_RATE										/* DEBUG */
				--				,@dec_GROSS_RATE
				--				,@dec_NETCHARGES
				--				,@dec_NET_AMT
				--				,@dec_COMM_AMT
				--				,@dec_VENDOR_TAX
				--				,@dec_STATE_TAX
				--				,@dec_COUNTY_TAX
				--				,@dec_CITY_TAX
				--				,@dec_LINE_TOTAL
				--				,@dec_REBATE_AMT
				--				,@dec_DISCOUNT_AMT
				--				,@dec_AP_NET_AMT
				--				,@dec_PROD_CHARGE
				--				,@dec_BLEED_NET
				--				,@dec_COLOR_NET
				--				,@dec_PREMIUM_NET
				--				,@dec_POSITION_NET


			END
			ELSE IF @media_type = 'O' BEGIN
				SELECT @dec_NET_RATE = SUM(COALESCE(AD.NET_AMT,0))
								,@dec_GROSS_RATE = SUM(COALESCE(AD.NET_AMT,0)) + SUM(COALESCE(AD.COMM_AMT,0))
								,@dec_NETCHARGES = SUM(COALESCE(AD.NETCHARGES,0))
								,@dec_NET_AMT = SUM(COALESCE(AD.NET_AMT,0))
								,@dec_COMM_AMT = SUM(COALESCE(AD.COMM_AMT,0))
								,@dec_VENDOR_TAX = SUM(COALESCE(AD.VENDOR_TAX,0))
								,@dec_STATE_TAX = SUM(COALESCE(AD.STATE_TAX,0))
								,@dec_COUNTY_TAX = SUM(COALESCE(AD.COUNTY_TAX,0))
								,@dec_CITY_TAX = SUM(COALESCE(AD.CITY_TAX,0))
								,@dec_LINE_TOTAL = SUM(COALESCE(AD.LINE_TOTAL,0))
								,@dec_REBATE_AMT = SUM(COALESCE(AD.REBATE_AMT,0))
								,@dec_DISCOUNT_AMT = SUM(COALESCE(AD.DISCOUNT_AMT,0))
								,@dec_AP_NET_AMT = SUM(COALESCE((AD.NET_AMT), 0) + COALESCE((AD.NETCHARGES), 0) + COALESCE((AD.VENDOR_TAX), 0) + COALESCE((AD.DISCOUNT_AMT), 0))
								,@TAX_RESALE = MAX(AD.TAX_RESALE), @TAXAPPLYC = MAX(AD.TAXAPPLYC), @TAXAPPLYLN = MAX(AD.TAXAPPLYLN), @TAXAPPLYLND = MAX(AD.TAXAPPLYLND)
								,@TAXAPPLYNC =MAX(AD.TAXAPPLYNC), @TAXAPPLYR = MAX(AD.TAXAPPLYR)--, @TAXAPPLYAI = MAX(AD.TAXAPPLYAI)
								,@AP_TAX_CODE = MAX(AD.TAX_CODE)
								,@dec_CITY_PCT = MAX(AD.TAX_CITY_PCT), @dec_COUNTY_PCT = MAX(AD.TAX_COUNTY_PCT), @dec_STATE_PCT = MAX(AD.TAX_STATE_PCT)
						FROM AP_OUTDOOR AD, OUTDOOR_DETAIL D
						WHERE	AD.ORDER_NBR = D.ORDER_NBR AND AD.ORDER_LINE_NBR = D.LINE_NBR AND
										AD.ORDER_NBR = @order_nbr  AND D.LINE_NBR = @line_nbr AND D.ACTIVE_REV = 1 AND D.BILL_TYPE_FLAG <> 1 AND
									(AD.MODIFY_DELETE IS NULL OR AD.MODIFY_DELETE = 0);	
			END
		END		
		
		SECOND_PASS:
		
		SET @dec_NET_RATE = COALESCE(@dec_NET_RATE, 0)
		SET @dec_GROSS_RATE = COALESCE(@dec_GROSS_RATE, 0)
		SET @dec_NETCHARGES = COALESCE(@dec_NETCHARGES, 0)
		SET @dec_NET_AMT = COALESCE(@dec_NET_AMT, 0)
		SET @dec_COMM_AMT = COALESCE(@dec_COMM_AMT, 0)		
		SET @dec_VENDOR_TAX = COALESCE(@dec_VENDOR_TAX, 0)
		SET @dec_STATE_TAX = COALESCE(@dec_STATE_TAX, 0)
		SET @dec_COUNTY_TAX = COALESCE(@dec_COUNTY_TAX, 0)
		SET @dec_CITY_TAX = COALESCE(@dec_CITY_TAX, 0)
		SET @dec_LINE_TOTAL = COALESCE(@dec_LINE_TOTAL, 0)
		SET @dec_REBATE_AMT = COALESCE(@dec_REBATE_AMT, 0)
		SET @dec_DISCOUNT_AMT = COALESCE(@dec_DISCOUNT_AMT, 0)
		SET @dec_IMPRESSIONS = COALESCE(@dec_IMPRESSIONS, 0)
		SET @dec_AP_NET_AMT = COALESCE(@dec_AP_NET_AMT, 0)
		
		SET @dec_ADDL_CHARGE = COALESCE(@dec_O_ADDL_CHARGE, 0)
		
		/** If this is the New line for the diiference between Order & AP */
		IF @DIFFERENCE_LINE = 1 BEGIN
			/*  SET DIFFERECE BETWEEN ORDER & AP HERE & RECALC  */			
			
			SELECT @dec_NET_RATE = NULL --@dec_O_NET_RATE
								,@dec_GROSS_RATE = NULL --@dec_O_GROSS_RATE
								,@dec_NET_AMT = @dec_O_EXT_NET_AMT - @dec_NET_AMT
								,@dec_COMM_AMT = @dec_O_COMM_AMT - @dec_COMM_AMT
								,@dec_NETCHARGES = @dec_O_NETCHARGE - @dec_NETCHARGES								
								,@dec_VENDOR_TAX = NULL --@dec_O_NON_RESALE_AMT - @dec_VENDOR_TAX
								,@dec_STATE_TAX = NULL
								,@dec_COUNTY_TAX = NULL
								,@dec_CITY_TAX = NULL
								,@dec_LINE_TOTAL = NULL --@dec_O_EXT_NET_AMT - @dec_LINE_TOTAL
								,@dec_REBATE_AMT = @dec_O_REBATE_AMT - @dec_REBATE_AMT
								,@dec_DISCOUNT_AMT = @dec_O_DISCOUNT_AMT - @dec_DISCOUNT_AMT
								,@dec_IMPRESSIONS = @dec_ORDER_QTY - @dec_IMPRESSIONS
								
			--SELECT @COST_TYPE '@COST_TYPE', @NET_GROSS '@NET_GROSS', @dec_NET_AMT '@dec_NET_AMT', @dec_IMPRESSIONS '@dec_IMPRESSIONS', 
			--					@dec_O_EXT_NET_AMT '@dec_O_EXT_NET_AMT', @dec_O_COMM_AMT '@dec_O_COMM_AMT' 
			--SELECT @dec_O_ADDL_CHARGE '@dec_O_ADDL_CHARGE', @dec_O_NETCHARGE '@dec_O_NETCHARGE', @dec_NETCHARGES '@dec_NETCHARGES'								
		END

		IF @reconcile_by = 'L' AND @media_type = 'M' BEGIN  /**********/
			SET @dec_GROSS_AMT = @dec_GROSS_AMT /* No Chg */
		END
		ELSE BEGIN
			SET @dec_GROSS_AMT = @dec_NET_AMT + @dec_COMM_AMT
		END	

		IF @DIFFERENCE_LINE = 0 BEGIN
			SET @dec_DISCOUNT_AMT_ABS = ABS(@dec_DISCOUNT_AMT)
		END
		
		--IF @dec_IMPRESSIONS = 0 BEGIN
		--	SET @dec_IMPRESSIONS = 1	
		--END
			
		SET @CPM = 1
		
		--SELECT @COST_TYPE '@COST_TYPE', @NET_GROSS '@NET_GROSS', @dec_NET_AMT '@dec_NET_AMT', @dec_IMPRESSIONS '@dec_IMPRESSIONS'

		IF @COST_TYPE = 'NA'
			BEGIN
				SET @dec_NEW_GROSS_RATE = @dec_GROSS_AMT
				SET @dec_GROSS_BASE_RATE = @dec_GROSS_AMT
				SET @dec_NEW_NET_RATE = @dec_NET_AMT
				SET @dec_NET_BASE_RATE = @dec_NET_AMT				
			
			
				IF @NET_GROSS = 1 --AND (@DIFFERENCE_LINE = 0) /** NOT DIFF LINE **/
					BEGIN
						SET @dec_NEW_RATE_AMT = @dec_GROSS_AMT
						SET @dec_NEW_GROSS_RATE = @dec_GROSS_AMT
						SET @dec_GROSS_BASE_RATE = @dec_GROSS_AMT
					END
				ELSE 
					BEGIN
						SET @dec_NEW_RATE_AMT = @dec_NET_AMT
						SET @dec_NEW_NET_RATE = @dec_NET_AMT
						SET @dec_NET_BASE_RATE = @dec_NET_AMT
					END
					
				SET @dec_RECONCILE_RATE = @dec_NEW_RATE_AMT
				--SET @dec_TEMP_RATE = @dec_NEW_RATE_AMT
					
				IF @dec_IMPRESSIONS <> 0 AND @dec_IMPRESSIONS IS NOT NULL
					BEGIN
						--SET @dec_ACTUAL_IMPRESSIONS = @dec_IMPRESSIONS
						SET @dec_GUARANTEED_IMPRESSIONS = @dec_IMPRESSIONS
					END

				SET @dec_CONTRACT_QTY = @dec_ORDER_QTY
			END
		ELSE 
			BEGIN
				SET @dec_NEW_GROSS_RATE = @dec_GROSS_AMT
				SET @dec_GROSS_BASE_RATE = @dec_GROSS_AMT
				SET @dec_NEW_NET_RATE = @dec_NET_AMT
				SET @dec_NET_BASE_RATE = @dec_NET_AMT					
				
				IF @NET_GROSS = 1 --AND (@DIFFERENCE_LINE = 0) /** NOT DIFF LINE **/
					BEGIN
						SET @dec_NEW_RATE_AMT = @dec_GROSS_AMT
						--SET @dec_TEMP_RATE = @dec_GROSS_RATE
						SET @dec_NEW_GROSS_RATE = @dec_GROSS_AMT
					END
				ELSE 
					BEGIN
						SET @dec_NEW_RATE_AMT = @dec_NET_AMT
						--SET @dec_TEMP_RATE = @dec_NET_RATE
						SET @dec_NEW_NET_RATE = @dec_NET_AMT
					END
					
				SET @dec_RECONCILE_RATE = @dec_NEW_RATE_AMT
				SET @dec_TEMP_RATE = @dec_NEW_RATE_AMT
				
				IF @media_type NOT IN ('I') BEGIN
					SELECT @dec_IMPRESSIONS = COALESCE(@dec_IMPRESSIONS, 0)
					IF @dec_ORDER_QTY > 0 BEGIN
						SET @dec_IMPRESSIONS = @dec_ORDER_QTY
					END 
				END
				ELSE BEGIN
					SELECT @dec_IMPRESSIONS = COALESCE(@dec_IMPRESSIONS, @dec_GUARANTEED_IMPRESSIONS)  
				END
				
				If @dec_IMPRESSIONS <> 0  AND @dec_IMPRESSIONS IS NOT NULL
					BEGIN 
						SET @dec_TEMP_RATE = @dec_TEMP_RATE / @dec_IMPRESSIONS
						/* PJH set all rates here */
						SET @dec_GROSS_BASE_RATE = @dec_GROSS_BASE_RATE / @dec_IMPRESSIONS
						SET @dec_NEW_GROSS_RATE = @dec_NEW_GROSS_RATE / @dec_IMPRESSIONS
						SET @dec_NET_BASE_RATE = @dec_NET_BASE_RATE / @dec_IMPRESSIONS
						SET @dec_NEW_NET_RATE = @dec_NEW_NET_RATE / @dec_IMPRESSIONS						
					END
				Else
					BEGIN
						SET @dec_IMPRESSIONS = 0
						SET @CPM = 0
					END
					
				--SELECT @dec_TEMP_RATE '@dec_TEMP_RATE', @dec_NEW_GROSS_RATE '@dec_NEW_GROSS_RATE', @dec_NEW_NET_RATE '@dec_NEW_NET_RATE', /***************** DEBUG **************/
				--				@dec_NET_BASE_RATE '@dec_NET_BASE_RATE', @dec_GROSS_BASE_RATE' @dec_GROSS_BASE_RATE'
								
				SET @dec_ACTUAL_IMPRESSIONS = @dec_IMPRESSIONS   --Use for GUARANTEED on new line
				SET @dec_ACTUAL_IMPRESSIONS = COALESCE(@dec_ACTUAL_IMPRESSIONS, 0)

				IF @COST_TYPE IN ('CPM') AND @CPM = 1 
				BEGIN
					SET @dec_TEMP_RATE = @dec_TEMP_RATE * 1000
					/* PJH set all rates here */
					SET @dec_NET_BASE_RATE = @dec_NET_BASE_RATE * 1000
					SET @dec_NEW_NET_RATE = @dec_NEW_NET_RATE * 1000
					SET @dec_GROSS_BASE_RATE = @dec_GROSS_BASE_RATE * 1000
					SET @dec_NEW_GROSS_RATE = @dec_NEW_GROSS_RATE * 1000	
					SET @dec_CONTRACT_QTY = @dec_ORDER_QTY / 1000
				END
				ELSE BEGIN
					SET @dec_CONTRACT_QTY = @dec_ORDER_QTY
				END
				
				--IF @NET_GROSS = 1 
				--	BEGIN
				--		SET @dec_GROSS_BASE_RATE = @dec_TEMP_RATE
				--		SET @dec_NEW_GROSS_RATE = @dec_TEMP_RATE
				--	END
				--ELSE 
				--	BEGIN
				--		SET @dec_NET_BASE_RATE = @dec_TEMP_RATE
				--		SET @dec_NEW_NET_RATE = @dec_TEMP_RATE
				--	END
				
			END

			/* PJH 06/12/2020 - ROUND from 14,8 to 14,4 */
			SET @dec_NET_BASE_RATE = ROUND(@dec_NET_BASE_RATE,4) 
			SET @dec_GROSS_BASE_RATE = ROUND(@dec_GROSS_BASE_RATE,4)
			SET @dec_NEW_NET_RATE = ROUND(@dec_NEW_NET_RATE,4) 
			SET @dec_NEW_GROSS_RATE = ROUND(@dec_NEW_GROSS_RATE,4)
			SET @dec_RECONCILE_RATE = ROUND(@dec_RECONCILE_RATE,4)
			SET @dec_TEMP_RATE = ROUND(@dec_TEMP_RATE,4)
			
			SET @dec_COST_RATE = @dec_TEMP_RATE
			
			--SELECT @dec_TEMP_RATE '@dec_TEMP_RATE', @dec_NEW_GROSS_RATE '@dec_NEW_GROSS_RATE', @dec_NEW_NET_RATE '@dec_NEW_NET_RATE', @dec_COST_RATE '@dec_COST_RATE' /***************** DEBUG **************/
			
			/* Get max line number - For Roll Forward */	
			IF @media_type = 'I' BEGIN
				SELECT @MAX_LINE_NBR = MAX(D.LINE_NBR)
				FROM INTERNET_HEADER H,INTERNET_DETAIL	D
				WHERE H.ORDER_NBR = D.ORDER_NBR AND H.ORDER_NBR = @order_nbr;	
			END
			ELSE IF @media_type = 'T' BEGIN
				SELECT @MAX_LINE_NBR = MAX(D.LINE_NBR)
				FROM TV_DETAIL	D
				WHERE D.ORDER_NBR = @order_nbr;				
			END
			ELSE IF @media_type = 'R' BEGIN
				SELECT @MAX_LINE_NBR = MAX(D.LINE_NBR)
				FROM RADIO_DETAIL	D
				WHERE D.ORDER_NBR = @order_nbr;					
			END						
			
			--SELECT @dec_NET_AMT '@dec_NET_AMT',	 @dec_COMM_AMT '@dec_COMM_AMT',	@dec_MARKUP_PCT '@dec_MARKUP_PCT',
			--			@dec_NETCHARGES '@dec_NETCHARGES', @dec_DISCOUNT_AMT '@dec_DISCOUNT_AMT'  /***************** DEBUG **************/
			
			IF @DIFFERENCE_LINE = 0 BEGIN  /** Only on first pass **/
				SET @dec_MARKUP_PCT = @dec_MARKUP_PCT / 100
			END
			
			IF @media_type IN ('I') BEGIN
				SET @dec_COMM_AMT = Round(@dec_MARKUP_PCT * @dec_NET_AMT, 2)
			/* ELSE	- Use AP Comm Amt */
			END
			
			IF @UNITS = 'D' BEGIN
					--per insertion rate
					SET @dec_NETCHARGES = @dec_NETCHARGES / @QUANTITY
					SET @dec_DISCOUNT_AMT = @dec_DISCOUNT_AMT / @QUANTITY
			END			
			
			--SELECT @dec_MARKUP_PCT '@dec_MARKUP_PCT', @dec_COMM_PCT '@dec_COMM_PCT', @dec_DISCOUNT_PCT '@dec_DISCOUNT_PCT'
						
		/** LOGIC FROM uf_calc_out_inet() **/		
		
		/* CALC_TOTALS: ***********************************************************/

		--GET_DEF_TAX_INFO:

		IF  @DIFFERENCE_LINE = 0 BEGIN

			IF @reconcile_by <> 'L' BEGIN

			--GET_VENDOR_TAX:

				SELECT	@V_USE_TAX_FLAGS = USE_TAX_FLAGS , 
								@V_TAXAPPLYC = COALESCE(TAXAPPLYC,  0), 	@V_TAXAPPLYLN = COALESCE(TAXAPPLYLN,  0), @V_TAXAPPLYND = COALESCE(TAXAPPLYND,  0), 
								@V_TAXAPPLYNC = COALESCE(TAXAPPLYNC,  0),	@V_TAXAPPLYR = COALESCE(TAXAPPLYR,  0), @V_TAXAPPLYAI = COALESCE(TAXAPPLYAI,  0),
								@V_MATL_CLOSE = COALESCE(MATL_CLOSE, 0), @V_SPACE_CLOSE = COALESCE(SPACE_CLOSE, 0)
				FROM		VENDOR
				WHERE	VN_CODE = @VN_CODE;



			--GET_PRODUCT_INFO:

				IF  @media_type = 'I' BEGIN
					SELECT	 @P_USE_TAX_FLAGS = USE_TAX_FLAGS_I, 
								@P_TAXAPPLYC = COALESCE(TAXAPPLYC_I,  0), 	@P_TAXAPPLYLN = COALESCE(TAXAPPLYLN_I,  0), @P_TAXAPPLYND = COALESCE(TAXAPPLYND_I,  0), 
								@P_TAXAPPLYNC = COALESCE(TAXAPPLYNC_I,  0),	@P_TAXAPPLYR = COALESCE(TAXAPPLYR_I,  0), @P_TAXAPPLYAI = COALESCE(TAXAPPLYAI_I,  0),
								@PRD_MISC_BF_AF = COALESCE(PRD_MISC_BF_AF,  0), @PRD_MISC_DAYS = COALESCE(PRD_MISC_DAYS,  0)	
					FROM		PRODUCT
					WHERE	CL_CODE = @CL_CODE AND
								DIV_CODE = @DIV_CODE AND
								PRD_CODE = @PRD_CODE;
				END
		
				IF (@TAX_CODE) IS NOT NULL BEGIN
					SELECT	@dec_CITY_PCT = TAX_CITY_PERCENT, @dec_COUNTY_PCT = TAX_COUNTY_PERCENT,
									@dec_STATE_PCT = TAX_STATE_PERCENT, @TAX_RESALE = TAX_RESALE
					FROM		 SALES_TAX
					WHERE	 TAX_CODE = @TAX_CODE;
				END

			END

			IF @dec_CITY_PCT IS NULL SET @dec_CITY_PCT = 0
			IF @dec_COUNTY_PCT IS NULL SET @dec_COUNTY_PCT = 0
			IF @dec_STATE_PCT IS NULL SET @dec_STATE_PCT = 0
			IF @TAX_RESALE IS NULL SET @TAX_RESALE = 0
		END

		/** DEBUG ***/
		--IF @QUANTITY > 0 SET @QUANTITY = @QUANTITY
		--ELSE SET @QUANTITY = 0

		IF @media_type = 'I' BEGIN
			SET @roll_forward_new_date = NULL
			SET @new_start_date_d = NULL
			SET @new_end_date_d = NULL
		END
		ELSE IF @media_type = 'T' BEGIN
			SELECT @new_start_date_d = MIN(D.[START_DATE]), @new_end_date_d = MAX(D.END_DATE), 
							@new_close_date_d = MIN(D.CLOSE_DATE), @new_matl_close_date_d = MIN(D.MATL_CLOSE_DATE)
			FROM dbo.TV_DETAIL D                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
			WHERE D.ORDER_NBR = @order_nbr AND 
						RIGHT('00' + CONVERT(VARCHAR(2), D.MONTH_NBR), 2) = @month AND 
						RIGHT('0000' + CONVERT(VARCHAR(4), D.YEAR_NBR), 4) = @year AND D.ACTIVE_REV=1 AND D.BILL_TYPE_FLAG <> 1 AND
						D.LINE_CANCELLED IS NULL;	
	
		END
		ELSE IF @media_type = 'R' BEGIN
			SELECT @new_start_date_d = MIN(D.[START_DATE]), @new_end_date_d = MAX(D.END_DATE), 
							@new_close_date_d = MIN(D.CLOSE_DATE), @new_matl_close_date_d = MIN(D.MATL_CLOSE_DATE)
			FROM dbo.RADIO_DETAIL D                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
			WHERE D.ORDER_NBR = @order_nbr AND 
						RIGHT('00' + CONVERT(VARCHAR(2), D.MONTH_NBR), 2) = @month AND 
						RIGHT('0000' + CONVERT(VARCHAR(4), D.YEAR_NBR), 4) = @year AND D.ACTIVE_REV=1 AND D.BILL_TYPE_FLAG <> 1 AND
						D.LINE_CANCELLED IS NULL;	
	
		END

		 --SELECT @new_start_date_d , @new_end_date_d ,	@new_close_date_d , @new_matl_close_date_d  /***************************************** DEBUG *************************/

		IF @reconcile_by = 'O' BEGIN
			SELECT @new_start_date_d = MIN(START_DATE), @new_end_date_d = MAX(END_DATE)
			FROM dbo.INTERNET_DETAIL D                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
			WHERE D.ORDER_NBR = @order_nbr AND 
						D.ACTIVE_REV = 1 AND D.BILL_TYPE_FLAG <> 1 AND
						D.LINE_CANCELLED IS NULL;	
	
			IF @V_MATL_CLOSE > 0 BEGIN
				SET @new_matl_close_date_d = dateadd(d,-@V_MATL_CLOSE,@new_start_date_d)
			END
			ELSE BEGIN
				SET @new_matl_close_date_d = @new_start_date_d
			END

			IF @V_SPACE_CLOSE > 0 BEGIN
				SET @new_close_date_d = dateadd(d,-@V_SPACE_CLOSE,@new_start_date_d)
			END
			ELSE BEGIN
				SET @new_close_date_d = @new_start_date_d
			END			
		END
		ELSE IF (@reconcile_by = 'M' OR @reconcile_by = 'L') BEGIN
			/*  If Roll Forward */
			IF @reconcile_method = 'R' BEGIN
				--SELECT @roll_forward_month --------------------------------------------------------------------
				IF @roll_forward_month IS NOT NULL BEGIN
					SET @roll_forward_month_s = RIGHT('00' + CAST(@roll_forward_month AS varchar(2)), 2)
					SET @roll_forward_year_n = CAST(@year AS int)
					--SELECT @roll_forward_month_s, @roll_forward_year_n --------------------------------------------------------------------
					IF @roll_forward_month_s < @month  BEGIN
						SET @roll_forward_year_n = @roll_forward_year_n + 1
					END
					SET @roll_forward_year_s = CAST(@roll_forward_year_n AS varchar(4))
					SET @roll_forward_new_date = @roll_forward_month_s + '-' + '01' + '-' + @roll_forward_year_s

					IF  (@media_type = 'M' OR @media_type = 'N')  AND @UNITS <> 'D' BEGIN
						SET @new_start_date_d = CAST(@roll_forward_new_date AS smalldatetime)
					END
					ELSE BEGIN
					--SELECT @UNITS '@UNITS'  --------------------------------------------------------------------
						SET @new_start_date_d = CAST(@roll_forward_new_date AS smalldatetime)
						IF @UNITS  = 'W' BEGIN
							SET @new_end_date_d = dateadd(d,7,@new_start_date_d)
							SET @new_end_date_d = dateadd(d,-1,@new_end_date_d)
							END
						ELSE IF @UNITS  = 'M' BEGIN
						--SELECT @new_start_date_d, @roll_forward_new_date   --------------------------------------------------------------------
							SET @new_end_date_d = dateadd(m,1,@new_start_date_d)
							SET @new_end_date_d = dateadd(d,-1,@new_end_date_d)			
							END
						ELSE IF @UNITS  = 'D' BEGIN
						--SELECT @UNITS '@UNITS2'   --------------------------------------------------------------------
							SET @new_end_date_d = dateadd(d,1,@new_start_date_d)
							--SET @new_end_date_d = dateadd(d,-1,@new_end_date_d)					
							END
						--ELSE IF @UNITS  = 'CM' BEGIN
						--	--calendar month
						--	ld_end_date = uf_get_end_date_bc( ld_orig_date )
						--	END
						--ELSE IF @UNITS  = 'BM' BEGIN
						--	--broadcast month
						--	/* get the end of the broadcast month in relation to the start date */
						--	ld_end_date = uf_get_end_date_bc( ld_orig_date )
						--	END
						--ELSE IF @UNITS  = 'DB' BEGIN
						--	--broadcast daily
						--	ld_end_date = ld_orig_date
						--	END
					END
					--@new_matl_close_date_d date, @new_close_date_d
					IF @V_MATL_CLOSE > 0 BEGIN
						SET @new_matl_close_date_d = dateadd(d,-@V_MATL_CLOSE,@new_start_date_d)
					END
					ELSE BEGIN
						SET @new_matl_close_date_d = @new_start_date_d
					END
			
					IF @V_SPACE_CLOSE > 0 BEGIN
						SET @new_close_date_d = dateadd(d,-@V_SPACE_CLOSE,@new_start_date_d)
					END
					ELSE BEGIN
						SET @new_close_date_d = @new_start_date_d
					END	
				END
			END
		END

		/*
		If Not IsNull(ll_prd_bill_days) Then
			// If Before Post Dt then use negative relative date
			If (il_prd_bf_af = 1 OR IsNull(il_prd_bf_af)) OR &
				(il_prd_bf_af = 3) Then //Use Close Date
				ll_prd_bill_days = (-1 * ll_prd_bill_days)
			End If
			ld_date_to_bill = RelativeDate(ad_start_date, ll_prd_bill_days)
		Else
			ld_date_to_bill = ad_start_date
		End If		
		*/
		IF  @DIFFERENCE_LINE = 1 BEGIN
			IF @PRD_MISC_DAYS <> 0 BEGIN
				/* If Before Post Dt then use negative relative date */
				IF @PRD_MISC_BF_AF IS NULL OR @PRD_MISC_BF_AF IN (1,3) BEGIN
					SET @PRD_MISC_DAYS = @PRD_MISC_DAYS * -1
				END
				SET @new_date_to_bill = dateadd(d,@PRD_MISC_DAYS,@new_start_date_d)
			END
			ELSE BEGIN
				SET @new_date_to_bill = @new_start_date_d
			END
		END

		--SELECT @reconcile_method, @new_start_date_d, @new_end_date_d, @new_matl_close_date_d, @new_close_date_d

		--SELECT @dec_AP_BILLING_AMT '@dec_AP_BILLING_AMT',  @dec_NET_AMT '@dec_NET_AMT',  @dec_NEW_GROSS_RATE '@dec_NEW_GROSS_RATE', @dec_NEW_NET_RATE '@dec_NEW_NET_RATE',
		--		@dec_NETCHARGES '@dec_NETCHARGES',  @dec_ADDL_CHARGE '@dec_ADDL_CHARGE', 
		--		@dec_DISCOUNT_AMT '@dec_DISCOUNT_AMT', @dec_COMM_AMT '@dec_COMM_AMT',  @dec_REBATE_AMT '@dec_REBATE_AMT', 
		--		@dec_VENDOR_TAX '@dec_VENDOR_TAX', @dec_RESALE_TAX_tmp '@dec_RESALE_TAX_tmp',  @dec_ADDL_CHARGE_tax '@dec_ADDL_CHARGE_tax'

		IF  @DIFFERENCE_LINE = 0 BEGIN
			SET @dec_COMM_PCT_tmp = @dec_COMM_PCT / 100
			/** Markup already adjusted **/
			SET @dec_MARKUP_PCT_tmp = @dec_MARKUP_PCT

			SET @dec_REBATE_PCT_tmp = @dec_REBATE_PCT / 100
			SET @dec_DISCOUNT_PCT_tmp = @dec_DISCOUNT_PCT / 100
			SET @dec_STATE_PCT_tmp = @dec_STATE_PCT / 100
			SET @dec_COUNTY_PCT_tmp = @dec_COUNTY_PCT / 100
			SET @dec_CITY_PCT_tmp = @dec_CITY_PCT / 100
	
			SET @dec_DISCOUNT_AMT = @dec_DISCOUNT_AMT --@dec_DISCOUNT_AMT_ABS * -1
		--END
		--ELSE BEGIN
			/* Order Disc less AP Disc */ /* DONE in DIFF STEP */
			--SET @dec_DISCOUNT_AMT = @dec_O_DISCOUNT_AMT - @dec_DISCOUNT_AMT
			--SET @dec_NETCHARGES = @dec_O_NETCHARGE - @dec_NETCHARGES
		END

		--SELECT @dec_O_DISCOUNT_AMT '@dec_O_DISCOUNT_AMT', @dec_DISCOUNT_AMT '@dec_DISCOUNT_AMT'

		--SELECT @dec_COMM_PCT_tmp '@dec_COMM_PCT', @dec_MARKUP_PCT_tmp '@dec_MARKUP_PCT', @dec_REBATE_PCT_tmp '@dec_REBATE_PCT', @dec_DISCOUNT_PCT_tmp '@dec_DISCOUNT_PCT',
		--@dec_STATE_PCT_tmp '@dec_STATE_PCT', @dec_COUNTY_PCT_tmp' @dec_COUNTY_PCT', @dec_CITY_PCT_tmp '@dec_CITY_PCT'

		--SET @dec_RECONCILE_RATE = @dec_RECONCILE_RATE

		IF @NET_GROSS = 1 BEGIN --AND (@DIFFERENCE_LINE = 0) /** NOT DIFF LINE **/ 
			/* dec_NEW_GROSS_RATE & @dec_RECONCILE_RATE are ALREADY SET */	
			--SET @dec_NEW_NET_RATE = @dec_NEW_GROSS_RATE - (@dec_NEW_GROSS_RATE * @dec_COMM_PCT_tmp)	
			--SET @dec_NEW_NET_RATE = ROUND(@dec_NEW_NET_RATE, 4)
			----SET @dec_GROSS_AMT = ROUND(@QUANTITY * @dec_NEW_GROSS_RATE, 2)
			--SET @dec_COMM_AMT = ROUND(@dec_COMM_PCT_tmp * @dec_GROSS_AMT, 2)
			--SET @dec_NET_AMT = @dec_GROSS_AMT - @dec_COMM_AMT
			IF @dec_REBATE_PCT_tmp > 0 BEGIN
				SET @dec_REBATE_AMT = ROUND(@dec_REBATE_PCT_tmp * @dec_GROSS_AMT * -1, 2)
			END
		END	
		ELSE BEGIN
			/* dec_NEW_NET_RATE & @dec_RECONCILE_RATE are ALREADY SET */
			--SET @dec_NEW_GROSS_RATE = @dec_NEW_NET_RATE + (@dec_NEW_NET_RATE * @dec_MARKUP_PCT_tmp)
			--SET @dec_NEW_GROSS_RATE = ROUND(@dec_NEW_GROSS_RATE, 4) 
			----SET @dec_NET_AMT = ROUND(@QUANTITY * @dec_NEW_NET_RATE, 2)
			--SET @dec_COMM_AMT = ROUND(@dec_MARKUP_PCT_tmp * @dec_NET_AMT, 2)
			--SET @dec_GROSS_AMT = @dec_NET_AMT + @dec_COMM_AMT
			SET @dec_REBATE_AMT = 0
		END

		IF @DIFFERENCE_LINE = 1 BEGIN
			SET @dec_VENDOR_TAX = 0  --Keep AP NON_RESALE_TAX if Not Difference Line
		END

		--SELECT @dec_AP_BILLING_AMT '@dec_AP_BILLING_AMT',  @dec_NET_AMT '@dec_NET_AMT',  @dec_NEW_GROSS_RATE '@dec_NEW_GROSS_RATE', @dec_NEW_NET_RATE '@dec_NEW_NET_RATE',
		--		@dec_NETCHARGES '@dec_NETCHARGES',  @dec_ADDL_CHARGE '@dec_ADDL_CHARGE', 
		--		@dec_DISCOUNT_AMT '@dec_DISCOUNT_AMT', @dec_COMM_AMT '@dec_COMM_AMT',  @dec_REBATE_AMT '@dec_REBATE_AMT', 
		--		@dec_VENDOR_TAX '@dec_VENDOR_TAX', @dec_RESALE_TAX_tmp '@dec_RESALE_TAX_tmp',  @dec_ADDL_CHARGE_tax '@dec_ADDL_CHARGE_tax'
		
		SET @dec_STATE_TAX = 0
		SET @dec_COUNTY_TAX = 0
		SET @dec_CITY_TAX = 0
		SET @dec_RESALE_TAX_tmp = 0

		SELECT @dec_NETCHARGES = COALESCE(@dec_NETCHARGES, 0)
		SELECT @dec_DISCOUNT_AMT = COALESCE(@dec_DISCOUNT_AMT, 0)
		SELECT @dec_REBATE_AMT = COALESCE(@dec_REBATE_AMT, 0)
		SELECT @dec_ADDL_CHARGE = COALESCE(@dec_ADDL_CHARGE, 0)
		--SELECT @dec_ADDL_CHARGE = COALESCE(@dec_O_ADDL_CHARGE, 0)

		--SELECT @dec_ADDL_CHARGE '@dec_ADDL_CHARGE', @dec_NETCHARGES '@dec_NETCHARGES'

		--SELECT @dec_STATE_TAX '@dec_STATE_TAX', @dec_COUNTY_TAX '@dec_COUNTY_TAX', @dec_CITY_TAX '@dec_CITY_TAX', @dec_RESALE_TAX_tmp '@dec_RESALE_TAX_tmp',
		--				@dec_STATE_PCT '@dec_STATE_PCT', @dec_COUNTY_PCT '@dec_COUNTY_PCT', @dec_CITY_PCT '@dec_CITY_PCT'

		--SELECT @TAXAPPLYLN '@TAXAPPLYLN', @TAXAPPLYLND '@TAXAPPLYLND', @TAXAPPLYNC '@TAXAPPLYNC', @TAXAPPLYC '@TAXAPPLYC',
		--				@TAXAPPLYR '@TAXAPPLYR', @TAXAPPLYR '@TAXAPPLYR', @TAXAPPLYAI '@TAXAPPLYAI'

		IF @reconcile_by = 'L' AND @media_type = 'M' BEGIN  /**********/ 
			IF @TAXAPPLYLN = 1 BEGIN  /* From AP */
				SET @dec_STATE_TAX_tmp = ISNULL(ROUND(@dec_NET_RATE * @dec_STATE_PCT_tmp, 2),0)
				SET @dec_COUNTY_TAX_tmp = ISNULL(ROUND(@dec_NET_RATE * @dec_COUNTY_PCT_tmp, 2),0)
				SET @dec_CITY_TAX_tmp = ISNULL(ROUND(@dec_NET_RATE * @dec_CITY_PCT_tmp, 2),0)
				SET @dec_VENDOR_TAX_tmp = @dec_STATE_TAX_tmp + @dec_COUNTY_TAX_tmp + @dec_CITY_TAX_tmp	
				IF @TAX_RESALE = 1 BEGIN
					SET @dec_STATE_TAX = @dec_STATE_TAX + @dec_STATE_TAX_tmp
					SET @dec_COUNTY_TAX = @dec_COUNTY_TAX + @dec_COUNTY_TAX_tmp
					SET @dec_CITY_TAX = @dec_CITY_TAX + @dec_CITY_TAX_tmp
				END
				ELSE IF @DIFFERENCE_LINE = 1 BEGIN
					SET @dec_VENDOR_TAX = @dec_VENDOR_TAX + @dec_VENDOR_TAX_tmp
				END
			END
		END ELSE BEGIN
			IF @TAXAPPLYLN = 1 BEGIN  /* From AP */
				SET @dec_STATE_TAX_tmp = ISNULL(ROUND(@dec_NET_AMT * @dec_STATE_PCT_tmp, 2),0)
				SET @dec_COUNTY_TAX_tmp = ISNULL(ROUND(@dec_NET_AMT * @dec_COUNTY_PCT_tmp, 2),0)
				SET @dec_CITY_TAX_tmp = ISNULL(ROUND(@dec_NET_AMT * @dec_CITY_PCT_tmp, 2),0)
				SET @dec_VENDOR_TAX_tmp = @dec_STATE_TAX_tmp + @dec_COUNTY_TAX_tmp + @dec_CITY_TAX_tmp	
				IF @TAX_RESALE = 1 BEGIN
					SET @dec_STATE_TAX = @dec_STATE_TAX + @dec_STATE_TAX_tmp
					SET @dec_COUNTY_TAX = @dec_COUNTY_TAX + @dec_COUNTY_TAX_tmp
					SET @dec_CITY_TAX = @dec_CITY_TAX + @dec_CITY_TAX_tmp
				END
				ELSE IF @DIFFERENCE_LINE = 1 BEGIN
					SET @dec_VENDOR_TAX = @dec_VENDOR_TAX + @dec_VENDOR_TAX_tmp
				END
			END
		END

		IF @TAXAPPLYLND = 1 BEGIN  /* From AP */
			SET @dec_STATE_TAX_tmp = ISNULL(ROUND(@dec_DISCOUNT_AMT * @dec_STATE_PCT_tmp, 2),0)
			SET @dec_COUNTY_TAX_tmp = ISNULL(ROUND(@dec_DISCOUNT_AMT * @dec_COUNTY_PCT_tmp, 2),0)
			SET @dec_CITY_TAX_tmp = ISNULL(ROUND(@dec_DISCOUNT_AMT * @dec_CITY_PCT_tmp, 2),0)
			SET @dec_VENDOR_TAX_tmp = @dec_STATE_TAX_tmp + @dec_COUNTY_TAX_tmp + @dec_CITY_TAX_tmp	
			IF @TAX_RESALE = 1 BEGIN
				SET @dec_STATE_TAX = @dec_STATE_TAX + @dec_STATE_TAX_tmp
				SET @dec_COUNTY_TAX = @dec_COUNTY_TAX + @dec_COUNTY_TAX_tmp
				SET @dec_CITY_TAX = @dec_CITY_TAX + @dec_CITY_TAX_tmp
			END
			ELSE IF @DIFFERENCE_LINE = 1 BEGIN
				SET @dec_VENDOR_TAX = @dec_VENDOR_TAX + @dec_VENDOR_TAX_tmp
			END
		END

		IF @TAXAPPLYNC = 1 BEGIN  /* From AP */
			SET @dec_STATE_TAX_tmp = ISNULL(ROUND(@dec_NETCHARGES * @dec_STATE_PCT_tmp, 2),0)
			SET @dec_COUNTY_TAX_tmp = ISNULL(ROUND(@dec_NETCHARGES * @dec_COUNTY_PCT_tmp, 2),0)
			SET @dec_CITY_TAX_tmp = ISNULL(ROUND(@dec_NETCHARGES * @dec_CITY_PCT_tmp, 2),0)
			SET @dec_VENDOR_TAX_tmp = @dec_STATE_TAX_tmp + @dec_COUNTY_TAX_tmp + @dec_CITY_TAX_tmp		
			IF @TAX_RESALE = 1 BEGIN
				SET @dec_STATE_TAX = @dec_STATE_TAX + @dec_STATE_TAX_tmp
				SET @dec_COUNTY_TAX = @dec_COUNTY_TAX + @dec_COUNTY_TAX_tmp
				SET @dec_CITY_TAX = @dec_CITY_TAX + @dec_CITY_TAX_tmp
			END
			ELSE IF @DIFFERENCE_LINE = 1 BEGIN
				SET @dec_VENDOR_TAX = @dec_VENDOR_TAX + @dec_VENDOR_TAX_tmp
			END
		END

		IF @TAXAPPLYC = 1 BEGIN  /* From AP */
			SET @dec_STATE_TAX_tmp = ISNULL(ROUND(@dec_COMM_AMT * @dec_STATE_PCT_tmp, 2),0)
			SET @dec_COUNTY_TAX_tmp = ISNULL(ROUND(@dec_COMM_AMT * @dec_COUNTY_PCT_tmp, 2),0)
			SET @dec_CITY_TAX_tmp = ISNULL(ROUND(@dec_COMM_AMT * @dec_CITY_PCT_tmp, 2),0)
			SET @dec_STATE_TAX = @dec_STATE_TAX + @dec_STATE_TAX_tmp
			SET @dec_COUNTY_TAX = @dec_COUNTY_TAX + @dec_COUNTY_TAX_tmp
			SET @dec_CITY_TAX = @dec_CITY_TAX + @dec_CITY_TAX_tmp
		END

		IF @TAXAPPLYR = 1 BEGIN  /* From AP */
			SET @dec_STATE_TAX_tmp = ISNULL(ROUND(@dec_REBATE_AMT * @dec_STATE_PCT_tmp, 2),0)
			SET @dec_COUNTY_TAX_tmp = ISNULL(ROUND(@dec_REBATE_AMT * @dec_COUNTY_PCT_tmp, 2),0)
			SET @dec_CITY_TAX_tmp = ISNULL(ROUND(@dec_REBATE_AMT * @dec_CITY_PCT_tmp, 2),0)
			SET @dec_STATE_TAX = @dec_STATE_TAX + @dec_STATE_TAX_tmp
			SET @dec_COUNTY_TAX = @dec_COUNTY_TAX + @dec_COUNTY_TAX_tmp
			SET @dec_CITY_TAX = @dec_CITY_TAX + @dec_CITY_TAX_tmp
		END

		/* Before Addl Chrg Tax */
		SET @dec_RESALE_TAX_tmp = @dec_STATE_TAX + @dec_COUNTY_TAX + @dec_CITY_TAX
		SET @dec_VENDOR_TAX = ISNULL(ROUND(@dec_VENDOR_TAX, 2),0)
		SET @dec_SALES_TAX_tmp = @dec_VENDOR_TAX + @dec_STATE_TAX + @dec_COUNTY_TAX + @dec_CITY_TAX

		IF @TAXAPPLYAI = 1 BEGIN /* From Order */
			SET @dec_STATE_TAX_tmp = ISNULL(ROUND(@dec_ADDL_CHARGE * @dec_STATE_PCT_tmp, 2),0)
			SET @dec_COUNTY_TAX_tmp = ISNULL(ROUND(@dec_ADDL_CHARGE * @dec_COUNTY_PCT_tmp, 2),0)
			SET @dec_CITY_TAX_tmp = ISNULL(ROUND(@dec_ADDL_CHARGE * @dec_CITY_PCT_tmp, 2),0)

			--IF @DIFFERENCE_LINE = 1 AND @reconcile_method = 'R' BEGIN
			--	SET @dec_STATE_TAX_tmp = 0
			--	SET @dec_COUNTY_TAX_tmp = 0
			--	SET @dec_CITY_TAX_tmp = 0
			--END	
	
			SET @dec_ADDL_CHARGE_tax = @dec_STATE_TAX_tmp + @dec_COUNTY_TAX_tmp + @dec_CITY_TAX_tmp	
	
			SET @dec_STATE_TAX = @dec_STATE_TAX + @dec_STATE_TAX_tmp
			SET @dec_COUNTY_TAX = @dec_COUNTY_TAX + @dec_COUNTY_TAX_tmp
			SET @dec_CITY_TAX = @dec_CITY_TAX + @dec_CITY_TAX_tmp		
		END

		/*  dec_VENDOR_TAX is set from AP */
	
		/*			If	ll_bill_type = 1 Then  //Comm Only
						//PJH 09/27/04 - added ldec_resale_tax_amt
						ldec_bill_amt = ( ldec_comm_amt + ldec_rebate_amt ) + ldec_resale_tax_amt
					ElseIf ll_bill_type = 2 Then  //Net
						ldec_bill_amt = ( ldec_net_amt + ldec_net_charge + ldec_addl_charge + ldec_discount_amt + ldec_sales_tax_amt + ldec_addl_charge_taxes )
					ElseIf ll_bill_type = 3 Then //Gross
						ldec_bill_amt = ( ldec_net_amt + ldec_net_charge + ldec_addl_charge + ldec_discount_amt + ldec_comm_amt +  ldec_rebate_amt + ldec_sales_tax_amt + ldec_addl_charge_taxes)		
		*/		

		SET @dec_ADDL_CHARGE_tax = ISNULL(@dec_ADDL_CHARGE_tax, 0)
		SET @dec_RESALE_TAX_tmp = ISNULL(@dec_RESALE_TAX_tmp, 0)
		SET @dec_SALES_TAX_tmp = ISNULL(@dec_SALES_TAX_tmp, 0)
				
		IF	 @BILL_TYPE = 1   BEGIN	--Comm Only
			SET @dec_AP_BILLING_AMT = @dec_COMM_AMT + @dec_REBATE_AMT + @dec_RESALE_TAX_tmp
			END
		ELSE IF	@BILL_TYPE = 2  BEGIN --Net
			--PJH 06/08/2015 - removed @dec_COMM_AMT + @dec_REBATE_AMT - not sure how they go there
			IF @reconcile_by = 'L' AND @media_type = 'M'  /**********/
				SET @dec_AP_BILLING_AMT = @dec_NET_RATE + @dec_NETCHARGES + @dec_ADDL_CHARGE + @dec_DISCOUNT_AMT + @dec_SALES_TAX_tmp + @dec_ADDL_CHARGE_tax
			ELSE
				SET @dec_AP_BILLING_AMT = @dec_NET_AMT + @dec_NETCHARGES + @dec_ADDL_CHARGE + @dec_DISCOUNT_AMT + @dec_SALES_TAX_tmp + @dec_ADDL_CHARGE_tax
			END
		ELSE IF	@BILL_TYPE = 3  BEGIN--Gross
			IF @reconcile_by = 'L' AND @media_type = 'M'  /**********/
				SET @dec_AP_BILLING_AMT = @dec_NET_RATE + @dec_NETCHARGES + @dec_ADDL_CHARGE + @dec_DISCOUNT_AMT + @dec_COMM_AMT + @dec_REBATE_AMT + 
						@dec_SALES_TAX_tmp + @dec_ADDL_CHARGE_tax
			ELSE
				SET @dec_AP_BILLING_AMT = @dec_NET_AMT + @dec_NETCHARGES + @dec_ADDL_CHARGE + @dec_DISCOUNT_AMT + @dec_COMM_AMT + @dec_REBATE_AMT + 
						@dec_SALES_TAX_tmp + @dec_ADDL_CHARGE_tax				
			END
	
		IF @reconcile_by = 'L' AND @media_type = 'M'  /**********/
			SET @dec_LINE_TOTAL = @dec_NET_RATE + @dec_NETCHARGES + @dec_DISCOUNT_AMT + @dec_VENDOR_TAX
		ELSE
			SET @dec_LINE_TOTAL = @dec_NET_AMT + @dec_NETCHARGES + @dec_DISCOUNT_AMT + @dec_VENDOR_TAX

		IF @NET_GROSS = 1 BEGIN
			SET @dec_LINE_TOTAL = @dec_LINE_TOTAL + @dec_COMM_AMT
		END
		


		/* END CALC_TOTALS ************************/
				
		/**** END GET AP ****/

		-- START INTERNET_DETAIL --@order_nbr int, @reconcile_by varchar(6), @reconcile_method varchar(6), @year varchar(4), @month varchar(2)
		--IF EXISTS (SELECT ORDER_NBR FROM dbo.INTERNET_DETAIL D WHERE ORDER_NBR = @order_nbr)
		BEGIN /* INTERNET_DETAIL */
			/************************ SKIP ON DIFFERENCE ONSET LINE CALC ***************************/
			IF @DIFFERENCE_LINE = 0 BEGIN
				IF @media_type = 'I' BEGIN
					IF @reconcile_by = 'M' BEGIN
						INSERT INTO @INTERNET_DETAIL_TABLE
						SELECT H.ORDER_NBR, LINE_NBR, REV_NBR, SEQ_NBR, NET_GROSS
						FROM dbo.INTERNET_HEADER H, dbo.INTERNET_DETAIL D                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
						WHERE H.ORDER_NBR = D.ORDER_NBR AND
									H.ORDER_NBR = @order_nbr AND 
									D.ACTIVE_REV = 1 AND D.BILL_TYPE_FLAG <> 1 AND
									LINE_CANCELLED IS NULL AND
									SUBSTRING(CONVERT(VARCHAR(10), D.START_DATE, 112), 5,2) = @month AND 
									SUBSTRING(CONVERT(VARCHAR(10), D.START_DATE, 112), 1,4) = @year
						ORDER BY H.ORDER_NBR, LINE_NBR, REV_NBR, SEQ_NBR;
					END
					ELSE IF @reconcile_by = 'O' BEGIN
						INSERT INTO @INTERNET_DETAIL_TABLE
						SELECT H.ORDER_NBR, LINE_NBR, REV_NBR, SEQ_NBR, NET_GROSS
						FROM dbo.INTERNET_HEADER H, dbo.INTERNET_DETAIL D                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
						WHERE H.ORDER_NBR = D.ORDER_NBR AND
									H.ORDER_NBR = @order_nbr AND 
									D.ACTIVE_REV = 1 AND D.BILL_TYPE_FLAG <> 1 AND
									LINE_CANCELLED IS NULL 
						ORDER BY H.ORDER_NBR, LINE_NBR, REV_NBR, SEQ_NBR;			
					END
					ELSE IF @reconcile_by = 'L' BEGIN
						INSERT INTO @INTERNET_DETAIL_TABLE
						SELECT H.ORDER_NBR, LINE_NBR, REV_NBR, SEQ_NBR, NET_GROSS
						FROM dbo.INTERNET_HEADER H, dbo.INTERNET_DETAIL D                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
						WHERE H.ORDER_NBR = D.ORDER_NBR AND
									H.ORDER_NBR = @order_nbr AND 
									D.LINE_NBR = @line_nbr AND
									D.ACTIVE_REV = 1 AND D.BILL_TYPE_FLAG <> 1 AND
									LINE_CANCELLED IS NULL
						ORDER BY H.ORDER_NBR, LINE_NBR, REV_NBR, SEQ_NBR;
					END
				END
				ELSE IF @media_type = 'T' BEGIN
					IF @reconcile_by = 'M' BEGIN
						INSERT INTO @TV_DETAIL_TABLE
						SELECT H.ORDER_NBR, LINE_NBR, REV_NBR, SEQ_NBR, NET_GROSS
						FROM dbo.TV_HDR H, dbo.TV_DETAIL D                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
						WHERE H.ORDER_NBR = D.ORDER_NBR AND
									H.ORDER_NBR = @order_nbr AND 
									D.ACTIVE_REV = 1 AND D.BILL_TYPE_FLAG <> 1 AND
									LINE_CANCELLED IS NULL AND
									RIGHT('00' + CONVERT(VARCHAR(2), D.MONTH_NBR), 2) = @month AND 
									RIGHT('0000' + CONVERT(VARCHAR(4), D.YEAR_NBR), 4) = @year 			
						ORDER BY H.ORDER_NBR, LINE_NBR, REV_NBR, SEQ_NBR;
					END	
					ELSE IF @reconcile_by = 'L' BEGIN /* 06/29/20 */
						INSERT INTO @TV_DETAIL_TABLE
						SELECT H.ORDER_NBR, LINE_NBR, REV_NBR, SEQ_NBR, NET_GROSS
						FROM dbo.TV_HDR H, dbo.TV_DETAIL D                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
						WHERE H.ORDER_NBR = D.ORDER_NBR AND
									H.ORDER_NBR = @order_nbr AND 
									D.LINE_NBR = @line_nbr AND
									D.ACTIVE_REV = 1 AND D.BILL_TYPE_FLAG <> 1 AND
									LINE_CANCELLED IS NULL
						ORDER BY H.ORDER_NBR, LINE_NBR, REV_NBR, SEQ_NBR;	
					END								
				END
				ELSE IF @media_type = 'R' BEGIN
					IF @reconcile_by = 'M' BEGIN
						INSERT INTO @RADIO_DETAIL_TABLE
						SELECT H.ORDER_NBR, LINE_NBR, REV_NBR, SEQ_NBR, NET_GROSS
						FROM dbo.RADIO_HDR H, dbo.RADIO_DETAIL D                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
						WHERE H.ORDER_NBR = D.ORDER_NBR AND
									H.ORDER_NBR = @order_nbr AND 
									D.ACTIVE_REV = 1 AND D.BILL_TYPE_FLAG <> 1 AND
									LINE_CANCELLED IS NULL AND
									RIGHT('00' + CONVERT(VARCHAR(2), D.MONTH_NBR), 2) = @month AND 
									RIGHT('0000' + CONVERT(VARCHAR(4), D.YEAR_NBR), 4) = @year 	
						ORDER BY H.ORDER_NBR, LINE_NBR, REV_NBR, SEQ_NBR;
					END	
					ELSE IF @reconcile_by = 'L' BEGIN /* 06/29/20 */
						INSERT INTO @RADIO_DETAIL_TABLE
						SELECT H.ORDER_NBR, LINE_NBR, REV_NBR, SEQ_NBR, NET_GROSS
						FROM dbo.RADIO_HDR H, dbo.RADIO_DETAIL D                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
						WHERE H.ORDER_NBR = D.ORDER_NBR AND
									H.ORDER_NBR = @order_nbr AND 
									D.LINE_NBR = @line_nbr AND
									D.ACTIVE_REV = 1 AND D.BILL_TYPE_FLAG <> 1 AND
									LINE_CANCELLED IS NULL
						ORDER BY H.ORDER_NBR, LINE_NBR, REV_NBR, SEQ_NBR;	
					END										
				END
				ELSE IF @media_type = 'N' BEGIN
					IF @reconcile_by = 'L' BEGIN /* 06/29/20 */
						INSERT INTO @NEWSPAPER_DETAIL_TABLE
						SELECT H.ORDER_NBR, LINE_NBR, REV_NBR, SEQ_NBR, NET_GROSS
						FROM dbo.NEWSPAPER_HEADER H, dbo.NEWSPAPER_DETAIL D                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
						WHERE H.ORDER_NBR = D.ORDER_NBR AND
									H.ORDER_NBR = @order_nbr AND 
									D.LINE_NBR = @line_nbr AND
									D.ACTIVE_REV = 1 AND D.BILL_TYPE_FLAG <> 1 AND
									LINE_CANCELLED IS NULL
						ORDER BY H.ORDER_NBR, LINE_NBR, REV_NBR, SEQ_NBR;	
					END										
				END
				ELSE IF @media_type = 'M' BEGIN
					IF @reconcile_by = 'L' BEGIN /* 06/29/20 */
						INSERT INTO @MAGAZINE_DETAIL_TABLE
						SELECT H.ORDER_NBR, LINE_NBR, REV_NBR, SEQ_NBR, NET_GROSS
						FROM dbo.MAGAZINE_HEADER H, dbo.MAGAZINE_DETAIL D                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
						WHERE H.ORDER_NBR = D.ORDER_NBR AND
									H.ORDER_NBR = @order_nbr AND 
									D.LINE_NBR = @line_nbr AND
									D.ACTIVE_REV = 1 AND D.BILL_TYPE_FLAG <> 1 AND
									LINE_CANCELLED IS NULL
						ORDER BY H.ORDER_NBR, LINE_NBR, REV_NBR, SEQ_NBR;	
					END										
				END
				ELSE IF @media_type = 'O' BEGIN
					IF @reconcile_by = 'L' BEGIN /* 06/29/20 */
						INSERT INTO @OUTDOOR_DETAIL_TABLE
						SELECT H.ORDER_NBR, LINE_NBR, REV_NBR, SEQ_NBR, NET_GROSS
						FROM dbo.OUTDOOR_HEADER H, dbo.OUTDOOR_DETAIL D                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
						WHERE H.ORDER_NBR = D.ORDER_NBR AND
									H.ORDER_NBR = @order_nbr AND 
									D.LINE_NBR = @line_nbr AND
									D.ACTIVE_REV = 1 AND D.BILL_TYPE_FLAG <> 1 AND
									LINE_CANCELLED IS NULL
						ORDER BY H.ORDER_NBR, LINE_NBR, REV_NBR, SEQ_NBR;	
					END										
				END
				
				SET @ROW_COUNT = @@ROWCOUNT /* Could be from and media type - Each media type has its own temp table */
				SET @ROW_ID = 1		
				
				--IF @media_type = 'I' BEGIN
				--	SELECT * FROM INTERNET_DETAIL WHERE ORDER_NBR = @order_nbr ORDER BY START_DATE, LINE_NBR        /***************** DEBUG **************/
				--END
				--ELSE IF @media_type = 'T' BEGIN
				--	SELECT * FROM TV_DETAIL WHERE ORDER_NBR = @order_nbr ORDER BY START_DATE, LINE_NBR        /***************** DEBUG **************/
				--END
				--ELSE IF @media_type = 'R' BEGIN
				--	SELECT * FROM RADIO_DETAIL WHERE ORDER_NBR = @order_nbr ORDER BY START_DATE, LINE_NBR        /***************** DEBUG **************/
				--END		
				--IF @media_type = 'N' BEGIN
				--	SELECT * FROM NEWSPAPER_DETAIL WHERE ORDER_NBR = @order_nbr ORDER BY START_DATE, LINE_NBR        /***************** DEBUG **************/
				--END	
				--IF @media_type = 'M' BEGIN
				--	SELECT * FROM MAGAZINE_DETAIL WHERE ORDER_NBR = @order_nbr ORDER BY START_DATE, LINE_NBR        /***************** DEBUG **************/
				--END
				--IF @media_type = 'O' BEGIN
				--	SELECT * FROM OUTDOOR_DETAIL WHERE ORDER_NBR = @order_nbr ORDER BY POST_DATE, LINE_NBR        /***************** DEBUG **************/
				--END													
				
				WHILE @ROW_ID <= @ROW_COUNT BEGIN		
					IF @media_type = 'I' BEGIN
						SELECT
							@order_nbr = ORDER_NBR,
							@line_nbr = LINE_NBR,
							@rev_nbr = REV_NBR,
							@seq_nbr = SEQ_NBR
						FROM 
							@INTERNET_DETAIL_TABLE
						WHERE
							RowID = @ROW_ID;		
							
						--SELECT 	@order_nbr, 	@line_nbr,  @rev_nbr, @seq_nbr
						
						/*PJH 08/12/13 - Use Order/Line	*/
						UPDATE	 dbo.INTERNET_DETAIL SET ACTIVE_REV = NULL
						WHERE	 ORDER_NBR = @order_nbr
						AND		LINE_NBR = @line_nbr;
						
						/* PJH 08/27/13 - Reverse Quantities */
						INSERT INTO dbo.INTERNET_DETAIL  ( ORDER_NBR, LINE_NBR, REV_NBR, SEQ_NBR,
						ACTIVE_REV, LINK_DETID, [START_DATE], END_DATE, CLOSE_DATE, MATL_CLOSE_DATE, EXT_CLOSE_DATE, EXT_MATL_DATE, HEADLINE, INTERNET_TYPE,
						SIZE, PROJ_IMPRESSIONS, GUARANTEED_IMPRESS, URL, TARGET_AUDIENCE, COPY_AREA, JOB_NUMBER, JOB_COMPONENT_NBR, RATE_CARD, RATE_TYPE, 
						RATE_DESC, QUANTITY, RATE, NET_RATE, GROSS_RATE, EXT_NET_AMT, EXT_GROSS_AMT,
						COMM_AMT, REBATE_AMT, DISCOUNT_AMT, DISCOUNT_DESC, STATE_AMT, COUNTY_AMT, CITY_AMT, NON_RESALE_AMT, NETCHARGE, NCDESC, 
						ADDL_CHARGE, ADDL_CHARGE_DESC, LINE_TOTAL, LINE_CANCELLED, DATE_TO_BILL, BILLING_USER,
						AR_INV_NBR, AR_TYPE, AR_INV_SEQ, GLEXACT, GLESEQ_SALES, GLESEQ_COS, GLESEQ_WIP, GLESEQ_STATE, GLESEQ_COUNTY, GLESEQ_CITY, 
						GLEXACT_DEF, GLESEQ_COS_DEF, GLESEQ_SALES_DEF, GLACODE_SALES, GLACODE_COS, GLACODE_WIP,
						GLACODE_STATE, GLACODE_COUNTY, GLACODE_CITY, NON_BILL_FLAG, MODIFIED_BY, MODIFIED_DATE, MODIFIED_COMMENTS, BILL_TYPE_FLAG, CREATIVE_SIZE, 
						PLACEMENT_1, PLACEMENT_2, COMM_PCT, MARKUP_PCT, REBATE_PCT, DISCOUNT_PCT,
						TAX_CODE, TAX_CITY_PCT, TAX_COUNTY_PCT, TAX_STATE_PCT, TAX_RESALE, TAXAPPLYC, TAXAPPLYLN, TAXAPPLYND, TAXAPPLYNC, TAXAPPLYR, TAXAPPLYAI, 
						RECONCILE_FLAG, ACT_IMPRESSIONS, GLACODE_SALES_DEF, GLACODE_COS_DEF,
						BILLING_AMT, COST_TYPE, COST_RATE, NET_BASE_RATE, GROSS_BASE_RATE, 
						BILL_CANCELLED, EST_NBR, EST_LINE_NBR, EST_REV_NBR )
						SELECT
						ORDER_NBR, LINE_NBR, REV_NBR, @seq_nbr + 1,
						NULL, NULL, [START_DATE], END_DATE, CLOSE_DATE, MATL_CLOSE_DATE, EXT_CLOSE_DATE,	EXT_MATL_DATE, HEADLINE, INTERNET_TYPE,
						SIZE, -PROJ_IMPRESSIONS, -GUARANTEED_IMPRESS, URL, TARGET_AUDIENCE, COPY_AREA, JOB_NUMBER, JOB_COMPONENT_NBR, RATE_CARD, RATE_TYPE, 
						RATE_DESC, -QUANTITY, RATE, NET_RATE, GROSS_RATE, -EXT_NET_AMT, -EXT_GROSS_AMT,
						-COMM_AMT, -REBATE_AMT, -DISCOUNT_AMT, DISCOUNT_DESC, -STATE_AMT, -COUNTY_AMT, -CITY_AMT, -NON_RESALE_AMT, -NETCHARGE, NCDESC, 
						-ADDL_CHARGE, 'AP Reconcile', -LINE_TOTAL, LINE_CANCELLED, DATE_TO_BILL, NULL,
						NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 
						NULL, NULL, NULL, NULL, NULL, NULL,
						NULL, NULL, NULL, NULL, @user_code, @CURRENT_DATE, @modified_comments + ' - Reversal', BILL_TYPE_FLAG, CREATIVE_SIZE, 
						PLACEMENT_1, PLACEMENT_2, COMM_PCT, MARKUP_PCT, REBATE_PCT, DISCOUNT_PCT,
						TAX_CODE, TAX_CITY_PCT, TAX_COUNTY_PCT, TAX_STATE_PCT, TAX_RESALE, TAXAPPLYC, TAXAPPLYLN, TAXAPPLYND, TAXAPPLYNC, TAXAPPLYR, TAXAPPLYAI, 
						NULL, -ACT_IMPRESSIONS, NULL, NULL,
						-BILLING_AMT, COST_TYPE, COST_RATE, NET_BASE_RATE, GROSS_BASE_RATE, 
						(SELECT MAX(ISNULL(BILL_CANCELLED,0)) FROM dbo.INTERNET_DETAIL WHERE ORDER_NBR = @order_nbr AND LINE_NBR = @line_nbr), EST_NBR, EST_LINE_NBR, EST_REV_NBR
						FROM	 dbo.INTERNET_DETAIL
						WHERE	 ORDER_NBR = @order_nbr
						AND  	LINE_NBR = @line_nbr
						AND  	REV_NBR = @rev_nbr
						AND  	SEQ_NBR = @seq_nbr;		
						
						IF @reconcile_by = 'L' BEGIN
							/** Do new AP Amounts row later **/
							SET @ROW_ID = @ROW_ID + 1				
						END
						ELSE BEGIN
							/* PJH 08/27/13 - Zero Amounts */
							INSERT INTO dbo.INTERNET_DETAIL  ( ORDER_NBR, LINE_NBR, REV_NBR, SEQ_NBR,
							ACTIVE_REV, LINK_DETID, [START_DATE], END_DATE, CLOSE_DATE, MATL_CLOSE_DATE, EXT_CLOSE_DATE, EXT_MATL_DATE, HEADLINE, INTERNET_TYPE,
							SIZE, PROJ_IMPRESSIONS, GUARANTEED_IMPRESS, URL, TARGET_AUDIENCE, COPY_AREA, JOB_NUMBER, JOB_COMPONENT_NBR, RATE_CARD, RATE_TYPE, 
							RATE_DESC, QUANTITY, RATE, NET_RATE, GROSS_RATE, EXT_NET_AMT, EXT_GROSS_AMT,
							COMM_AMT, REBATE_AMT, DISCOUNT_AMT, DISCOUNT_DESC, STATE_AMT, COUNTY_AMT, CITY_AMT, NON_RESALE_AMT, NETCHARGE, NCDESC, 
							ADDL_CHARGE, ADDL_CHARGE_DESC, LINE_TOTAL, LINE_CANCELLED, DATE_TO_BILL, BILLING_USER,
							AR_INV_NBR, AR_TYPE, AR_INV_SEQ, GLEXACT, GLESEQ_SALES, GLESEQ_COS, GLESEQ_WIP, GLESEQ_STATE, GLESEQ_COUNTY, GLESEQ_CITY, 
							GLEXACT_DEF, GLESEQ_COS_DEF, GLESEQ_SALES_DEF, GLACODE_SALES, GLACODE_COS, GLACODE_WIP,
							GLACODE_STATE, GLACODE_COUNTY, GLACODE_CITY, NON_BILL_FLAG, MODIFIED_BY, MODIFIED_DATE, MODIFIED_COMMENTS, BILL_TYPE_FLAG, CREATIVE_SIZE, 
							PLACEMENT_1, PLACEMENT_2, COMM_PCT, MARKUP_PCT, REBATE_PCT, DISCOUNT_PCT,
							TAX_CODE, TAX_CITY_PCT, TAX_COUNTY_PCT, TAX_STATE_PCT, TAX_RESALE, TAXAPPLYC, TAXAPPLYLN, TAXAPPLYND, TAXAPPLYNC, TAXAPPLYR, TAXAPPLYAI, 
							RECONCILE_FLAG, ACT_IMPRESSIONS, GLACODE_SALES_DEF, GLACODE_COS_DEF,
							BILLING_AMT, COST_TYPE, COST_RATE, NET_BASE_RATE, GROSS_BASE_RATE, 
							BILL_CANCELLED, EST_NBR, EST_LINE_NBR, EST_REV_NBR )
							SELECT
							ORDER_NBR, LINE_NBR, @rev_nbr + 1, 1,
							1, NULL, [START_DATE], END_DATE, CLOSE_DATE, MATL_CLOSE_DATE, EXT_CLOSE_DATE,	EXT_MATL_DATE, HEADLINE, INTERNET_TYPE,
							SIZE, NULL, 0, URL, TARGET_AUDIENCE, COPY_AREA, JOB_NUMBER, JOB_COMPONENT_NBR, RATE_CARD, RATE_TYPE, 
							RATE_DESC, 0, 0, 0, 0, 0, 0,
							0, 0, 0, NULL, 0, 0, 0, 0, 0, NULL, 0, 'AP Reconcile - 0', 0, LINE_CANCELLED, DATE_TO_BILL, NULL,
							NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 
							NULL, NULL, NULL, NULL, NULL, NULL,
							NULL, NULL, NULL, NULL, @user_code, @CURRENT_DATE, @modified_comments + ' - New Revision', BILL_TYPE_FLAG, CREATIVE_SIZE, 
							PLACEMENT_1, PLACEMENT_2, COMM_PCT, MARKUP_PCT, REBATE_PCT, DISCOUNT_PCT,
							TAX_CODE, TAX_CITY_PCT, TAX_COUNTY_PCT, TAX_STATE_PCT, TAX_RESALE, TAXAPPLYC, TAXAPPLYLN, TAXAPPLYND, TAXAPPLYNC, TAXAPPLYR, TAXAPPLYAI, 
							NULL, 0, NULL, NULL,
							0, COST_TYPE, 0, 0, 0, 
							(SELECT MAX(ISNULL(BILL_CANCELLED,0)) FROM dbo.INTERNET_DETAIL	WHERE ORDER_NBR = @order_nbr AND LINE_NBR = @line_nbr), EST_NBR, EST_LINE_NBR, EST_REV_NBR
							FROM	 dbo.INTERNET_DETAIL
							WHERE	 ORDER_NBR = @order_nbr
							AND  	LINE_NBR = @line_nbr
							AND  	REV_NBR = @rev_nbr
							AND  	SEQ_NBR = @seq_nbr;					
							
							SET @ROW_ID = @ROW_ID + 1
						END
					END	
					ELSE IF @media_type = 'N' BEGIN  /* PJH 09/26/2020 */
						SELECT
							@order_nbr = ORDER_NBR,
							@line_nbr = LINE_NBR,
							@rev_nbr = REV_NBR,
							@seq_nbr = SEQ_NBR
						FROM 
							@NEWSPAPER_DETAIL_TABLE
						WHERE
							RowID = @ROW_ID;		
							
						--SELECT 	@order_nbr, 	@line_nbr,  @rev_nbr, @seq_nbr
						
						/*PJH 08/12/13 - Use Order/Line	*/
						UPDATE	 dbo.NEWSPAPER_DETAIL SET ACTIVE_REV = NULL
						WHERE	 ORDER_NBR = @order_nbr
						AND		LINE_NBR = @line_nbr;
						
						/* Reverse Quantities */
						INSERT INTO [dbo].[NEWSPAPER_DETAIL]
									([ORDER_NBR], [LINE_NBR], [REV_NBR], [SEQ_NBR], [ACTIVE_REV], [LINK_DETID], [START_DATE], [END_DATE], [CLOSE_DATE],
									[MATL_CLOSE_DATE], [EXT_CLOSE_DATE], [EXT_MATL_DATE], [SIZE], [AD_NUMBER], [HEADLINE], [MATERIAL], [EDITION_ISSUE], [SECTION],
									[JOB_NUMBER], [JOB_COMPONENT_NBR], [RATE_CARD_ID], [RATE_DTL_ID], [PRINT_COLUMNS], [PRINT_INCHES], [PRINT_LINES], [CONTRACT_QTY],
									[QUANTITY], [RATE], [NET_RATE], [GROSS_RATE], [FLAT_NET], [FLAT_GROSS], [EXT_NET_AMT], [EXT_GROSS_AMT], [COMM_AMT], [REBATE_AMT],
									[DISCOUNT_AMT], [DISCOUNT_DESC], [STATE_AMT], [COUNTY_AMT], [CITY_AMT], [NON_RESALE_AMT], [NETCHARGE], [NETCHARGE_DESC],
									[ADDL_CHARGE], [ADDL_CHARGE_DESC], [PROD_CHARGE], [PROD_DESC], [COLOR_CHARGE], [COLOR_DESC], [LINE_TOTAL], [LINE_CANCELLED],
									[DATE_TO_BILL], --[BILLING_USER], [AR_INV_NBR], [AR_TYPE], [AR_INV_SEQ], [GLEXACT], [GLESEQ_SALES], [GLESEQ_COS], [GLESEQ_WIP],
									[MARKUP_PCT], [REBATE_PCT], [DISCOUNT_PCT], [TAX_CODE], [TAX_CITY_PCT], [TAX_COUNTY_PCT], [TAX_STATE_PCT], [TAX_RESALE],
									[TAXAPPLYC], [TAXAPPLYLN], [TAXAPPLYND], [TAXAPPLYNC], [TAXAPPLYR], [TAXAPPLYAI], [RECONCILE_FLAG],
									--[GLESEQ_STATE], [GLESEQ_COUNTY], [GLESEQ_CITY], [GLEXACT_DEF], [GLACODE_SALES], [GLACODE_COS], [GLACODE_WIP], [GLACODE_STATE],
									--[GLACODE_COUNTY], [GLACODE_CITY], 
									[NON_BILL_FLAG], [MODIFIED_BY], [MODIFIED_DATE], [MODIFIED_COMMENTS], [BILL_TYPE_FLAG], [COMM_PCT],							   
									--[GLESEQ_SALES_DEF], [GLESEQ_COS_DEF], [GLACODE_SALES_DEF], [GLACODE_COS_DEF], 
									[BILLING_AMT], [BILL_CANCELLED],
									[EST_NBR], [EST_LINE_NBR], [EST_REV_NBR], [FLAT_NETCHARGE], [FLAT_ADDL_CHARGE], [FLAT_DISCOUNT_AMT], [PRODUCTION_SIZE],
									[MAT_COMP], [SIZE_CODE], [COST_TYPE], [COST_RATE], [RATE_TYPE], [NP_CIRCULATION], [PRINT_QUANTITY])
								SELECT --DATE_TO_BILL, NON_BILL_FLAG??
									ORDER_NBR, LINE_NBR, REV_NBR, @seq_nbr + 1, NULL, NULL, [START_DATE], [END_DATE], [CLOSE_DATE],
									[MATL_CLOSE_DATE], [EXT_CLOSE_DATE], [EXT_MATL_DATE], [SIZE], [AD_NUMBER], [HEADLINE], [MATERIAL], [EDITION_ISSUE], [SECTION],
									[JOB_NUMBER], [JOB_COMPONENT_NBR], [RATE_CARD_ID], [RATE_DTL_ID], [PRINT_COLUMNS], [PRINT_INCHES], [PRINT_LINES] * -1, [CONTRACT_QTY] * -1,
									[QUANTITY] * -1, [RATE], [NET_RATE], [GROSS_RATE], [FLAT_NET], [FLAT_GROSS], [EXT_NET_AMT] * -1, [EXT_GROSS_AMT] * -1, [COMM_AMT] * -1, [REBATE_AMT] * -1,
									[DISCOUNT_AMT] * -1, [DISCOUNT_DESC], [STATE_AMT] * -1, [COUNTY_AMT] * -1, [CITY_AMT] * -1, [NON_RESALE_AMT] * -1, [NETCHARGE] * -1, [NETCHARGE_DESC],
									[ADDL_CHARGE] * -1, [ADDL_CHARGE_DESC], [PROD_CHARGE] * -1, [PROD_DESC], [COLOR_CHARGE] * -1, [COLOR_DESC], [LINE_TOTAL] * -1, [LINE_CANCELLED],
									[DATE_TO_BILL], --[BILLING_USER], [AR_INV_NBR], [AR_TYPE], [AR_INV_SEQ], [GLEXACT], [GLESEQ_SALES], [GLESEQ_COS], [GLESEQ_WIP],
									[MARKUP_PCT], [REBATE_PCT], [DISCOUNT_PCT], [TAX_CODE], [TAX_CITY_PCT], [TAX_COUNTY_PCT], [TAX_STATE_PCT], [TAX_RESALE],
									[TAXAPPLYC], [TAXAPPLYLN], [TAXAPPLYND], [TAXAPPLYNC], [TAXAPPLYR], [TAXAPPLYAI], [RECONCILE_FLAG],
									--[GLESEQ_STATE], [GLESEQ_COUNTY], [GLESEQ_CITY], [GLEXACT_DEF], [GLACODE_SALES], [GLACODE_COS], [GLACODE_WIP], [GLACODE_STATE],
									--[GLACODE_COUNTY], [GLACODE_CITY], 
									[NON_BILL_FLAG], [MODIFIED_BY], [MODIFIED_DATE], [MODIFIED_COMMENTS], [BILL_TYPE_FLAG], [COMM_PCT],							   
									--[GLESEQ_SALES_DEF], [GLESEQ_COS_DEF], [GLACODE_SALES_DEF], [GLACODE_COS_DEF], 
									[BILLING_AMT]  * -1, [BILL_CANCELLED],
									[EST_NBR], [EST_LINE_NBR], [EST_REV_NBR], [FLAT_NETCHARGE] * -1, [FLAT_ADDL_CHARGE] * -1, [FLAT_DISCOUNT_AMT] * -1, [PRODUCTION_SIZE],
									[MAT_COMP], [SIZE_CODE], [COST_TYPE], [COST_RATE], [RATE_TYPE], [NP_CIRCULATION], [PRINT_QUANTITY] * -1
						FROM  [dbo].[NEWSPAPER_DETAIL]
						WHERE	 ORDER_NBR = @order_nbr
						AND  	LINE_NBR = @line_nbr
						AND  	REV_NBR = @rev_nbr
						AND  	SEQ_NBR = @seq_nbr;		

						--DELETE FROM [dbo].[NEWSPAPER_OTH_CHGS]
						--	WHERE [ORDER_NBR] = @order_nbr AND [LINE_NBR] = @line_nbr

						--IF	 COALESCE(@netcharge, 0) <> 0 BEGIN
						--	INSERT INTO [dbo].[NEWSPAPER_OTH_CHGS]
						--			([ORDER_NBR], [LINE_NBR], [CHG_TYPE], [CHG_DESC]
						--			,[QUANTITY], [RATE], [AMOUNT], [RATE_TYPE]
						--			,[REVISED_DATE], [REVISED_BY])			
						--	VALUES			
						--			(@order_nbr, @line_nbr,'NC', @ncdesc,
						--			1, @netcharge, @netcharge, @rate_type, 
						--			@modified_date, @modified_by)
						--END

						--IF	 COALESCE(@color_charge, 0) <> 0 BEGIN						
						--	INSERT INTO [dbo].[NEWSPAPER_OTH_CHGS]
						--			([ORDER_NBR], [LINE_NBR], [CHG_TYPE], [CHG_DESC]
						--			,[QUANTITY], [RATE], [AMOUNT], [RATE_TYPE]
						--			,[REVISED_DATE], [REVISED_BY])			
						--	VALUES			
						--			(@order_nbr, @line_nbr,'RC', @color_desc,
						--			1, @color_charge, @color_charge, @rate_type, 
						--			@modified_date, @modified_by)
						--END		

						--IF	 COALESCE(@addl_charge, 0) <> 0 BEGIN							
						--	INSERT INTO [dbo].[NEWSPAPER_OTH_CHGS]
						--			([ORDER_NBR], [LINE_NBR], [CHG_TYPE], [CHG_DESC]
						--			,[QUANTITY], [RATE], [AMOUNT], [RATE_TYPE]
						--			,[REVISED_DATE], [REVISED_BY])			
						--	VALUES			
						--			(@order_nbr, @line_nbr,'AF', @addl_charge_desc,
						--			1, @addl_charge, @addl_charge, @rate_type, 
						--			@modified_date, @modified_by)
						--END	
						
						IF @reconcile_by = 'L' BEGIN
							/** Do new AP Amounts row later **/
							SET @ROW_ID = @ROW_ID + 1				
						END
					END		
					ELSE IF @media_type = 'M' BEGIN
						SELECT
							@order_nbr = ORDER_NBR,
							@line_nbr = LINE_NBR,
							@rev_nbr = REV_NBR,
							@seq_nbr = SEQ_NBR
						FROM 
							@MAGAZINE_DETAIL_TABLE
						WHERE
							RowID = @ROW_ID;		
							
						SELECT 	@order_nbr, @line_nbr,  @rev_nbr, @seq_nbr, 'Reverse Quantities'
						
						/*PJH 08/12/13 - Use Order/Line	*/
						UPDATE	 dbo.MAGAZINE_DETAIL SET ACTIVE_REV = NULL
						WHERE	 ORDER_NBR = @order_nbr
						AND		LINE_NBR = @line_nbr;
						
						/* PJH 08/27/13 - Reverse Quantities */
						INSERT INTO [dbo].[MAGAZINE_DETAIL]
									([ORDER_NBR], [LINE_NBR], [REV_NBR], [SEQ_NBR], [ACTIVE_REV], [LINK_DETID], [START_DATE], [END_DATE], [CLOSE_DATE],
									[MATL_CLOSE_DATE], [EXT_CLOSE_DATE], [EXT_MATL_DATE], [SIZE], [AD_NUMBER], [HEADLINE], [MATERIAL], [EDITION_ISSUE], [SECTION],
									[JOB_NUMBER], [JOB_COMPONENT_NBR], [RATE_CARD_ID], [RATE_DTL_ID], [CONTRACT_QTY],
									[QUANTITY], [RATE], [NET_RATE], [GROSS_RATE], [FLAT_NET], [FLAT_GROSS], [EXT_NET_AMT], [EXT_GROSS_AMT], [COMM_AMT], [REBATE_AMT],
									[DISCOUNT_AMT], [DISCOUNT_DESC], [STATE_AMT], [COUNTY_AMT], [CITY_AMT], [NON_RESALE_AMT], [NETCHARGE], [NETCHARGE_DESC],
									[ADDL_CHARGE], [ADDL_CHARGE_DESC], [PROD_CHARGE], [PROD_DESC], [COLOR_CHARGE], [COLOR_DESC], [LINE_TOTAL], --[LINE_CANCELLED],
									[BLEED_PCT], [BLEED_AMT], [POSITION_PCT], [POSITION_AMT], [PREMIUM_PCT], [PREMIUM_AMT],
									[DATE_TO_BILL], 
									--[BILLING_USER], [AR_INV_NBR], [AR_TYPE], [AR_INV_SEQ], [GLEXACT], [GLESEQ_SALES], [GLESEQ_COS], [GLESEQ_WIP],
									[MARKUP_PCT], [REBATE_PCT], [DISCOUNT_PCT], [TAX_CODE], [TAX_CITY_PCT], [TAX_COUNTY_PCT], [TAX_STATE_PCT], [TAX_RESALE],
									[TAXAPPLYC], [TAXAPPLYLN], [TAXAPPLYND], [TAXAPPLYNC], [TAXAPPLYR], [TAXAPPLYAI], [RECONCILE_FLAG],
									--[GLESEQ_STATE], [GLESEQ_COUNTY], [GLESEQ_CITY], [GLEXACT_DEF], [GLACODE_SALES], [GLACODE_COS], [GLACODE_WIP], [GLACODE_STATE],
									--[GLACODE_COUNTY], [GLACODE_CITY], 
									[NON_BILL_FLAG], 
									[MODIFIED_BY], [MODIFIED_DATE], [MODIFIED_COMMENTS], [BILL_TYPE_FLAG], [COMM_PCT],							   
									--[GLESEQ_SALES_DEF], [GLESEQ_COS_DEF], [GLACODE_SALES_DEF], [GLACODE_COS_DEF], 
									[BILLING_AMT], [BILL_CANCELLED],
									[EST_NBR], [EST_LINE_NBR], [EST_REV_NBR], [FLAT_NETCHARGE], [FLAT_ADDL_CHARGE], [FLAT_DISCOUNT_AMT], [PRODUCTION_SIZE],
									[MAT_COMP], [SIZE_CODE], [MG_CIRCULATION])
								SELECT
									ORDER_NBR, LINE_NBR, REV_NBR, @seq_nbr + 1, NULL, NULL, [START_DATE], [END_DATE], [CLOSE_DATE],
									[MATL_CLOSE_DATE], [EXT_CLOSE_DATE], [EXT_MATL_DATE], [SIZE], [AD_NUMBER], [HEADLINE], [MATERIAL], [EDITION_ISSUE], [SECTION],
									[JOB_NUMBER], [JOB_COMPONENT_NBR], [RATE_CARD_ID], [RATE_DTL_ID], [CONTRACT_QTY] * -1,
									[QUANTITY] * -1, [RATE], [NET_RATE], [GROSS_RATE], [FLAT_NET], [FLAT_GROSS], [EXT_NET_AMT] * -1, [EXT_GROSS_AMT] * -1, [COMM_AMT] * -1, [REBATE_AMT] * -1,
									[DISCOUNT_AMT] * -1, [DISCOUNT_DESC], [STATE_AMT] * -1, [COUNTY_AMT] * -1, [CITY_AMT] * -1, [NON_RESALE_AMT] * -1, [NETCHARGE] * -1, [NETCHARGE_DESC],
									[ADDL_CHARGE] * -1, [ADDL_CHARGE_DESC], [PROD_CHARGE] * -1, [PROD_DESC], [COLOR_CHARGE] * -1, [COLOR_DESC], [LINE_TOTAL] * -1, --[LINE_CANCELLED],
									[BLEED_PCT], [BLEED_AMT] * -1, [POSITION_PCT], [POSITION_AMT] * -1, [PREMIUM_PCT], [PREMIUM_AMT] * -1,
									[DATE_TO_BILL], 
									--[BILLING_USER], [AR_INV_NBR], [AR_TYPE], [AR_INV_SEQ], [GLEXACT], [GLESEQ_SALES], [GLESEQ_COS], [GLESEQ_WIP],
									[MARKUP_PCT], [REBATE_PCT], [DISCOUNT_PCT], [TAX_CODE], [TAX_CITY_PCT], [TAX_COUNTY_PCT], [TAX_STATE_PCT], [TAX_RESALE],
									[TAXAPPLYC], [TAXAPPLYLN], [TAXAPPLYND], [TAXAPPLYNC], [TAXAPPLYR], [TAXAPPLYAI], [RECONCILE_FLAG],
									--[GLESEQ_STATE], [GLESEQ_COUNTY], [GLESEQ_CITY], [GLEXACT_DEF], [GLACODE_SALES], [GLACODE_COS], [GLACODE_WIP], [GLACODE_STATE],
									--[GLACODE_COUNTY], [GLACODE_CITY], 
									[NON_BILL_FLAG], 
									[MODIFIED_BY], [MODIFIED_DATE], [MODIFIED_COMMENTS], [BILL_TYPE_FLAG], [COMM_PCT],							   
									--[GLESEQ_SALES_DEF], [GLESEQ_COS_DEF], [GLACODE_SALES_DEF], [GLACODE_COS_DEF], 
									[BILLING_AMT] * -1, [BILL_CANCELLED],
									[EST_NBR], [EST_LINE_NBR], [EST_REV_NBR], [FLAT_NETCHARGE] * -1, [FLAT_ADDL_CHARGE] * -1, [FLAT_DISCOUNT_AMT] * -1, [PRODUCTION_SIZE],
									[MAT_COMP], [SIZE_CODE], [MG_CIRCULATION]
						FROM  [dbo].[MAGAZINE_DETAIL]
						WHERE	 ORDER_NBR = @order_nbr
						AND  	LINE_NBR = @line_nbr
						AND  	REV_NBR = @rev_nbr
						AND  	SEQ_NBR = @seq_nbr;		
						
						IF @reconcile_by = 'L' BEGIN
							/** Do new AP Amounts row later **/
							SET @ROW_ID = @ROW_ID + 1				
						END
					END	
					ELSE IF @media_type = 'O' BEGIN
						SELECT
							@order_nbr = ORDER_NBR,
							@line_nbr = LINE_NBR,
							@rev_nbr = REV_NBR,
							@seq_nbr = SEQ_NBR
						FROM 
							@OUTDOOR_DETAIL_TABLE
						WHERE
							RowID = @ROW_ID;		
							
						--SELECT 	@order_nbr, 	@line_nbr,  @rev_nbr, @seq_nbr
						
						/*PJH 08/12/13 - Use Order/Line	*/
						UPDATE	 dbo.OUTDOOR_DETAIL SET ACTIVE_REV = NULL
						WHERE	 ORDER_NBR = @order_nbr
						AND		LINE_NBR = @line_nbr;
						
						/* PJH 08/27/13 - Reverse Quantities */
						INSERT INTO [dbo].[OUTDOOR_DETAIL]
								   ([ORDER_NBR], [LINE_NBR], [REV_NBR], [SEQ_NBR], [ACTIVE_REV], [LINK_DETID], [POST_DATE], [END_DATE], [CLOSE_DATE]
								   ,[MATL_CLOSE_DATE], [EXT_CLOSE_DATE], [EXT_MATL_DATE], [HEADLINE], [OUTDOOR_TYPE], [SIZE]
								   ,[LOCATION], [COPY_AREA]
								   ,[JOB_NUMBER], [JOB_COMPONENT_NBR], [RATE_CARD], [RATE_TYPE], [RATE_DESC]
								   ,[QUANTITY], [RATE], [NET_RATE], [GROSS_RATE], [EXT_NET_AMT], [EXT_GROSS_AMT], [COMM_AMT], [REBATE_AMT]
								   ,[DISCOUNT_AMT], [DISCOUNT_DESC], [STATE_AMT], [COUNTY_AMT], [CITY_AMT], [NON_RESALE_AMT], [NETCHARGE], [NCDESC]
								   ,[ADDL_CHARGE], [ADDL_CHARGE_DESC], [LINE_TOTAL] --,[LINE_CANCELLED]
								   ,[DATE_TO_BILL]
								   --,[BILLING_USER], [AR_INV_NBR], [AR_TYPE], [AR_INV_SEQ], [GLEXACT], [GLESEQ_SALES], [GLESEQ_COS], [GLESEQ_WIP]
								   --,[GLESEQ_STATE], [GLESEQ_COUNTY], [GLESEQ_CITY], [GLEXACT_DEF], [GLACODE_SALES], [GLACODE_COS], [GLACODE_WIP]
								   --,[GLACODE_STATE], [GLACODE_COUNTY], [GLACODE_CITY]
								   ,[NON_BILL_FLAG]
								   ,[MODIFIED_BY], [MODIFIED_DATE], [MODIFIED_COMMENTS], [BILL_TYPE_FLAG]
								   ,[COMM_PCT], [MARKUP_PCT], [REBATE_PCT], [DISCOUNT_PCT]
								   ,[TAX_CODE], [TAX_CITY_PCT], [TAX_COUNTY_PCT], [TAX_STATE_PCT], [TAX_RESALE]
								   ,[TAXAPPLYC], [TAXAPPLYLN], [TAXAPPLYND], [TAXAPPLYNC], [TAXAPPLYR], [TAXAPPLYAI]
								   --,[RECONCILE_FLAG], [GLESEQ_SALES_DEF], [GLESEQ_COS_DEF], [GLACODE_SALES_DEF], [GLACODE_COS_DEF]
								   ,[BILLING_AMT] , [BILL_CANCELLED]
								   ,[EST_NBR], [EST_LINE_NBR], [EST_REV_NBR], [AD_NUMBER], [MAT_COMP], [IMPRESSIONS], [ACTUAL_IMPRESSIONS])
								SELECT
									ORDER_NBR, LINE_NBR, REV_NBR, @seq_nbr + 1, NULL, NULL, [POST_DATE], [END_DATE], [CLOSE_DATE]
								   ,[MATL_CLOSE_DATE], [EXT_CLOSE_DATE], [EXT_MATL_DATE], [HEADLINE], [OUTDOOR_TYPE], [SIZE]
								   ,[LOCATION], [COPY_AREA]
								   ,[JOB_NUMBER], [JOB_COMPONENT_NBR], [RATE_CARD], [RATE_TYPE], [RATE_DESC]
								   ,[QUANTITY] * -1, [RATE], [NET_RATE], [GROSS_RATE], [EXT_NET_AMT] * -1, [EXT_GROSS_AMT] * -1, [COMM_AMT] * -1, [REBATE_AMT] * -1
								   ,[DISCOUNT_AMT] * -1, [DISCOUNT_DESC], [STATE_AMT] * -1, [COUNTY_AMT] * -1, [CITY_AMT] * -1, [NON_RESALE_AMT] * -1, [NETCHARGE] * -1, [NCDESC]
								   ,[ADDL_CHARGE] * -1, [ADDL_CHARGE_DESC], [LINE_TOTAL] * -1 --,[LINE_CANCELLED]
								   ,[DATE_TO_BILL]
								   --,[BILLING_USER], [AR_INV_NBR], [AR_TYPE], [AR_INV_SEQ], [GLEXACT], [GLESEQ_SALES], [GLESEQ_COS], [GLESEQ_WIP]
								   --,[GLESEQ_STATE], [GLESEQ_COUNTY], [GLESEQ_CITY], [GLEXACT_DEF], [GLACODE_SALES], [GLACODE_COS], [GLACODE_WIP]
								   --,[GLACODE_STATE], [GLACODE_COUNTY], [GLACODE_CITY]
								   ,[NON_BILL_FLAG]
								   ,[MODIFIED_BY], [MODIFIED_DATE], [MODIFIED_COMMENTS], [BILL_TYPE_FLAG]
								   ,[COMM_PCT], [MARKUP_PCT], [REBATE_PCT], [DISCOUNT_PCT]
								   ,[TAX_CODE], [TAX_CITY_PCT], [TAX_COUNTY_PCT], [TAX_STATE_PCT], [TAX_RESALE]
								   ,[TAXAPPLYC], [TAXAPPLYLN], [TAXAPPLYND], [TAXAPPLYNC], [TAXAPPLYR], [TAXAPPLYAI]
								   --,[RECONCILE_FLAG], [GLESEQ_SALES_DEF], [GLESEQ_COS_DEF], [GLACODE_SALES_DEF], [GLACODE_COS_DEF]
								   ,[BILLING_AMT] * -1 , [BILL_CANCELLED]
								   ,[EST_NBR], [EST_LINE_NBR], [EST_REV_NBR], [AD_NUMBER], [MAT_COMP], [IMPRESSIONS], [ACTUAL_IMPRESSIONS]
						FROM  [dbo].[OUTDOOR_DETAIL]
						WHERE	 ORDER_NBR = @order_nbr
						AND  	LINE_NBR = @line_nbr
						AND  	REV_NBR = @rev_nbr
						AND  	SEQ_NBR = @seq_nbr;		
						
						IF @reconcile_by = 'L' BEGIN
							/** Do new AP Amounts row later **/
							SET @ROW_ID = @ROW_ID + 1				
						END
					END	
					ELSE IF @media_type = 'T' BEGIN
					
						SELECT
							@order_nbr = ORDER_NBR,
							@line_nbr = LINE_NBR,
							@rev_nbr = REV_NBR,
							@seq_nbr = SEQ_NBR
						FROM 
							@TV_DETAIL_TABLE
						WHERE
							RowID = @ROW_ID;		
							
						--SELECT 	@order_nbr, 	@line_nbr,  @rev_nbr, @seq_nbr
						
						/*PJH 08/12/13 - Use Order/Line	*/
						UPDATE	 dbo.TV_DETAIL SET ACTIVE_REV = NULL
						WHERE	 ORDER_NBR = @order_nbr
						AND		LINE_NBR = @line_nbr;
						
						/* PJH 08/27/13 - Reverse Quantities */
						INSERT INTO [dbo].[TV_DETAIL]
								   ([ORDER_NBR],  [LINE_NBR],  [REV_NBR],  [SEQ_NBR],  [ACTIVE_REV],  [LINK_DETID],  [BUY_TYPE]
									, [START_DATE],  [END_DATE],  [MONTH_NBR],  [YEAR_NBR],  [CLOSE_DATE],  [MATL_CLOSE_DATE],  [EXT_CLOSE_DATE],  [EXT_MATL_DATE]
									, [DATE1],  [DATE2],  [DATE3],  [DATE4],  [DATE5],  [DATE6],  [DATE7]
									, [MONDAY],  [TUESDAY],  [WEDNESDAY],  [THURSDAY],  [FRIDAY],  [SATURDAY],  [SUNDAY]
									, [SPOTS1],  [SPOTS2],  [SPOTS3],  [SPOTS4],  [SPOTS5],  [SPOTS6],  [SPOTS7],  [TOTAL_SPOTS]
									, [JOB_NUMBER],  [JOB_COMPONENT_NBR],  [QUANTITY],  [RATE],  [NET_RATE],  [GROSS_RATE]
									, [EXT_NET_AMT],  [EXT_GROSS_AMT],  [COMM_AMT],  [REBATE_AMT],  [DISCOUNT_AMT],  [DISCOUNT_DESC]
									, [STATE_AMT],  [COUNTY_AMT],  [CITY_AMT],  [NON_RESALE_AMT],  [NETCHARGE],  [NCDESC]
									, [ADDL_CHARGE],  [ADDL_CHARGE_DESC],  [LINE_TOTAL],  [LINE_CANCELLED],  [DATE_TO_BILL],  [BILLING_USER]
									, [AR_INV_NBR],  [AR_TYPE],  [AR_INV_SEQ]
									, [GLEXACT],  [GLESEQ_SALES],  [GLESEQ_COS],  [GLESEQ_WIP],  [GLESEQ_STATE],  [GLESEQ_COUNTY],  [GLESEQ_CITY]
									, [GLEXACT_DEF],  [GLACODE_SALES],  [GLACODE_COS],  [GLACODE_WIP],  [GLACODE_STATE],  [GLACODE_COUNTY],  [GLACODE_CITY]
									, [NON_BILL_FLAG],  [MODIFIED_BY],  [MODIFIED_DATE],  [MODIFIED_COMMENTS],  [BILL_TYPE_FLAG]
									, [COMM_PCT],  [MARKUP_PCT],  [REBATE_PCT],  [DISCOUNT_PCT],  [TAX_CODE],  [TAX_CITY_PCT],  [TAX_COUNTY_PCT],  [TAX_STATE_PCT]
									, [TAX_RESALE],  [TAXAPPLYC],  [TAXAPPLYLN],  [TAXAPPLYND],  [TAXAPPLYNC],  [TAXAPPLYR],  [TAXAPPLYAI]
									, [RECONCILE_FLAG],  [GLESEQ_SALES_DEF],  [GLESEQ_COS_DEF],  [GLACODE_SALES_DEF],  [GLACODE_COS_DEF]
									, [BILLING_AMT],  [COST_TYPE],  [COST_RATE],  [NET_BASE_RATE],  [GROSS_BASE_RATE]
									, [BILL_CANCELLED]
									, [EST_NBR],  [EST_LINE_NBR],  [EST_REV_NBR],  [AD_NUMBER],  [MAT_COMP],  [PROGRAMMING]
									, [START_TIME],  [END_TIME],  [LENGTH],  [REMARKS],  [TAG],  [NETWORK_ID])
						SELECT
									  [ORDER_NBR],  [LINE_NBR],  [REV_NBR],   @seq_nbr + 1,  NULL,  NULL,  [BUY_TYPE]
									, [START_DATE],  [END_DATE],  [MONTH_NBR],  [YEAR_NBR],  [CLOSE_DATE],  [MATL_CLOSE_DATE],  [EXT_CLOSE_DATE],  [EXT_MATL_DATE]
									, [DATE1],  [DATE2],  [DATE3],  [DATE4],  [DATE5],  [DATE6],  [DATE7]
									, [MONDAY],  [TUESDAY],  [WEDNESDAY],  [THURSDAY],  [FRIDAY],  [SATURDAY],  [SUNDAY]
									, -[SPOTS1],  -[SPOTS2],  -[SPOTS3],  -[SPOTS4],  -[SPOTS5],  -[SPOTS6],  -[SPOTS7],  -[TOTAL_SPOTS]
									, [JOB_NUMBER],  [JOB_COMPONENT_NBR],  [QUANTITY],  [RATE],  [NET_RATE],  [GROSS_RATE]
									, -[EXT_NET_AMT],  -[EXT_GROSS_AMT],  -[COMM_AMT],  -[REBATE_AMT],  -[DISCOUNT_AMT],  [DISCOUNT_DESC]
									, -[STATE_AMT],  -[COUNTY_AMT],  -[CITY_AMT],  -[NON_RESALE_AMT],  -[NETCHARGE],  [NCDESC]
									, -[ADDL_CHARGE],  [ADDL_CHARGE_DESC],  -[LINE_TOTAL],  [LINE_CANCELLED],  [DATE_TO_BILL],  [BILLING_USER]
									, NULL,  NULL,  NULL
									, NULL,  NULL,  NULL,  NULL,  NULL,  NULL,  NULL
									, NULL,  NULL,  NULL,  NULL,  NULL,  NULL,  NULL
									, [NON_BILL_FLAG],  @user_code,  @CURRENT_DATE,   @modified_comments + ' - Reversal',  [BILL_TYPE_FLAG]
									, [COMM_PCT],  [MARKUP_PCT],  [REBATE_PCT],  [DISCOUNT_PCT],  [TAX_CODE],  [TAX_CITY_PCT],  [TAX_COUNTY_PCT],  [TAX_STATE_PCT]
									, [TAX_RESALE],  [TAXAPPLYC],  [TAXAPPLYLN],  [TAXAPPLYND],  [TAXAPPLYNC],  [TAXAPPLYR],  [TAXAPPLYAI]
									, [RECONCILE_FLAG],  NULL,  NULL,  NULL,  NULL
									, -[BILLING_AMT],  [COST_TYPE],  [COST_RATE],  [NET_BASE_RATE],  [GROSS_BASE_RATE]
									, (SELECT MAX(ISNULL(BILL_CANCELLED,0)) FROM dbo.TV_DETAIL WHERE ORDER_NBR = @order_nbr AND LINE_NBR = @line_nbr)
									, [EST_NBR],  [EST_LINE_NBR],  [EST_REV_NBR],  [AD_NUMBER],  [MAT_COMP],  [PROGRAMMING]
									, [START_TIME],  [END_TIME],  [LENGTH],  [REMARKS],  [TAG],  [NETWORK_ID]						
						
						FROM	 dbo.TV_DETAIL
						WHERE	 ORDER_NBR = @order_nbr
						AND  	LINE_NBR = @line_nbr
						AND  	REV_NBR = @rev_nbr
						AND  	SEQ_NBR = @seq_nbr;		
						
						IF @reconcile_by = 'L' BEGIN
							/** Do new AP Amounts row later **/
							SET @ROW_ID = @ROW_ID + 1				
						END
						ELSE BEGIN
							/* PJH 08/27/13 - Zero Amounts */
							INSERT INTO [dbo].[TV_DETAIL]
									   ([ORDER_NBR],  [LINE_NBR],  [REV_NBR],  [SEQ_NBR],  [ACTIVE_REV],  [LINK_DETID],  [BUY_TYPE]
										, [START_DATE],  [END_DATE],  [MONTH_NBR],  [YEAR_NBR],  [CLOSE_DATE],  [MATL_CLOSE_DATE],  [EXT_CLOSE_DATE],  [EXT_MATL_DATE]
										, [DATE1],  [DATE2],  [DATE3],  [DATE4],  [DATE5],  [DATE6],  [DATE7]
										, [MONDAY],  [TUESDAY],  [WEDNESDAY],  [THURSDAY],  [FRIDAY],  [SATURDAY],  [SUNDAY]
										, [SPOTS1],  [SPOTS2],  [SPOTS3],  [SPOTS4],  [SPOTS5],  [SPOTS6],  [SPOTS7],  [TOTAL_SPOTS]
										, [JOB_NUMBER],  [JOB_COMPONENT_NBR],  [QUANTITY],  [RATE],  [NET_RATE],  [GROSS_RATE]
										, [EXT_NET_AMT],  [EXT_GROSS_AMT],  [COMM_AMT],  [REBATE_AMT],  [DISCOUNT_AMT],  [DISCOUNT_DESC]
										, [STATE_AMT],  [COUNTY_AMT],  [CITY_AMT],  [NON_RESALE_AMT],  [NETCHARGE],  [NCDESC]
										, [ADDL_CHARGE],  [ADDL_CHARGE_DESC],  [LINE_TOTAL],  [LINE_CANCELLED],  [DATE_TO_BILL],  [BILLING_USER]
										, [AR_INV_NBR],  [AR_TYPE],  [AR_INV_SEQ]
										, [GLEXACT],  [GLESEQ_SALES],  [GLESEQ_COS],  [GLESEQ_WIP],  [GLESEQ_STATE],  [GLESEQ_COUNTY],  [GLESEQ_CITY]
										, [GLEXACT_DEF],  [GLACODE_SALES],  [GLACODE_COS],  [GLACODE_WIP],  [GLACODE_STATE],  [GLACODE_COUNTY],  [GLACODE_CITY]
										, [NON_BILL_FLAG],  [MODIFIED_BY],  [MODIFIED_DATE],  [MODIFIED_COMMENTS],  [BILL_TYPE_FLAG]
										, [COMM_PCT],  [MARKUP_PCT],  [REBATE_PCT],  [DISCOUNT_PCT],  [TAX_CODE],  [TAX_CITY_PCT],  [TAX_COUNTY_PCT],  [TAX_STATE_PCT]
										, [TAX_RESALE],  [TAXAPPLYC],  [TAXAPPLYLN],  [TAXAPPLYND],  [TAXAPPLYNC],  [TAXAPPLYR],  [TAXAPPLYAI]
										, [RECONCILE_FLAG],  [GLESEQ_SALES_DEF],  [GLESEQ_COS_DEF],  [GLACODE_SALES_DEF],  [GLACODE_COS_DEF]
										, [BILLING_AMT],  [COST_TYPE],  [COST_RATE],  [NET_BASE_RATE],  [GROSS_BASE_RATE]
										, [BILL_CANCELLED]
										, [EST_NBR],  [EST_LINE_NBR],  [EST_REV_NBR],  [AD_NUMBER],  [MAT_COMP],  [PROGRAMMING]
										, [START_TIME],  [END_TIME],  [LENGTH],  [REMARKS],  [TAG],  [NETWORK_ID])
							SELECT
										  [ORDER_NBR],  [LINE_NBR],  @rev_nbr + 1, 1, 1,  NULL,  [BUY_TYPE]
										, [START_DATE],  [END_DATE],  [MONTH_NBR],  [YEAR_NBR],  [CLOSE_DATE],  [MATL_CLOSE_DATE],  [EXT_CLOSE_DATE],  [EXT_MATL_DATE]
										, [DATE1],  [DATE2],  [DATE3],  [DATE4],  [DATE5],  [DATE6],  [DATE7]
										, [MONDAY],  [TUESDAY],  [WEDNESDAY],  [THURSDAY],  [FRIDAY],  [SATURDAY],  [SUNDAY]
										, 0,  0,  0,  0,  0,  0,  0,  0
										, [JOB_NUMBER],  [JOB_COMPONENT_NBR],  0,  0,  0,  0
										, 0,  0,  0,  0,  0,  NULL
										, 0,  0,  0,  0,  0,  NULL
										, 0,  NULL,  0,  [LINE_CANCELLED],  [DATE_TO_BILL],  NULL
										, NULL,  NULL,  NULL
										, NULL,  NULL,  NULL,  NULL,  NULL,  NULL,  NULL
										, NULL,  NULL,  NULL,  NULL,  NULL,  NULL,  NULL
										, [NON_BILL_FLAG],  @user_code,  @CURRENT_DATE,   @modified_comments + ' - New Revision',  [BILL_TYPE_FLAG]
										, [COMM_PCT],  [MARKUP_PCT],  [REBATE_PCT],  [DISCOUNT_PCT],  [TAX_CODE],  [TAX_CITY_PCT],  [TAX_COUNTY_PCT],  [TAX_STATE_PCT]
										, [TAX_RESALE],  [TAXAPPLYC],  [TAXAPPLYLN],  [TAXAPPLYND],  [TAXAPPLYNC],  [TAXAPPLYR],  [TAXAPPLYAI]
										, [RECONCILE_FLAG],  NULL,  NULL,  NULL,  NULL
										, 0,  [COST_TYPE],  [COST_RATE],  0,  0
										, (SELECT MAX(ISNULL(BILL_CANCELLED,0)) FROM dbo.TV_DETAIL WHERE ORDER_NBR = @order_nbr AND LINE_NBR = @line_nbr)
										, [EST_NBR],  [EST_LINE_NBR],  [EST_REV_NBR],  [AD_NUMBER],  [MAT_COMP],  [PROGRAMMING]
										, [START_TIME],  [END_TIME],  [LENGTH],  [REMARKS],  [TAG],  [NETWORK_ID]						
							
							FROM	 dbo.TV_DETAIL
							WHERE	 ORDER_NBR = @order_nbr
							AND  	LINE_NBR = @line_nbr
							AND  	REV_NBR = @rev_nbr
							AND  	SEQ_NBR = @seq_nbr;			
							
							SET @ROW_ID = @ROW_ID + 1
						END					
					END
					ELSE IF @media_type = 'R' BEGIN
						SELECT
							@order_nbr = ORDER_NBR,
							@line_nbr = LINE_NBR,
							@rev_nbr = REV_NBR,
							@seq_nbr = SEQ_NBR
						FROM 
							@RADIO_DETAIL_TABLE
						WHERE
							RowID = @ROW_ID;		
							
						SELECT 	@order_nbr, 	@line_nbr,  @rev_nbr, @seq_nbr
						
						/*PJH 08/12/13 - Use Order/Line	*/
						UPDATE	 dbo.RADIO_DETAIL SET ACTIVE_REV = NULL
						WHERE	 ORDER_NBR = @order_nbr
						AND		LINE_NBR = @line_nbr;
						
						/* PJH 08/27/13 - Reverse Quantities */
						INSERT INTO [dbo].[RADIO_DETAIL]
								   ([ORDER_NBR],  [LINE_NBR],  [REV_NBR],  [SEQ_NBR],  [ACTIVE_REV],  [LINK_DETID],  [BUY_TYPE]
									, [START_DATE],  [END_DATE],  [MONTH_NBR],  [YEAR_NBR],  [CLOSE_DATE],  [MATL_CLOSE_DATE],  [EXT_CLOSE_DATE],  [EXT_MATL_DATE]
									, [DATE1],  [DATE2],  [DATE3],  [DATE4],  [DATE5],  [DATE6],  [DATE7]
									, [MONDAY],  [TUESDAY],  [WEDNESDAY],  [THURSDAY],  [FRIDAY],  [SATURDAY],  [SUNDAY]
									, [SPOTS1],  [SPOTS2],  [SPOTS3],  [SPOTS4],  [SPOTS5],  [SPOTS6],  [SPOTS7],  [TOTAL_SPOTS]
									, [JOB_NUMBER],  [JOB_COMPONENT_NBR],  [QUANTITY],  [RATE],  [NET_RATE],  [GROSS_RATE]
									, [EXT_NET_AMT],  [EXT_GROSS_AMT],  [COMM_AMT],  [REBATE_AMT],  [DISCOUNT_AMT],  [DISCOUNT_DESC]
									, [STATE_AMT],  [COUNTY_AMT],  [CITY_AMT],  [NON_RESALE_AMT],  [NETCHARGE],  [NCDESC]
									, [ADDL_CHARGE],  [ADDL_CHARGE_DESC],  [LINE_TOTAL],  [LINE_CANCELLED],  [DATE_TO_BILL],  [BILLING_USER]
									, [AR_INV_NBR],  [AR_TYPE],  [AR_INV_SEQ]
									, [GLEXACT],  [GLESEQ_SALES],  [GLESEQ_COS],  [GLESEQ_WIP],  [GLESEQ_STATE],  [GLESEQ_COUNTY],  [GLESEQ_CITY]
									, [GLEXACT_DEF],  [GLACODE_SALES],  [GLACODE_COS],  [GLACODE_WIP],  [GLACODE_STATE],  [GLACODE_COUNTY],  [GLACODE_CITY]
									, [NON_BILL_FLAG],  [MODIFIED_BY],  [MODIFIED_DATE],  [MODIFIED_COMMENTS],  [BILL_TYPE_FLAG]
									, [COMM_PCT],  [MARKUP_PCT],  [REBATE_PCT],  [DISCOUNT_PCT],  [TAX_CODE],  [TAX_CITY_PCT],  [TAX_COUNTY_PCT],  [TAX_STATE_PCT]
									, [TAX_RESALE],  [TAXAPPLYC],  [TAXAPPLYLN],  [TAXAPPLYND],  [TAXAPPLYNC],  [TAXAPPLYR],  [TAXAPPLYAI]
									, [RECONCILE_FLAG],  [GLESEQ_SALES_DEF],  [GLESEQ_COS_DEF],  [GLACODE_SALES_DEF],  [GLACODE_COS_DEF]
									, [BILLING_AMT],  [COST_TYPE],  [COST_RATE],  [NET_BASE_RATE],  [GROSS_BASE_RATE]
									, [BILL_CANCELLED]
									, [EST_NBR],  [EST_LINE_NBR],  [EST_REV_NBR],  [AD_NUMBER],  [MAT_COMP],  [PROGRAMMING]
									, [START_TIME],  [END_TIME],  [LENGTH],  [REMARKS],  [TAG],  [NETWORK_ID])
						SELECT
									  [ORDER_NBR],  [LINE_NBR],  [REV_NBR],   @seq_nbr + 1,  NULL,  NULL,  [BUY_TYPE]
									, [START_DATE],  [END_DATE],  [MONTH_NBR],  [YEAR_NBR],  [CLOSE_DATE],  [MATL_CLOSE_DATE],  [EXT_CLOSE_DATE],  [EXT_MATL_DATE]
									, [DATE1],  [DATE2],  [DATE3],  [DATE4],  [DATE5],  [DATE6],  [DATE7]
									, [MONDAY],  [TUESDAY],  [WEDNESDAY],  [THURSDAY],  [FRIDAY],  [SATURDAY],  [SUNDAY]
									, -[SPOTS1],  -[SPOTS2],  -[SPOTS3],  -[SPOTS4],  -[SPOTS5],  -[SPOTS6],  -[SPOTS7],  -[TOTAL_SPOTS]
									, [JOB_NUMBER],  [JOB_COMPONENT_NBR],  [QUANTITY],  [RATE],  [NET_RATE],  [GROSS_RATE]
									, -[EXT_NET_AMT],  -[EXT_GROSS_AMT],  -[COMM_AMT],  -[REBATE_AMT],  -[DISCOUNT_AMT],  [DISCOUNT_DESC]
									, -[STATE_AMT],  -[COUNTY_AMT],  -[CITY_AMT],  -[NON_RESALE_AMT],  -[NETCHARGE],  [NCDESC]
									, -[ADDL_CHARGE],  [ADDL_CHARGE_DESC],  -[LINE_TOTAL],  [LINE_CANCELLED],  [DATE_TO_BILL],  [BILLING_USER]
									, NULL,  NULL,  NULL
									, NULL,  NULL,  NULL,  NULL,  NULL,  NULL,  NULL
									, NULL,  NULL,  NULL,  NULL,  NULL,  NULL,  NULL
									, [NON_BILL_FLAG],  @user_code,  @CURRENT_DATE,   @modified_comments + ' - Reversal',  [BILL_TYPE_FLAG]
									, [COMM_PCT],  [MARKUP_PCT],  [REBATE_PCT],  [DISCOUNT_PCT],  [TAX_CODE],  [TAX_CITY_PCT],  [TAX_COUNTY_PCT],  [TAX_STATE_PCT]
									, [TAX_RESALE],  [TAXAPPLYC],  [TAXAPPLYLN],  [TAXAPPLYND],  [TAXAPPLYNC],  [TAXAPPLYR],  [TAXAPPLYAI]
									, [RECONCILE_FLAG],  NULL,  NULL,  NULL,  NULL
									, -[BILLING_AMT],  [COST_TYPE],  [COST_RATE],  [NET_BASE_RATE],  [GROSS_BASE_RATE]
									, (SELECT MAX(ISNULL(BILL_CANCELLED,0)) FROM dbo.RADIO_DETAIL WHERE ORDER_NBR = @order_nbr AND LINE_NBR = @line_nbr)
									, [EST_NBR],  [EST_LINE_NBR],  [EST_REV_NBR],  [AD_NUMBER],  [MAT_COMP],  [PROGRAMMING]
									, [START_TIME],  [END_TIME],  [LENGTH],  [REMARKS],  [TAG],  [NETWORK_ID]						
						
						FROM	 dbo.RADIO_DETAIL
						WHERE	 ORDER_NBR = @order_nbr
						AND  	LINE_NBR = @line_nbr
						AND  	REV_NBR = @rev_nbr
						AND  	SEQ_NBR = @seq_nbr;		
						
						IF @reconcile_by = 'L' BEGIN
							/** Do new AP Amounts row later **/
							SET @ROW_ID = @ROW_ID + 1				
						END
						ELSE BEGIN
							/* PJH 08/27/13 - Zero Amounts */
							INSERT INTO [dbo].[RADIO_DETAIL]
									   ([ORDER_NBR],  [LINE_NBR],  [REV_NBR],  [SEQ_NBR],  [ACTIVE_REV],  [LINK_DETID],  [BUY_TYPE]
										, [START_DATE],  [END_DATE],  [MONTH_NBR],  [YEAR_NBR],  [CLOSE_DATE],  [MATL_CLOSE_DATE],  [EXT_CLOSE_DATE],  [EXT_MATL_DATE]
										, [DATE1],  [DATE2],  [DATE3],  [DATE4],  [DATE5],  [DATE6],  [DATE7]
										, [MONDAY],  [TUESDAY],  [WEDNESDAY],  [THURSDAY],  [FRIDAY],  [SATURDAY],  [SUNDAY]
										, [SPOTS1],  [SPOTS2],  [SPOTS3],  [SPOTS4],  [SPOTS5],  [SPOTS6],  [SPOTS7],  [TOTAL_SPOTS]
										, [JOB_NUMBER],  [JOB_COMPONENT_NBR],  [QUANTITY],  [RATE],  [NET_RATE],  [GROSS_RATE]
										, [EXT_NET_AMT],  [EXT_GROSS_AMT],  [COMM_AMT],  [REBATE_AMT],  [DISCOUNT_AMT],  [DISCOUNT_DESC]
										, [STATE_AMT],  [COUNTY_AMT],  [CITY_AMT],  [NON_RESALE_AMT],  [NETCHARGE],  [NCDESC]
										, [ADDL_CHARGE],  [ADDL_CHARGE_DESC],  [LINE_TOTAL],  [LINE_CANCELLED],  [DATE_TO_BILL],  [BILLING_USER]
										, [AR_INV_NBR],  [AR_TYPE],  [AR_INV_SEQ]
										, [GLEXACT],  [GLESEQ_SALES],  [GLESEQ_COS],  [GLESEQ_WIP],  [GLESEQ_STATE],  [GLESEQ_COUNTY],  [GLESEQ_CITY]
										, [GLEXACT_DEF],  [GLACODE_SALES],  [GLACODE_COS],  [GLACODE_WIP],  [GLACODE_STATE],  [GLACODE_COUNTY],  [GLACODE_CITY]
										, [NON_BILL_FLAG],  [MODIFIED_BY],  [MODIFIED_DATE],  [MODIFIED_COMMENTS],  [BILL_TYPE_FLAG]
										, [COMM_PCT],  [MARKUP_PCT],  [REBATE_PCT],  [DISCOUNT_PCT],  [TAX_CODE],  [TAX_CITY_PCT],  [TAX_COUNTY_PCT],  [TAX_STATE_PCT]
										, [TAX_RESALE],  [TAXAPPLYC],  [TAXAPPLYLN],  [TAXAPPLYND],  [TAXAPPLYNC],  [TAXAPPLYR],  [TAXAPPLYAI]
										, [RECONCILE_FLAG],  [GLESEQ_SALES_DEF],  [GLESEQ_COS_DEF],  [GLACODE_SALES_DEF],  [GLACODE_COS_DEF]
										, [BILLING_AMT],  [COST_TYPE],  [COST_RATE],  [NET_BASE_RATE],  [GROSS_BASE_RATE]
										, [BILL_CANCELLED]
										, [EST_NBR],  [EST_LINE_NBR],  [EST_REV_NBR],  [AD_NUMBER],  [MAT_COMP],  [PROGRAMMING]
										, [START_TIME],  [END_TIME],  [LENGTH],  [REMARKS],  [TAG],  [NETWORK_ID])
							SELECT
										  [ORDER_NBR],  [LINE_NBR],  @rev_nbr + 1, 1,  1,  NULL,  [BUY_TYPE]
										, [START_DATE],  [END_DATE],  [MONTH_NBR],  [YEAR_NBR],  [CLOSE_DATE],  [MATL_CLOSE_DATE],  [EXT_CLOSE_DATE],  [EXT_MATL_DATE]
										, [DATE1],  [DATE2],  [DATE3],  [DATE4],  [DATE5],  [DATE6],  [DATE7]
										, [MONDAY],  [TUESDAY],  [WEDNESDAY],  [THURSDAY],  [FRIDAY],  [SATURDAY],  [SUNDAY]
										, 0,  0,  0,  0,  0,  0,  0,  0
										, [JOB_NUMBER],  [JOB_COMPONENT_NBR],  0,  0,  0,  0
										, 0,  0,  0,  0,  0,  NULL
										, 0,  0,  0,  0,  0,  NULL
										, 0,  NULL,  0,  [LINE_CANCELLED],  [DATE_TO_BILL],  NULL
										, NULL,  NULL,  NULL
										, NULL,  NULL,  NULL,  NULL,  NULL,  NULL,  NULL
										, NULL,  NULL,  NULL,  NULL,  NULL,  NULL,  NULL
										, [NON_BILL_FLAG],  @user_code,  @CURRENT_DATE,   @modified_comments + ' - New Revision',  [BILL_TYPE_FLAG]
										, [COMM_PCT],  [MARKUP_PCT],  [REBATE_PCT],  [DISCOUNT_PCT],  [TAX_CODE],  [TAX_CITY_PCT],  [TAX_COUNTY_PCT],  [TAX_STATE_PCT]
										, [TAX_RESALE],  [TAXAPPLYC],  [TAXAPPLYLN],  [TAXAPPLYND],  [TAXAPPLYNC],  [TAXAPPLYR],  [TAXAPPLYAI]
										, [RECONCILE_FLAG],  NULL,  NULL,  NULL,  NULL
										, 0,  [COST_TYPE],  [COST_RATE],  0,  0
										, (SELECT MAX(ISNULL(BILL_CANCELLED,0)) FROM dbo.RADIO_DETAIL WHERE ORDER_NBR = @order_nbr AND LINE_NBR = @line_nbr)
										, [EST_NBR],  [EST_LINE_NBR],  [EST_REV_NBR],  [AD_NUMBER],  [MAT_COMP],  [PROGRAMMING]
										, [START_TIME],  [END_TIME],  [LENGTH],  [REMARKS],  [TAG],  [NETWORK_ID]						
							
							FROM	 dbo.RADIO_DETAIL
							WHERE	 ORDER_NBR = @order_nbr
							AND  	LINE_NBR = @line_nbr
							AND  	REV_NBR = @rev_nbr
							AND  	SEQ_NBR = @seq_nbr;		
							
							--SELECT * FROM dbo.RADIO_DETAIL WHERE	 ORDER_NBR = @order_nbr  AND  	LINE_NBR = @line_nbr	--AND  	REV_NBR = @rev_nbr	AND  	SEQ_NBR = @seq_nbr; /****** DEBUG ******/			
							
							SET @ROW_ID = @ROW_ID + 1
						END	
					END
				END
			END /* @DIFFERENCE_LINE */
		END
		-- STOP INTERNET_DETAIL
		
		/* New Revision OR Line AND Roll Forward Difference between Order and AP */
		IF @DIFFERENCE_LINE = 0 BEGIN
			/* If Line level then new Revision  */
			IF @reconcile_by = 'L' BEGIN
				IF @media_type = 'I' BEGIN
					INSERT INTO dbo.INTERNET_DETAIL  ( ORDER_NBR, LINE_NBR, REV_NBR, SEQ_NBR,
						ACTIVE_REV, LINK_DETID, [START_DATE], END_DATE, CLOSE_DATE, MATL_CLOSE_DATE, EXT_CLOSE_DATE, EXT_MATL_DATE, HEADLINE, INTERNET_TYPE,
						SIZE, PROJ_IMPRESSIONS, GUARANTEED_IMPRESS, URL, TARGET_AUDIENCE, COPY_AREA, JOB_NUMBER, JOB_COMPONENT_NBR, RATE_CARD, RATE_TYPE, RATE_DESC, QUANTITY, 
						RATE, NET_RATE, GROSS_RATE, EXT_NET_AMT, EXT_GROSS_AMT,
						COMM_AMT, REBATE_AMT, DISCOUNT_AMT, DISCOUNT_DESC, STATE_AMT, COUNTY_AMT, CITY_AMT, NON_RESALE_AMT, NETCHARGE, NCDESC, ADDL_CHARGE, ADDL_CHARGE_DESC, 
				
						LINE_TOTAL, LINE_CANCELLED, DATE_TO_BILL, BILLING_USER,
				
						AR_INV_NBR, AR_TYPE, AR_INV_SEQ, GLEXACT, GLESEQ_SALES, GLESEQ_COS, GLESEQ_WIP, GLESEQ_STATE, GLESEQ_COUNTY, GLESEQ_CITY, GLEXACT_DEF, GLESEQ_COS_DEF, GLESEQ_SALES_DEF, 
						GLACODE_SALES, GLACODE_COS, GLACODE_WIP,
						GLACODE_STATE, GLACODE_COUNTY, GLACODE_CITY, NON_BILL_FLAG, MODIFIED_BY, MODIFIED_DATE, MODIFIED_COMMENTS, BILL_TYPE_FLAG, CREATIVE_SIZE, PLACEMENT_1, PLACEMENT_2, COMM_PCT, 
						MARKUP_PCT, REBATE_PCT, DISCOUNT_PCT,
						TAX_CODE, TAX_CITY_PCT, TAX_COUNTY_PCT, TAX_STATE_PCT, TAX_RESALE, TAXAPPLYC, TAXAPPLYLN, TAXAPPLYND, TAXAPPLYNC, TAXAPPLYR, TAXAPPLYAI, RECONCILE_FLAG, ACT_IMPRESSIONS, 
						GLACODE_SALES_DEF, GLACODE_COS_DEF,
						BILLING_AMT, COST_TYPE, COST_RATE, NET_BASE_RATE, GROSS_BASE_RATE, 
						BILL_CANCELLED, EST_NBR, EST_LINE_NBR, EST_REV_NBR )
					SELECT
						ORDER_NBR, LINE_NBR, @rev_nbr + 1, 0,
						1, NULL, [START_DATE], END_DATE, CLOSE_DATE, MATL_CLOSE_DATE, EXT_CLOSE_DATE, EXT_MATL_DATE, HEADLINE, INTERNET_TYPE,
						SIZE, NULL, @dec_ACTUAL_IMPRESSIONS, URL, TARGET_AUDIENCE, COPY_AREA, JOB_NUMBER, JOB_COMPONENT_NBR, RATE_CARD, RATE_TYPE, RATE_DESC, QUANTITY, 
						@dec_RECONCILE_RATE, @dec_NET_AMT, @dec_GROSS_AMT, @dec_NET_AMT, @dec_GROSS_AMT,
						@dec_COMM_AMT, @dec_REBATE_AMT, @dec_DISCOUNT_AMT, DISCOUNT_DESC, @dec_STATE_TAX, @dec_COUNTY_TAX, @dec_CITY_TAX, @dec_VENDOR_TAX, @dec_NETCHARGES, 'AP Reconcile', @dec_O_ADDL_CHARGE, 'AP Reconcile', 
				
						@dec_LINE_TOTAL, LINE_CANCELLED, DATE_TO_BILL, BILLING_USER, --PJH 06/08/2015 changed @dec_AP_NET_AMT to @dec_LINE_TOTAL
				
						NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 
						NULL, NULL, NULL,
						NULL, NULL, NULL, NON_BILL_FLAG, @user_code, @CURRENT_DATE, @modified_comments + ' - Summary', BILL_TYPE_FLAG, CREATIVE_SIZE, PLACEMENT_1, PLACEMENT_2, COMM_PCT, 
						MARKUP_PCT, REBATE_PCT, DISCOUNT_PCT,
						@AP_TAX_CODE, @dec_CITY_PCT, @dec_COUNTY_PCT, @dec_STATE_PCT, @TAX_RESALE, @TAXAPPLYC, @TAXAPPLYLN, @TAXAPPLYLND, @TAXAPPLYNC, @TAXAPPLYR, @TAXAPPLYAI, NULL, @dec_ACTUAL_IMPRESSIONS, 
						GLACODE_SALES_DEF, GLACODE_COS_DEF,
						@dec_AP_BILLING_AMT, COST_TYPE, @dec_COST_RATE, @dec_NEW_NET_RATE, @dec_NEW_GROSS_RATE, 
						(SELECT MAX(ISNULL(BILL_CANCELLED,0)) FROM dbo.INTERNET_DETAIL WHERE ORDER_NBR = @order_nbr AND LINE_NBR = @line_nbr), EST_NBR, EST_LINE_NBR, EST_REV_NBR
					FROM	 dbo.INTERNET_DETAIL
					WHERE	 ORDER_NBR = @order_nbr
					AND  	LINE_NBR = @line_nbr
					AND  	REV_NBR = @rev_nbr
					AND  	SEQ_NBR = @seq_nbr;	
				END

			--SET @dec_NET_BASE_RATE = ROUND(@dec_NET_BASE_RATE,4) 
			--SET @dec_GROSS_BASE_RATE = ROUND(@dec_GROSS_BASE_RATE,4)
			--SET @dec_NEW_NET_RATE = ROUND(@dec_NEW_NET_RATE,4) 
			--SET @dec_NEW_GROSS_RATE = ROUND(@dec_NEW_GROSS_RATE,4)
			--SET @dec_RECONCILE_RATE = ROUND(@dec_RECONCILE_RATE,4)
			--SET @dec_TEMP_RATE = ROUND(@dec_TEMP_RATE,4)
			
			--SET @dec_COST_RATE = @dec_TEMP_RATE


				ELSE IF @media_type = 'N' BEGIN  /* PJH 09/26/2020 */
					INSERT INTO [dbo].[NEWSPAPER_DETAIL]
								([ORDER_NBR], [LINE_NBR], [REV_NBR], [SEQ_NBR], [ACTIVE_REV], [LINK_DETID], [START_DATE], [END_DATE], [CLOSE_DATE],
								[MATL_CLOSE_DATE], [EXT_CLOSE_DATE], [EXT_MATL_DATE], [SIZE], [AD_NUMBER], [HEADLINE], [MATERIAL], [EDITION_ISSUE], [SECTION],
								[JOB_NUMBER], [JOB_COMPONENT_NBR], [RATE_CARD_ID], [RATE_DTL_ID], [PRINT_COLUMNS], [PRINT_INCHES], [PRINT_LINES], [CONTRACT_QTY],
								[QUANTITY], [RATE], [NET_RATE], [GROSS_RATE], [FLAT_NET], [FLAT_GROSS], [EXT_NET_AMT], [EXT_GROSS_AMT], [COMM_AMT], [REBATE_AMT],
								[DISCOUNT_AMT], [DISCOUNT_DESC], [STATE_AMT], [COUNTY_AMT], [CITY_AMT], [NON_RESALE_AMT], [NETCHARGE], [NETCHARGE_DESC],
								[ADDL_CHARGE], [ADDL_CHARGE_DESC], [PROD_CHARGE], [PROD_DESC], [COLOR_CHARGE], [COLOR_DESC], [LINE_TOTAL], [LINE_CANCELLED],
								[DATE_TO_BILL], --[BILLING_USER], [AR_INV_NBR], [AR_TYPE], [AR_INV_SEQ], [GLEXACT], [GLESEQ_SALES], [GLESEQ_COS], [GLESEQ_WIP],
								[MARKUP_PCT], [REBATE_PCT], [DISCOUNT_PCT], 
								[TAX_CODE], [TAX_CITY_PCT], [TAX_COUNTY_PCT], [TAX_STATE_PCT], [TAX_RESALE], [TAXAPPLYC], [TAXAPPLYLN], [TAXAPPLYND], [TAXAPPLYNC], [TAXAPPLYR], [TAXAPPLYAI], [RECONCILE_FLAG],
								--[GLESEQ_STATE], [GLESEQ_COUNTY], [GLESEQ_CITY], [GLEXACT_DEF], [GLACODE_SALES], [GLACODE_COS], [GLACODE_WIP], [GLACODE_STATE],
								--[GLACODE_COUNTY], [GLACODE_CITY], 
								[NON_BILL_FLAG], [MODIFIED_BY], [MODIFIED_DATE], [MODIFIED_COMMENTS], [BILL_TYPE_FLAG], [COMM_PCT],							   
								--[GLESEQ_SALES_DEF], [GLESEQ_COS_DEF], [GLACODE_SALES_DEF], [GLACODE_COS_DEF], 
								[BILLING_AMT], [BILL_CANCELLED],
								[EST_NBR], [EST_LINE_NBR], [EST_REV_NBR], [FLAT_NETCHARGE], [FLAT_ADDL_CHARGE], [FLAT_DISCOUNT_AMT], [PRODUCTION_SIZE],
								[MAT_COMP], [SIZE_CODE], [COST_TYPE], [COST_RATE], [RATE_TYPE], [NP_CIRCULATION], [PRINT_QUANTITY])
							SELECT --DATE_TO_BILL, NON_BILL_FLAG??
								ORDER_NBR, LINE_NBR, @rev_nbr + 1, 0, 1, NULL, [START_DATE], [END_DATE], [CLOSE_DATE],
								[MATL_CLOSE_DATE], [EXT_CLOSE_DATE], [EXT_MATL_DATE], [SIZE], [AD_NUMBER], [HEADLINE], [MATERIAL], [EDITION_ISSUE], [SECTION],
								[JOB_NUMBER], [JOB_COMPONENT_NBR], [RATE_CARD_ID], [RATE_DTL_ID], [PRINT_COLUMNS], [PRINT_INCHES], @dec_AP_PRINT_LINES, @dec_CONTRACT_QTY,
								[QUANTITY], @dec_RECONCILE_RATE,  @dec_NEW_NET_RATE, @dec_NEW_GROSS_RATE,  @dec_NET_BASE_RATE, @dec_GROSS_BASE_RATE, @dec_NET_AMT, @dec_GROSS_AMT, @dec_COMM_AMT, @dec_REBATE_AMT,
								@dec_DISCOUNT_AMT, [DISCOUNT_DESC], @dec_STATE_TAX, @dec_COUNTY_TAX, @dec_CITY_TAX, @dec_VENDOR_TAX, @dec_NETCHARGES, 'AP Reconcile',
								@dec_O_ADDL_CHARGE, 'AP Reconcile', @dec_PROD_CHARGE, 'AP Reconcile', @dec_COLOR_NET, 'AP Reconcile', @dec_LINE_TOTAL, [LINE_CANCELLED],
								[DATE_TO_BILL], --[BILLING_USER], [AR_INV_NBR], [AR_TYPE], [AR_INV_SEQ], [GLEXACT], [GLESEQ_SALES], [GLESEQ_COS], [GLESEQ_WIP],
								[MARKUP_PCT], [REBATE_PCT], [DISCOUNT_PCT], 
								@AP_TAX_CODE, @dec_CITY_PCT, @dec_COUNTY_PCT, @dec_STATE_PCT, @TAX_RESALE, @TAXAPPLYC, @TAXAPPLYLN, @TAXAPPLYLND, @TAXAPPLYNC, @TAXAPPLYR, @TAXAPPLYAI, [RECONCILE_FLAG],
								--[GLESEQ_STATE], [GLESEQ_COUNTY], [GLESEQ_CITY], [GLEXACT_DEF], [GLACODE_SALES], [GLACODE_COS], [GLACODE_WIP], [GLACODE_STATE],
								--[GLACODE_COUNTY], [GLACODE_CITY], 
								[NON_BILL_FLAG], @user_code, @CURRENT_DATE, @modified_comments + ' - Summary', [BILL_TYPE_FLAG], [COMM_PCT],							   
								--[GLESEQ_SALES_DEF], [GLESEQ_COS_DEF], [GLACODE_SALES_DEF], [GLACODE_COS_DEF], 
								@dec_AP_BILLING_AMT, (SELECT MAX(ISNULL(BILL_CANCELLED,0)) FROM dbo.NEWSPAPER_DETAIL WHERE ORDER_NBR = @order_nbr AND LINE_NBR = @line_nbr),
								[EST_NBR], [EST_LINE_NBR], [EST_REV_NBR], [FLAT_NETCHARGE], [FLAT_ADDL_CHARGE], [FLAT_DISCOUNT_AMT], [PRODUCTION_SIZE],
								[MAT_COMP], [SIZE_CODE], [COST_TYPE], @dec_COST_RATE, [RATE_TYPE], [NP_CIRCULATION], [PRINT_QUANTITY]
					FROM  [dbo].[NEWSPAPER_DETAIL]
					WHERE	 ORDER_NBR = @order_nbr
					AND  	LINE_NBR = @line_nbr
					AND  	REV_NBR = @rev_nbr
					AND  	SEQ_NBR = @seq_nbr;		

					--DELETE FROM [dbo].[NEWSPAPER_OTH_CHGS]
					--	WHERE [ORDER_NBR] = @order_nbr AND [LINE_NBR] = @line_nbr

					--IF	 COALESCE(@netcharge, 0) <> 0 BEGIN
					--	INSERT INTO [dbo].[NEWSPAPER_OTH_CHGS]
					--			([ORDER_NBR], [LINE_NBR], [CHG_TYPE], [CHG_DESC]
					--			,[QUANTITY], [RATE], [AMOUNT], [RATE_TYPE]
					--			,[REVISED_DATE], [REVISED_BY])			
					--	VALUES			
					--			(@order_nbr, @line_nbr,'NC', @ncdesc,
					--			1, @netcharge, @netcharge, @rate_type, 
					--			@modified_date, @modified_by)
					--END

					--IF	 COALESCE(@color_charge, 0) <> 0 BEGIN						
					--	INSERT INTO [dbo].[NEWSPAPER_OTH_CHGS]
					--			([ORDER_NBR], [LINE_NBR], [CHG_TYPE], [CHG_DESC]
					--			,[QUANTITY], [RATE], [AMOUNT], [RATE_TYPE]
					--			,[REVISED_DATE], [REVISED_BY])			
					--	VALUES			
					--			(@order_nbr, @line_nbr,'RC', @color_desc,
					--			1, @color_charge, @color_charge, @rate_type, 
					--			@modified_date, @modified_by)
					--END		

					--IF	 COALESCE(@addl_charge, 0) <> 0 BEGIN							
					--	INSERT INTO [dbo].[NEWSPAPER_OTH_CHGS]
					--			([ORDER_NBR], [LINE_NBR], [CHG_TYPE], [CHG_DESC]
					--			,[QUANTITY], [RATE], [AMOUNT], [RATE_TYPE]
					--			,[REVISED_DATE], [REVISED_BY])			
					--	VALUES			
					--			(@order_nbr, @line_nbr,'AF', @addl_charge_desc,
					--			1, @addl_charge, @addl_charge, @rate_type, 
					--			@modified_date, @modified_by)
					--END	
						
					IF @reconcile_by = 'L' BEGIN
						/** Do new AP Amounts row later **/
						SET @ROW_ID = @ROW_ID + 1				
					END
				END		
				ELSE IF @media_type = 'M' BEGIN
					SELECT
						@order_nbr = ORDER_NBR,
						@line_nbr = LINE_NBR,
						@rev_nbr = REV_NBR,
						@seq_nbr = SEQ_NBR
					FROM 
						@INTERNET_DETAIL_TABLE
					WHERE
						RowID = @ROW_ID;		
							
					SELECT 	@order_nbr, @line_nbr,  @rev_nbr, @seq_nbr, 'AP Valuse'
						
					/*PJH 08/12/13 - Use Order/Line	*/
					UPDATE	 dbo.MAGAZINE_DETAIL SET ACTIVE_REV = NULL
					WHERE	 ORDER_NBR = @order_nbr
					AND		LINE_NBR = @line_nbr;

					SELECT @NET_GROSS = NET_GROSS FROM MAGAZINE_HEADER WHERE ORDER_NBR = @order_nbr   /**********/

					IF @NET_GROSS = 1
						SET @dec_RECONCILE_RATE = @dec_GROSS_AMT
					ELSE
						SET @dec_RECONCILE_RATE = @dec_NET_AMT
					
						
					/* PJH 08/27/13 - AP Values */
					INSERT INTO [dbo].[MAGAZINE_DETAIL]
								([ORDER_NBR], [LINE_NBR], [REV_NBR], [SEQ_NBR], [ACTIVE_REV], [LINK_DETID], [START_DATE], [END_DATE], [CLOSE_DATE],
								[MATL_CLOSE_DATE], [EXT_CLOSE_DATE], [EXT_MATL_DATE], [SIZE], [AD_NUMBER], [HEADLINE], [MATERIAL], [EDITION_ISSUE], [SECTION],
								[JOB_NUMBER], [JOB_COMPONENT_NBR], [RATE_CARD_ID], [RATE_DTL_ID], [CONTRACT_QTY],
								[QUANTITY], [RATE], [NET_RATE], [GROSS_RATE], [FLAT_NET], [FLAT_GROSS], [EXT_NET_AMT], [EXT_GROSS_AMT], [COMM_AMT], [REBATE_AMT],
								[DISCOUNT_AMT], [DISCOUNT_DESC], [STATE_AMT], [COUNTY_AMT], [CITY_AMT], [NON_RESALE_AMT], [NETCHARGE], [NETCHARGE_DESC],
								[ADDL_CHARGE], [ADDL_CHARGE_DESC], [PROD_CHARGE], [PROD_DESC], 
								[COLOR_CHARGE], [COLOR_DESC], [LINE_TOTAL], --[LINE_CANCELLED],
								[BLEED_PCT], [BLEED_AMT], 
								[POSITION_PCT], [POSITION_AMT], 
								[PREMIUM_PCT], [PREMIUM_AMT],
								[DATE_TO_BILL], 
								--[BILLING_USER], [AR_INV_NBR], [AR_TYPE], [AR_INV_SEQ], [GLEXACT], [GLESEQ_SALES], [GLESEQ_COS], [GLESEQ_WIP],
								[MARKUP_PCT], [REBATE_PCT], [DISCOUNT_PCT], 
								[TAX_CODE], [TAX_CITY_PCT], [TAX_COUNTY_PCT], [TAX_STATE_PCT], [TAX_RESALE], [TAXAPPLYC], [TAXAPPLYLN], [TAXAPPLYND], [TAXAPPLYNC], [TAXAPPLYR], [TAXAPPLYAI], [RECONCILE_FLAG],
								--[GLESEQ_STATE], [GLESEQ_COUNTY], [GLESEQ_CITY], [GLEXACT_DEF], [GLACODE_SALES], [GLACODE_COS], [GLACODE_WIP], [GLACODE_STATE],
								--[GLACODE_COUNTY], [GLACODE_CITY], 
								[NON_BILL_FLAG], 
								[MODIFIED_BY], [MODIFIED_DATE], [MODIFIED_COMMENTS], [BILL_TYPE_FLAG], [COMM_PCT],							   
								--[GLESEQ_SALES_DEF], [GLESEQ_COS_DEF], [GLACODE_SALES_DEF], [GLACODE_COS_DEF], 
								[BILLING_AMT], [BILL_CANCELLED],
								[EST_NBR], [EST_LINE_NBR], [EST_REV_NBR], [FLAT_NETCHARGE], [FLAT_ADDL_CHARGE], [FLAT_DISCOUNT_AMT], [PRODUCTION_SIZE],
								[MAT_COMP], [SIZE_CODE], [MG_CIRCULATION])
							SELECT
								ORDER_NBR, LINE_NBR, @rev_nbr + 1, 0, 1, NULL, [START_DATE], [END_DATE], [CLOSE_DATE],
								[MATL_CLOSE_DATE], [EXT_CLOSE_DATE], [EXT_MATL_DATE], [SIZE], [AD_NUMBER], [HEADLINE], [MATERIAL], [EDITION_ISSUE], [SECTION],
								[JOB_NUMBER], [JOB_COMPONENT_NBR], [RATE_CARD_ID], [RATE_DTL_ID], @dec_CONTRACT_QTY,
								[QUANTITY], @dec_RECONCILE_RATE,  @dec_NET_RATE, @dec_GROSS_RATE, @dec_NET_AMT, @dec_GROSS_AMT, @dec_NET_RATE, @dec_NET_AMT + @dec_COMM_AMT /*@dec_GROSS_AMT*/, @dec_COMM_AMT, @dec_REBATE_AMT,
								@dec_DISCOUNT_AMT, [DISCOUNT_DESC], @dec_STATE_TAX, @dec_COUNTY_TAX, @dec_CITY_TAX, @dec_VENDOR_TAX, @dec_NETCHARGES, 'AP Reconcile',
								@dec_O_ADDL_CHARGE, 'AP Reconcile', @dec_PROD_CHARGE, 'AP Reconcile', 
								CASE WHEN @NET_GROSS = 0 THEN @dec_COLOR_NET ELSE @dec_COLOR_GROSS END, 'AP Reconcile', @dec_LINE_TOTAL, --[LINE_CANCELLED],
								[BLEED_PCT], CASE WHEN @NET_GROSS = 0 THEN @dec_BLEED_NET ELSE @dec_BLEED_GROSS END, 
								[POSITION_PCT], CASE WHEN @NET_GROSS = 0 THEN @dec_POSITION_NET ELSE @dec_POSITION_GROSS END, 
								[PREMIUM_PCT], CASE WHEN @NET_GROSS = 0 THEN @dec_PREMIUM_NET ELSE @dec_PREMIUM_GROSS END,
								[DATE_TO_BILL], 
								--[BILLING_USER], [AR_INV_NBR], [AR_TYPE], [AR_INV_SEQ], [GLEXACT], [GLESEQ_SALES], [GLESEQ_COS], [GLESEQ_WIP],
								[MARKUP_PCT], [REBATE_PCT], [DISCOUNT_PCT], 
								@AP_TAX_CODE, @dec_CITY_PCT, @dec_COUNTY_PCT, @dec_STATE_PCT, @TAX_RESALE, @TAXAPPLYC, @TAXAPPLYLN, @TAXAPPLYLND, @TAXAPPLYNC, @TAXAPPLYR, @TAXAPPLYAI, [RECONCILE_FLAG],
								--[GLESEQ_STATE], [GLESEQ_COUNTY], [GLESEQ_CITY], [GLEXACT_DEF], [GLACODE_SALES], [GLACODE_COS], [GLACODE_WIP], [GLACODE_STATE],
								--[GLACODE_COUNTY], [GLACODE_CITY], 
								[NON_BILL_FLAG], 
								@user_code, @CURRENT_DATE, @modified_comments + ' - Summary', [BILL_TYPE_FLAG], [COMM_PCT],							   
								--[GLESEQ_SALES_DEF], [GLESEQ_COS_DEF], [GLACODE_SALES_DEF], [GLACODE_COS_DEF], 
								@dec_AP_BILLING_AMT, (SELECT MAX(ISNULL(BILL_CANCELLED,0)) FROM dbo.[MAGAZINE_DETAIL] WHERE ORDER_NBR = @order_nbr AND LINE_NBR = @line_nbr),
								[EST_NBR], [EST_LINE_NBR], [EST_REV_NBR], @dec_NETCHARGES, @dec_O_ADDL_CHARGE, @dec_DISCOUNT_AMT, @dec_PROD_CHARGE,
								[MAT_COMP], [SIZE_CODE], [MG_CIRCULATION]
					FROM  [dbo].[MAGAZINE_DETAIL]
					WHERE	 ORDER_NBR = @order_nbr
					AND  	LINE_NBR = @line_nbr
					AND  	REV_NBR = @rev_nbr
					AND  	SEQ_NBR = @seq_nbr;		

					SELECT @@ROWCOUNT 'AP Values'
						
					IF @reconcile_by = 'L' BEGIN
						/** Do new AP Amounts row later **/
						SET @ROW_ID = @ROW_ID + 1				
					END
				END	
				ELSE IF @media_type = 'O' BEGIN
					SELECT
						@order_nbr = ORDER_NBR,
						@line_nbr = LINE_NBR,
						@rev_nbr = REV_NBR,
						@seq_nbr = SEQ_NBR
					FROM 
						@INTERNET_DETAIL_TABLE
					WHERE
						RowID = @ROW_ID;		
							
					--SELECT 	@order_nbr, 	@line_nbr,  @rev_nbr, @seq_nbr
						
					/*PJH 08/12/13 - Use Order/Line	*/
					UPDATE	 dbo.OUTDOOR_DETAIL SET ACTIVE_REV = NULL
					WHERE	 ORDER_NBR = @order_nbr
					AND		LINE_NBR = @line_nbr;
						
					/* PJH 08/27/13 - AP Values */
					INSERT INTO [dbo].[OUTDOOR_DETAIL]
								([ORDER_NBR], [LINE_NBR], [REV_NBR], [SEQ_NBR], [ACTIVE_REV], [LINK_DETID], [POST_DATE], [END_DATE], [CLOSE_DATE]
								,[MATL_CLOSE_DATE], [EXT_CLOSE_DATE], [EXT_MATL_DATE], [HEADLINE], [OUTDOOR_TYPE], [SIZE]
								,[LOCATION], [COPY_AREA]
								,[JOB_NUMBER], [JOB_COMPONENT_NBR], [RATE_CARD], [RATE_TYPE], [RATE_DESC]
								,[QUANTITY], [RATE], [NET_RATE], [GROSS_RATE], [EXT_NET_AMT], [EXT_GROSS_AMT], [COMM_AMT], [REBATE_AMT]
								,[DISCOUNT_AMT], [DISCOUNT_DESC], [STATE_AMT], [COUNTY_AMT], [CITY_AMT], [NON_RESALE_AMT], [NETCHARGE], [NCDESC]
								,[ADDL_CHARGE], [ADDL_CHARGE_DESC], [LINE_TOTAL], [LINE_CANCELLED]
								,[DATE_TO_BILL]
								--,[BILLING_USER], [AR_INV_NBR], [AR_TYPE], [AR_INV_SEQ], [GLEXACT], [GLESEQ_SALES], [GLESEQ_COS], [GLESEQ_WIP]
								--,[GLESEQ_STATE], [GLESEQ_COUNTY], [GLESEQ_CITY], [GLEXACT_DEF], [GLACODE_SALES], [GLACODE_COS], [GLACODE_WIP]
								--,[GLACODE_STATE], [GLACODE_COUNTY], [GLACODE_CITY]
								,[NON_BILL_FLAG]
								,[MODIFIED_BY], [MODIFIED_DATE], [MODIFIED_COMMENTS], [BILL_TYPE_FLAG]
								,[COMM_PCT], [MARKUP_PCT], [REBATE_PCT], [DISCOUNT_PCT]
								,[TAX_CODE], [TAX_CITY_PCT], [TAX_COUNTY_PCT], [TAX_STATE_PCT], [TAX_RESALE], [TAXAPPLYC], [TAXAPPLYLN], [TAXAPPLYND], [TAXAPPLYNC], [TAXAPPLYR], [TAXAPPLYAI]
								,[RECONCILE_FLAG] --, [GLESEQ_SALES_DEF], [GLESEQ_COS_DEF], [GLACODE_SALES_DEF], [GLACODE_COS_DEF]
								,[BILLING_AMT] , [BILL_CANCELLED]
								,[EST_NBR], [EST_LINE_NBR], [EST_REV_NBR], [AD_NUMBER], [MAT_COMP], [IMPRESSIONS], [ACTUAL_IMPRESSIONS])
							SELECT
								ORDER_NBR, LINE_NBR, @rev_nbr + 1, 0, 1, NULL, [POST_DATE], [END_DATE], [CLOSE_DATE]
								,[MATL_CLOSE_DATE], [EXT_CLOSE_DATE], [EXT_MATL_DATE], [HEADLINE], [OUTDOOR_TYPE], [SIZE]
								,[LOCATION], [COPY_AREA]
								,[JOB_NUMBER], [JOB_COMPONENT_NBR], [RATE_CARD], [RATE_TYPE], [RATE_DESC]
								,[QUANTITY], @dec_RECONCILE_RATE,  @dec_NEW_NET_RATE, @dec_NEW_GROSS_RATE, @dec_NET_AMT, @dec_GROSS_AMT, @dec_COMM_AMT, @dec_REBATE_AMT
								,@dec_DISCOUNT_AMT_ABS *-1, [DISCOUNT_DESC], @dec_STATE_TAX, @dec_COUNTY_TAX, @dec_CITY_TAX, @dec_VENDOR_TAX, @dec_NETCHARGES, 'AP Reconcile'
								,@dec_O_ADDL_CHARGE, 'AP Reconcile', @dec_LINE_TOTAL, [LINE_CANCELLED]
								,[DATE_TO_BILL]
								--,[BILLING_USER], [AR_INV_NBR], [AR_TYPE], [AR_INV_SEQ], [GLEXACT], [GLESEQ_SALES], [GLESEQ_COS], [GLESEQ_WIP]
								--,[GLESEQ_STATE], [GLESEQ_COUNTY], [GLESEQ_CITY], [GLEXACT_DEF], [GLACODE_SALES], [GLACODE_COS], [GLACODE_WIP]
								--,[GLACODE_STATE], [GLACODE_COUNTY], [GLACODE_CITY]
								,[NON_BILL_FLAG]
								,[MODIFIED_BY], [MODIFIED_DATE], [MODIFIED_COMMENTS], [BILL_TYPE_FLAG]
								,[COMM_PCT], [MARKUP_PCT], [REBATE_PCT], [DISCOUNT_PCT]
								,@AP_TAX_CODE, @dec_CITY_PCT, @dec_COUNTY_PCT, @dec_STATE_PCT, @TAX_RESALE, @TAXAPPLYC, @TAXAPPLYLN, @TAXAPPLYLND, @TAXAPPLYNC, @TAXAPPLYR, @TAXAPPLYAI
								,[RECONCILE_FLAG] --, [GLESEQ_SALES_DEF], [GLESEQ_COS_DEF], [GLACODE_SALES_DEF], [GLACODE_COS_DEF]
								,@dec_AP_BILLING_AMT, (SELECT MAX(ISNULL(BILL_CANCELLED,0)) FROM dbo.NEWSPAPER_DETAIL WHERE ORDER_NBR = @order_nbr AND LINE_NBR = @line_nbr)
								,[EST_NBR], [EST_LINE_NBR], [EST_REV_NBR], [AD_NUMBER], [MAT_COMP], [IMPRESSIONS], [ACTUAL_IMPRESSIONS]
					FROM  [dbo].[OUTDOOR_DETAIL]
					WHERE	 ORDER_NBR = @order_nbr
					AND  	LINE_NBR = @line_nbr
					AND  	REV_NBR = @rev_nbr
					AND  	SEQ_NBR = @seq_nbr;		
						
					IF @reconcile_by = 'L' BEGIN
						/** Do new AP Amounts row later **/
						SET @ROW_ID = @ROW_ID + 1				
					END
				END	
				ELSE IF @media_type = 'T' BEGIN 					
					
					--SELECT '>>>>>>', @dec_AP_BILLING_AMT '@dec_AP_BILLING_AMT',  @dec_NET_AMT '@dec_NET_AMT',  @dec_GROSS_AMT '@dec_GROSS_AMT', @dec_COMM_AMT '@dec_COMM_AMT',
					--		@dec_COST_RATE '@dec_COST_RATE', @dec_NEW_GROSS_RATE '@dec_NEW_GROSS_RATE', @dec_NEW_NET_RATE '@dec_NEW_NET_RATE'	
					
					UPDATE	 dbo.TV_DETAIL SET ACTIVE_REV = NULL
					WHERE	 ORDER_NBR = @order_nbr
					AND		LINE_NBR = @line_nbr;									
					
					INSERT INTO [dbo].[TV_DETAIL]
									([ORDER_NBR],  [LINE_NBR],  [REV_NBR],  [SEQ_NBR],  [ACTIVE_REV],  [LINK_DETID],  [BUY_TYPE]
									, [START_DATE],  [END_DATE],  [MONTH_NBR],  [YEAR_NBR],  [CLOSE_DATE],  [MATL_CLOSE_DATE],  [EXT_CLOSE_DATE],  [EXT_MATL_DATE]
									, [DATE1],  [DATE2],  [DATE3],  [DATE4],  [DATE5],  [DATE6],  [DATE7]
									, [MONDAY],  [TUESDAY],  [WEDNESDAY],  [THURSDAY],  [FRIDAY],  [SATURDAY],  [SUNDAY]
									, [SPOTS1],  [SPOTS2],  [SPOTS3],  [SPOTS4],  [SPOTS5],  [SPOTS6],  [SPOTS7],  [TOTAL_SPOTS]
									, [JOB_NUMBER],  [JOB_COMPONENT_NBR],  [QUANTITY],  [RATE],  [NET_RATE],  [GROSS_RATE]
									, [EXT_NET_AMT],  [EXT_GROSS_AMT],  [COMM_AMT],  [REBATE_AMT],  [DISCOUNT_AMT],  [DISCOUNT_DESC]
									, [STATE_AMT],  [COUNTY_AMT],  [CITY_AMT],  [NON_RESALE_AMT],  [NETCHARGE],  [NCDESC]
									, [ADDL_CHARGE],  [ADDL_CHARGE_DESC]
											
									,  [LINE_TOTAL],  [LINE_CANCELLED],  [DATE_TO_BILL],  [BILLING_USER]
											
									, [AR_INV_NBR],  [AR_TYPE],  [AR_INV_SEQ]
									, [GLEXACT],  [GLESEQ_SALES],  [GLESEQ_COS],  [GLESEQ_WIP],  [GLESEQ_STATE],  [GLESEQ_COUNTY],  [GLESEQ_CITY]
									, [GLEXACT_DEF],  [GLACODE_SALES],  [GLACODE_COS],  [GLACODE_WIP],  [GLACODE_STATE],  [GLACODE_COUNTY],  [GLACODE_CITY]
									, [NON_BILL_FLAG],  [MODIFIED_BY],  [MODIFIED_DATE],  [MODIFIED_COMMENTS],  [BILL_TYPE_FLAG]
									, [COMM_PCT],  [MARKUP_PCT],  [REBATE_PCT],  [DISCOUNT_PCT],  [TAX_CODE],  [TAX_CITY_PCT],  [TAX_COUNTY_PCT],  [TAX_STATE_PCT]
									, [TAX_RESALE],  [TAXAPPLYC],  [TAXAPPLYLN],  [TAXAPPLYND],  [TAXAPPLYNC],  [TAXAPPLYR],  [TAXAPPLYAI]
									, [RECONCILE_FLAG],  [GLESEQ_SALES_DEF],  [GLESEQ_COS_DEF],  [GLACODE_SALES_DEF],  [GLACODE_COS_DEF]
									, [BILLING_AMT],  [COST_TYPE],  [COST_RATE],  [NET_BASE_RATE],  [GROSS_BASE_RATE]
									, [BILL_CANCELLED]
									, [EST_NBR],  [EST_LINE_NBR],  [EST_REV_NBR],  [AD_NUMBER],  [MAT_COMP],  [PROGRAMMING]
									, [START_TIME],  [END_TIME],  [LENGTH],  [REMARKS],  [TAG],  [NETWORK_ID])
					SELECT    [ORDER_NBR], [LINE_NBR], @rev_nbr + 1, 0,  1,  NULL,  [BUY_TYPE]
									, ([START_DATE]), (END_DATE),  [MONTH_NBR],  [YEAR_NBR],  (CLOSE_DATE), (MATL_CLOSE_DATE),  [EXT_CLOSE_DATE],  [EXT_MATL_DATE]
									, [DATE1],  [DATE2],  [DATE3],  [DATE4],  [DATE5],  [DATE6],  [DATE7]
									, [MONDAY],  [TUESDAY],  [WEDNESDAY],  [THURSDAY],  [FRIDAY],  [SATURDAY],  [SUNDAY]
									, @dec_ORDER_QTY,  0,  0,  0,  0,  0,  0,  @dec_ORDER_QTY
									, [JOB_NUMBER],  [JOB_COMPONENT_NBR],  [QUANTITY],  @dec_COST_RATE,  @dec_NEW_NET_RATE,  @dec_NEW_GROSS_RATE
									, @dec_NET_AMT,  @dec_GROSS_AMT,  @dec_COMM_AMT,  @dec_REBATE_AMT,  @dec_DISCOUNT_AMT,  [DISCOUNT_DESC]
									, @dec_STATE_TAX,  @dec_COUNTY_TAX,  @dec_CITY_TAX,  @dec_VENDOR_TAX,  @dec_NETCHARGES,  'AP Reconcile'
									, @dec_O_ADDL_CHARGE,  'AP Reconcile'
										
									, @dec_LINE_TOTAL,  [LINE_CANCELLED],  [DATE_TO_BILL],  NULL
										
									, NULL,  NULL,  NULL
									, NULL,  NULL,  NULL,  NULL,  NULL,  NULL,  NULL
									, NULL,  NULL,  NULL,  NULL,  NULL,  NULL,  NULL
									, [NON_BILL_FLAG],  @user_code,  @CURRENT_DATE,  @modified_comments + ' - Summary',  [BILL_TYPE_FLAG]
									, [COMM_PCT],  [MARKUP_PCT],  [REBATE_PCT],  [DISCOUNT_PCT],  [TAX_CODE],  [TAX_CITY_PCT],  [TAX_COUNTY_PCT],  [TAX_STATE_PCT]
									, [TAX_RESALE],  [TAXAPPLYC],  [TAXAPPLYLN],  [TAXAPPLYND],  [TAXAPPLYNC],  [TAXAPPLYR],  [TAXAPPLYAI]
									, NULL,  NULL,  NULL,  NULL,  NULL
									, @dec_AP_BILLING_AMT,  [COST_TYPE],  @dec_COST_RATE,  @dec_NEW_NET_RATE,  @dec_NEW_GROSS_RATE
									, (SELECT MAX(ISNULL(BILL_CANCELLED,0)) FROM dbo.TV_DETAIL WHERE ORDER_NBR = @order_nbr AND LINE_NBR = @line_nbr)
									, [EST_NBR],  [EST_LINE_NBR],  [EST_REV_NBR],  [AD_NUMBER],  [MAT_COMP],  [PROGRAMMING]
									, [START_TIME],  [END_TIME],  [LENGTH],  [REMARKS],  [TAG],  [NETWORK_ID] /**/
					FROM	 dbo.TV_DETAIL
					WHERE	 ORDER_NBR = @order_nbr
					AND  	LINE_NBR = @line_nbr
					AND  	REV_NBR = @rev_nbr
					AND  	SEQ_NBR = @seq_nbr;		
						
					--INSERT INTO [dbo].[TV_COMMENTS]
					--			([ORDER_NBR]   ,[LINE_NBR]    ,[INSTRUCTIONS]    ,[ORDER_COPY]
					--			,[MATL_NOTES]    ,[POSITION_INFO]    ,[CLOSE_INFO]    ,[RATE_INFO]
					--			,[MISC_INFO]    ,[IN_HOUSE_CMTS])
					--SELECT
					--			[ORDER_NBR]   ,@MAX_LINE_NBR + 1    ,NULL    ,NULL
					--			,NULL    ,NULL    ,NULL    ,NULL
					--			,NULL    ,NULL 
					--FROM [dbo].[TV_COMMENTS] 								
					--WHERE	 ORDER_NBR = @order_nbr
					--AND  	LINE_NBR = @line_nbr	;							
				END
				ELSE IF @media_type = 'R' BEGIN

					UPDATE	 dbo.RADIO_DETAIL SET ACTIVE_REV = NULL
					WHERE	 ORDER_NBR = @order_nbr
					AND		LINE_NBR = @line_nbr;									

					INSERT INTO [dbo].[RADIO_DETAIL]
									([ORDER_NBR],  [LINE_NBR],  [REV_NBR],  [SEQ_NBR],  [ACTIVE_REV],  [LINK_DETID],  [BUY_TYPE]
									, [START_DATE],  [END_DATE],  [MONTH_NBR],  [YEAR_NBR],  [CLOSE_DATE],  [MATL_CLOSE_DATE],  [EXT_CLOSE_DATE],  [EXT_MATL_DATE]
									, [DATE1],  [DATE2],  [DATE3],  [DATE4],  [DATE5],  [DATE6],  [DATE7]
									, [MONDAY],  [TUESDAY],  [WEDNESDAY],  [THURSDAY],  [FRIDAY],  [SATURDAY],  [SUNDAY]
									, [SPOTS1],  [SPOTS2],  [SPOTS3],  [SPOTS4],  [SPOTS5],  [SPOTS6],  [SPOTS7],  [TOTAL_SPOTS]
									, [JOB_NUMBER],  [JOB_COMPONENT_NBR],  [QUANTITY],  [RATE],  [NET_RATE],  [GROSS_RATE]
									, [EXT_NET_AMT],  [EXT_GROSS_AMT],  [COMM_AMT],  [REBATE_AMT],  [DISCOUNT_AMT],  [DISCOUNT_DESC]
									, [STATE_AMT],  [COUNTY_AMT],  [CITY_AMT],  [NON_RESALE_AMT],  [NETCHARGE],  [NCDESC]
									, [ADDL_CHARGE],  [ADDL_CHARGE_DESC]
										
									,  [LINE_TOTAL],  [LINE_CANCELLED],  [DATE_TO_BILL],  [BILLING_USER]
										
									, [AR_INV_NBR],  [AR_TYPE],  [AR_INV_SEQ]
									, [GLEXACT],  [GLESEQ_SALES],  [GLESEQ_COS],  [GLESEQ_WIP],  [GLESEQ_STATE],  [GLESEQ_COUNTY],  [GLESEQ_CITY]
									, [GLEXACT_DEF],  [GLACODE_SALES],  [GLACODE_COS],  [GLACODE_WIP],  [GLACODE_STATE],  [GLACODE_COUNTY],  [GLACODE_CITY]
									, [NON_BILL_FLAG],  [MODIFIED_BY],  [MODIFIED_DATE],  [MODIFIED_COMMENTS],  [BILL_TYPE_FLAG]
									, [COMM_PCT],  [MARKUP_PCT],  [REBATE_PCT],  [DISCOUNT_PCT],  [TAX_CODE],  [TAX_CITY_PCT],  [TAX_COUNTY_PCT],  [TAX_STATE_PCT]
									, [TAX_RESALE],  [TAXAPPLYC],  [TAXAPPLYLN],  [TAXAPPLYND],  [TAXAPPLYNC],  [TAXAPPLYR],  [TAXAPPLYAI]
									, [RECONCILE_FLAG],  [GLESEQ_SALES_DEF],  [GLESEQ_COS_DEF],  [GLACODE_SALES_DEF],  [GLACODE_COS_DEF]
									, [BILLING_AMT],  [COST_TYPE],  [COST_RATE],  [NET_BASE_RATE],  [GROSS_BASE_RATE]
									, [BILL_CANCELLED]
									, [EST_NBR],  [EST_LINE_NBR],  [EST_REV_NBR],  [AD_NUMBER],  [MAT_COMP],  [PROGRAMMING]
									, [START_TIME],  [END_TIME],  [LENGTH],  [REMARKS],  [TAG],  [NETWORK_ID])
					SELECT    [ORDER_NBR],  [LINE_NBR], @rev_nbr + 1, 0,  1,  NULL,  [BUY_TYPE]
									, ([START_DATE]), (END_DATE),  [MONTH_NBR],  [YEAR_NBR],  (CLOSE_DATE), (MATL_CLOSE_DATE),  [EXT_CLOSE_DATE],  [EXT_MATL_DATE]
									, [DATE1],  [DATE2],  [DATE3],  [DATE4],  [DATE5],  [DATE6],  [DATE7]
									, [MONDAY],  [TUESDAY],  [WEDNESDAY],  [THURSDAY],  [FRIDAY],  [SATURDAY],  [SUNDAY]
									, @dec_ORDER_QTY,  0,  0,  0,  0,  0,  0,  @dec_ORDER_QTY
									, [JOB_NUMBER],  [JOB_COMPONENT_NBR],  [QUANTITY],  @dec_COST_RATE,  @dec_NEW_NET_RATE,  @dec_NEW_GROSS_RATE
									, @dec_NET_AMT,  @dec_GROSS_AMT,  @dec_COMM_AMT,  @dec_REBATE_AMT,  @dec_DISCOUNT_AMT,  [DISCOUNT_DESC]
									, @dec_STATE_TAX,  @dec_COUNTY_TAX,  @dec_CITY_TAX,  @dec_VENDOR_TAX,  @dec_NETCHARGES,  'AP Reconcile'
									, @dec_O_ADDL_CHARGE,  'AP Reconcile'
										
									,  @dec_LINE_TOTAL,  [LINE_CANCELLED],  [DATE_TO_BILL],  NULL
										
									,  NULL,  NULL,  NULL
									, NULL,  NULL,  NULL,  NULL,  NULL,  NULL,  NULL
									, NULL,  NULL,  NULL,  NULL,  NULL,  NULL,  NULL
									, [NON_BILL_FLAG],  @user_code,  @CURRENT_DATE,  @modified_comments + ' - Summary',  [BILL_TYPE_FLAG]
									, [COMM_PCT],  [MARKUP_PCT],  [REBATE_PCT],  [DISCOUNT_PCT],  [TAX_CODE],  [TAX_CITY_PCT],  [TAX_COUNTY_PCT],  [TAX_STATE_PCT]
									, [TAX_RESALE],  [TAXAPPLYC],  [TAXAPPLYLN],  [TAXAPPLYND],  [TAXAPPLYNC],  [TAXAPPLYR],  [TAXAPPLYAI]
									, NULL,  NULL,  NULL,  NULL,  NULL
									, @dec_AP_BILLING_AMT,  [COST_TYPE],  @dec_COST_RATE,  @dec_NEW_NET_RATE,  @dec_NEW_GROSS_RATE
									, (SELECT MAX(ISNULL(BILL_CANCELLED,0)) FROM dbo.RADIO_DETAIL WHERE ORDER_NBR = @order_nbr AND LINE_NBR = @line_nbr)
									, [EST_NBR],  [EST_LINE_NBR],  [EST_REV_NBR],  [AD_NUMBER],  [MAT_COMP],  [PROGRAMMING]
									, [START_TIME],  [END_TIME],  [LENGTH],  [REMARKS],  [TAG],  [NETWORK_ID]
					FROM	 dbo.RADIO_DETAIL
					WHERE	 ORDER_NBR = @order_nbr
					AND  	LINE_NBR = @line_nbr
					AND  	REV_NBR = @rev_nbr
					AND  	SEQ_NBR = @seq_nbr;	
						
					--INSERT INTO [dbo].[RADIO_COMMENTS]
					--			([ORDER_NBR]   ,[LINE_NBR]    ,[INSTRUCTIONS]    ,[ORDER_COPY]
					--			,[MATL_NOTES]    ,[POSITION_INFO]    ,[CLOSE_INFO]    ,[RATE_INFO]
					--			,[MISC_INFO]    ,[IN_HOUSE_CMTS])
					--SELECT
					--			[ORDER_NBR]   ,@MAX_LINE_NBR + 1    ,NULL    ,NULL
					--			,NULL    ,NULL    ,NULL    ,NULL
					--			,NULL    ,NULL 
					--FROM [dbo].[RADIO_COMMENTS] 								
					--WHERE	 ORDER_NBR = @order_nbr
					--AND  	LINE_NBR = @line_nbr	;								
				END				
			END
			ELSE BEGIN
				/* If Month OR Order level then new Line  */
				
				IF @dec_NET_AMT <> 0 BEGIN /*** SKIP_NEW_LINE ***/
								
					--SELECT @new_start_date_d , @new_end_date_d ,	@new_close_date_d , @new_matl_close_date_d  /***************************************** DEBUG *************************/				
					
					IF @reconcile_by <> 'O' AND @media_type = 'I' BEGIN
						SET @new_start_date_d = NULL
						SET @new_end_date_d = NULL
						SET @new_close_date_d = NULL
						SET @new_matl_close_date_d = NULL					
					END		
					IF @media_type = 'I' BEGIN
						IF @reconcile_method = 'R' BEGIN
							SET @dec_tmp_ADDL_CHARGE = 0
						END
						ELSE BEGIN
							SET @dec_tmp_ADDL_CHARGE = @dec_O_ADDL_CHARGE
						END
						INSERT INTO dbo.INTERNET_DETAIL  ( ORDER_NBR, LINE_NBR, REV_NBR, SEQ_NBR,
						ACTIVE_REV, LINK_DETID, [START_DATE], END_DATE, CLOSE_DATE, 
						MATL_CLOSE_DATE, EXT_CLOSE_DATE, EXT_MATL_DATE, HEADLINE, INTERNET_TYPE,
						SIZE, PROJ_IMPRESSIONS, GUARANTEED_IMPRESS, URL, TARGET_AUDIENCE, COPY_AREA, JOB_NUMBER, JOB_COMPONENT_NBR, RATE_CARD, RATE_TYPE, 
						RATE_DESC, QUANTITY, RATE, NET_RATE, GROSS_RATE, EXT_NET_AMT, EXT_GROSS_AMT,
						COMM_AMT, REBATE_AMT, DISCOUNT_AMT, DISCOUNT_DESC, STATE_AMT, COUNTY_AMT, CITY_AMT, NON_RESALE_AMT, 
						NETCHARGE, NCDESC, ADDL_CHARGE, ADDL_CHARGE_DESC, 
						
						LINE_TOTAL, LINE_CANCELLED, DATE_TO_BILL, BILLING_USER,
						
						AR_INV_NBR, AR_TYPE, AR_INV_SEQ, GLEXACT, GLESEQ_SALES, GLESEQ_COS, GLESEQ_WIP, GLESEQ_STATE, GLESEQ_COUNTY, GLESEQ_CITY, GLEXACT_DEF, GLESEQ_COS_DEF, 
						GLESEQ_SALES_DEF, GLACODE_SALES, GLACODE_COS, GLACODE_WIP,
						GLACODE_STATE, GLACODE_COUNTY, GLACODE_CITY, NON_BILL_FLAG, MODIFIED_BY, MODIFIED_DATE, MODIFIED_COMMENTS, BILL_TYPE_FLAG, CREATIVE_SIZE, PLACEMENT_1, PLACEMENT_2, 
						COMM_PCT, MARKUP_PCT, REBATE_PCT, DISCOUNT_PCT,
						TAX_CODE, TAX_CITY_PCT, TAX_COUNTY_PCT, TAX_STATE_PCT, TAX_RESALE, TAXAPPLYC, TAXAPPLYLN, TAXAPPLYND, TAXAPPLYNC, TAXAPPLYR, TAXAPPLYAI, RECONCILE_FLAG, ACT_IMPRESSIONS, 
						GLACODE_SALES_DEF, GLACODE_COS_DEF,
						BILLING_AMT, COST_TYPE, COST_RATE, NET_BASE_RATE, GROSS_BASE_RATE, 
						BILL_CANCELLED, EST_NBR, EST_LINE_NBR, EST_REV_NBR )
						SELECT
						ORDER_NBR, @MAX_LINE_NBR + 1, 0, 0,
						1, NULL, COALESCE(@new_start_date_d, [START_DATE]), COALESCE(@new_end_date_d, END_DATE), COALESCE(@new_close_date_d, CLOSE_DATE), 
						COALESCE(@new_matl_close_date_d, MATL_CLOSE_DATE), EXT_CLOSE_DATE, EXT_MATL_DATE, HEADLINE, INTERNET_TYPE,
						SIZE, NULL, @dec_ACTUAL_IMPRESSIONS, URL, TARGET_AUDIENCE, COPY_AREA, JOB_NUMBER, JOB_COMPONENT_NBR, RATE_CARD, RATE_TYPE, 
						RATE_DESC, QUANTITY, @dec_RECONCILE_RATE, @dec_NET_AMT, @dec_GROSS_AMT, @dec_NET_AMT, @dec_GROSS_AMT,
						@dec_COMM_AMT, @dec_REBATE_AMT, @dec_DISCOUNT_AMT, DISCOUNT_DESC, @dec_STATE_TAX, @dec_COUNTY_TAX, @dec_CITY_TAX, @dec_VENDOR_TAX, 
						@dec_NETCHARGES, 'AP Reconcile', @dec_tmp_ADDL_CHARGE, 'AP Reconcile', 
						
						@dec_LINE_TOTAL, LINE_CANCELLED, DATE_TO_BILL, BILLING_USER,
						
						NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
						NULL, NULL, NULL, NON_BILL_FLAG, @user_code, @CURRENT_DATE, @modified_comments + ' - Summary', BILL_TYPE_FLAG, CREATIVE_SIZE, PLACEMENT_1, PLACEMENT_2, 
						COMM_PCT, MARKUP_PCT, REBATE_PCT, DISCOUNT_PCT,
						TAX_CODE, TAX_CITY_PCT, TAX_COUNTY_PCT, TAX_STATE_PCT, TAX_RESALE, TAXAPPLYC, TAXAPPLYLN, TAXAPPLYND, TAXAPPLYNC, TAXAPPLYR, TAXAPPLYAI, NULL, NULL, 
						GLACODE_SALES_DEF, GLACODE_COS_DEF,
						@dec_AP_BILLING_AMT, COST_TYPE, @dec_COST_RATE, @dec_NEW_NET_RATE, @dec_NEW_GROSS_RATE, 
						(SELECT MAX(ISNULL(BILL_CANCELLED,0)) FROM dbo.INTERNET_DETAIL WHERE ORDER_NBR = @order_nbr AND LINE_NBR = @line_nbr), EST_NBR, EST_LINE_NBR, EST_REV_NBR
						FROM	 dbo.INTERNET_DETAIL
						WHERE	 ORDER_NBR = @order_nbr
						AND  	LINE_NBR = @line_nbr
						AND  	REV_NBR = @rev_nbr
						AND  	SEQ_NBR = @seq_nbr;		
						
						INSERT INTO [dbo].[INTERNET_COMMENTS]
								   ([ORDER_NBR]   ,[LINE_NBR]   ,[INSTRUCTIONS]   ,[MISC_INFO]
								   ,[ORDER_COPY]	   ,[MATL_NOTES])
						SELECT
									[ORDER_NBR]   ,@MAX_LINE_NBR + 1   ,[INSTRUCTIONS]   ,[MISC_INFO]
								   ,[ORDER_COPY]	   ,[MATL_NOTES] 
						FROM [dbo].[INTERNET_COMMENTS] 						
						WHERE	 ORDER_NBR = @order_nbr
						AND  	LINE_NBR = @line_nbr	;		   
					END
					ELSE IF @media_type = 'T' BEGIN 
					
					
						--SELECT '>>>>>>', @dec_AP_BILLING_AMT '@dec_AP_BILLING_AMT',  @dec_NET_AMT '@dec_NET_AMT',  @dec_GROSS_AMT '@dec_GROSS_AMT', @dec_COMM_AMT '@dec_COMM_AMT',
						--		@dec_COST_RATE '@dec_COST_RATE', @dec_NEW_GROSS_RATE '@dec_NEW_GROSS_RATE', @dec_NEW_NET_RATE '@dec_NEW_NET_RATE'					
					
						INSERT INTO [dbo].[TV_DETAIL]
										   ([ORDER_NBR],  [LINE_NBR],  [REV_NBR],  [SEQ_NBR],  [ACTIVE_REV],  [LINK_DETID],  [BUY_TYPE]
											, [START_DATE],  [END_DATE],  [MONTH_NBR],  [YEAR_NBR],  [CLOSE_DATE],  
											[MATL_CLOSE_DATE],  [EXT_CLOSE_DATE],  [EXT_MATL_DATE]
											, [DATE1],  [DATE2],  [DATE3],  [DATE4],  [DATE5],  [DATE6],  [DATE7]
											, [MONDAY],  [TUESDAY],  [WEDNESDAY],  [THURSDAY],  [FRIDAY],  [SATURDAY],  [SUNDAY]
											, [SPOTS1],  [SPOTS2],  [SPOTS3],  [SPOTS4],  [SPOTS5],  [SPOTS6],  [SPOTS7],  [TOTAL_SPOTS]
											, [JOB_NUMBER],  [JOB_COMPONENT_NBR],  [QUANTITY],  [RATE],  [NET_RATE],  [GROSS_RATE]
											, [EXT_NET_AMT],  [EXT_GROSS_AMT],  [COMM_AMT],  [REBATE_AMT],  [DISCOUNT_AMT],  [DISCOUNT_DESC]
											, [STATE_AMT],  [COUNTY_AMT],  [CITY_AMT],  [NON_RESALE_AMT],  [NETCHARGE],  [NCDESC]
											, [ADDL_CHARGE],  [ADDL_CHARGE_DESC]
											
											,  [LINE_TOTAL],  [LINE_CANCELLED],  [DATE_TO_BILL],  [BILLING_USER]
											
											, [AR_INV_NBR],  [AR_TYPE],  [AR_INV_SEQ]
											, [GLEXACT],  [GLESEQ_SALES],  [GLESEQ_COS],  [GLESEQ_WIP],  [GLESEQ_STATE],  [GLESEQ_COUNTY],  [GLESEQ_CITY]
											, [GLEXACT_DEF],  [GLACODE_SALES],  [GLACODE_COS],  [GLACODE_WIP],  [GLACODE_STATE],  [GLACODE_COUNTY],  [GLACODE_CITY]
											, [NON_BILL_FLAG],  [MODIFIED_BY],  [MODIFIED_DATE],  [MODIFIED_COMMENTS],  [BILL_TYPE_FLAG]
											, [COMM_PCT],  [MARKUP_PCT],  [REBATE_PCT],  [DISCOUNT_PCT],  [TAX_CODE],  [TAX_CITY_PCT],  [TAX_COUNTY_PCT],  [TAX_STATE_PCT]
											, [TAX_RESALE],  [TAXAPPLYC],  [TAXAPPLYLN],  [TAXAPPLYND],  [TAXAPPLYNC],  [TAXAPPLYR],  [TAXAPPLYAI]
											, [RECONCILE_FLAG],  [GLESEQ_SALES_DEF],  [GLESEQ_COS_DEF],  [GLACODE_SALES_DEF],  [GLACODE_COS_DEF]
											, [BILLING_AMT],  [COST_TYPE],  [COST_RATE],  [NET_BASE_RATE],  [GROSS_BASE_RATE]
											, [BILL_CANCELLED]
											, [EST_NBR],  [EST_LINE_NBR],  [EST_REV_NBR],  [AD_NUMBER],  [MAT_COMP],  [PROGRAMMING]
											, [START_TIME],  [END_TIME],  [LENGTH],  [REMARKS],  [TAG],  [NETWORK_ID])
						SELECT    [ORDER_NBR],  @MAX_LINE_NBR + 1, 0, 0,  1,  NULL,  [BUY_TYPE]
										, COALESCE(@new_start_date_d, [START_DATE]), COALESCE(@new_end_date_d, END_DATE),  [MONTH_NBR],  [YEAR_NBR],  COALESCE(@new_close_date_d, CLOSE_DATE), 
										COALESCE(@new_matl_close_date_d, MATL_CLOSE_DATE),  [EXT_CLOSE_DATE],  [EXT_MATL_DATE]
										, [DATE1],  [DATE2],  [DATE3],  [DATE4],  [DATE5],  [DATE6],  [DATE7]
										, [MONDAY],  [TUESDAY],  [WEDNESDAY],  [THURSDAY],  [FRIDAY],  [SATURDAY],  [SUNDAY]
										, @dec_ACTUAL_IMPRESSIONS,  0,  0,  0,  0,  0,  0,  @dec_ACTUAL_IMPRESSIONS
										, [JOB_NUMBER],  [JOB_COMPONENT_NBR],  [QUANTITY],  @dec_COST_RATE,  @dec_NEW_NET_RATE,  @dec_NEW_GROSS_RATE
										, @dec_NET_AMT,  @dec_GROSS_AMT,  @dec_COMM_AMT,  @dec_REBATE_AMT,  @dec_DISCOUNT_AMT,  [DISCOUNT_DESC]
										, @dec_STATE_TAX,  @dec_COUNTY_TAX,  @dec_CITY_TAX,  @dec_VENDOR_TAX,  @dec_NETCHARGES,  'AP Reconcile'
										, @dec_O_ADDL_CHARGE,  'AP Reconcile'
										
										,  @dec_LINE_TOTAL,  [LINE_CANCELLED],  [DATE_TO_BILL],  NULL
										
										,  NULL,  NULL,  NULL
										, NULL,  NULL,  NULL,  NULL,  NULL,  NULL,  NULL
										, NULL,  NULL,  NULL,  NULL,  NULL,  NULL,  NULL
										, [NON_BILL_FLAG],  @user_code,  @CURRENT_DATE,  @modified_comments + ' - Summary',  [BILL_TYPE_FLAG]
										, [COMM_PCT],  [MARKUP_PCT],  [REBATE_PCT],  [DISCOUNT_PCT],  [TAX_CODE],  [TAX_CITY_PCT],  [TAX_COUNTY_PCT],  [TAX_STATE_PCT]
										, [TAX_RESALE],  [TAXAPPLYC],  [TAXAPPLYLN],  [TAXAPPLYND],  [TAXAPPLYNC],  [TAXAPPLYR],  [TAXAPPLYAI]
										, NULL,  NULL,  NULL,  NULL,  NULL
										, @dec_AP_BILLING_AMT,  [COST_TYPE],  @dec_COST_RATE,  @dec_NEW_NET_RATE,  @dec_NEW_GROSS_RATE
										, (SELECT MAX(ISNULL(BILL_CANCELLED,0)) FROM dbo.TV_DETAIL WHERE ORDER_NBR = @order_nbr AND LINE_NBR = @line_nbr)
										, [EST_NBR],  [EST_LINE_NBR],  [EST_REV_NBR],  [AD_NUMBER],  [MAT_COMP],  [PROGRAMMING]
										, [START_TIME],  [END_TIME],  [LENGTH],  [REMARKS],  [TAG],  [NETWORK_ID]
						FROM	 dbo.TV_DETAIL
						WHERE	 ORDER_NBR = @order_nbr
						AND  	LINE_NBR = @line_nbr
						AND  	REV_NBR = @rev_nbr
						AND  	SEQ_NBR = @seq_nbr;		
						
						INSERT INTO [dbo].[TV_COMMENTS]
								    ([ORDER_NBR]   ,[LINE_NBR]    ,[INSTRUCTIONS]    ,[ORDER_COPY]
								   ,[MATL_NOTES]    ,[POSITION_INFO]    ,[CLOSE_INFO]    ,[RATE_INFO]
								   ,[MISC_INFO]    ,[IN_HOUSE_CMTS])
						SELECT
									[ORDER_NBR]   ,@MAX_LINE_NBR + 1    ,NULL    ,NULL
								   ,NULL    ,NULL    ,NULL    ,NULL
								   ,NULL    ,NULL 
						FROM [dbo].[TV_COMMENTS] 								
						WHERE	 ORDER_NBR = @order_nbr
						AND  	LINE_NBR = @line_nbr	;							
					END
					ELSE IF @media_type = 'R' BEGIN
						INSERT INTO [dbo].[RADIO_DETAIL]
									   ([ORDER_NBR],  [LINE_NBR],  [REV_NBR],  [SEQ_NBR],  [ACTIVE_REV],  [LINK_DETID],  [BUY_TYPE]
										, [START_DATE],  [END_DATE],  [MONTH_NBR],  [YEAR_NBR],  [CLOSE_DATE],  
										[MATL_CLOSE_DATE],  [EXT_CLOSE_DATE],  [EXT_MATL_DATE]
										, [DATE1],  [DATE2],  [DATE3],  [DATE4],  [DATE5],  [DATE6],  [DATE7]
										, [MONDAY],  [TUESDAY],  [WEDNESDAY],  [THURSDAY],  [FRIDAY],  [SATURDAY],  [SUNDAY]
										, [SPOTS1],  [SPOTS2],  [SPOTS3],  [SPOTS4],  [SPOTS5],  [SPOTS6],  [SPOTS7],  [TOTAL_SPOTS]
										, [JOB_NUMBER],  [JOB_COMPONENT_NBR],  [QUANTITY],  [RATE],  [NET_RATE],  [GROSS_RATE]
										, [EXT_NET_AMT],  [EXT_GROSS_AMT],  [COMM_AMT],  [REBATE_AMT],  [DISCOUNT_AMT],  [DISCOUNT_DESC]
										, [STATE_AMT],  [COUNTY_AMT],  [CITY_AMT],  [NON_RESALE_AMT],  [NETCHARGE],  [NCDESC]
										, [ADDL_CHARGE],  [ADDL_CHARGE_DESC]
										
										,  [LINE_TOTAL],  [LINE_CANCELLED],  [DATE_TO_BILL],  [BILLING_USER]
										
										, [AR_INV_NBR],  [AR_TYPE],  [AR_INV_SEQ]
										, [GLEXACT],  [GLESEQ_SALES],  [GLESEQ_COS],  [GLESEQ_WIP],  [GLESEQ_STATE],  [GLESEQ_COUNTY],  [GLESEQ_CITY]
										, [GLEXACT_DEF],  [GLACODE_SALES],  [GLACODE_COS],  [GLACODE_WIP],  [GLACODE_STATE],  [GLACODE_COUNTY],  [GLACODE_CITY]
										, [NON_BILL_FLAG],  [MODIFIED_BY],  [MODIFIED_DATE],  [MODIFIED_COMMENTS],  [BILL_TYPE_FLAG]
										, [COMM_PCT],  [MARKUP_PCT],  [REBATE_PCT],  [DISCOUNT_PCT],  [TAX_CODE],  [TAX_CITY_PCT],  [TAX_COUNTY_PCT],  [TAX_STATE_PCT]
										, [TAX_RESALE],  [TAXAPPLYC],  [TAXAPPLYLN],  [TAXAPPLYND],  [TAXAPPLYNC],  [TAXAPPLYR],  [TAXAPPLYAI]
										, [RECONCILE_FLAG],  [GLESEQ_SALES_DEF],  [GLESEQ_COS_DEF],  [GLACODE_SALES_DEF],  [GLACODE_COS_DEF]
										, [BILLING_AMT],  [COST_TYPE],  [COST_RATE],  [NET_BASE_RATE],  [GROSS_BASE_RATE]
										, [BILL_CANCELLED]
										, [EST_NBR],  [EST_LINE_NBR],  [EST_REV_NBR],  [AD_NUMBER],  [MAT_COMP],  [PROGRAMMING]
										, [START_TIME],  [END_TIME],  [LENGTH],  [REMARKS],  [TAG],  [NETWORK_ID])
						SELECT    [ORDER_NBR],  @MAX_LINE_NBR + 1, 0, 0,  1,  NULL,  [BUY_TYPE]
										, COALESCE(@new_start_date_d, [START_DATE]), COALESCE(@new_end_date_d, END_DATE),  [MONTH_NBR],  [YEAR_NBR],  COALESCE(@new_close_date_d, CLOSE_DATE), 
										COALESCE(@new_matl_close_date_d, MATL_CLOSE_DATE),  [EXT_CLOSE_DATE],  [EXT_MATL_DATE]
										, [DATE1],  [DATE2],  [DATE3],  [DATE4],  [DATE5],  [DATE6],  [DATE7]
										, [MONDAY],  [TUESDAY],  [WEDNESDAY],  [THURSDAY],  [FRIDAY],  [SATURDAY],  [SUNDAY]
										, @dec_ACTUAL_IMPRESSIONS,  0,  0,  0,  0,  0,  0,  @dec_ACTUAL_IMPRESSIONS
										, [JOB_NUMBER],  [JOB_COMPONENT_NBR],  [QUANTITY],  @dec_COST_RATE,  @dec_NEW_NET_RATE,  @dec_NEW_GROSS_RATE
										, @dec_NET_AMT,  @dec_GROSS_AMT,  @dec_COMM_AMT,  @dec_REBATE_AMT,  @dec_DISCOUNT_AMT,  [DISCOUNT_DESC]
										, @dec_STATE_TAX,  @dec_COUNTY_TAX,  @dec_CITY_TAX,  @dec_VENDOR_TAX,  @dec_NETCHARGES,  'AP Reconcile'
										, @dec_O_ADDL_CHARGE,  'AP Reconcile'
										
										,  @dec_LINE_TOTAL,  [LINE_CANCELLED],  [DATE_TO_BILL],  NULL
										
										,  NULL,  NULL,  NULL
										, NULL,  NULL,  NULL,  NULL,  NULL,  NULL,  NULL
										, NULL,  NULL,  NULL,  NULL,  NULL,  NULL,  NULL
										, [NON_BILL_FLAG],  @user_code,  @CURRENT_DATE,  @modified_comments + ' - Summary',  [BILL_TYPE_FLAG]
										, [COMM_PCT],  [MARKUP_PCT],  [REBATE_PCT],  [DISCOUNT_PCT],  [TAX_CODE],  [TAX_CITY_PCT],  [TAX_COUNTY_PCT],  [TAX_STATE_PCT]
										, [TAX_RESALE],  [TAXAPPLYC],  [TAXAPPLYLN],  [TAXAPPLYND],  [TAXAPPLYNC],  [TAXAPPLYR],  [TAXAPPLYAI]
										, NULL,  NULL,  NULL,  NULL,  NULL
										, @dec_AP_BILLING_AMT,  [COST_TYPE],  @dec_COST_RATE,  @dec_NEW_NET_RATE,  @dec_NEW_GROSS_RATE
										, (SELECT MAX(ISNULL(BILL_CANCELLED,0)) FROM dbo.RADIO_DETAIL WHERE ORDER_NBR = @order_nbr AND LINE_NBR = @line_nbr)
										, [EST_NBR],  [EST_LINE_NBR],  [EST_REV_NBR],  [AD_NUMBER],  [MAT_COMP],  [PROGRAMMING]
										, [START_TIME],  [END_TIME],  [LENGTH],  [REMARKS],  [TAG],  [NETWORK_ID]
						FROM	 dbo.RADIO_DETAIL
						WHERE	 ORDER_NBR = @order_nbr
						AND  	LINE_NBR = @line_nbr
						AND  	REV_NBR = @rev_nbr
						AND  	SEQ_NBR = @seq_nbr;	
						
						INSERT INTO [dbo].[RADIO_COMMENTS]
								    ([ORDER_NBR]   ,[LINE_NBR]    ,[INSTRUCTIONS]    ,[ORDER_COPY]
								   ,[MATL_NOTES]    ,[POSITION_INFO]    ,[CLOSE_INFO]    ,[RATE_INFO]
								   ,[MISC_INFO]    ,[IN_HOUSE_CMTS])
						SELECT
									[ORDER_NBR]   ,@MAX_LINE_NBR + 1    ,NULL    ,NULL
								   ,NULL    ,NULL    ,NULL    ,NULL
								   ,NULL    ,NULL 
						FROM [dbo].[RADIO_COMMENTS] 								
						WHERE	 ORDER_NBR = @order_nbr
						AND  	LINE_NBR = @line_nbr	;								
					END
				END	
			END /*** SKIP_NEW_LINE ***/
		END /* @DIFFERENCE_LINE - IF */
		ELSE BEGIN
				/* Only Add difference line if Roll-Forward */
				IF @reconcile_method = 'R' BEGIN
					INSERT INTO dbo.INTERNET_DETAIL  ( ORDER_NBR, LINE_NBR, REV_NBR, SEQ_NBR,
					ACTIVE_REV, LINK_DETID, [START_DATE], END_DATE, CLOSE_DATE, 
					MATL_CLOSE_DATE, EXT_CLOSE_DATE, EXT_MATL_DATE, HEADLINE, INTERNET_TYPE,
					SIZE, PROJ_IMPRESSIONS, GUARANTEED_IMPRESS, URL, TARGET_AUDIENCE, COPY_AREA, JOB_NUMBER, JOB_COMPONENT_NBR, RATE_CARD, RATE_TYPE, RATE_DESC, QUANTITY, 
					RATE, NET_RATE, GROSS_RATE, EXT_NET_AMT, EXT_GROSS_AMT,
					COMM_AMT, REBATE_AMT, DISCOUNT_AMT, DISCOUNT_DESC, STATE_AMT, COUNTY_AMT, CITY_AMT, NON_RESALE_AMT, 
					NETCHARGE, NCDESC, ADDL_CHARGE, ADDL_CHARGE_DESC, 
					
					LINE_TOTAL, LINE_CANCELLED, DATE_TO_BILL, BILLING_USER,
					
					AR_INV_NBR, AR_TYPE, AR_INV_SEQ, GLEXACT, GLESEQ_SALES, GLESEQ_COS, GLESEQ_WIP, GLESEQ_STATE, GLESEQ_COUNTY, GLESEQ_CITY, GLEXACT_DEF, 
					GLESEQ_COS_DEF, GLESEQ_SALES_DEF, GLACODE_SALES, GLACODE_COS, GLACODE_WIP,
					GLACODE_STATE, GLACODE_COUNTY, GLACODE_CITY, NON_BILL_FLAG, MODIFIED_BY, MODIFIED_DATE, MODIFIED_COMMENTS, BILL_TYPE_FLAG, CREATIVE_SIZE, PLACEMENT_1, PLACEMENT_2, 
					COMM_PCT, MARKUP_PCT, REBATE_PCT, DISCOUNT_PCT,
					TAX_CODE, TAX_CITY_PCT, TAX_COUNTY_PCT, TAX_STATE_PCT, TAX_RESALE, TAXAPPLYC, TAXAPPLYLN, TAXAPPLYND, TAXAPPLYNC, TAXAPPLYR, TAXAPPLYAI, RECONCILE_FLAG, ACT_IMPRESSIONS, 
					GLACODE_SALES_DEF, GLACODE_COS_DEF,
					BILLING_AMT, COST_TYPE, COST_RATE, NET_BASE_RATE, GROSS_BASE_RATE, 
					BILL_CANCELLED, EST_NBR, EST_LINE_NBR, EST_REV_NBR )
					SELECT
					ORDER_NBR, @MAX_LINE_NBR + 1, 0, 0,
					1, NULL, COALESCE(@new_start_date_d, [START_DATE]), COALESCE(@new_end_date_d, END_DATE), COALESCE(@new_close_date_d, CLOSE_DATE), 
					COALESCE(@new_matl_close_date_d, MATL_CLOSE_DATE), EXT_CLOSE_DATE, EXT_MATL_DATE, HEADLINE, INTERNET_TYPE,
					SIZE, NULL,@dec_ACTUAL_IMPRESSIONS, URL, TARGET_AUDIENCE, COPY_AREA, JOB_NUMBER, JOB_COMPONENT_NBR, RATE_CARD, RATE_TYPE, RATE_DESC, QUANTITY, 
					@dec_RECONCILE_RATE, @dec_NET_AMT, @dec_GROSS_AMT, @dec_NET_AMT, @dec_GROSS_AMT,
					@dec_COMM_AMT, @dec_REBATE_AMT, @dec_DISCOUNT_AMT, DISCOUNT_DESC, @dec_STATE_TAX, @dec_COUNTY_TAX, @dec_CITY_TAX, @dec_VENDOR_TAX, 
					@dec_NETCHARGES, 'AP Reconcile', @dec_ADDL_CHARGE, 'AP Reconcile - 0', 
					
					@dec_LINE_TOTAL, LINE_CANCELLED, COALESCE(@new_date_to_bill, [START_DATE]), BILLING_USER,
					
					NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 
					NULL, NULL, NULL, NULL, NULL,
					NULL, NULL, NULL, NON_BILL_FLAG, @user_code, @CURRENT_DATE, @modified_comments + '  - Roll Fwd', BILL_TYPE_FLAG, CREATIVE_SIZE, PLACEMENT_1, PLACEMENT_2, 
					COMM_PCT, MARKUP_PCT, REBATE_PCT, DISCOUNT_PCT,
					TAX_CODE, TAX_CITY_PCT, TAX_COUNTY_PCT, TAX_STATE_PCT, TAX_RESALE, TAXAPPLYC, TAXAPPLYLN, TAXAPPLYND, TAXAPPLYNC, TAXAPPLYR, TAXAPPLYAI, NULL, NULL, 
					GLACODE_SALES_DEF, GLACODE_COS_DEF,
					@dec_AP_BILLING_AMT, COST_TYPE, @dec_COST_RATE, @dec_NEW_NET_RATE, @dec_NEW_GROSS_RATE, 
					(SELECT MAX(ISNULL(BILL_CANCELLED,0)) FROM dbo.INTERNET_DETAIL WHERE ORDER_NBR = @order_nbr AND LINE_NBR = @line_nbr), EST_NBR, EST_LINE_NBR, EST_REV_NBR
					FROM	 dbo.INTERNET_DETAIL
					WHERE	 ORDER_NBR = @order_nbr
					AND  	LINE_NBR = @line_nbr
					AND  	REV_NBR = @rev_nbr
					AND  	SEQ_NBR = @seq_nbr;
					
					INSERT INTO [dbo].[INTERNET_COMMENTS]
							   ([ORDER_NBR]   ,[LINE_NBR]   ,[INSTRUCTIONS]   ,[MISC_INFO]
							   ,[ORDER_COPY]	   ,[MATL_NOTES])
					SELECT
								[ORDER_NBR]   ,@MAX_LINE_NBR + 1   ,NULL   ,NULL
							   ,NULL	   ,NULL 
					FROM [dbo].[INTERNET_COMMENTS] 		  						
					WHERE	 ORDER_NBR = @order_nbr  
					AND  	LINE_NBR = @line_nbr	;						
				END	
		END /* @DIFFERENCE_LINE - ELSE */
		
		IF @DIFFERENCE_LINE = 0 BEGIN

			IF @media_type = 'I' BEGIN
				SELECT BILLING_AMT, * FROM INTERNET_DETAIL WHERE ORDER_NBR = @order_nbr ORDER BY LINE_NBR, START_DATE        /***************** DEBUG **************/
				SELECT LINE_TOTAL, * FROM AP_INTERNET WHERE ORDER_NBR = @order_nbr AND ORDER_LINE_NBR = 1
			END
			ELSE IF @media_type = 'T' BEGIN
				SELECT * FROM TV_DETAIL WHERE ORDER_NBR = @order_nbr ORDER BY LINE_NBR, START_DATE        /***************** DEBUG **************/
			END
			ELSE IF @media_type = 'R' BEGIN
				SELECT * FROM RADIO_DETAIL WHERE ORDER_NBR = @order_nbr ORDER BY LINE_NBR, START_DATE        /***************** DEBUG **************/
			END
			IF @media_type = 'N' BEGIN
				SELECT LINE_TOTAL, * FROM AP_NEWSPAPER WHERE ORDER_NBR = @order_nbr AND ORDER_LINE_NBR = 1	
				SELECT BILLING_AMT, * FROM NEWSPAPER_DETAIL WHERE ORDER_NBR = @order_nbr ORDER BY START_DATE, LINE_NBR        /***************** DEBUG **************/
				SELECT * FROM NEWSPAPER_OTH_CHGS WHERE ORDER_NBR = @order_nbr
			END	
			IF @media_type = 'M' BEGIN
				SELECT LINE_TOTAL, * FROM AP_MAGAZINE WHERE ORDER_NBR = @order_nbr AND ORDER_LINE_NBR = 1			/***************** DEBUG **************/
				SELECT BILLING_AMT, * FROM MAGAZINE_DETAIL WHERE ORDER_NBR = @order_nbr AND LINE_NBR IN (1,2)		/***************** DEBUG **************/
			END
			IF @media_type = 'O' BEGIN
				SELECT LINE_TOTAL, * FROM AP_OUTDOOR WHERE ORDER_NBR = @order_nbr AND ORDER_LINE_NBR = 1			/***************** DEBUG **************/
				SELECT BILLING_AMT, * FROM OUTDOOR_DETAIL WHERE ORDER_NBR = @order_nbr AND LINE_NBR IN (1,2)		/***************** DEBUG **************/
			END	
		END	
		
		IF @DIFFERENCE_LINE = 0 BEGIN
			SET @DIFFERENCE_LINE = 1
			GOTO SECOND_PASS
		END

--RAISERROR ('Error raised in TRY block.', -- Message text.
--               16, -- Severity.
--               1); -- State.               
		
GOTO ENDIT


ENDIT:    /************ THE END *******************/
	
	--SELECT ORDER_NBR, YEAR_NBR, MONTH_NBR, SUM(TOTAL_SPOTS) FROM TV_DETAIL WHERE ORDER_NBR = 1042 AND ACTIVE_REV = 1 GROUP BY ORDER_NBR, YEAR_NBR, MONTH_NBR /********* DEBUG *********/
	
	--ROLLBACK TRAN
	COMMIT TRAN
	
	SET @ret_value = '---'
	--SELECT @ret_value AS ErrorMessage
	
	RETURN 0

END TRY
BEGIN CATCH

	ROLLBACK TRAN
	
	SET @ret_value = LEFT(ERROR_MESSAGE(), 254)
	--SELECT @ret_value as ErrorMessage;
	RETURN -1
    
END CATCH

GO

GRANT EXECUTE ON [advsp_ap_media_reconcile_revise] TO PUBLIC AS dbo
GO