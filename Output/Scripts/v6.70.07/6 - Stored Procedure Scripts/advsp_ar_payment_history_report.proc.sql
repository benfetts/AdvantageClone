if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[advsp_ar_payment_history_report]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[advsp_ar_payment_history_report]
GO

CREATE PROCEDURE [dbo].[advsp_ar_payment_history_report]
	@PostPeriodStart varchar(6),
	@PostPeriodEnd varchar(6),
	@AgingOption smallint,
	@IncludeOnAccount bit
AS
BEGIN
	CREATE TABLE #RPT_DATA (
		[OfficeCode] varchar(4) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		[OfficeName] varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		[ClientCode] varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		[ClientName] varchar(40) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		[ClientARComment] varchar(max) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		[DivisionCode] varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		[DivisionName] varchar(40) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		[ProductCode] varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		[ProductDescription] varchar(40) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		[ProductUDF1] varchar(50) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		[ProductUDF2] varchar(50) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		[ProductUDF3] varchar(50) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		[ProductUDF4] varchar(50) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		[ARInvoiceNumber] int NOT NULL,
		[ARInvoiceSequence] smallint NOT NULL,
		[ARInvoiceType] varchar(2) COLLATE SQL_Latin1_General_CP1_CS_AS NOT NULL,
		[ARInvoiceDate] smalldatetime NULL,
		[ARInvoiceDueDate] smalldatetime NULL,
		[ARCoopCode] varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		[ARCoopPercentage] decimal(10,4) NULL,
		[ARManualInvoiceFlag] bit NULL,
		[ARInvoiceCategory] varchar(20) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		[ARDescription] varchar(40) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		[ARCollectionNotes] varchar(max) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		[ARType] varchar(20) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		[MediaType] varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		[TransactionType] varchar(10),
		[PostingPeriod] varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		[SalesPostingPeriod] varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		[CampaignCode] varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		[CampaignName] varchar(128) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		[ClientPO] varchar(40) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		[AccountExecutiveCode] varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		[AccountExecutiveName] varchar(100) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		[JobNumber] int NULL,
		[JobDescription] varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		[ClientReference] varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		[JobComponentNumber] smallint NULL,
		[JobComponentDescription] varchar(60) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		[JobTypeDescription] varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		[JobAccountExecutiveCode] varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		[JobAccountExecutiveName] varchar(100) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		[OrderNumber] int NULL,
		[OrderDescription] varchar(40) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		[VendorCode] varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		[VendorName] varchar(40) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		[MediaMarket] varchar(10) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		[MediaDates] varchar(20) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		[ABIncomeRecognition] varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		--
		[ARHoursQuantity] decimal(18,2) NULL,
		[AREmployeeTimeAmount] decimal(18,2) NULL,
		[ARIncomeOnlyAmount] decimal(18,2) NULL,
		[ARCommissionAmount] decimal(18,2) NULL,
		[ARRebateAmount] decimal(18,2) NULL,
		[ARAdditionalCharges] decimal(18,2) NULL,
		[ARCostAmount] decimal(18,2) NULL,
		[ARAdvanceCostAmount] decimal(18,2) NULL,
		[ARAdvanceIncomeAmount] decimal(18,2) NULL,
		[ARAdvanceCommissionAmount] decimal(18,2) NULL,
		[ARAdvanceRetained] decimal(18,2) NULL,
		[ARCityTaxAmount] decimal(18,2) NULL,
		[ARCountyTaxAmount] decimal(18,2) NULL,
		[ARStateTaxAmount] decimal(18,2) NULL,
		[ARInvoiceAmount] decimal(18,2) NULL,
		--
		[CheckNumber] varchar(15) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		[CheckDate] smalldatetime NULL,
		[CheckDepositDate] smalldatetime NULL,
		[CheckAmount] decimal(14,2) NULL,
		[CheckAdjustmentAmount] decimal(18,2) NULL,
		[BalanceAmount] decimal(18,2) NULL,
		[Paid] varchar(3) NULL,
		[DaysToPay] int NULL,
		CashReceiptPaymentType varchar(100) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		--
		ClientBillingAddress1 varchar(40) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		ClientBillingAddress2 varchar(40) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		ClientBillingCity varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		ClientBillingState varchar(10) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		ClientBillingZip varchar(10) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		ClientBillingCounty varchar(20) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		ClientBillingCountry varchar(20) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		--
		ClientStatementAddress1 varchar(40) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		ClientStatementAddress2 varchar(40) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		ClientStatementCity varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		ClientStatementState varchar(10) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		ClientStatementZip varchar(10) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		ClientStatementCounty varchar(20) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		ClientStatementCountry varchar(20) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		ClientProductionContact varchar(40) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		ClientMediaContact varchar(40) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		--
		DivisionBillingAddress1 varchar(40) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		DivisionBillingAddress2 varchar(40) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		DivisionBillingCity varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		DivisionBillingState varchar(10) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		DivisionBillingZip varchar(10) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		DivisionBillingCounty varchar(20) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		DivisionBillingCountry varchar(20) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		--
		DivisionStatementAddress1 varchar(40) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		DivisionStatementAddress2 varchar(40) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		DivisionStatementCity varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		DivisionStatementState varchar(10) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		DivisionStatementZip varchar(10) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		DivisionStatementCounty varchar(20) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		DivisionStatementCountry varchar(20) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		DivisionContact varchar(40) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		--
		ProductBillingAddress1 varchar(40) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		ProductBillingAddress2 varchar(40) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		ProductBillingCity varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		ProductBillingState varchar(10) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		ProductBillingZip varchar(10) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		ProductBillingCounty varchar(20) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		ProductBillingCountry varchar(20) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		--
		ProductStatementAddress1 varchar(40) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		ProductStatementAddress2 varchar(40) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		ProductStatementCity varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		ProductStatementState varchar(10) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		ProductStatementZip varchar(10) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		ProductStatementCounty varchar(20) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		ProductStatementCountry varchar(20) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		ProductContact varchar(40) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		BankCode varchar(4) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		BankDescription varchar(30) COLLATE SQL_Latin1_General_CP1_CS_AS NULL,
		IsCleared bit NOT NULL
	)
	
	--Manual Invoices
	INSERT INTO #RPT_DATA
	SELECT 
		[OfficeCode],
		[OfficeName],
		[ClientCode],
		[ClientName],
		[ClientARComment],
		[DivisionCode],
		[DivisionName],
		[ProductCode],
		[ProductDescription],
		[ProductUDF1],
		[ProductUDF2],
		[ProductUDF3],
		[ProductUDF4],
		[ARInvoiceNumber],
		[ARInvoiceSequence],
		[ARInvoiceType],
		[ARInvoiceDate],
		[ARInvoiceDueDate],
		[ARCoopCode],
		[ARCoopPercentage],
		[ARManualInvoiceFlag],
		[ARInvoiceCategory],
		[ARDescription],
		[ARCollectionNotes],
		[ARType],
		[MediaType],
		[TransactionType],
		[PostingPeriod],
		[SalesPostingPeriod],
		[CampaignCode],
		[CampaignName],
		[ClientPO],
		[AccountExecutiveCode],
		[AccountExecutiveName],
		[JobNumber],
		[JobDescription],
		[ClientReference],
		[JobComponentNumber],
		[JobComponentDescription],
		[JobTypeDescription],
		[JobAccountExecutiveCode],
		[JobAccountExecutiveName],
		[OrderNumber],
		[OrderDescription],
		[VendorCode],
		[VendorName],
		[MediaMarket],
		[MediaDates],
		[ABIncomeRecognition],

		SUM(COALESCE([ARHoursQuantity],0)),
		SUM(COALESCE([AREmployeeTimeAmount],0)),
		SUM(COALESCE([ARIncomeOnlyAmount],0)),
		SUM(COALESCE([ARCommissionAmount],0)),
		SUM(COALESCE([ARRebateAmount],0)),
		SUM(COALESCE([ARAdditionalCharges],0)),
		SUM(COALESCE([ARCostAmount],0)),
		SUM(COALESCE([ARAdvanceCostAmount],0)),
		SUM(COALESCE([ARAdvanceIncomeAmount],0)),
		SUM(COALESCE([ARAdvanceCommissionAmount],0)),
		SUM(COALESCE([ARAdvanceRetained],0)),
		SUM(COALESCE([ARCityTaxAmount],0)),
		SUM(COALESCE([ARCountyTaxAmount],0)),
		SUM(COALESCE([ARStateTaxAmount],0)),
		SUM(COALESCE([ARInvoiceAmount],0)),
		[CheckNumber] = NULL,
		[CheckDate] = NULL,
		[CheckDepositDate] = NULL,
		[CheckAmount] = 0,
		[CheckAdjustmentAmount] = 0,
		SUM(COALESCE([BalanceAmount],0)),
		[Paid] = NULL,
		[DaysToPay] = 0,
		CashReceiptPaymentType = NULL,
		ClientBillingAddress1,
		ClientBillingAddress2,
		ClientBillingCity,
		ClientBillingState,
		ClientBillingZip,
		ClientBillingCounty,
		ClientBillingCountry,
		ClientStatementAddress1,
		ClientStatementAddress2,
		ClientStatementCity,
		ClientStatementState,
		ClientStatementZip,
		ClientStatementCounty,
		ClientStatementCountry,
		ClientProductionContact,
		ClientMediaContact,
		DivisionBillingAddress1,
		DivisionBillingAddress2,
		DivisionBillingCity,
		DivisionBillingState,
		DivisionBillingZip,
		DivisionBillingCounty,
		DivisionBillingCountry,
		DivisionStatementAddress1,
		DivisionStatementAddress2,
		DivisionStatementCity,
		DivisionStatementState,
		DivisionStatementZip,
		DivisionStatementCounty,
		DivisionStatementCountry,
		DivisionContact,
		ProductBillingAddress1,
		ProductBillingAddress2,
		ProductBillingCity,
		ProductBillingState,
		ProductBillingZip,
		ProductBillingCounty,
		ProductBillingCountry,
		ProductStatementAddress1,
		ProductStatementAddress2,
		ProductStatementCity,
		ProductStatementState,
		ProductStatementZip,
		ProductStatementCounty,
		ProductStatementCountry,
		ProductContact,
		BankCode,
		BankDescription,
		IsCleared
	FROM 
		(
		SELECT
			[OfficeCode] = AR.OFFICE_CODE,
			[OfficeName] = O.OFFICE_NAME,
			[ClientCode] = AR.CL_CODE,
			[ClientName] = C.CL_NAME,
			[ClientARComment] = CAST(C.CL_AR_COMMENT AS VARCHAR(MAX)),
			[DivisionCode] = AR.DIV_CODE,
			[DivisionName] = D.DIV_NAME,
			[ProductCode] = AR.PRD_CODE,
			[ProductDescription] = P.PRD_DESCRIPTION,
			[ProductUDF1] = P.USER_DEFINED1,
			[ProductUDF2] = P.USER_DEFINED2,
			[ProductUDF3] = P.USER_DEFINED3,
			[ProductUDF4] = P.USER_DEFINED4,
			[ARInvoiceNumber] = AR.AR_INV_NBR,
			[ARInvoiceSequence] = AR.AR_INV_SEQ,
			[ARInvoiceType] = AR.AR_TYPE,
			[ARInvoiceDate] = AR.AR_INV_DATE,
			[ARInvoiceDueDate] = CASE
									WHEN AR.DUE_DATE IS NOT NULL THEN AR.DUE_DATE
									WHEN AR.DUE_DATE IS NULL AND AR.REC_TYPE IN ( 'P','S' ) THEN DATEADD( Day,ISNULL( C.CL_P_PAYDAYS, 0 ), AR.AR_INV_DATE )
									ELSE DATEADD( Day, ISNULL( C.CL_M_PAYDAYS, 0 ), AR.AR_INV_DATE )
								 END,
			[ARCoopCode] = NULL,
			[ARCoopPercentage] = NULL,
			[ARManualInvoiceFlag] = CAST(1 AS BIT),
			[ARInvoiceCategory] = IC.INV_CAT_DESC,
			[ARDescription] = AR.AR_DESCRIPTION,
			[ARCollectionNotes] = CAST(N.COLLECT_NOTES AS VARCHAR(MAX)),
			[ARType] = CASE
							WHEN AR.REC_TYPE = 'P' THEN 'Production'
							ELSE 'Media'
					   END,
			[MediaType] = SC.SC_DESCRIPTION,
			[TransactionType] = 'AR',
			[PostingPeriod] = AR.AR_POST_PERIOD,
			[SalesPostingPeriod] = AR.AR_POST_PERIOD,
			[CampaignCode] = NULL,
			[CampaignName] = NULL,
			[ClientPO] = NULL,
			[AccountExecutiveCode] = AE.EMP_CODE,
			[AccountExecutiveName] = dbo.udf_get_empl_name(AE.EMP_CODE, 'FML'),
			[JobNumber] = NULL,
			[JobDescription] = NULL,
			[ClientReference] = NULL,
			[JobComponentNumber] = NULL,
			[JobComponentDescription] = NULL,
			[JobTypeDescription] = NULL,			
			[JobAccountExecutiveCode] = NULL,
			[JobAccountExecutiveName] = NULL,
			[OrderNumber] = NULL,
			[OrderDescription] = NULL,
			[VendorCode] = NULL,
			[VendorName] = NULL,
			[MediaMarket] = NULL,
			[MediaDates] = NULL,
			[ABIncomeRecognition] = NULL,

			[ARHoursQuantity] = 0,
			[AREmployeeTimeAmount] = 0,
			[ARIncomeOnlyAmount] = 0,
			[ARCommissionAmount] = AR.AR_COMM_AMT,
			[ARRebateAmount] = 0,
			[ARAdditionalCharges] = 0,
			[ARCostAmount] = AR.AR_COS_AMT,
			[ARAdvanceCostAmount] = 0,
			[ARAdvanceIncomeAmount] = 0,
			[ARAdvanceCommissionAmount] = 0,
			[ARAdvanceRetained] = 0,
			[ARCityTaxAmount] = AR.AR_CITY_AMT,
			[ARCountyTaxAmount] = AR.AR_COUNTY_AMT,
			[ARStateTaxAmount] = AR.AR_STATE_AMT,
			[ARInvoiceAmount] = AR.AR_INV_AMOUNT,
			[CheckNumber] = NULL,
			[CheckDate] = NULL,
			[CheckDepositDate] = NULL,
			[CheckAmount] = 0,
			[CheckAdjustmentAmount] = 0,
			[BalanceAmount] = AR.AR_INV_AMOUNT,
			[Paid] = NULL,
			[DaysToPay] = 0,
			CashReceiptPaymentType = NULL,
			ClientBillingAddress1 = C.CL_BADDRESS1,
			ClientBillingAddress2 = C.CL_BADDRESS2,
			ClientBillingCity = C.CL_BCITY,
			ClientBillingState = C.CL_BSTATE,
			ClientBillingZip = C.CL_BZIP,
			ClientBillingCounty = C.CL_BCOUNTY,
			ClientBillingCountry = C.CL_BCOUNTRY,
			ClientStatementAddress1 = C.CL_SADDRESS1,
			ClientStatementAddress2 = C.CL_SADDRESS2,
			ClientStatementCity = C.CL_SCITY,
			ClientStatementState= C.CL_SSTATE,
			ClientStatementZip = C.CL_SZIP,
			ClientStatementCounty = C.CL_SCOUNTY,
			ClientStatementCountry = C.CL_SCOUNTRY,
			ClientProductionContact = C.CL_ATTENTION,
			ClientMediaContact = C.CL_MATTENTION,
			DivisionBillingAddress1 = D.DIV_BADDRESS1,
			DivisionBillingAddress2 = D.DIV_BADDRESS2,
			DivisionBillingCity = D.DIV_BCITY,
			DivisionBillingState = D.DIV_BSTATE,
			DivisionBillingZip = D.DIV_BZIP,
			DivisionBillingCounty = D.DIV_BCOUNTY,
			DivisionBillingCountry = D.DIV_BCOUNTRY,
			DivisionStatementAddress1 = D.DIV_SADDRESS1,
			DivisionStatementAddress2 = D.DIV_SADDRESS2,
			DivisionStatementCity = D.DIV_SCITY,
			DivisionStatementState = D.DIV_SSTATE,
			DivisionStatementZip = D.DIV_SZIP,
			DivisionStatementCounty = D.DIV_SCOUNTY,
			DivisionStatementCountry = D.DIV_SCOUNTRY,
			DivisionContact = D.DIV_ATTENTION,
			ProductBillingAddress1 = P.PRD_BILL_ADDRESS1,
			ProductBillingAddress2 = P.PRD_BILL_ADDRESS2,
			ProductBillingCity = P.PRD_BILL_CITY,
			ProductBillingState = P.PRD_BILL_STATE,
			ProductBillingZip = P.PRD_BILL_ZIP,
			ProductBillingCounty = P.PRD_BILL_COUNTY,
			ProductBillingCountry = P.PRD_BILL_COUNTRY,
			ProductStatementAddress1 = P.PRD_STATE_ADDR1,
			ProductStatementAddress2 = P.PRD_STATE_ADDR2,
			ProductStatementCity = P.PRD_STATE_CITY,
			ProductStatementState = P.PRD_STATE_STATE,
			ProductStatementZip = P.PRD_STATE_ZIP,
			ProductStatementCounty = P.PRD_STATE_COUNTY,
			ProductStatementCountry = P.PRD_STATE_COUNTRY,
			ProductContact = P.PRD_ATTENTION,
			BankCode = NULL,
			BankDescription = NULL,
			IsCleared = 0
		FROM dbo.ACCT_REC AR
			LEFT OUTER JOIN dbo.AR_COLL_NOTES N ON AR.AR_INV_NBR = N.AR_INV_NBR AND AR.AR_INV_SEQ = N.AR_INV_SEQ AND AR.AR_TYPE = N.AR_TYPE 
			LEFT OUTER JOIN dbo.INVOICE_CATEGORY AS IC ON AR.INV_CAT = IC.INV_CAT	
			LEFT OUTER JOIN dbo.OFFICE O ON AR.OFFICE_CODE = O.OFFICE_CODE
			LEFT OUTER JOIN dbo.CLIENT C ON AR.CL_CODE = C.CL_CODE
			LEFT OUTER JOIN dbo.DIVISION D ON AR.CL_CODE = D.CL_CODE AND AR.DIV_CODE = D.DIV_CODE
			LEFT OUTER JOIN dbo.PRODUCT P ON AR.CL_CODE = P.CL_CODE AND AR.DIV_CODE = P.DIV_CODE AND AR.PRD_CODE = P.PRD_CODE
			LEFT OUTER JOIN dbo.SALES_CLASS SC ON AR.SC_CODE = SC.SC_CODE AND SC.SC_TYPE = 'P'
			LEFT OUTER JOIN dbo.ACCOUNT_EXECUTIVE AE ON AE.CL_CODE = P.CL_CODE AND AE.DIV_CODE = P.DIV_CODE AND AE.PRD_CODE = P.PRD_CODE 
														AND (AE.INACTIVE_FLAG = 0 OR AE.INACTIVE_FLAG IS NULL) AND AE.DEFAULT_AE = 1
		WHERE
			AR.AR_INV_SEQ <> 99
		AND AR.MANUAL_INV = 1
		AND	AR.AR_POST_PERIOD between @PostPeriodStart AND @PostPeriodEnd
	) InvoiceLevel
	GROUP BY 
		[OfficeCode],
		[OfficeName],
		[ClientCode],
		[ClientName],
		[ClientARComment],
		[DivisionCode],
		[DivisionName],
		[ProductCode],
		[ProductDescription],
		[ProductUDF1],
		[ProductUDF2],
		[ProductUDF3],
		[ProductUDF4],
		[ARInvoiceNumber],
		[ARInvoiceSequence],
		[ARInvoiceType],
		[ARInvoiceDate],
		[ARInvoiceDueDate],
		[ARCoopCode],
		[ARCoopPercentage],
		[ARManualInvoiceFlag],
		[ARInvoiceCategory],
		[ARDescription],
		[ARCollectionNotes],
		[ARType],
		[MediaType],
		[TransactionType],
		[PostingPeriod],
		[SalesPostingPeriod],
		[CampaignCode],
		[CampaignName],
		[ClientPO],
		[AccountExecutiveCode],
		[AccountExecutiveName],
		[JobNumber],
		[JobDescription],
		[ClientReference],
		[JobComponentNumber],
		[JobComponentDescription],
		[JobTypeDescription],
		[JobAccountExecutiveCode],
		[JobAccountExecutiveName],
		[OrderNumber],
		[OrderDescription],
		[VendorCode],
		[VendorName],
		[MediaMarket],
		[MediaDates],
		[ABIncomeRecognition],
		ClientBillingAddress1,
		ClientBillingAddress2,
		ClientBillingCity,
		ClientBillingState,
		ClientBillingZip,
		ClientBillingCounty,
		ClientBillingCountry,
		ClientStatementAddress1,
		ClientStatementAddress2,
		ClientStatementCity,
		ClientStatementState,
		ClientStatementZip,
		ClientStatementCounty,
		ClientStatementCountry,
		ClientProductionContact,
		ClientMediaContact,
		DivisionBillingAddress1,
		DivisionBillingAddress2,
		DivisionBillingCity,
		DivisionBillingState,
		DivisionBillingZip,
		DivisionBillingCounty,
		DivisionBillingCountry,
		DivisionStatementAddress1,
		DivisionStatementAddress2,
		DivisionStatementCity,
		DivisionStatementState,
		DivisionStatementZip,
		DivisionStatementCounty,
		DivisionStatementCountry,
		DivisionContact,
		ProductBillingAddress1,
		ProductBillingAddress2,
		ProductBillingCity,
		ProductBillingState,
		ProductBillingZip,
		ProductBillingCounty,
		ProductBillingCountry,
		ProductStatementAddress1,
		ProductStatementAddress2,
		ProductStatementCity,
		ProductStatementState,
		ProductStatementZip,
		ProductStatementCounty,
		ProductStatementCountry,
		ProductContact,
		BankCode,
		BankDescription,
		IsCleared
	INSERT INTO #RPT_DATA
	SELECT 
		[OfficeCode],
		[OfficeName],
		[ClientCode],
		[ClientName],
		[ClientARComment],
		[DivisionCode],
		[DivisionName],
		[ProductCode],
		[ProductDescription],
		[ProductUDF1],
		[ProductUDF2],
		[ProductUDF3],
		[ProductUDF4],
		[ARInvoiceNumber],
		[ARInvoiceSequence],
		[ARInvoiceType],
		[ARInvoiceDate],
		[ARInvoiceDueDate],
		[ARCoopCode],
		[ARCoopPercentage],
		[ARManualInvoiceFlag],
		[ARInvoiceCategory],
		[ARDescription],
		[ARCollectionNotes],
		[ARType],
		[MediaType],
		[TransactionType],
		[PostingPeriod],
		[SalesPostingPeriod],
		[CampaignCode],
		[CampaignName],
		[ClientPO],
		[AccountExecutiveCode],
		[AccountExecutiveName],
		[JobNumber],
		[JobDescription],
		[ClientReference],
		[JobComponentNumber],
		[JobComponentDescription],
		[JobTypeDescription],
		[JobAccountExecutiveCode],
		[JobAccountExecutiveName],
		[OrderNumber],
		[OrderDescription],
		[VendorCode],
		[VendorName],
		[MediaMarket],
		[MediaDates],
		[ABIncomeRecognition],

		SUM(COALESCE([ARHoursQuantity],0)),
		SUM(COALESCE([AREmployeeTimeAmount],0)),
		SUM(COALESCE([ARIncomeOnlyAmount],0)),
		SUM(COALESCE([ARCommissionAmount],0)),
		SUM(COALESCE([ARRebateAmount],0)),
		SUM(COALESCE([ARAdditionalCharges],0)),
		SUM(COALESCE([ARCostAmount],0)),
		SUM(COALESCE([ARAdvanceCostAmount],0)),
		SUM(COALESCE([ARAdvanceIncomeAmount],0)),
		SUM(COALESCE([ARAdvanceCommissionAmount],0)),
		SUM(COALESCE([ARAdvanceRetained],0)),
		SUM(COALESCE([ARCityTaxAmount],0)),
		SUM(COALESCE([ARCountyTaxAmount],0)),
		SUM(COALESCE([ARStateTaxAmount],0)),
		SUM(COALESCE([ARInvoiceAmount],0)),
		[CheckNumber] = NULL,
		[CheckDate] = NULL,
		[CheckDepositDate] = NULL,
		[CheckAmount] = 0,
		[CheckAdjustmentAmount] = 0,
		SUM(COALESCE([BalanceAmount],0)),
		[Paid] = NULL,
		[DaysToPay] = 0,
		CashReceiptPaymentType = NULL,
		ClientBillingAddress1,
		ClientBillingAddress2,
		ClientBillingCity,
		ClientBillingState,
		ClientBillingZip,
		ClientBillingCounty,
		ClientBillingCountry,
		ClientStatementAddress1,
		ClientStatementAddress2,
		ClientStatementCity,
		ClientStatementState,
		ClientStatementZip,
		ClientStatementCounty,
		ClientStatementCountry,
		ClientProductionContact,
		ClientMediaContact,
		DivisionBillingAddress1,
		DivisionBillingAddress2,
		DivisionBillingCity,
		DivisionBillingState,
		DivisionBillingZip,
		DivisionBillingCounty,
		DivisionBillingCountry,
		DivisionStatementAddress1,
		DivisionStatementAddress2,
		DivisionStatementCity,
		DivisionStatementState,
		DivisionStatementZip,
		DivisionStatementCounty,
		DivisionStatementCountry,
		DivisionContact,
		ProductBillingAddress1,
		ProductBillingAddress2,
		ProductBillingCity,
		ProductBillingState,
		ProductBillingZip,
		ProductBillingCounty,
		ProductBillingCountry,
		ProductStatementAddress1,
		ProductStatementAddress2,
		ProductStatementCity,
		ProductStatementState,
		ProductStatementZip,
		ProductStatementCounty,
		ProductStatementCountry,
		ProductContact,
		BankCode,
		BankDescription,
		IsCleared
	FROM 
		(
		SELECT
			[OfficeCode] = ARS.OFFICE_CODE,
			[OfficeName] = O.OFFICE_NAME,
			[ClientCode] = ARS.CL_CODE,
			[ClientName] = C.CL_NAME,
			[ClientARComment] = CAST(C.CL_AR_COMMENT AS VARCHAR(MAX)),
			[DivisionCode] = ARS.DIV_CODE,
			[DivisionName] = D.DIV_NAME,
			[ProductCode] = ARS.PRD_CODE,
			[ProductDescription] = P.PRD_DESCRIPTION,
			[ProductUDF1] = P.USER_DEFINED1,
			[ProductUDF2] = P.USER_DEFINED2,
			[ProductUDF3] = P.USER_DEFINED3,
			[ProductUDF4] = P.USER_DEFINED4,
			[ARInvoiceNumber] = ARS.AR_INV_NBR,
			[ARInvoiceSequence] = ARS.AR_INV_SEQ,
			[ARInvoiceType] = ARS.AR_TYPE,
			[ARInvoiceDate] = AR.AR_INV_DATE,
			[ARInvoiceDueDate] = CASE
									WHEN AR.DUE_DATE IS NOT NULL THEN AR.DUE_DATE
									WHEN AR.DUE_DATE IS NULL AND AR.REC_TYPE IN ( 'P','S' ) THEN DATEADD( Day,ISNULL( C.CL_P_PAYDAYS, 0 ), AR.AR_INV_DATE )
									ELSE DATEADD( Day, ISNULL( C.CL_M_PAYDAYS, 0 ), AR.AR_INV_DATE )
								 END,
			[ARCoopCode] = ARS.COOP_CODE,
			[ARCoopPercentage] = ARS.COOP_PCT,
			[ARManualInvoiceFlag] = CAST(COALESCE(ARS.MANUAL_FLAG, 0) AS BIT),
			[ARInvoiceCategory] = IC.INV_CAT_DESC,
			[ARDescription] = ARS.AR_DESCRIPTION,
			[ARCollectionNotes] = CAST(N.COLLECT_NOTES AS VARCHAR(MAX)),
			[ARType] = CASE
							WHEN ARS.JOB_NUMBER IS NOT NULL THEN 'Production'
							WHEN ARS.MEDIA_TYPE IN ('R','T') THEN 'Broadcast Media'
							WHEN ARS.MEDIA_TYPE IN ('I','M','N','O') THEN 'Print Media'
					   END,
			[MediaType] = SC.SC_DESCRIPTION,
			[TransactionType] = 'AR',
			[PostingPeriod] = AR.AR_POST_PERIOD,
			[SalesPostingPeriod] = ARS.SALE_POST_PERIOD,
			[CampaignCode] = CMP.CMP_CODE,
			[CampaignName] = CMP.CMP_NAME,
			[ClientPO] = ARS.CLIENT_PO,
			[AccountExecutiveCode] = AE.EMP_CODE,
			[AccountExecutiveName] = dbo.udf_get_empl_name(AE.EMP_CODE, 'FML'),
			[JobNumber] = ARS.JOB_NUMBER,
			[JobDescription] = JL.JOB_DESC,
			[ClientReference] = JL.JOB_CLI_REF,
			[JobComponentNumber] = ARS.JOB_COMPONENT_NBR,
			[JobComponentDescription] = JC.JOB_COMP_DESC,
			[JobTypeDescription] = JT.JT_DESC,			
			[JobAccountExecutiveCode] = JC.EMP_CODE,
			[JobAccountExecutiveName] = COALESCE((RTRIM(EMP.EMP_FNAME) + ' '),'') + COALESCE((EMP.EMP_MI + '. '),'') + COALESCE(EMP.EMP_LNAME,''),
			[OrderNumber] = ARS.ORDER_NBR,
			[OrderDescription] = VMH.ORDER_DESC,
			[VendorCode] = VMH.VN_CODE,
			[VendorName] = V.VN_NAME,
			[MediaMarket] = ARS.MARKET_CODE,
			[MediaDates] = CASE WHEN ARS.MEDIA_TYPE IS NOT NULL THEN dbo.advfn_media_order_dates(ARS.ORDER_NBR,dbo.advfn_ar_min_order_line(ARS.AR_INV_NBR, ARS.ORDER_NBR), ARS.MEDIA_TYPE)
								ELSE NULL 
						   END,
			[ABIncomeRecognition] = CASE ARS.AB_REC_FLAG 
									WHEN 1 THEN 'Upon Reconciliation'
									WHEN 2 THEN 'Initial Billing'
									END,

			[ARHoursQuantity] = ARS.HRS_QTY,
			[AREmployeeTimeAmount] = ARS.EMP_TIME_AMT,
			[ARIncomeOnlyAmount] = ARS.INC_ONLY_AMT,
			[ARCommissionAmount] = ARS.COMMISSION_AMT,
			[ARRebateAmount] = ARS.REBATE_AMT,
			[ARAdditionalCharges] = ARS.ADDITIONAL_AMT,
			[ARCostAmount] = COALESCE(ARS.COST_AMT,0) + COALESCE(ARS.NET_CHARGE_AMT,0) + COALESCE(ARS.DISCOUNT_AMT,0) + COALESCE(ARS.NON_RESALE_AMT,0),
			[ARAdvanceCostAmount] = ARS.AB_COST_AMT,
			[ARAdvanceIncomeAmount] = ARS.AB_INC_AMT,
			[ARAdvanceCommissionAmount] = ARS.AB_COMMISSION_AMT,
			[ARAdvanceRetained] = ARS.AB_SALE_AMT,
			[ARCityTaxAmount] = ARS.CITY_TAX_AMT,
			[ARCountyTaxAmount] = ARS.CNTY_TAX_AMT,
			[ARStateTaxAmount] = ARS.STATE_TAX_AMT,
			[ARInvoiceAmount] = ARS.TOTAL_BILL,
			[CheckNumber] = NULL,
			[CheckDate] = NULL,
			[CheckDepositDate] = NULL,
			[CheckAmount] = 0,
			[CheckAdjustmentAmount] = 0,
			[BalanceAmount] = ARS.TOTAL_BILL,
			[Paid] = NULL,
			[DaysToPay] = 0,
			CashReceiptPaymentType = NULL,
			ClientBillingAddress1 = C.CL_BADDRESS1,
			ClientBillingAddress2 = C.CL_BADDRESS2,
			ClientBillingCity = C.CL_BCITY,
			ClientBillingState = C.CL_BSTATE,
			ClientBillingZip = C.CL_BZIP,
			ClientBillingCounty = C.CL_BCOUNTY,
			ClientBillingCountry = C.CL_BCOUNTRY,
			ClientStatementAddress1 = C.CL_SADDRESS1,
			ClientStatementAddress2 = C.CL_SADDRESS2,
			ClientStatementCity = C.CL_SCITY,
			ClientStatementState= C.CL_SSTATE,
			ClientStatementZip = C.CL_SZIP,
			ClientStatementCounty = C.CL_SCOUNTY,
			ClientStatementCountry = C.CL_SCOUNTRY,
			ClientProductionContact = C.CL_ATTENTION,
			ClientMediaContact = C.CL_MATTENTION,
			DivisionBillingAddress1 = D.DIV_BADDRESS1,
			DivisionBillingAddress2 = D.DIV_BADDRESS2,
			DivisionBillingCity = D.DIV_BCITY,
			DivisionBillingState = D.DIV_BSTATE,
			DivisionBillingZip = D.DIV_BZIP,
			DivisionBillingCounty = D.DIV_BCOUNTY,
			DivisionBillingCountry = D.DIV_BCOUNTRY,
			DivisionStatementAddress1 = D.DIV_SADDRESS1,
			DivisionStatementAddress2 = D.DIV_SADDRESS2,
			DivisionStatementCity = D.DIV_SCITY,
			DivisionStatementState = D.DIV_SSTATE,
			DivisionStatementZip = D.DIV_SZIP,
			DivisionStatementCounty = D.DIV_SCOUNTY,
			DivisionStatementCountry = D.DIV_SCOUNTRY,
			DivisionContact = D.DIV_ATTENTION,
			ProductBillingAddress1 = P.PRD_BILL_ADDRESS1,
			ProductBillingAddress2 = P.PRD_BILL_ADDRESS2,
			ProductBillingCity = P.PRD_BILL_CITY,
			ProductBillingState = P.PRD_BILL_STATE,
			ProductBillingZip = P.PRD_BILL_ZIP,
			ProductBillingCounty = P.PRD_BILL_COUNTY,
			ProductBillingCountry = P.PRD_BILL_COUNTRY,
			ProductStatementAddress1 = P.PRD_STATE_ADDR1,
			ProductStatementAddress2 = P.PRD_STATE_ADDR2,
			ProductStatementCity = P.PRD_STATE_CITY,
			ProductStatementState = P.PRD_STATE_STATE,
			ProductStatementZip = P.PRD_STATE_ZIP,
			ProductStatementCounty = P.PRD_STATE_COUNTY,
			ProductStatementCountry = P.PRD_STATE_COUNTRY,
			ProductContact = P.PRD_ATTENTION,
			BankCode = NULL,
			BankDescription = NULL,
			IsCleared = 0
		FROM dbo.AR_SUMMARY ARS
			INNER JOIN dbo.ACCT_REC AR ON ARS.AR_INV_NBR = AR.AR_INV_NBR AND ARS.AR_INV_SEQ = AR.AR_INV_SEQ AND ARS.AR_TYPE = AR.AR_TYPE
			LEFT OUTER JOIN dbo.AR_COLL_NOTES N ON ARS.AR_INV_NBR = N.AR_INV_NBR AND ARS.AR_INV_SEQ = N.AR_INV_SEQ AND ARS.AR_TYPE = N.AR_TYPE 
			LEFT OUTER JOIN dbo.INVOICE_CATEGORY AS IC ON AR.INV_CAT = IC.INV_CAT	
			LEFT OUTER JOIN dbo.OFFICE O ON ARS.OFFICE_CODE = O.OFFICE_CODE
			LEFT OUTER JOIN dbo.CLIENT C ON ARS.CL_CODE = C.CL_CODE
			LEFT OUTER JOIN dbo.DIVISION D ON ARS.CL_CODE = D.CL_CODE AND ARS.DIV_CODE = D.DIV_CODE
			LEFT OUTER JOIN dbo.PRODUCT P ON ARS.CL_CODE = P.CL_CODE AND ARS.DIV_CODE = P.DIV_CODE AND ARS.PRD_CODE = P.PRD_CODE
			LEFT OUTER JOIN dbo.SALES_CLASS SC ON ARS.SC_CODE = SC.SC_CODE AND ((ARS.JOB_NUMBER IS NOT NULL AND SC.SC_TYPE = 'P') OR (ARS.JOB_NUMBER IS NULL AND SC.SC_TYPE = ARS.MEDIA_TYPE))
			LEFT OUTER JOIN dbo.CAMPAIGN CMP ON ARS.CMP_IDENTIFIER = CMP.CMP_IDENTIFIER
			LEFT OUTER JOIN dbo.ACCOUNT_EXECUTIVE AE ON AE.CL_CODE = P.CL_CODE AND AE.DIV_CODE = P.DIV_CODE AND AE.PRD_CODE = P.PRD_CODE 
														AND (AE.INACTIVE_FLAG = 0 OR AE.INACTIVE_FLAG IS NULL) AND AE.DEFAULT_AE = 1
			LEFT OUTER JOIN dbo.JOB_LOG JL ON ARS.JOB_NUMBER = JL.JOB_NUMBER
			LEFT OUTER JOIN dbo.JOB_COMPONENT JC ON ARS.JOB_NUMBER = JC.JOB_NUMBER AND ARS.JOB_COMPONENT_NBR = JC.JOB_COMPONENT_NBR 
			--LEFT OUTER JOIN dbo.JOB_LOG JL ON dbo.advfn_ar_min_job(ARS.AR_INV_NBR) = JL.JOB_NUMBER
			--LEFT OUTER JOIN dbo.JOB_COMPONENT JC ON dbo.advfn_ar_min_job(ARS.AR_INV_NBR) = JC.JOB_NUMBER AND dbo.advfn_ar_min_job_comp(ARS.AR_INV_NBR) = JC.JOB_COMPONENT_NBR 
			LEFT OUTER JOIN dbo.JOB_TYPE JT ON JC.JT_CODE = JT.JT_CODE
			LEFT OUTER JOIN dbo.V_MEDIA_HDR VMH ON ARS.ORDER_NBR = VMH.ORDER_NBR 
			--LEFT OUTER JOIN dbo.V_MEDIA_HDR VMH ON dbo.advfn_ar_min_order(ARS.AR_INV_NBR) = VMH.ORDER_NBR 
			LEFT OUTER JOIN dbo.VENDOR V ON VMH.VN_CODE = V.VN_CODE
			--LEFT OUTER JOIN dbo.V_ARINV_JOB_LIST AS jll ON ARS.AR_INV_NBR = jll.AR_INV_NBR	
			--LEFT OUTER JOIN dbo.V_ARINV_MEDIA_ORDER_LIST AS oll ON ARS.AR_INV_NBR = oll.AR_INV_NBR
			LEFT OUTER JOIN dbo.EMPLOYEE_CLOAK AS EMP ON EMP.EMP_CODE = JC.EMP_CODE
		WHERE
			ARS.AR_INV_SEQ <> 99
		AND	AR.AR_POST_PERIOD between @PostPeriodStart AND @PostPeriodEnd
	) InvoiceLevel
	GROUP BY 
		[OfficeCode],
		[OfficeName],
		[ClientCode],
		[ClientName],
		[ClientARComment],
		[DivisionCode],
		[DivisionName],
		[ProductCode],
		[ProductDescription],
		[ProductUDF1],
		[ProductUDF2],
		[ProductUDF3],
		[ProductUDF4],
		[ARInvoiceNumber],
		[ARInvoiceSequence],
		[ARInvoiceType],
		[ARInvoiceDate],
		[ARInvoiceDueDate],
		[ARCoopCode],
		[ARCoopPercentage],
		[ARManualInvoiceFlag],
		[ARInvoiceCategory],
		[ARDescription],
		[ARCollectionNotes],
		[ARType],
		[MediaType],
		[TransactionType],
		[PostingPeriod],
		[SalesPostingPeriod],
		[CampaignCode],
		[CampaignName],
		[ClientPO],
		[AccountExecutiveCode],
		[AccountExecutiveName],
		[JobNumber],
		[JobDescription],
		[ClientReference],
		[JobComponentNumber],
		[JobComponentDescription],
		[JobTypeDescription],
		[JobAccountExecutiveCode],
		[JobAccountExecutiveName],
		[OrderNumber],
		[OrderDescription],
		[VendorCode],
		[VendorName],
		[MediaMarket],
		[MediaDates],
		[ABIncomeRecognition],
		ClientBillingAddress1,
		ClientBillingAddress2,
		ClientBillingCity,
		ClientBillingState,
		ClientBillingZip,
		ClientBillingCounty,
		ClientBillingCountry,
		ClientStatementAddress1,
		ClientStatementAddress2,
		ClientStatementCity,
		ClientStatementState,
		ClientStatementZip,
		ClientStatementCounty,
		ClientStatementCountry,
		ClientProductionContact,
		ClientMediaContact,
		DivisionBillingAddress1,
		DivisionBillingAddress2,
		DivisionBillingCity,
		DivisionBillingState,
		DivisionBillingZip,
		DivisionBillingCounty,
		DivisionBillingCountry,
		DivisionStatementAddress1,
		DivisionStatementAddress2,
		DivisionStatementCity,
		DivisionStatementState,
		DivisionStatementZip,
		DivisionStatementCounty,
		DivisionStatementCountry,
		DivisionContact,
		ProductBillingAddress1,
		ProductBillingAddress2,
		ProductBillingCity,
		ProductBillingState,
		ProductBillingZip,
		ProductBillingCounty,
		ProductBillingCountry,
		ProductStatementAddress1,
		ProductStatementAddress2,
		ProductStatementCity,
		ProductStatementState,
		ProductStatementZip,
		ProductStatementCounty,
		ProductStatementCountry,
		ProductContact,
		BankCode,
		BankDescription,
		IsCleared

	
	--Payments
	INSERT INTO #RPT_DATA (ARInvoiceNumber,ARInvoiceSequence,ARInvoiceType,[TransactionType],[PostingPeriod],[CheckNumber],[CheckDate],[CheckDepositDate],[CheckAmount],[CheckAdjustmentAmount],[BalanceAmount],CashReceiptPaymentType,BankCode,BankDescription,IsCleared,
				OfficeCode,	[OfficeName],[ClientCode],[ClientName],[DivisionCode],[DivisionName],[ProductCode],[ProductDescription],[ProductUDF1],[ProductUDF2],[ProductUDF3],[ProductUDF4],
				ClientBillingAddress1,
				ClientBillingAddress2,
				ClientBillingCity,
				ClientBillingState,
				ClientBillingZip,
				ClientBillingCounty,
				ClientBillingCountry,
				ClientStatementAddress1,
				ClientStatementAddress2,
				ClientStatementCity,
				ClientStatementState,
				ClientStatementZip,
				ClientStatementCounty,
				ClientStatementCountry,
				ClientProductionContact,
				ClientMediaContact,
				DivisionBillingAddress1,
				DivisionBillingAddress2,
				DivisionBillingCity,
				DivisionBillingState,
				DivisionBillingZip,
				DivisionBillingCounty,
				DivisionBillingCountry,
				DivisionStatementAddress1,
				DivisionStatementAddress2,
				DivisionStatementCity,
				DivisionStatementState,
				DivisionStatementZip,
				DivisionStatementCounty,
				DivisionStatementCountry,
				DivisionContact,
				ProductBillingAddress1,
				ProductBillingAddress2,
				ProductBillingCity,
				ProductBillingState,
				ProductBillingZip,
				ProductBillingCounty,
				ProductBillingCountry,
				ProductStatementAddress1,
				ProductStatementAddress2,
				ProductStatementCity,
				ProductStatementState,
				ProductStatementZip,
				ProductStatementCounty,
				ProductStatementCountry,
				ProductContact)
	SELECT
			ARInvoiceNumber = CCD.AR_INV_NBR,
			ARInvoiceSequence = CCD.AR_INV_SEQ,
			ARInvoiceType = CCD.AR_TYPE,
			[TransactionType] = 'PAYMENT',
			[PostingPeriod] = CCD.POST_PERIOD,
			[CheckNumber] = CC.CR_CHECK_NBR,
			[CheckDate] = CC.CR_CHECK_DATE,
			[CheckDepositDate] = CC.CR_DEP_DATE,
			[CheckAmount] = SUM(COALESCE(CCD.CR_PAY_AMT,0)),
			[CheckAdjustmentAmount] = SUM(COALESCE(CCD.CR_ADJ_AMT,0)),
			[BalanceAmount] = -(SUM(COALESCE(CCD.CR_PAY_AMT,0)) + SUM(COALESCE(CCD.CR_ADJ_AMT,0))),
			CashReceiptPaymentType = CRPT.[DESCRIPTION],
			BankCode = CC.BK_CODE,
			BankDescription = B.BK_DESCRIPTION,
			IsCleared = CAST(COALESCE(CC.CLEARED, 0) AS BIT),
			OfficeCode = CC.OFFICE_CODE,
			[OfficeName] = O.OFFICE_NAME,
			[ClientCode] = CC.CL_CODE,
			[ClientName] = C.CL_NAME,
			[DivisionCode] = CCD.DIV_CODE,
			[DivisionName] = D.DIV_NAME,
			[ProductCode] = CCD.PRD_CODE,
			[ProductDescription] =P.PRD_DESCRIPTION,
			[ProductUDF1] = P.USER_DEFINED1,
			[ProductUDF2] = P.USER_DEFINED2,
			[ProductUDF3] = P.USER_DEFINED3,
			[ProductUDF4] = P.USER_DEFINED4,
			ClientBillingAddress1 = C.CL_BADDRESS1,
			ClientBillingAddress2 = C.CL_BADDRESS2,
			ClientBillingCity = C.CL_BCITY,
			ClientBillingState = C.CL_BSTATE,
			ClientBillingZip = C.CL_BZIP,
			ClientBillingCounty = C.CL_BCOUNTY,
			ClientBillingCountry = C.CL_BCOUNTRY,
			ClientStatementAddress1 = C.CL_SADDRESS1,
			ClientStatementAddress2 = C.CL_SADDRESS2,
			ClientStatementCity = C.CL_SCITY,
			ClientStatementState= C.CL_SSTATE,
			ClientStatementZip = C.CL_SZIP,
			ClientStatementCounty = C.CL_SCOUNTY,
			ClientStatementCountry = C.CL_SCOUNTRY,
			ClientProductionContact = C.CL_ATTENTION,
			ClientMediaContact = C.CL_MATTENTION,
			DivisionBillingAddress1 = D.DIV_BADDRESS1,
			DivisionBillingAddress2 = D.DIV_BADDRESS2,
			DivisionBillingCity = D.DIV_BCITY,
			DivisionBillingState = D.DIV_BSTATE,
			DivisionBillingZip = D.DIV_BZIP,
			DivisionBillingCounty = D.DIV_BCOUNTY,
			DivisionBillingCountry = D.DIV_BCOUNTRY,
			DivisionStatementAddress1 = D.DIV_SADDRESS1,
			DivisionStatementAddress2 = D.DIV_SADDRESS2,
			DivisionStatementCity = D.DIV_SCITY,
			DivisionStatementState = D.DIV_SSTATE,
			DivisionStatementZip = D.DIV_SZIP,
			DivisionStatementCounty = D.DIV_SCOUNTY,
			DivisionStatementCountry = D.DIV_SCOUNTRY,
			DivisionContact = D.DIV_ATTENTION,
			ProductBillingAddress1 = P.PRD_BILL_ADDRESS1,
			ProductBillingAddress2 = P.PRD_BILL_ADDRESS2,
			ProductBillingCity = P.PRD_BILL_CITY,
			ProductBillingState = P.PRD_BILL_STATE,
			ProductBillingZip = P.PRD_BILL_ZIP,
			ProductBillingCounty = P.PRD_BILL_COUNTY,
			ProductBillingCountry = P.PRD_BILL_COUNTRY,
			ProductStatementAddress1 = P.PRD_STATE_ADDR1,
			ProductStatementAddress2 = P.PRD_STATE_ADDR2,
			ProductStatementCity = P.PRD_STATE_CITY,
			ProductStatementState = P.PRD_STATE_STATE,
			ProductStatementZip = P.PRD_STATE_ZIP,
			ProductStatementCounty = P.PRD_STATE_COUNTY,
			ProductStatementCountry = P.PRD_STATE_COUNTRY,
			ProductContact = P.PRD_ATTENTION
		
		FROM dbo.CR_CLIENT_DTL CCD
			INNER JOIN dbo.CR_CLIENT CC ON CCD.REC_ID = CC.REC_ID AND CCD.SEQ_NBR = CC.SEQ_NBR 
			LEFT OUTER JOIN dbo.CR_PAYMENT_TYPE CRPT ON CC.CR_PAYMENT_TYPE_ID = CRPT.CR_PAYMENT_TYPE_ID
			LEFT OUTER JOIN dbo.BANK B ON CC.BK_CODE = B.BK_CODE
			INNER JOIN dbo.CLIENT C ON CC.CL_CODE = C.CL_CODE
			LEFT OUTER JOIN dbo.DIVISION D ON CC.CL_CODE = D.CL_CODE AND CCD.DIV_CODE = D.DIV_CODE
			LEFT OUTER JOIN dbo.PRODUCT P ON CC.CL_CODE = P.CL_CODE AND CCD.DIV_CODE = P.DIV_CODE AND CCD.PRD_CODE = P.PRD_CODE
			LEFT OUTER JOIN dbo.OFFICE O ON CC.OFFICE_CODE = O.OFFICE_CODE
		WHERE
			CCD.POST_PERIOD between @PostPeriodStart AND @PostPeriodEnd
		AND (CC.[STATUS] IS NULL OR CC.[STATUS] <> 'D')
		GROUP BY
			CCD.AR_INV_NBR,
			CCD.AR_INV_SEQ,
			CCD.AR_TYPE,
			CCD.POST_PERIOD,
			CC.CR_CHECK_NBR,
			CC.CR_CHECK_DATE,
			CC.CR_DEP_DATE,
			CRPT.[DESCRIPTION],
			CC.BK_CODE,
			B.BK_DESCRIPTION,
			CAST(COALESCE(CC.CLEARED, 0) AS BIT),
			 CC.OFFICE_CODE,
			O.OFFICE_NAME,
			CC.CL_CODE,
			C.CL_NAME,
			CCD.DIV_CODE,
			D.DIV_NAME,
			CCD.PRD_CODE,
			P.PRD_DESCRIPTION,
		    P.USER_DEFINED1,
			P.USER_DEFINED2,
			P.USER_DEFINED3,
			P.USER_DEFINED4,
			C.CL_BADDRESS1,
			C.CL_BADDRESS2,
			C.CL_BCITY,
			C.CL_BSTATE,
			C.CL_BZIP,
			C.CL_BCOUNTY,
			C.CL_BCOUNTRY,
			C.CL_SADDRESS1,
			C.CL_SADDRESS2,
			C.CL_SCITY,
			C.CL_SSTATE,
			C.CL_SZIP,
			C.CL_SCOUNTY,
			C.CL_SCOUNTRY,
			C.CL_ATTENTION,
			C.CL_MATTENTION,
			D.DIV_BADDRESS1,
			D.DIV_BADDRESS2,
			D.DIV_BCITY,
			D.DIV_BSTATE,
			D.DIV_BZIP,
			D.DIV_BCOUNTY,
			D.DIV_BCOUNTRY,
			D.DIV_SADDRESS1,
			D.DIV_SADDRESS2,
			D.DIV_SCITY,
			D.DIV_SSTATE,
			D.DIV_SZIP,
			D.DIV_SCOUNTY,
			D.DIV_SCOUNTRY,
			D.DIV_ATTENTION,
			P.PRD_BILL_ADDRESS1,
			P.PRD_BILL_ADDRESS2,
			P.PRD_BILL_CITY,
			P.PRD_BILL_STATE,
			P.PRD_BILL_ZIP,
			P.PRD_BILL_COUNTY,
			P.PRD_BILL_COUNTRY,
			P.PRD_STATE_ADDR1,
			P.PRD_STATE_ADDR2,
			P.PRD_STATE_CITY,
			P.PRD_STATE_STATE,
			P.PRD_STATE_ZIP,
			P.PRD_STATE_COUNTY,
			P.PRD_STATE_COUNTRY,
			P.PRD_ATTENTION	

    

   UPDATE #RPT_DATA
   SET [ARInvoiceDate] = (SELECT AR_INV_DATE FROM ACCT_REC AR WHERE #RPT_DATA.ARInvoiceNumber = AR.AR_INV_NBR AND #RPT_DATA.ARInvoiceSequence = AR.AR_INV_SEQ AND #RPT_DATA.ARInvoiceType = AR.AR_TYPE),
		[ARInvoiceDueDate] = (SELECT CASE
									WHEN AR.DUE_DATE IS NOT NULL THEN AR.DUE_DATE
									WHEN AR.DUE_DATE IS NULL AND AR.REC_TYPE IN ( 'P','S' ) THEN DATEADD( Day,ISNULL( C.CL_P_PAYDAYS, 0 ), AR.AR_INV_DATE )
									ELSE DATEADD( Day, ISNULL( C.CL_M_PAYDAYS, 0 ), AR.AR_INV_DATE )
								 END FROM ACCT_REC AR LEFT OUTER JOIN dbo.CLIENT C ON AR.CL_CODE = C.CL_CODE
							 WHERE #RPT_DATA.ARInvoiceNumber = AR.AR_INV_NBR AND #RPT_DATA.ARInvoiceSequence = AR.AR_INV_SEQ AND #RPT_DATA.ARInvoiceType = AR.AR_TYPE),
		--[ARCoopCode] = (SELECT TOP 1 RD.COOP_CODE FROM AR_SUMMARY RD WHERE #RPT_DATA.ARInvoiceNumber = RD.AR_INV_NBR AND #RPT_DATA.ARInvoiceSequence = RD.AR_INV_SEQ AND #RPT_DATA.ARInvoiceType = RD.AR_TYPE ),
		--[ARCoopPercentage] = (SELECT TOP 1 RD.COOP_PCT FROM AR_SUMMARY RD WHERE #RPT_DATA.ARInvoiceNumber = RD.AR_INV_NBR AND #RPT_DATA.ARInvoiceSequence = RD.AR_INV_SEQ AND #RPT_DATA.ARInvoiceType = RD.AR_TYPE ),
		--[ARManualInvoiceFlag] = (SELECT MANUAL_INV FROM ACCT_REC RD WHERE #RPT_DATA.ARInvoiceNumber = RD.AR_INV_NBR AND #RPT_DATA.ARInvoiceSequence = RD.AR_INV_SEQ AND #RPT_DATA.ARInvoiceType = RD.AR_TYPE ),
		--[ARInvoiceCategory] = (SELECT IC.INV_CAT_DESC FROM ACCT_REC RD LEFT OUTER JOIN dbo.INVOICE_CATEGORY AS IC ON RD.INV_CAT = IC.INV_CAT WHERE #RPT_DATA.ARInvoiceNumber = RD.AR_INV_NBR AND #RPT_DATA.ARInvoiceSequence = RD.AR_INV_SEQ AND #RPT_DATA.ARInvoiceType = RD.AR_TYPE ),
	 --   [ARDescription] = (SELECT AR_DESCRIPTION FROM ACCT_REC RD WHERE #RPT_DATA.ARInvoiceNumber = RD.AR_INV_NBR AND #RPT_DATA.ARInvoiceSequence = RD.AR_INV_SEQ AND #RPT_DATA.ARInvoiceType = RD.AR_TYPE ),
		[ARCollectionNotes] = (SELECT CAST(N.COLLECT_NOTES AS VARCHAR(MAX)) FROM ACCT_REC RD LEFT OUTER JOIN dbo.AR_COLL_NOTES N ON RD.AR_INV_NBR = N.AR_INV_NBR AND RD.AR_INV_SEQ = N.AR_INV_SEQ AND RD.AR_TYPE = N.AR_TYPE WHERE #RPT_DATA.ARInvoiceNumber = RD.AR_INV_NBR AND #RPT_DATA.ARInvoiceSequence = RD.AR_INV_SEQ AND #RPT_DATA.ARInvoiceType = RD.AR_TYPE ),
		--[ARType] = (SELECT DISTINCT CASE
		--					WHEN RD.JOB_NUMBER IS NOT NULL THEN 'Production'
		--					WHEN RD.MEDIA_TYPE IN ('R','T') THEN 'Broadcast Media'
		--					WHEN RD.MEDIA_TYPE IN ('I','M','N','O') THEN 'Print Media'
		--			   END FROM AR_SUMMARY RD WHERE #RPT_DATA.ARInvoiceNumber = RD.AR_INV_NBR AND #RPT_DATA.ARInvoiceSequence = RD.AR_INV_SEQ AND #RPT_DATA.ARInvoiceType = RD.AR_TYPE ),
		--[CampaignCode] = (SELECT TOP 1 CMP.CMP_CODE FROM AR_SUMMARY RD LEFT OUTER JOIN dbo.CAMPAIGN CMP ON RD.CMP_IDENTIFIER = CMP.CMP_IDENTIFIER WHERE #RPT_DATA.ARInvoiceNumber = RD.AR_INV_NBR AND #RPT_DATA.ARInvoiceSequence = RD.AR_INV_SEQ AND #RPT_DATA.ARInvoiceType = RD.AR_TYPE ),
		--[CampaignName] = (SELECT TOP 1 CMP.CMP_NAME FROM AR_SUMMARY RD LEFT OUTER JOIN dbo.CAMPAIGN CMP ON RD.CMP_IDENTIFIER = CMP.CMP_IDENTIFIER WHERE #RPT_DATA.ARInvoiceNumber = RD.AR_INV_NBR AND #RPT_DATA.ARInvoiceSequence = RD.AR_INV_SEQ AND #RPT_DATA.ARInvoiceType = RD.AR_TYPE ),		
		--[AccountExecutiveCode] = (SELECT AE.EMP_CODE FROM ACCT_REC RD LEFT OUTER JOIN dbo.ACCOUNT_EXECUTIVE AE ON AE.CL_CODE = RD.CL_CODE AND AE.DIV_CODE = RD.DIV_CODE AND AE.PRD_CODE = RD.PRD_CODE 
		--												AND (AE.INACTIVE_FLAG = 0 OR AE.INACTIVE_FLAG IS NULL) AND AE.DEFAULT_AE = 1 
		--												WHERE #RPT_DATA.ARInvoiceNumber = RD.AR_INV_NBR AND #RPT_DATA.ARInvoiceSequence = RD.AR_INV_SEQ AND #RPT_DATA.ARInvoiceType = RD.AR_TYPE AND #RPT_DATA.[AccountExecutiveCode] IS NULL),
		--[AccountExecutiveName] = (SELECT dbo.udf_get_empl_name(AE.EMP_CODE, 'FML') FROM ACCT_REC RD LEFT OUTER JOIN dbo.ACCOUNT_EXECUTIVE AE ON AE.CL_CODE = RD.CL_CODE AND AE.DIV_CODE = RD.DIV_CODE AND AE.PRD_CODE = RD.PRD_CODE 
		--												AND (AE.INACTIVE_FLAG = 0 OR AE.INACTIVE_FLAG IS NULL) AND AE.DEFAULT_AE = 1
		--												WHERE #RPT_DATA.ARInvoiceNumber = RD.AR_INV_NBR AND #RPT_DATA.ARInvoiceSequence = RD.AR_INV_SEQ AND #RPT_DATA.ARInvoiceType = RD.AR_TYPE ),
		[ARHoursQuantity] = 0,
		[AREmployeeTimeAmount] = 0,
		[ARIncomeOnlyAmount] = 0,
		[ARCommissionAmount] = 0,
		[ARRebateAmount] = 0,
		[ARAdditionalCharges] = 0,
		[ARCostAmount] = 0,
		[ARAdvanceCostAmount] = 0,
		[ARAdvanceIncomeAmount] = 0,
		[ARAdvanceCommissionAmount] = 0,
		[ARAdvanceRetained] = 0,
		[ARCityTaxAmount] = 0,
		[ARCountyTaxAmount] = 0,
		[ARStateTaxAmount] = 0,
		[ARInvoiceAmount] = 0--,		
		--[Paid] = CASE WHEN (SELECT SUM(BalanceAmount) FROM #RPT_DATA R WHERE #RPT_DATA.ARInvoiceNumber = R.ARInvoiceNumber AND #RPT_DATA.ARInvoiceSequence = R.ARInvoiceSequence AND #RPT_DATA.ARInvoiceType = R.ARInvoiceType) <= 0 THEN 'Y' ELSE 'N' END
		
  
   --FROM #RPT_DATA R 
   WHERE #RPT_DATA.TransactionType = 'PAYMENT'     

   --UPDATE #RPT_DATA
   --SET [MediaType] = (SELECT DISTINCT SC_DESCRIPTION FROM AR_SUMMARY ARS LEFT OUTER JOIN dbo.SALES_CLASS SC ON ARS.SC_CODE = SC.SC_CODE AND ((ARS.JOB_NUMBER IS NOT NULL AND SC.SC_TYPE = 'P') OR (ARS.JOB_NUMBER IS NULL AND SC.SC_TYPE = ARS.MEDIA_TYPE))
			--			 WHERE #RPT_DATA.ARInvoiceNumber = ARS.AR_INV_NBR AND #RPT_DATA.ARInvoiceSequence = ARS.AR_INV_SEQ AND #RPT_DATA.ARInvoiceType = ARS.AR_TYPE )      
   --WHERE #RPT_DATA.TransactionType = 'PAYMENT' AND #RPT_DATA.MediaType IS NULL       

   --UPDATE #RPT_DATA
   --SET [MediaType] = (SELECT SC_DESCRIPTION FROM ACCT_REC ARS LEFT OUTER JOIN dbo.SALES_CLASS SC ON ARS.SC_CODE = SC.SC_CODE AND SC.SC_TYPE = 'P'
			--			 WHERE #RPT_DATA.ARInvoiceNumber = ARS.AR_INV_NBR AND #RPT_DATA.ARInvoiceSequence = ARS.AR_INV_SEQ AND #RPT_DATA.ARInvoiceType = ARS.AR_TYPE AND ARS.MANUAL_INV = 1)      
   --WHERE #RPT_DATA.TransactionType = 'PAYMENT'  AND #RPT_DATA.MediaType IS NULL

   --UPDATE #RPT_DATA
   --SET [SalesPostingPeriod] = (SELECT DISTINCT SALE_POST_PERIOD FROM AR_SUMMARY ARS WHERE #RPT_DATA.ARInvoiceNumber = ARS.AR_INV_NBR AND #RPT_DATA.ARInvoiceSequence = ARS.AR_INV_SEQ AND #RPT_DATA.ARInvoiceType = ARS.AR_TYPE)      
   --WHERE #RPT_DATA.TransactionType = 'PAYMENT' AND #RPT_DATA.SalesPostingPeriod IS NULL       

   --UPDATE #RPT_DATA
   --SET [SalesPostingPeriod] = (SELECT AR_POST_PERIOD FROM ACCT_REC ARS 
			--			 WHERE #RPT_DATA.ARInvoiceNumber = ARS.AR_INV_NBR AND #RPT_DATA.ARInvoiceSequence = ARS.AR_INV_SEQ AND #RPT_DATA.ARInvoiceType = ARS.AR_TYPE AND ARS.MANUAL_INV = 1)      
   --WHERE #RPT_DATA.TransactionType = 'PAYMENT'  AND #RPT_DATA.SalesPostingPeriod IS NULL         

   UPDATE #RPT_DATA
   SET [DaysToPay] = CASE
						WHEN @AgingOption = 1 THEN DATEDIFF(d, #RPT_DATA.ARInvoiceDate, #RPT_DATA.[CheckDate]) 
						WHEN @AgingOption = 2 THEN DATEDIFF(d, #RPT_DATA.ARInvoiceDueDate, #RPT_DATA.[CheckDate])
						ELSE 0
					  END   

   UPDATE R
   SET [Paid] = CASE WHEN (SELECT SUM(BalanceAmount) FROM #RPT_DATA WHERE #RPT_DATA.ARInvoiceNumber = RD.ARInvoiceNumber AND #RPT_DATA.ARInvoiceSequence = RD.ARInvoiceSequence AND #RPT_DATA.ARInvoiceType = RD.ARInvoiceType) = 0 THEN 'Y' ELSE 'N' END   
   FROM #RPT_DATA R INNER JOIN #RPT_DATA RD ON R.ARInvoiceNumber = RD.ARInvoiceNumber AND R.ARInvoiceSequence = RD.ARInvoiceSequence AND R.ARInvoiceType = RD.ARInvoiceType

   --UPDATE #RPT_DATA
   --SET [ARInvoiceAmount] = (SELECT SUM(ARS.TOTAL_BILL) FROM AR_SUMMARY ARS WHERE #RPT_DATA.ARInvoiceNumber = ARS.AR_INV_NBR AND #RPT_DATA.ARInvoiceSequence = ARS.AR_INV_SEQ AND #RPT_DATA.ARInvoiceType = ARS.AR_TYPE)      
   --WHERE #RPT_DATA.TransactionType = 'PAYMENT'   

   --UPDATE #RPT_DATA
   --SET [ARInvoiceAmount] = (SELECT SUM(ARS.AR_INV_AMOUNT) FROM ACCT_REC ARS WHERE #RPT_DATA.ARInvoiceNumber = ARS.AR_INV_NBR AND #RPT_DATA.ARInvoiceSequence = ARS.AR_INV_SEQ AND #RPT_DATA.ARInvoiceType = ARS.AR_TYPE AND ARS.MANUAL_INV = 1)      
   --WHERE #RPT_DATA.TransactionType = 'PAYMENT'

   UPDATE #RPT_DATA
   SET ARManualInvoiceFlag = 0 
   WHERE ARManualInvoiceFlag IS NULL

  --SELECT * FROM #RPT_DATA WHERE ARInvoiceNumber = 1654
   

	SELECT [ID] = NewID(), * FROM #RPT_DATA

	--UNION

	--SELECT
	--	[ID] = NewID(),
	--	R.[OfficeCode],
	--	R.[OfficeName],
	--	R.[ClientCode],
	--	R.[ClientName],
	--	R.[ClientARComment],
	--	R.[DivisionCode],
	--	R.[DivisionName],
	--	R.[ProductCode],
	--	R.[ProductDescription],
	--	R.[ProductUDF1],
	--	R.[ProductUDF2],
	--	R.[ProductUDF3],
	--	R.[ProductUDF4],
	--	Payments.[ARInvoiceNumber],
	--	Payments.[ARInvoiceSequence],
	--	Payments.[ARInvoiceType],
	--	R.[ARInvoiceDate],
	--	R.[ARInvoiceDueDate],
	--	R.[ARCoopCode],
	--	R.[ARCoopPercentage],
	--	R.[ARManualInvoiceFlag],
	--	R.[ARInvoiceCategory],
	--	R.[ARDescription],
	--	R.[ARCollectionNotes],
	--	R.[ARType],
	--	R.[MediaType],
	--	Payments.[TransactionType],
	--	Payments.[PostingPeriod],
	--	[SalesPostingPeriod],
	--	[CampaignCode],
	--	[CampaignName],
	--	[ClientPO],
	--	[AccountExecutiveCode],
	--	[AccountExecutiveName],
	--	[JobNumber] = NULL,
	--	[JobDescription] = NULL,
	--	[ClientReference] = NULL,
	--	[JobComponentNumber] = NULL,
	--	[JobComponentDescription] = NULL,
	--	[JobTypeDescription] = NULL,
	--	[OrderNumber] = NULL,
	--	[OrderDescription] = NULL,
	--	[VendorCode] = NULL,
	--	[VendorName] = NULL,
	--	[MediaMarket] = NULL,
	--	[MediaDates] = NULL,
	--	[ABIncomeRecognition],

	--	[ARHoursQuantity] = 0,
	--	[AREmployeeTimeAmount] = 0,
	--	[ARIncomeOnlyAmount] = 0,
	--	[ARCommissionAmount] = 0,
	--	[ARRebateAmount] = 0,
	--	[ARAdditionalCharges] = 0,
	--	[ARCostAmount] = 0,
	--	[ARAdvanceCostAmount] = 0,
	--	[ARAdvanceIncomeAmount] = 0,
	--	[ARAdvanceCommissionAmount] = 0,
	--	[ARAdvanceRetained] = 0,
	--	[ARCityTaxAmount] = 0,
	--	[ARCountyTaxAmount] = 0,
	--	[ARStateTaxAmount] = 0,
	--	[ARInvoiceAmount] = 0,
	--	Payments.[CheckNumber],
	--	Payments.[CheckDate],
	--	Payments.[CheckDepositDate],
	--	Payments.[CheckAmount],
	--	Payments.[CheckAdjustmentAmount],
	--	[BalanceAmount] = -(Payments.[CheckAmount] + Payments.[CheckAdjustmentAmount]),
	--	[DaysToPay] = CASE
	--					WHEN @AgingOption = 1 THEN DATEDIFF(d, R.ARInvoiceDate, Payments.[CheckDate])
	--					WHEN @AgingOption = 2 THEN DATEDIFF(d, R.ARInvoiceDueDate, Payments.[CheckDate])
	--				  END,
	--	CashReceiptPaymentType = Payments.CashReceiptPaymentType,
	--	ClientBillingAddress1,
	--	ClientBillingAddress2,
	--	ClientBillingCity,
	--	ClientBillingState,
	--	ClientBillingZip,
	--	ClientBillingCounty,
	--	ClientBillingCountry,
	--	ClientStatementAddress1,
	--	ClientStatementAddress2,
	--	ClientStatementCity,
	--	ClientStatementState,
	--	ClientStatementZip,
	--	ClientStatementCounty,
	--	ClientStatementCountry,
	--	ClientProductionContact,
	--	ClientMediaContact,
	--	DivisionBillingAddress1,
	--	DivisionBillingAddress2,
	--	DivisionBillingCity,
	--	DivisionBillingState,
	--	DivisionBillingZip,
	--	DivisionBillingCounty,
	--	DivisionBillingCountry,
	--	DivisionStatementAddress1,
	--	DivisionStatementAddress2,
	--	DivisionStatementCity,
	--	DivisionStatementState,
	--	DivisionStatementZip,
	--	DivisionStatementCounty,
	--	DivisionStatementCountry,
	--	DivisionContact,
	--	ProductBillingAddress1,
	--	ProductBillingAddress2,
	--	ProductBillingCity,
	--	ProductBillingState,
	--	ProductBillingZip,
	--	ProductBillingCounty,
	--	ProductBillingCountry,
	--	ProductStatementAddress1,
	--	ProductStatementAddress2,
	--	ProductStatementCity,
	--	ProductStatementState,
	--	ProductStatementZip,
	--	ProductStatementCounty,
	--	ProductStatementCountry,
	--	ProductContact,
	--	Payments.BankCode,
	--	Payments.BankDescription,
	--	Payments.IsCleared
	--FROM
	--	(
	--	SELECT
	--		ARInvoiceNumber = CCD.AR_INV_NBR,
	--		ARInvoiceSequence = CCD.AR_INV_SEQ,
	--		ARInvoiceType = CCD.AR_TYPE,
	--		[TransactionType] = 'PAYMENT',
	--		[PostingPeriod] = CCD.POST_PERIOD,
	--		[CheckNumber] = CC.CR_CHECK_NBR,
	--		[CheckDate] = CC.CR_CHECK_DATE,
	--		[CheckDepositDate] = CC.CR_DEP_DATE,
	--		[CheckAmount] = SUM(COALESCE(CCD.CR_PAY_AMT,0)),
	--		[CheckAdjustmentAmount] = SUM(COALESCE(CCD.CR_ADJ_AMT,0)),
	--		CashReceiptPaymentType = CRPT.[DESCRIPTION],
	--		BankCode = CC.BK_CODE,
	--		BankDescription = B.BK_DESCRIPTION,
	--		IsCleared = CAST(COALESCE(CC.CLEARED, 0) AS BIT)
	--	FROM dbo.CR_CLIENT_DTL CCD
	--		INNER JOIN dbo.CR_CLIENT CC ON CCD.REC_ID = CC.REC_ID AND CCD.SEQ_NBR = CC.SEQ_NBR 
	--		LEFT OUTER JOIN dbo.CR_PAYMENT_TYPE CRPT ON CC.CR_PAYMENT_TYPE_ID = CRPT.CR_PAYMENT_TYPE_ID
	--		LEFT OUTER JOIN dbo.BANK B ON CC.BK_CODE = B.BK_CODE
	--	WHERE
	--		CCD.POST_PERIOD between @PostPeriodStart AND @PostPeriodEnd
	--	AND (CC.[STATUS] IS NULL OR CC.[STATUS] <> 'D')
	--	GROUP BY
	--		CCD.AR_INV_NBR,
	--		CCD.AR_INV_SEQ,
	--		CCD.AR_TYPE,
	--		CCD.POST_PERIOD,
	--		CC.CR_CHECK_NBR,
	--		CC.CR_CHECK_DATE,
	--		CC.CR_DEP_DATE,
	--		CRPT.[DESCRIPTION],
	--		CC.BK_CODE,
	--		B.BK_DESCRIPTION,
	--		CAST(COALESCE(CC.CLEARED, 0) AS BIT)
	--	) Payments
	--		INNER JOIN #RPT_DATA R ON Payments.ARInvoiceNumber = R.ARInvoiceNumber AND Payments.ARInvoiceSequence = R.ARInvoiceSequence AND Payments.ARInvoiceType = R.ARInvoiceType 

	UNION

	SELECT
		[ID] = NewID(),
		[OfficeCode] = Onaccount.OFFICE_CODE,
		[OfficeName] = O.OFFICE_NAME,
		[ClientCode] = Onaccount.CL_CODE,
		[ClientName] = C.CL_NAME,
		[ClientARComment] = CAST(C.CL_AR_COMMENT AS VARCHAR(MAX)),
		[DivisionCode] = Onaccount.DIV_CODE,
		[DivisionName] = D.DIV_NAME,
		[ProductCode] = Onaccount.PRD_CODE,
		[ProductDescription] = P.PRD_DESCRIPTION,
		[ProductUDF1] = P.USER_DEFINED1,
		[ProductUDF2] = P.USER_DEFINED2,
		[ProductUDF3] = P.USER_DEFINED3,
		[ProductUDF4] = P.USER_DEFINED4,
		[ARInvoiceNumber] = NULL,
		[ARInvoiceSequence] = NULL,
		[ARInvoiceType] = NULL,
		[ARInvoiceDate] = NULL,
		[ARInvoiceDueDate] = NULL,
		[ARCoopCode] = NULL,
		[ARCoopPercentage] = NULL,
		[ARManualInvoiceFlag] = CAST(0 AS BIT),
		[ARInvoiceCategory] = NULL,
		[ARDescription] = NULL,
		[ARCollectionNotes] = NULL,
		[ARType] = NULL,
		[MediaType] = NULL,
		Onaccount.[TransactionType],
		Onaccount.[PostingPeriod],
		[SalesPostingPeriod] = NULL,
		[CampaignCode] = Onaccount.CMP_CODE,
		[CampaignName] = CMP.CMP_NAME,
		[ClientPO] = NULL,
		[AccountExecutiveCode] = NULL,
		[AccountExecutiveName] = NULL,
		[JobNumber] = NULL,
		[JobDescription] = NULL,
		[ClientReference] = NULL,
		[JobComponentNumber] = NULL,
		[JobComponentDescription] = NULL,
		[JobTypeDescription] = NULL,
		[JobAccountExecutiveCode] = NULL,
		[JobAccountExecutiveName] = NULL,
		[OrderNumber] = NULL,
		[OrderDescription] = NULL,
		[VendorCode] = NULL,
		[VendorName] = NULL,
		[MediaMarket] = NULL,
		[MediaDates] = NULL,
		[ABIncomeRecognition] = NULL,

		[ARHoursQuantity] = 0,
		[AREmployeeTimeAmount] = 0,
		[ARIncomeOnlyAmount] = 0,
		[ARCommissionAmount] = 0,
		[ARRebateAmount] = 0,
		[ARAdditionalCharges] = 0,
		[ARCostAmount] = 0,
		[ARAdvanceCostAmount] = 0,
		[ARAdvanceIncomeAmount] = 0,
		[ARAdvanceCommissionAmount] = 0,
		[ARAdvanceRetained] = 0,
		[ARCityTaxAmount] = 0,
		[ARCountyTaxAmount] = 0,
		[ARStateTaxAmount] = 0,
		[ARInvoiceAmount] = 0,
		Onaccount.[CheckNumber],
		Onaccount.[CheckDate],
		Onaccount.[CheckDepositDate],
		Onaccount.[CheckAmount],
		Onaccount.[CheckAdjustmentAmount],
		[BalanceAmount] = -Onaccount.[CheckAmount],
		[Paid] = NULL,
		[DaysToPay] = 0,
		CashReceiptPaymentType = Onaccount.CashReceiptPaymentType,
		ClientBillingAddress1 = C.CL_BADDRESS1,
		ClientBillingAddress2 = C.CL_BADDRESS2,
		ClientBillingCity = C.CL_BCITY,
		ClientBillingState = C.CL_BSTATE,
		ClientBillingZip = C.CL_BZIP,
		ClientBillingCounty = C.CL_BCOUNTY,
		ClientBillingCountry = C.CL_BCOUNTRY,
		ClientStatementAddress1 = C.CL_SADDRESS1,
		ClientStatementAddress2 = C.CL_SADDRESS2,
		ClientStatementCity = C.CL_SCITY,
		ClientStatementState= C.CL_SSTATE,
		ClientStatementZip = C.CL_SZIP,
		ClientStatementCounty = C.CL_SCOUNTY,
		ClientStatementCountry = C.CL_SCOUNTRY,
		ClientProductionContact = C.CL_ATTENTION,
		ClientMediaContact = C.CL_MATTENTION,
		DivisionBillingAddress1 = D.DIV_BADDRESS1,
		DivisionBillingAddress2 = D.DIV_BADDRESS2,
		DivisionBillingCity = D.DIV_BCITY,
		DivisionBillingState = D.DIV_BSTATE,
		DivisionBillingZip = D.DIV_BZIP,
		DivisionBillingCounty = D.DIV_BCOUNTY,
		DivisionBillingCountry = D.DIV_BCOUNTRY,
		DivisionStatementAddress1 = D.DIV_SADDRESS1,
		DivisionStatementAddress2 = D.DIV_SADDRESS2,
		DivisionStatementCity = D.DIV_SCITY,
		DivisionStatementState = D.DIV_SSTATE,
		DivisionStatementZip = D.DIV_SZIP,
		DivisionStatementCounty = D.DIV_SCOUNTY,
		DivisionStatementCountry = D.DIV_SCOUNTRY,
		DivisionContact = D.DIV_ATTENTION,
		ProductBillingAddress1 = P.PRD_BILL_ADDRESS1,
		ProductBillingAddress2 = P.PRD_BILL_ADDRESS2,
		ProductBillingCity = P.PRD_BILL_CITY,
		ProductBillingState = P.PRD_BILL_STATE,
		ProductBillingZip = P.PRD_BILL_ZIP,
		ProductBillingCounty = P.PRD_BILL_COUNTY,
		ProductBillingCountry = P.PRD_BILL_COUNTRY,
		ProductStatementAddress1 = P.PRD_STATE_ADDR1,
		ProductStatementAddress2 = P.PRD_STATE_ADDR2,
		ProductStatementCity = P.PRD_STATE_CITY,
		ProductStatementState = P.PRD_STATE_STATE,
		ProductStatementZip = P.PRD_STATE_ZIP,
		ProductStatementCounty = P.PRD_STATE_COUNTY,
		ProductStatementCountry = P.PRD_STATE_COUNTRY,
		ProductContact = P.PRD_ATTENTION,
		Onaccount.BankCode,
		Onaccount.BankDescription,
		Onaccount.IsCleared
	FROM
		(
		SELECT
			[TransactionType] = 'ON-ACCOUNT',
			[PostingPeriod] = COA.POST_PERIOD,
			[CheckNumber] = CC.CR_CHECK_NBR,
			[CheckDate] = CC.CR_CHECK_DATE,
			[CheckDepositDate] = CC.CR_DEP_DATE,
			[CheckAmount] = SUM(COALESCE(COA.CR_OA_AMT, 0)),
			[CheckAdjustmentAmount] = 0,
			[BalanceAmount] = 0,
			COA.OFFICE_CODE,
			CC.CL_CODE,
			COA.DIV_CODE,
			COA.PRD_CODE,
			COA.CMP_CODE,
			CashReceiptPaymentType = CRPT.[DESCRIPTION],
			BankCode = CC.BK_CODE,
			BankDescription = B.BK_DESCRIPTION,
			IsCleared = CAST(COALESCE(CC.CLEARED, 0) AS BIT)
		FROM dbo.CR_ON_ACCT COA
			INNER JOIN dbo.CR_CLIENT CC ON COA.REC_ID = CC.REC_ID AND COA.SEQ_NBR = CC.SEQ_NBR
			LEFT OUTER JOIN dbo.CR_PAYMENT_TYPE CRPT ON CC.CR_PAYMENT_TYPE_ID = CRPT.CR_PAYMENT_TYPE_ID
			LEFT OUTER JOIN dbo.BANK B ON CC.BK_CODE = B.BK_CODE
		WHERE
			COA.POST_PERIOD between @PostPeriodStart AND @PostPeriodEnd
		AND (CC.[STATUS] IS NULL OR CC.[STATUS] <> 'D')
		GROUP BY
			COA.POST_PERIOD,
			CC.CR_CHECK_NBR,
			CC.CR_CHECK_DATE,
			CC.CR_DEP_DATE,
			COA.OFFICE_CODE,
			CC.CL_CODE,
			COA.DIV_CODE,
			COA.PRD_CODE,
			COA.CMP_CODE,
			CRPT.[DESCRIPTION],
			CC.BK_CODE,
			B.BK_DESCRIPTION,
			CAST(COALESCE(CC.CLEARED, 0) AS BIT)
		) Onaccount
			INNER JOIN dbo.CLIENT C ON Onaccount.CL_CODE = C.CL_CODE
			LEFT OUTER JOIN dbo.DIVISION D ON Onaccount.CL_CODE = D.CL_CODE AND Onaccount.DIV_CODE = D.DIV_CODE
			LEFT OUTER JOIN dbo.PRODUCT P ON Onaccount.CL_CODE = P.CL_CODE AND Onaccount.DIV_CODE = P.DIV_CODE AND Onaccount.PRD_CODE = P.PRD_CODE
			LEFT OUTER JOIN dbo.OFFICE O ON Onaccount.OFFICE_CODE = O.OFFICE_CODE
			LEFT OUTER JOIN dbo.CAMPAIGN CMP ON Onaccount.CL_CODE = CMP.CL_CODE AND Onaccount.DIV_CODE = CMP.DIV_CODE AND Onaccount.PRD_CODE = CMP.PRD_CODE AND Onaccount.CMP_CODE = CMP.CMP_CODE
	WHERE @IncludeOnAccount = 1
	ORDER BY [ARInvoiceNumber]
	
END
GO
