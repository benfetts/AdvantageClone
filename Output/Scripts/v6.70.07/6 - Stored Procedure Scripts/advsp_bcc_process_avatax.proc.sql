CREATE PROC advsp_bcc_process_avatax @BillingUser varchar(100), @Post bit, @ARInvNumberList varchar(max)

AS

DECLARE @USE_CLIENT_STREET_ADDRESS bit,
		@USE_JOB_SALES_CLASS bit,
		@USE_JOB_CONTACT_ADDRESS bit

SELECT @USE_CLIENT_STREET_ADDRESS = CAST(COALESCE(AGY_SETTINGS_VALUE, 0) AS bit) FROM dbo.AGY_SETTINGS 
WHERE AGY_SETTINGS_CODE = 'AVATAX_USE_CL_ADDR'

SELECT @USE_JOB_CONTACT_ADDRESS = CAST(COALESCE(AGY_SETTINGS_VALUE, 0) AS bit) FROM dbo.AGY_SETTINGS 
WHERE AGY_SETTINGS_CODE = 'AVATAX_USE_JC_ADDR'

SELECT @USE_JOB_SALES_CLASS = CAST(COALESCE(AGY_SETTINGS_VALUE, 0) AS bit) FROM dbo.AGY_SETTINGS 
WHERE AGY_SETTINGS_CODE = 'AVATAX_USE_JOB_SC'

IF @USE_JOB_SALES_CLASS IS NULL
	SET @USE_JOB_SALES_CLASS = 0

IF @Post = 0
	SELECT	ID = W.AR_FUNCTION_ID,
			ClientCode = W.CL_CODE,
			DivisionCode = W.DIV_CODE,
			ProductCode = W.PRD_CODE, 
			FunctionCode = W.FNC_CODE, 
			SalesClassCode = CASE WHEN @USE_JOB_SALES_CLASS = 1 THEN W.SC_CODE ELSE C.AVALARA_SC_CODE END,
			FunctionDescription = F.FNC_DESCRIPTION, 
			TaxExempt = CASE WHEN W.INV_BY IN (1,2,8,3,5,22,24) THEN 
							CASE WHEN P.AVALARA_TAX_EXEMPT_OVERRIDE = 1 OR COALESCE(C.AVALARA_TAX_EXEMPT, 0) = 1 THEN CAST(1 as bit)
							ELSE CAST(0 as bit)
							END
						ELSE CAST(COALESCE(C.AVALARA_TAX_EXEMPT, 0) as bit)
						END,
			AvaTaxCompanyCode = O.AVATAX_COMPANY_CODE,
			AvaTaxCode = CASE WHEN APM.AVALARA_TAX_ID IS NOT NULL THEN (SELECT CODE FROM dbo.AVALARA_TAX WHERE AVALARA_TAX_ID = APM.AVALARA_TAX_ID)
							  ELSE (SELECT CODE FROM dbo.AVALARA_TAX WHERE AVALARA_TAX_ID = APM2.AVALARA_TAX_ID)
							  END,
			HoursQuantity = CAST(1 as decimal), --W.HRS_QTY,
			Amount = COALESCE( EMP_TIME_AMT, 0.00 ) + COALESCE( INC_ONLY_AMT, 0.00 ) + COALESCE( AB_SALE_AMT, 0.00 ) + 
					 COALESCE( AB_INC_AMT, 0.00 ) + COALESCE( COST_AMT, 0.00 ) + COALESCE( AB_COST_AMT, 0.00 ) +
					 COALESCE( COMMISSION_AMT, 0.00 ) + COALESCE( AB_COMMISSION_AMT, 0.00 ),								
			BillingAddress = CASE WHEN @USE_CLIENT_STREET_ADDRESS = 0 AND @USE_JOB_CONTACT_ADDRESS = 0 THEN
								CASE W.INV_BY 
									WHEN 6 THEN C.CL_BADDRESS1 
									WHEN 7 THEN D.DIV_BADDRESS1 
									ELSE P.PRD_BILL_ADDRESS1 END
							 WHEN @USE_CLIENT_STREET_ADDRESS = 1 THEN
								C.CL_ADDRESS1
							 WHEN @USE_JOB_CONTACT_ADDRESS = 1 THEN
								CASE WHEN (SELECT COUNT(DISTINCT CH.CDP_CONTACT_ID) FROM dbo.W_AR_FUNCTION W2 LEFT OUTER JOIN dbo.JOB_COMPONENT JC ON W2.JOB_NUMBER = JC.JOB_NUMBER AND W2.JOB_COMPONENT_NBR = JC.JOB_COMPONENT_NBR
												    														  LEFT OUTER JOIN dbo.CDP_CONTACT_HDR CH ON JC.CDP_CONTACT_ID = CH.CDP_CONTACT_ID
																					WHERE W2.DRAFT_INV_NBR = W.DRAFT_INV_NBR) = 1 THEN
									CH.CONT_ADDRESS1
								ELSE
									CASE W.INV_BY 
									WHEN 6 THEN C.CL_BADDRESS1 
									WHEN 7 THEN D.DIV_BADDRESS1 
									ELSE P.PRD_BILL_ADDRESS1 END
								END
							 END,
			BillingCity = CASE WHEN @USE_CLIENT_STREET_ADDRESS = 0 AND @USE_JOB_CONTACT_ADDRESS = 0 THEN
								CASE W.INV_BY 
									WHEN 6 THEN C.CL_BCITY  
									WHEN 7 THEN D.DIV_BCITY 
									ELSE P.PRD_BILL_CITY END
						  WHEN @USE_CLIENT_STREET_ADDRESS = 1 THEN
								C.CL_CITY
						  WHEN @USE_JOB_CONTACT_ADDRESS = 1 THEN
							CASE WHEN (SELECT COUNT(DISTINCT CH.CDP_CONTACT_ID) FROM dbo.W_AR_FUNCTION W2 LEFT OUTER JOIN dbo.JOB_COMPONENT JC ON W2.JOB_NUMBER = JC.JOB_NUMBER AND W2.JOB_COMPONENT_NBR = JC.JOB_COMPONENT_NBR
												    														  LEFT OUTER JOIN dbo.CDP_CONTACT_HDR CH ON JC.CDP_CONTACT_ID = CH.CDP_CONTACT_ID
																					WHERE W2.DRAFT_INV_NBR = W.DRAFT_INV_NBR) = 1 THEN
								CH.CONT_CITY
							ELSE
								CASE W.INV_BY 
									WHEN 6 THEN C.CL_BCITY  
									WHEN 7 THEN D.DIV_BCITY 
									ELSE P.PRD_BILL_CITY END
							END
						  END,
			BillingState = CASE WHEN @USE_CLIENT_STREET_ADDRESS = 0 AND @USE_JOB_CONTACT_ADDRESS = 0 THEN
								CASE W.INV_BY 
									WHEN 6 THEN C.CL_BSTATE 
									WHEN 7 THEN D.DIV_BSTATE  
									ELSE P.PRD_BILL_STATE END
						   WHEN @USE_CLIENT_STREET_ADDRESS = 1 THEN
								C.CL_STATE
						   WHEN @USE_JOB_CONTACT_ADDRESS = 1 THEN
							CASE WHEN (SELECT COUNT(DISTINCT CH.CDP_CONTACT_ID) FROM dbo.W_AR_FUNCTION W2 LEFT OUTER JOIN dbo.JOB_COMPONENT JC ON W2.JOB_NUMBER = JC.JOB_NUMBER AND W2.JOB_COMPONENT_NBR = JC.JOB_COMPONENT_NBR
												    														  LEFT OUTER JOIN dbo.CDP_CONTACT_HDR CH ON JC.CDP_CONTACT_ID = CH.CDP_CONTACT_ID
																					WHERE W2.DRAFT_INV_NBR = W.DRAFT_INV_NBR) = 1 THEN
								CH.CONT_STATE
							ELSE
								CASE W.INV_BY 
									WHEN 6 THEN C.CL_BSTATE 
									WHEN 7 THEN D.DIV_BSTATE  
									ELSE P.PRD_BILL_STATE END
							END
						   END,
			BillingZip = CASE WHEN @USE_CLIENT_STREET_ADDRESS = 0 AND @USE_JOB_CONTACT_ADDRESS = 0 THEN
								CASE W.INV_BY 
									WHEN 6 THEN C.CL_BZIP 
									WHEN 7 THEN D.DIV_BZIP 
									ELSE P.PRD_BILL_ZIP END
						 WHEN @USE_CLIENT_STREET_ADDRESS = 1 THEN
								C.CL_ZIP
						 WHEN @USE_JOB_CONTACT_ADDRESS = 1 THEN
							CASE WHEN (SELECT COUNT(DISTINCT CH.CDP_CONTACT_ID) FROM dbo.W_AR_FUNCTION W2 LEFT OUTER JOIN dbo.JOB_COMPONENT JC ON W2.JOB_NUMBER = JC.JOB_NUMBER AND W2.JOB_COMPONENT_NBR = JC.JOB_COMPONENT_NBR
												    														  LEFT OUTER JOIN dbo.CDP_CONTACT_HDR CH ON JC.CDP_CONTACT_ID = CH.CDP_CONTACT_ID
																					WHERE W2.DRAFT_INV_NBR = W.DRAFT_INV_NBR) = 1 THEN
								CH.CONT_ZIP
							ELSE
								CASE W.INV_BY 
									WHEN 6 THEN C.CL_BZIP 
									WHEN 7 THEN D.DIV_BZIP 
									ELSE P.PRD_BILL_ZIP END
							END
						 END,
			TotalTax = COALESCE(CITY_TAX_AMT, 0) + COALESCE(CNTY_TAX_AMT, 0) + COALESCE(STATE_TAX_AMT, 0),
	 		InvoiceNumber = DRAFT_INV_NBR + CASE WHEN W.AR_INV_SEQ = 0 THEN '' ELSE '-' + CAST(W.AR_INV_SEQ as varchar) END,
	 		IsAvaTaxCalculated = CAST(COALESCE(AVATAX_CALCULATED, 0) as bit),
			BillingCountry = CASE WHEN @USE_CLIENT_STREET_ADDRESS = 0 THEN
								CASE W.INV_BY 
									WHEN 6 THEN C.CL_BCOUNTRY
									WHEN 7 THEN D.DIV_BCOUNTRY
									ELSE P.PRD_BILL_COUNTRY END
							 ELSE
									C.CL_COUNTRY
							 END
	FROM	dbo.W_AR_FUNCTION W
				INNER JOIN dbo.FUNCTIONS F ON W.FNC_CODE = F.FNC_CODE 
				INNER JOIN dbo.CLIENT C ON W.CL_CODE = C.CL_CODE 
				INNER JOIN dbo.OFFICE O ON W.OFFICE_CODE = O.OFFICE_CODE 
				LEFT OUTER JOIN dbo.AVALARA_PRODUCT_MAPPING APM ON ((@USE_JOB_SALES_CLASS = 1 AND W.SC_CODE = APM.SC_CODE AND W.JOB_NUMBER IS NOT NULL) OR (@USE_JOB_SALES_CLASS = 0 AND C.AVALARA_SC_CODE = APM.SC_CODE)) AND W.FNC_CODE = APM.FNC_CODE 
				LEFT OUTER JOIN dbo.AVALARA_PRODUCT_MAPPING APM2 ON W.FNC_CODE = APM2.FNC_CODE AND APM2.SC_CODE IS NULL
				LEFT OUTER JOIN dbo.DIVISION D ON W.CL_CODE = D.CL_CODE AND W.DIV_CODE = D.DIV_CODE 
				LEFT OUTER JOIN dbo.PRODUCT P ON W.CL_CODE = P.CL_CODE AND W.DIV_CODE = P.DIV_CODE AND W.PRD_CODE = P.PRD_CODE
				LEFT OUTER JOIN dbo.JOB_COMPONENT JC ON W.JOB_NUMBER = JC.JOB_NUMBER AND W.JOB_COMPONENT_NBR = JC.JOB_COMPONENT_NBR
				LEFT OUTER JOIN dbo.CDP_CONTACT_HDR CH ON JC.CDP_CONTACT_ID = CH.CDP_CONTACT_ID
	WHERE	W.BILLING_USER = @BillingUser 
	AND		W.AR_INV_SEQ <> 99
	AND		W.FNC_TYPE IN ('E', 'I', 'V')
	AND		W.SUMMARY_FLAG = 0
	AND		W.ORDER_NBR IS NULL
	AND		W.MEDIA_TYPE IS NULL
ELSE
	SELECT	ID = W.AR_SUMMARY_ID, 
			ClientCode = W.CL_CODE,
			DivisionCode = W.DIV_CODE,
			ProductCode = W.PRD_CODE, 
			FunctionCode = W.FNC_CODE, 
			SalesClassCode = CASE WHEN @USE_JOB_SALES_CLASS = 1 THEN W.SC_CODE ELSE C.AVALARA_SC_CODE END,
			FunctionDescription = F.FNC_DESCRIPTION, 
			TaxExempt = CASE WHEN W.INV_BY IN (1,2,8,3,5,22,24) THEN 
							CASE WHEN P.AVALARA_TAX_EXEMPT_OVERRIDE = 1 OR COALESCE(C.AVALARA_TAX_EXEMPT, 0) = 1 THEN CAST(1 as bit)
							ELSE CAST(0 as bit)
							END
						ELSE CAST(COALESCE(C.AVALARA_TAX_EXEMPT, 0) as bit)
						END,
			AvaTaxCompanyCode = O.AVATAX_COMPANY_CODE,
			AvaTaxCode = CASE WHEN APM.AVALARA_TAX_ID IS NOT NULL THEN (SELECT CODE FROM dbo.AVALARA_TAX WHERE AVALARA_TAX_ID = APM.AVALARA_TAX_ID)
							  ELSE (SELECT CODE FROM dbo.AVALARA_TAX WHERE AVALARA_TAX_ID = APM2.AVALARA_TAX_ID)
							  END,
			HoursQuantity = CAST(1 as decimal), --W.HRS_QTY,
			Amount = COALESCE( EMP_TIME_AMT, 0.00 ) + COALESCE( INC_ONLY_AMT, 0.00 ) + COALESCE( AB_SALE_AMT, 0.00 ) + 
					 COALESCE( AB_INC_AMT, 0.00 ) + COALESCE( COST_AMT, 0.00 ) + COALESCE( AB_COST_AMT, 0.00 ) +
					 COALESCE( COMMISSION_AMT, 0.00 ) + COALESCE( AB_COMMISSION_AMT, 0.00 ),								
			BillingAddress = CASE WHEN @USE_CLIENT_STREET_ADDRESS = 0 AND @USE_JOB_CONTACT_ADDRESS = 0 THEN
								CASE W.INV_BY 
									WHEN 6 THEN C.CL_BADDRESS1 
									WHEN 7 THEN D.DIV_BADDRESS1 
									ELSE P.PRD_BILL_ADDRESS1 END
							 WHEN @USE_CLIENT_STREET_ADDRESS = 1 THEN
								C.CL_ADDRESS1
							 WHEN @USE_JOB_CONTACT_ADDRESS = 1 THEN
								CASE WHEN (SELECT COUNT(DISTINCT CH.CDP_CONTACT_ID) FROM dbo.AR_SUMMARY W2 LEFT OUTER JOIN dbo.JOB_COMPONENT JC ON W2.JOB_NUMBER = JC.JOB_NUMBER AND W2.JOB_COMPONENT_NBR = JC.JOB_COMPONENT_NBR
												    														  LEFT OUTER JOIN dbo.CDP_CONTACT_HDR CH ON JC.CDP_CONTACT_ID = CH.CDP_CONTACT_ID
																					WHERE W2.AR_INV_NBR = W.AR_INV_NBR) = 1 THEN
									CH.CONT_ADDRESS1
								ELSE
									CASE W.INV_BY 
									WHEN 6 THEN C.CL_BADDRESS1 
									WHEN 7 THEN D.DIV_BADDRESS1 
									ELSE P.PRD_BILL_ADDRESS1 END
								END
							 END,
			BillingCity = CASE WHEN @USE_CLIENT_STREET_ADDRESS = 0 AND @USE_JOB_CONTACT_ADDRESS = 0 THEN
								CASE W.INV_BY 
									WHEN 6 THEN C.CL_BCITY  
									WHEN 7 THEN D.DIV_BCITY 
									ELSE P.PRD_BILL_CITY END
						  WHEN @USE_CLIENT_STREET_ADDRESS = 1 THEN
								C.CL_CITY
						  WHEN @USE_JOB_CONTACT_ADDRESS = 1 THEN
							CASE WHEN (SELECT COUNT(DISTINCT CH.CDP_CONTACT_ID) FROM dbo.AR_SUMMARY W2 LEFT OUTER JOIN dbo.JOB_COMPONENT JC ON W2.JOB_NUMBER = JC.JOB_NUMBER AND W2.JOB_COMPONENT_NBR = JC.JOB_COMPONENT_NBR
												    														  LEFT OUTER JOIN dbo.CDP_CONTACT_HDR CH ON JC.CDP_CONTACT_ID = CH.CDP_CONTACT_ID
																					WHERE W2.AR_INV_NBR = W.AR_INV_NBR) = 1 THEN
								CH.CONT_CITY
							ELSE
								CASE W.INV_BY 
									WHEN 6 THEN C.CL_BCITY  
									WHEN 7 THEN D.DIV_BCITY 
									ELSE P.PRD_BILL_CITY END
							END
						  END,
			BillingState = CASE WHEN @USE_CLIENT_STREET_ADDRESS = 0 AND @USE_JOB_CONTACT_ADDRESS = 0 THEN
								CASE W.INV_BY 
									WHEN 6 THEN C.CL_BSTATE 
									WHEN 7 THEN D.DIV_BSTATE  
									ELSE P.PRD_BILL_STATE END
						   WHEN @USE_CLIENT_STREET_ADDRESS = 1 THEN
								C.CL_STATE
						   WHEN @USE_JOB_CONTACT_ADDRESS = 1 THEN
							CASE WHEN (SELECT COUNT(DISTINCT CH.CDP_CONTACT_ID) FROM dbo.AR_SUMMARY W2 LEFT OUTER JOIN dbo.JOB_COMPONENT JC ON W2.JOB_NUMBER = JC.JOB_NUMBER AND W2.JOB_COMPONENT_NBR = JC.JOB_COMPONENT_NBR
												    														  LEFT OUTER JOIN dbo.CDP_CONTACT_HDR CH ON JC.CDP_CONTACT_ID = CH.CDP_CONTACT_ID
																					WHERE W2.AR_INV_NBR = W.AR_INV_NBR) = 1 THEN
								CH.CONT_STATE
							ELSE
								CASE W.INV_BY 
									WHEN 6 THEN C.CL_BSTATE 
									WHEN 7 THEN D.DIV_BSTATE  
									ELSE P.PRD_BILL_STATE END
							END
						   END,
			BillingZip = CASE WHEN @USE_CLIENT_STREET_ADDRESS = 0 AND @USE_JOB_CONTACT_ADDRESS = 0 THEN
								CASE W.INV_BY 
									WHEN 6 THEN C.CL_BZIP 
									WHEN 7 THEN D.DIV_BZIP 
									ELSE P.PRD_BILL_ZIP END
						 WHEN @USE_CLIENT_STREET_ADDRESS = 1 THEN
								C.CL_ZIP
						 WHEN @USE_JOB_CONTACT_ADDRESS = 1 THEN
							CASE WHEN (SELECT COUNT(DISTINCT CH.CDP_CONTACT_ID) FROM dbo.AR_SUMMARY W2 LEFT OUTER JOIN dbo.JOB_COMPONENT JC ON W2.JOB_NUMBER = JC.JOB_NUMBER AND W2.JOB_COMPONENT_NBR = JC.JOB_COMPONENT_NBR
												    														  LEFT OUTER JOIN dbo.CDP_CONTACT_HDR CH ON JC.CDP_CONTACT_ID = CH.CDP_CONTACT_ID
																					WHERE W2.AR_INV_NBR = W.AR_INV_NBR) = 1 THEN
								CH.CONT_ZIP
							ELSE
								CASE W.INV_BY 
									WHEN 6 THEN C.CL_BZIP 
									WHEN 7 THEN D.DIV_BZIP 
									ELSE P.PRD_BILL_ZIP END
							END
						 END,
			TotalTax = COALESCE(CITY_TAX_AMT, 0) + COALESCE(CNTY_TAX_AMT, 0) + COALESCE(STATE_TAX_AMT, 0),
	 		InvoiceNumber = CAST(W.AR_INV_NBR as varchar) + CASE WHEN W.AR_INV_SEQ = 0 THEN '' ELSE '-' + CAST(W.AR_INV_SEQ as varchar) END,
	 		IsAvaTaxCalculated = CAST(1 as bit),
			InvoiceDate = (SELECT TOP 1 AR_INV_DATE FROM dbo.ACCT_REC WHERE AR_INV_NBR = W.AR_INV_NBR AND AR_TYPE = 'IN')
	FROM	dbo.AR_SUMMARY W
				INNER JOIN dbo.FUNCTIONS F ON W.FNC_CODE = F.FNC_CODE 
				INNER JOIN dbo.CLIENT C ON W.CL_CODE = C.CL_CODE 
				INNER JOIN dbo.OFFICE O ON W.OFFICE_CODE = O.OFFICE_CODE 
				LEFT OUTER JOIN dbo.AVALARA_PRODUCT_MAPPING APM ON ((@USE_JOB_SALES_CLASS = 1 AND W.SC_CODE = APM.SC_CODE AND W.JOB_NUMBER IS NOT NULL) OR (@USE_JOB_SALES_CLASS = 0 AND C.AVALARA_SC_CODE = APM.SC_CODE)) AND W.FNC_CODE = APM.FNC_CODE 
				LEFT OUTER JOIN dbo.AVALARA_PRODUCT_MAPPING APM2 ON W.FNC_CODE = APM2.FNC_CODE AND APM2.SC_CODE IS NULL
				LEFT OUTER JOIN dbo.DIVISION D ON W.CL_CODE = D.CL_CODE AND W.DIV_CODE = D.DIV_CODE 
				LEFT OUTER JOIN dbo.PRODUCT P ON W.CL_CODE = P.CL_CODE AND W.DIV_CODE = P.DIV_CODE AND W.PRD_CODE = P.PRD_CODE 
				LEFT OUTER JOIN dbo.JOB_COMPONENT JC ON W.JOB_NUMBER = JC.JOB_NUMBER AND W.JOB_COMPONENT_NBR = JC.JOB_COMPONENT_NBR
				LEFT OUTER JOIN dbo.CDP_CONTACT_HDR CH ON JC.CDP_CONTACT_ID = CH.CDP_CONTACT_ID
	WHERE	W.AR_INV_SEQ <> 99
	AND		W.FNC_TYPE IN ('E', 'I', 'V')
	AND		(W.AR_INV_NBR IN (SELECT * FROM dbo.udf_split_list(@ARInvNumberList, ',')) OR @ARInvNumberList = 'ALL')
	AND		W.AVATAX_POSTED = 0
	AND		W.ORDER_NBR IS NULL
	AND		W.MEDIA_TYPE IS NULL
GO
