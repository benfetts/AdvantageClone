CREATE PROCEDURE [dbo].[advsp_broadcast_orders_for_vendor_rep]
	@VN_CODE varchar(6),
	@VR_CODE varchar(4),
	@SENT bit	-- 1 means the order number MUST be in the @ORDERS table (it was sent to the ven rep already)
				-- 0 means the rep has not yet been sent but has been selected as a recipient (this gathers the information for the generated order email)
AS

DECLARE @ORDERS TABLE (
	ORDER_NBR int NOT NULL
)

DECLARE @EMAIL varchar(50)

SELECT @EMAIL = UPPER(vr.EMAIL_ADDRESS)
FROM dbo.VEN_REP vr 
WHERE vr.VN_CODE = @VN_CODE
AND VR_CODE = @VR_CODE

INSERT INTO @ORDERS (ORDER_NBR)
SELECT DISTINCT a.ORDER_NBR
FROM dbo.MEDIA_MGR_GENERATED_REPORT a
	INNER JOIN dbo.MEDIA_MGR_GENERATED_REPORT_SENT_INFO b ON a.MEDIA_MGR_GENERATED_REPORT_ID = b.MEDIA_MGR_GENERATED_REPORT_ID AND UPPER(b.EMAIL) = @EMAIL
	INNER JOIN dbo.BRD_IMPORT_XREF x ON a.ORDER_NBR = x.ORDER_NBR AND x.IMPORTED_FROM = 'AW'
	
IF @SENT = 1 BEGIN

	DELETE o
	FROM @ORDERS o
		INNER JOIN dbo.TV_HDR h ON o.ORDER_NBR = h.ORDER_NBR
	WHERE
		h.ALERT_ID IS NULL
		
	DELETE o
	FROM @ORDERS o
		INNER JOIN dbo.RADIO_HDR h ON o.ORDER_NBR = h.ORDER_NBR
	WHERE
		h.ALERT_ID IS NULL

END

--DELETE o
--FROM @ORDERS o
--	INNER JOIN (
--				SELECT d.ORDER_NBR, GENERATE_PENDING = CASE WHEN os.ORDER_NBR IS NULL THEN 1 ELSE 0 END
--				FROM dbo.TV_DETAIL d
--					LEFT OUTER JOIN dbo.TV_ORDER_STATUS os ON d.ORDER_NBR = os.ORDER_NBR AND d.LINE_NBR = os.LINE_NBR AND d.REV_NBR = os.REV_NBR 
--				WHERE d.ORDER_NBR IN (SELECT DISTINCT ORDER_NBR FROM @ORDERS)
--				AND d.ACTIVE_REV = 1
--				AND os.ORDER_NBR IS NULL
--				) gp ON o.ORDER_NBR = gp.ORDER_NBR AND gp.GENERATE_PENDING = 1
					
--DELETE o
--FROM @ORDERS o
--	INNER JOIN (
--				SELECT d.ORDER_NBR, GENERATE_PENDING = CASE WHEN os.ORDER_NBR IS NULL THEN 1 ELSE 0 END
--				FROM dbo.RADIO_DETAIL d
--					LEFT OUTER JOIN dbo.RADIO_ORDER_STATUS os ON d.ORDER_NBR = os.ORDER_NBR AND d.LINE_NBR = os.LINE_NBR AND d.REV_NBR = os.REV_NBR 
--				WHERE d.ORDER_NBR IN (SELECT DISTINCT ORDER_NBR FROM @ORDERS)
--				AND d.ACTIVE_REV = 1
--				AND os.ORDER_NBR IS NULL
--				) gp ON o.ORDER_NBR = gp.ORDER_NBR AND gp.GENERATE_PENDING = 1

--SELECT DISTINCT MBW.[NAME], MBWMDD.ORDER_NBR, MBW.[START_DATE], MBW.[END_DATE]
--INTO #BCAST
--FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_DATE MBWMDD
--	INNER JOIN dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL MBWMD ON MBWMDD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID = MBWMD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID 
--	INNER JOIN dbo.MEDIA_BROADCAST_WORKSHEET_MARKET MBWM ON MBWMD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = MBWM.MEDIA_BROADCAST_WORKSHEET_MARKET_ID 
--	INNER JOIN dbo.MEDIA_BROADCAST_WORKSHEET MBW ON MBWM.MEDIA_BROADCAST_WORKSHEET_ID = MBW.MEDIA_BROADCAST_WORKSHEET_ID 
--WHERE MBWMDD.ORDER_NBR IN (SELECT ORDER_NBR FROM @ORDERS)

SELECT
		MarketDescription = m.MARKET_DESC,
		Station = v.VN_NAME, 
		OrderNumber = ORDER_NBR, 
		ClientName = CASE WHEN UPPER(c.CL_NAME) <> UPPER(d.DIV_NAME) THEN c.CL_NAME + '/' + d.DIV_NAME ELSE c.CL_NAME END, 
		ProductDescription = p.PRD_DESCRIPTION, 
		[Period],
		[Status] = dbo.[advfn_makegood_get_order_status](ORDER_NBR, SUBSTRING(MEDIA_FROM,1,1)),
		StatusDate = dbo.[advfn_makegood_get_order_status_date](ORDER_NBR),
		MediaFrom = MEDIA_FROM,
		AgencyName = (SELECT TOP 1 [NAME] from dbo.AGENCY),
		BuyerEmployeeCode,
		BuyerName = ISNULL(RTRIM(e.EMP_FNAME) + ' ', '') + ISNULL(e.EMP_MI + '. ', '') + ISNULL(e.EMP_LNAME, ''),
		BuyerEmail = e.EMP_EMAIL,
		BuyerWorkPhone = e.EMP_PHONE_WORK,
		VendorRepEmail,
		WorksheetName = detail.[NAME],
		FlightEndDate,
		DropAfterDays = CAST(60 as int),
		OrderProcessControl = CAST(OrderProcessControl as int)
FROM (
	SELECT 
		mmgr.ORDER_NBR,
		MARKET_CODE = COALESCE(th.MARKET_CODE, rh.MARKET_CODE),
		VN_CODE = COALESCE(th.VN_CODE, rh.VN_CODE),
		CL_CODE = COALESCE(th.CL_CODE, rh.CL_CODE),
		DIV_CODE = COALESCE(th.DIV_CODE, rh.DIV_CODE),
		PRD_CODE = COALESCE(th.PRD_CODE, rh.PRD_CODE),
		mmgr.MEDIA_FROM,
		[Period] = CONVERT(varchar(10), worksheet.[START_DATE], 101) + ' - ' + CONVERT(varchar(10), worksheet.[END_DATE], 101),
		--[Period] = CASE 
		--			WHEN mmgr.MEDIA_FROM = 'TV' THEN
		--				(SELECT CONVERT(varchar(10), MIN([START_DATE]), 101) + ' - ' + CONVERT(varchar(10), MAX([END_DATE]), 101) 
		--				 FROM dbo.TV_DETAIL td
		--				 WHERE ORDER_NBR = mmgr.ORDER_NBR 
		--				 AND ACTIVE_REV = 1
		--				 AND LINE_NBR IN (SELECT DISTINCT b.LINE_NBR FROM dbo.MEDIA_MGR_GENERATED_REPORT a INNER JOIN dbo.MEDIA_MGR_GENERATED_REPORT_DETAIL b ON a.MEDIA_MGR_GENERATED_REPORT_ID = b.MEDIA_MGR_GENERATED_REPORT_ID WHERE a.ORDER_NBR = td.ORDER_NBR))
		--			WHEN mmgr.MEDIA_FROM = 'Radio' THEN
		--				(SELECT CONVERT(varchar(10), MIN([START_DATE]), 101) + ' - ' + CONVERT(varchar(10), MAX([END_DATE]), 101) 
		--				 FROM dbo.RADIO_DETAIL rd
		--				 WHERE ORDER_NBR = mmgr.ORDER_NBR 
		--				 AND ACTIVE_REV = 1
		--				 AND LINE_NBR IN (SELECT DISTINCT b.LINE_NBR FROM dbo.MEDIA_MGR_GENERATED_REPORT a INNER JOIN dbo.MEDIA_MGR_GENERATED_REPORT_DETAIL b ON a.MEDIA_MGR_GENERATED_REPORT_ID = b.MEDIA_MGR_GENERATED_REPORT_ID WHERE a.ORDER_NBR = rd.ORDER_NBR))
		--		   END,
		BuyerEmployeeCode = COALESCE(th.BUYER_EMP_CODE, rh.BUYER_EMP_CODE),
		VendorRepEmail = @EMAIL,
		worksheet.[NAME],
		FlightEndDate = CASE 
						WHEN mmgr.MEDIA_FROM = 'TV' THEN
							(SELECT MAX([END_DATE])
							 FROM dbo.TV_DETAIL td
							 WHERE ORDER_NBR = mmgr.ORDER_NBR 
							 AND ACTIVE_REV = 1
							 AND LINE_NBR IN (SELECT DISTINCT b.LINE_NBR FROM dbo.MEDIA_MGR_GENERATED_REPORT a INNER JOIN dbo.MEDIA_MGR_GENERATED_REPORT_DETAIL b ON a.MEDIA_MGR_GENERATED_REPORT_ID = b.MEDIA_MGR_GENERATED_REPORT_ID WHERE a.ORDER_NBR = td.ORDER_NBR))
						WHEN mmgr.MEDIA_FROM = 'Radio' THEN
							(SELECT MAX([END_DATE])
							 FROM dbo.RADIO_DETAIL rd
							 WHERE ORDER_NBR = mmgr.ORDER_NBR 
							 AND ACTIVE_REV = 1
							 AND LINE_NBR IN (SELECT DISTINCT b.LINE_NBR FROM dbo.MEDIA_MGR_GENERATED_REPORT a INNER JOIN dbo.MEDIA_MGR_GENERATED_REPORT_DETAIL b ON a.MEDIA_MGR_GENERATED_REPORT_ID = b.MEDIA_MGR_GENERATED_REPORT_ID WHERE a.ORDER_NBR = rd.ORDER_NBR))
						END,
		OrderProcessControl = COALESCE(th.ORD_PROCESS_CONTRL, rh.ORD_PROCESS_CONTRL)
	FROM (
			SELECT MAX(a.MEDIA_MGR_GENERATED_REPORT_ID) AS MEDIA_MGR_GENERATED_REPORT_ID, a.ORDER_NBR, a.MEDIA_FROM
			FROM dbo.MEDIA_MGR_GENERATED_REPORT a
				INNER JOIN dbo.BRD_IMPORT_XREF x ON a.ORDER_NBR = x.ORDER_NBR AND x.IMPORTED_FROM = 'AW'
				LEFT OUTER JOIN @ORDERS o ON a.ORDER_NBR = o.ORDER_NBR
			WHERE a.MEDIA_FROM IN ('TV', 'Radio')
			AND 
				(
					(@SENT = 0)
				OR
					(@SENT = 1 AND o.ORDER_NBR IS NOT NULL)
				)
			GROUP BY a.ORDER_NBR, MEDIA_FROM) mmgr
		LEFT OUTER JOIN dbo.TV_HDR th ON mmgr.ORDER_NBR = th.ORDER_NBR AND (th.VN_CODE = @VN_CODE OR th.VN_CODE IN (SELECT VN_CODE FROM dbo.MEDIA_MGR_GENERATED_REPORT_SENT_INFO WHERE UPPER(EMAIL) = @EMAIL))
		LEFT OUTER JOIN dbo.RADIO_HDR rh ON mmgr.ORDER_NBR = rh.ORDER_NBR AND (rh.VN_CODE = @VN_CODE OR rh.VN_CODE IN (SELECT VN_CODE FROM dbo.MEDIA_MGR_GENERATED_REPORT_SENT_INFO WHERE UPPER(EMAIL) = @EMAIL))
		LEFT OUTER JOIN (
						SELECT DISTINCT MBW.[NAME], MBWMDD.ORDER_NBR, MBW.[START_DATE], MBW.[END_DATE]
						FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_DATE MBWMDD
							INNER JOIN dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL MBWMD ON MBWMDD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID = MBWMD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID 
							INNER JOIN dbo.MEDIA_BROADCAST_WORKSHEET_MARKET MBWM ON MBWMD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = MBWM.MEDIA_BROADCAST_WORKSHEET_MARKET_ID 
							INNER JOIN dbo.MEDIA_BROADCAST_WORKSHEET MBW ON MBWM.MEDIA_BROADCAST_WORKSHEET_ID = MBW.MEDIA_BROADCAST_WORKSHEET_ID 
						) worksheet ON mmgr.ORDER_NBR = worksheet.ORDER_NBR 
	) detail
		INNER JOIN dbo.MARKET m ON detail.MARKET_CODE = m.MARKET_CODE 
		INNER JOIN dbo.VENDOR v ON detail.VN_CODE = v.VN_CODE
		INNER JOIN dbo.CLIENT c ON detail.CL_CODE = c.CL_CODE
		INNER JOIN dbo.DIVISION d ON detail.CL_CODE = d.CL_CODE AND detail.DIV_CODE = d.DIV_CODE
		INNER JOIN dbo.PRODUCT p ON detail.CL_CODE = p.CL_CODE AND detail.DIV_CODE = p.DIV_CODE AND detail.PRD_CODE = p.PRD_CODE 
		LEFT OUTER JOIN dbo.EMPLOYEE e ON detail.BuyerEmployeeCode = e.EMP_CODE
	ORDER BY 8 DESC, 4 ASC, 5 ASC, 16 ASC
