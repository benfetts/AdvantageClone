CREATE PROCEDURE [dbo].[advsp_makegood_staging_add_makegood]
	@MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL_ID int
AS

DECLARE @MEDIA_BROADCAST_WORKSHEET_MARKET_ID int, 
		@LINE_NUMBER int,
		@MAKEGOOD_NUMBER int,
		@NEW_MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL_ID int,
		@MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID int,
		@VN_CODE varchar(6)

SELECT @MEDIA_BROADCAST_WORKSHEET_MARKET_ID = MEDIA_BROADCAST_WORKSHEET_MARKET_ID, @LINE_NUMBER = LINE_NUMBER, @MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID = MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID
FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL
WHERE MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL_ID = @MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL_ID

SELECT @VN_CODE = VN_CODE FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL 
WHERE MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID = @MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID

SELECT @MAKEGOOD_NUMBER = MAX(MAKEGOOD_NUMBER) + 1 
FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL 
WHERE MEDIA_BROADCAST_WORKSHEET_MARKET_ID = @MEDIA_BROADCAST_WORKSHEET_MARKET_ID
AND LINE_NUMBER = @LINE_NUMBER 
AND MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID IN (SELECT MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID
													FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL
													WHERE MEDIA_BROADCAST_WORKSHEET_MARKET_ID = @MEDIA_BROADCAST_WORKSHEET_MARKET_ID
													AND VN_CODE = @VN_CODE)

INSERT INTO dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL (
	MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID, MEDIA_BROADCAST_WORKSHEET_MARKET_ID, LINE_NUMBER, MAKEGOOD_NUMBER, MAKEGOOD_DATE, MAKEGOOD_SPOTS,
	REVISION_NUMBER, CABLE_NETWORK_STATION_CODE, CABLE_NETWORK_NIELSEN_TV_STATION_CODE, PROGRAM, DAY_PART_ID,
	[LENGTH], [DAYS], SUNDAY, MONDAY, TUESDAY, WEDNESDAY, THURSDAY, FRIDAY, SATURDAY, START_TIME, END_TIME,
	START_HOUR, END_HOUR, COMMENTS, 
	BOOKEND, DEFAULT_RATE, IS_ORIGINAL, MADEGOOD_NUMBER, 
	PRIMARY_RATING, PRIMARY_CPP, PRIMARY_CPM, PRIMARY_IMPRESSIONS,
	SECONDARY_RATING, SECONDARY_CPP, SECONDARY_CPM, SECONDARY_IMPRESSIONS, USER_CREATED, CREATED_DATE)
SELECT
	MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID, MEDIA_BROADCAST_WORKSHEET_MARKET_ID, LINE_NUMBER, @MAKEGOOD_NUMBER, '0001-01-01', 0,
	REVISION_NUMBER, CABLE_NETWORK_STATION_CODE, CABLE_NETWORK_NIELSEN_TV_STATION_CODE, PROGRAM, DAY_PART_ID,
	[LENGTH], [DAYS], SUNDAY, MONDAY, TUESDAY, WEDNESDAY, THURSDAY, FRIDAY, SATURDAY, START_TIME, END_TIME,
	START_HOUR, END_HOUR, CASE WHEN MAKEGOOD_NUMBER > 0 THEN 'Makegood is for line ' + RIGHT('000' + CAST(@LINE_NUMBER as varchar), 4) + '-' + RIGHT('0' + CAST(MAKEGOOD_NUMBER as varchar), 2)
							ELSE 'Makegood is for line ' + RIGHT('000' + CAST(@LINE_NUMBER as varchar), 4)
							END,
	BOOKEND, DEFAULT_RATE, 0, MAKEGOOD_NUMBER, 
	PRIMARY_RATING, PRIMARY_CPP, PRIMARY_CPM, PRIMARY_IMPRESSIONS,
	SECONDARY_RATING, SECONDARY_CPP, SECONDARY_CPM, SECONDARY_IMPRESSIONS, USER_CREATED, CREATED_DATE 
FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL 
WHERE MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL_ID = @MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL_ID

SELECT @NEW_MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL_ID = SCOPE_IDENTITY()

INSERT INTO dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL_DATE (
	MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL_ID, [DATE], RATE, SPOTS, IS_HIATUS, ALLOW_SPOTS_TO_BE_ENTERED)
SELECT
	@NEW_MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL_ID, [DATE], RATE, 0, IS_HIATUS, ALLOW_SPOTS_TO_BE_ENTERED
FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL_DATE
WHERE MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL_ID = @MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL_ID

SELECT @NEW_MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL_ID

GO