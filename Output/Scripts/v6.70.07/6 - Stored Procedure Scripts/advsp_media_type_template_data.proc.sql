CREATE PROCEDURE [dbo].[advsp_media_type_template_data]
	@MEDIA_PLAN_ESTIMATE_TEMPLATE_ID int,
    @SELECT_INTERNET_RATES bit = 0
AS

SELECT 
	ID = dt.MEDIA_PLAN_ESTIMATE_TEMPLATE_DATA_ID,
	MediaPlanEstimateTemplateID = t.MEDIA_PLAN_ESTIMATE_TEMPLATE_ID,
	MediaPlanEstimateTemplateVendorID = v.MEDIA_PLAN_ESTIMATE_TEMPLATE_VENDOR_ID,
    VendorCode = v.VN_CODE,
    VendorName = vnd.VN_NAME,
    SuggestedVendorName = v.[NAME],
    MediaPlanEstimateTemplateMediaTacticID = tc.MEDIA_PLAN_ESTIMATE_TEMPLATE_TACTIC_ID,
    MediaTacticID = tc.MEDIA_TACTIC_ID,
    TacticDescription = mt.[DESCRIPTION],
    SuggestedTacticDescription = tc.[DESCRIPTION],
    PercentageOrRate = CASE WHEN t.[TYPE] = 'I' AND @SELECT_INTERNET_RATES = 0 THEN COALESCE(dt.[PERCENTAGE],0)
                            WHEN t.[TYPE] = 'I' AND @SELECT_INTERNET_RATES = 1 THEN COALESCE(dt.[RATE],0)
                            WHEN t.[TYPE] IN ('R','T') THEN COALESCE(dt.[RATE],0)
                            ELSE COALESCE(dt.[RATE],0)
                            END,
    MediaPlanEstimateTemplateDaypartID = dp.MEDIA_PLAN_ESTIMATE_TEMPLATE_DAYPART_ID,
	Daypart = dpd.DAY_PART_CODE, -- + ' | ' + CAST(dp.[PERCENTAGE] as varchar) + '%',
    DaypartPercent = dpp.[PERCENTAGE],
    DaypartDescription = dpd.[DESCRIPTION],
    DaypartID = dpd.DAY_PART_ID,
    MediaPlanEstimateTemplateDemographicID = d.MEDIA_PLAN_ESTIMATE_TEMPLATE_DEMOGRAPHIC_ID,
	Demographic = md.[DESCRIPTION],
    MediaPlanEstimateTemplateMarketID = m.MEDIA_PLAN_ESTIMATE_TEMPLATE_MARKET_ID,
	Market = mkt.MARKET_DESC,
    MarketCode = mkt.MARKET_CODE,
    MediaPlanEstimateTemplateSpotLengthID = s.MEDIA_PLAN_ESTIMATE_TEMPLATE_SPOTLENGTH_ID,
	SpotLength = CAST(COALESCE(s.SPOT_LENGTH,0) as smallint),
    MediaPlanEstimateTemplateQuarterID = q.MEDIA_PLAN_ESTIMATE_TEMPLATE_QUARTER_ID,
	[Quarter] = CASE 
				WHEN q.[QUARTER] = 1 THEN 'Q1'
				WHEN q.[QUARTER] = 2 THEN 'Q2'
				WHEN q.[QUARTER] = 3 THEN 'Q3'
				WHEN q.[QUARTER] = 4 THEN 'Q4'
				ELSE NULL
				END,
	MediaPlanEstimateTemplateAdSizeID = a.MEDIA_PLAN_ESTIMATE_TEMPLATE_AD_SIZE_ID,
	AdSize = ads.SIZE_DESC,
    AdSizeCode = a.SIZE_CODE,
	MediaPlanEstimateTemplateOutdoorTypeID = o.MEDIA_PLAN_ESTIMATE_TEMPLATE_OUTDOOR_TYPE_ID,
	OutOfHomeType = ot.OD_DESC,
    OutOfHomeTypeCode = o.OD_CODE,
    MediaPlanEstimateTemplateRateTypeID = rt.MEDIA_PLAN_ESTIMATE_TEMPLATE_RATE_TYPE_ID,
    [RateTypeDescription] = CASE 
				WHEN rt.[RATE_TYPE] = 1 THEN 'Column/Inch'
				WHEN rt.[RATE_TYPE] = 2 THEN 'Line'
				WHEN rt.[RATE_TYPE] = 3 THEN 'Standard'
				ELSE NULL
				END,
    RateTypeID = rt.[RATE_TYPE],
    IsInternetRate = @SELECT_INTERNET_RATES,
    InternetTypeCode = it.OD_CODE,
    InternetTypeName = it.OD_DESC
FROM dbo.MEDIA_PLAN_ESTIMATE_TEMPLATE t
	LEFT OUTER JOIN dbo.MEDIA_PLAN_ESTIMATE_TEMPLATE_AD_SIZE a on t.MEDIA_PLAN_ESTIMATE_TEMPLATE_ID = a.MEDIA_PLAN_ESTIMATE_TEMPLATE_ID 
	LEFT OUTER JOIN dbo.AD_SIZE ads ON a.SIZE_CODE = ads.SIZE_CODE AND t.[TYPE] = ads.MEDIA_TYPE 
	LEFT OUTER JOIN dbo.MEDIA_PLAN_ESTIMATE_TEMPLATE_DAYPART dp on t.MEDIA_PLAN_ESTIMATE_TEMPLATE_ID = dp.MEDIA_PLAN_ESTIMATE_TEMPLATE_ID 
	LEFT OUTER JOIN dbo.DAY_PART dpd ON dp.DAY_PART_ID = dpd.DAY_PART_ID 
	LEFT OUTER JOIN dbo.MEDIA_PLAN_ESTIMATE_TEMPLATE_DEMOGRAPHIC d on t.MEDIA_PLAN_ESTIMATE_TEMPLATE_ID = d.MEDIA_PLAN_ESTIMATE_TEMPLATE_ID 
	LEFT OUTER JOIN dbo.MEDIA_DEMO md ON d.MEDIA_DEMO_ID = md.MEDIA_DEMO_ID 
	LEFT OUTER JOIN dbo.MEDIA_PLAN_ESTIMATE_TEMPLATE_MARKET m on t.MEDIA_PLAN_ESTIMATE_TEMPLATE_ID = m.MEDIA_PLAN_ESTIMATE_TEMPLATE_ID 
	LEFT OUTER JOIN dbo.MARKET mkt ON m.MARKET_CODE = mkt.MARKET_CODE 
    LEFT OUTER JOIN dbo.MEDIA_PLAN_ESTIMATE_TEMPLATE_DAYPART_PERCENT dpp on dp.MEDIA_PLAN_ESTIMATE_TEMPLATE_DAYPART_ID = dpp.MEDIA_PLAN_ESTIMATE_TEMPLATE_DAYPART_ID 
                                                                    AND ((dpp.MARKET_CODE IS NOT NULL AND mkt.MARKET_CODE = dpp.MARKET_CODE) OR (dpp.MARKET_CODE IS NULL))
	LEFT OUTER JOIN dbo.MEDIA_PLAN_ESTIMATE_TEMPLATE_OUTDOOR_TYPE o on t.MEDIA_PLAN_ESTIMATE_TEMPLATE_ID = o.MEDIA_PLAN_ESTIMATE_TEMPLATE_ID 
	LEFT OUTER JOIN dbo.OUTDOOR_TYPE ot ON o.OD_CODE = ot.OD_CODE 
	LEFT OUTER JOIN dbo.MEDIA_PLAN_ESTIMATE_TEMPLATE_QUARTER q on t.MEDIA_PLAN_ESTIMATE_TEMPLATE_ID = q.MEDIA_PLAN_ESTIMATE_TEMPLATE_ID 
	LEFT OUTER JOIN dbo.MEDIA_PLAN_ESTIMATE_TEMPLATE_SPOTLENGTH s on t.MEDIA_PLAN_ESTIMATE_TEMPLATE_ID = s.MEDIA_PLAN_ESTIMATE_TEMPLATE_ID 
	LEFT OUTER JOIN dbo.MEDIA_PLAN_ESTIMATE_TEMPLATE_TACTIC tc on @SELECT_INTERNET_RATES = 0 AND t.MEDIA_PLAN_ESTIMATE_TEMPLATE_ID = tc.MEDIA_PLAN_ESTIMATE_TEMPLATE_ID 
	LEFT OUTER JOIN dbo.MEDIA_PLAN_ESTIMATE_TEMPLATE_VENDOR v on t.MEDIA_PLAN_ESTIMATE_TEMPLATE_ID = v.MEDIA_PLAN_ESTIMATE_TEMPLATE_ID 
    LEFT OUTER JOIN dbo.MEDIA_PLAN_ESTIMATE_TEMPLATE_RATE_TYPE rt on t.MEDIA_PLAN_ESTIMATE_TEMPLATE_ID = rt.MEDIA_PLAN_ESTIMATE_TEMPLATE_ID 
    LEFT OUTER JOIN dbo.INTERNET_TYPE it ON @SELECT_INTERNET_RATES = 1
	LEFT OUTER JOIN dbo.MEDIA_PLAN_ESTIMATE_TEMPLATE_DATA dt ON t.MEDIA_PLAN_ESTIMATE_TEMPLATE_ID = dt.MEDIA_PLAN_ESTIMATE_TEMPLATE_ID AND
														COALESCE(dt.MEDIA_PLAN_ESTIMATE_TEMPLATE_AD_SIZE_ID,0) = COALESCE(a.MEDIA_PLAN_ESTIMATE_TEMPLATE_AD_SIZE_ID,0) AND
														COALESCE(dt.MEDIA_PLAN_ESTIMATE_TEMPLATE_DAYPART_ID,0) = COALESCE(dp.MEDIA_PLAN_ESTIMATE_TEMPLATE_DAYPART_ID,0) AND
														COALESCE(dt.MEDIA_PLAN_ESTIMATE_TEMPLATE_DEMOGRAPHIC_ID,0) = COALESCE(d.MEDIA_PLAN_ESTIMATE_TEMPLATE_DEMOGRAPHIC_ID,0) AND														
														COALESCE(dt.MEDIA_PLAN_ESTIMATE_TEMPLATE_MARKET_ID,0) = COALESCE(m.MEDIA_PLAN_ESTIMATE_TEMPLATE_MARKET_ID,0) AND
														COALESCE(dt.MEDIA_PLAN_ESTIMATE_TEMPLATE_OUTDOOR_TYPE_ID,0) = COALESCE(o.MEDIA_PLAN_ESTIMATE_TEMPLATE_OUTDOOR_TYPE_ID,0) AND
														COALESCE(dt.MEDIA_PLAN_ESTIMATE_TEMPLATE_QUARTER_ID,0) = COALESCE(q.MEDIA_PLAN_ESTIMATE_TEMPLATE_QUARTER_ID,0) AND
														COALESCE(dt.MEDIA_PLAN_ESTIMATE_TEMPLATE_SPOTLENGTH_ID,0) = COALESCE(s.MEDIA_PLAN_ESTIMATE_TEMPLATE_SPOTLENGTH_ID,0) AND
														COALESCE(dt.MEDIA_PLAN_ESTIMATE_TEMPLATE_TACTIC_ID,0) = COALESCE(tc.MEDIA_PLAN_ESTIMATE_TEMPLATE_TACTIC_ID,0) AND
														COALESCE(dt.MEDIA_PLAN_ESTIMATE_TEMPLATE_VENDOR_ID,0) = COALESCE(v.MEDIA_PLAN_ESTIMATE_TEMPLATE_VENDOR_ID,0) AND
                                                        COALESCE(dt.MEDIA_PLAN_ESTIMATE_TEMPLATE_RATE_TYPE_ID,0) = COALESCE(rt.MEDIA_PLAN_ESTIMATE_TEMPLATE_RATE_TYPE_ID,0) AND
                                                        COALESCE(dt.INTERNET_TYPE_CODE,'') = COALESCE(it.OD_CODE,'')
	LEFT OUTER JOIN dbo.VENDOR vnd ON vnd.VN_CODE = v.VN_CODE
	LEFT OUTER JOIN dbo.MEDIA_TACTIC mt ON mt.MEDIA_TACTIC_ID = tc.MEDIA_TACTIC_ID     
WHERE t.MEDIA_PLAN_ESTIMATE_TEMPLATE_ID = @MEDIA_PLAN_ESTIMATE_TEMPLATE_ID
