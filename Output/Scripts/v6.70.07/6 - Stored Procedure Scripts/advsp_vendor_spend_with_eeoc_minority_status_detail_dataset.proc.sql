CREATE PROCEDURE [dbo].[advsp_vendor_spend_with_eeoc_minority_status_detail_dataset]
	@START_POST_PERIOD varchar(6), @END_POST_PERIOD varchar(6)
AS

--declare @START_POST_PERIOD varchar(6), @END_POST_PERIOD varchar(6)
--set @START_POST_PERIOD = '200001'
--set @END_POST_PERIOD = '202012'

SELECT DISTINCT AP_ID
INTO #APIDS
FROM dbo.AP_HEADER
WHERE POST_PERIOD BETWEEN @START_POST_PERIOD AND @END_POST_PERIOD

SELECT
	ID = NEWID(),
	VendorCode = V.VN_CODE,
	VendorName = V.VN_NAME,
	[Address] = V.VN_ADDRESS1,
	City = V.VN_CITY,
	County = V.VN_COUNTY,
	[State] = V.VN_STATE,
	ZipCode = V.VN_ZIP,
	Country = V.VN_COUNTRY,
	HUBZ = CASE WHEN EXISTS(SELECT 1 FROM EEOC_STATUS WHERE VENDOR = V.VN_CODE AND EEOC_CODE = 'HZSB') THEN 'Y' ELSE 'N' END,
	[IO] = CASE WHEN EXISTS(SELECT 1 FROM EEOC_STATUS WHERE VENDOR = V.VN_CODE AND EEOC_CODE = 'I') THEN 'Y' ELSE 'N' END,
	LGBT = CASE WHEN EXISTS(SELECT 1 FROM EEOC_STATUS WHERE VENDOR = V.VN_CODE AND EEOC_CODE = 'LGBT') THEN 'Y' ELSE 'N' END,
	MBE = CASE WHEN EXISTS(SELECT 1 FROM EEOC_STATUS WHERE VENDOR = V.VN_CODE AND EEOC_CODE = 'MO') THEN 'Y' ELSE 'N' END,
	MISC1 = CASE WHEN EXISTS(SELECT 1 FROM EEOC_STATUS WHERE VENDOR = V.VN_CODE AND EEOC_CODE = 'MISC1') THEN 'Y' ELSE 'N' END,
	MISC2 = CASE WHEN EXISTS(SELECT 1 FROM EEOC_STATUS WHERE VENDOR = V.VN_CODE AND EEOC_CODE = 'MISC2') THEN 'Y' ELSE 'N' END,
	MISC3 = CASE WHEN EXISTS(SELECT 1 FROM EEOC_STATUS WHERE VENDOR = V.VN_CODE AND EEOC_CODE = 'MISC3') THEN 'Y' ELSE 'N' END,
	NA = CASE WHEN EXISTS(SELECT 1 FROM EEOC_STATUS WHERE VENDOR = V.VN_CODE AND EEOC_CODE = 'N') THEN 'Y' ELSE 'N' END,
	OT = CASE WHEN EXISTS(SELECT 1 FROM EEOC_STATUS WHERE VENDOR = V.VN_CODE AND EEOC_CODE = 'OT') THEN 'Y' ELSE 'N' END,
	OTS = CASE WHEN EXISTS(SELECT 1 FROM EEOC_STATUS WHERE VENDOR = V.VN_CODE AND EEOC_CODE = 'O') THEN 'Y' ELSE 'N' END,
	SB = CASE WHEN EXISTS(SELECT 1 FROM EEOC_STATUS WHERE VENDOR = V.VN_CODE AND EEOC_CODE = 'SB') THEN 'Y' ELSE 'N' END,
	SDB = CASE WHEN EXISTS(SELECT 1 FROM EEOC_STATUS WHERE VENDOR = V.VN_CODE AND EEOC_CODE = 'SDB') THEN 'Y' ELSE 'N' END,
	VET = CASE WHEN EXISTS(SELECT 1 FROM EEOC_STATUS WHERE VENDOR = V.VN_CODE AND EEOC_CODE = 'VOSB') THEN 'Y' ELSE 'N' END,
	WBE = CASE WHEN EXISTS(SELECT 1 FROM EEOC_STATUS WHERE VENDOR = V.VN_CODE AND EEOC_CODE = 'WOB') THEN 'Y' ELSE 'N' END,
	WBS = CASE WHEN EXISTS(SELECT 1 FROM EEOC_STATUS WHERE VENDOR = V.VN_CODE AND EEOC_CODE = 'WOSB') THEN 'Y' ELSE 'N' END,
	Ethnicity = VEE.[DESCRIPTION],
	NMSDC = CASE WHEN E.IS_NMSDC = 1 THEN 'Y' ELSE 'N' END,
	NMSDCCertificationNumber = E.MINORITY_CERTIFICATE_NUMBER,
	NMSDCExpirationDate = E.MINORITY_CERTIFICATE_NUMBER_EXP_DATE,
	WBENC = CASE WHEN E.IS_WBENC = 1 THEN 'Y' ELSE 'N' END,
	WBENCCertificationNumber = E.WBENC_CERTIFICATE_NUMBER,
	WBENCExpirationDate = E.WBENC_CERTIFICATE_NUMBER_EXP_DATE,
	TotalSpend = AP.TotalSpend,
	ClientName = OD.CL_NAME,
    InvoiceDate = AP.AP_INV_DATE,
    InvoiceNumber = AP.AP_INV_VCHR,
    InvoiceAmount = AP.TotalSpend,
    DirectSpend = COALESCE(OD.DISBURSED, 0.00),
    IndirectSpend = 0.00,
	AP.AP_ID 
FROM
	(
		SELECT SUM(AP.AP_INV_AMT + COALESCE(AP.AP_SHIPPING,0) + COALESCE(AP.AP_SALES_TAX,0)) AS TotalSpend,
			VN_FRL_EMP_CODE as VN_CODE, AP.AP_ID, AP.AP_INV_DATE, AP.AP_INV_VCHR 
		FROM dbo.AP_HEADER AP
		WHERE AP_ID IN (SELECT AP_ID FROM #APIDS)
		AND COALESCE(MODIFY_FLAG,0) = 0
		AND COALESCE(DELETE_FLAG,0) = 0
        AND EXISTS (SELECT 1 FROM dbo.EEOC_STATUS ES WHERE ES.VENDOR = AP.VN_FRL_EMP_CODE)
		GROUP BY VN_FRL_EMP_CODE, AP_ID, AP.AP_INV_DATE, AP.AP_INV_VCHR
	) AP
		INNER JOIN dbo.VENDOR V ON AP.VN_CODE = V.VN_CODE
		LEFT OUTER JOIN dbo.VENDOR_EEOC2 E ON V.VN_CODE = E.VN_CODE 
		LEFT OUTER JOIN dbo.VENDOR_EEOC2_ETHNICITY VEE ON E.ETHNICITY_ID = VEE.ID
		LEFT OUTER JOIN 
			(
			SELECT SUM(DISBURSED) AS DISBURSED, AP_ID, CL_NAME 
			FROM
				(
				SELECT SUM(COALESCE(AP.AP_PROD_EXT_AMT,0) + COALESCE(AP.EXT_NONRESALE_TAX,0)) AS DISBURSED, AP.AP_ID, C.CL_NAME 
				FROM dbo.AP_PRODUCTION AP
					INNER JOIN #APIDS A ON AP.AP_ID = A.AP_ID AND COALESCE(AP.MODIFY_DELETE,0) = 0
					INNER JOIN dbo.JOB_LOG JL ON JL.JOB_NUMBER = AP.JOB_NUMBER 
					INNER JOIN dbo.CLIENT C ON C.CL_CODE = JL.CL_CODE 
				GROUP BY AP.AP_ID, C.CL_NAME 
				UNION
				SELECT SUM(COALESCE(AP.NET_AMT,0) + COALESCE(AP.DISCOUNT_AMT, 0) + COALESCE(AP.NETCHARGES, 0) + COALESCE(AP.VENDOR_TAX,0)) AS DISBURSED, AP.AP_ID, C.CL_NAME 
				FROM dbo.AP_INTERNET AP
					INNER JOIN #APIDS A ON AP.AP_ID = A.AP_ID AND COALESCE(AP.MODIFY_DELETE,0) = 0
					INNER JOIN dbo.INTERNET_HEADER H ON H.ORDER_NBR = AP.ORDER_NBR 
					INNER JOIN dbo.CLIENT C ON C.CL_CODE = H.CL_CODE 
				GROUP BY AP.AP_ID, C.CL_NAME 
				UNION
				SELECT SUM(COALESCE(AP.DISBURSED_AMT,0)) AS DISBURSED, AP.AP_ID, C.CL_NAME 
				FROM dbo.AP_MAGAZINE AP
					INNER JOIN #APIDS A ON AP.AP_ID = A.AP_ID AND COALESCE(AP.MODIFY_DELETE,0) = 0
					INNER JOIN (
                                SELECT ORDER_NBR, CL_CODE
                                FROM dbo.MAG_HEADER 
                                UNION
                                SELECT ORDER_NBR, CL_CODE
                                FROM dbo.MAGAZINE_HEADER 
                                ) H ON H.ORDER_NBR = AP.ORDER_NBR 
					INNER JOIN dbo.CLIENT C ON C.CL_CODE = H.CL_CODE 
				GROUP BY AP.AP_ID, C.CL_NAME 
				UNION
				SELECT SUM(COALESCE(AP.DISBURSED_AMT,0)) AS DISBURSED, AP.AP_ID, C.CL_NAME 
				FROM dbo.AP_NEWSPAPER AP
					INNER JOIN #APIDS A ON AP.AP_ID = A.AP_ID AND COALESCE(AP.MODIFY_DELETE,0) = 0
					INNER JOIN (
								SELECT ORDER_NBR, CL_CODE
								FROM dbo.NEWS_HEADER  
								UNION 
								SELECT ORDER_NBR, CL_CODE
								FROM dbo.NEWSPAPER_HEADER 
								) H ON H.ORDER_NBR = AP.ORDER_NBR 
					INNER JOIN dbo.CLIENT C ON C.CL_CODE = H.CL_CODE 
				GROUP BY AP.AP_ID, C.CL_NAME 
				UNION
				SELECT SUM(COALESCE(AP.NET_AMT,0) + COALESCE(AP.DISCOUNT_AMT, 0) + COALESCE(AP.NETCHARGES, 0) + COALESCE(AP.VENDOR_TAX,0)) AS DISBURSED, AP.AP_ID, C.CL_NAME 
				FROM dbo.AP_OUTDOOR AP
					INNER JOIN #APIDS A ON AP.AP_ID = A.AP_ID AND COALESCE(AP.MODIFY_DELETE,0) = 0
					INNER JOIN dbo.OUTDOOR_HEADER H ON H.ORDER_NBR = AP.ORDER_NBR 
					INNER JOIN dbo.CLIENT C ON C.CL_CODE = H.CL_CODE 
				GROUP BY AP.AP_ID, C.CL_NAME 
				UNION
				SELECT SUM(COALESCE(AP.EXT_NET_AMT,0) + COALESCE(AP.DISC_AMT, 0) + COALESCE(AP.NETCHARGES, 0) + COALESCE(AP.VENDOR_TAX,0)) AS DISBURSED, AP.AP_ID, C.CL_NAME 
				FROM dbo.AP_RADIO AP
					INNER JOIN #APIDS A ON AP.AP_ID = A.AP_ID AND COALESCE(AP.MODIFY_DELETE,0) = 0
					INNER JOIN (
								SELECT ORDER_NBR, CL_CODE
								FROM dbo.RADIO_HDR 
								UNION 
								SELECT ORDER_NBR, CL_CODE
								FROM dbo.RADIO_HEADER
								) H ON H.ORDER_NBR = AP.ORDER_NBR 
					INNER JOIN dbo.CLIENT C ON C.CL_CODE = H.CL_CODE 
				GROUP BY AP.AP_ID, C.CL_NAME 
				UNION
				SELECT SUM(COALESCE(AP.EXT_NET_AMT,0) + COALESCE(AP.DISC_AMT, 0) + COALESCE(AP.NETCHARGES, 0) + COALESCE(AP.VENDOR_TAX,0)) AS DISBURSED, AP.AP_ID, C.CL_NAME 
				FROM dbo.AP_TV AP
					INNER JOIN #APIDS A ON AP.AP_ID = A.AP_ID AND COALESCE(AP.MODIFY_DELETE,0) = 0
					INNER JOIN (
								SELECT ORDER_NBR, CL_CODE
								FROM dbo.TV_HDR 
								UNION 
								SELECT ORDER_NBR, CL_CODE
								FROM dbo.TV_HEADER
								) H ON H.ORDER_NBR = AP.ORDER_NBR 
					INNER JOIN dbo.CLIENT C ON C.CL_CODE = H.CL_CODE 
				GROUP BY AP.AP_ID, C.CL_NAME 
			) orders
		GROUP BY AP_ID, CL_NAME
		) OD on OD.AP_ID = AP.AP_ID
WHERE COALESCE(OD.DISBURSED, 0.00) <> 0

UNION

SELECT
	ID = NEWID(),
	VendorCode = V.VN_CODE,
	VendorName = V.VN_NAME,
	[Address] = V.VN_ADDRESS1,
	City = V.VN_CITY,
	County = V.VN_COUNTY,
	[State] = V.VN_STATE,
	ZipCode = V.VN_ZIP,
	Country = V.VN_COUNTRY,
	HUBZ = CASE WHEN EXISTS(SELECT 1 FROM EEOC_STATUS WHERE VENDOR = V.VN_CODE AND EEOC_CODE = 'HZSB') THEN 'Y' ELSE 'N' END,
	[IO] = CASE WHEN EXISTS(SELECT 1 FROM EEOC_STATUS WHERE VENDOR = V.VN_CODE AND EEOC_CODE = 'I') THEN 'Y' ELSE 'N' END,
	LGBT = CASE WHEN EXISTS(SELECT 1 FROM EEOC_STATUS WHERE VENDOR = V.VN_CODE AND EEOC_CODE = 'LGBT') THEN 'Y' ELSE 'N' END,
	MBE = CASE WHEN EXISTS(SELECT 1 FROM EEOC_STATUS WHERE VENDOR = V.VN_CODE AND EEOC_CODE = 'MO') THEN 'Y' ELSE 'N' END,
	MISC1 = CASE WHEN EXISTS(SELECT 1 FROM EEOC_STATUS WHERE VENDOR = V.VN_CODE AND EEOC_CODE = 'MISC1') THEN 'Y' ELSE 'N' END,
	MISC2 = CASE WHEN EXISTS(SELECT 1 FROM EEOC_STATUS WHERE VENDOR = V.VN_CODE AND EEOC_CODE = 'MISC2') THEN 'Y' ELSE 'N' END,
	MISC3 = CASE WHEN EXISTS(SELECT 1 FROM EEOC_STATUS WHERE VENDOR = V.VN_CODE AND EEOC_CODE = 'MISC3') THEN 'Y' ELSE 'N' END,
	NA = CASE WHEN EXISTS(SELECT 1 FROM EEOC_STATUS WHERE VENDOR = V.VN_CODE AND EEOC_CODE = 'N') THEN 'Y' ELSE 'N' END,
	OT = CASE WHEN EXISTS(SELECT 1 FROM EEOC_STATUS WHERE VENDOR = V.VN_CODE AND EEOC_CODE = 'OT') THEN 'Y' ELSE 'N' END,
	OTS = CASE WHEN EXISTS(SELECT 1 FROM EEOC_STATUS WHERE VENDOR = V.VN_CODE AND EEOC_CODE = 'O') THEN 'Y' ELSE 'N' END,
	SB = CASE WHEN EXISTS(SELECT 1 FROM EEOC_STATUS WHERE VENDOR = V.VN_CODE AND EEOC_CODE = 'SB') THEN 'Y' ELSE 'N' END,
	SDB = CASE WHEN EXISTS(SELECT 1 FROM EEOC_STATUS WHERE VENDOR = V.VN_CODE AND EEOC_CODE = 'SDB') THEN 'Y' ELSE 'N' END,
	VET = CASE WHEN EXISTS(SELECT 1 FROM EEOC_STATUS WHERE VENDOR = V.VN_CODE AND EEOC_CODE = 'VOSB') THEN 'Y' ELSE 'N' END,
	WBE = CASE WHEN EXISTS(SELECT 1 FROM EEOC_STATUS WHERE VENDOR = V.VN_CODE AND EEOC_CODE = 'WOB') THEN 'Y' ELSE 'N' END,
	WBS = CASE WHEN EXISTS(SELECT 1 FROM EEOC_STATUS WHERE VENDOR = V.VN_CODE AND EEOC_CODE = 'WOSB') THEN 'Y' ELSE 'N' END,
	Ethnicity = VEE.[DESCRIPTION],
	NMSDC = CASE WHEN E.IS_NMSDC = 1 THEN 'Y' ELSE 'N' END,
	NMSDCCertificationNumber = E.MINORITY_CERTIFICATE_NUMBER,
	NMSDCExpirationDate = E.MINORITY_CERTIFICATE_NUMBER_EXP_DATE,
	WBENC = CASE WHEN E.IS_WBENC = 1 THEN 'Y' ELSE 'N' END,
	WBENCCertificationNumber = E.WBENC_CERTIFICATE_NUMBER,
	WBENCExpirationDate = E.WBENC_CERTIFICATE_NUMBER_EXP_DATE,
	TotalSpend = AP.TotalSpend,
	ClientName = '',
    InvoiceDate = AP.AP_INV_DATE,
    InvoiceNumber = AP.AP_INV_VCHR,
    InvoiceAmount = AP.TotalSpend,
    DirectSpend = 0.00,
    IndirectSpend = COALESCE(IndirectAmount, 0.00),
	AP.AP_ID 
FROM
	(
		SELECT SUM(AP.AP_INV_AMT + COALESCE(AP.AP_SHIPPING,0) + COALESCE(AP.AP_SALES_TAX,0)) AS TotalSpend,
			VN_FRL_EMP_CODE as VN_CODE, AP.AP_ID, AP.AP_INV_DATE, AP.AP_INV_VCHR 
		FROM dbo.AP_HEADER AP
		WHERE AP_ID IN (SELECT AP_ID FROM #APIDS)
		AND COALESCE(MODIFY_FLAG,0) = 0
		AND COALESCE(DELETE_FLAG,0) = 0
        AND EXISTS (SELECT 1 FROM dbo.EEOC_STATUS ES WHERE ES.VENDOR = AP.VN_FRL_EMP_CODE)
		GROUP BY VN_FRL_EMP_CODE, AP_ID, AP.AP_INV_DATE, AP.AP_INV_VCHR
	) AP
		INNER JOIN dbo.VENDOR V ON AP.VN_CODE = V.VN_CODE
		LEFT OUTER JOIN dbo.VENDOR_EEOC2 E ON V.VN_CODE = E.VN_CODE 
		LEFT OUTER JOIN dbo.VENDOR_EEOC2_ETHNICITY VEE ON E.ETHNICITY_ID = VEE.ID
		INNER JOIN 
			(SELECT SUM(AP_GL_AMT) as IndirectAmount, AP_ID
			FROM dbo.AP_GL_DIST 
			WHERE MODIFY_DELETE IS NULL
			GROUP BY AP_ID
			) AGD ON AGD.AP_ID = AP.AP_ID 
WHERE COALESCE(IndirectAmount, 0.00) <> 0 

DROP TABLE #APIDS

GO
