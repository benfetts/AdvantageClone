IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[usp_wv_AAMGetUserViewSettings]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[usp_wv_AAMGetUserViewSettings]
GO

/****** Object:  StoredProcedure [dbo].[usp_wv_AAMGetUserViewSettings]    Script Date: 7/21/2020 4:21:43 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[usp_wv_AAMGetUserViewSettings]
	@USER_CODE VARCHAR(100),
	@APPLICATION_NAME VARCHAR(200)	
AS
--BEGIN
--WAITFOR DELAY '00:00:02';
--END
DECLARE @GRID_SIZE INT,
@MAX_ID INT

	BEGIN
		--ELIMINATE DUPLICATE VALUES DUE TO PREVIOUS BUG
		SELECT @MAX_ID = MAX(ID)
		FROM APP_VARS
		WHERE APPLICATION = @APPLICATION_NAME
			AND USERID = @USER_CODE
			AND VARIABLE_NAME = 'AAM_GridSize'

		IF (SELECT COUNT(1) FROM APP_VARS WHERE APPLICATION = @APPLICATION_NAME AND USERID = @USER_CODE AND VARIABLE_NAME = 'AAM_GridSize') > 1
			DELETE FROM APP_VARS
			WHERE APPLICATION = @APPLICATION_NAME
				AND USERID = @USER_CODE
				AND VARIABLE_NAME = 'AAM_GridSize'	
				AND ID < @MAX_ID

		--CLEAN UP BAD GRID SIZE VALUES FROM PREVIOUS BUG		
		SELECT @GRID_SIZE = VARIABLE_VALUE
		FROM APP_VARS
		WHERE APPLICATION = @APPLICATION_NAME
			AND USERID = @USER_CODE
			AND VARIABLE_NAME = 'AAM_GridSize'		
		
		IF @GRID_SIZE NOT IN (10, 15, 20, 50, 100, 200)
			DELETE FROM APP_VARS
			WHERE APPLICATION = @APPLICATION_NAME
				AND USERID = @USER_CODE
				AND VARIABLE_NAME = 'AAM_GridSize'				

	END

	BEGIN
		SELECT VARIABLE_NAME AS	SettingName, ISNULL(VARIABLE_VALUE,'') AS SettingValue 
		FROM APP_VARS WITH(NOLOCK) 
		WHERE USERID = @USER_CODE AND APPLICATION = @APPLICATION_NAME
		AND VARIABLE_VALUE IS NOT NULL AND LEN(VARIABLE_VALUE) > 0
		AND VARIABLE_NAME like 'AAM_%'
	END