IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[usp_wv_AAMUpdateUserViewSettings]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[usp_wv_AAMUpdateUserViewSettings]
GO

/****** Object:  StoredProcedure [dbo].[usp_wv_AAMUpdateUserViewSettings]    Script Date: 7/21/2020 4:21:43 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[usp_wv_AAMUpdateUserViewSettings]
	@USER_CODE VARCHAR(100),
	@APPLICATION_NAME VARCHAR(200),	
	@SETTING_NAME VARCHAR(200),
	@SETTING_VALUE VARCHAR(200)
AS
	IF EXISTS (SELECT 1 FROM APP_VARS WITH(NOLOCK) WHERE USERID = @USER_CODE AND APPLICATION = @APPLICATION_NAME
			AND VARIABLE_VALUE IS NOT NULL AND LEN(VARIABLE_VALUE) > 0
			AND VARIABLE_NAME = @SETTING_NAME)
		BEGIN
			IF ((@SETTING_NAME = 'AAM_GridSize' AND CONVERT(INT, @SETTING_VALUE) = 10))
				OR (@SETTING_NAME = 'AAM_ShowOnlyCompletedTasks' AND CONVERT(bit, @SETTING_VALUE) = 0)
				OR (@SETTING_NAME NOT IN ('AAM_GridSize', 'AAM_ShowCompletedTasks') AND LEN(@SETTING_VALUE) < 1)

				BEGIN
					DELETE FROM APP_VARS
					WHERE APPLICATION = @APPLICATION_NAME
						AND USERID = @USER_CODE
						AND VARIABLE_NAME = @SETTING_NAME
				END			
			ELSE
				BEGIN
					UPDATE APP_VARS WITH(ROWLOCK)
						SET VARIABLE_VALUE = @SETTING_VALUE
					WHERE APPLICATION = @APPLICATION_NAME
						AND USERID = @USER_CODE
						AND VARIABLE_NAME = @SETTING_NAME;
				END			
		END
	ELSE
		BEGIN
			IF ((@SETTING_NAME = 'AAM_GridSize' AND CONVERT(INT, @SETTING_VALUE) != 10))
				OR (@SETTING_NAME = 'AAM_ShowOnlyCompletedTasks' AND CONVERT(bit, @SETTING_VALUE) = 1)
				OR (@SETTING_NAME NOT IN ('AAM_GridSize', 'AAM_ShowCompletedTasks') AND LEN(@SETTING_VALUE) > 0)

				BEGIN
					INSERT INTO APP_VARS WITH(ROWLOCK)
					VALUES(@USER_CODE, @APPLICATION_NAME, 0, @SETTING_NAME, '', NULL, @SETTING_VALUE);
				END
			
		END