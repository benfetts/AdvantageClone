UPDATE MBWMSDD SET MAKEGOOD_SPOTS = MBWMSD.MAKEGOOD_SPOTS 
FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL_DATE MBWMSDD
	INNER JOIN dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL MBWMSD ON MBWMSDD.MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL_ID = MBWMSD.MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL_ID AND
																			 MBWMSDD.[DATE] = MBWMSD.MAKEGOOD_DATE 

SELECT MAX(REVISED_DATE) as MAX_REVISED_DATE, ORDER_NBR
INTO #LATEST_TV
FROM dbo.TV_ORDER_STATUS 
WHERE ORDER_NBR IN (SELECT DISTINCT ORDER_NBR FROM dbo.TV_ORDER_STATUS WHERE [STATUS] = 16)
GROUP BY ORDER_NBR

SELECT MAX(REVISED_DATE) as MAX_REVISED_DATE, ORDER_NBR
INTO #LATEST_RADIO
FROM dbo.RADIO_ORDER_STATUS 
WHERE ORDER_NBR IN (SELECT DISTINCT ORDER_NBR FROM dbo.RADIO_ORDER_STATUS WHERE [STATUS] = 16)
GROUP BY ORDER_NBR

--SELECT * FROM #LATEST_TV

--SELECT COUNT(1), tos.ORDER_NBR, tos.[STATUS]
--FROM #LATEST_TV l
--	INNER JOIN dbo.TV_ORDER_STATUS tos ON l.ORDER_NBR = tos.ORDER_NBR AND l.MAX_REVISED_DATE = tos.REVISED_DATE 
--GROUP BY tos.ORDER_NBR, tos.[STATUS]
--HAVING tos.[STATUS] = 16

UPDATE MBWMSD SET IS_SUBMITTED = 1
FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL MBWMSD
WHERE MBWMSD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID IN (
	SELECT
		--MediaBroadcastWorksheetID = MBW.MEDIA_BROADCAST_WORKSHEET_ID, 
		--MediaBroadcastWorksheetMarketID = MBWM.MEDIA_BROADCAST_WORKSHEET_MARKET_ID,
		dtl.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID
	FROM dbo.MEDIA_BROADCAST_WORKSHEET MBW
		INNER JOIN dbo.MEDIA_BROADCAST_WORKSHEET_MARKET MBWM ON MBW.MEDIA_BROADCAST_WORKSHEET_ID = MBWM.MEDIA_BROADCAST_WORKSHEET_ID 
		INNER JOIN (
			SELECT MBWMD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID, MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID --, MAX(MBWMD.REVISION_NUMBER) as MAXREV, 
			FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL MBWMD
			WHERE MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID IN (
				SELECT DISTINCT MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID
				FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_DATE MBWMDD
				WHERE
					MBWMDD.ORDER_NBR IN (
										SELECT ORDER_NBR
										FROM (
											SELECT COUNT(1) as mycount, tos.ORDER_NBR, tos.[STATUS]
											FROM #LATEST_TV l
												INNER JOIN dbo.TV_ORDER_STATUS tos ON l.ORDER_NBR = tos.ORDER_NBR AND l.MAX_REVISED_DATE = tos.REVISED_DATE 
											GROUP BY tos.ORDER_NBR, tos.[STATUS]
											HAVING tos.[STATUS] = 16) mgs

										UNION

										SELECT ORDER_NBR
										FROM (
											SELECT COUNT(1) as mycount, tos.ORDER_NBR, tos.[STATUS]
											FROM #LATEST_RADIO l
												INNER JOIN dbo.RADIO_ORDER_STATUS tos ON l.ORDER_NBR = tos.ORDER_NBR AND l.MAX_REVISED_DATE = tos.REVISED_DATE 
											GROUP BY tos.ORDER_NBR, tos.[STATUS]
											HAVING tos.[STATUS] = 16) mgs
										)
				)
			GROUP BY MBWMD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID, MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID
			) dtl ON dtl.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = MBWM.MEDIA_BROADCAST_WORKSHEET_MARKET_ID
	)
AND EXISTS(SELECT 1 FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL 
			WHERE MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID = MBWMSD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID
			AND IS_ORIGINAL = 0)

drop table #LATEST_TV
drop table #LATEST_RADIO
