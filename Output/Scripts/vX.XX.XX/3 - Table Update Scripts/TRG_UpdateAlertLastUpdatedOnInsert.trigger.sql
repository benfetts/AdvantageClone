IF EXISTS (SELECT * FROM sys.triggers WHERE object_id = OBJECT_ID(N'[dbo].[TRG_UpdateAlertLastUpdatedOnInsert]'))
	DROP TRIGGER [dbo].[TRG_UpdateAlertLastUpdatedOnInsert]
GO
CREATE TRIGGER [dbo].[TRG_UpdateAlertLastUpdatedOnInsert] ON [dbo].[ALERT_COMMENT]
AFTER INSERT AS
BEGIN
	DECLARE @ALERT_ID INT, @LAST_UPDATED SMALLDATETIME, @USER_CODE VARCHAR(100), @USER_FML VARCHAR(80), @CP_ALERT SMALLINT, @CURR_ASSIGNED_EMP_CODE VARCHAR(6), @THIS_COMMENT_ID INT
	SELECT TOP 1 @ALERT_ID = ISNULL(ALERT_ID, 0), @LAST_UPDATED = GENERATED_DATE, @USER_CODE = USER_CODE, @CURR_ASSIGNED_EMP_CODE = ASSIGNED_EMP_CODE, @THIS_COMMENT_ID = COMMENT_ID FROM inserted;
	IF (@ALERT_ID > 0)
	BEGIN
		SELECT @CP_ALERT = ISNULL(CP_ALERT, 0) FROM ALERT WITH(NOLOCK) WHERE ALERT_ID = @ALERT_ID;
		IF @CP_ALERT = 0
		BEGIN
			SELECT @USER_FML =
				(SELECT 
					TOP 1 ISNULL(RTRIM(EMPLOYEE.EMP_FNAME) + ' ', '') + ISNULL(EMPLOYEE.EMP_MI + '. ', '') + ISNULL(EMPLOYEE.EMP_LNAME, '') 
				FROM 
					EMPLOYEE WITH(NOLOCK) 
					INNER JOIN SEC_USER WITH(NOLOCK) ON SEC_USER.EMP_CODE = EMPLOYEE.EMP_CODE 
				WHERE	
					SEC_USER.USER_CODE = @USER_CODE
				ORDER BY
					SEC_USER.SEC_USER_ID DESC)
		END
		ELSE
		BEGIN
			IF ISNUMERIC(@USER_CODE) = 1
			BEGIN
				SELECT @USER_FML = CONT_FML FROM CDP_CONTACT_HDR WITH (NOLOCK) WHERE  CDP_CONTACT_ID = CAST(@USER_CODE AS INT);
			END
		END
		UPDATE ALERT WITH(ROWLOCK) SET LAST_UPDATED = GETDATE(), LAST_UPDATED_USER_CODE = @USER_CODE, LAST_UPDATED_FML = @USER_FML WHERE ALERT_ID = @ALERT_ID;
		IF @CURR_ASSIGNED_EMP_CODE IS NULL
		BEGIN
			SELECT @CURR_ASSIGNED_EMP_CODE = ASSIGNED_EMP_CODE FROM ALERT WITH(NOLOCK) WHERE ALERT_ID = @ALERT_ID;
			IF NOT @CURR_ASSIGNED_EMP_CODE IS NULL
			BEGIN
				UPDATE ALERT_COMMENT WITH(ROWLOCK) SET ASSIGNED_EMP_CODE = @CURR_ASSIGNED_EMP_CODE WHERE COMMENT_ID = @THIS_COMMENT_ID;
			END
		END
	END
END
GO


