IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[advsp_agile_get_emp_work_items]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
    DROP PROCEDURE [dbo].[advsp_agile_get_emp_work_items]
GO

CREATE PROCEDURE [dbo].[advsp_agile_get_emp_work_items]
@EMP_CODE VARCHAR(6),
@JOB_NUMBER INT,
@JOB_COMPONENT_NBR SMALLINT,
@INCL_CLOSED BIT
AS
/*=========== QUERY ===========*/
BEGIN

	SET @INCL_CLOSED = ISNULL(@INCL_CLOSED, 0);

	DECLARE @DATA TABLE (ID INT IDENTITY, ALERT_ID INT, [DESCRIPTION] VARCHAR(MAX), IS_TASK BIT, JOB_NUMBER INT, JOB_COMPONENT_NBR SMALLINT, TASK_SEQ_NBR SMALLINT, PARENT_TASK_SEQ_NBR SMALLINT);
	DECLARE @PARENT_TASKS TABLE (ID INT IDENTITY, JOB_NUMBER INT, JOB_COMPONENT_NBR SMALLINT, TASK_SEQ_NBR SMALLINT);

	INSERT INTO @DATA (ALERT_ID, [DESCRIPTION], IS_TASK, JOB_NUMBER, JOB_COMPONENT_NBR, TASK_SEQ_NBR, PARENT_TASK_SEQ_NBR)
	SELECT DISTINCT 
		A.ALERT_ID,
		A.[SUBJECT],
		CASE
			WHEN A.ALERT_CAT_ID = 71 THEN CAST(1 AS BIT)
			ELSE CAST(0 AS BIT)
		END,
		A.JOB_NUMBER,
		A.JOB_COMPONENT_NBR,
		A.TASK_SEQ_NBR,
		J.PARENT_TASK_SEQ
	FROM
		ALERT A WITH (NOLOCK)
		LEFT OUTER JOIN JOB_TRAFFIC_DET J WITH (NOLOCK) ON A.JOB_NUMBER = J.JOB_NUMBER AND A.JOB_COMPONENT_NBR = J.JOB_COMPONENT_NBR AND A.TASK_SEQ_NBR = J.SEQ_NBR
	WHERE 
		A.IS_WORK_ITEM = 1
		AND 1 = CASE
					WHEN @JOB_NUMBER > 0 AND A.JOB_NUMBER = @JOB_NUMBER THEN 1
					ELSE 0
				END
		AND 1 = CASE
					WHEN @JOB_COMPONENT_NBR > 0 AND A.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR THEN 1
					ELSE 0
				END
		AND 1 = CASE
					WHEN @INCL_CLOSED = 0 AND A.ASSIGN_COMPLETED = 1 THEN 0
					WHEN @INCL_CLOSED = 0 AND NOT A.JOB_NUMBER IS NULL AND NOT A.JOB_COMPONENT_NBR IS NULL AND NOT A.TASK_SEQ_NBR IS NULL AND NOT J.JOB_COMPLETED_DATE IS NULL THEN 0
					ELSE 1
				END
		AND (A.IS_DRAFT IS NULL OR A.IS_DRAFT = 0)
	ORDER BY
		A.[SUBJECT];
	INSERT INTO @PARENT_TASKS
	SELECT
		D.JOB_NUMBER,
		D.JOB_COMPONENT_NBR,
		D.PARENT_TASK_SEQ_NBR
	FROM
		@DATA D
	WHERE
		D.PARENT_TASK_SEQ_NBR IS NOT NULL;
	DELETE @DATA
	FROM
		@PARENT_TASKS P
		INNER JOIN @DATA D ON P.JOB_NUMBER = D.JOB_NUMBER AND P.JOB_COMPONENT_NBR = D.JOB_COMPONENT_NBR AND P.TASK_SEQ_NBR = D.TASK_SEQ_NBR;	
	SELECT
		[AlertID] = D.ALERT_ID,
		[Description] = D.[DESCRIPTION]
	FROM
		@DATA D;
END
/*=========== QUERY ===========*/