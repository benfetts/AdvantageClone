IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[advsp_alert_validate_attachment_download]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
    DROP PROCEDURE [dbo].[advsp_alert_validate_attachment_download]
GO
CREATE PROCEDURE [dbo].[advsp_alert_validate_attachment_download] /*WITH ENCRYPTION*/
@ALERT_ID INT,
@DOCUMENT_ID INT,
@FILENAME VARCHAR(300)
AS
/*=========== QUERY ===========*/
BEGIN
	--	VARIABLES
	BEGIN
		DECLARE
			@HAS_REC AS BIT,
			@RETURN_MESSAGE AS VARCHAR(1000)
			;
	END
	--	INIT
	BEGIN
		SELECT 
			@HAS_REC = 0,
			@RETURN_MESSAGE = '';
	END
	-- VALIDATE
	BEGIN
		IF EXISTS (SELECT 1 FROM DOCUMENTS D WITH(NOLOCK) WHERE D.DOCUMENT_ID = @DOCUMENT_ID)
		BEGIN
			IF EXISTS (SELECT 1 FROM DOCUMENTS D WITH(NOLOCK) WHERE D.DOCUMENT_ID = @DOCUMENT_ID AND D.[FILENAME] = @FILENAME)
			BEGIN
				IF EXISTS (SELECT 1 FROM ALERT A WITH(NOLOCK) WHERE ALERT_ID = @ALERT_ID)
				BEGIN
					IF EXISTS (SELECT 1 FROM ALERT_ATTACHMENT X WITH(NOLOCK) WHERE X.ALERT_ID = @ALERT_ID AND X.DOCUMENT_ID = @DOCUMENT_ID)
					BEGIN
						SELECT @HAS_REC = 1;
					END
					IF @HAS_REC = 0
					BEGIN
						DECLARE
							@ALERT_LEVEL VARCHAR(50),
							@OFFICE_CODE VARCHAR(4),
							@CL_CODE VARCHAR(6),
							@DIV_CODE VARCHAR(6),
							@PRD_CODE VARCHAR(6),
							@JOB_NUMBER INT,
							@JOB_COMPONENT_NBR SMALLINT,
							@TASK_SEQ_NBR SMALLINT
							;
						SELECT
							@ALERT_LEVEL = A.ALERT_LEVEL,
							@OFFICE_CODE = A.OFFICE_CODE,
							@CL_CODE = A.CL_CODE,
							@DIV_CODE = A.DIV_CODE,
							@PRD_CODE = A.PRD_CODE,
							@JOB_NUMBER = A.JOB_NUMBER,
							@JOB_COMPONENT_NBR = A.JOB_COMPONENT_NBR,
							@TASK_SEQ_NBR = A.TASK_SEQ_NBR
						FROM
							ALERT A WITH(NOLOCK)
						WHERE
							A.ALERT_ID = @ALERT_ID;
						IF RTRIM(LTRIM(@ALERT_LEVEL)) = '' OR DATALENGTH(@ALERT_LEVEL) = 0
						BEGIN
							SELECT @HAS_REC = 1;
						END
						IF @HAS_REC = 0 AND (@ALERT_LEVEL = 'BRD' OR @ALERT_LEVEL = 'PST')
						BEGIN
							IF EXISTS (SELECT 1 FROM JOB_TRAFFIC_DET_DOCS X WITH(NOLOCK) WHERE X.DOCUMENT_ID = @DOCUMENT_ID AND X.JOB_NUMBER = @JOB_NUMBER AND X.JOB_COMPONENT_NBR = @JOB_COMPONENT_NBR AND X.SEQ_NBR = @TASK_SEQ_NBR)
							BEGIN
								SELECT @HAS_REC = 1;
							END
						END
						IF @HAS_REC = 0 AND @ALERT_LEVEL = 'JC'
						BEGIN
							IF EXISTS (SELECT 1 FROM JOB_COMPONENT_DOCUMENTS X WITH(NOLOCK) WHERE X.DOCUMENT_ID = @DOCUMENT_ID AND X.JOB_NUMBER = @JOB_NUMBER AND X.JOB_COMPONENT_NUMBER = @JOB_COMPONENT_NBR)
							BEGIN
								SELECT @HAS_REC = 1;
							END
						END
						IF @HAS_REC = 0 AND (@ALERT_LEVEL = 'JO' OR @ALERT_LEVEL = 'J')
						BEGIN
							IF EXISTS (SELECT 1 FROM JOB_DOCUMENTS X WITH(NOLOCK) WHERE X.DOCUMENT_ID = @DOCUMENT_ID AND X.JOB_NUMBER = @JOB_NUMBER)
							BEGIN
								SELECT @HAS_REC = 1;
							END
						END
						IF @HAS_REC = 0 AND @ALERT_LEVEL = 'OF' OR @ALERT_LEVEL = 'O'
						BEGIN
							IF EXISTS (SELECT 1 FROM OFFICE_DOCUMENTS X WITH(NOLOCK) WHERE X.DOCUMENT_ID = @DOCUMENT_ID AND X.OFFICE_CODE = @OFFICE_CODE)
							BEGIN
								SELECT @HAS_REC = 1;
							END
						END
						IF @HAS_REC = 0 AND @ALERT_LEVEL = 'CL' OR @ALERT_LEVEL = 'C'
						BEGIN
							IF EXISTS (SELECT 1 FROM CLIENT_DOCUMENTS X WITH(NOLOCK) WHERE X.DOCUMENT_ID = @DOCUMENT_ID AND X.CL_CODE = @CL_CODE)
							BEGIN
								SELECT @HAS_REC = 1;
							END
						END
						IF @HAS_REC = 0 AND (@ALERT_LEVEL = 'DIV' OR @ALERT_LEVEL = 'DI' OR @ALERT_LEVEL = 'D')
						BEGIN
							IF EXISTS (SELECT 1 FROM DIVISION_DOCUMENTS X WITH(NOLOCK) WHERE X.DOCUMENT_ID = @DOCUMENT_ID AND X.CL_CODE = @CL_CODE AND X.DIV_CODE = @DIV_CODE)
							BEGIN
								SELECT @HAS_REC = 1;
							END
						END
						IF @HAS_REC = 0 AND (@ALERT_LEVEL = 'PRD' OR @ALERT_LEVEL = 'PR' OR @ALERT_LEVEL = 'P')
						BEGIN
							IF EXISTS (SELECT 1 FROM PRODUCT_DOCUMENTS X WITH(NOLOCK) WHERE X.DOCUMENT_ID = @DOCUMENT_ID AND X.CL_CODE = @CL_CODE AND X.DIV_CODE = @DIV_CODE AND X.PRD_CODE = @PRD_CODE)
							BEGIN
								SELECT @HAS_REC = 1;
							END
						END
					END
				END
				ELSE
				BEGIN
					SELECT 
						@HAS_REC = 0,
						@RETURN_MESSAGE = 'Alert does not exist.';
				END
			END
			ELSE
			BEGIN
				SELECT
					@HAS_REC = 0,
					@RETURN_MESSAGE = 'Filename does not match document ID filename.'
			END
		END
		ELSE
		BEGIN
			SELECT 
				@HAS_REC = 0,
				@RETURN_MESSAGE = 'Document does not exist.'
		END
	END
	-- CLEAN UP
	BEGIN
		IF @HAS_REC = 1
		BEGIN
			SELECT
				@RETURN_MESSAGE = '';
		END
	END
	--	RETURN
	BEGIN
		SELECT @RETURN_MESSAGE;
	END
END/*=========== QUERY ===========*/
