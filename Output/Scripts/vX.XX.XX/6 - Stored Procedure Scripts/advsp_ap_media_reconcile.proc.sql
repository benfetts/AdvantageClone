/****** Object:  StoredProcedure [dbo].[advsp_ap_media_reconcile]    Script Date: 09/05/2014 09:03:32 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[advsp_ap_media_reconcile]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[advsp_ap_media_reconcile]
GO

CREATE PROCEDURE [dbo].[advsp_ap_media_reconcile] 
	@media_type_p varchar(10), 
	@reconcile_method_p varchar(10), 
	@reconcile_by_p varchar(10),
	@start_date smalldatetime,
	@end_date smalldatetime,
	@complete int
AS

/* PJH 03/22/16 - added "AND D.BILL_TYPE_FLAG <> 1" */
/* PJH 09/17/18 - added AND D.LINE_CANCELLED IS NULL */

BEGIN
	SET NOCOUNT ON;
	
	DECLARE @AP_MEDIA_TMP TABLE
	(
		[ID] INT IDENTITY(1,1) PRIMARY KEY,
		[ORDER_NBR] [int] NOT NULL,
		MONTH_GRP varchar(2) NOT NULL,
		YEAR_GRP varchar(4) NOT NULL,
		[NET_AMT] [decimal](14, 2) NULL,	
		[GROSS_AMT] [decimal](14, 2) NULL,	
		[COMM_AMT] [decimal](14, 2) NULL,	
		[REBATE_AMT] [decimal](14, 2) NULL,
		[NETCHARGES] [decimal](14, 2) NULL,
		[DISCOUNT_AMT] [decimal](14, 2) NULL,	
		[VENDOR_TAX] [decimal](14, 2) NULL,
		[STATE_TAX] [decimal](14, 2) NULL,
		[COUNTY_TAX] [decimal](14, 2) NULL,
		[CITY_TAX] [decimal](14, 2) NULL	,
		[IMPRESSIONS]  [int] NULL	
	) 	
	
		DECLARE @AP_MEDIA_TMP2 TABLE
	(
		[ID] INT IDENTITY(1,1) PRIMARY KEY,
		[ORDER_NBR] [int] NOT NULL,
		MONTH_GRP varchar(2) NOT NULL,
		YEAR_GRP varchar(4) NOT NULL,
		[NET_AMT] [decimal](14, 2) NULL,	
		[GROSS_AMT] [decimal](14, 2) NULL,	
		[COMM_AMT] [decimal](14, 2) NULL,	
		[REBATE_AMT] [decimal](14, 2) NULL,
		[NETCHARGES] [decimal](14, 2) NULL,
		DISCOUNT_LN [decimal](14, 2) NULL,	
		[VENDOR_TAX] [decimal](14, 2) NULL,
		[STATE_TAX] [decimal](14, 2) NULL,
		[COUNTY_TAX] [decimal](14, 2) NULL,
		[CITY_TAX] [decimal](14, 2) NULL		,
		[IMPRESSIONS]  [int] NULL	
	) 	
	
	DECLARE @ORDER_MEDIA_TMP TABLE
	(
		[ID] INT IDENTITY(1,1) PRIMARY KEY,
		[ORDER_NBR] [int] NOT NULL,
		MONTH_GRP varchar(2) NOT NULL,
		YEAR_GRP varchar(4) NOT NULL,
		[EXT_NET_AMT] [decimal](14, 2) NULL,	
		[BILLING_AMT] [decimal](14, 2) NULL,	
		[NETCHARGE] [decimal](14, 2) NULL,
		[NON_RESALE_AMT] [decimal](14, 2) NULL,		
		[DISCOUNT_AMT] [decimal](14, 2) NULL,	
		[ADDL_CHARGE] [decimal](14, 2) NULL,
		[MODIFIED_COMMENTS] [varchar](254) NULL,
		[RECONCILE_FLAG] [smallint] NULL,
		[IMPRESSIONS]  [int] NULL	
	) 	
	
	DECLARE @ORDER_MEDIA_TMP2 TABLE
	(
		[ID] INT IDENTITY(1,1) PRIMARY KEY,
		[ORDER_NBR] [int] NOT NULL,
		MONTH_GRP varchar(2) NOT NULL,
		YEAR_GRP varchar(4) NOT NULL,
		[EXT_NET_AMT] [decimal](14, 2) NULL,	
		[BILLING_AMT] [decimal](14, 2) NULL,	
		[NETCHARGE] [decimal](14, 2) NULL,
		[NON_RESALE_AMT] [decimal](14, 2) NULL,		
		[DISCOUNT_AMT] [decimal](14, 2) NULL,	
		[ADDL_CHARGE] [decimal](14, 2) NULL,
		[MODIFIED_COMMENTS] [varchar](254) NULL,
		[RECONCILE_FLAG] [smallint] NULL,
		[IMPRESSIONS] [int] NULL,
		[CL_CODE] varchar(6), [DIV_CODE] varchar(6), [PRD_CODE] varchar(6),  [CMP_CODE] varchar(6),  [VN_CODE] varchar(6), CLIENT_PO varchar(25), LOCKED varchar(1)
	) 	
	
	DECLARE @include varchar(1)

	IF @complete <> 1 BEGIN
		SET @complete = NULL
	END
	
	SET @include = RIGHT(@reconcile_by_p, 1) /* 'O' All Orders or 'V' AP Variance */
	SET @reconcile_by_p = LEFT(@reconcile_by_p, 1)  /* 'L' Line, 'M' Month, 'O' Order */
	
	/***** START CODE *****/
	IF @reconcile_by_p = 'M' BEGIN  ------------ MONTHLY RECONCILE
		IF 	@media_type_p = 'I' BEGIN
			INSERT INTO @AP_MEDIA_TMP --AP
			SELECT AD.ORDER_NBR, SUBSTRING(CONVERT(VARCHAR(10), D.START_DATE, 112), 5,2) MONTH_GRP, SUBSTRING(CONVERT(VARCHAR(10), D.START_DATE, 112), 1,4) YEAR_GRP,
			--COALESCE(AD.NET_AMT, 0) AS NET_AMT, 
			COALESCE((AD.NET_AMT), 0) + COALESCE((AD.NETCHARGES), 0) + COALESCE((AD.VENDOR_TAX), 0) + COALESCE((AD.DISCOUNT_AMT), 0) AS NET_AMT, 
			COALESCE((AD.NET_AMT), 0) + COALESCE((AD.NETCHARGES), 0) + COALESCE((AD.VENDOR_TAX), 0) + COALESCE((AD.DISCOUNT_AMT), 0) + COALESCE(AD.COMM_AMT,0) AS GROSS_AMT, 
			COALESCE(AD.COMM_AMT, 0) AS COMM_AMT,
			COALESCE(AD.REBATE_AMT, 0) AS REBATE_AMT,
			COALESCE(AD.NETCHARGES, 0) AS NETCHARGES,
			COALESCE(AD.DISCOUNT_AMT, 0) AS DISCOUNT_LN,			
			COALESCE(AD.VENDOR_TAX, 0) AS VENDOR_TAX,
			COALESCE(AD.STATE_TAX, 0) AS STATE_TAX,
			COALESCE(AD.COUNTY_TAX, 0) AS COUNTY_TAX,
			COALESCE(AD.CITY_TAX, 0) AS CITY_TAX,
			COALESCE(AD.IMPRESSIONS, 0) AS IMPRESSIONS
			FROM INTERNET_DETAIL D, AP_INTERNET AD
			WHERE D.ORDER_NBR = AD.ORDER_NBR AND D.LINE_NBR = AD.ORDER_LINE_NBR AND 
				AD.MODIFY_DELETE IS NULL AND D.ACTIVE_REV = 1 AND D.BILL_TYPE_FLAG <> 1 AND
				D.START_DATE BETWEEN @start_date AND @end_date;
			
			INSERT INTO @ORDER_MEDIA_TMP --ORDER
			SELECT D.ORDER_NBR, SUBSTRING(CONVERT(VARCHAR(10), D.START_DATE, 112), 5,2) MONTH_GRP, SUBSTRING(CONVERT(VARCHAR(10), D.START_DATE, 112), 1,4) YEAR_GRP, 
								COALESCE(D.EXT_NET_AMT, 0) EXT_NET_AMT,   
								COALESCE(D.BILLING_AMT, 0) BILLING_AMT,
								COALESCE(D.NETCHARGE, 0) NETCHARGE,
								COALESCE(D.NON_RESALE_AMT, 0) NON_RESALE_AMT,
								COALESCE(D.DISCOUNT_AMT, 0) DISCOUNT_AMT,
								COALESCE(D.ADDL_CHARGE, 0) ADDL_CHARGE, 
								COALESCE(D.MODIFIED_COMMENTS,''),  COALESCE(D.RECONCILE_FLAG,0),
								CASE 
									WHEN (D.COST_TYPE = 'NA') THEN 0 
									WHEN D.ACT_IMPRESSIONS IS NOT NULL THEN D.ACT_IMPRESSIONS
									ELSE COALESCE(D.GUARANTEED_IMPRESS,0)
								END AS IMPRESSIONS
			FROM INTERNET_DETAIL D INNER JOIN INTERNET_HEADER H ON D.ORDER_NBR = H.ORDER_NBR
								WHERE D.ACTIVE_REV = 1 AND (@complete IS NULL OR H.COMPLETE = @complete) AND D.BILL_TYPE_FLAG <> 1
									AND D.START_DATE BETWEEN @start_date AND @end_date
									AND D.LINE_CANCELLED IS NULL;				/* PJH 04/30/21 - check for cancelled */
		END ---INET
		ELSE IF 	@media_type_p = 'T' BEGIN
			INSERT INTO @AP_MEDIA_TMP
			SELECT AD.ORDER_NBR, RIGHT('00' + CONVERT(VARCHAR(2), D.MONTH_NBR), 2) MONTH_GRP, RIGHT('0000' + CONVERT(VARCHAR(4), D.YEAR_NBR), 4) YEAR_GRP, 
			COALESCE((AD.DISC_AMT), 0) + COALESCE((AD.NETCHARGES), 0) + COALESCE((AD.VENDOR_TAX), 0) + COALESCE((AD.DISC_AMT), 0) AS NET_AMT, 
			COALESCE((AD.DISC_AMT), 0) + COALESCE((AD.NETCHARGES), 0) + COALESCE((AD.VENDOR_TAX), 0) + COALESCE((AD.DISC_AMT), 0) + COALESCE(AD.COMM_AMT,0) AS GROSS_AMT, 
			COALESCE(AD.COMM_AMT, 0) AS COMM_AMT,
			COALESCE(AD.REBATE_AMT, 0) AS REBATE_AMT,
			COALESCE(AD.NETCHARGES, 0) AS NETCHARGES,
			COALESCE(AD.DISC_AMT, 0) AS DISCOUNT_LN,			
			COALESCE(AD.VENDOR_TAX, 0) AS VENDOR_TAX,
			COALESCE(AD.STATE_TAX, 0) AS STATE_TAX,
			COALESCE(AD.COUNTY_TAX, 0) AS COUNTY_TAX,
			COALESCE(AD.CITY_TAX, 0) AS CITY_TAX,
			COALESCE(AD.TOTAL_SPOTS,0) AS IMPRESSIONS
			FROM TV_DETAIL D, AP_TV AD
			WHERE D.ORDER_NBR = AD.ORDER_NBR AND D.LINE_NBR = AD.ORDER_LINE_NBR AND 
				AD.MODIFY_DELETE IS NULL AND D.ACTIVE_REV = 1 AND D.BILL_TYPE_FLAG <> 1 AND
				D.START_DATE BETWEEN @start_date AND @end_date;
			
			INSERT INTO @ORDER_MEDIA_TMP
			SELECT D.ORDER_NBR, RIGHT('00' + CONVERT(VARCHAR(2), D.MONTH_NBR), 2) MONTH_GRP, RIGHT('0000' + CONVERT(VARCHAR(4), D.YEAR_NBR), 4) YEAR_GRP, 
								COALESCE(D.EXT_NET_AMT, 0) EXT_NET_AMT,   
								COALESCE(D.BILLING_AMT, 0) BILLING_AMT,
								COALESCE(D.NETCHARGE, 0) NETCHARGE,
								COALESCE(D.NON_RESALE_AMT, 0) NON_RESALE_AMT,
								COALESCE(D.DISCOUNT_AMT, 0) DISCOUNT_AMT,
								COALESCE(D.ADDL_CHARGE, 0) ADDL_CHARGE, 
								COALESCE(D.MODIFIED_COMMENTS,''),  COALESCE(D.RECONCILE_FLAG,0),
								COALESCE(D.TOTAL_SPOTS,0) AS IMPRESSIONS
			FROM TV_DETAIL D
								WHERE D.ACTIVE_REV = 1	AND D.BILL_TYPE_FLAG <> 1
									/* PJH 09/17/18 - added AND D.LINE_CANCELLED IS NULL */
									AND D.LINE_CANCELLED IS NULL
									AND D.START_DATE BETWEEN @start_date AND @end_date
									AND D.LINE_CANCELLED IS NULL;				/* PJH 04/30/21 - check for cancelled */			
		END ---INET
		ELSE IF 	@media_type_p = 'R' BEGIN
			INSERT INTO @AP_MEDIA_TMP
			SELECT AD.ORDER_NBR, RIGHT('00' + CONVERT(VARCHAR(2), D.MONTH_NBR), 2) MONTH_GRP, RIGHT('0000' + CONVERT(VARCHAR(4), D.YEAR_NBR), 4) YEAR_GRP, 
			COALESCE((AD.DISC_AMT), 0) + COALESCE((AD.NETCHARGES), 0) + COALESCE((AD.VENDOR_TAX), 0) + COALESCE((AD.DISC_AMT), 0) AS NET_AMT, 
			COALESCE((AD.DISC_AMT), 0) + COALESCE((AD.NETCHARGES), 0) + COALESCE((AD.VENDOR_TAX), 0) + COALESCE((AD.DISC_AMT), 0) + COALESCE(AD.COMM_AMT,0) AS GROSS_AMT, 
			COALESCE(AD.COMM_AMT, 0) AS COMM_AMT,
			COALESCE(AD.REBATE_AMT, 0) AS REBATE_AMT,
			COALESCE(AD.NETCHARGES, 0) AS NETCHARGES,
			COALESCE(AD.DISC_AMT, 0) AS DISCOUNT_LN,			
			COALESCE(AD.VENDOR_TAX, 0) AS VENDOR_TAX,
			COALESCE(AD.STATE_TAX, 0) AS STATE_TAX,
			COALESCE(AD.COUNTY_TAX, 0) AS COUNTY_TAX,
			COALESCE(AD.CITY_TAX, 0) AS CITY_TAX,
			COALESCE(AD.TOTAL_SPOTS,0) AS IMPRESSIONS
			FROM RADIO_DETAIL D, AP_RADIO AD
			WHERE D.ORDER_NBR = AD.ORDER_NBR AND D.LINE_NBR = AD.ORDER_LINE_NBR AND 
				AD.MODIFY_DELETE IS NULL AND D.ACTIVE_REV = 1 AND D.BILL_TYPE_FLAG <> 1 AND
				D.START_DATE BETWEEN @start_date AND @end_date;
			
			INSERT INTO @ORDER_MEDIA_TMP
			SELECT D.ORDER_NBR, RIGHT('00' + CONVERT(VARCHAR(2), D.MONTH_NBR), 2) MONTH_GRP, RIGHT('0000' + CONVERT(VARCHAR(4), D.YEAR_NBR), 4) YEAR_GRP, 
								COALESCE(D.EXT_NET_AMT, 0) EXT_NET_AMT,   
								COALESCE(D.BILLING_AMT, 0) BILLING_AMT,
								COALESCE(D.NETCHARGE, 0) NETCHARGE,
								COALESCE(D.NON_RESALE_AMT, 0) NON_RESALE_AMT,
								COALESCE(D.DISCOUNT_AMT, 0) DISCOUNT_AMT,
								COALESCE(D.ADDL_CHARGE, 0) ADDL_CHARGE, 
								COALESCE(D.MODIFIED_COMMENTS,''),  COALESCE(D.RECONCILE_FLAG,0),
								COALESCE(D.TOTAL_SPOTS,0) AS IMPRESSIONS
			FROM RADIO_DETAIL D
								WHERE D.ACTIVE_REV = 1	AND D.BILL_TYPE_FLAG <> 1
									/* PJH 09/17/18 - added AND D.LINE_CANCELLED IS NULL */
									AND D.LINE_CANCELLED IS NULL
									AND D.START_DATE BETWEEN @start_date AND @end_date
									AND D.LINE_CANCELLED IS NULL;				/* PJH 04/30/21 - check for cancelled */
		END
		
		BEGIN ---Shared Code	
			INSERT INTO @AP_MEDIA_TMP2	
			SELECT ORDER_NBR, MONTH_GRP, YEAR_GRP,
							SUM(NET_AMT) NET_AMT, SUM(GROSS_AMT) GROSS_AMT, SUM(COMM_AMT) COMM_AMT, SUM(REBATE_AMT) REBATE_AMT, SUM(NETCHARGES) NETCHARGES, 
							SUM(DISCOUNT_AMT) DISCOUNT_LN, SUM(VENDOR_TAX) VENDOR_TAX, SUM(STATE_TAX) STATE_TAX, SUM(COUNTY_TAX) COUNTY_TAX, SUM(CITY_TAX) CITY_TAX,
							SUM(IMPRESSIONS)
							FROM --AD
								(SELECT * FROM @AP_MEDIA_TMP) AD
								GROUP BY ORDER_NBR, YEAR_GRP, MONTH_GRP	;
								
			INSERT INTO @ORDER_MEDIA_TMP2
			SELECT ORDER_NBR, MONTH_GRP, YEAR_GRP,
					SUM(EXT_NET_AMT) EXT_NET_AMT, SUM(BILLING_AMT) BILLING_AMT, SUM(NETCHARGE) NETCHARGE, SUM(NON_RESALE_AMT) NON_RESALE_AMT, 
					SUM(DISCOUNT_AMT) DISCOUNT_AMT, SUM(ADDL_CHARGE) ADDL_CHARGE, MAX(D.MODIFIED_COMMENTS) MODIFIED_COMMENTS,  MAX(D.RECONCILE_FLAG) RECONCILE_FLAG,
					SUM(IMPRESSIONS) IMPRESSIONS, '', '', '', '', '', '', ''
					FROM  --D
						(SELECT * FROM @ORDER_MEDIA_TMP) D
						GROUP BY ORDER_NBR, YEAR_GRP, MONTH_GRP;
			
			IF 	@media_type_p = 'I' BEGIN			
			UPDATE D
				SET  D.CL_CODE = H.CL_CODE, D.DIV_CODE = H.DIV_CODE,  D.PRD_CODE = H.PRD_CODE,  D.CMP_CODE = H.CMP_CODE,  D.VN_CODE = H.VN_CODE, D.CLIENT_PO = H.CLIENT_PO, D.LOCKED = H.LOCKED
				FROM @ORDER_MEDIA_TMP2 D INNER JOIN INTERNET_HEADER H ON	D.ORDER_NBR = H.ORDER_NBR;
			END
			ELSE IF 	@media_type_p = 'T' BEGIN			
			UPDATE D
				SET  D.CL_CODE = H.CL_CODE, D.DIV_CODE = H.DIV_CODE,  D.PRD_CODE = H.PRD_CODE,  D.CMP_CODE = H.CMP_CODE,  D.VN_CODE = H.VN_CODE, D.CLIENT_PO = H.CLIENT_PO, D.LOCKED = H.LOCKED
				FROM @ORDER_MEDIA_TMP2 D INNER JOIN TV_HDR H ON	D.ORDER_NBR = H.ORDER_NBR;
			END
			ELSE IF 	@media_type_p = 'R' BEGIN			
			UPDATE D
				SET  D.CL_CODE = H.CL_CODE, D.DIV_CODE = H.DIV_CODE,  D.PRD_CODE = H.PRD_CODE,  D.CMP_CODE = H.CMP_CODE,  D.VN_CODE = H.VN_CODE, D.CLIENT_PO = H.CLIENT_PO, D.LOCKED = H.LOCKED
				FROM @ORDER_MEDIA_TMP2 D INNER JOIN RADIO_HDR H ON	D.ORDER_NBR = H.ORDER_NBR;
			END			
				
			--SELECT @@ROWCOUNT;

			--SELECT 'AP-DTL', * FROM @AP_MEDIA_TMP					
			--SELECT 'AP_SUM', * FROM @AP_MEDIA_TMP2
			--SELECT 'ORDER-DTL', * FROM @ORDER_MEDIA_TMP					
			--SELECT 'ORDER_SUM', * FROM @ORDER_MEDIA_TMP2	
			
			--GOTO END_IT
			IF @include = 'V' /* AP Variance Only */
				SELECT cc_row_hdr = '',   
					 D.CL_CODE,            D.DIV_CODE,            D.PRD_CODE,            D.CMP_CODE,   
					 D.VN_CODE,            D.CLIENT_PO,            D.ORDER_NBR,            NULL AS LINE_NBR, (D.YEAR_GRP), (D.MONTH_GRP), 
					 SUM(D.EXT_NET_AMT) + SUM(COALESCE(D.NETCHARGE, 0)) + SUM(COALESCE(D.NON_RESALE_AMT, 0)) + SUM(COALESCE(D.DISCOUNT_AMT, 0))  AS NET_AMT,   
					 SUM(D.BILLING_AMT) BILLING_AMT,
					 SUM(COALESCE(AD.NET_AMT,0)) AS AP_NET_AMT,  0.0000 AS REC_NET_AMT,  SUM(COALESCE(AD.GROSS_AMT,0)) AS AP_GROSS_AMT, 
					 MAX(D.MODIFIED_COMMENTS) MODIFIED_COMMENTS,   
					 MAX(D.RECONCILE_FLAG) RECONCILE_FLAG,   
					 0.0000 AS AP_BILLING_AMT,   
					 0.0000 AS VAR_NET,   
					 0.0000 AS VAR_BILLING_AMT,   
					 0.0000 AS ORDER_UNBILLED_AMT,   
					 0 AS VAR_NO_BILL_FLAG,
						SUM(COALESCE(AD.COMM_AMT,0)) AS COMM_AMT,
						SUM(COALESCE(AD.REBATE_AMT,0)) AS REBATE_AMT,
						0.0000 AS COLOR_NET_AMT,
						0.0000 AS COLOR_GROSS_AMT,
						SUM(COALESCE(AD.NETCHARGES,0)) AS NETCHARGES,
						SUM(COALESCE(AD.DISCOUNT_LN,0)) AS DISCOUNT_AMT,
						0.0000 AS BLEED_NET_AMT,
						0.0000 AS BLEED_GROSS_AMT,
						0.0000 AS POSITION_NET_AMT,
						0.0000 AS POSITION_GROSS_AMT,
						0.0000 AS PREMIUM_NET_AMT,
						0.0000 AS PREMIUM_GROSS_AMT,
						0.0000 AS NET_GROSS,
						0.0000 AS GROSS_AMT,
						SUM(COALESCE(D.IMPRESSIONS,0)) AS QUANTITY,
						0.0000 AS RATE,
						SUM(COALESCE(AD.VENDOR_TAX,0)) AS VENDOR_TAX,
						INCLUDE = '', (SUM(COALESCE(D.NETCHARGE, 0)) + SUM(COALESCE(D.NON_RESALE_AMT, 0)) + 
						SUM(COALESCE(D.DISCOUNT_AMT, 0))) AS ORDER_ADDL, (D.LOCKED),
						(SUM(COALESCE(AD.STATE_TAX, 0)) + SUM(COALESCE(AD.COUNTY_TAX, 0)) + 
						SUM(COALESCE(AD.CITY_TAX, 0))) AS AP_SALES_TAX, SUM(COALESCE(D.ADDL_CHARGE, 0)) AS ADDL_CHARGE,
						0.0000 AS COMM_PCT, 0.0000 AS MARKUP_PCT, 0 AS cc_cancel_flag,
						0 AS GUARANTEED_IMPRESS, 0 AS ACT_IMPRESSIONS, SUM(COALESCE(AD.IMPRESSIONS,0)) AS AP_QTY, 
						RECONCILE_METHOD = (@reconcile_method_p), RECONCILE_BY = (@reconcile_by_p), NULL AS RECONCILE_MONTH 
				FROM @ORDER_MEDIA_TMP2 D	
				INNER JOIN @AP_MEDIA_TMP2 AD /*PJH 03/23/16 - Changed from 'LEFT OUTER JOIN' to 'INNER JOIN' */
					ON  D.ORDER_NBR = AD.ORDER_NBR 
					AND D.YEAR_GRP = AD.YEAR_GRP AND D.MONTH_GRP = AD.MONTH_GRP
				GROUP BY D.CL_CODE,            D.DIV_CODE,            D.PRD_CODE,            D.CMP_CODE,            D.VN_CODE,   
					 D.CLIENT_PO,            D.ORDER_NBR,           D.YEAR_GRP,           D.MONTH_GRP,           D.LOCKED
				ORDER BY  D.ORDER_NBR,          D.YEAR_GRP,			D.MONTH_GRP --D.CL_CODE,            D.DIV_CODE,            D.PRD_CODE,            D.CMP_CODE,   D.VN_CODE,            D.CLIENT_PO--,            D.ORDER_NBR,          D.YEAR_GRP,			D.MONTH_GRP
			ELSE /* All Orders */
				SELECT cc_row_hdr = '',   
					 D.CL_CODE,            D.DIV_CODE,            D.PRD_CODE,            D.CMP_CODE,   
					 D.VN_CODE,            D.CLIENT_PO,            D.ORDER_NBR,            NULL AS LINE_NBR, (D.YEAR_GRP), (D.MONTH_GRP), 
					 SUM(D.EXT_NET_AMT) + SUM(COALESCE(D.NETCHARGE, 0)) + SUM(COALESCE(D.NON_RESALE_AMT, 0)) + SUM(COALESCE(D.DISCOUNT_AMT, 0))  AS NET_AMT,   
					 SUM(D.BILLING_AMT) BILLING_AMT,
					 SUM(COALESCE(AD.NET_AMT,0)) AS AP_NET_AMT,  0.0000 AS REC_NET_AMT,  SUM(COALESCE(AD.GROSS_AMT,0)) AS AP_GROSS_AMT, 
					 MAX(D.MODIFIED_COMMENTS) MODIFIED_COMMENTS,   
					 MAX(D.RECONCILE_FLAG) RECONCILE_FLAG,   
					 0.0000 AS AP_BILLING_AMT,   
					 0.0000 AS VAR_NET,   
					 0.0000 AS VAR_BILLING_AMT,   
					 0.0000 AS ORDER_UNBILLED_AMT,   
					 0 AS VAR_NO_BILL_FLAG,
						SUM(COALESCE(AD.COMM_AMT,0)) AS COMM_AMT,
						SUM(COALESCE(AD.REBATE_AMT,0)) AS REBATE_AMT,
						0.0000 AS COLOR_NET_AMT,
						0.0000 AS COLOR_GROSS_AMT,
						SUM(COALESCE(AD.NETCHARGES,0)) AS NETCHARGES,
						SUM(COALESCE(AD.DISCOUNT_LN,0)) AS DISCOUNT_AMT,
						0.0000 AS BLEED_NET_AMT,
						0.0000 AS BLEED_GROSS_AMT,
						0.0000 AS POSITION_NET_AMT,
						0.0000 AS POSITION_GROSS_AMT,
						0.0000 AS PREMIUM_NET_AMT,
						0.0000 AS PREMIUM_GROSS_AMT,
						0.0000 AS NET_GROSS,
						0.0000 AS GROSS_AMT,
						SUM(COALESCE(D.IMPRESSIONS,0)) AS QUANTITY,
						0.0000 AS RATE,
						SUM(COALESCE(AD.VENDOR_TAX,0)) AS VENDOR_TAX,
						INCLUDE = '', (SUM(COALESCE(D.NETCHARGE, 0)) + SUM(COALESCE(D.NON_RESALE_AMT, 0)) + 
						SUM(COALESCE(D.DISCOUNT_AMT, 0))) AS ORDER_ADDL, (D.LOCKED),
						(SUM(COALESCE(AD.STATE_TAX, 0)) + SUM(COALESCE(AD.COUNTY_TAX, 0)) + 
						SUM(COALESCE(AD.CITY_TAX, 0))) AS AP_SALES_TAX, SUM(COALESCE(D.ADDL_CHARGE, 0)) AS ADDL_CHARGE,
						0.0000 AS COMM_PCT, 0.0000 AS MARKUP_PCT, 0 AS cc_cancel_flag,
						0 AS GUARANTEED_IMPRESS, 0 AS ACT_IMPRESSIONS, SUM(COALESCE(AD.IMPRESSIONS,0)) AS AP_QTY, 
						RECONCILE_METHOD = (@reconcile_method_p), RECONCILE_BY = (@reconcile_by_p), NULL AS RECONCILE_MONTH 
				FROM @ORDER_MEDIA_TMP2 D	
				LEFT OUTER JOIN @AP_MEDIA_TMP2 AD 
					ON  D.ORDER_NBR = AD.ORDER_NBR 
					AND D.YEAR_GRP = AD.YEAR_GRP AND D.MONTH_GRP = AD.MONTH_GRP
				GROUP BY D.CL_CODE,            D.DIV_CODE,            D.PRD_CODE,            D.CMP_CODE,            D.VN_CODE,   
					 D.CLIENT_PO,            D.ORDER_NBR,           D.YEAR_GRP,           D.MONTH_GRP,           D.LOCKED
				ORDER BY  D.ORDER_NBR,          D.YEAR_GRP,			D.MONTH_GRP 
		END	 --- Shared Code - @media_type_p
	END --- @reconcile_by_p
	ELSE IF @reconcile_by_p = 'O' BEGIN  ------------ ORDER LEVEL RECONCILE
		IF 	@media_type_p = 'I' BEGIN
			INSERT INTO @AP_MEDIA_TMP
			SELECT AD.ORDER_NBR, CONVERT(VARCHAR(10), LINE_NBR) MONTH_GRP, '0' YEAR_GRP,
			--COALESCE(AD.NET_AMT, 0) AS NET_AMT, 
			COALESCE((AD.NET_AMT), 0) + COALESCE((AD.NETCHARGES), 0) + COALESCE((AD.VENDOR_TAX), 0) + COALESCE((AD.DISCOUNT_AMT), 0) AS NET_AMT, 
			COALESCE((AD.NET_AMT), 0) + COALESCE((AD.NETCHARGES), 0) + COALESCE((AD.VENDOR_TAX), 0) + COALESCE((AD.DISCOUNT_AMT), 0) + COALESCE(AD.COMM_AMT,0) AS GROSS_AMT, 
			COALESCE(AD.COMM_AMT, 0) AS COMM_AMT,
			COALESCE(AD.REBATE_AMT, 0) AS REBATE_AMT,
			COALESCE(AD.NETCHARGES, 0) AS NETCHARGES,
			COALESCE(AD.DISCOUNT_AMT, 0) AS DISCOUNT_LN,			
			COALESCE(AD.VENDOR_TAX, 0) AS VENDOR_TAX,
			COALESCE(AD.STATE_TAX, 0) AS STATE_TAX,
			COALESCE(AD.COUNTY_TAX, 0) AS COUNTY_TAX,
			COALESCE(AD.CITY_TAX, 0) AS CITY_TAX,
			COALESCE(AD.IMPRESSIONS, 0) AS IMPRESSIONS
			FROM INTERNET_DETAIL D, AP_INTERNET AD
			WHERE D.ORDER_NBR = AD.ORDER_NBR AND D.LINE_NBR = AD.ORDER_LINE_NBR AND 
				AD.MODIFY_DELETE IS NULL AND D.ACTIVE_REV = 1 AND D.BILL_TYPE_FLAG <> 1 AND
				D.START_DATE BETWEEN @start_date AND @end_date;
								
			INSERT INTO @ORDER_MEDIA_TMP
			SELECT D.ORDER_NBR, CONVERT(VARCHAR(10), LINE_NBR) MONTH_GRP, '0' YEAR_GRP, 
								COALESCE(D.EXT_NET_AMT, 0) EXT_NET_AMT,   
								COALESCE(D.BILLING_AMT, 0) BILLING_AMT,
								COALESCE(D.NETCHARGE, 0) NETCHARGE,
								COALESCE(D.NON_RESALE_AMT, 0) NON_RESALE_AMT,
								COALESCE(D.DISCOUNT_AMT, 0) DISCOUNT_AMT,
								COALESCE(D.ADDL_CHARGE, 0) ADDL_CHARGE, 
								COALESCE(D.MODIFIED_COMMENTS,''),  COALESCE(D.RECONCILE_FLAG,0),
								CASE 
									WHEN (D.COST_TYPE = 'NA') THEN 0 
									WHEN D.ACT_IMPRESSIONS IS NOT NULL THEN D.ACT_IMPRESSIONS
									ELSE COALESCE(D.GUARANTEED_IMPRESS,0)
								END AS IMPRESSIONS
			FROM INTERNET_DETAIL D INNER JOIN INTERNET_HEADER H ON D.ORDER_NBR = H.ORDER_NBR
								WHERE D.ACTIVE_REV = 1 AND (@complete IS NULL OR H.COMPLETE = @complete) AND D.BILL_TYPE_FLAG <> 1
									AND D.START_DATE BETWEEN @start_date AND @end_date;
		END ---INET
		ELSE IF 	@media_type_p = 'T' BEGIN
			INSERT INTO @AP_MEDIA_TMP
			SELECT AD.ORDER_NBR, CONVERT(VARCHAR(10), LINE_NBR) MONTH_GRP, '0' YEAR_GRP,
			COALESCE((AD.DISC_AMT), 0) + COALESCE((AD.NETCHARGES), 0) + COALESCE((AD.VENDOR_TAX), 0) + COALESCE((AD.DISC_AMT), 0) AS NET_AMT, 
			COALESCE((AD.DISC_AMT), 0) + COALESCE((AD.NETCHARGES), 0) + COALESCE((AD.VENDOR_TAX), 0) + COALESCE((AD.DISC_AMT), 0) + COALESCE(AD.COMM_AMT,0) AS GROSS_AMT, 
			COALESCE(AD.COMM_AMT, 0) AS COMM_AMT,
			COALESCE(AD.REBATE_AMT, 0) AS REBATE_AMT,
			COALESCE(AD.NETCHARGES, 0) AS NETCHARGES,
			COALESCE(AD.DISC_AMT, 0) AS DISCOUNT_LN,			
			COALESCE(AD.VENDOR_TAX, 0) AS VENDOR_TAX,
			COALESCE(AD.STATE_TAX, 0) AS STATE_TAX,
			COALESCE(AD.COUNTY_TAX, 0) AS COUNTY_TAX,
			COALESCE(AD.CITY_TAX, 0) AS CITY_TAX,
			COALESCE(AD.TOTAL_SPOTS,0) AS IMPRESSIONS
			FROM TV_DETAIL D, AP_TV AD
			WHERE D.ORDER_NBR = AD.ORDER_NBR AND D.LINE_NBR = AD.ORDER_LINE_NBR AND 
				AD.MODIFY_DELETE IS NULL AND D.ACTIVE_REV = 1 AND D.BILL_TYPE_FLAG <> 1 AND
				D.START_DATE BETWEEN @start_date AND @end_date;
			
			INSERT INTO @ORDER_MEDIA_TMP
			SELECT D.ORDER_NBR, CONVERT(VARCHAR(10), LINE_NBR) MONTH_GRP, '0' YEAR_GRP, 
								COALESCE(D.EXT_NET_AMT, 0) EXT_NET_AMT,   
								COALESCE(D.BILLING_AMT, 0) BILLING_AMT,
								COALESCE(D.NETCHARGE, 0) NETCHARGE,
								COALESCE(D.NON_RESALE_AMT, 0) NON_RESALE_AMT,
								COALESCE(D.DISCOUNT_AMT, 0) DISCOUNT_AMT,
								COALESCE(D.ADDL_CHARGE, 0) ADDL_CHARGE, 
								COALESCE(D.MODIFIED_COMMENTS,''),  COALESCE(D.RECONCILE_FLAG,0),
								COALESCE(D.TOTAL_SPOTS,0) AS IMPRESSIONS
			FROM TV_DETAIL D
								WHERE D.ACTIVE_REV = 1	AND D.BILL_TYPE_FLAG <> 1
									/* PJH 09/17/18 - added AND D.LINE_CANCELLED IS NULL */
									AND D.LINE_CANCELLED IS NULL
									AND D.START_DATE BETWEEN @start_date AND @end_date;			
		END ---TV
		ELSE IF 	@media_type_p = 'R' BEGIN
			INSERT INTO @AP_MEDIA_TMP
			SELECT AD.ORDER_NBR, CONVERT(VARCHAR(10), LINE_NBR) MONTH_GRP, '0' YEAR_GRP,
			COALESCE((AD.DISC_AMT), 0) + COALESCE((AD.NETCHARGES), 0) + COALESCE((AD.VENDOR_TAX), 0) + COALESCE((AD.DISC_AMT), 0) AS NET_AMT, 
			COALESCE((AD.DISC_AMT), 0) + COALESCE((AD.NETCHARGES), 0) + COALESCE((AD.VENDOR_TAX), 0) + COALESCE((AD.DISC_AMT), 0) + COALESCE(AD.COMM_AMT,0) AS GROSS_AMT, 
			COALESCE(AD.COMM_AMT, 0) AS COMM_AMT,
			COALESCE(AD.REBATE_AMT, 0) AS REBATE_AMT,
			COALESCE(AD.NETCHARGES, 0) AS NETCHARGES,
			COALESCE(AD.DISC_AMT, 0) AS DISCOUNT_LN,			
			COALESCE(AD.VENDOR_TAX, 0) AS VENDOR_TAX,
			COALESCE(AD.STATE_TAX, 0) AS STATE_TAX,
			COALESCE(AD.COUNTY_TAX, 0) AS COUNTY_TAX,
			COALESCE(AD.CITY_TAX, 0) AS CITY_TAX,
			COALESCE(AD.TOTAL_SPOTS,0) AS IMPRESSIONS
			FROM RADIO_DETAIL D, AP_RADIO AD
			WHERE D.ORDER_NBR = AD.ORDER_NBR AND D.LINE_NBR = AD.ORDER_LINE_NBR AND 
				AD.MODIFY_DELETE IS NULL AND D.ACTIVE_REV = 1 AND D.BILL_TYPE_FLAG <> 1 AND
				D.START_DATE BETWEEN @start_date AND @end_date;
			
			INSERT INTO @ORDER_MEDIA_TMP
			SELECT D.ORDER_NBR, CONVERT(VARCHAR(10), LINE_NBR) MONTH_GRP, '0' YEAR_GRP, 
								COALESCE(D.EXT_NET_AMT, 0) EXT_NET_AMT,   
								COALESCE(D.BILLING_AMT, 0) BILLING_AMT,
								COALESCE(D.NETCHARGE, 0) NETCHARGE,
								COALESCE(D.NON_RESALE_AMT, 0) NON_RESALE_AMT,
								COALESCE(D.DISCOUNT_AMT, 0) DISCOUNT_AMT,
								COALESCE(D.ADDL_CHARGE, 0) ADDL_CHARGE, 
								COALESCE(D.MODIFIED_COMMENTS,''),  COALESCE(D.RECONCILE_FLAG,0),
								COALESCE(D.TOTAL_SPOTS,0) AS IMPRESSIONS
			FROM RADIO_DETAIL D
								WHERE D.ACTIVE_REV = 1	AND D.BILL_TYPE_FLAG <> 1
									/* PJH 09/17/18 - added AND D.LINE_CANCELLED IS NULL */
									AND D.LINE_CANCELLED IS NULL
									AND D.START_DATE BETWEEN @start_date AND @end_date;					
		END ---RADIO		
		
		BEGIN --Shared Code
			INSERT INTO @AP_MEDIA_TMP2	
			SELECT ORDER_NBR, 0, 0,--MONTH_GRP, YEAR_GRP,
							SUM(NET_AMT) NET_AMT, SUM(GROSS_AMT) GROSS_AMT, SUM(COMM_AMT) COMM_AMT, SUM(REBATE_AMT) REBATE_AMT, SUM(NETCHARGES) NETCHARGES, 
							SUM(DISCOUNT_AMT) DISCOUNT_LN, SUM(VENDOR_TAX) VENDOR_TAX, SUM(STATE_TAX) STATE_TAX, SUM(COUNTY_TAX) COUNTY_TAX, SUM(CITY_TAX) CITY_TAX,
							SUM(IMPRESSIONS)
							FROM --AD
								(SELECT * FROM @AP_MEDIA_TMP) AD
								GROUP BY ORDER_NBR; --, YEAR_GRP, MONTH_GRP	;

									
			INSERT INTO @ORDER_MEDIA_TMP2
			SELECT ORDER_NBR, 0, 0, --MONTH_GRP, YEAR_GRP,
					SUM(EXT_NET_AMT) EXT_NET_AMT, SUM(BILLING_AMT) BILLING_AMT, SUM(NETCHARGE) NETCHARGE, SUM(NON_RESALE_AMT) NON_RESALE_AMT, 
					SUM(DISCOUNT_AMT) DISCOUNT_AMT, SUM(ADDL_CHARGE) ADDL_CHARGE, MAX(D.MODIFIED_COMMENTS) MODIFIED_COMMENTS,  MAX(D.RECONCILE_FLAG) RECONCILE_FLAG,
					SUM(IMPRESSIONS) IMPRESSIONS, '', '', '', '', '', '', ''
					FROM  --D
						(SELECT * FROM @ORDER_MEDIA_TMP) D
						GROUP BY ORDER_NBR; --, YEAR_GRP, MONTH_GRP;

			IF 	@media_type_p = 'I' BEGIN			
			UPDATE D
				SET  D.CL_CODE = H.CL_CODE, D.DIV_CODE = H.DIV_CODE,  D.PRD_CODE = H.PRD_CODE,  D.CMP_CODE = H.CMP_CODE,  D.VN_CODE = H.VN_CODE, D.CLIENT_PO = H.CLIENT_PO, D.LOCKED = H.LOCKED
				FROM @ORDER_MEDIA_TMP2 D INNER JOIN INTERNET_HEADER H ON	D.ORDER_NBR = H.ORDER_NBR;
			END
			ELSE IF 	@media_type_p = 'T' BEGIN			
			UPDATE D
				SET  D.CL_CODE = H.CL_CODE, D.DIV_CODE = H.DIV_CODE,  D.PRD_CODE = H.PRD_CODE,  D.CMP_CODE = H.CMP_CODE,  D.VN_CODE = H.VN_CODE, D.CLIENT_PO = H.CLIENT_PO, D.LOCKED = H.LOCKED
				FROM @ORDER_MEDIA_TMP2 D INNER JOIN TV_HDR H ON	D.ORDER_NBR = H.ORDER_NBR;
			END
			ELSE IF 	@media_type_p = 'R' BEGIN			
			UPDATE D
				SET  D.CL_CODE = H.CL_CODE, D.DIV_CODE = H.DIV_CODE,  D.PRD_CODE = H.PRD_CODE,  D.CMP_CODE = H.CMP_CODE,  D.VN_CODE = H.VN_CODE, D.CLIENT_PO = H.CLIENT_PO, D.LOCKED = H.LOCKED
				FROM @ORDER_MEDIA_TMP2 D INNER JOIN RADIO_HDR H ON	D.ORDER_NBR = H.ORDER_NBR;
			END			

			--SELECT 'AP-DTL', * FROM @AP_MEDIA_TMP					
			--SELECT 'AP_SUM', * FROM @AP_MEDIA_TMP2
			--SELECT 'ORDER-DTL', * FROM @ORDER_MEDIA_TMP					
			--SELECT 'ORDER_SUM', * FROM @ORDER_MEDIA_TMP2		
			IF @include = 'V' /* AP Variance Only */
				SELECT cc_row_hdr = '',   
					 D.CL_CODE,            D.DIV_CODE,            D.PRD_CODE,            D.CMP_CODE,   
					 D.VN_CODE,            D.CLIENT_PO,            D.ORDER_NBR,            NULL AS LINE_NBR, '0', '0', --(D.YEAR_GRP), (D.MONTH_GRP), 
					 SUM(D.EXT_NET_AMT) + SUM(COALESCE(D.NETCHARGE, 0)) + SUM(COALESCE(D.NON_RESALE_AMT, 0)) + SUM(COALESCE(D.DISCOUNT_AMT, 0))  AS NET_AMT,   
					 SUM(D.BILLING_AMT) BILLING_AMT,
					 SUM(COALESCE(AD.NET_AMT,0)) AS AP_NET_AMT,  0.0000 AS REC_NET_AMT,  SUM(COALESCE(AD.GROSS_AMT,0)) AS AP_GROSS_AMT, 
					 MAX(D.MODIFIED_COMMENTS) MODIFIED_COMMENTS,   
					 MAX(D.RECONCILE_FLAG) RECONCILE_FLAG,   
					 0.0000 AS AP_BILLING_AMT,   
					 0.0000 AS VAR_NET,   
					 0.0000 AS VAR_BILLING_AMT,   
					 0.0000 AS ORDER_UNBILLED_AMT,   
					 0 AS VAR_NO_BILL_FLAG,
						SUM(COALESCE(AD.COMM_AMT,0)) AS COMM_AMT,
						SUM(COALESCE(AD.REBATE_AMT,0)) AS REBATE_AMT,
						0.0000 AS COLOR_NET_AMT,
						0.0000 AS COLOR_GROSS_AMT,
						SUM(COALESCE(AD.NETCHARGES,0)) AS NETCHARGES,
						SUM(COALESCE(AD.DISCOUNT_LN,0)) AS DISCOUNT_AMT,
						0.0000 AS BLEED_NET_AMT,
						0.0000 AS BLEED_GROSS_AMT,
						0.0000 AS POSITION_NET_AMT,
						0.0000 AS POSITION_GROSS_AMT,
						0.0000 AS PREMIUM_NET_AMT,
						0.0000 AS PREMIUM_GROSS_AMT,
						0.0000 AS NET_GROSS,
						0.0000 AS GROSS_AMT,
						SUM(COALESCE(D.IMPRESSIONS,0)) AS QUANTITY,
						0.0000 AS RATE,
						SUM(COALESCE(AD.VENDOR_TAX,0)) AS VENDOR_TAX,
						INCLUDE = '', (SUM(COALESCE(D.NETCHARGE, 0)) + SUM(COALESCE(D.NON_RESALE_AMT, 0)) + 
						SUM(COALESCE(D.DISCOUNT_AMT, 0))) AS ORDER_ADDL, (D.LOCKED),
						(SUM(COALESCE(AD.STATE_TAX, 0)) + SUM(COALESCE(AD.COUNTY_TAX, 0)) + 
						SUM(COALESCE(AD.CITY_TAX, 0))) AS AP_SALES_TAX, SUM(COALESCE(D.ADDL_CHARGE, 0)) AS ADDL_CHARGE,
						0.0000 AS COMM_PCT, 0.0000 AS MARKUP_PCT, 0 AS cc_cancel_flag,
						0 AS GUARANTEED_IMPRESS, 0 AS ACT_IMPRESSIONS, SUM(COALESCE(AD.IMPRESSIONS,0)) AS AP_QTY, 
						RECONCILE_METHOD = (@reconcile_method_p), RECONCILE_BY = (@reconcile_by_p), NULL AS RECONCILE_MONTH, 0 AS cc_approval 
				FROM @ORDER_MEDIA_TMP2 D	
				INNER JOIN @AP_MEDIA_TMP2 AD /*PJH 03/23/16 - Changed from 'LEFT OUTER JOIN' to 'INNER JOIN' */
					ON  D.ORDER_NBR = AD.ORDER_NBR 
					AND D.YEAR_GRP = AD.YEAR_GRP AND D.MONTH_GRP = AD.MONTH_GRP
				GROUP BY D.CL_CODE,            D.DIV_CODE,            D.PRD_CODE,            D.CMP_CODE,            D.VN_CODE,   
					 D.CLIENT_PO,            D.ORDER_NBR,              D.LOCKED--,           D.YEAR_GRP,           D.MONTH_GRP,           D.LOCKED
				ORDER BY   D.ORDER_NBR --D.CL_CODE,            D.DIV_CODE,            D.PRD_CODE,            D.CMP_CODE,   D.VN_CODE,            D.CLIENT_PO,            D.ORDER_NBR 
			ELSE /* All Orders */
				SELECT cc_row_hdr = '',   
					 D.CL_CODE,            D.DIV_CODE,            D.PRD_CODE,            D.CMP_CODE,   
					 D.VN_CODE,            D.CLIENT_PO,            D.ORDER_NBR,            NULL AS LINE_NBR, '0', '0', --(D.YEAR_GRP), (D.MONTH_GRP), 
					 SUM(D.EXT_NET_AMT) + SUM(COALESCE(D.NETCHARGE, 0)) + SUM(COALESCE(D.NON_RESALE_AMT, 0)) + SUM(COALESCE(D.DISCOUNT_AMT, 0))  AS NET_AMT,   
					 SUM(D.BILLING_AMT) BILLING_AMT,
					 SUM(COALESCE(AD.NET_AMT,0)) AS AP_NET_AMT,  0.0000 AS REC_NET_AMT,  SUM(COALESCE(AD.GROSS_AMT,0)) AS AP_GROSS_AMT, 
					 MAX(D.MODIFIED_COMMENTS) MODIFIED_COMMENTS,   
					 MAX(D.RECONCILE_FLAG) RECONCILE_FLAG,   
					 0.0000 AS AP_BILLING_AMT,   
					 0.0000 AS VAR_NET,   
					 0.0000 AS VAR_BILLING_AMT,   
					 0.0000 AS ORDER_UNBILLED_AMT,   
					 0 AS VAR_NO_BILL_FLAG,
						SUM(COALESCE(AD.COMM_AMT,0)) AS COMM_AMT,
						SUM(COALESCE(AD.REBATE_AMT,0)) AS REBATE_AMT,
						0.0000 AS COLOR_NET_AMT,
						0.0000 AS COLOR_GROSS_AMT,
						SUM(COALESCE(AD.NETCHARGES,0)) AS NETCHARGES,
						SUM(COALESCE(AD.DISCOUNT_LN,0)) AS DISCOUNT_AMT,
						0.0000 AS BLEED_NET_AMT,
						0.0000 AS BLEED_GROSS_AMT,
						0.0000 AS POSITION_NET_AMT,
						0.0000 AS POSITION_GROSS_AMT,
						0.0000 AS PREMIUM_NET_AMT,
						0.0000 AS PREMIUM_GROSS_AMT,
						0.0000 AS NET_GROSS,
						0.0000 AS GROSS_AMT,
						SUM(COALESCE(D.IMPRESSIONS,0)) AS QUANTITY,
						0.0000 AS RATE,
						SUM(COALESCE(AD.VENDOR_TAX,0)) AS VENDOR_TAX,
						INCLUDE = '', (SUM(COALESCE(D.NETCHARGE, 0)) + SUM(COALESCE(D.NON_RESALE_AMT, 0)) + 
						SUM(COALESCE(D.DISCOUNT_AMT, 0))) AS ORDER_ADDL, (D.LOCKED),
						(SUM(COALESCE(AD.STATE_TAX, 0)) + SUM(COALESCE(AD.COUNTY_TAX, 0)) + 
						SUM(COALESCE(AD.CITY_TAX, 0))) AS AP_SALES_TAX, SUM(COALESCE(D.ADDL_CHARGE, 0)) AS ADDL_CHARGE,
						0.0000 AS COMM_PCT, 0.0000 AS MARKUP_PCT, 0 AS cc_cancel_flag,
						0 AS GUARANTEED_IMPRESS, 0 AS ACT_IMPRESSIONS, SUM(COALESCE(AD.IMPRESSIONS,0)) AS AP_QTY, 
						RECONCILE_METHOD = (@reconcile_method_p), RECONCILE_BY = (@reconcile_by_p), NULL AS RECONCILE_MONTH, 0 AS cc_approval 
				FROM @ORDER_MEDIA_TMP2 D	
				LEFT OUTER JOIN @AP_MEDIA_TMP2 AD 
					ON  D.ORDER_NBR = AD.ORDER_NBR 
					AND D.YEAR_GRP = AD.YEAR_GRP AND D.MONTH_GRP = AD.MONTH_GRP
				GROUP BY D.CL_CODE,            D.DIV_CODE,            D.PRD_CODE,            D.CMP_CODE,            D.VN_CODE,   
					 D.CLIENT_PO,            D.ORDER_NBR,              D.LOCKED--,           D.YEAR_GRP,           D.MONTH_GRP,           D.LOCKED
				ORDER BY   D.ORDER_NBR --D.CL_CODE,            D.DIV_CODE,            D.PRD_CODE,            D.CMP_CODE,   D.VN_CODE,            D.CLIENT_PO,            D.ORDER_NBR 			
		END	 --- Shared Code - @media_type_p
	END --- @reconcile_by_p	
END --- SP

END_IT:

GO

GRANT EXECUTE ON [advsp_ap_media_reconcile] TO PUBLIC AS dbo
GO
