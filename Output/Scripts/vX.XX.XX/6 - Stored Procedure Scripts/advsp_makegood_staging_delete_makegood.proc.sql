CREATE PROCEDURE [dbo].[advsp_makegood_staging_delete_makegood]
	@MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL_ID int
AS

DECLARE @MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID int,
		@MEDIA_BROADCAST_WORKSHEET_MARKET_ID int,
		@LINE_NUMBER int,
		@MG_ZERO_MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL_ID int,
		@VN_CODE varchar(6),
		@MADEGOOD_NUMBER int

DECLARE @RENUMBER TABLE (
	MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL_ID int,
	MAKEGOOD_NUMBER int,
	NEW_NUMBER int identity(1,1)
)

SELECT @MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID = MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID, @MEDIA_BROADCAST_WORKSHEET_MARKET_ID = MEDIA_BROADCAST_WORKSHEET_MARKET_ID, 
	@LINE_NUMBER = LINE_NUMBER, @MADEGOOD_NUMBER = MADEGOOD_NUMBER
FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL
WHERE MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL_ID = @MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL_ID
AND IS_ORIGINAL = 0

SELECT @VN_CODE = VN_CODE FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL 
WHERE MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID = @MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID

SELECT @MG_ZERO_MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL_ID = MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL_ID 
FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL
WHERE MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID = @MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID
AND MAKEGOOD_NUMBER = @MADEGOOD_NUMBER

--select @VN_CODE, @MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID, @MEDIA_BROADCAST_WORKSHEET_MARKET_ID, @LINE_NUMBER, @MG_ZERO_MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL_ID, @MADEGOOD_NUMBER

BEGIN TRY

	BEGIN TRAN
		
		UPDATE ORG SET ORG.SPOTS = ORG.SPOTS + MG.MAKEGOOD_SPOTS
		FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL_DATE ORG
			INNER JOIN dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL_DATE MG ON ORG.[DATE] = MG.[DATE]
		WHERE ORG.MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL_ID = @MG_ZERO_MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL_ID
		AND MG.MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL_ID = @MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL_ID

		DELETE dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL_DATE
		WHERE MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL_ID = @MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL_ID

		DELETE dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL
		WHERE MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL_ID = @MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL_ID
		
		INSERT INTO @RENUMBER (MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL_ID, MAKEGOOD_NUMBER)
		SELECT MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL_ID, MAKEGOOD_NUMBER 
		FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL 
		WHERE MEDIA_BROADCAST_WORKSHEET_MARKET_ID = @MEDIA_BROADCAST_WORKSHEET_MARKET_ID
		AND LINE_NUMBER = @LINE_NUMBER 
		AND MAKEGOOD_NUMBER <> 0
		AND MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID IN (SELECT MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID
															FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL
															WHERE MEDIA_BROADCAST_WORKSHEET_MARKET_ID = @MEDIA_BROADCAST_WORKSHEET_MARKET_ID
															AND VN_CODE = @VN_CODE)
		
		UPDATE S SET S.MAKEGOOD_NUMBER = R.NEW_NUMBER 
		FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL S
			INNER JOIN @RENUMBER R ON S.MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL_ID = R.MEDIA_BROADCAST_WORKSHEET_MARKET_STAGING_DETAIL_ID 

	COMMIT TRAN

END TRY
BEGIN CATCH
	
	ROLLBACK TRAN
		
	SELECT 
    --ERROR_NUMBER() as ErrorNumber,
    ERROR_MESSAGE() as ErrorMessage;
        
END CATCH
