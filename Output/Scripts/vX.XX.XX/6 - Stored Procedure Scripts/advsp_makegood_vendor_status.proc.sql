CREATE PROCEDURE [dbo].[advsp_makegood_vendor_status]
	@MEDIA_BROADCAST_WORKSHEET_MARKET_ID int,
	@REVISION_NUMBER int
AS

DECLARE @MEDIA_TYPE varchar(1)

CREATE TABLE #VEN_ORDERS (
	VN_CODE varchar(6) COLLATE SQL_Latin1_General_CP1_CS_AS NOT NULL,
	ORDER_NBR int NOT NULL,
	ORDER_LINE_NBR int NOT NULL
)
CREATE TABLE #STATII (
	ORDER_NBR int NOT NULL,
	REV_NBR int NOT NULL,
	LINE_NBR smallint NOT NULL,
	REVISED_DATE datetime,
	[STATUS] smallint,
	GENERATE_PENDING bit NOT NULL DEFAULT(0)
)

SELECT @MEDIA_TYPE = MEDIA_TYPE_CODE 
FROM dbo.MEDIA_BROADCAST_WORKSHEET 
WHERE MEDIA_BROADCAST_WORKSHEET_ID = (SELECT MEDIA_BROADCAST_WORKSHEET_ID 
										FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET
										WHERE MEDIA_BROADCAST_WORKSHEET_MARKET_ID = @MEDIA_BROADCAST_WORKSHEET_MARKET_ID)
INSERT #VEN_ORDERS
SELECT DISTINCT MBWMD.VN_CODE, MBWMDD.ORDER_NBR, MBWMDD.ORDER_LINE_NBR 
FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL MBWMD
	INNER JOIN dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_DATE MBWMDD ON MBWMD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID = MBWMDD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID 
WHERE MBWMD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = @MEDIA_BROADCAST_WORKSHEET_MARKET_ID
AND MBWMD.REVISION_NUMBER = @REVISION_NUMBER
AND ORDER_NBR IS NOT NULL

IF @MEDIA_TYPE = 'T' BEGIN

	INSERT #STATII (REV_NBR, LINE_NBR, ORDER_NBR)
	SELECT MAX(REV_NBR) AS REV_NBR, LINE_NBR, ORDER_NBR 
	FROM dbo.TV_ORDER_STATUS
	WHERE ORDER_NBR IN (SELECT DISTINCT ORDER_NBR FROM #VEN_ORDERS)
	AND [STATUS] IN (19, 20, 15, 4, 5, 16, 17, 18)
	GROUP BY LINE_NBR, ORDER_NBR

	UPDATE s SET REVISED_DATE = (
								SELECT MAX(os.REVISED_DATE) 
								FROM dbo.TV_ORDER_STATUS os 
								WHERE [STATUS] IN (19, 20, 15, 4, 5, 16, 17, 18)
								AND os.ORDER_NBR = s.ORDER_NBR AND os.LINE_NBR = s.LINE_NBR AND os.REV_NBR = s.REV_NBR
								)
	FROM #STATII s
		
	UPDATE s SET [STATUS] = (
							SELECT TOP 1 [STATUS] 
							FROM dbo.TV_ORDER_STATUS os 
							WHERE [STATUS] IN (19, 20, 15, 4, 5, 16, 17, 18)
							AND os.ORDER_NBR = s.ORDER_NBR AND os.LINE_NBR = s.LINE_NBR AND os.REV_NBR = s.REV_NBR AND os.REVISED_DATE = s.REVISED_DATE
							)
	FROM #STATII s
	
	UPDATE s SET GENERATE_PENDING = 1
	FROM #STATII s
		LEFT OUTER JOIN (
						SELECT d.ORDER_NBR, GENERATE_PENDING = CASE WHEN os.ORDER_NBR IS NULL THEN 1 ELSE 0 END
						FROM dbo.TV_DETAIL d
							LEFT OUTER JOIN dbo.TV_ORDER_STATUS os ON d.ORDER_NBR = os.ORDER_NBR AND d.LINE_NBR = os.LINE_NBR AND d.REV_NBR = os.REV_NBR 
						WHERE d.ORDER_NBR IN (SELECT DISTINCT ORDER_NBR FROM #VEN_ORDERS)
						AND d.ACTIVE_REV = 1
						AND os.ORDER_NBR IS NULL) dtl ON s.ORDER_NBR = dtl.ORDER_NBR 
	WHERE dtl.ORDER_NBR IS NOT NULL
	
END ELSE IF @MEDIA_TYPE = 'R' BEGIN

	INSERT #STATII (REV_NBR, LINE_NBR, ORDER_NBR)
	SELECT MAX(REV_NBR) AS REV_NBR, LINE_NBR, ORDER_NBR
	FROM dbo.RADIO_ORDER_STATUS
	WHERE ORDER_NBR IN (SELECT DISTINCT ORDER_NBR FROM #VEN_ORDERS)
	AND [STATUS] IN (19, 20, 15, 4, 5, 16, 17, 18)
	GROUP BY LINE_NBR, ORDER_NBR

	UPDATE s SET REVISED_DATE = (
								SELECT MAX(os.REVISED_DATE) 
								FROM dbo.RADIO_ORDER_STATUS os 
								WHERE [STATUS] IN (19, 20, 15, 4, 5, 16, 17, 18)
								AND os.ORDER_NBR = s.ORDER_NBR AND os.LINE_NBR = s.LINE_NBR AND os.REV_NBR = s.REV_NBR)
	FROM #STATII s
		
	UPDATE s SET [STATUS] = (
							SELECT TOP 1 [STATUS] 
							FROM dbo.RADIO_ORDER_STATUS os 
							WHERE [STATUS] IN (19, 20, 15, 4, 5, 16, 17, 18)
							AND os.ORDER_NBR = s.ORDER_NBR AND os.LINE_NBR = s.LINE_NBR AND os.REV_NBR = s.REV_NBR AND os.REVISED_DATE = s.REVISED_DATE
							)
	FROM #STATII s
	
	UPDATE s SET GENERATE_PENDING = 1
	FROM #STATII s
		LEFT OUTER JOIN (
						SELECT d.ORDER_NBR, GENERATE_PENDING = CASE WHEN os.ORDER_NBR IS NULL THEN 1 ELSE 0 END
						FROM dbo.RADIO_DETAIL d
							LEFT OUTER JOIN dbo.RADIO_ORDER_STATUS os ON d.ORDER_NBR = os.ORDER_NBR AND d.LINE_NBR = os.LINE_NBR AND d.REV_NBR = os.REV_NBR 
						WHERE d.ORDER_NBR IN (SELECT DISTINCT ORDER_NBR FROM #VEN_ORDERS)
						AND d.ACTIVE_REV = 1
						AND os.ORDER_NBR IS NULL) dtl ON s.ORDER_NBR = dtl.ORDER_NBR 
	WHERE dtl.ORDER_NBR IS NOT NULL
	
END

SELECT VendorName = V.VN_NAME, [Status] = TOS.[STATUS], [OrderNumber] = TOS.ORDER_NBR, [LineNumber] = TOS.LINE_NBR, [RevisionNumber] = TOS.REV_NBR, [Date] = TOS.REVISED_DATE,
	GeneratePending = TOS.GENERATE_PENDING 
FROM #STATII TOS
	INNER JOIN #VEN_ORDERS VO ON TOS.ORDER_NBR = VO.ORDER_NBR AND TOS.LINE_NBR = VO.ORDER_LINE_NBR 
	INNER JOIN dbo.VENDOR V ON VO.VN_CODE = V.VN_CODE
	
DROP TABLE #VEN_ORDERS
DROP TABLE #STATII

GO