CREATE PROCEDURE [dbo].[advsp_media_broadcast_worksheet_order_status]
	@MEDIA_BROADCAST_WORKSHEET_MARKET_ID int,
	@SELECT_BY smallint, -- 0 = ALL, 1 = highest revision only, 2 = most recent status, 3 = most recent status by worksheet line
	@debug int = 0
AS

DECLARE @MEDIA_TYPE_CODE char(1)

SELECT @MEDIA_TYPE_CODE = MBW.MEDIA_TYPE_CODE 
FROM MEDIA_BROADCAST_WORKSHEET_MARKET MBWM
	INNER JOIN MEDIA_BROADCAST_WORKSHEET MBW ON MBWM.MEDIA_BROADCAST_WORKSHEET_ID = MBW.MEDIA_BROADCAST_WORKSHEET_ID
WHERE MBWM.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = @MEDIA_BROADCAST_WORKSHEET_MARKET_ID

CREATE TABLE #details (
	VendorCode varchar(6) NOT NULL,
	VendorName varchar(40) NOT NULL,
	OrderNumber int NOT NULL,
	LineNumber int NOT NULL,
	WorksheetLine int NOT NULL,
	RevisionNumber smallint NOT NULL,
	[Month] smallint NOT NULL,
	[Year] smallint NOT NULL
)
CREATE TABLE #max_rev_status (
	REVISED_DATE datetime NOT NULL, 
	ORDER_NBR int NOT NULL, 
	LINE_NBR int NOT NULL, 
	REV_NBR smallint NOT NULL
)

IF @MEDIA_TYPE_CODE = 'T' BEGIN
	IF @SELECT_BY = 0
		INSERT INTO #details
		SELECT DISTINCT
			VendorCode = V.VN_CODE,
			VendorName = V.VN_NAME,
			OrderNumber = MBWMDD.ORDER_NBR,
			LineNumber = MBWMDD.ORDER_LINE_NBR,
			WorksheetLine = MBWMD.LINE_NUMBER,
			RevisionNumber = D.REV_NBR,
			[Month] = D.MONTH_NBR,
			[Year] = D.YEAR_NBR
		FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL MBWMD
			INNER JOIN dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_DATE MBWMDD ON MBWMD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID = MBWMDD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID 
			INNER JOIN dbo.TV_HDR H ON MBWMDD.ORDER_NBR = H.ORDER_NBR 
			INNER JOIN dbo.VENDOR V ON H.VN_CODE = V.VN_CODE
			INNER JOIN dbo.TV_DETAIL D ON MBWMDD.ORDER_NBR = D.ORDER_NBR AND MBWMDD.ORDER_LINE_NBR = D.LINE_NBR
		WHERE MBWMDD.ORDER_NBR IS NOT NULL
		AND MBWMD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = @MEDIA_BROADCAST_WORKSHEET_MARKET_ID
	
	ELSE --IF @SELECT_BY = 1 OR @SELECT_BY = 2
		INSERT INTO #details
		SELECT DISTINCT
			VendorCode = V.VN_CODE,
			VendorName = V.VN_NAME,
			OrderNumber = MBWMDD.ORDER_NBR,
			LineNumber = MBWMDD.ORDER_LINE_NBR,
			WorksheetLine = MBWMD.LINE_NUMBER,
			RevisionNumber = MAX(D.REV_NBR),
			[Month] = D.MONTH_NBR,
			[Year] = D.YEAR_NBR
		FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL MBWMD
			INNER JOIN dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_DATE MBWMDD ON MBWMD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID = MBWMDD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID 
			INNER JOIN dbo.TV_HDR H ON MBWMDD.ORDER_NBR = H.ORDER_NBR 
			INNER JOIN dbo.VENDOR V ON H.VN_CODE = V.VN_CODE
			INNER JOIN dbo.TV_DETAIL D ON MBWMDD.ORDER_NBR = D.ORDER_NBR AND MBWMDD.ORDER_LINE_NBR = D.LINE_NBR
		WHERE MBWMDD.ORDER_NBR IS NOT NULL
		AND MBWMD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = @MEDIA_BROADCAST_WORKSHEET_MARKET_ID
		GROUP BY
			V.VN_CODE,
			V.VN_NAME,
			MBWMDD.ORDER_NBR,
			MBWMDD.ORDER_LINE_NBR,
			MBWMD.LINE_NUMBER,
			D.MONTH_NBR,
			D.YEAR_NBR

	IF @debug = 1
		select * from #details

	IF @SELECT_BY = 2 OR @SELECT_BY = 3 BEGIN
		INSERT INTO #max_rev_status
			SELECT MAX(tos.REVISED_DATE), tos.ORDER_NBR, tos.LINE_NBR, tos.REV_NBR 
			FROM dbo.TV_ORDER_STATUS tos
				INNER JOIN #details d ON tos.ORDER_NBR = d.OrderNumber AND tos.LINE_NBR = d.LineNumber AND tos.REV_NBR = d.RevisionNumber 
			GROUP BY tos.ORDER_NBR, tos.LINE_NBR, tos.REV_NBR 

		IF @debug = 1
			select * from #max_rev_status

		IF @SELECT_BY = 2
			SELECT D.VendorCode,
				D.VendorName,
				D.OrderNumber,
				D.LineNumber,
				D.WorksheetLine,
				D.RevisionNumber,
				D.[Month],
				D.[Year],
				StatusDescription = os.STATUS_DESC,
				[Date] = tos.REVISED_DATE, 
				[By] = tos.REVISED_BY_NAME 
			FROM #details D
				INNER JOIN #max_rev_status mrs ON D.OrderNumber = mrs.ORDER_NBR AND D.LineNumber = mrs.LINE_NBR AND D.RevisionNumber = mrs.REV_NBR 
				INNER JOIN dbo.TV_ORDER_STATUS tos ON D.OrderNumber = tos.ORDER_NBR AND D.LineNumber = tos.LINE_NBR AND D.RevisionNumber = tos.REV_NBR AND mrs.REVISED_DATE = tos.REVISED_DATE 
				INNER JOIN dbo.ORDER_STATUS os ON tos.[STATUS] = os.[STATUS]
			ORDER BY 3,4,5
		ELSE IF @SELECT_BY = 3
			SELECT DISTINCT D.VendorCode,
				D.VendorName,
				D.OrderNumber,
				--D.LineNumber,
				D.WorksheetLine,
				D.RevisionNumber,
				--D.[Month],
				--D.[Year],
				StatusDescription = os.STATUS_DESC,
				[Date] = tos.REVISED_DATE, 
				[By] = tos.REVISED_BY_NAME 
			FROM #details D
				INNER JOIN #max_rev_status mrs ON D.OrderNumber = mrs.ORDER_NBR AND D.LineNumber = mrs.LINE_NBR AND D.RevisionNumber = mrs.REV_NBR 
				INNER JOIN dbo.TV_ORDER_STATUS tos ON D.OrderNumber = tos.ORDER_NBR AND D.LineNumber = tos.LINE_NBR AND D.RevisionNumber = tos.REV_NBR AND mrs.REVISED_DATE = tos.REVISED_DATE 
				INNER JOIN dbo.ORDER_STATUS os ON tos.[STATUS] = os.[STATUS]
			ORDER BY 3,4,5
	END ELSE
		SELECT D.*, StatusDescription = os.STATUS_DESC, [Date] = tos.REVISED_DATE, [By] = tos.REVISED_BY_NAME 
		FROM #details D
			INNER JOIN dbo.TV_ORDER_STATUS tos ON D.OrderNumber = tos.ORDER_NBR AND D.LineNumber = tos.LINE_NBR AND D.RevisionNumber = tos.REV_NBR 
			INNER JOIN dbo.ORDER_STATUS os ON tos.[STATUS] = os.[STATUS]
		ORDER BY 3,4,5

END ELSE IF @MEDIA_TYPE_CODE = 'R' BEGIN
	IF @SELECT_BY = 0
		INSERT INTO #details
		SELECT DISTINCT
			VendorCode = V.VN_CODE,
			VendorName = V.VN_NAME,
			OrderNumber = MBWMDD.ORDER_NBR,
			LineNumber = MBWMDD.ORDER_LINE_NBR,
			WorksheetLine = MBWMD.LINE_NUMBER,
			RevisionNumber = D.REV_NBR,
			[Month] = D.MONTH_NBR,
			[Year] = D.YEAR_NBR
		FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL MBWMD
			INNER JOIN dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_DATE MBWMDD ON MBWMD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID = MBWMDD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID 
			INNER JOIN dbo.RADIO_HDR H ON MBWMDD.ORDER_NBR = H.ORDER_NBR 
			INNER JOIN dbo.VENDOR V ON H.VN_CODE = V.VN_CODE
			INNER JOIN dbo.RADIO_DETAIL D ON MBWMDD.ORDER_NBR = D.ORDER_NBR AND MBWMDD.ORDER_LINE_NBR = D.LINE_NBR
		WHERE MBWMDD.ORDER_NBR IS NOT NULL
		AND MBWMD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = @MEDIA_BROADCAST_WORKSHEET_MARKET_ID
	
	ELSE --IF @SELECT_BY = 1 OR @SELECT_BY = 2
		INSERT INTO #details
		SELECT DISTINCT
			VendorCode = V.VN_CODE,
			VendorName = V.VN_NAME,
			OrderNumber = MBWMDD.ORDER_NBR,
			LineNumber = MBWMDD.ORDER_LINE_NBR,
			WorksheetLine = MBWMD.LINE_NUMBER,
			RevisionNumber = MAX(D.REV_NBR),
			[Month] = D.MONTH_NBR,
			[Year] = D.YEAR_NBR
		FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL MBWMD
			INNER JOIN dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_DATE MBWMDD ON MBWMD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID = MBWMDD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID 
			INNER JOIN dbo.RADIO_HDR H ON MBWMDD.ORDER_NBR = H.ORDER_NBR 
			INNER JOIN dbo.VENDOR V ON H.VN_CODE = V.VN_CODE
			INNER JOIN dbo.RADIO_DETAIL D ON MBWMDD.ORDER_NBR = D.ORDER_NBR AND MBWMDD.ORDER_LINE_NBR = D.LINE_NBR
		WHERE MBWMDD.ORDER_NBR IS NOT NULL
		AND MBWMD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = @MEDIA_BROADCAST_WORKSHEET_MARKET_ID
		GROUP BY
			V.VN_CODE,
			V.VN_NAME,
			MBWMDD.ORDER_NBR,
			MBWMDD.ORDER_LINE_NBR,
			MBWMD.LINE_NUMBER,
			D.MONTH_NBR,
			D.YEAR_NBR

	IF @debug = 1
		select * from #details

	IF @SELECT_BY = 2 OR @SELECT_BY = 3 BEGIN
		INSERT INTO #max_rev_status
			SELECT MAX(tos.REVISED_DATE), tos.ORDER_NBR, tos.LINE_NBR, tos.REV_NBR 
			FROM dbo.RADIO_ORDER_STATUS tos
				INNER JOIN #details d ON tos.ORDER_NBR = d.OrderNumber AND tos.LINE_NBR = d.LineNumber AND tos.REV_NBR = d.RevisionNumber 
			GROUP BY tos.ORDER_NBR, tos.LINE_NBR, tos.REV_NBR 

		IF @debug = 1
			select * from #max_rev_status

		IF @SELECT_BY = 2
			SELECT D.VendorCode,
				D.VendorName,
				D.OrderNumber,
				D.LineNumber,
				D.WorksheetLine,
				D.RevisionNumber,
				D.[Month],
				D.[Year],
				StatusDescription = os.STATUS_DESC,
				[Date] = tos.REVISED_DATE, 
				[By] = tos.REVISED_BY_NAME 
			FROM #details D
				INNER JOIN #max_rev_status mrs ON D.OrderNumber = mrs.ORDER_NBR AND D.LineNumber = mrs.LINE_NBR AND D.RevisionNumber = mrs.REV_NBR 
				INNER JOIN dbo.RADIO_ORDER_STATUS tos ON D.OrderNumber = tos.ORDER_NBR AND D.LineNumber = tos.LINE_NBR AND D.RevisionNumber = tos.REV_NBR AND mrs.REVISED_DATE = tos.REVISED_DATE 
				INNER JOIN dbo.ORDER_STATUS os ON tos.[STATUS] = os.[STATUS]
			ORDER BY 3,4,5
		ELSE IF @SELECT_BY = 3
			SELECT DISTINCT D.VendorCode,
				D.VendorName,
				D.OrderNumber,
				--D.LineNumber,
				D.WorksheetLine,
				D.RevisionNumber,
				--D.[Month],
				--D.[Year],
				StatusDescription = os.STATUS_DESC,
				[Date] = tos.REVISED_DATE, 
				[By] = tos.REVISED_BY_NAME 
			FROM #details D
				INNER JOIN #max_rev_status mrs ON D.OrderNumber = mrs.ORDER_NBR AND D.LineNumber = mrs.LINE_NBR AND D.RevisionNumber = mrs.REV_NBR 
				INNER JOIN dbo.RADIO_ORDER_STATUS tos ON D.OrderNumber = tos.ORDER_NBR AND D.LineNumber = tos.LINE_NBR AND D.RevisionNumber = tos.REV_NBR AND mrs.REVISED_DATE = tos.REVISED_DATE 
				INNER JOIN dbo.ORDER_STATUS os ON tos.[STATUS] = os.[STATUS]
			ORDER BY 3,4,5
	END ELSE
		SELECT D.*, StatusDescription = os.STATUS_DESC, [Date] = tos.REVISED_DATE, [By] = tos.REVISED_BY_NAME 
		FROM #details D
			INNER JOIN dbo.RADIO_ORDER_STATUS tos ON D.OrderNumber = tos.ORDER_NBR AND D.LineNumber = tos.LINE_NBR AND D.RevisionNumber = tos.REV_NBR 
			INNER JOIN dbo.ORDER_STATUS os ON tos.[STATUS] = os.[STATUS]
		ORDER BY 3,4,5

END
GO