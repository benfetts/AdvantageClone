CREATE PROCEDURE [dbo].[advsp_media_broadcast_worksheet_other_updated_rate_request_report]
	@MEDIA_BROADCAST_WORKSHEET_ID int, @MEDIA_BROADCAST_WORKSHEET_MARKET_ID_VENDOR_CODES varchar(max), @SHOW_RATINGS_CPP bit
AS
BEGIN

--declare @MEDIA_BROADCAST_WORKSHEET_ID int, @MEDIA_BROADCAST_WORKSHEET_MARKET_ID_VENDOR_CODES varchar(max), @SHOW_SECONDARY_DEMO bit
--set @MEDIA_BROADCAST_WORKSHEET_ID = 1
--set @MEDIA_BROADCAST_WORKSHEET_MARKET_ID_VENDOR_CODES = '6|8054,6|cast'

	SELECT DISTINCT
		[Rate] = MBWMDD.RATE,
		ClientName = C.CL_NAME,
		DivisionName = D.DIV_NAME,
		ProductDescription = P.PRD_DESCRIPTION,
		MediaBroadcastWorksheetName = MBW.[NAME],
		MarketName = M.MARKET_DESC + CASE WHEN MBWM.IS_CABLE = 1 THEN ' - CA' ELSE '' END,
		VendorCode = MBWMD.VN_CODE,
		VendorName = V.VN_NAME,
		FlightDates = CONVERT(CHAR(10),MBW.[START_DATE], 101) + ' - ' + CONVERT(CHAR(10),MBW.[END_DATE], 101),
		StationName = CASE 
						WHEN MBWM.IS_CABLE = 0 THEN 
							CASE WHEN V.IS_CABLE_SYSTEM = 1 THEN V.VN_CODE
							ELSE V.VN_NAME
							END
						WHEN MBWM.IS_CABLE = 1 THEN V.VN_CODE
						ELSE '' 
						END,
		[Days] = MBWMD.[DAYS],
		[Time] = dbo.advfn_format_airtime(MBWMD.START_TIME, MBWMD.END_TIME),
		Program = CASE WHEN NULLIF(MBWMD.CABLE_NETWORK_STATION_CODE,'') IS NOT NULL THEN MBWMD.CABLE_NETWORK_STATION_CODE + '/' + MBWMD.PROGRAM
					ELSE MBWMD.PROGRAM END,
		Daypart = DP.[DAY_PART_CODE],
		[Len] = MBWMD.[LENGTH],
		[NielsenTVStationCode] = CASE WHEN MBW.RATINGS_SERVICE_ID = 1 THEN COALESCE(V.NIELSEN_TV_STATION_CODE, MBWMD.CABLE_NETWORK_NIELSEN_TV_STATION_CODE)
										WHEN MBW.RATINGS_SERVICE_ID = 2 THEN COALESCE(V.COMSCORE_TV_STATION_ID, MBWMD.CABLE_NETWORK_NIELSEN_TV_STATION_CODE)
									END,
		NCCTVSyscodeID = V.NCC_TV_SYSCODE_ID,
		NielsenMarketNumber = CASE WHEN MBW.RATINGS_SERVICE_ID = 1 THEN CAST(COALESCE(M.NIELSEN_TV_CODE, 0) as integer)
									WHEN MBW.RATINGS_SERVICE_ID = 2 THEN CAST(COALESCE(M.COMSCORE_NEW_MARKET_NUMBER, 0) as integer)
									ELSE 0 END,
		PrimaryDemographicDescription = (SELECT [DESCRIPTION] FROM dbo.MEDIA_DEMO WHERE MEDIA_DEMO_ID = MBW.PRIMARY_MEDIA_DEMO_ID),
		SecondaryDemographicDescription = (SELECT [DESCRIPTION] FROM dbo.MEDIA_DEMO WHERE MEDIA_DEMO_ID = MBWM.SECONDARY_MEDIA_DEMO_ID),
		DetailDaypart = DP.[DAY_PART_CODE],
		MediaBroadcastWorksheetMarketID = MBWM.MEDIA_BROADCAST_WORKSHEET_MARKET_ID,
		RatingsServiceID = MBW.RATINGS_SERVICE_ID,
		RatingSource = CASE MBW.MEDIA_TYPE_CODE 
						WHEN 'T' THEN MBRS.[NAME]
						WHEN 'R' THEN (CASE MBWM.EXTERNAL_RADIO_SOURCE WHEN 0 THEN 'Nielsen' WHEN 1 THEN 'Eastlan' WHEN 2 THEN 'Nielsen County' ELSE 'N/A' END)
						ELSE 'N/A' END,
		PrimaryRating = CASE 
						WHEN MBW.MEDIA_TYPE_CODE = 'T' THEN MBWMD.PRIMARY_RATING
						WHEN MBW.MEDIA_TYPE_CODE = 'R' THEN MBWMD.PRIMARY_AQH_RATING
						END,
		SecondaryRating = CASE 
							WHEN MBW.MEDIA_TYPE_CODE = 'T' THEN MBWMD.SECONDARY_RATING
							WHEN MBW.MEDIA_TYPE_CODE = 'R' THEN MBWMD.SECONDARY_AQH_RATING 
							END,
		PrimaryImpressions = CASE 
								WHEN MBW.MEDIA_TYPE_CODE = 'T' THEN CAST(CAST(MBWMD.PRIMARY_IMPRESSIONS as decimal) / 1000 as decimal(18,1))
								WHEN MBW.MEDIA_TYPE_CODE = 'R' THEN CAST(CAST(MBWMD.PRIMARY_AQH as decimal) / 100 as decimal(18,1))
								END,
		SecondaryImpressions = CASE 
								WHEN MBW.MEDIA_TYPE_CODE = 'T' THEN CAST(CAST(MBWMD.SECONDARY_IMPRESSIONS as decimal) / 1000 as decimal(18,1))
								WHEN MBW.MEDIA_TYPE_CODE = 'R' THEN CAST(CAST(MBWMD.SECONDARY_AQH as decimal) / 100 as decimal(18,1))
								END,
		PrimaryCPM = CASE 
							WHEN MBW.MEDIA_TYPE_CODE = 'T' THEN 
								CASE WHEN MBWMD.PRIMARY_IMPRESSIONS = 0 THEN 0 ELSE MBWMDD.RATE / MBWMD.PRIMARY_IMPRESSIONS * 1000 END
							WHEN MBW.MEDIA_TYPE_CODE = 'R' THEN 
								CASE WHEN MBWMD.PRIMARY_AQH = 0 THEN 0 ELSE MBWMDD.RATE / MBWMD.PRIMARY_AQH * 1000 END
							END,
		SecondaryCPM = CASE 
							WHEN MBW.MEDIA_TYPE_CODE = 'T' THEN 
								CASE WHEN MBWMD.SECONDARY_IMPRESSIONS = 0 THEN 0 ELSE MBWMDD.RATE / MBWMD.SECONDARY_IMPRESSIONS * 1000 END
							WHEN MBW.MEDIA_TYPE_CODE = 'R' THEN
								CASE WHEN MBWMD.SECONDARY_AQH = 0 THEN 0 ELSE MBWMDD.RATE / MBWMD.SECONDARY_AQH * 1000 END
							END,
		PrimaryCPP = MBWMD.PRIMARY_CPP,
		SecondaryCPP = MBWMD.SECONDARY_CPP,
		SharebookID = MBWM.SHAREBOOK_NIELSEN_TV_BOOK_ID,
		HPUTbookID = MBWM.HUTPUT_NIELSEN_TV_BOOK_ID,
		MediaType = MBW.MEDIA_TYPE_CODE,
		StartHour = MBWMD.START_HOUR,
		EndHour = MBWMD.END_HOUR,
		RadioPeriod1 = MBWM.NIELSEN_RADIO_PERIOD_ID1,
		RadioPeriod2 = MBWM.NIELSEN_RADIO_PERIOD_ID2,
		RadioPeriod3 = MBWM.NIELSEN_RADIO_PERIOD_ID3,
		RadioPeriod4 = MBWM.NIELSEN_RADIO_PERIOD_ID4,
		RadioPeriod5 = MBWM.NIELSEN_RADIO_PERIOD_ID5,
		ShowRatingsCPP = @SHOW_RATINGS_CPP
	FROM dbo.MEDIA_BROADCAST_WORKSHEET MBW
		INNER JOIN dbo.CLIENT C ON MBW.CL_CODE = C.CL_CODE
		INNER JOIN dbo.DIVISION D ON MBW.CL_CODE = D.CL_CODE AND MBW.DIV_CODE = D.DIV_CODE
		INNER JOIN dbo.PRODUCT P ON MBW.CL_CODE = P.CL_CODE AND MBW.DIV_CODE = P.DIV_CODE AND MBW.PRD_CODE = P.PRD_CODE 
		INNER JOIN dbo.MEDIA_BROADCAST_WORKSHEET_MARKET MBWM ON MBW.MEDIA_BROADCAST_WORKSHEET_ID = MBWM.MEDIA_BROADCAST_WORKSHEET_ID 
		INNER JOIN dbo.MARKET M ON MBWM.MARKET_CODE = M.MARKET_CODE 
		INNER JOIN dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL MBWMD ON MBWM.MEDIA_BROADCAST_WORKSHEET_MARKET_ID = MBWMD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID 
																		AND MBWMD.ON_HOLD = 0
																		AND MBWMD.REVISION_NUMBER = (SELECT MAX(REVISION_NUMBER)
																									FROM dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL
																									WHERE MEDIA_BROADCAST_WORKSHEET_MARKET_ID = MBWM.MEDIA_BROADCAST_WORKSHEET_MARKET_ID)
		LEFT OUTER JOIN dbo.VENDOR V ON MBWMD.VN_CODE = V.VN_CODE
		LEFT OUTER JOIN dbo.DAY_PART DP ON MBWMD.DAY_PART_ID = DP.DAY_PART_ID 
		LEFT JOIN dbo.RATINGS_SERVICE MBRS ON MBRS.RATINGS_SERVICE_ID = MBW.RATINGS_SERVICE_ID 
		INNER JOIN dbo.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_DATE MBWMDD ON MBWMD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID = MBWMDD.MEDIA_BROADCAST_WORKSHEET_MARKET_DETAIL_ID

	WHERE 
		MBW.MEDIA_BROADCAST_WORKSHEET_ID = @MEDIA_BROADCAST_WORKSHEET_ID
	AND	CAST(MBWMD.MEDIA_BROADCAST_WORKSHEET_MARKET_ID as varchar) + '|' + MBWMD.VN_CODE IN (SELECT items FROM dbo.udf_split_list(@MEDIA_BROADCAST_WORKSHEET_MARKET_ID_VENDOR_CODES, ','))
	ORDER BY MarketName, StationName, DetailDaypart, StartHour, EndHour, [Days]

END
GO
