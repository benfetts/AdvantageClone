CREATE PROCEDURE [dbo].[advsp_media_type_template_daypart_percents]
	@MEDIA_PLAN_ESTIMATE_TEMPLATE_ID int,
	@INCLUDE_MARKET bit
AS

SELECT 
	ID = dpp.MEDIA_PLAN_ESTIMATE_TEMPLATE_DAYPART_PERCENT_ID,
	MediaPlanEstimateTemplateID = t.MEDIA_PLAN_ESTIMATE_TEMPLATE_ID,
    MediaPlanEstimateTemplateDaypartID = dp.MEDIA_PLAN_ESTIMATE_TEMPLATE_DAYPART_ID,
	Daypart = dpd.DAY_PART_CODE, -- + ' | ' + CAST(dp.[PERCENTAGE] as varchar) + '%',
    PercentageOrRate = COALESCE(dpp.[PERCENTAGE],0.00),
    DaypartDescription = dpd.[DESCRIPTION],
    DaypartID = dpd.DAY_PART_ID,
    MediaPlanEstimateTemplateMarketID = m.MEDIA_PLAN_ESTIMATE_TEMPLATE_MARKET_ID,
	Market = mkt.MARKET_DESC,
    MarketCode = mkt.MARKET_CODE
FROM dbo.MEDIA_PLAN_ESTIMATE_TEMPLATE t
	LEFT OUTER JOIN dbo.MEDIA_PLAN_ESTIMATE_TEMPLATE_DAYPART dp on t.MEDIA_PLAN_ESTIMATE_TEMPLATE_ID = dp.MEDIA_PLAN_ESTIMATE_TEMPLATE_ID 
	LEFT OUTER JOIN dbo.DAY_PART dpd ON dp.DAY_PART_ID = dpd.DAY_PART_ID 
	LEFT OUTER JOIN dbo.MEDIA_PLAN_ESTIMATE_TEMPLATE_MARKET m on @INCLUDE_MARKET = 1 AND t.MEDIA_PLAN_ESTIMATE_TEMPLATE_ID = m.MEDIA_PLAN_ESTIMATE_TEMPLATE_ID 
	LEFT OUTER JOIN dbo.MARKET mkt ON @INCLUDE_MARKET = 1 AND m.MARKET_CODE = mkt.MARKET_CODE 
	LEFT OUTER JOIN dbo.MEDIA_PLAN_ESTIMATE_TEMPLATE_DAYPART_PERCENT dpp ON dp.MEDIA_PLAN_ESTIMATE_TEMPLATE_DAYPART_ID = dpp.MEDIA_PLAN_ESTIMATE_TEMPLATE_DAYPART_ID AND
														COALESCE(dpp.MARKET_CODE,'') = COALESCE(mkt.MARKET_CODE,'')
WHERE t.MEDIA_PLAN_ESTIMATE_TEMPLATE_ID = @MEDIA_PLAN_ESTIMATE_TEMPLATE_ID
