CREATE PROCEDURE [dbo].[advsp_project_schedule_copyto_load_jobcomp]
	@USER_CODE VARCHAR(100)
AS
BEGIN

	DECLARE @ADVTF_USER_JOB_LIMITS TABLE (CL_CODE VARCHAR(6), DIV_CODE VARCHAR(6), PRD_CODE VARCHAR(6), TIME_ENTRY SMALLINT, JOB_NUMBER INT)
	DECLARE @Custom1Security bit

	INSERT INTO @ADVTF_USER_JOB_LIMITS
	SELECT CL_CODE, DIV_CODE, PRD_CODE, TIME_ENTRY, JOB_NUMBER FROM dbo.advtf_user_job_limits(@USER_CODE)

	SELECT @Custom1Security = Custom1
	FROM V_SEC_PERMISSION
	WHERE ApplicationID = (SELECT SEC_APPLICATION_ID FROM dbo.SEC_APPLICATION WHERE NAME = 'Webvantage')
	AND UserID = (SELECT SEC_USER_ID FROM dbo.SEC_USER WHERE UPPER(USER_CODE) = UPPER(@USER_CODE))
	AND ModuleCode = 'ProjectManagement_ProjectSchedule'

	SELECT
		[ID] = JC.ROWID,
		[JobNumber] = JC.JOB_NUMBER, 
		[JobDescription] = JL.JOB_DESC, 
		[JobComponentNumber] = JC.JOB_COMPONENT_NBR,
		[JobComponentDescription] = JC.JOB_COMP_DESC, 
		[ClientCode] = JL.CL_CODE,  
		[ClientName] = C.CL_NAME, 
		[DivisionCode] = JL.DIV_CODE,
		[DivisionName] = D.DIV_NAME, 
		[ProductCode] = JL.PRD_CODE, 
		[ProductDescription] = P.PRD_DESCRIPTION, 
		[OfficeCode] = JL.OFFICE_CODE, 
		[OfficeName] = O.OFFICE_NAME,
		[IsOpen] = ISNULL(JCO.[IS_OPEN], 0),
		[JobProcessControl] = JC.JOB_PROCESS_CONTRL,
		[SalesClassCode] = JL.SC_CODE, 
		[SalesClassDescription] = SC.SC_DESCRIPTION,  
		[JobTypeCode] = JC.JT_CODE, 
		[JobTypeDescription] = JT.JT_DESC,
		[PromotionType] = PT.PROMO_DESC,
		[CopyFromJobNumber] = JC.TRF_JOB_NUMBER,
		[CopyFromJobComponentNumber] = JC.TRF_JOB_COMPONENT_NBR
	FROM
		dbo.JOB_COMPONENT JC
		INNER JOIN @ADVTF_USER_JOB_LIMITS JLL ON JLL.JOB_NUMBER = JC.JOB_NUMBER
		INNER JOIN dbo.JOB_LOG JL ON JL.JOB_NUMBER = JC.JOB_NUMBER
		INNER JOIN dbo.CLIENT C ON C.CL_CODE = JL.CL_CODE 
		INNER JOIN dbo.PRODUCT P ON P.CL_CODE = JL.CL_CODE AND P.DIV_CODE = JL.DIV_CODE AND P.PRD_CODE = JL.PRD_CODE 
		INNER JOIN dbo.DIVISION D ON D.CL_CODE = JL.CL_CODE AND D.DIV_CODE = JL.DIV_CODE
		LEFT OUTER JOIN dbo.JOB_TRAFFIC JPS ON JPS.JOB_NUMBER = JC.JOB_NUMBER AND JPS.JOB_COMPONENT_NBR = JC.JOB_COMPONENT_NBR
		LEFT OUTER JOIN dbo.OFFICE O ON O.OFFICE_CODE = JL.OFFICE_CODE
		LEFT OUTER JOIN dbo.SALES_CLASS SC ON SC.SC_CODE = JL.SC_CODE
		LEFT OUTER JOIN dbo.JOB_TYPE JT ON JT.JT_CODE = JC.JT_CODE
		LEFT OUTER JOIN dbo.PROMO_TYPE PT ON PT.PROMO_CODE = JL.PROMO_CODE
		LEFT OUTER JOIN (SELECT 
								JOB_NUMBER, 
								JOB_COMPONENT_NBR,
								[IS_OPEN] = CASE WHEN JOB_PROCESS_CONTRL <> 6 AND JOB_PROCESS_CONTRL <> 12 THEN 1 ELSE 0 END
							FROM 
								dbo.JOB_COMPONENT) AS JCO ON JCO.JOB_NUMBER = JC.JOB_NUMBER
															 AND JCO.JOB_COMPONENT_NBR = JC.JOB_COMPONENT_NBR
	WHERE
		ISNULL(JCO.[IS_OPEN], 0) = 1
		AND 1 = CASE WHEN @Custom1Security = 1 AND ISNULL(JPS.IS_TEMPLATE, 0) = 1 THEN 0 ELSE 1 END 
	ORDER BY
		JC.JOB_NUMBER DESC, JC.JOB_COMPONENT_NBR;	
		
END
GO