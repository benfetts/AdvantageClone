CREATE PROCEDURE [dbo].[advsp_security_user_login_audit_dataset]
	@StartDate datetime,
	@EndDate datetime,
	@OnlyFailures bit
AS
BEGIN

	SELECT 
		[ID] = SULA.SEC_USER_LOGIN_AUDIT_ID,
		[UserCode] = SULA.USER_CODE,
		[Employee] = COALESCE((RTRIM(E.EMP_FNAME) + ' '), '') + COALESCE((E.EMP_MI + '. '), '') + COALESCE(E.EMP_LNAME, ''),
		[IPAddress] = SULA.IP_ADDRESS,
		[Application] = SA.[NAME],
		[LoginTime] = SULA.LOGIN_DATETIME,
		[LogoutTime] = CASE WHEN DATEPART(YEAR, SULA.LOGOUT_DATETIME) = 1 THEN NULL ELSE SULA.LOGOUT_DATETIME END,
		[Successful] = SULA.SUCCESSFUL,
		[FailureReason] = SULA.FAILURE_REASON
	FROM 
		[dbo].[SEC_USER_LOGIN_AUDIT] AS SULA
		LEFT OUTER JOIN [dbo].[SEC_USER] AS SU ON SU.USER_CODE = SULA.USER_CODE
		LEFT OUTER JOIN [dbo].[EMPLOYEE] AS E ON E.EMP_CODE = SU.EMP_CODE
		INNER JOIN [dbo].[SEC_APPLICATION] AS SA ON SA.SEC_APPLICATION_ID = SULA.SEC_APPLICATION_ID
	WHERE
		SULA.LOGIN_DATETIME >= @StartDate 
		AND SULA.LOGIN_DATETIME <= @EndDate 
		AND 0 = CASE WHEN @OnlyFailures = 1 THEN SULA.SUCCESSFUL ELSE 0 END

END
GO