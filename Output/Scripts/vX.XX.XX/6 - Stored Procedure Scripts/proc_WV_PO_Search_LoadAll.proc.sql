IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID(N'[dbo].[proc_WV_PO_Search_LoadAll]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [dbo].[proc_WV_PO_Search_LoadAll]
GO

CREATE PROCEDURE [dbo].[proc_WV_PO_Search_LoadAll]

  (@filter integer, @str1 varchar(15), @str2 varchar(15), @str3 smalldatetime, @str4 smalldatetime, @str5 varchar(15),
	  @str6 varchar(25), @str7 varchar(15), @str8 varchar(15), @str9 varchar(15), @str10 varchar(15), @str11 smalldatetime,
	  @str12 varchar(10), @sort varchar(50), @str13 varchar(15), @printed smallint, @str14 varchar(15), @voided as smallint, @closed as smallint,
	  @user_id varchar(100)
  ) 
  
AS

/* NOT USED IN .Net AT THIS POINT */

IF ISNULL(@user_id, '') > '' BEGIN
	SET @user_id = UPPER(@user_id)
END
ELSE BEGIN
	SET @user_id = ''
	--SELECT @user_id = UPPER(dbo.78())
END

-- AND search for Purchase Orders....

/*
declare @str1 varchar(15) --po
declare @str2 varchar(15) --descrip (like .. starts with - case insensitive.) 
declare @str3 varchar(15) --issue date
declare @str4 varchar(15) --due date
declare @str5 varchar(15) --emp code (issuer)
declare @str6 varchar(15) -- vendor code
declare @str7 varchar(15) -- client code (must have job relationship.)
declare @str8 varchar(15) -- division code (must have job relationship.)
declare @str9 varchar(15) -- product code (must have job relationship.)
declare @str10 varchar(15) -- job number
declare @str11 varchar(15) -- issue date end (range search)

select @str1=''
select @str2 = ''
select @str3 = '6/13/2007'
select @str4 = ''
select @str5 = ''
select @str6 = ''
select @str7 = ''
select @str8 = ''
select @str9 = ''
select @str10 = ''
select @str11 = '6/30/2007'
*/

IF (LTRIM(RTRIM(@str1)) <> '' OR LTRIM(RTRIM(@str2)) <> '' OR LTRIM(RTRIM(@str3)) <> '' OR LTRIM(RTRIM(@str4)) <> '' OR LTRIM(RTRIM(@str5)) <> ''
   OR LTRIM(RTRIM(@str6)) <> ''  OR LTRIM(RTRIM(@str7)) <> '' OR LTRIM(RTRIM(@str8)) <> '' OR LTRIM(RTRIM(@str9)) <> '' OR LTRIM(RTRIM(@str10)) <> ''
  OR LTRIM(RTRIM(@str11)) <> '' OR LTRIM(RTRIM(@str13)) <> '' OR @printed = 1 OR LTRIM(RTRIM(@str14)) <> '') 
BEGIN

	DECLARE @UserCode VARCHAR(100)
	DECLARE @EmployeeCode VARCHAR(6)
	DECLARE @IsLimitedByOffice BIT

	SELECT @UserCode = @user_id --dbo.fn_AdvanUser()
	SELECT @EmployeeCode = EMP_CODE FROM dbo.SEC_USER WHERE USER_CODE = @UserCode

	SET @IsLimitedByOffice = 0

	IF EXISTS (SELECT * FROM dbo.EMP_OFFICE WHERE EMP_CODE = @EmployeeCode)
		SET @IsLimitedByOffice = 1

	SET @str1 = LTRIM(RTRIM(@str1))
	SET @str2 = LTRIM(RTRIM(@str2))
	--SET @str3 = LTRIM(RTRIM(@str3))
	--SET @str4 = LTRIM(RTRIM(@str4))
	SET @str5 = LTRIM(RTRIM(@str5))
	SET @str6 = LTRIM(RTRIM(@str6))
	SET @str7 = LTRIM(RTRIM(@str7))
	SET @str8 = LTRIM(RTRIM(@str8))
	SET @str9 = LTRIM(RTRIM(@str9))
	SET @str10 = LTRIM(RTRIM(@str10))
	--SET @str11 = LTRIM(RTRIM(@str11))
	SET @str12 = LTRIM(RTRIM(@str12))
	SET @str13 = LTRIM(RTRIM(@str13))
	SET @str14 = LTRIM(RTRIM(@str14))

	SELECT DISTINCT
		[PO_NUMBER] = PURCHASE_ORDER.PO_NUMBER,
		[PO_PAD] = RIGHT('00000000' + CONVERT(VARCHAR(8), PURCHASE_ORDER.PO_NUMBER), 8),
		[DISPLAY_PO_NUMBER] = V_PURCHASE_ORDER.DISPLAY_PO_NUMBER,
		[PO_CREATE_DATE] = PURCHASE_ORDER.PO_CREATE_DATE,
		[ISSUED_BY] = V_PURCHASE_ORDER.EMP_NAME,
		[EMP_CODE] = PURCHASE_ORDER.EMP_CODE,
		[PO_DATE] = PURCHASE_ORDER.PO_DATE,
		[PO_DUE_DATE] = PURCHASE_ORDER.PO_DUE_DATE,
		[PO_DESCRIPTION] = ISNULL(PURCHASE_ORDER.PO_DESCRIPTION, ''),
		[VN_CODE] = PURCHASE_ORDER.VN_CODE,
		[PO_COMPLETE] = ISNULL(PURCHASE_ORDER.PO_COMPLETE, 0),
		[VOID_FLAG] = ISNULL(PURCHASE_ORDER.VOID_FLAG, 0),
		[VOID_INFO] = CASE WHEN PURCHASE_ORDER.VOID_FLAG = 1 THEN 'Voided ' + CONVERT(CHAR(10), PURCHASE_ORDER.VOID_DATE, 101) + ' by ' + LTRIM(PURCHASE_ORDER.VOIDED_BY) ELSE '' END,
		[PO_REVISION] = ISNULL(PO_REVISION, 0),
		[PO_WORK_COMPLETE] = PURCHASE_ORDER.PO_WORK_COMPLETE,
		[VN_NAME] = V_PURCHASE_ORDER.VN_NAME,
		[ISSUED_BY_EMP] = EMPLOYEE.EMP_LNAME + ', ' + EMPLOYEE.EMP_FNAME,
		[SEARCH_CODE] = 'All',
		[PO_APPROVAL_FLAG] = ISNULL(PURCHASE_ORDER.PO_APPROVAL_FLAG, 0)
	FROM
		dbo.PURCHASE_ORDER INNER JOIN
		dbo.V_PURCHASE_ORDER ON PURCHASE_ORDER.PO_NUMBER = V_PURCHASE_ORDER.PO_NUMBER LEFT JOIN
		dbo.PURCHASE_ORDER_DET ON PURCHASE_ORDER.PO_NUMBER = PURCHASE_ORDER_DET.PO_NUMBER LEFT JOIN
		dbo.JOB_LOG ON PURCHASE_ORDER_DET.JOB_NUMBER = JOB_LOG.JOB_NUMBER LEFT JOIN
		dbo.advtf_user_job_limits(@UserCode) JL ON PURCHASE_ORDER_DET.JOB_NUMBER = JL.JOB_NUMBER LEFT JOIN
		dbo.JOB_COMPONENT ON PURCHASE_ORDER_DET.JOB_NUMBER = JOB_COMPONENT.JOB_NUMBER AND
							 PURCHASE_ORDER_DET.JOB_COMPONENT_NBR = JOB_COMPONENT.JOB_COMPONENT_NBR LEFT JOIN
		dbo.VENDOR ON PURCHASE_ORDER.VN_CODE = VENDOR.VN_CODE LEFT JOIN
		dbo.advtf_employee_office_limits(@EmployeeCode) EO ON VENDOR.OFFICE_CODE = EO.OFFICE_CODE LEFT JOIN
		dbo.EMPLOYEE ON PURCHASE_ORDER.EMP_CODE = EMPLOYEE.EMP_CODE LEFT JOIN
		dbo.advtf_user_employee_limits(@UserCode) EL ON EMPLOYEE.EMP_CODE = EL.EMP_CODE LEFT JOIN
		(SELECT
			PO_APPROVAL.PO_NUMBER,
			PO_APPR_RULE_EMP.EMP_CODE
		 FROM
			dbo.PO_APPROVAL INNER JOIN
			dbo.PO_APPR_RULE_EMP ON PO_APPROVAL.PO_APPR_RULE_ID = PO_APPR_RULE_EMP.PO_APPR_RULE_ID) EMP_APPROVAL ON PURCHASE_ORDER.PO_NUMBER = EMP_APPROVAL.PO_NUMBER
	WHERE
		1 = CASE WHEN @str1 = '' THEN 1 WHEN PURCHASE_ORDER.PO_NUMBER = CAST(@str1 as varchar(15)) THEN 1 ELSE 0 END AND
		1 = CASE WHEN @str2 = '' THEN 1 WHEN LOWER(PURCHASE_ORDER.PO_DESCRIPTION) LIKE '%' + LOWER(CAST(@str2 AS VARCHAR(15))) + '%' THEN 1 ELSE 0 END AND
		1 = CASE WHEN ISNULL(@str3, '') = '' THEN 1 WHEN PURCHASE_ORDER.PO_DATE BETWEEN CAST(@str3 AS VARCHAR) AND CAST(ISNULL(@str11, @str3) AS VARCHAR) THEN 1 ELSE 0 END AND
		1 = CASE WHEN ISNULL(@str4, '') = '' THEN 1 WHEN PURCHASE_ORDER.PO_DUE_DATE = CAST(@str4 AS VARCHAR) THEN 1 ELSE 0 END AND
		1 = CASE WHEN @str5 = '' THEN 1 WHEN PURCHASE_ORDER.EMP_CODE = CAST(@str5 AS VARCHAR(15)) THEN 1 ELSE 0 END AND
		1 = CASE WHEN @str6 = '' THEN 1 WHEN PURCHASE_ORDER.VN_CODE = CAST(@str6 AS VARCHAR(15)) THEN 1 ELSE 0 END AND
		1 = CASE WHEN @str7 = '' THEN 1 WHEN JOB_LOG.CL_CODE = CAST(@str7 AS VARCHAR(15)) THEN 1 ELSE 0 END AND
		1 = CASE WHEN @str8 = '' THEN 1 WHEN JOB_LOG.DIV_CODE = CAST(@str8 AS VARCHAR(15)) THEN 1 ELSE 0 END AND
		1 = CASE WHEN @str9 = '' THEN 1 WHEN JOB_LOG.PRD_CODE = CAST(@str9 AS VARCHAR(15)) THEN 1 ELSE 0 END AND
		1 = CASE WHEN @str10 = '' THEN 1 WHEN JOB_LOG.JOB_NUMBER = CAST(@str10 AS VARCHAR(15)) THEN 1 ELSE 0 END AND
		1 = CASE WHEN @str12 = '' THEN 1 WHEN JOB_COMPONENT.JOB_NUMBER = CAST(@str10 AS VARCHAR(15)) AND JOB_COMPONENT.JOB_COMPONENT_NBR = CAST(@str12 AS VARCHAR(15)) THEN 1 ELSE 0 END AND
		1 = CASE WHEN @str13 = '0' THEN 1 WHEN PURCHASE_ORDER.PO_APPROVAL_FLAG = CAST(@str13 AS VARCHAR(15)) THEN 1 ELSE 0 END AND
		1 = CASE WHEN @str14 = '' THEN 1 WHEN EMP_APPROVAL.EMP_CODE = CAST(@str14 AS VARCHAR(15)) THEN 1 ELSE 0 END AND
		1 = CASE WHEN @printed = 1 THEN 
					CASE WHEN PURCHASE_ORDER.PO_PRINTED = 1 THEN 1 ELSE 0 END
				 WHEN @printed = 0 THEN
					CASE WHEN ISNULL(PURCHASE_ORDER.PO_PRINTED, 0) = 0 THEN 1 ELSE 0 END
				 ELSE 1 END AND
		1 = CASE WHEN @voided <> 1 THEN 1 WHEN ISNULL(PURCHASE_ORDER.VOID_FLAG, 0) = 0 THEN 1 ELSE 0 END AND
		1 = CASE WHEN @closed <> 1 THEN 1 WHEN ISNULL(PURCHASE_ORDER.PO_COMPLETE, 0) = 0 THEN 1 ELSE 0 END AND
		1 = CASE WHEN @IsLimitedByOffice = 0 OR PURCHASE_ORDER.VN_CODE IS NULL THEN 1 WHEN EO.OFFICE_CODE IS NOT NULL THEN 1 ELSE 0 END AND
		1 = CASE WHEN PURCHASE_ORDER.EMP_CODE IS NULL THEN 1 WHEN EL.EMP_CODE IS NOT NULL THEN 1 ELSE 0 END AND
		1 = CASE WHEN PURCHASE_ORDER_DET.JOB_NUMBER IS NULL THEN 1 WHEN JL.JOB_NUMBER IS NOT NULL THEN 1 ELSE 0 END
	ORDER BY
		PURCHASE_ORDER.PO_NUMBER DESC
	
END
GO

GRANT EXECUTE ON [proc_WV_PO_Search_LoadAll] TO PUBLIC AS dbo
GO

