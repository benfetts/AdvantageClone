/****** Object:  StoredProcedure [dbo].[usp_wv_Traffic_Schedule_CopyEmployees]    Script Date: 12/14/2020 1:52:46 PM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[usp_wv_Traffic_Schedule_CopyEmployees] 
@FROM_JOB_NUMBER AS INTEGER,
@FROM_JOB_COMPONENT_NBR AS SMALLINT,
@FROM_SEQ_NBR AS SMALLINT,
@TO_JOB_NUMBER AS INTEGER,
@TO_JOB_COMPONENT_NBR AS SMALLINT,
@TO_SEQ_NBR AS SMALLINT,
@HOURS AS DECIMAL
AS

DECLARE @FROM_HOURS_ALLOWED AS DECIMAL, @TO_HOURS_ALLOWED AS DECIMAL, @HOURS_ALLOWED AS DECIMAL

select @FROM_HOURS_ALLOWED = JOB_HRS from JOB_TRAFFIC_DET WHERE JOB_NUMBER = @FROM_JOB_NUMBER and JOB_COMPONENT_NBR = @FROM_JOB_COMPONENT_NBR and SEQ_NBR = @FROM_SEQ_NBR
select @TO_HOURS_ALLOWED = JOB_HRS from JOB_TRAFFIC_DET WHERE JOB_NUMBER = @TO_JOB_NUMBER and JOB_COMPONENT_NBR = @TO_JOB_COMPONENT_NBR and SEQ_NBR = @TO_SEQ_NBR

if @HOURS > 0
BEGIN
    SELECT @HOURS_ALLOWED = @HOURS

    INSERT INTO JOB_TRAFFIC_DET_EMPS WITH(ROWLOCK) (EMP_CODE, JOB_NUMBER, JOB_COMPONENT_NBR, SEQ_NBR, HOURS_ALLOWED)
    SELECT  DISTINCT EMP_CODE, @TO_JOB_NUMBER, @TO_JOB_COMPONENT_NBR, @TO_SEQ_NBR,  @HOURS_ALLOWED
    FROM JOB_TRAFFIC_DET_EMPS WHERE JOB_NUMBER = @FROM_JOB_NUMBER AND JOB_COMPONENT_NBR = @FROM_JOB_COMPONENT_NBR AND SEQ_NBR = @FROM_SEQ_NBR

END
ELSE
BEGIN
    --SELECT @HOURS_ALLOWED = HOURS_ALLOWED FROM JOB_TRAFFIC_DET_EMPS WHERE JOB_NUMBER = @FROM_JOB_NUMBER AND JOB_COMPONENT_NBR = @FROM_JOB_COMPONENT_NBR AND SEQ_NBR = @FROM_SEQ_NBR

    INSERT INTO JOB_TRAFFIC_DET_EMPS WITH(ROWLOCK) (EMP_CODE, JOB_NUMBER, JOB_COMPONENT_NBR, SEQ_NBR, HOURS_ALLOWED)
    SELECT  DISTINCT EMP_CODE, @TO_JOB_NUMBER, @TO_JOB_COMPONENT_NBR, @TO_SEQ_NBR,  HOURS_ALLOWED
    FROM JOB_TRAFFIC_DET_EMPS WHERE JOB_NUMBER = @FROM_JOB_NUMBER AND JOB_COMPONENT_NBR = @FROM_JOB_COMPONENT_NBR AND SEQ_NBR = @FROM_SEQ_NBR
END




GO


