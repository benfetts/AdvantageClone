IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[dbo].[usp_wv_Traffic_Schedule_GetTasks_Report]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
DROP PROCEDURE [dbo].[usp_wv_Traffic_Schedule_GetTasks_Report]
GO

CREATE PROCEDURE [dbo].[usp_wv_Traffic_Schedule_GetTasks_Report]
@JobNum AS INT,
@JobCompNum AS INT,
@Sort VARCHAR(10),
@MS as INT,
@Completed AS INT
AS
DECLARE @SQL VARCHAR(8000),
		@SCHEDULE_CALC INT

SELECT
	@SCHEDULE_CALC = ISNULL(SCHEDULE_CALC, 0)
FROM
	dbo.JOB_TRAFFIC
WHERE
	JOB_NUMBER = @JobNum AND
	JOB_COMPONENT_NBR = @JobCompNum
	
if @MS = 1
Begin
SET @SQL = '
SELECT     
	[ROWID] = V_JOB_TRAFFIC_DET.ROWID, 
	[JOB_NUMBER] = V_JOB_TRAFFIC_DET.JOB_NUMBER, 
	[JOB_COMPONENT_NBR] = V_JOB_TRAFFIC_DET.JOB_COMPONENT_NBR, 
	[SEQ_NBR] = V_JOB_TRAFFIC_DET.SEQ_NBR,
	[TASK_CODE] = V_JOB_TRAFFIC_DET.FNC_CODE, 
	[TASK_DESCRIPTION] = V_JOB_TRAFFIC_DET.TASK_DESCRIPTION, 
	[TASK_STATUS] = V_JOB_TRAFFIC_DET.TASK_STATUS,
	[FNC_EST] = V_JOB_TRAFFIC_DET.FNC_EST, 
	[TASK_START_DATE] = V_JOB_TRAFFIC_DET.TASK_START_DATE, 
	[JOB_REVISED_DATE] = V_JOB_TRAFFIC_DET.JOB_REVISED_DATE,
	[JOB_COMPLETED_DATE] = V_JOB_TRAFFIC_DET.JOB_COMPLETED_DATE, 
	[JOB_DUE_DATE] = V_JOB_TRAFFIC_DET.JOB_DUE_DATE,
	[REVISED_DUE_TIME] = V_JOB_TRAFFIC_DET.REVISED_DUE_TIME, 
	[TRAFFIC_PHASE_ID]= ISNULL(V_JOB_TRAFFIC_DET.TRAFFIC_PHASE_ID, 0), 
	[PHASE_ORDER]= TRAFFIC_PHASE.PHASE_ORDER,
	[PHASE_DESC]= TRAFFIC_PHASE.PHASE_DESC, 
	[JOB_ORDER]= V_JOB_TRAFFIC_DET.JOB_ORDER, 
	[JOB_DAYS]= V_JOB_TRAFFIC_DET.JOB_DAYS, --V_JOB_TRAFFIC_DET.JOB_HRS,
	[DUE_TIME]= V_JOB_TRAFFIC_DET.DUE_TIME, 
	[MILESTONE]= V_JOB_TRAFFIC_DET.MILESTONE, 
	[PREDECESSOR]= ''1'', 
	[DUE_DATE_LOCK]= ISNULL(V_JOB_TRAFFIC_DET.DUE_DATE_LOCK, 0), 
	[FNC_COMMENTS]= CAST(V_JOB_TRAFFIC_DET.FNC_COMMENTS AS VARCHAR(4000)), 
	[DUE_DATE_COMMENTS]= CAST(V_JOB_TRAFFIC_DET.DUE_DATE_COMMENTS AS VARCHAR(4000)), 
	[REV_DATE_COMMENTS]= CAST(V_JOB_TRAFFIC_DET.REV_DATE_COMMENTS AS VARCHAR(4000)), 
	[DISPERSED_HOURS]= ISNULL(SUM(V_JOB_TRAFFIC_DET.JOB_HRS), 0), 
	[EMP_LNAME_LIST]= V_JOB_TRAFFIC_DET_EMPS.EMP_LNAME_LIST, 
	[CLIENT_LNAME_LIST]= V_JOB_TRAFFIC_DET_CLIENTS.CLIENT_LNAME_LIST, 
	[HAS_CHILDREN]= HT.HAS_CHILDREN,
	[PHASE_ORDER_ID]= CAST(ISNULL(TRAFFIC_PHASE.PHASE_ORDER,0) AS VARCHAR(4)) + ''-'' + CAST(ISNULL(V_JOB_TRAFFIC_DET.TRAFFIC_PHASE_ID, 0) AS VARCHAR(4))
FROM         
	dbo.JOB_COMPONENT INNER JOIN
    dbo.V_JOB_TRAFFIC_DET ON JOB_COMPONENT.JOB_NUMBER = V_JOB_TRAFFIC_DET.JOB_NUMBER AND 
							 JOB_COMPONENT.JOB_COMPONENT_NBR = V_JOB_TRAFFIC_DET.JOB_COMPONENT_NBR INNER JOIN
	dbo.JOB_TRAFFIC_DET ON V_JOB_TRAFFIC_DET.JOB_NUMBER = JOB_TRAFFIC_DET.JOB_NUMBER AND
						   V_JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = JOB_TRAFFIC_DET.JOB_COMPONENT_NBR AND
						   V_JOB_TRAFFIC_DET.SEQ_NBR = JOB_TRAFFIC_DET.SEQ_NBR LEFT OUTER JOIN
    dbo.TRAFFIC_PHASE ON V_JOB_TRAFFIC_DET.TRAFFIC_PHASE_ID = TRAFFIC_PHASE.TRAFFIC_PHASE_ID INNER JOIN
	dbo.V_JOB_TRAFFIC_DET_EMPS ON V_JOB_TRAFFIC_DET.JOB_NUMBER = V_JOB_TRAFFIC_DET_EMPS.JOB_NUMBER AND 
								  V_JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = V_JOB_TRAFFIC_DET_EMPS.JOB_COMPONENT_NBR AND 
								  V_JOB_TRAFFIC_DET.SEQ_NBR = V_JOB_TRAFFIC_DET_EMPS.SEQ_NBR LEFT OUTER JOIN
    dbo.V_JOB_TRAFFIC_DET_CLIENTS ON V_JOB_TRAFFIC_DET.JOB_NUMBER = V_JOB_TRAFFIC_DET_CLIENTS.JOB_NUMBER AND 
									 V_JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = V_JOB_TRAFFIC_DET_CLIENTS.JOB_COMPONENT_NBR AND 
									 V_JOB_TRAFFIC_DET.SEQ_NBR = V_JOB_TRAFFIC_DET_CLIENTS.SEQ_NBR INNER JOIN
	dbo.advtf_traffic_schedule_GetHierarchyDates(' + CAST(@JobNum AS VARCHAR)+', ' + CAST(@JobCompNum AS VARCHAR)+') HT ON V_JOB_TRAFFIC_DET.JOB_NUMBER = HT.JOB_NUMBER AND
																														   V_JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = HT.JOB_COMPONENT_NBR AND
																														   V_JOB_TRAFFIC_DET.SEQ_NBR = HT.SEQ_NBR
WHERE     
	(V_JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = ' + CAST(@JobCompNum AS VARCHAR)+') AND 
	(V_JOB_TRAFFIC_DET.JOB_NUMBER = ' + CAST(@JobNum AS VARCHAR)+') AND (V_JOB_TRAFFIC_DET.MILESTONE = 1)'
	IF @Completed = 0
	BEGIN
		SET @SQL = @SQL + ' AND JOB_TRAFFIC_DET.JOB_COMPLETED_DATE IS NULL '
	END
SET @SQL = @SQL + ' GROUP BY 
	V_JOB_TRAFFIC_DET.ROWID, 
	V_JOB_TRAFFIC_DET.JOB_NUMBER, 
	V_JOB_TRAFFIC_DET.JOB_COMPONENT_NBR, 
	V_JOB_TRAFFIC_DET.SEQ_NBR,
	V_JOB_TRAFFIC_DET.FNC_CODE, 
	V_JOB_TRAFFIC_DET.TASK_DESCRIPTION, 
	V_JOB_TRAFFIC_DET.TASK_STATUS, 
	V_JOB_TRAFFIC_DET.FNC_EST,
	V_JOB_TRAFFIC_DET.TASK_START_DATE, 
	V_JOB_TRAFFIC_DET.JOB_REVISED_DATE, 
	V_JOB_TRAFFIC_DET.REVISED_DUE_TIME,
	V_JOB_TRAFFIC_DET.JOB_COMPLETED_DATE, --V_JOB_TRAFFIC_DET.TEMP_COMP_DATE,
	CAST(V_JOB_TRAFFIC_DET.FNC_COMMENTS AS VARCHAR(4000)), 
	V_JOB_TRAFFIC_DET.TRAFFIC_PHASE_ID, 
	TRAFFIC_PHASE.PHASE_ORDER,
	TRAFFIC_PHASE.PHASE_DESC, 
	V_JOB_TRAFFIC_DET.JOB_ORDER, 
	V_JOB_TRAFFIC_DET.JOB_DAYS, 
	V_JOB_TRAFFIC_DET.DUE_DATE_LOCK,
	CAST(V_JOB_TRAFFIC_DET.DUE_DATE_COMMENTS AS VARCHAR(4000)), 
	CAST(V_JOB_TRAFFIC_DET.REV_DATE_COMMENTS AS VARCHAR(4000)),
	V_JOB_TRAFFIC_DET.DUE_TIME, 
	V_JOB_TRAFFIC_DET.MILESTONE, 
	V_JOB_TRAFFIC_DET.JOB_DUE_DATE, 
	V_JOB_TRAFFIC_DET_EMPS.EMP_LNAME_LIST, 
	V_JOB_TRAFFIC_DET_CLIENTS.CLIENT_LNAME_LIST,
	JOB_TRAFFIC_DET.GRID_ORDER,
	HT.ROW_ORDER,
	HT.HAS_CHILDREN '

IF @SCHEDULE_CALC = 1
BEGIN
	SET @SQL = @SQL + '
	ORDER BY 
		HT.ROW_ORDER ASC
	'
END

IF @SCHEDULE_CALC = 0
	BEGIN
		SET @SQL = @SQL + '
		ORDER BY 
			COALESCE(V_JOB_TRAFFIC_DET.JOB_ORDER, V_JOB_TRAFFIC_DET.TASK_START_DATE) ASC,
			ISNULL(JOB_TRAFFIC_DET.GRID_ORDER, V_JOB_TRAFFIC_DET.SEQ_NBR) ASC
		'
	END

--ORDER BY TRAFFIC_PHASE.PHASE_ORDER, V_JOB_TRAFFIC_DET.JOB_ORDER, V_JOB_TRAFFIC_DET.TASK_START_DATE, V_JOB_TRAFFIC_DET.JOB_REVISED_DATE, V_JOB_TRAFFIC_DET.SEQ_NBR
--IF @SCHEDULE_CALC = 1
--	BEGIN
--		SET @SQL = @SQL + '
--		ORDER BY 
--		'

--IF @Sort = 'startdue'
--	BEGIN
--		SET @SQL = @SQL + '
--		ORDER BY V_JOB_TRAFFIC_DET.TASK_START_DATE, V_JOB_TRAFFIC_DET.JOB_REVISED_DATE, V_JOB_TRAFFIC_DET.JOB_DUE_DATE, V_JOB_TRAFFIC_DET.JOB_ORDER ASC, V_JOB_TRAFFIC_DET.SEQ_NBR ASC
--		'
--	END
--IF @Sort = 'phase'
--	BEGIN
--		SET @SQL = @SQL + '
--		ORDER BY TRAFFIC_PHASE.PHASE_ORDER ASC, TRAFFIC_PHASE.PHASE_DESC ASC, V_JOB_TRAFFIC_DET.TASK_START_DATE, V_JOB_TRAFFIC_DET.JOB_REVISED_DATE ASC, V_JOB_TRAFFIC_DET.JOB_ORDER ASC, V_JOB_TRAFFIC_DET.SEQ_NBR ASC
--		'
--	END
--IF @Sort = 'order'
--	BEGIN
--		SET @SQL = @SQL + '
--		ORDER BY V_JOB_TRAFFIC_DET.JOB_ORDER ASC, V_JOB_TRAFFIC_DET.TASK_START_DATE, V_JOB_TRAFFIC_DET.JOB_REVISED_DATE ASC, V_JOB_TRAFFIC_DET.SEQ_NBR ASC
--		'
--	END
--IF @Sort = ''
--	BEGIN
--		SET @SQL = @SQL + '
--		ORDER BY V_JOB_TRAFFIC_DET.TASK_START_DATE, V_JOB_TRAFFIC_DET.JOB_REVISED_DATE, V_JOB_TRAFFIC_DET.JOB_DUE_DATE, V_JOB_TRAFFIC_DET.JOB_ORDER ASC, V_JOB_TRAFFIC_DET.SEQ_NBR ASC
--		'
--	END
End
Else
Begin
SET @SQL = '
SELECT     
	[ROWID] = V_JOB_TRAFFIC_DET.ROWID, 
	[JOB_NUMBER] = V_JOB_TRAFFIC_DET.JOB_NUMBER, 
	[JOB_COMPONENT_NBR] = V_JOB_TRAFFIC_DET.JOB_COMPONENT_NBR, 
	[SEQ_NBR] = V_JOB_TRAFFIC_DET.SEQ_NBR, 
	[TASK_CODE] = V_JOB_TRAFFIC_DET.FNC_CODE, 
	[TASK_DESCRIPTION] = V_JOB_TRAFFIC_DET.TASK_DESCRIPTION, 
	[TASK_STATUS] = V_JOB_TRAFFIC_DET.TASK_STATUS, 
	[FNC_EST] = V_JOB_TRAFFIC_DET.FNC_EST, 
	[TASK_START_DATE] = V_JOB_TRAFFIC_DET.TASK_START_DATE, 
	[JOB_REVISED_DATE] = V_JOB_TRAFFIC_DET.JOB_REVISED_DATE, 
	[JOB_COMPLETED_DATE] = V_JOB_TRAFFIC_DET.JOB_COMPLETED_DATE, 
	[JOB_DUE_DATE] = V_JOB_TRAFFIC_DET.JOB_DUE_DATE,  
	[REVISED_DUE_TIME] = V_JOB_TRAFFIC_DET.REVISED_DUE_TIME, 
	[TRAFFIC_PHASE_ID] = ISNULL(V_JOB_TRAFFIC_DET.TRAFFIC_PHASE_ID, 0), 
	[PHASE_ORDER] = TRAFFIC_PHASE.PHASE_ORDER, 
	[PHASE_DESC] = TRAFFIC_PHASE.PHASE_DESC, 
	[JOB_ORDER] = V_JOB_TRAFFIC_DET.JOB_ORDER, 
	[JOB_DAYS] = V_JOB_TRAFFIC_DET.JOB_DAYS, --V_JOB_TRAFFIC_DET.JOB_HRS, 
	[DUE_TIME] = V_JOB_TRAFFIC_DET.DUE_TIME, 
	[MILESTONE] = V_JOB_TRAFFIC_DET.MILESTONE, 
	[PREDECESSOR] = ''1'', 
	[DUE_DATE_LOCK] = ISNULL(V_JOB_TRAFFIC_DET.DUE_DATE_LOCK, 0), 
	[FNC_COMMENTS] = CAST(V_JOB_TRAFFIC_DET.FNC_COMMENTS AS VARCHAR(4000)), 
	[DUE_DATE_COMMENTS] = CAST(V_JOB_TRAFFIC_DET.DUE_DATE_COMMENTS AS VARCHAR(4000)), 
	[REV_DATE_COMMENTS] = CAST(V_JOB_TRAFFIC_DET.REV_DATE_COMMENTS AS VARCHAR(4000)), 
	[DISPERSED_HOURS] = ISNULL(SUM(V_JOB_TRAFFIC_DET.JOB_HRS), 0), 
	[EMP_LNAME_LIST] = V_JOB_TRAFFIC_DET_EMPS.EMP_LNAME_LIST, 
	[CLIENT_LNAME_LIST] = V_JOB_TRAFFIC_DET_CLIENTS.CLIENT_LNAME_LIST,
	[HAS_CHILDREN] = HT.HAS_CHILDREN,
	[PHASE_ORDER_ID]= CAST(ISNULL(TRAFFIC_PHASE.PHASE_ORDER,0) AS VARCHAR(4)) + ''-'' + CAST(ISNULL(V_JOB_TRAFFIC_DET.TRAFFIC_PHASE_ID, 0) AS VARCHAR(4))
FROM         
	dbo.JOB_COMPONENT INNER JOIN
	dbo.V_JOB_TRAFFIC_DET ON JOB_COMPONENT.JOB_NUMBER = V_JOB_TRAFFIC_DET.JOB_NUMBER AND 
							 JOB_COMPONENT.JOB_COMPONENT_NBR = V_JOB_TRAFFIC_DET.JOB_COMPONENT_NBR INNER JOIN
	dbo.JOB_TRAFFIC_DET ON V_JOB_TRAFFIC_DET.JOB_NUMBER = JOB_TRAFFIC_DET.JOB_NUMBER AND
						   V_JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = JOB_TRAFFIC_DET.JOB_COMPONENT_NBR AND
						   V_JOB_TRAFFIC_DET.SEQ_NBR = JOB_TRAFFIC_DET.SEQ_NBR LEFT OUTER JOIN
	dbo.TRAFFIC_PHASE ON V_JOB_TRAFFIC_DET.TRAFFIC_PHASE_ID = TRAFFIC_PHASE.TRAFFIC_PHASE_ID INNER JOIN
	dbo.V_JOB_TRAFFIC_DET_EMPS ON V_JOB_TRAFFIC_DET.JOB_NUMBER = V_JOB_TRAFFIC_DET_EMPS.JOB_NUMBER AND 
								  V_JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = V_JOB_TRAFFIC_DET_EMPS.JOB_COMPONENT_NBR AND 
								  V_JOB_TRAFFIC_DET.SEQ_NBR = V_JOB_TRAFFIC_DET_EMPS.SEQ_NBR LEFT OUTER JOIN
	dbo.V_JOB_TRAFFIC_DET_CLIENTS ON V_JOB_TRAFFIC_DET.JOB_NUMBER = V_JOB_TRAFFIC_DET_CLIENTS.JOB_NUMBER AND 
									 V_JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = V_JOB_TRAFFIC_DET_CLIENTS.JOB_COMPONENT_NBR AND 
									 V_JOB_TRAFFIC_DET.SEQ_NBR = V_JOB_TRAFFIC_DET_CLIENTS.SEQ_NBR INNER JOIN
	dbo.advtf_traffic_schedule_GetHierarchyDates(' + CAST(@JobNum AS VARCHAR)+', ' + CAST(@JobCompNum AS VARCHAR)+') HT ON V_JOB_TRAFFIC_DET.JOB_NUMBER = HT.JOB_NUMBER AND
																														   V_JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = HT.JOB_COMPONENT_NBR AND
																														   V_JOB_TRAFFIC_DET.SEQ_NBR = HT.SEQ_NBR
WHERE     
	(V_JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = ' + CAST(@JobCompNum AS VARCHAR)+') AND 
    (V_JOB_TRAFFIC_DET.JOB_NUMBER = ' + CAST(@JobNum AS VARCHAR)+')'
	IF @Completed = 0
	BEGIN
		SET @SQL = @SQL + ' AND JOB_TRAFFIC_DET.JOB_COMPLETED_DATE IS NULL '
	END
SET @SQL = @SQL + '
GROUP BY 
	V_JOB_TRAFFIC_DET.ROWID, 
	V_JOB_TRAFFIC_DET.JOB_NUMBER, 
	V_JOB_TRAFFIC_DET.JOB_COMPONENT_NBR, 
	V_JOB_TRAFFIC_DET.SEQ_NBR, 
	V_JOB_TRAFFIC_DET.FNC_CODE, 
	V_JOB_TRAFFIC_DET.TASK_DESCRIPTION, 
	V_JOB_TRAFFIC_DET.TASK_STATUS, 
	V_JOB_TRAFFIC_DET.FNC_EST, 
	V_JOB_TRAFFIC_DET.TASK_START_DATE, 
	V_JOB_TRAFFIC_DET.JOB_REVISED_DATE, 
	V_JOB_TRAFFIC_DET.REVISED_DUE_TIME, 
	V_JOB_TRAFFIC_DET.JOB_COMPLETED_DATE, --V_JOB_TRAFFIC_DET.TEMP_COMP_DATE, 
	CAST(V_JOB_TRAFFIC_DET.FNC_COMMENTS AS VARCHAR(4000)), 
	V_JOB_TRAFFIC_DET.TRAFFIC_PHASE_ID, 
	TRAFFIC_PHASE.PHASE_ORDER, 
	TRAFFIC_PHASE.PHASE_DESC, 
	V_JOB_TRAFFIC_DET.JOB_ORDER, 
	V_JOB_TRAFFIC_DET.JOB_DAYS, 
	V_JOB_TRAFFIC_DET.DUE_DATE_LOCK, 
	CAST(V_JOB_TRAFFIC_DET.DUE_DATE_COMMENTS AS VARCHAR(4000)), 
	CAST(V_JOB_TRAFFIC_DET.REV_DATE_COMMENTS AS VARCHAR(4000)), 
	V_JOB_TRAFFIC_DET.DUE_TIME, 
	V_JOB_TRAFFIC_DET.MILESTONE, 
	V_JOB_TRAFFIC_DET.JOB_DUE_DATE, 
	V_JOB_TRAFFIC_DET_EMPS.EMP_LNAME_LIST, 
	V_JOB_TRAFFIC_DET_CLIENTS.CLIENT_LNAME_LIST,
	JOB_TRAFFIC_DET.GRID_ORDER,
	HT.ROW_ORDER,
	HT.HAS_CHILDREN '

IF @SCHEDULE_CALC = 1
	BEGIN
		SET @SQL = @SQL + '
		ORDER BY 
			HT.ROW_ORDER ASC
		'
	END

IF @SCHEDULE_CALC = 0
	BEGIN
		SET @SQL = @SQL + '
		ORDER BY 
			COALESCE(V_JOB_TRAFFIC_DET.JOB_ORDER, V_JOB_TRAFFIC_DET.TASK_START_DATE) ASC,
			ISNULL(JOB_TRAFFIC_DET.GRID_ORDER, V_JOB_TRAFFIC_DET.SEQ_NBR) ASC
		'
	END

--ORDER BY TRAFFIC_PHASE.PHASE_ORDER, V_JOB_TRAFFIC_DET.JOB_ORDER, V_JOB_TRAFFIC_DET.TASK_START_DATE, V_JOB_TRAFFIC_DET.JOB_REVISED_DATE, V_JOB_TRAFFIC_DET.SEQ_NBR
--IF @Sort = 'startdue'
--	BEGIN
--		SET @SQL = @SQL + '
--		ORDER BY V_JOB_TRAFFIC_DET.TASK_START_DATE, V_JOB_TRAFFIC_DET.JOB_REVISED_DATE, V_JOB_TRAFFIC_DET.JOB_DUE_DATE, V_JOB_TRAFFIC_DET.JOB_ORDER ASC, V_JOB_TRAFFIC_DET.SEQ_NBR ASC
--		'
--	END
--IF @Sort = 'phase'
--	BEGIN
--		SET @SQL = @SQL + '
--		ORDER BY TRAFFIC_PHASE.PHASE_ORDER ASC, TRAFFIC_PHASE.PHASE_DESC ASC, V_JOB_TRAFFIC_DET.TASK_START_DATE, V_JOB_TRAFFIC_DET.JOB_REVISED_DATE ASC, V_JOB_TRAFFIC_DET.JOB_ORDER ASC, V_JOB_TRAFFIC_DET.SEQ_NBR ASC
--		'
--	END
--IF @Sort = 'order'
--	BEGIN
--		SET @SQL = @SQL + '
--		ORDER BY V_JOB_TRAFFIC_DET.JOB_ORDER ASC, V_JOB_TRAFFIC_DET.TASK_START_DATE, V_JOB_TRAFFIC_DET.JOB_REVISED_DATE ASC, V_JOB_TRAFFIC_DET.SEQ_NBR ASC
--		'
--	END
--IF @Sort = ''
--	BEGIN
--		SET @SQL = @SQL + '
--		ORDER BY V_JOB_TRAFFIC_DET.TASK_START_DATE, V_JOB_TRAFFIC_DET.JOB_REVISED_DATE, V_JOB_TRAFFIC_DET.JOB_DUE_DATE, V_JOB_TRAFFIC_DET.JOB_ORDER ASC, V_JOB_TRAFFIC_DET.SEQ_NBR ASC
--		'
--	END
End

PRINT @SQL
EXEC (@SQL)

SELECT ALERT.ALERT_ID, JOB_TRAFFIC_DET.JOB_NUMBER, JOB_TRAFFIC_DET.JOB_COMPONENT_NBR, JOB_TRAFFIC_DET.SEQ_NBR, 
                      ALERT.DUE_DATE, ALERT_STATES.ALERT_STATE_ID, ALERT_STATES.ALERT_STATE_NAME
FROM ALERT INNER JOIN
         ALERT_STATES ON ALERT.ALERT_STATE_ID = ALERT_STATES.ALERT_STATE_ID INNER JOIN
         JOB_TRAFFIC_DET ON ALERT.JOB_NUMBER = JOB_TRAFFIC_DET.JOB_NUMBER AND 
         ALERT.JOB_COMPONENT_NBR = JOB_TRAFFIC_DET.JOB_COMPONENT_NBR AND ALERT.TASK_SEQ_NBR = JOB_TRAFFIC_DET.SEQ_NBR
WHERE (JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = @JobCompNum) AND 
                      (JOB_TRAFFIC_DET.JOB_NUMBER = @JobNum)