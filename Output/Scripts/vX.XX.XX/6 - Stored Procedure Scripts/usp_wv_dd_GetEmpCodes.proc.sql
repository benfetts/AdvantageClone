
SET ANSI_NULLS OFF
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[usp_wv_dd_GetEmpCodes] 
@USER_CODE VARCHAR(100) ,
@SHOW_ALL TINYINT,
@OVERRIDE_SEC_EMP TINYINT,
@FROM_TS BIT
AS
BEGIN
	DECLARE 
		@RESTRICTED AS INT,
		@OfficeRestrictions AS INT,
		@EMP_CODE AS VARCHAR(6)
	IF @OVERRIDE_SEC_EMP IS NULL SET @OVERRIDE_SEC_EMP = 0;
	IF @OVERRIDE_SEC_EMP = 1
	BEGIN
		SET @RESTRICTED = 0;
	END
	ELSE
	BEGIN
		SELECT @RESTRICTED = COUNT(*) FROM SEC_EMP WITH(NOLOCK) WHERE UPPER(USER_ID) = UPPER(@USER_CODE);
	END

	SELECT @EMP_CODE = EMP_CODE FROM [dbo].[SEC_USER] WHERE UPPER([USER_CODE]) = UPPER(@USER_CODE);
	SELECT @OfficeRestrictions = COUNT(*) FROM EMP_OFFICE WHERE EMP_CODE = @EMP_CODE;

	IF @SHOW_ALL IS NULL
	BEGIN
		SET @SHOW_ALL = 0;
	END

	IF @FROM_TS = 1
	BEGIN
		IF @SHOW_ALL = 0
		BEGIN
			IF @RESTRICTED > 0
				SELECT 
					EMPLOYEE.EMP_CODE Code,
					EMPLOYEE.EMP_CODE + ' - ' + ISNULL(EMPLOYEE.EMP_LNAME, EMPLOYEE.EMP_CODE)  + ', ' + ISNULL(EMPLOYEE.EMP_FNAME, '') Description
					,EMPLOYEE.EMP_LNAME LastName
					,EMPLOYEE.EMP_MI MiddleInitial
					,EMPLOYEE.EMP_FNAME FirstName
					,EMPLOYEE.EMP_TITLE Title
				FROM   
					EMPLOYEE WITH(NOLOCK)
					INNER JOIN [dbo].[advtf_sec_emp] (@USER_CODE) AS SEC_EMP ON  EMPLOYEE.EMP_CODE = SEC_EMP.EMP_CODE
				WHERE  
					(EMP_TERM_DATE IS NULL OR EMP_TERM_DATE > GETDATE())
					order by EMPLOYEE.EMP_FNAME, EMPLOYEE.EMP_MI, EMPLOYEE.EMP_LNAME
			ELSE
				SELECT 
					EMP_CODE Code,
					EMPLOYEE.EMP_CODE + ' - ' + ISNULL(EMPLOYEE.EMP_LNAME, EMPLOYEE.EMP_CODE)  + ', ' + ISNULL(EMPLOYEE.EMP_FNAME, '') Description
					,EMPLOYEE.EMP_LNAME LastName
					,EMPLOYEE.EMP_MI MiddleInitial
					,EMPLOYEE.EMP_FNAME FirstName
					,EMPLOYEE.EMP_TITLE Title
				FROM   
					EMPLOYEE WITH(NOLOCK)
				WHERE  
					(EMP_TERM_DATE IS NULL OR EMP_TERM_DATE > GETDATE())
					order by EMPLOYEE.EMP_FNAME, EMPLOYEE.EMP_MI, EMPLOYEE.EMP_LNAME
		END
		IF @SHOW_ALL = 1
		BEGIN
			IF @RESTRICTED > 0
				SELECT 
					EMPLOYEE.EMP_CODE Code,
					EMPLOYEE.EMP_CODE + ' - ' + ISNULL(EMPLOYEE.EMP_LNAME, EMPLOYEE.EMP_CODE)  + ', ' + ISNULL(EMPLOYEE.EMP_FNAME, '') Description
					,EMPLOYEE.EMP_LNAME LastName
					,EMPLOYEE.EMP_MI MiddleInitial
					,EMPLOYEE.EMP_FNAME FirstName
					,EMPLOYEE.EMP_TITLE Title
				FROM   
					EMPLOYEE WITH(NOLOCK)
					INNER JOIN [dbo].[advtf_sec_emp] (@USER_CODE) AS SEC_EMP ON  EMPLOYEE.EMP_CODE = SEC_EMP.EMP_CODE
					order by EMPLOYEE.EMP_FNAME, EMPLOYEE.EMP_MI, EMPLOYEE.EMP_LNAME
			ELSE
				SELECT 
					EMP_CODE Code,
					EMPLOYEE.EMP_CODE + ' - ' + ISNULL(EMPLOYEE.EMP_LNAME, EMPLOYEE.EMP_CODE)  + ', ' + ISNULL(EMPLOYEE.EMP_FNAME, '') Description
					,EMPLOYEE.EMP_LNAME LastName
					,EMPLOYEE.EMP_MI MiddleInitial
					,EMPLOYEE.EMP_FNAME FirstName
					,EMPLOYEE.EMP_TITLE Title
				FROM   
					EMPLOYEE WITH(NOLOCK)
					order by EMPLOYEE.EMP_FNAME, EMPLOYEE.EMP_MI, EMPLOYEE.EMP_LNAME
		END
	END
	ELSE
	BEGIN
		IF @SHOW_ALL = 0
		BEGIN
			IF @RESTRICTED > 0
				IF @OfficeRestrictions > 0
				BEGIN
					SELECT 
						EMPLOYEE.EMP_CODE Code,
						EMPLOYEE.EMP_CODE + ' - ' + ISNULL(EMPLOYEE.EMP_LNAME, EMPLOYEE.EMP_CODE)  + ', ' + ISNULL(EMPLOYEE.EMP_FNAME, '') Description
						,EMPLOYEE.EMP_LNAME LastName
						,EMPLOYEE.EMP_MI MiddleInitial
						,EMPLOYEE.EMP_FNAME FirstName
						,EMPLOYEE.EMP_TITLE Title
					FROM   
						EMPLOYEE WITH(NOLOCK)
						INNER JOIN [dbo].[advtf_sec_emp] (@USER_CODE) AS SEC_EMP  ON  EMPLOYEE.EMP_CODE = SEC_EMP.EMP_CODE
						INNER JOIN EMP_OFFICE ON EMPLOYEE.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = @EMP_CODE
					WHERE  
						(EMP_TERM_DATE IS NULL OR EMP_TERM_DATE > GETDATE())
					order by EMPLOYEE.EMP_FNAME, EMPLOYEE.EMP_MI, EMPLOYEE.EMP_LNAME
				END
				ELSE
				BEGIN
					SELECT 
						EMPLOYEE.EMP_CODE Code,
						EMPLOYEE.EMP_CODE + ' - ' + ISNULL(EMPLOYEE.EMP_LNAME, EMPLOYEE.EMP_CODE)  + ', ' + ISNULL(EMPLOYEE.EMP_FNAME, '') Description
					,EMPLOYEE.EMP_LNAME LastName
					,EMPLOYEE.EMP_MI MiddleInitial
					,EMPLOYEE.EMP_FNAME FirstName
					,EMPLOYEE.EMP_CODE Code
					,EMPLOYEE.EMP_TITLE Title
					FROM   
						EMPLOYEE WITH(NOLOCK)
						INNER JOIN [dbo].[advtf_sec_emp] (@USER_CODE) AS SEC_EMP ON  EMPLOYEE.EMP_CODE = SEC_EMP.EMP_CODE
					WHERE  
						(EMP_TERM_DATE IS NULL OR EMP_TERM_DATE > GETDATE())
					order by EMPLOYEE.EMP_FNAME, EMPLOYEE.EMP_MI, EMPLOYEE.EMP_LNAME
				END
			
			ELSE
				IF @OfficeRestrictions > 0
				BEGIN
					SELECT 
						EMPLOYEE.EMP_CODE Code,
						EMPLOYEE.EMP_CODE + ' - ' + ISNULL(EMPLOYEE.EMP_LNAME, EMPLOYEE.EMP_CODE)  + ', ' + ISNULL(EMPLOYEE.EMP_FNAME, '') Description
					,EMPLOYEE.EMP_LNAME LastName
					,EMPLOYEE.EMP_MI MiddleInitial
					,EMPLOYEE.EMP_FNAME FirstName
					,EMPLOYEE.EMP_TITLE Title
					FROM   
						EMPLOYEE WITH(NOLOCK)						
						INNER JOIN EMP_OFFICE ON EMPLOYEE.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = @EMP_CODE
					WHERE  
						(EMP_TERM_DATE IS NULL OR EMP_TERM_DATE > GETDATE())
					order by EMPLOYEE.EMP_FNAME, EMPLOYEE.EMP_MI, EMPLOYEE.EMP_LNAME
				END
				ELSE
				BEGIN
					SELECT 
						EMP_CODE Code,
						EMPLOYEE.EMP_CODE + ' - ' + ISNULL(EMPLOYEE.EMP_LNAME, EMPLOYEE.EMP_CODE)  + ', ' + ISNULL(EMPLOYEE.EMP_FNAME, '') Description
					,EMPLOYEE.EMP_LNAME LastName
					,EMPLOYEE.EMP_MI MiddleInitial
					,EMPLOYEE.EMP_FNAME FirstName
					,EMPLOYEE.EMP_TITLE Title
					FROM   
						EMPLOYEE WITH(NOLOCK)
					WHERE  
						(EMP_TERM_DATE IS NULL OR EMP_TERM_DATE > GETDATE())
					order by EMPLOYEE.EMP_FNAME, EMPLOYEE.EMP_MI, EMPLOYEE.EMP_LNAME
				END
			
		END
		IF @SHOW_ALL = 1
		BEGIN
			IF @RESTRICTED > 0
				IF @OfficeRestrictions > 0
				BEGIN
					SELECT 
						EMPLOYEE.EMP_CODE Code,
						EMPLOYEE.EMP_CODE + ' - ' + ISNULL(EMPLOYEE.EMP_LNAME, EMPLOYEE.EMP_CODE)  + ', ' + ISNULL(EMPLOYEE.EMP_FNAME, '') Description
					,EMPLOYEE.EMP_LNAME LastName
					,EMPLOYEE.EMP_MI MiddleInitial
					,EMPLOYEE.EMP_FNAME FirstName
					,EMPLOYEE.EMP_TITLE Title
					FROM   
						EMPLOYEE WITH(NOLOCK)
						INNER JOIN [dbo].[advtf_sec_emp] (@USER_CODE) AS SEC_EMP ON  EMPLOYEE.EMP_CODE = SEC_EMP.EMP_CODE						
						INNER JOIN EMP_OFFICE ON EMPLOYEE.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = @EMP_CODE
					order by EMPLOYEE.EMP_FNAME, EMPLOYEE.EMP_MI, EMPLOYEE.EMP_LNAME
				END
				ELSE
				BEGIN
					SELECT 
						EMPLOYEE.EMP_CODE Code,
						EMPLOYEE.EMP_CODE + ' - ' + ISNULL(EMPLOYEE.EMP_LNAME, EMPLOYEE.EMP_CODE)  + ', ' + ISNULL(EMPLOYEE.EMP_FNAME, '') Description
					,EMPLOYEE.EMP_LNAME LastName
					,EMPLOYEE.EMP_MI MiddleInitial
					,EMPLOYEE.EMP_FNAME FirstName
					,EMPLOYEE.EMP_TITLE Title
					FROM   
						EMPLOYEE WITH(NOLOCK)
						INNER JOIN [dbo].[advtf_sec_emp] (@USER_CODE) AS SEC_EMP ON  EMPLOYEE.EMP_CODE = SEC_EMP.EMP_CODE
					order by EMPLOYEE.EMP_FNAME, EMPLOYEE.EMP_MI, EMPLOYEE.EMP_LNAME
				END
			
			ELSE
				IF @OfficeRestrictions > 0
				BEGIN
					SELECT 
					EMPLOYEE.EMP_CODE Code,
						   EMPLOYEE.EMP_CODE + ' - ' + ISNULL(EMPLOYEE.EMP_LNAME, EMPLOYEE.EMP_CODE)  + ', ' + ISNULL(EMPLOYEE.EMP_FNAME, '')  Description
					,EMPLOYEE.EMP_LNAME LastName
					,EMPLOYEE.EMP_MI MiddleInitial
					,EMPLOYEE.EMP_FNAME FirstName
					,EMPLOYEE.EMP_TITLE Title
					FROM   
						EMPLOYEE WITH(NOLOCK)
						INNER JOIN EMP_OFFICE ON EMPLOYEE.OFFICE_CODE = EMP_OFFICE.OFFICE_CODE AND EMP_OFFICE.EMP_CODE = @EMP_CODE
					order by EMPLOYEE.EMP_FNAME, EMPLOYEE.EMP_MI, EMPLOYEE.EMP_LNAME
				END
				ELSE
				BEGIN
					SELECT 
						EMP_CODE code,
						EMPLOYEE.EMP_CODE + ' - ' + ISNULL(EMPLOYEE.EMP_LNAME, EMPLOYEE.EMP_CODE)  + ', ' + ISNULL(EMPLOYEE.EMP_FNAME, '') Description
					,EMPLOYEE.EMP_LNAME LastName
					,EMPLOYEE.EMP_MI MiddleInitial
					,EMPLOYEE.EMP_FNAME FirstName
					,EMPLOYEE.EMP_TITLE Title
					FROM   
						EMPLOYEE WITH(NOLOCK)
					order by EMPLOYEE.EMP_FNAME, EMPLOYEE.EMP_MI, EMPLOYEE.EMP_LNAME
				END
			
		END
	END
END
GO

