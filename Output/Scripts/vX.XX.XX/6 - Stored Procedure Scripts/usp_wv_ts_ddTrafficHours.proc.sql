--DROP PROCEDURE [dbo].[usp_wv_ts_ddTrafficHours]
CREATE PROCEDURE [dbo].[usp_wv_ts_ddTrafficHours]
@JobNumber INT,
@JobCompNumber INT,
@FunctionCode VARCHAR(6),
@EmpCode VARCHAR(6),
@EmpOnly BIT,
@AlertID INT
AS

SET @EmpOnly = ISNULL(@EmpOnly, 0);

IF @EmpOnly = 0
BEGIN
	SELECT 
		[JobNumber] = A.JOB_NUMBER,
		[JobComponentNumber] = A.JOB_COMPONENT_NBR,
		[TaskCode] = A.FNC_CODE,
		[FunctionCode] = A.FNC_EST,
		[EmployeeCode] = A.EMP_CODE,
		[TotalJobHours] = ISNULL(SUM(A.DISBURSED_HOURS),0),
		[TaskDescription] = A.TASK_DESCRIPTION,
		A.FULL_NAME
	FROM
		(
			SELECT        
				JOB_TRAFFIC_DET.JOB_NUMBER, 
				JOB_TRAFFIC_DET.JOB_COMPONENT_NBR, 
				JOB_TRAFFIC_DET.FNC_CODE, 
				JOB_TRAFFIC_DET_EMPS.EMP_CODE, 
				ISNULL(EMPLOYEE.EMP_FNAME + ' ', '') + ISNULL(EMPLOYEE.EMP_MI + '. ',' ') + ISNULL(EMPLOYEE.EMP_LNAME, '') AS FULL_NAME,
				ISNULL(SUM(JOB_TRAFFIC_DET_EMPS.HOURS_ALLOWED), JOB_TRAFFIC_DET.JOB_HRS) AS DISBURSED_HOURS, 
				JOB_TRAFFIC_DET.FNC_EST,
				JOB_TRAFFIC_DET.TASK_DESCRIPTION
			FROM            
				JOB_TRAFFIC_DET WITH(NOLOCK) LEFT OUTER JOIN
				JOB_TRAFFIC_DET_EMPS WITH(NOLOCK) ON JOB_TRAFFIC_DET.JOB_NUMBER = JOB_TRAFFIC_DET_EMPS.JOB_NUMBER AND 
				JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = JOB_TRAFFIC_DET_EMPS.JOB_COMPONENT_NBR AND JOB_TRAFFIC_DET.SEQ_NBR = JOB_TRAFFIC_DET_EMPS.SEQ_NBR
				LEFT OUTER JOIN EMPLOYEE WITH(NOLOCK) ON JOB_TRAFFIC_DET_EMPS.EMP_CODE = EMPLOYEE.EMP_CODE
			WHERE
				JOB_TRAFFIC_DET.JOB_NUMBER = @JobNumber AND JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = @JobCompNumber AND JOB_TRAFFIC_DET.SEQ_NBR = (SELECT TASK_SEQ_NBR FROM ALERT WHERE ALERT_ID = @AlertID) AND JOB_TRAFFIC_DET_EMPS.EMP_CODE = @EmpCode
			GROUP BY
				JOB_TRAFFIC_DET.JOB_NUMBER, 
				JOB_TRAFFIC_DET.JOB_COMPONENT_NBR, 
				JOB_TRAFFIC_DET.FNC_CODE, 
				JOB_TRAFFIC_DET_EMPS.EMP_CODE, 
				EMPLOYEE.EMP_FNAME, 
				EMPLOYEE.EMP_MI, 
				EMPLOYEE.EMP_LNAME, 
				JOB_TRAFFIC_DET.JOB_HRS,
				JOB_TRAFFIC_DET.FNC_EST,
				JOB_TRAFFIC_DET.TASK_DESCRIPTION
			UNION ALL
			SELECT        
				JOB_TRAFFIC_DET.JOB_NUMBER, 
				JOB_TRAFFIC_DET.JOB_COMPONENT_NBR, 
				JOB_TRAFFIC_DET.FNC_CODE, 
				NULL AS EMP_CODE, 
				'Others' AS FULL_NAME,
				ISNULL(SUM(JOB_TRAFFIC_DET_EMPS.HOURS_ALLOWED), JOB_TRAFFIC_DET.JOB_HRS) AS DISBURSED_HOURS, 
				JOB_TRAFFIC_DET.FNC_EST,
				JOB_TRAFFIC_DET.TASK_DESCRIPTION
			FROM            
				JOB_TRAFFIC_DET WITH(NOLOCK) LEFT OUTER JOIN
				JOB_TRAFFIC_DET_EMPS WITH(NOLOCK) ON JOB_TRAFFIC_DET.JOB_NUMBER = JOB_TRAFFIC_DET_EMPS.JOB_NUMBER AND 
				JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = JOB_TRAFFIC_DET_EMPS.JOB_COMPONENT_NBR AND JOB_TRAFFIC_DET.SEQ_NBR = JOB_TRAFFIC_DET_EMPS.SEQ_NBR
				LEFT OUTER JOIN EMPLOYEE WITH(NOLOCK) ON JOB_TRAFFIC_DET_EMPS.EMP_CODE = EMPLOYEE.EMP_CODE
			WHERE
				JOB_TRAFFIC_DET.JOB_NUMBER = @JobNumber AND JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = @JobCompNumber AND JOB_TRAFFIC_DET.SEQ_NBR = (SELECT TASK_SEQ_NBR FROM ALERT WHERE ALERT_ID = @AlertID) AND JOB_TRAFFIC_DET_EMPS.EMP_CODE <> @EmpCode
			GROUP BY
				JOB_TRAFFIC_DET.JOB_NUMBER, 
				JOB_TRAFFIC_DET.JOB_COMPONENT_NBR, 
				JOB_TRAFFIC_DET.FNC_CODE, 
				JOB_TRAFFIC_DET_EMPS.EMP_CODE, 
				EMPLOYEE.EMP_FNAME, 
				EMPLOYEE.EMP_MI, 
				EMPLOYEE.EMP_LNAME, 
				JOB_TRAFFIC_DET.JOB_HRS,
				JOB_TRAFFIC_DET.FNC_EST,
				JOB_TRAFFIC_DET.TASK_DESCRIPTION

		) AS A
	GROUP BY
		A.JOB_NUMBER,
		A.JOB_COMPONENT_NBR,
		A.FNC_CODE,
		A.FNC_EST,
		A.EMP_CODE,
		A.FULL_NAME,
		A.TASK_DESCRIPTION
	ORDER BY
		A.EMP_CODE DESC;
END
ELSE
BEGIN
	SELECT 
		[JobNumber] = A.JOB_NUMBER,
		[JobComponentNumber] = A.JOB_COMPONENT_NBR,
		[TaskCode] = A.FNC_CODE,
		[FunctionCode] = A.FNC_EST,
		[EmployeeCode] = A.EMP_CODE,
		[TotalJobHours] = ISNULL(SUM(A.DISBURSED_HOURS),0),
		[TaskDescription] = A.TASK_DESCRIPTION,
		A.FULL_NAME
	FROM
		(
			SELECT        
				JOB_TRAFFIC_DET.JOB_NUMBER, 
				JOB_TRAFFIC_DET.JOB_COMPONENT_NBR, 
				JOB_TRAFFIC_DET.FNC_CODE, 
				JOB_TRAFFIC_DET_EMPS.EMP_CODE, 
				ISNULL(EMPLOYEE.EMP_FNAME + ' ', '') + ISNULL(EMPLOYEE.EMP_MI + '. ',' ') + ISNULL(EMPLOYEE.EMP_LNAME, '') AS FULL_NAME,
				ISNULL(SUM(JOB_TRAFFIC_DET_EMPS.HOURS_ALLOWED), JOB_TRAFFIC_DET.JOB_HRS) AS DISBURSED_HOURS, 
				JOB_TRAFFIC_DET.FNC_EST,
				JOB_TRAFFIC_DET.TASK_DESCRIPTION
			FROM            
				JOB_TRAFFIC_DET WITH(NOLOCK) LEFT OUTER JOIN
				JOB_TRAFFIC_DET_EMPS WITH(NOLOCK) ON JOB_TRAFFIC_DET.JOB_NUMBER = JOB_TRAFFIC_DET_EMPS.JOB_NUMBER AND 
				JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = JOB_TRAFFIC_DET_EMPS.JOB_COMPONENT_NBR AND JOB_TRAFFIC_DET.SEQ_NBR = JOB_TRAFFIC_DET_EMPS.SEQ_NBR
				LEFT OUTER JOIN EMPLOYEE WITH(NOLOCK) ON JOB_TRAFFIC_DET_EMPS.EMP_CODE = EMPLOYEE.EMP_CODE
			WHERE
				JOB_TRAFFIC_DET.JOB_NUMBER = @JobNumber AND JOB_TRAFFIC_DET.JOB_COMPONENT_NBR = @JobCompNumber AND JOB_TRAFFIC_DET.SEQ_NBR = (SELECT TASK_SEQ_NBR FROM ALERT WHERE ALERT_ID = @AlertID) AND JOB_TRAFFIC_DET_EMPS.EMP_CODE = @EmpCode
			GROUP BY
				JOB_TRAFFIC_DET.JOB_NUMBER, 
				JOB_TRAFFIC_DET.JOB_COMPONENT_NBR, 
				JOB_TRAFFIC_DET.FNC_CODE, 
				JOB_TRAFFIC_DET_EMPS.EMP_CODE, 
				EMPLOYEE.EMP_FNAME, 
				EMPLOYEE.EMP_MI, 
				EMPLOYEE.EMP_LNAME, 
				JOB_TRAFFIC_DET.JOB_HRS,
				JOB_TRAFFIC_DET.FNC_EST,
				JOB_TRAFFIC_DET.TASK_DESCRIPTION
		) AS A
	GROUP BY
		A.JOB_NUMBER,
		A.JOB_COMPONENT_NBR,
		A.FNC_CODE,
		A.EMP_CODE,
		A.FULL_NAME,
		A.FNC_EST,
		A.TASK_DESCRIPTION;
END;