DECLARE
	@DELETE_FROM_NOT_COMPLETED BIT
/************	DO NOT MODIFY ABOVE  ************/
SET @DELETE_FROM_NOT_COMPLETED = 1;
/************	DO NOT MODIFY BELOW  ************/
BEGIN
	--	VARIABLES
	BEGIN
		DECLARE
			@ALERT TABLE (ID INT IDENTITY, ALERT_ID INT, LAST_UPDATED SMALLDATETIME, JOB_NUMBER INT, JOB_COMPONENT_NBR SMALLINT, TASK_SEQ_NUMBER SMALLINT);
		DECLARE
			@OPEN_SPRINTS TABLE (ID INT IDENTITY, SPRINT_HDR_ID INT);	
	END
	--	INIT
	BEGIN
		INSERT INTO @OPEN_SPRINTS (SPRINT_HDR_ID)
		SELECT
			S.ID
		FROM
			SPRINT_HDR S WITH(NOLOCK)
		WHERE
			S.COMPLETED_DATE IS NULL
			OR (IS_COMPLETE IS NULL OR IS_COMPLETE = 0);
		INSERT INTO @ALERT (ALERT_ID, LAST_UPDATED, JOB_NUMBER, JOB_COMPONENT_NBR, TASK_SEQ_NUMBER)
		SELECT 
			A.ALERT_ID, 
			T.JOB_COMPLETED_DATE,
			A.JOB_NUMBER,
			A.JOB_COMPONENT_NBR,
			A.TASK_SEQ_NBR 
		FROM 
			ALERT A WITH(NOLOCK)
			INNER JOIN JOB_TRAFFIC_DET T WITH(NOLOCK) ON A.JOB_NUMBER = T.JOB_NUMBER AND A.JOB_COMPONENT_NBR = T.JOB_COMPONENT_NBR AND A.TASK_SEQ_NBR = T.SEQ_NBR
		WHERE 
			(A.ASSIGN_COMPLETED IS NULL OR A.ASSIGN_COMPLETED = 0)
			AND (A.ALERT_CAT_ID = 71 OR A.ALERT_LEVEL = 'BRD')
			AND NOT T.JOB_COMPLETED_DATE IS NULL;
	END
	--	FIX ALERT RECS
	BEGIN
		UPDATE 
			ALERT SET ASSIGN_COMPLETED = 1, 
			LAST_UPDATED = T.LAST_UPDATED
		FROM 
			ALERT A
			INNER JOIN @ALERT T ON A.ALERT_ID = T.ALERT_ID;
	END
	--	REMOVE FROM OPEN SPRINT
	IF @DELETE_FROM_NOT_COMPLETED = 1
	BEGIN
		DELETE SPRINT_DTL
		FROM
			SPRINT_DTL S
			INNER JOIN @ALERT A ON S.ALERT_ID = A.ALERT_ID
			INNER JOIN @OPEN_SPRINTS O ON O.SPRINT_HDR_ID = S.SPRINT_HDR_ID;
	END
	-- NEW FIX
	BEGIN
		DELETE FROM @ALERT;
		INSERT INTO @ALERT (ALERT_ID)
		SELECT A.ALERT_ID
		FROM
			ALERT A
			INNER JOIN JOB_TRAFFIC_DET J ON A.JOB_NUMBER = J.JOB_NUMBER 
			AND A.JOB_COMPONENT_NBR = J.JOB_COMPONENT_NBR 
			AND A.TASK_SEQ_NBR = J.SEQ_NBR
		WHERE
			(A.ALERT_CAT_ID = 71 OR A.ALERT_LEVEL = 'BRD')
			AND J.JOB_COMPLETED_DATE IS NOT NULL
			AND (A.ASSIGN_COMPLETED IS NULL OR A.ASSIGN_COMPLETED = 0);
		DELETE SPRINT_DTL
		FROM
			SPRINT_DTL S
			INNER JOIN @ALERT A ON S.ALERT_ID = A.ALERT_ID;
		UPDATE ALERT SET ASSIGN_COMPLETED = 1
		FROM
			ALERT A
			INNER JOIN @ALERT AA ON A.ALERT_ID = AA.ALERT_ID;
	END
END